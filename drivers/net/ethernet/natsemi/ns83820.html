<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › natsemi › ns83820.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ns83820.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define VERSION &quot;0.23&quot;</span>
<span class="cm">/* ns83820.c by Benjamin LaHaise with contributions.</span>
<span class="cm"> *</span>
<span class="cm"> * Questions/comments/discussion to linux-ns83820@kvack.org.</span>
<span class="cm"> *</span>
<span class="cm"> * $Revision: 1.34.2.23 $</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2001 Benjamin LaHaise.</span>
<span class="cm"> * Copyright 2001, 2002 Red Hat.</span>
<span class="cm"> *</span>
<span class="cm"> * Mmmm, chocolate vanilla mocha...</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * ChangeLog</span>
<span class="cm"> * =========</span>
<span class="cm"> *	20010414	0.1 - created</span>
<span class="cm"> *	20010622	0.2 - basic rx and tx.</span>
<span class="cm"> *	20010711	0.3 - added duplex and link state detection support.</span>
<span class="cm"> *	20010713	0.4 - zero copy, no hangs.</span>
<span class="cm"> *			0.5 - 64 bit dma support (davem will hate me for this)</span>
<span class="cm"> *			    - disable jumbo frames to avoid tx hangs</span>
<span class="cm"> *			    - work around tx deadlocks on my 1.02 card via</span>
<span class="cm"> *			      fiddling with TXCFG</span>
<span class="cm"> *	20010810	0.6 - use pci dma api for ringbuffers, work on ia64</span>
<span class="cm"> *	20010816	0.7 - misc cleanups</span>
<span class="cm"> *	20010826	0.8 - fix critical zero copy bugs</span>
<span class="cm"> *			0.9 - internal experiment</span>
<span class="cm"> *	20010827	0.10 - fix ia64 unaligned access.</span>
<span class="cm"> *	20010906	0.11 - accept all packets with checksum errors as</span>
<span class="cm"> *			       otherwise fragments get lost</span>
<span class="cm"> *			     - fix &gt;&gt; 32 bugs</span>
<span class="cm"> *			0.12 - add statistics counters</span>
<span class="cm"> *			     - add allmulti/promisc support</span>
<span class="cm"> *	20011009	0.13 - hotplug support, other smaller pci api cleanups</span>
<span class="cm"> *	20011204	0.13a - optical transceiver support added</span>
<span class="cm"> *				by Michael Clark &lt;michael@metaparadigm.com&gt;</span>
<span class="cm"> *	20011205	0.13b - call register_netdev earlier in initialization</span>
<span class="cm"> *				suppress duplicate link status messages</span>
<span class="cm"> *	20011117 	0.14 - ethtool GDRVINFO, GLINK support from jgarzik</span>
<span class="cm"> *	20011204 	0.15	get ppc (big endian) working</span>
<span class="cm"> *	20011218	0.16	various cleanups</span>
<span class="cm"> *	20020310	0.17	speedups</span>
<span class="cm"> *	20020610	0.18 -	actually use the pci dma api for highmem</span>
<span class="cm"> *			     -	remove pci latency register fiddling</span>
<span class="cm"> *			0.19 -	better bist support</span>
<span class="cm"> *			     -	add ihr and reset_phy parameters</span>
<span class="cm"> *			     -	gmii bus probing</span>
<span class="cm"> *			     -	fix missed txok introduced during performance</span>
<span class="cm"> *				tuning</span>
<span class="cm"> *			0.20 -	fix stupid RFEN thinko.  i am such a smurf.</span>
<span class="cm"> *	20040828	0.21 -	add hardware vlan accleration</span>
<span class="cm"> *				by Neil Horman &lt;nhorman@redhat.com&gt;</span>
<span class="cm"> *	20050406	0.22 -	improved DAC ifdefs from Andi Kleen</span>
<span class="cm"> *			     -	removal of dead code from Adrian Bunk</span>
<span class="cm"> *			     -	fix half duplex collision behaviour</span>
<span class="cm"> * Driver Overview</span>
<span class="cm"> * ===============</span>
<span class="cm"> *</span>
<span class="cm"> * This driver was originally written for the National Semiconductor</span>
<span class="cm"> * 83820 chip, a 10/100/1000 Mbps 64 bit PCI ethernet NIC.  Hopefully</span>
<span class="cm"> * this code will turn out to be a) clean, b) correct, and c) fast.</span>
<span class="cm"> * With that in mind, I&#39;m aiming to split the code up as much as</span>
<span class="cm"> * reasonably possible.  At present there are X major sections that</span>
<span class="cm"> * break down into a) packet receive, b) packet transmit, c) link</span>
<span class="cm"> * management, d) initialization and configuration.  Where possible,</span>
<span class="cm"> * these code paths are designed to run in parallel.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver has been tested and found to work with the following</span>
<span class="cm"> * cards (in no particular order):</span>
<span class="cm"> *</span>
<span class="cm"> *	Cameo		SOHO-GA2000T	SOHO-GA2500T</span>
<span class="cm"> *	D-Link		DGE-500T</span>
<span class="cm"> *	PureData	PDP8023Z-TG</span>
<span class="cm"> *	SMC		SMC9452TX	SMC9462TX</span>
<span class="cm"> *	Netgear		GA621</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to SMC for providing hardware to test this driver on.</span>
<span class="cm"> *</span>
<span class="cm"> * Reports of success or failure would be greatly appreciated.</span>
<span class="cm"> */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define dprintk        printk</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define dprintk(x...)		do { } while (0)</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;	</span><span class="cm">/* for iph */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/in.h&gt;	</span><span class="cm">/* for IPPROTO_... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;ns83820&quot;</span>

<span class="cm">/* Global parameters.  See module_param near the bottom. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ihr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reset_phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lnksts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* CFG_LNKSTS bit polarity */</span>

<span class="cm">/* Dprintk is used for more interesting debug events */</span>
<span class="cp">#undef Dprintk</span>
<span class="cp">#define	Dprintk			dprintk</span>

<span class="cm">/* tunables */</span>
<span class="cp">#define RX_BUF_SIZE	1500	</span><span class="cm">/* 8192 */</span><span class="cp"></span>
<span class="cp">#if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)</span>
<span class="cp">#define NS83820_VLAN_ACCEL_SUPPORT</span>
<span class="cp">#endif</span>

<span class="cm">/* Must not exceed ~65000. */</span>
<span class="cp">#define NR_RX_DESC	64</span>
<span class="cp">#define NR_TX_DESC	128</span>

<span class="cm">/* not tunable */</span>
<span class="cp">#define REAL_RX_BUF_SIZE (RX_BUF_SIZE + 14)	</span><span class="cm">/* rx/tx mac addr + type */</span><span class="cp"></span>

<span class="cp">#define MIN_TX_DESC_FREE	8</span>

<span class="cm">/* register defines */</span>
<span class="cp">#define CFGCS		0x04</span>

<span class="cp">#define CR_TXE		0x00000001</span>
<span class="cp">#define CR_TXD		0x00000002</span>
<span class="cm">/* Ramit : Here&#39;s a tip, don&#39;t do a RXD immediately followed by an RXE</span>
<span class="cm"> * The Receive engine skips one descriptor and moves</span>
<span class="cm"> * onto the next one!! */</span>
<span class="cp">#define CR_RXE		0x00000004</span>
<span class="cp">#define CR_RXD		0x00000008</span>
<span class="cp">#define CR_TXR		0x00000010</span>
<span class="cp">#define CR_RXR		0x00000020</span>
<span class="cp">#define CR_SWI		0x00000080</span>
<span class="cp">#define CR_RST		0x00000100</span>

<span class="cp">#define PTSCR_EEBIST_FAIL       0x00000001</span>
<span class="cp">#define PTSCR_EEBIST_EN         0x00000002</span>
<span class="cp">#define PTSCR_EELOAD_EN         0x00000004</span>
<span class="cp">#define PTSCR_RBIST_FAIL        0x000001b8</span>
<span class="cp">#define PTSCR_RBIST_DONE        0x00000200</span>
<span class="cp">#define PTSCR_RBIST_EN          0x00000400</span>
<span class="cp">#define PTSCR_RBIST_RST         0x00002000</span>

<span class="cp">#define MEAR_EEDI		0x00000001</span>
<span class="cp">#define MEAR_EEDO		0x00000002</span>
<span class="cp">#define MEAR_EECLK		0x00000004</span>
<span class="cp">#define MEAR_EESEL		0x00000008</span>
<span class="cp">#define MEAR_MDIO		0x00000010</span>
<span class="cp">#define MEAR_MDDIR		0x00000020</span>
<span class="cp">#define MEAR_MDC		0x00000040</span>

<span class="cp">#define ISR_TXDESC3	0x40000000</span>
<span class="cp">#define ISR_TXDESC2	0x20000000</span>
<span class="cp">#define ISR_TXDESC1	0x10000000</span>
<span class="cp">#define ISR_TXDESC0	0x08000000</span>
<span class="cp">#define ISR_RXDESC3	0x04000000</span>
<span class="cp">#define ISR_RXDESC2	0x02000000</span>
<span class="cp">#define ISR_RXDESC1	0x01000000</span>
<span class="cp">#define ISR_RXDESC0	0x00800000</span>
<span class="cp">#define ISR_TXRCMP	0x00400000</span>
<span class="cp">#define ISR_RXRCMP	0x00200000</span>
<span class="cp">#define ISR_DPERR	0x00100000</span>
<span class="cp">#define ISR_SSERR	0x00080000</span>
<span class="cp">#define ISR_RMABT	0x00040000</span>
<span class="cp">#define ISR_RTABT	0x00020000</span>
<span class="cp">#define ISR_RXSOVR	0x00010000</span>
<span class="cp">#define ISR_HIBINT	0x00008000</span>
<span class="cp">#define ISR_PHY		0x00004000</span>
<span class="cp">#define ISR_PME		0x00002000</span>
<span class="cp">#define ISR_SWI		0x00001000</span>
<span class="cp">#define ISR_MIB		0x00000800</span>
<span class="cp">#define ISR_TXURN	0x00000400</span>
<span class="cp">#define ISR_TXIDLE	0x00000200</span>
<span class="cp">#define ISR_TXERR	0x00000100</span>
<span class="cp">#define ISR_TXDESC	0x00000080</span>
<span class="cp">#define ISR_TXOK	0x00000040</span>
<span class="cp">#define ISR_RXORN	0x00000020</span>
<span class="cp">#define ISR_RXIDLE	0x00000010</span>
<span class="cp">#define ISR_RXEARLY	0x00000008</span>
<span class="cp">#define ISR_RXERR	0x00000004</span>
<span class="cp">#define ISR_RXDESC	0x00000002</span>
<span class="cp">#define ISR_RXOK	0x00000001</span>

<span class="cp">#define TXCFG_CSI	0x80000000</span>
<span class="cp">#define TXCFG_HBI	0x40000000</span>
<span class="cp">#define TXCFG_MLB	0x20000000</span>
<span class="cp">#define TXCFG_ATP	0x10000000</span>
<span class="cp">#define TXCFG_ECRETRY	0x00800000</span>
<span class="cp">#define TXCFG_BRST_DIS	0x00080000</span>
<span class="cp">#define TXCFG_MXDMA1024	0x00000000</span>
<span class="cp">#define TXCFG_MXDMA512	0x00700000</span>
<span class="cp">#define TXCFG_MXDMA256	0x00600000</span>
<span class="cp">#define TXCFG_MXDMA128	0x00500000</span>
<span class="cp">#define TXCFG_MXDMA64	0x00400000</span>
<span class="cp">#define TXCFG_MXDMA32	0x00300000</span>
<span class="cp">#define TXCFG_MXDMA16	0x00200000</span>
<span class="cp">#define TXCFG_MXDMA8	0x00100000</span>

<span class="cp">#define CFG_LNKSTS	0x80000000</span>
<span class="cp">#define CFG_SPDSTS	0x60000000</span>
<span class="cp">#define CFG_SPDSTS1	0x40000000</span>
<span class="cp">#define CFG_SPDSTS0	0x20000000</span>
<span class="cp">#define CFG_DUPSTS	0x10000000</span>
<span class="cp">#define CFG_TBI_EN	0x01000000</span>
<span class="cp">#define CFG_MODE_1000	0x00400000</span>
<span class="cm">/* Ramit : Dont&#39; ever use AUTO_1000, it never works and is buggy.</span>
<span class="cm"> * Read the Phy response and then configure the MAC accordingly */</span>
<span class="cp">#define CFG_AUTO_1000	0x00200000</span>
<span class="cp">#define CFG_PINT_CTL	0x001c0000</span>
<span class="cp">#define CFG_PINT_DUPSTS	0x00100000</span>
<span class="cp">#define CFG_PINT_LNKSTS	0x00080000</span>
<span class="cp">#define CFG_PINT_SPDSTS	0x00040000</span>
<span class="cp">#define CFG_TMRTEST	0x00020000</span>
<span class="cp">#define CFG_MRM_DIS	0x00010000</span>
<span class="cp">#define CFG_MWI_DIS	0x00008000</span>
<span class="cp">#define CFG_T64ADDR	0x00004000</span>
<span class="cp">#define CFG_PCI64_DET	0x00002000</span>
<span class="cp">#define CFG_DATA64_EN	0x00001000</span>
<span class="cp">#define CFG_M64ADDR	0x00000800</span>
<span class="cp">#define CFG_PHY_RST	0x00000400</span>
<span class="cp">#define CFG_PHY_DIS	0x00000200</span>
<span class="cp">#define CFG_EXTSTS_EN	0x00000100</span>
<span class="cp">#define CFG_REQALG	0x00000080</span>
<span class="cp">#define CFG_SB		0x00000040</span>
<span class="cp">#define CFG_POW		0x00000020</span>
<span class="cp">#define CFG_EXD		0x00000010</span>
<span class="cp">#define CFG_PESEL	0x00000008</span>
<span class="cp">#define CFG_BROM_DIS	0x00000004</span>
<span class="cp">#define CFG_EXT_125	0x00000002</span>
<span class="cp">#define CFG_BEM		0x00000001</span>

<span class="cp">#define EXTSTS_UDPPKT	0x00200000</span>
<span class="cp">#define EXTSTS_TCPPKT	0x00080000</span>
<span class="cp">#define EXTSTS_IPPKT	0x00020000</span>
<span class="cp">#define EXTSTS_VPKT	0x00010000</span>
<span class="cp">#define EXTSTS_VTG_MASK	0x0000ffff</span>

<span class="cp">#define SPDSTS_POLARITY	(CFG_SPDSTS1 | CFG_SPDSTS0 | CFG_DUPSTS | (lnksts ? CFG_LNKSTS : 0))</span>

<span class="cp">#define MIBC_MIBS	0x00000008</span>
<span class="cp">#define MIBC_ACLR	0x00000004</span>
<span class="cp">#define MIBC_FRZ	0x00000002</span>
<span class="cp">#define MIBC_WRN	0x00000001</span>

<span class="cp">#define PCR_PSEN	(1 &lt;&lt; 31)</span>
<span class="cp">#define PCR_PS_MCAST	(1 &lt;&lt; 30)</span>
<span class="cp">#define PCR_PS_DA	(1 &lt;&lt; 29)</span>
<span class="cp">#define PCR_STHI_8	(3 &lt;&lt; 23)</span>
<span class="cp">#define PCR_STLO_4	(1 &lt;&lt; 23)</span>
<span class="cp">#define PCR_FFHI_8K	(3 &lt;&lt; 21)</span>
<span class="cp">#define PCR_FFLO_4K	(1 &lt;&lt; 21)</span>
<span class="cp">#define PCR_PAUSE_CNT	0xFFFE</span>

<span class="cp">#define RXCFG_AEP	0x80000000</span>
<span class="cp">#define RXCFG_ARP	0x40000000</span>
<span class="cp">#define RXCFG_STRIPCRC	0x20000000</span>
<span class="cp">#define RXCFG_RX_FD	0x10000000</span>
<span class="cp">#define RXCFG_ALP	0x08000000</span>
<span class="cp">#define RXCFG_AIRL	0x04000000</span>
<span class="cp">#define RXCFG_MXDMA512	0x00700000</span>
<span class="cp">#define RXCFG_DRTH	0x0000003e</span>
<span class="cp">#define RXCFG_DRTH0	0x00000002</span>

<span class="cp">#define RFCR_RFEN	0x80000000</span>
<span class="cp">#define RFCR_AAB	0x40000000</span>
<span class="cp">#define RFCR_AAM	0x20000000</span>
<span class="cp">#define RFCR_AAU	0x10000000</span>
<span class="cp">#define RFCR_APM	0x08000000</span>
<span class="cp">#define RFCR_APAT	0x07800000</span>
<span class="cp">#define RFCR_APAT3	0x04000000</span>
<span class="cp">#define RFCR_APAT2	0x02000000</span>
<span class="cp">#define RFCR_APAT1	0x01000000</span>
<span class="cp">#define RFCR_APAT0	0x00800000</span>
<span class="cp">#define RFCR_AARP	0x00400000</span>
<span class="cp">#define RFCR_MHEN	0x00200000</span>
<span class="cp">#define RFCR_UHEN	0x00100000</span>
<span class="cp">#define RFCR_ULM	0x00080000</span>

<span class="cp">#define VRCR_RUDPE	0x00000080</span>
<span class="cp">#define VRCR_RTCPE	0x00000040</span>
<span class="cp">#define VRCR_RIPE	0x00000020</span>
<span class="cp">#define VRCR_IPEN	0x00000010</span>
<span class="cp">#define VRCR_DUTF	0x00000008</span>
<span class="cp">#define VRCR_DVTF	0x00000004</span>
<span class="cp">#define VRCR_VTREN	0x00000002</span>
<span class="cp">#define VRCR_VTDEN	0x00000001</span>

<span class="cp">#define VTCR_PPCHK	0x00000008</span>
<span class="cp">#define VTCR_GCHK	0x00000004</span>
<span class="cp">#define VTCR_VPPTI	0x00000002</span>
<span class="cp">#define VTCR_VGTI	0x00000001</span>

<span class="cp">#define CR		0x00</span>
<span class="cp">#define CFG		0x04</span>
<span class="cp">#define MEAR		0x08</span>
<span class="cp">#define PTSCR		0x0c</span>
<span class="cp">#define	ISR		0x10</span>
<span class="cp">#define	IMR		0x14</span>
<span class="cp">#define	IER		0x18</span>
<span class="cp">#define	IHR		0x1c</span>
<span class="cp">#define TXDP		0x20</span>
<span class="cp">#define TXDP_HI		0x24</span>
<span class="cp">#define TXCFG		0x28</span>
<span class="cp">#define GPIOR		0x2c</span>
<span class="cp">#define RXDP		0x30</span>
<span class="cp">#define RXDP_HI		0x34</span>
<span class="cp">#define RXCFG		0x38</span>
<span class="cp">#define PQCR		0x3c</span>
<span class="cp">#define WCSR		0x40</span>
<span class="cp">#define PCR		0x44</span>
<span class="cp">#define RFCR		0x48</span>
<span class="cp">#define RFDR		0x4c</span>

<span class="cp">#define SRR		0x58</span>

<span class="cp">#define VRCR		0xbc</span>
<span class="cp">#define VTCR		0xc0</span>
<span class="cp">#define VDR		0xc4</span>
<span class="cp">#define CCSR		0xcc</span>

<span class="cp">#define TBICR		0xe0</span>
<span class="cp">#define TBISR		0xe4</span>
<span class="cp">#define TANAR		0xe8</span>
<span class="cp">#define TANLPAR		0xec</span>
<span class="cp">#define TANER		0xf0</span>
<span class="cp">#define TESR		0xf4</span>

<span class="cp">#define TBICR_MR_AN_ENABLE	0x00001000</span>
<span class="cp">#define TBICR_MR_RESTART_AN	0x00000200</span>

<span class="cp">#define TBISR_MR_LINK_STATUS	0x00000020</span>
<span class="cp">#define TBISR_MR_AN_COMPLETE	0x00000004</span>

<span class="cp">#define TANAR_PS2 		0x00000100</span>
<span class="cp">#define TANAR_PS1 		0x00000080</span>
<span class="cp">#define TANAR_HALF_DUP 		0x00000040</span>
<span class="cp">#define TANAR_FULL_DUP 		0x00000020</span>

<span class="cp">#define GPIOR_GP5_OE		0x00000200</span>
<span class="cp">#define GPIOR_GP4_OE		0x00000100</span>
<span class="cp">#define GPIOR_GP3_OE		0x00000080</span>
<span class="cp">#define GPIOR_GP2_OE		0x00000040</span>
<span class="cp">#define GPIOR_GP1_OE		0x00000020</span>
<span class="cp">#define GPIOR_GP3_OUT		0x00000004</span>
<span class="cp">#define GPIOR_GP1_OUT		0x00000001</span>

<span class="cp">#define LINK_AUTONEGOTIATE	0x01</span>
<span class="cp">#define LINK_DOWN		0x02</span>
<span class="cp">#define LINK_UP			0x04</span>

<span class="cp">#define HW_ADDR_LEN	sizeof(dma_addr_t)</span>
<span class="cp">#define desc_addr_set(desc, addr)				\</span>
<span class="cp">	do {							\</span>
<span class="cp">		((desc)[0] = cpu_to_le32(addr));		\</span>
<span class="cp">		if (HW_ADDR_LEN == 8)		 		\</span>
<span class="cp">			(desc)[1] = cpu_to_le32(((u64)addr) &gt;&gt; 32);	\</span>
<span class="cp">	} while(0)</span>
<span class="cp">#define desc_addr_get(desc)					\</span>
<span class="cp">	(le32_to_cpu((desc)[0]) | \</span>
<span class="cp">	(HW_ADDR_LEN == 8 ? ((dma_addr_t)le32_to_cpu((desc)[1]))&lt;&lt;32 : 0))</span>

<span class="cp">#define DESC_LINK		0</span>
<span class="cp">#define DESC_BUFPTR		(DESC_LINK + HW_ADDR_LEN/4)</span>
<span class="cp">#define DESC_CMDSTS		(DESC_BUFPTR + HW_ADDR_LEN/4)</span>
<span class="cp">#define DESC_EXTSTS		(DESC_CMDSTS + 4/4)</span>

<span class="cp">#define CMDSTS_OWN	0x80000000</span>
<span class="cp">#define CMDSTS_MORE	0x40000000</span>
<span class="cp">#define CMDSTS_INTR	0x20000000</span>
<span class="cp">#define CMDSTS_ERR	0x10000000</span>
<span class="cp">#define CMDSTS_OK	0x08000000</span>
<span class="cp">#define CMDSTS_RUNT	0x00200000</span>
<span class="cp">#define CMDSTS_LEN_MASK	0x0000ffff</span>

<span class="cp">#define CMDSTS_DEST_MASK	0x01800000</span>
<span class="cp">#define CMDSTS_DEST_SELF	0x00800000</span>
<span class="cp">#define CMDSTS_DEST_MULTI	0x01000000</span>

<span class="cp">#define DESC_SIZE	8		</span><span class="cm">/* Should be cache line sized */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">rx_info</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">up</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">idle</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skbs</span><span class="p">[</span><span class="n">NR_RX_DESC</span><span class="p">];</span>

	<span class="n">__le32</span>		<span class="o">*</span><span class="n">next_rx_desc</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">next_rx</span><span class="p">,</span> <span class="n">next_empty</span><span class="p">;</span>

	<span class="n">__le32</span>		<span class="o">*</span><span class="n">descs</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">phy_descs</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">ns83820</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rx_info</span>		<span class="n">rx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">rx_tasklet</span><span class="p">;</span>

	<span class="kt">unsigned</span>		<span class="n">ihr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">tq_refill</span><span class="p">;</span>

	<span class="cm">/* protects everything below.  irqsave when using. */</span>
	<span class="n">spinlock_t</span>		<span class="n">misc_lock</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">CFG_cache</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">MEAR_cache</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">IMR_cache</span><span class="p">;</span>

	<span class="kt">unsigned</span>		<span class="n">linkstate</span><span class="p">;</span>

	<span class="n">spinlock_t</span>	<span class="n">tx_lock</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="n">tx_done_idx</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tx_idx</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u16</span>	<span class="n">tx_free_idx</span><span class="p">;</span>	<span class="cm">/* idx of free desc chain */</span>
	<span class="n">u16</span>		<span class="n">tx_intr_idx</span><span class="p">;</span>

	<span class="n">atomic_t</span>	<span class="n">nr_tx_skbs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">NR_TX_DESC</span><span class="p">];</span>

	<span class="kt">char</span>		<span class="n">pad</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">16</span><span class="p">)));</span>
	<span class="n">__le32</span>		<span class="o">*</span><span class="n">tx_descs</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">tx_phy_descs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">tx_watchdog</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="nf">PRIV</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define __kick_rx(dev)	writel(CR_RXE, dev-&gt;base + CR)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kick_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;kick_rx: maybe kicking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">idle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;actually kicking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span> <span class="o">+</span>
			<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx</span><span class="p">),</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_empty</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: uh-oh: next_rx == next_empty???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">__kick_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>free = (tx<em>done</em>idx + NR<em>TX</em>DESC-2 - free<em>idx) % NR</em>TX_DESC</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define start_tx_okay(dev)	\</span>
<span class="cp">	(((NR_TX_DESC-2 + dev-&gt;tx_done_idx - dev-&gt;tx_free_idx) % NR_TX_DESC) &gt; MIN_TX_DESC_FREE)</span>

<span class="cm">/* Packet Receiver</span>
<span class="cm"> *</span>
<span class="cm"> * The hardware supports linked lists of receive descriptors for</span>
<span class="cm"> * which ownership is transferred back and forth by means of an</span>
<span class="cm"> * ownership bit.  While the hardware does support the use of a</span>
<span class="cm"> * ring for receive descriptors, we only make use of a chain in</span>
<span class="cm"> * an attempt to reduce bus traffic under heavy load scenarios.</span>
<span class="cm"> * This will also make bugs a bit more obvious.  The current code</span>
<span class="cm"> * only makes use of a single rx chain; I hope to implement</span>
<span class="cm"> * priority based rx for version 1.0.  Goal: even under overload</span>
<span class="cm"> * conditions, still route realtime traffic with as low jitter as</span>
<span class="cm"> * possible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">build_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">link</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmdsts</span><span class="p">,</span> <span class="n">u32</span> <span class="n">extsts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc_addr_set</span><span class="p">(</span><span class="n">desc</span> <span class="o">+</span> <span class="n">DESC_LINK</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
	<span class="n">desc_addr_set</span><span class="p">(</span><span class="n">desc</span> <span class="o">+</span> <span class="n">DESC_BUFPTR</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">DESC_EXTSTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">extsts</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmdsts</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define nr_rx_empty(dev) ((NR_RX_DESC-2 + dev-&gt;rx_info.next_rx - dev-&gt;rx_info.next_empty) % NR_RX_DESC)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ns83820_add_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">next_empty</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmdsts</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">next_empty</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_empty</span><span class="p">;</span>

	<span class="cm">/* don&#39;t overrun last rx marker */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nr_rx_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	dprintk(&quot;next_empty[%d] nr_used[%d] next_rx[%d]\n&quot;,</span>
<span class="c">		dev-&gt;rx_info.next_empty,</span>
<span class="c">		dev-&gt;rx_info.nr_used,</span>
<span class="c">		dev-&gt;rx_info.next_rx</span>
<span class="c">		);</span>
<span class="cp">#endif</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">next_empty</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">skbs</span><span class="p">[</span><span class="n">next_empty</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">skbs</span><span class="p">[</span><span class="n">next_empty</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_empty</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_RX_DESC</span><span class="p">;</span>
	<span class="n">cmdsts</span> <span class="o">=</span> <span class="n">REAL_RX_BUF_SIZE</span> <span class="o">|</span> <span class="n">CMDSTS_INTR</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			     <span class="n">REAL_RX_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">build_rx_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">cmdsts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* update link of previous rx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">next_empty</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span><span class="p">[((</span><span class="n">NR_RX_DESC</span> <span class="o">+</span> <span class="n">next_empty</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_RX_DESC</span><span class="p">)</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">next_empty</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rx_refill</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nr_rx_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;rx_refill(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfp</span> <span class="o">==</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NR_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">res</span><span class="p">;</span>

		<span class="cm">/* extra 16 bytes for alignment */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">__netdev_alloc_skb</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">REAL_RX_BUF_SIZE</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfp</span> <span class="o">!=</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ns83820_add_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfp</span> <span class="o">!=</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gfp</span> <span class="o">==</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_refill_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rx_refill</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* REFILL */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">queue_refill</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ns83820</span><span class="p">,</span> <span class="n">tq_refill</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">rx_refill</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">up</span><span class="p">)</span>
		<span class="n">kick_rx</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clear_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">build_rx_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMDSTS_OWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">phy_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">speeds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;10&quot;</span><span class="p">,</span> <span class="s">&quot;100&quot;</span><span class="p">,</span> <span class="s">&quot;1000&quot;</span><span class="p">,</span> <span class="s">&quot;1000(?)&quot;</span><span class="p">,</span> <span class="s">&quot;1000F&quot;</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">new_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tbisr</span><span class="p">,</span> <span class="n">tanar</span><span class="p">,</span> <span class="n">tanlpar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="n">fullduplex</span><span class="p">,</span> <span class="n">newlinkstate</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">)</span> <span class="o">^</span> <span class="n">SPDSTS_POLARITY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_TBI_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have an optical transceiver */</span>
		<span class="n">tbisr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TBISR</span><span class="p">);</span>
		<span class="n">tanar</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TANAR</span><span class="p">);</span>
		<span class="n">tanlpar</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TANLPAR</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;phy_intr: tbisr=%08x, tanar=%08x, tanlpar=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tbisr</span><span class="p">,</span> <span class="n">tanar</span><span class="p">,</span> <span class="n">tanlpar</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">fullduplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">tanlpar</span> <span class="o">&amp;</span> <span class="n">TANAR_FULL_DUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">tanar</span> <span class="o">&amp;</span> <span class="n">TANAR_FULL_DUP</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* both of us are full duplex */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">)</span>
			       <span class="o">|</span> <span class="n">TXCFG_CSI</span> <span class="o">|</span> <span class="n">TXCFG_HBI</span> <span class="o">|</span> <span class="n">TXCFG_ATP</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">RXCFG_RX_FD</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">);</span>
			<span class="cm">/* Light up full duplex LED */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">)</span> <span class="o">|</span> <span class="n">GPIOR_GP1_OUT</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">tanlpar</span> <span class="o">&amp;</span> <span class="n">TANAR_HALF_DUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">tanar</span> <span class="o">&amp;</span> <span class="n">TANAR_HALF_DUP</span><span class="p">))</span> <span class="o">||</span>
			   <span class="p">((</span><span class="n">tanlpar</span> <span class="o">&amp;</span> <span class="n">TANAR_FULL_DUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">tanar</span> <span class="o">&amp;</span> <span class="n">TANAR_HALF_DUP</span><span class="p">))</span> <span class="o">||</span>
			   <span class="p">((</span><span class="n">tanlpar</span> <span class="o">&amp;</span> <span class="n">TANAR_HALF_DUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">tanar</span> <span class="o">&amp;</span> <span class="n">TANAR_FULL_DUP</span><span class="p">)))</span> <span class="p">{</span>

			<span class="cm">/* one or both of us are half duplex */</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TXCFG_CSI</span> <span class="o">|</span> <span class="n">TXCFG_HBI</span><span class="p">))</span> <span class="o">|</span> <span class="n">TXCFG_ATP</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RXCFG_RX_FD</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">);</span>
			<span class="cm">/* Turn off full duplex LED */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GPIOR_GP1_OUT</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">speed</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 1000F */</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* we have a copper transceiver */</span>
		<span class="n">new_cfg</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CFG_SB</span> <span class="o">|</span> <span class="n">CFG_MODE_1000</span> <span class="o">|</span> <span class="n">CFG_SPDSTS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_SPDSTS1</span><span class="p">)</span>
			<span class="n">new_cfg</span> <span class="o">|=</span> <span class="n">CFG_MODE_1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">new_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_MODE_1000</span><span class="p">;</span>

		<span class="n">speed</span> <span class="o">=</span> <span class="p">((</span><span class="n">cfg</span> <span class="o">/</span> <span class="n">CFG_SPDSTS0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">fullduplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_DUPSTS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fullduplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_cfg</span> <span class="o">|=</span> <span class="n">CFG_SB</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">TXCFG_CSI</span> <span class="o">|</span> <span class="n">TXCFG_HBI</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">RXCFG_RX_FD</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TXCFG_CSI</span> <span class="o">|</span> <span class="n">TXCFG_HBI</span><span class="p">),</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">RXCFG_RX_FD</span><span class="p">),</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_LNKSTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">new_cfg</span> <span class="o">^</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">new_cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">=</span> <span class="n">new_cfg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_SPDSTS</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_SPDSTS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">newlinkstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_LNKSTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">LINK_UP</span> <span class="o">:</span> <span class="n">LINK_DOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newlinkstate</span> <span class="o">&amp;</span> <span class="n">LINK_UP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">!=</span> <span class="n">newlinkstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: link now %s mbps, %s duplex and up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">speeds</span><span class="p">[</span><span class="n">speed</span><span class="p">],</span>
			<span class="n">fullduplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newlinkstate</span> <span class="o">&amp;</span> <span class="n">LINK_DOWN</span> <span class="o">&amp;&amp;</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">!=</span> <span class="n">newlinkstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: link now down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">=</span> <span class="n">newlinkstate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns83820_setup_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ns83820_setup_rx(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">idle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx_desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NR_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">clear_rx_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXDP_HI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXDP</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rx_refill</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;starting receiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* prevent the interrupt handler from stomping on us */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CCSR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RFCR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x7fc00000</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RFCR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xffc00000</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RFCR</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">phy_intr</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

		<span class="cm">/* Okay, let it rip */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_PHY</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_RXRCMP</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>dev->IMR<em>cache |= ISR</em>RXERR;
dev->IMR<em>cache |= ISR</em>RXOK;</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_RXORN</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_RXSOVR</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_RXDESC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_RXIDLE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_TXDESC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_TXIDLE</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IER</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>

		<span class="n">kick_rx</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns83820_cleanup_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ns83820_cleanup_rx(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* disable receive interrupts */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISR_RXOK</span> <span class="o">|</span> <span class="n">ISR_RXDESC</span> <span class="o">|</span> <span class="n">ISR_RXERR</span> <span class="o">|</span> <span class="n">ISR_RXEARLY</span> <span class="o">|</span> <span class="n">ISR_RXIDLE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* synchronize with the interrupt handler and kill it */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* touch the pci bus... */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="cm">/* assumes the transmitter is already disabled and reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXDP_HI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXDP</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NR_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">skbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">clear_rx_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns83820_rx_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="cm">/*if (nr_rx_empty(dev) &gt;= NR_RX_DESC/4)*/</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_refill_atomic</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">kick_rx</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="n">nr_rx_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NR_RX_DESC</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tq_refill</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kick_rx</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">idle</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: BAD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* rx_irq</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">next_rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_rc</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmdsts</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;rx_irq(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;rxdp: %08x, descs: %08lx next_rx[%d]: %p next_empty[%d]: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXDP</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx</span><span class="p">)),</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_empty</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_empty</span><span class="p">))</span>
		<span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;walking descs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">next_rx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rx</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">CMDSTS_OWN</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmdsts</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">])))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">cmdsts</span> <span class="o">!=</span> <span class="n">CMDSTS_OWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">extsts</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_EXTSTS</span><span class="p">]);</span>
		<span class="n">dma_addr_t</span> <span class="n">bufptr</span> <span class="o">=</span> <span class="n">desc_addr_get</span><span class="p">(</span><span class="n">desc</span> <span class="o">+</span> <span class="n">DESC_BUFPTR</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;cmdsts: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdsts</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;link: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_LINK</span><span class="p">]));</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;extsts: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">extsts</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">next_rx</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">next_rx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_rx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_RX_DESC</span><span class="p">;</span>

		<span class="n">mb</span><span class="p">();</span>
		<span class="n">clear_rx_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">next_rx</span><span class="p">);</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span>
				 <span class="n">RX_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="n">CMDSTS_LEN_MASK</span><span class="p">;</span>
<span class="cp">#ifdef NS83820_VLAN_ACCEL_SUPPORT</span>
		<span class="cm">/* NH: As was mentioned below, this chip is kinda</span>
<span class="cm">		 * brain dead about vlan tag stripping.  Frames</span>
<span class="cm">		 * that are 64 bytes with a vlan header appended</span>
<span class="cm">		 * like arp frames, or pings, are flagged as Runts</span>
<span class="cm">		 * when the tag is stripped and hardware.  This</span>
<span class="cm">		 * also means that the OK bit in the descriptor</span>
<span class="cm">		 * is cleared when the frame comes in so we have</span>
<span class="cm">		 * to do a specific length check here to make sure</span>
<span class="cm">		 * the frame would have been ok, had we not stripped</span>
<span class="cm">		 * the tag.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">CMDSTS_OK</span> <span class="o">&amp;</span> <span class="n">cmdsts</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="n">CMDSTS_RUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">56</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">CMDSTS_OK</span> <span class="o">&amp;</span> <span class="n">cmdsts</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#endif</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">netdev_mangle_me_harder_failed</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="n">CMDSTS_DEST_MULTI</span><span class="p">)</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">extsts</span> <span class="o">&amp;</span> <span class="mh">0x002a0000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">extsts</span> <span class="o">&amp;</span> <span class="mh">0x00540000</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
<span class="cp">#ifdef NS83820_VLAN_ACCEL_SUPPORT</span>
			<span class="k">if</span><span class="p">(</span><span class="n">extsts</span> <span class="o">&amp;</span> <span class="n">EXTSTS_VPKT</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tag</span><span class="p">;</span>

				<span class="n">tag</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">extsts</span> <span class="o">&amp;</span> <span class="n">EXTSTS_VTG_MASK</span><span class="p">);</span>
				<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">rx_rc</span> <span class="o">=</span> <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NET_RX_DROP</span> <span class="o">==</span> <span class="n">rx_rc</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">netdev_mangle_me_harder_failed:</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">next_rx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rx</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">next_rx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rx</span> <span class="o">=</span> <span class="n">next_rx</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rx_desc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">next_rx</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Dprintk</span><span class="p">(</span><span class="s">&quot;dazed: cmdsts_f: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdsts</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_action</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">rx_irq</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ihr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IHR</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_RXDESC</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>

	<span class="n">rx_irq</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ns83820_rx_kick</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Packet Transmit code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">kick_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;kick_tx(%p): tx_idx=%d free_idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CR_TXE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* No spinlock needed on the transmit irq path as the interrupt handler is</span>
<span class="cm"> * serialized.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cmdsts</span><span class="p">,</span> <span class="n">tx_done_idx</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;do_tx_done(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">tx_done_idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">tx_done_idx</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tx_done_idx=%d free_idx=%d cmdsts=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tx_done_idx</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">]));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tx_done_idx</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">CMDSTS_OWN</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmdsts</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">])))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="n">CMDSTS_ERR</span><span class="p">)</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="n">CMDSTS_OK</span><span class="p">)</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="n">CMDSTS_OK</span><span class="p">)</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tx_done_idx=%d free_idx=%d cmdsts=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tx_done_idx</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">,</span> <span class="n">cmdsts</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">tx_done_idx</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">tx_done_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;done(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">cmdsts</span> <span class="o">&amp;</span> <span class="n">CMDSTS_LEN_MASK</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">desc_addr_get</span><span class="p">(</span><span class="n">desc</span> <span class="o">+</span> <span class="n">DESC_BUFPTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span>
					<span class="n">len</span><span class="p">,</span>
					<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr_tx_skbs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span>
					<span class="n">len</span><span class="p">,</span>
					<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">tx_done_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_done_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_TX_DESC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span> <span class="o">=</span> <span class="n">tx_done_idx</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">tx_done_idx</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allow network stack to resume queueing packets after we&#39;ve</span>
<span class="cm">	 * finished transmitting at least 1/4 of the packets in the queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">start_tx_okay</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;start_queue(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_cleanup_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NR_TX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__le32</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="n">desc_addr_get</span><span class="p">(</span><span class="n">desc</span> <span class="o">+</span> <span class="n">DESC_BUFPTR</span><span class="p">),</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">CMDSTS_LEN_MASK</span><span class="p">,</span>
					<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr_tx_skbs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NR_TX_DESC</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* transmit routine.  This code relies on the network layer serializing</span>
<span class="cm"> * its calls in, but will run happily in parallel with the interrupt</span>
<span class="cm"> * handler.  This code currently has provisions for fragmenting tx buffers</span>
<span class="cm"> * while trying to track down a bug in either the zero copy code or</span>
<span class="cm"> * the tx fifo (hence the MAX_FRAG_LEN).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ns83820_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">free_idx</span><span class="p">,</span> <span class="n">cmdsts</span><span class="p">,</span> <span class="n">extsts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_free</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tx_done_idx</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">first_desc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ns83820_hard_start_xmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nr_frags</span> <span class="o">=</span>  <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_LNKSTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_LNKSTS</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">last_idx</span> <span class="o">=</span> <span class="n">free_idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">;</span>
	<span class="n">tx_done_idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span><span class="p">;</span>
	<span class="n">nr_free</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_done_idx</span> <span class="o">+</span> <span class="n">NR_TX_DESC</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">free_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_TX_DESC</span><span class="p">;</span>
	<span class="n">nr_free</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_free</span> <span class="o">&lt;=</span> <span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;stop_queue - not enough(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

		<span class="cm">/* Check again: we may have raced with a tx done irq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span> <span class="o">!=</span> <span class="n">tx_done_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;restart queue(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
			<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_idx</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_intr_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_intr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_intr_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_intr_idx</span> <span class="o">+</span> <span class="n">NR_TX_DESC</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_TX_DESC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nr_free</span> <span class="o">-=</span> <span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_free</span> <span class="o">&lt;</span> <span class="n">MIN_TX_DESC_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;stop_queue - last entry(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frag</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_frags</span><span class="p">)</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">extsts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">extsts</span> <span class="o">|=</span> <span class="n">EXTSTS_IPPKT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IPPROTO_TCP</span> <span class="o">==</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span>
			<span class="n">extsts</span> <span class="o">|=</span> <span class="n">EXTSTS_TCPPKT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IPPROTO_UDP</span> <span class="o">==</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span>
			<span class="n">extsts</span> <span class="o">|=</span> <span class="n">EXTSTS_UDPPKT</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef NS83820_VLAN_ACCEL_SUPPORT</span>
	<span class="k">if</span><span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* fetch the vlan tag info out of the</span>
<span class="cm">		 * ancillary data if the vlan code</span>
<span class="cm">		 * is using hw vlan acceleration</span>
<span class="cm">		 */</span>
		<span class="kt">short</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">extsts</span> <span class="o">|=</span> <span class="p">(</span><span class="n">EXTSTS_VPKT</span> <span class="o">|</span> <span class="n">htons</span><span class="p">(</span><span class="n">tag</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_frags</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">first_desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">free_idx</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">free_idx</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;frag[%3u]: %4u @ 0x%08Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">free_idx</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">last_idx</span> <span class="o">=</span> <span class="n">free_idx</span><span class="p">;</span>
		<span class="n">free_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">free_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_TX_DESC</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">DESC_LINK</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">free_idx</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">desc_addr_set</span><span class="p">(</span><span class="n">desc</span> <span class="o">+</span> <span class="n">DESC_BUFPTR</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">DESC_EXTSTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">extsts</span><span class="p">);</span>

		<span class="n">cmdsts</span> <span class="o">=</span> <span class="p">((</span><span class="n">nr_frags</span><span class="p">)</span> <span class="o">?</span> <span class="n">CMDSTS_MORE</span> <span class="o">:</span> <span class="n">do_intr</span> <span class="o">?</span> <span class="n">CMDSTS_INTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cmdsts</span> <span class="o">|=</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="n">first_desc</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">CMDSTS_OWN</span><span class="p">;</span>
		<span class="n">cmdsts</span> <span class="o">|=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmdsts</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_frags</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;frag: buf=%08Lx  page=%08lx offset=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">),</span>
			<span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">frag</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nr_frags</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;done pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">last_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">first_desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CMDSTS_OWN</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span> <span class="o">=</span> <span class="n">free_idx</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr_tx_skbs</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">kick_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check again: we may have raced with a tx done irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span> <span class="o">!=</span> <span class="n">tx_done_idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">start_tx_okay</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/* the DP83820 will freeze counters, so we need to read all of them */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span>		<span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span>	<span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span>	<span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span>	<span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="cm">/*ndev-&gt;stats.rx_symbol_errors +=*/</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x70</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span>	<span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x74</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span>	<span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x78</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="cm">/*ndev-&gt;stats.rx_badopcode_errors += */</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x7c</span><span class="p">);</span>
	<span class="cm">/*ndev-&gt;stats.rx_pause_count += */</span>  <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="cm">/*ndev-&gt;stats.tx_pause_count += */</span>  <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x84</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span>	<span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">ns83820_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* somewhat overkill */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
	<span class="n">ns83820_update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Let ethtool retrieve info */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ns83820_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">tanar</span><span class="p">,</span> <span class="n">tbicr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fullduplex</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Here&#39;s the list of available ethtool commands from other drivers:</span>
<span class="cm">	 *	cmd-&gt;advertising =</span>
<span class="cm">	 *	ethtool_cmd_speed_set(cmd, ...)</span>
<span class="cm">	 *	cmd-&gt;duplex =</span>
<span class="cm">	 *	cmd-&gt;port = 0;</span>
<span class="cm">	 *	cmd-&gt;phy_address =</span>
<span class="cm">	 *	cmd-&gt;transceiver = 0;</span>
<span class="cm">	 *	cmd-&gt;autoneg =</span>
<span class="cm">	 *	cmd-&gt;maxtxpkt = 0;</span>
<span class="cm">	 *	cmd-&gt;maxrxpkt = 0;</span>
<span class="cm">	 */</span>

	<span class="cm">/* read current configuration */</span>
	<span class="n">cfg</span>   <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">)</span> <span class="o">^</span> <span class="n">SPDSTS_POLARITY</span><span class="p">;</span>
	<span class="n">tanar</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TANAR</span><span class="p">);</span>
	<span class="n">tbicr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TBICR</span><span class="p">);</span>

	<span class="n">fullduplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_DUPSTS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_TBI_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have optical interface */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span>       <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* we have copper */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			<span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
			<span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			<span class="n">SUPPORTED_MII</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">fullduplex</span> <span class="o">?</span> <span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">/</span> <span class="n">CFG_SPDSTS0</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_100</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">tbicr</span> <span class="o">&amp;</span> <span class="n">TBICR_MR_AN_ENABLE</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">:</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Let ethool change settings*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ns83820_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">tanar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">have_optical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fullduplex</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read current configuration */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">)</span> <span class="o">^</span> <span class="n">SPDSTS_POLARITY</span><span class="p">;</span>
	<span class="n">tanar</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TANAR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_TBI_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have optical */</span>
		<span class="n">have_optical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fullduplex</span>   <span class="o">=</span> <span class="p">(</span><span class="n">tanar</span> <span class="o">&amp;</span> <span class="n">TANAR_FULL_DUP</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* we have copper */</span>
		<span class="n">fullduplex</span> <span class="o">=</span> <span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_DUPSTS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="cm">/* Set duplex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">fullduplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">have_optical</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*set full duplex*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* force full duplex */</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">TXCFG_CSI</span> <span class="o">|</span> <span class="n">TXCFG_HBI</span> <span class="o">|</span> <span class="n">TXCFG_ATP</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">RXCFG_RX_FD</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">);</span>
				<span class="cm">/* Light up full duplex LED */</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">)</span> <span class="o">|</span> <span class="n">GPIOR_GP1_OUT</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*TODO: set half duplex */</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*we have copper*/</span>
			<span class="cm">/* TODO: Set duplex for copper cards */</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Duplex set via ethtool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set autonegotiation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* restart auto negotiation */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TBICR_MR_AN_ENABLE</span> <span class="o">|</span> <span class="n">TBICR_MR_RESTART_AN</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TBICR</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TBICR_MR_AN_ENABLE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TBICR</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">=</span> <span class="n">LINK_AUTONEGOTIATE</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: autoneg enabled via ethtool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* disable auto negotiation */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TBICR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: autoneg %s via ethtool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">?</span> <span class="s">&quot;ENABLED&quot;</span> <span class="o">:</span> <span class="s">&quot;DISABLED&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">phy_intr</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* end ethtool get/set support -df */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ns83820&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">ns83820_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">)</span> <span class="o">^</span> <span class="n">SPDSTS_POLARITY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">CFG_LNKSTS</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>    <span class="o">=</span> <span class="n">ns83820_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>    <span class="o">=</span> <span class="n">ns83820_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>     <span class="o">=</span> <span class="n">ns83820_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>        <span class="o">=</span> <span class="n">ns83820_get_link</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ns83820_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IER</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function is called in irq context from the ISR */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_mib_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ns83820_update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_do_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ns83820_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">foo</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">isr</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ns83820_irq(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ihr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;irq: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	<span class="n">ns83820_do_isr</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_do_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ISR_PHY</span> <span class="o">|</span> <span class="n">ISR_RXDESC</span> <span class="o">|</span> <span class="n">ISR_RXEARLY</span> <span class="o">|</span> <span class="n">ISR_RXOK</span> <span class="o">|</span> <span class="n">ISR_RXERR</span> <span class="o">|</span> <span class="n">ISR_TXIDLE</span> <span class="o">|</span> <span class="n">ISR_TXOK</span> <span class="o">|</span> <span class="n">ISR_TXDESC</span><span class="p">))</span>
		<span class="n">Dprintk</span><span class="p">(</span><span class="s">&quot;odd isr? 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISR_RXIDLE</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">idle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">Dprintk</span><span class="p">(</span><span class="s">&quot;oh dear, we are idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ns83820_rx_kick</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ISR_RXDESC</span> <span class="o">|</span> <span class="n">ISR_RXOK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">next_rx_desc</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISR_RXDESC</span> <span class="o">|</span> <span class="n">ISR_RXOK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>rx_irq(ndev);
writel(4, dev->base + IHR);</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ISR_RXIDLE</span> <span class="o">|</span> <span class="n">ISR_RXORN</span> <span class="o">|</span> <span class="n">ISR_RXDESC</span> <span class="o">|</span> <span class="n">ISR_RXOK</span> <span class="o">|</span> <span class="n">ISR_RXERR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">)</span>
		<span class="n">ns83820_rx_kick</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ISR_RXSOVR</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>printk("overrun: rxsovr\n");</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ISR_RXORN</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>printk("overrun: rxorn\n");</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ISR_RXRCMP</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">up</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">CR_RXE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISR_TXIDLE</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">txdp</span><span class="p">;</span>
		<span class="n">txdp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXDP</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;txdp: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txdp</span><span class="p">);</span>
		<span class="n">txdp</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="n">txdp</span> <span class="o">/</span> <span class="p">(</span><span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">&gt;=</span> <span class="n">NR_TX_DESC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: BUG -- txdp out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The may have been a race between a pci originated read</span>
<span class="cm">		 * and the descriptor update from the cpu.  Just in case,</span>
<span class="cm">		 * kick the transmitter if the hardware thinks it is on a</span>
<span class="cm">		 * different descriptor than we are.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">)</span>
			<span class="n">kick_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Defer tx ring processing until more than a minimum amount of</span>
<span class="cm">	 * work has accumulated</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ISR_TXDESC</span> <span class="o">|</span> <span class="n">ISR_TXIDLE</span> <span class="o">|</span> <span class="n">ISR_TXOK</span> <span class="o">|</span> <span class="n">ISR_TXERR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">do_tx_done</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Disable TxOk if there are no outstanding tx packets.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">&amp;</span> <span class="n">ISR_TXOK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISR_TXOK</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The TxIdle interrupt can come in before the transmit has</span>
<span class="cm">	 * completed.  Normally we reap packets off of the combination</span>
<span class="cm">	 * of TxDesc and TxIdle and leave TxOk disabled (since it</span>
<span class="cm">	 * occurs on every packet), but when no further irqs of this</span>
<span class="cm">	 * nature are expected, we must enable TxOk.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ISR_TXIDLE</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">|=</span> <span class="n">ISR_TXOK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* MIB interrupt: one of the statistics counters is about to overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ISR_MIB</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">))</span>
		<span class="n">ns83820_mib_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* PHY: Link up/down/negotiation state change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ISR_PHY</span> <span class="o">&amp;</span> <span class="n">isr</span><span class="p">))</span>
		<span class="n">phy_intr</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c">	/* Still working on the interrupt mitigation strategy */</span>
<span class="c">	if (dev-&gt;ihr)</span>
<span class="c">		writel(dev-&gt;ihr, dev-&gt;base + IHR);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_do_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dprintk</span><span class="p">(</span><span class="s">&quot;resetting chip...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CR</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">which</span><span class="p">);</span>
	<span class="n">Dprintk</span><span class="p">(</span><span class="s">&quot;okay!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ns83820_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* FIXME: protect against interrupt handler? */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_watchdog</span><span class="p">);</span>

	<span class="n">ns83820_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">ns83820_do_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR_RST</span><span class="p">);</span>

	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISR_TXURN</span> <span class="o">|</span> <span class="n">ISR_TXIDLE</span> <span class="o">|</span> <span class="n">ISR_TXERR</span> <span class="o">|</span> <span class="n">ISR_TXDESC</span> <span class="o">|</span> <span class="n">ISR_TXOK</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>

	<span class="n">ns83820_cleanup_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ns83820_cleanup_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
        <span class="n">u32</span> <span class="n">tx_done_idx</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tx_done_idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">tx_done_idx</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: tx_timeout: tx_done_idx=%d free_idx=%d cmdsts=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">tx_done_idx</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">]));</span>

<span class="cp">#if defined(DEBUG)</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">isr</span><span class="p">;</span>
		<span class="n">isr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;irq: %08x imr: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span><span class="p">);</span>
		<span class="n">ns83820_do_isr</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">do_tx_done</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">tx_done_idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">tx_done_idx</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: after: tx_done_idx=%d free_idx=%d cmdsts=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">tx_done_idx</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">DESC_CMDSTS</span><span class="p">]));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_tx_watch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ns83820_tx_watch: %u %u %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr_tx_skbs</span><span class="p">)</span>
		<span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_trans_start</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ns83820_tx_watch: %u %u %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_free_idx</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr_tx_skbs</span><span class="p">));</span>
		<span class="n">ns83820_tx_timeout</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_watchdog</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ns83820_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ns83820_open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PQCR</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ns83820_setup_rx</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">NR_TX_DESC</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NR_TX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="n">DESC_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">DESC_LINK</span><span class="p">]</span>
				<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span>
				  <span class="o">+</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NR_TX_DESC</span><span class="p">)</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXDP_HI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXDP</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_watchdog</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_watchdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_watchdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ns83820_tx_watch</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_watchdog</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>	<span class="cm">/* FIXME: wait for phy to come up */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">ns83820_stop</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_getmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

		<span class="cm">/* Read from the perfect match memory: this is loaded by</span>
<span class="cm">		 * the chip from the EEPROM via the EELOAD self test.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RFCR</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RFDR</span><span class="p">);</span>

		<span class="o">*</span><span class="n">mac</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mac</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ns83820_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">RX_BUF_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rfcr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RFCR</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">and_mask</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">or_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">or_mask</span> <span class="o">|=</span> <span class="n">RFCR_AAU</span> <span class="o">|</span> <span class="n">RFCR_AAM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">and_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RFCR_AAU</span> <span class="o">|</span> <span class="n">RFCR_AAM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">or_mask</span> <span class="o">|=</span> <span class="n">RFCR_AAM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">and_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RFCR_AAM</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">rfcr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">and_mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">or_mask</span><span class="p">;</span>
	<span class="cm">/* Ramit : RFCR Write Fix doc says RFEN must be 0 modify other bits */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RFCR_RFEN</span><span class="p">,</span> <span class="n">rfcr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rfcr</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_run_bist</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">,</span> <span class="n">u32</span> <span class="n">done</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: start %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PTSCR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PTSCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">enable</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">done</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">fail</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">fail</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s failed! (0x%08x &amp; 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">fail</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timed_out</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: run_bist %s timed out! (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: done %s in %d loops</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">loops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef PHY_CODE_IS_FINISHED</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* drive MDC low */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEAR_MDC</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>

	<span class="cm">/* enable output, set bit */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">|=</span> <span class="n">MEAR_MDDIR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">|=</span> <span class="n">MEAR_MDIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEAR_MDIO</span><span class="p">;</span>

	<span class="cm">/* set the output bit */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>

	<span class="cm">/* Wait.  Max clock rate is 2.5MHz, this way we come in under 1MHz */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* drive MDC high causing the data bit to be latched */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">|=</span> <span class="n">MEAR_MDC</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>

	<span class="cm">/* Wait again... */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="cm">/* drive MDC low, disable output */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEAR_MDC</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEAR_MDDIR</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>

	<span class="cm">/* Wait.  Max clock rate is 2.5MHz, this way we come in under 1MHz */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* drive MDC high causing the data bit to be latched */</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MEAR_MDIO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span> <span class="o">|=</span> <span class="n">MEAR_MDC</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">MEAR_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MEAR</span><span class="p">);</span>

	<span class="cm">/* Wait again... */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* read some garbage so that we eventually sync up */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* start */</span>
	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* opcode read */</span>
	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* write out the phy address: 5 bits, msb first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/* write out the register address, 5 bits, msb first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* turn around cycles */</span>
	<span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* read in the register data, 16 bits msb first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ns83820_mii_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* read some garbage so that we eventually sync up */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* start */</span>
	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* opcode read */</span>
	<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write out the phy address: 5 bits, msb first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/* write out the register address, 5 bits, msb first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* turn around cycles */</span>
	<span class="n">ns83820_mii_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* read in the register data, 16 bits msb first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns83820_mii_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ns83820_probe_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">first</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#define MII_PHYIDR1	0x02</span>
<span class="cp">#define MII_PHYIDR2	0x03</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (!first) {</span>
<span class="c">		unsigned tmp;</span>
<span class="c">		ns83820_mii_read_reg(dev, 1, 0x09);</span>
<span class="c">		ns83820_mii_write_reg(dev, 1, 0x10, 0x0d3e);</span>

<span class="c">		tmp = ns83820_mii_read_reg(dev, 1, 0x00);</span>
<span class="c">		ns83820_mii_write_reg(dev, 1, 0x00, tmp | 0x8000);</span>
<span class="c">		udelay(1300);</span>
<span class="c">		ns83820_mii_read_reg(dev, 1, 0x09);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_PHYIDR1</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_PHYIDR2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>printk("%s: phy %d: 0x%04x 0x%04x\n",
ndev->name, i, a, b);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mh">0x16</span><span class="p">;</span> <span class="n">j</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: [0x%02x] %04x %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
				<span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span>
				<span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span>
				<span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span>
				<span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
				<span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
		<span class="cm">/* read firmware version: memory addr is 0x8402 and 0x8403 */</span>
		<span class="n">ns83820_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">);</span>
		<span class="n">ns83820_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x810e</span><span class="p">);</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>

		<span class="n">ns83820_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">);</span>
		<span class="n">ns83820_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x810e</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">ns83820_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;version: 0x%04x 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ns83820_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ns83820_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ns83820_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">ns83820_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">ns83820_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ns83820_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ns83820_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">ns83820_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* See if we can set the dma mask early on; failure is fatal. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci_set_dma_mask failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ns83820</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">misc_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tq_refill</span><span class="p">,</span> <span class="n">queue_refill</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">,</span> <span class="n">rx_action</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci_enable_dev failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="mi">4</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">NR_TX_DESC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="mi">4</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">NR_RX_DESC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%p: %08lx  %p: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span><span class="p">);</span>

	<span class="n">ns83820_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">IMR_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ns83820_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register irq %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: we are holding rtnl_lock() over obscenely long area only</span>
<span class="cm">	 * because some of the setup code uses dev-&gt;name.  It&#39;s Wrong(tm) -</span>
<span class="cm">	 * we should be using driver-specific names for all that stuff.</span>
<span class="cm">	 * For now that will do, but we really need to come back and kill</span>
<span class="cm">	 * most of the dev_alloc_name() users later.</span>
<span class="cm">	 */</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to get netdev name: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ns83820.c: 0x22c: %08x, subsystem: %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x22c</span><span class="p">)),</span>
		<span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">ns83820_do_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR_RST</span><span class="p">);</span>

	<span class="cm">/* Must reset the ram bist before running it */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PTSCR_RBIST_RST</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PTSCR</span><span class="p">);</span>
	<span class="n">ns83820_run_bist</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;sram bist&quot;</span><span class="p">,</span>   <span class="n">PTSCR_RBIST_EN</span><span class="p">,</span>
			 <span class="n">PTSCR_RBIST_DONE</span><span class="p">,</span> <span class="n">PTSCR_RBIST_FAIL</span><span class="p">);</span>
	<span class="n">ns83820_run_bist</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;eeprom bist&quot;</span><span class="p">,</span> <span class="n">PTSCR_EEBIST_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">PTSCR_EEBIST_FAIL</span><span class="p">);</span>
	<span class="n">ns83820_run_bist</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;eeprom load&quot;</span><span class="p">,</span> <span class="n">PTSCR_EELOAD_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* I love config registers */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_PCI64_DET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: detected 64 bit PCI data bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/*dev-&gt;CFG_cache |= CFG_DATA64_EN;*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_DATA64_EN</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: EEPROM did not enable 64 bit bus.  Disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CFG_DATA64_EN</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">CFG_TBI_EN</span>  <span class="o">|</span> <span class="n">CFG_MRM_DIS</span>   <span class="o">|</span> <span class="n">CFG_MWI_DIS</span> <span class="o">|</span>
			   <span class="n">CFG_T64ADDR</span> <span class="o">|</span> <span class="n">CFG_DATA64_EN</span> <span class="o">|</span> <span class="n">CFG_EXT_125</span> <span class="o">|</span>
			   <span class="n">CFG_M64ADDR</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">CFG_PINT_DUPSTS</span> <span class="o">|</span> <span class="n">CFG_PINT_LNKSTS</span> <span class="o">|</span> <span class="n">CFG_PINT_SPDSTS</span> <span class="o">|</span>
			  <span class="n">CFG_EXTSTS_EN</span>   <span class="o">|</span> <span class="n">CFG_EXD</span>         <span class="o">|</span> <span class="n">CFG_PESEL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">CFG_REQALG</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">CFG_POW</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">CFG_TMRTEST</span><span class="p">;</span>

	<span class="cm">/* When compiled with 64 bit addressing, we must always enable</span>
<span class="cm">	 * the 64 bit descriptor format.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">CFG_M64ADDR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">using_dac</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">CFG_T64ADDR</span><span class="p">;</span>

	<span class="cm">/* Big endian mode does not seem to do what the docs suggest */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_BEM</span><span class="p">;</span>

	<span class="cm">/* setup optical transceiver if we have one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">&amp;</span> <span class="n">CFG_TBI_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: enabling optical transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3e8</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">GPIOR</span><span class="p">);</span>

		<span class="cm">/* setup auto negotiation feature advertisement */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TANAR</span><span class="p">)</span>
		       <span class="o">|</span> <span class="n">TANAR_HALF_DUP</span> <span class="o">|</span> <span class="n">TANAR_FULL_DUP</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TANAR</span><span class="p">);</span>

		<span class="cm">/* start auto negotiation */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TBICR_MR_AN_ENABLE</span> <span class="o">|</span> <span class="n">TBICR_MR_RESTART_AN</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TBICR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TBICR_MR_AN_ENABLE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TBICR</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">=</span> <span class="n">LINK_AUTONEGOTIATE</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|=</span> <span class="n">CFG_MODE_1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;CFG: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: resetting phy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span> <span class="o">|</span> <span class="n">CFG_PHY_RST</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CFG_cache</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c">	/* Huh?  This sets the PCI latency register.  Should be done via</span>
<span class="c">	 * the PCI layer.  FIXME.</span>
<span class="c">	 */</span>
<span class="c">	if (readl(dev-&gt;base + SRR))</span>
<span class="c">		writel(readl(dev-&gt;base+0x20c) | 0xfe00, dev-&gt;base + 0x20c);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Note!  The DMA burst size interacts with packet</span>
<span class="cm">	 * transmission, such that the largest packet that</span>
<span class="cm">	 * can be transmitted is 8192 - FLTH - burst size.</span>
<span class="cm">	 * If only the transmit fifo was larger...</span>
<span class="cm">	 */</span>
	<span class="cm">/* Ramit : 1024 DMA is not a good idea, it ends up banging</span>
<span class="cm">	 * some DELL and COMPAQ SMP systems */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TXCFG_CSI</span> <span class="o">|</span> <span class="n">TXCFG_HBI</span> <span class="o">|</span> <span class="n">TXCFG_ATP</span> <span class="o">|</span> <span class="n">TXCFG_MXDMA512</span>
		<span class="o">|</span> <span class="p">((</span><span class="mi">1600</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TXCFG</span><span class="p">);</span>

	<span class="cm">/* Flush the interrupt holdoff timer */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x000</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IHR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IHR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x000</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">IHR</span><span class="p">);</span>

	<span class="cm">/* Set Rx to full duplex, don&#39;t accept runt, errored, long or length</span>
<span class="cm">	 * range errored packets.  Use 512 byte DMA.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Ramit : 1024 DMA is not a good idea, it ends up banging</span>
<span class="cm">	 * some DELL and COMPAQ SMP systems</span>
<span class="cm">	 * Turn on ALP, only we are accpeting Jumbo Packets */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RXCFG_AEP</span> <span class="o">|</span> <span class="n">RXCFG_ARP</span> <span class="o">|</span> <span class="n">RXCFG_AIRL</span> <span class="o">|</span> <span class="n">RXCFG_RX_FD</span>
		<span class="o">|</span> <span class="n">RXCFG_STRIPCRC</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>| RXCFG_ALP</p></td><td class="code"><div class="highlight"><pre>		<span class="o">|</span> <span class="p">(</span><span class="n">RXCFG_MXDMA512</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RXCFG</span><span class="p">);</span>

	<span class="cm">/* Disable priority queueing */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PQCR</span><span class="p">);</span>

	<span class="cm">/* Enable IP checksum validation and detetion of VLAN headers.</span>
<span class="cm">	 * Note: do not set the reject options as at least the 0x102</span>
<span class="cm">	 * revision of the chip does not properly accept IP fragments</span>
<span class="cm">	 * at least for UDP.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Ramit : Be sure to turn on RXCFG_ARP if VLAN&#39;s are enabled, since</span>
<span class="cm">	 * the MAC it calculates the packetsize AFTER stripping the VLAN</span>
<span class="cm">	 * header, and if a VLAN Tagged packet of 64 bytes is received (like</span>
<span class="cm">	 * a ping with a VLAN header) then the card, strips the 4 byte VLAN</span>
<span class="cm">	 * tag and then checks the packet size, so if RXCFG_ARP is not enabled,</span>
<span class="cm">	 * it discrards it!.  These guys......</span>
<span class="cm">	 * also turn on tag stripping if hardware acceleration is enabled</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef NS83820_VLAN_ACCEL_SUPPORT</span>
<span class="cp">#define VRCR_INIT_VALUE (VRCR_IPEN|VRCR_VTDEN|VRCR_VTREN)</span>
<span class="cp">#else</span>
<span class="cp">#define VRCR_INIT_VALUE (VRCR_IPEN|VRCR_VTDEN)</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">VRCR_INIT_VALUE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VRCR</span><span class="p">);</span>

	<span class="cm">/* Enable per-packet TCP/UDP/IP checksumming</span>
<span class="cm">	 * and per packet vlan tag insertion if</span>
<span class="cm">	 * vlan hardware acceleration is enabled</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef NS83820_VLAN_ACCEL_SUPPORT</span>
<span class="cp">#define VTCR_INIT_VALUE (VTCR_PPCHK|VTCR_VPPTI)</span>
<span class="cp">#else</span>
<span class="cp">#define VTCR_INIT_VALUE VTCR_PPCHK</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">VTCR_INIT_VALUE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VTCR</span><span class="p">);</span>

	<span class="cm">/* Ramit : Enable async and sync pause frames */</span>
	<span class="cm">/* writel(0, dev-&gt;base + PCR); */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">PCR_PS_MCAST</span> <span class="o">|</span> <span class="n">PCR_PS_DA</span> <span class="o">|</span> <span class="n">PCR_PSEN</span> <span class="o">|</span> <span class="n">PCR_FFLO_4K</span> <span class="o">|</span>
		<span class="n">PCR_FFHI_8K</span> <span class="o">|</span> <span class="n">PCR_STLO_4</span> <span class="o">|</span> <span class="n">PCR_STHI_8</span> <span class="o">|</span> <span class="n">PCR_PAUSE_CNT</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PCR</span><span class="p">);</span>

	<span class="cm">/* Disable Wake On Lan */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WCSR</span><span class="p">);</span>

	<span class="n">ns83820_getmac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* Yes, we support dumb IP checksum on transmit */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>

<span class="cp">#ifdef NS83820_VLAN_ACCEL_SUPPORT</span>
	<span class="cm">/* We also support hardware vlan acceleration */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">using_dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: using 64 bit addressing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: ns83820 v&quot;</span> <span class="n">VERSION</span> <span class="s">&quot;: DP83820 v%u.%u: %pM io=0x%08lx irq=%d f=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SRR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SRR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;h,sg&quot;</span> <span class="o">:</span> <span class="s">&quot;sg&quot;</span>
		<span class="p">);</span>

<span class="cp">#ifdef PHY_CODE_IS_FINISHED</span>
	<span class="n">ns83820_probe_phy</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdevice</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ns83820: unable to register netdev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_cleanup:</span>
	<span class="n">ns83820_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* paranoia */</span>
<span class="nl">out_free_irq:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
<span class="nl">out_disable:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">NR_TX_DESC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">NR_RX_DESC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">ns83820_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ns83820</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PRIV</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span> <span class="cm">/* ok even if NULL */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>			<span class="cm">/* paranoia */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ns83820_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* paranoia */</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">NR_TX_DESC</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_descs</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_phy_descs</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">DESC_SIZE</span> <span class="o">*</span> <span class="n">NR_RX_DESC</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">descs</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">phy_descs</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">ns83820_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x100b</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ns83820&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ns83820_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ns83820_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ns83820_remove_one</span><span class="p">),</span>
<span class="cp">#if 0</span><span class="c">	/* FIXME: implement */</span>
<span class="c">	.suspend	= ,</span>
<span class="c">	.resume		= ,</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">ns83820_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ns83820.c: National Semiconductor DP83820 10/100/1000 driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">ns83820_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Benjamin LaHaise &lt;bcrl@kvack.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;National Semiconductor DP83820 10/100/1000 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ns83820_pci_tbl</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">lnksts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lnksts</span><span class="p">,</span> <span class="s">&quot;Polarity of LNKSTS bit&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ihr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ihr</span><span class="p">,</span> <span class="s">&quot;Time in 100 us increments to delay interrupts (range 0-127)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">reset_phy</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reset_phy</span><span class="p">,</span> <span class="s">&quot;Set to 1 to reset the PHY on startup&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ns83820_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ns83820_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
