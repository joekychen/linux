<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › natsemi › macsonic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>macsonic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * macsonic.c</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 2005 Finn Thain</span>
<span class="cm"> *</span>
<span class="cm"> * Converted to DMA API, converted to unified driver model, made it work as</span>
<span class="cm"> * a module again, and from the mac68k project, introduced more 32-bit cards</span>
<span class="cm"> * and dhd&#39;s support for 16-bit cards.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 1998 Alan Cox</span>
<span class="cm"> *</span>
<span class="cm"> * Debugging Andreas Ehliar, Michael Schmitz</span>
<span class="cm"> *</span>
<span class="cm"> * Based on code</span>
<span class="cm"> * (C) 1996 by Thomas Bogendoerfer (tsbogend@bigbug.franken.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is based on work from Andreas Busse, but most of</span>
<span class="cm"> * the code is rewritten.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 1995 by Andreas Busse (andy@waldorf-gmbh.de)</span>
<span class="cm"> *</span>
<span class="cm"> * A driver for the Mac onboard Sonic ethernet chip.</span>
<span class="cm"> *</span>
<span class="cm"> * 98/12/21 MSch: judged from tests on Q800, it&#39;s basically working,</span>
<span class="cm"> *		  but eating up both receive and transmit resources</span>
<span class="cm"> *		  and duplicating packets. Needs more testing.</span>
<span class="cm"> *</span>
<span class="cm"> * 99/01/03 MSch: upgraded to version 0.92 of the core driver, fixed.</span>
<span class="cm"> *</span>
<span class="cm"> * 00/10/31 sammy@oh.verio.com: Updated driver for 2.4 kernels, fixed problems</span>
<span class="cm"> *          on centris.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/nubus.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/bootinfo.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/hwtest.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/macintosh.h&gt;</span>
<span class="cp">#include &lt;asm/macints.h&gt;</span>
<span class="cp">#include &lt;asm/mac_via.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">mac_sonic_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;macsonic&quot;</span><span class="p">;</span>

<span class="cp">#include &quot;sonic.h&quot;</span>

<span class="cm">/* These should basically be bus-size and endian independent (since</span>
<span class="cm">   the SONIC is at least smart enough that it uses the same endianness</span>
<span class="cm">   as the host, unlike certain less enlightened Macintosh NICs) */</span>
<span class="cp">#define SONIC_READ(reg) (nubus_readw(dev-&gt;base_addr + (reg * 4) \</span>
<span class="cp">	      + lp-&gt;reg_offset))</span>
<span class="cp">#define SONIC_WRITE(reg,val) (nubus_writew(val, dev-&gt;base_addr + (reg * 4) \</span>
<span class="cp">	      + lp-&gt;reg_offset))</span>

<span class="cm">/* use 0 for production, 1 for verification, &gt;1 for debug */</span>
<span class="cp">#ifdef SONIC_DEBUG</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sonic_debug</span> <span class="o">=</span> <span class="n">SONIC_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sonic_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sonic_version_printed</span><span class="p">;</span>

<span class="cm">/* For onboard SONIC */</span>
<span class="cp">#define ONBOARD_SONIC_REGISTERS	0x50F0A000</span>
<span class="cp">#define ONBOARD_SONIC_PROM_BASE	0x50f08000</span>

<span class="k">enum</span> <span class="n">macsonic_type</span> <span class="p">{</span>
	<span class="n">MACSONIC_DUODOCK</span><span class="p">,</span>
	<span class="n">MACSONIC_APPLE</span><span class="p">,</span>
	<span class="n">MACSONIC_APPLE16</span><span class="p">,</span>
	<span class="n">MACSONIC_DAYNA</span><span class="p">,</span>
	<span class="n">MACSONIC_DAYNALINK</span>
<span class="p">};</span>

<span class="cm">/* For the built-in SONIC in the Duo Dock */</span>
<span class="cp">#define DUODOCK_SONIC_REGISTERS 0xe10000</span>
<span class="cp">#define DUODOCK_SONIC_PROM_BASE 0xe12000</span>

<span class="cm">/* For Apple-style NuBus SONIC */</span>
<span class="cp">#define APPLE_SONIC_REGISTERS	0</span>
<span class="cp">#define APPLE_SONIC_PROM_BASE	0x40000</span>

<span class="cm">/* Daynalink LC SONIC */</span>
<span class="cp">#define DAYNALINK_PROM_BASE 0x400000</span>

<span class="cm">/* For Dayna-style NuBus SONIC (haven&#39;t seen one yet) */</span>
<span class="cp">#define DAYNA_SONIC_REGISTERS   0x180000</span>
<span class="cm">/* This is what OpenBSD says.  However, this is definitely in NuBus</span>
<span class="cm">   ROM space so we should be able to get it by walking the NuBus</span>
<span class="cm">   resource directories */</span>
<span class="cp">#define DAYNA_SONIC_MAC_ADDR	0xffe004</span>

<span class="cp">#define SONIC_READ_PROM(addr) nubus_readb(prom_addr+addr)</span>

<span class="cm">/*</span>
<span class="cm"> * For reversing the PROM address</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bit_reverse_addr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">macsonic_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">sonic_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">macsonic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sonic_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;sonic&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to get IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Under the A/UX interrupt scheme, the onboard SONIC interrupt comes</span>
<span class="cm">	 * in at priority level 3. However, we sometimes get the level 2 inter-</span>
<span class="cm">	 * rupt as well, which must prevent re-entrance of the sonic handler.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">IRQ_AUTO_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_NUBUS_9</span><span class="p">,</span> <span class="n">macsonic_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="s">&quot;sonic&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to get IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IRQ_NUBUS_9</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sonic_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_irq_nubus</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_irq_nubus:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">IRQ_AUTO_3</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_NUBUS_9</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">macsonic_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sonic_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">IRQ_AUTO_3</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_NUBUS_9</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">macsonic_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">macsonic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">macsonic_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sonic_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">sonic_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">sonic_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">sonic_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">macsonic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sonic_local</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Allocate the entire chunk of memory for the descriptors.</span>
<span class="cm">           Note that this cannot cross a 64K boundary. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">descriptors</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
	            <span class="n">SIZEOF_SONIC_DESC</span> <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">),</span>
	            <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">descriptors_laddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: couldn&#39;t alloc DMA memory for descriptors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now set up the pointers to point to the appropriate places */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tda</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZEOF_SONIC_CDA</span>
	                     <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rda</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tda</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZEOF_SONIC_TD</span> <span class="o">*</span> <span class="n">SONIC_NUM_TDS</span>
	                     <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rra</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rda</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZEOF_SONIC_RD</span> <span class="o">*</span> <span class="n">SONIC_NUM_RDS</span>
	                     <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">));</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cda_laddr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">descriptors_laddr</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tda_laddr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cda_laddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZEOF_SONIC_CDA</span>
	                     <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rda_laddr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tda_laddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZEOF_SONIC_TD</span> <span class="o">*</span> <span class="n">SONIC_NUM_TDS</span>
	                     <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rra_laddr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rda_laddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZEOF_SONIC_RD</span> <span class="o">*</span> <span class="n">SONIC_NUM_RDS</span>
	                     <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macsonic_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear tally counter</span>
<span class="cm">	 */</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_CRCT</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_FAET</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_MPT</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define INVALID_MAC(mac) (memcmp(mac, &quot;\x08\x00\x07&quot;, 3) &amp;&amp; \</span>
<span class="cp">                          memcmp(mac, &quot;\x00\xA0\x40&quot;, 3) &amp;&amp; \</span>
<span class="cp">                          memcmp(mac, &quot;\x00\x80\x19&quot;, 3) &amp;&amp; \</span>
<span class="cp">                          memcmp(mac, &quot;\x00\x05\x02&quot;, 3))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">mac_onboard_sonic_ethernet_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sonic_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">prom_addr</span> <span class="o">=</span> <span class="n">ONBOARD_SONIC_PROM_BASE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On NuBus boards we can sometimes look in the ROM resources.</span>
<span class="cm">	 * No such luck for comm-slot/onboard.</span>
<span class="cm">	 * On the PowerBook 520, the PROM base address is a mystery.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwreg_present</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">prom_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SONIC_READ_PROM</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">INVALID_MAC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Most of the time, the address is bit-reversed. The NetBSD</span>
<span class="cm">		 * source has a rather long and detailed historical account of</span>
<span class="cm">		 * why this is so.</span>
<span class="cm">		 */</span>
		<span class="n">bit_reverse_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">INVALID_MAC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we still have what seems to be a bogus address, we&#39;ll</span>
<span class="cm">		 * look in the CAM. The top entry should be ours.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;macsonic: MAC address in PROM seems &quot;</span>
		                    <span class="s">&quot;to be invalid, trying CAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;macsonic: cannot read MAC address from &quot;</span>
		                    <span class="s">&quot;PROM, trying CAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This only works if MacOS has already initialized the card. */</span>

	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_CMD</span><span class="p">,</span> <span class="n">SONIC_CR_RST</span><span class="p">);</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_CEP</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_CAP2</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_CAP1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_CAP0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">INVALID_MAC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Still nonsense ... messed up someplace! */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;macsonic: MAC address in CAM entry 15 &quot;</span>
	                    <span class="s">&quot;seems invalid, will use a random MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mac_onboard_sonic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sonic_local</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">commslot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_MAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Checking for internal Macintosh ethernet (SONIC).. &quot;</span><span class="p">);</span>

	<span class="cm">/* Bogus probing, on the models which may or may not have</span>
<span class="cm">	   Ethernet (BTW, the Ethernet *is* always at the same</span>
<span class="cm">	   address, and nothing else lives there, at least if Apple&#39;s</span>
<span class="cm">	   documentation is to be believed) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_Q630</span> <span class="o">||</span>
	    <span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_P588</span> <span class="o">||</span>
	    <span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_P575</span> <span class="o">||</span>
	    <span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_C610</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">card_present</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">card_present</span> <span class="o">=</span> <span class="n">hwreg_present</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">ONBOARD_SONIC_REGISTERS</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card_present</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;none.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">commslot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;yes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Danger!  My arms are flailing wildly!  You *must* set lp-&gt;reg_offset</span>
<span class="cm">	 * and dev-&gt;base_addr before using SONIC_READ() or SONIC_WRITE() */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ONBOARD_SONIC_REGISTERS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">via_alt_mapping</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_AUTO_3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_NUBUS_9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sonic_version_printed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
		<span class="n">sonic_version_printed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: onboard / comm-slot SONIC at 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="cm">/* The PowerBook&#39;s SONIC is 16 bit always. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_PB520</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE16</span><span class="p">;</span>
		<span class="n">sr</span> <span class="o">=</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_SR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">commslot</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Some of the comm-slot cards are 16 bit.  But some</span>
<span class="cm">		   of them are not.  The 32-bit cards use offset 2 and</span>
<span class="cm">		   have known revisions, we try reading the revision</span>
<span class="cm">		   register at offset 2, if we don&#39;t get a known revision</span>
<span class="cm">		   we assume 16 bit at offset 0.  */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE16</span><span class="p">;</span>

		<span class="n">sr</span> <span class="o">=</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_SR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">==</span> <span class="mh">0x0004</span> <span class="o">||</span> <span class="n">sr</span> <span class="o">==</span> <span class="mh">0x0006</span> <span class="o">||</span> <span class="n">sr</span> <span class="o">==</span> <span class="mh">0x0100</span> <span class="o">||</span> <span class="n">sr</span> <span class="o">==</span> <span class="mh">0x0101</span><span class="p">)</span>
			<span class="cm">/* 83932 is 0x0004 or 0x0006, 83934 is 0x0100 or 0x0101 */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE32</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE16</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sr</span> <span class="o">=</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_SR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* All onboard cards are at offset 2 with 32 bit DMA. */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE32</span><span class="p">;</span>
		<span class="n">sr</span> <span class="o">=</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_SR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;%s: revision 0x%04x, using %d bit DMA and register offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">sr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="o">?</span><span class="mi">32</span><span class="o">:</span><span class="mi">16</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"> /* This is sometimes useful to find out how MacOS configured the card. */</span>
<span class="c">	printk(KERN_INFO &quot;%s: DCR: 0x%04x, DCR2: 0x%04x\n&quot;, dev_name(lp-&gt;device),</span>
<span class="c">	       SONIC_READ(SONIC_DCR) &amp; 0xffff, SONIC_READ(SONIC_DCR2) &amp; 0xffff);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Software reset, then initialize control registers. */</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_CMD</span><span class="p">,</span> <span class="n">SONIC_CR_RST</span><span class="p">);</span>

	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_DCR</span><span class="p">,</span> <span class="n">SONIC_DCR_EXBUS</span> <span class="o">|</span> <span class="n">SONIC_DCR_BMS</span> <span class="o">|</span>
	                       <span class="n">SONIC_DCR_RFT1</span>  <span class="o">|</span> <span class="n">SONIC_DCR_TFT0</span> <span class="o">|</span>
	                       <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span> <span class="o">?</span> <span class="n">SONIC_DCR_DW</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* This *must* be written back to in order to restore the</span>
<span class="cm">	 * extended programmable output bits, as it may not have been</span>
<span class="cm">	 * initialised since the hardware reset. */</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_DCR2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Clear *and* disable interrupts to be on the safe side */</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_ISR</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">);</span>

	<span class="cm">/* Now look for the MAC address. */</span>
	<span class="n">mac_onboard_sonic_ethernet_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Shared init code */</span>
	<span class="k">return</span> <span class="n">macsonic_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mac_nubus_sonic_ethernet_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prom_addr</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SONIC_READ_PROM</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Some of the addresses are bit-reversed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">MACSONIC_DAYNA</span><span class="p">)</span>
		<span class="n">bit_reverse_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">macsonic_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dev</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_hw</span> <span class="o">==</span> <span class="n">NUBUS_DRHW_ASANTE_LC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_sw</span> <span class="o">==</span> <span class="n">NUBUS_DRSW_SONIC_LC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MACSONIC_DAYNALINK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_hw</span> <span class="o">==</span> <span class="n">NUBUS_DRHW_SONIC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_sw</span> <span class="o">==</span> <span class="n">NUBUS_DRSW_APPLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* There has to be a better way to do this... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DuoDock&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">MACSONIC_DUODOCK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">MACSONIC_APPLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_hw</span> <span class="o">==</span> <span class="n">NUBUS_DRHW_SMC9194</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_sw</span> <span class="o">==</span> <span class="n">NUBUS_DRSW_DAYNA</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MACSONIC_DAYNA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_hw</span> <span class="o">==</span> <span class="n">NUBUS_DRHW_APPLE_SONIC_LC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_sw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* huh? */</span>
		<span class="k">return</span> <span class="n">MACSONIC_APPLE16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mac_nubus_sonic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">slots</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sonic_local</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span> <span class="n">prom_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sonic_dcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">dma_bitmode</span><span class="p">;</span>

	<span class="cm">/* Find the first SONIC that hasn&#39;t been initialized already */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">nubus_find_type</span><span class="p">(</span><span class="n">NUBUS_CAT_NETWORK</span><span class="p">,</span>
				       <span class="n">NUBUS_TYPE_ETHERNET</span><span class="p">,</span> <span class="n">ndev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Have we seen it already? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slots</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">slots</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>

		<span class="cm">/* Is it one of ours? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">=</span> <span class="n">macsonic_ident</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MACSONIC_DUODOCK</span>:
		<span class="n">base_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">DUODOCK_SONIC_REGISTERS</span><span class="p">;</span>
		<span class="n">prom_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">DUODOCK_SONIC_PROM_BASE</span><span class="p">;</span>
		<span class="n">sonic_dcr</span> <span class="o">=</span> <span class="n">SONIC_DCR_EXBUS</span> <span class="o">|</span> <span class="n">SONIC_DCR_RFT0</span> <span class="o">|</span> <span class="n">SONIC_DCR_RFT1</span> <span class="o">|</span>
		            <span class="n">SONIC_DCR_TFT0</span><span class="p">;</span>
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MACSONIC_APPLE</span>:
		<span class="n">base_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">APPLE_SONIC_REGISTERS</span><span class="p">;</span>
		<span class="n">prom_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">APPLE_SONIC_PROM_BASE</span><span class="p">;</span>
		<span class="n">sonic_dcr</span> <span class="o">=</span> <span class="n">SONIC_DCR_BMS</span> <span class="o">|</span> <span class="n">SONIC_DCR_RFT1</span> <span class="o">|</span> <span class="n">SONIC_DCR_TFT0</span><span class="p">;</span>
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MACSONIC_APPLE16</span>:
		<span class="n">base_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">APPLE_SONIC_REGISTERS</span><span class="p">;</span>
		<span class="n">prom_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">APPLE_SONIC_PROM_BASE</span><span class="p">;</span>
		<span class="n">sonic_dcr</span> <span class="o">=</span> <span class="n">SONIC_DCR_EXBUS</span> <span class="o">|</span> <span class="n">SONIC_DCR_RFT1</span> <span class="o">|</span> <span class="n">SONIC_DCR_TFT0</span> <span class="o">|</span>
		            <span class="n">SONIC_DCR_PO1</span> <span class="o">|</span> <span class="n">SONIC_DCR_BMS</span><span class="p">;</span>
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MACSONIC_DAYNALINK</span>:
		<span class="n">base_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">APPLE_SONIC_REGISTERS</span><span class="p">;</span>
		<span class="n">prom_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">DAYNALINK_PROM_BASE</span><span class="p">;</span>
		<span class="n">sonic_dcr</span> <span class="o">=</span> <span class="n">SONIC_DCR_RFT1</span> <span class="o">|</span> <span class="n">SONIC_DCR_TFT0</span> <span class="o">|</span>
		            <span class="n">SONIC_DCR_PO1</span> <span class="o">|</span> <span class="n">SONIC_DCR_BMS</span><span class="p">;</span>
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MACSONIC_DAYNA</span>:
		<span class="n">base_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">DAYNA_SONIC_REGISTERS</span><span class="p">;</span>
		<span class="n">prom_addr</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">+</span> <span class="n">DAYNA_SONIC_MAC_ADDR</span><span class="p">;</span>
		<span class="n">sonic_dcr</span> <span class="o">=</span> <span class="n">SONIC_DCR_BMS</span> <span class="o">|</span>
		            <span class="n">SONIC_DCR_RFT1</span> <span class="o">|</span> <span class="n">SONIC_DCR_TFT0</span> <span class="o">|</span> <span class="n">SONIC_DCR_PO1</span><span class="p">;</span>
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">SONIC_BITMODE16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;macsonic: WTF, id is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Danger!  My arms are flailing wildly!  You *must* set lp-&gt;reg_offset</span>
<span class="cm">	 * and dev-&gt;base_addr before using SONIC_READ() or SONIC_WRITE() */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">base_addr</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="n">reg_offset</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span> <span class="o">=</span> <span class="n">dma_bitmode</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">SLOT2IRQ</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sonic_version_printed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
		<span class="n">sonic_version_printed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s in slot %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: revision 0x%04x, using %d bit DMA and register offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">SONIC_READ</span><span class="p">(</span><span class="n">SONIC_SR</span><span class="p">),</span> <span class="n">dma_bitmode</span><span class="o">?</span><span class="mi">32</span><span class="o">:</span><span class="mi">16</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"> /* This is sometimes useful to find out how MacOS configured the card. */</span>
<span class="c">	printk(KERN_INFO &quot;%s: DCR: 0x%04x, DCR2: 0x%04x\n&quot;, dev_name(lp-&gt;device),</span>
<span class="c">	       SONIC_READ(SONIC_DCR) &amp; 0xffff, SONIC_READ(SONIC_DCR2) &amp; 0xffff);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Software reset, then initialize control registers. */</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_CMD</span><span class="p">,</span> <span class="n">SONIC_CR_RST</span><span class="p">);</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_DCR</span><span class="p">,</span> <span class="n">sonic_dcr</span> <span class="o">|</span> <span class="p">(</span><span class="n">dma_bitmode</span> <span class="o">?</span> <span class="n">SONIC_DCR_DW</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="cm">/* This *must* be written back to in order to restore the</span>
<span class="cm">	 * extended programmable output bits, since it may not have been</span>
<span class="cm">	 * initialised since the hardware reset. */</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_DCR2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Clear *and* disable interrupts to be on the safe side */</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SONIC_WRITE</span><span class="p">(</span><span class="n">SONIC_ISR</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">);</span>

	<span class="cm">/* Now look for the MAC address. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_nubus_sonic_ethernet_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prom_addr</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Shared init code */</span>
	<span class="k">return</span> <span class="n">macsonic_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mac_sonic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sonic_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sonic_local</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* This will catch fatal stuff like -ENOMEM as well as success */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mac_onboard_sonic_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mac_nubus_sonic_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: MAC %pM IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Macintosh SONIC ethernet driver&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sonic_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sonic_debug</span><span class="p">,</span> <span class="s">&quot;macsonic debug level (1-4)&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:macsonic&quot;</span><span class="p">);</span>

<span class="cp">#include &quot;sonic.c&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">mac_sonic_device_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sonic_local</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">SIZEOF_SONIC_DESC</span> <span class="o">*</span> <span class="n">SONIC_BUS_SCALE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_bitmode</span><span class="p">),</span>
	                  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">descriptors_laddr</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mac_sonic_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>  <span class="o">=</span> <span class="n">mac_sonic_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mac_sonic_device_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">mac_sonic_string</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mac_sonic_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
