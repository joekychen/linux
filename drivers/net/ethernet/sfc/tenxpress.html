<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › sfc › tenxpress.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tenxpress.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/****************************************************************************</span>
<span class="cm"> * Driver for Solarflare Solarstorm network controllers and boards</span>
<span class="cm"> * Copyright 2007-2011 Solarflare Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> * by the Free Software Foundation, incorporated herein by reference.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;efx.h&quot;</span>
<span class="cp">#include &quot;mdio_10g.h&quot;</span>
<span class="cp">#include &quot;nic.h&quot;</span>
<span class="cp">#include &quot;phy.h&quot;</span>
<span class="cp">#include &quot;workarounds.h&quot;</span>

<span class="cm">/* We expect these MMDs to be in the package. */</span>
<span class="cp">#define TENXPRESS_REQUIRED_DEVS (MDIO_DEVS_PMAPMD	| \</span>
<span class="cp">				 MDIO_DEVS_PCS		| \</span>
<span class="cp">				 MDIO_DEVS_PHYXS	| \</span>
<span class="cp">				 MDIO_DEVS_AN)</span>

<span class="cp">#define SFX7101_LOOPBACKS ((1 &lt;&lt; LOOPBACK_PHYXS) |	\</span>
<span class="cp">			   (1 &lt;&lt; LOOPBACK_PCS) |	\</span>
<span class="cp">			   (1 &lt;&lt; LOOPBACK_PMAPMD) |	\</span>
<span class="cp">			   (1 &lt;&lt; LOOPBACK_PHYXS_WS))</span>

<span class="cm">/* We complain if we fail to see the link partner as 10G capable this many</span>
<span class="cm"> * times in a row (must be &gt; 1 as sampling the autoneg. registers is racy)</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_BAD_LP_TRIES	(5)</span>

<span class="cm">/* Extended control register */</span>
<span class="cp">#define PMA_PMD_XCONTROL_REG	49152</span>
<span class="cp">#define PMA_PMD_EXT_GMII_EN_LBN	1</span>
<span class="cp">#define PMA_PMD_EXT_GMII_EN_WIDTH 1</span>
<span class="cp">#define PMA_PMD_EXT_CLK_OUT_LBN	2</span>
<span class="cp">#define PMA_PMD_EXT_CLK_OUT_WIDTH 1</span>
<span class="cp">#define PMA_PMD_LNPGA_POWERDOWN_LBN 8</span>
<span class="cp">#define PMA_PMD_LNPGA_POWERDOWN_WIDTH 1</span>
<span class="cp">#define PMA_PMD_EXT_CLK312_WIDTH 1</span>
<span class="cp">#define PMA_PMD_EXT_LPOWER_LBN  12</span>
<span class="cp">#define PMA_PMD_EXT_LPOWER_WIDTH 1</span>
<span class="cp">#define PMA_PMD_EXT_ROBUST_LBN	14</span>
<span class="cp">#define PMA_PMD_EXT_ROBUST_WIDTH 1</span>
<span class="cp">#define PMA_PMD_EXT_SSR_LBN	15</span>
<span class="cp">#define PMA_PMD_EXT_SSR_WIDTH	1</span>

<span class="cm">/* extended status register */</span>
<span class="cp">#define PMA_PMD_XSTATUS_REG	49153</span>
<span class="cp">#define PMA_PMD_XSTAT_MDIX_LBN	14</span>
<span class="cp">#define PMA_PMD_XSTAT_FLP_LBN   (12)</span>

<span class="cm">/* LED control register */</span>
<span class="cp">#define PMA_PMD_LED_CTRL_REG	49159</span>
<span class="cp">#define PMA_PMA_LED_ACTIVITY_LBN	(3)</span>

<span class="cm">/* LED function override register */</span>
<span class="cp">#define PMA_PMD_LED_OVERR_REG	49161</span>
<span class="cm">/* Bit positions for different LEDs (there are more but not wired on SFE4001)*/</span>
<span class="cp">#define PMA_PMD_LED_LINK_LBN	(0)</span>
<span class="cp">#define PMA_PMD_LED_SPEED_LBN	(2)</span>
<span class="cp">#define PMA_PMD_LED_TX_LBN	(4)</span>
<span class="cp">#define PMA_PMD_LED_RX_LBN	(6)</span>
<span class="cm">/* Override settings */</span>
<span class="cp">#define	PMA_PMD_LED_AUTO	(0)	</span><span class="cm">/* H/W control */</span><span class="cp"></span>
<span class="cp">#define	PMA_PMD_LED_ON		(1)</span>
<span class="cp">#define	PMA_PMD_LED_OFF		(2)</span>
<span class="cp">#define PMA_PMD_LED_FLASH	(3)</span>
<span class="cp">#define PMA_PMD_LED_MASK	3</span>
<span class="cm">/* All LEDs under hardware control */</span>
<span class="cm">/* Green and Amber under hardware control, Red off */</span>
<span class="cp">#define SFX7101_PMA_PMD_LED_DEFAULT (PMA_PMD_LED_OFF &lt;&lt; PMA_PMD_LED_RX_LBN)</span>

<span class="cp">#define PMA_PMD_SPEED_ENABLE_REG 49192</span>
<span class="cp">#define PMA_PMD_100TX_ADV_LBN    1</span>
<span class="cp">#define PMA_PMD_100TX_ADV_WIDTH  1</span>
<span class="cp">#define PMA_PMD_1000T_ADV_LBN    2</span>
<span class="cp">#define PMA_PMD_1000T_ADV_WIDTH  1</span>
<span class="cp">#define PMA_PMD_10000T_ADV_LBN   3</span>
<span class="cp">#define PMA_PMD_10000T_ADV_WIDTH 1</span>
<span class="cp">#define PMA_PMD_SPEED_LBN        4</span>
<span class="cp">#define PMA_PMD_SPEED_WIDTH      4</span>

<span class="cm">/* Misc register defines */</span>
<span class="cp">#define PCS_CLOCK_CTRL_REG	55297</span>
<span class="cp">#define PLL312_RST_N_LBN 2</span>

<span class="cp">#define PCS_SOFT_RST2_REG	55302</span>
<span class="cp">#define SERDES_RST_N_LBN 13</span>
<span class="cp">#define XGXS_RST_N_LBN 12</span>

<span class="cp">#define	PCS_TEST_SELECT_REG	55303	</span><span class="cm">/* PRM 10.5.8 */</span><span class="cp"></span>
<span class="cp">#define	CLK312_EN_LBN 3</span>

<span class="cm">/* PHYXS registers */</span>
<span class="cp">#define PHYXS_XCONTROL_REG	49152</span>
<span class="cp">#define PHYXS_RESET_LBN		15</span>
<span class="cp">#define PHYXS_RESET_WIDTH	1</span>

<span class="cp">#define PHYXS_TEST1         (49162)</span>
<span class="cp">#define LOOPBACK_NEAR_LBN   (8)</span>
<span class="cp">#define LOOPBACK_NEAR_WIDTH (1)</span>

<span class="cm">/* Boot status register */</span>
<span class="cp">#define PCS_BOOT_STATUS_REG		53248</span>
<span class="cp">#define PCS_BOOT_FATAL_ERROR_LBN	0</span>
<span class="cp">#define PCS_BOOT_PROGRESS_LBN		1</span>
<span class="cp">#define PCS_BOOT_PROGRESS_WIDTH		2</span>
<span class="cp">#define PCS_BOOT_PROGRESS_INIT		0</span>
<span class="cp">#define PCS_BOOT_PROGRESS_WAIT_MDIO	1</span>
<span class="cp">#define PCS_BOOT_PROGRESS_CHECKSUM	2</span>
<span class="cp">#define PCS_BOOT_PROGRESS_JUMP		3</span>
<span class="cp">#define PCS_BOOT_DOWNLOAD_WAIT_LBN	3</span>
<span class="cp">#define PCS_BOOT_CODE_STARTED_LBN	4</span>

<span class="cm">/* 100M/1G PHY registers */</span>
<span class="cp">#define GPHY_XCONTROL_REG	49152</span>
<span class="cp">#define GPHY_ISOLATE_LBN	10</span>
<span class="cp">#define GPHY_ISOLATE_WIDTH	1</span>
<span class="cp">#define GPHY_DUPLEX_LBN		8</span>
<span class="cp">#define GPHY_DUPLEX_WIDTH	1</span>
<span class="cp">#define GPHY_LOOPBACK_NEAR_LBN	14</span>
<span class="cp">#define GPHY_LOOPBACK_NEAR_WIDTH 1</span>

<span class="cp">#define C22EXT_STATUS_REG       49153</span>
<span class="cp">#define C22EXT_STATUS_LINK_LBN  2</span>
<span class="cp">#define C22EXT_STATUS_LINK_WIDTH 1</span>

<span class="cp">#define C22EXT_MSTSLV_CTRL			49161</span>
<span class="cp">#define C22EXT_MSTSLV_CTRL_ADV_1000_HD_LBN	8</span>
<span class="cp">#define C22EXT_MSTSLV_CTRL_ADV_1000_FD_LBN	9</span>

<span class="cp">#define C22EXT_MSTSLV_STATUS			49162</span>
<span class="cp">#define C22EXT_MSTSLV_STATUS_LP_1000_HD_LBN	10</span>
<span class="cp">#define C22EXT_MSTSLV_STATUS_LP_1000_FD_LBN	11</span>

<span class="cm">/* Time to wait between powering down the LNPGA and turning off the power</span>
<span class="cm"> * rails */</span>
<span class="cp">#define LNPGA_PDOWN_WAIT	(HZ / 5)</span>

<span class="k">struct</span> <span class="n">tenxpress_phy_data</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">efx_loopback_mode</span> <span class="n">loopback_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">efx_phy_mode</span> <span class="n">phy_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_lp_tries</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tenxpress_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable 312.5 MHz clock */</span>
	<span class="n">efx_mdio_write</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PCS</span><span class="p">,</span> <span class="n">PCS_TEST_SELECT_REG</span><span class="p">,</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLK312_EN_LBN</span><span class="p">);</span>

	<span class="cm">/* Set the LEDs up as: Green = Link, Amber = Link/Act, Red = Off */</span>
	<span class="n">efx_mdio_set_flag</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">PMA_PMD_LED_CTRL_REG</span><span class="p">,</span>
			  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMA_LED_ACTIVITY_LBN</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">efx_mdio_write</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">PMA_PMD_LED_OVERR_REG</span><span class="p">,</span>
		       <span class="n">SFX7101_PMA_PMD_LED_DEFAULT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tenxpress_phy_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tenxpress_phy_data</span> <span class="o">*</span><span class="n">phy_data</span><span class="p">;</span>

	<span class="cm">/* Allocate phy private storage */</span>
	<span class="n">phy_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">phy_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_data</span> <span class="o">=</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">;</span>

	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">mmds</span> <span class="o">=</span> <span class="n">TENXPRESS_REQUIRED_DEVS</span><span class="p">;</span>
	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">mode_support</span> <span class="o">=</span> <span class="n">MDIO_SUPPORTS_C45</span><span class="p">;</span>

	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">loopback_modes</span> <span class="o">=</span> <span class="n">SFX7101_LOOPBACKS</span> <span class="o">|</span> <span class="n">FALCON_XMAC_LOOPBACKS</span><span class="p">;</span>

	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_TP</span> <span class="o">|</span> <span class="n">ADVERTISED_Autoneg</span> <span class="o">|</span>
				 <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tenxpress_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">init_phy</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">efx_mdio_wait_reset_mmds</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">TENXPRESS_REQUIRED_DEVS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">efx_mdio_check_mmds</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">TENXPRESS_REQUIRED_DEVS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tenxpress_init</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Reinitialise flow control settings */</span>
	<span class="n">efx_link_set_wanted_fc</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">wanted_fc</span><span class="p">);</span>
	<span class="n">efx_mdio_an_reconfigure</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* 200ms */</span>

	<span class="cm">/* Let XGXS and SerDes out of reset */</span>
	<span class="n">falcon_reset_xaui</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform a &quot;special software reset&quot; on the PHY. The caller is</span>
<span class="cm"> * responsible for saving and restoring the PHY hardware registers</span>
<span class="cm"> * properly, and masking/unmasking LASI */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tenxpress_special_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* The XGMAC clock is driven from the SFX7101 312MHz clock, so</span>
<span class="cm">	 * a special software reset can glitch the XGMAC sufficiently for stats</span>
<span class="cm">	 * requests to fail. */</span>
	<span class="n">falcon_stop_nic_stats</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="cm">/* Initiate reset */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">efx_mdio_read</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">PMA_PMD_XCONTROL_REG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_EXT_SSR_LBN</span><span class="p">);</span>
	<span class="n">efx_mdio_write</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">PMA_PMD_XCONTROL_REG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* Wait for the blocks to come out of reset */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">efx_mdio_wait_reset_mmds</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">TENXPRESS_REQUIRED_DEVS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Try and reconfigure the device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tenxpress_init</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Wait for the XGXS state machine to churn */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">falcon_start_nic_stats</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfx7101_check_bad_lp</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">link_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tenxpress_phy_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bad_lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bad_lp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Check that AN has started but not completed. */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">efx_mdio_read</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_AN</span><span class="p">,</span> <span class="n">MDIO_STAT1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MDIO_AN_STAT1_LPABLE</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* LP status is unknown */</span>
		<span class="n">bad_lp</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MDIO_AN_STAT1_COMPLETE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bad_lp</span><span class="p">)</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">bad_lp_tries</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Nothing to do if all is well and was previously so. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bad_lp_tries</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Use the RX (red) LED as an error indicator once we&#39;ve seen AN</span>
<span class="cm">	 * failure several times in a row, and also log a message. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bad_lp</span> <span class="o">||</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bad_lp_tries</span> <span class="o">==</span> <span class="n">MAX_BAD_LP_TRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">efx_mdio_read</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				    <span class="n">PMA_PMD_LED_OVERR_REG</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PMA_PMD_LED_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_RX_LBN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bad_lp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PMA_PMD_LED_OFF</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_RX_LBN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PMA_PMD_LED_FLASH</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_RX_LBN</span><span class="p">;</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
				  <span class="s">&quot;appears to be plugged into a port&quot;</span>
				  <span class="s">&quot; that is not 10GBASE-T capable. The PHY&quot;</span>
				  <span class="s">&quot; supports 10GBASE-T ONLY, so no link can&quot;</span>
				  <span class="s">&quot; be established</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">efx_mdio_write</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
			       <span class="n">PMA_PMD_LED_OVERR_REG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">bad_lp_tries</span> <span class="o">=</span> <span class="n">bad_lp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">sfx7101_link_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">efx_mdio_links_ok</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span>
				 <span class="n">MDIO_DEVS_PMAPMD</span> <span class="o">|</span>
				 <span class="n">MDIO_DEVS_PCS</span> <span class="o">|</span>
				 <span class="n">MDIO_DEVS_PHYXS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tenxpress_ext_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">efx_mdio_set_flag</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PHYXS</span><span class="p">,</span> <span class="n">PHYXS_TEST1</span><span class="p">,</span>
			  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOOPBACK_NEAR_LBN</span><span class="p">,</span>
			  <span class="n">efx</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_PHYXS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tenxpress_low_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">efx_mdio_set_mmds_lpower</span><span class="p">(</span>
		<span class="n">efx</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_LOW_POWER</span><span class="p">),</span>
		<span class="n">TENXPRESS_REQUIRED_DEVS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tenxpress_phy_reconfigure</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tenxpress_phy_data</span> <span class="o">*</span><span class="n">phy_data</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">phy_mode_change</span><span class="p">,</span> <span class="n">loop_reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PHY_MODE_OFF</span> <span class="o">|</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phy_mode_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_NORMAL</span> <span class="o">&amp;&amp;</span>
			   <span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">!=</span> <span class="n">PHY_MODE_NORMAL</span><span class="p">);</span>
	<span class="n">loop_reset</span> <span class="o">=</span> <span class="p">(</span><span class="n">LOOPBACK_OUT_OF</span><span class="p">(</span><span class="n">phy_data</span><span class="p">,</span> <span class="n">efx</span><span class="p">,</span> <span class="n">LOOPBACKS_EXTERNAL</span><span class="p">(</span><span class="n">efx</span><span class="p">))</span> <span class="o">||</span>
		      <span class="n">LOOPBACK_CHANGED</span><span class="p">(</span><span class="n">phy_data</span><span class="p">,</span> <span class="n">efx</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOOPBACK_GPHY</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop_reset</span> <span class="o">||</span> <span class="n">phy_mode_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tenxpress_special_reset</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
		<span class="n">falcon_reset_xaui</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tenxpress_low_power</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">efx_mdio_transmit_disable</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">efx_mdio_phy_reconfigure</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">tenxpress_ext_loopback</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">efx_mdio_an_reconfigure</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">loopback_mode</span><span class="p">;</span>
	<span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">tenxpress_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">);</span>

<span class="cm">/* Poll for link state changes */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tenxpress_phy_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">efx_link_state</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">;</span>

	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">sfx7101_link_ok</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">efx_mdio_get_pause</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="n">sfx7101_check_bad_lp</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">up</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">efx_link_state_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfx7101_phy_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Power down the LNPGA */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LNPGA_POWERDOWN_LBN</span><span class="p">);</span>
	<span class="n">efx_mdio_write</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">PMA_PMD_XCONTROL_REG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Waiting here ensures that the board fini, which can turn</span>
<span class="cm">	 * off the power to the PHY, won&#39;t get run until the LNPGA</span>
<span class="cm">	 * powerdown has been given long enough to complete. */</span>
	<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">LNPGA_PDOWN_WAIT</span><span class="p">);</span> <span class="cm">/* 200 ms */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tenxpress_phy_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Override the RX, TX and link LEDs */</span>
<span class="kt">void</span> <span class="nf">tenxpress_set_id_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">enum</span> <span class="n">efx_led_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EFX_LED_OFF</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PMA_PMD_LED_OFF</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_TX_LBN</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">PMA_PMD_LED_OFF</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_RX_LBN</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">PMA_PMD_LED_OFF</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_LINK_LBN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EFX_LED_ON</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">PMA_PMD_LED_ON</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_TX_LBN</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">PMA_PMD_LED_ON</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_RX_LBN</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">PMA_PMD_LED_ON</span> <span class="o">&lt;&lt;</span> <span class="n">PMA_PMD_LED_LINK_LBN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SFX7101_PMA_PMD_LED_DEFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">efx_mdio_write</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">PMA_PMD_LED_OVERR_REG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">sfx7101_test_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;bist&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sfx7101_test_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sfx7101_test_names</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sfx7101_test_names</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sfx7101_run_tests</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">results</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* BIST is automatically run after a special software reset */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tenxpress_special_reset</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">efx_mdio_an_reconfigure</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tenxpress_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">efx_mdio_read</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_AN</span><span class="p">,</span> <span class="n">MDIO_AN_10GBT_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MDIO_AN_10GBT_CTRL_ADV10G</span><span class="p">)</span>
		<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">efx_mdio_read</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_AN</span><span class="p">,</span> <span class="n">MDIO_AN_10GBT_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MDIO_AN_10GBT_STAT_LP10G</span><span class="p">)</span>
		<span class="n">lpa</span> <span class="o">|=</span> <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">;</span>

	<span class="n">mdio45_ethtool_gset_npage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">lpa</span><span class="p">);</span>

	<span class="cm">/* In loopback, the PHY automatically brings up the correct interface,</span>
<span class="cm">	 * but doesn&#39;t advertise the correct speed. So override it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LOOPBACK_EXTERNAL</span><span class="p">(</span><span class="n">efx</span><span class="p">))</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">SPEED_10000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tenxpress_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">efx_mdio_set_settings</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfx7101_set_npage_adv</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">advertising</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">efx_mdio_set_flag</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">MDIO_MMD_AN</span><span class="p">,</span> <span class="n">MDIO_AN_10GBT_CTRL</span><span class="p">,</span>
			  <span class="n">MDIO_AN_10GBT_CTRL_ADV10G</span><span class="p">,</span>
			  <span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">efx_phy_operations</span> <span class="n">falcon_sfx7101_phy_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		  <span class="o">=</span> <span class="n">tenxpress_phy_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>             <span class="o">=</span> <span class="n">tenxpress_phy_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reconfigure</span>      <span class="o">=</span> <span class="n">tenxpress_phy_reconfigure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>             <span class="o">=</span> <span class="n">tenxpress_phy_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fini</span>             <span class="o">=</span> <span class="n">sfx7101_phy_fini</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		  <span class="o">=</span> <span class="n">tenxpress_phy_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>	  <span class="o">=</span> <span class="n">tenxpress_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	  <span class="o">=</span> <span class="n">tenxpress_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_npage_adv</span>    <span class="o">=</span> <span class="n">sfx7101_set_npage_adv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">test_alive</span>	  <span class="o">=</span> <span class="n">efx_mdio_test_alive</span><span class="p">,</span>
	<span class="p">.</span><span class="n">test_name</span>	  <span class="o">=</span> <span class="n">sfx7101_test_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">run_tests</span>	  <span class="o">=</span> <span class="n">sfx7101_run_tests</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
