<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › sfc › falcon_boards.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>falcon_boards.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/****************************************************************************</span>
<span class="cm"> * Driver for Solarflare Solarstorm network controllers and boards</span>
<span class="cm"> * Copyright 2007-2010 Solarflare Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> * by the Free Software Foundation, incorporated herein by reference.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>

<span class="cp">#include &quot;net_driver.h&quot;</span>
<span class="cp">#include &quot;phy.h&quot;</span>
<span class="cp">#include &quot;efx.h&quot;</span>
<span class="cp">#include &quot;nic.h&quot;</span>
<span class="cp">#include &quot;workarounds.h&quot;</span>

<span class="cm">/* Macros for unpacking the board revision */</span>
<span class="cm">/* The revision info is in host byte order. */</span>
<span class="cp">#define FALCON_BOARD_TYPE(_rev) (_rev &gt;&gt; 8)</span>
<span class="cp">#define FALCON_BOARD_MAJOR(_rev) ((_rev &gt;&gt; 4) &amp; 0xf)</span>
<span class="cp">#define FALCON_BOARD_MINOR(_rev) (_rev &amp; 0xf)</span>

<span class="cm">/* Board types */</span>
<span class="cp">#define FALCON_BOARD_SFE4001 0x01</span>
<span class="cp">#define FALCON_BOARD_SFE4002 0x02</span>
<span class="cp">#define FALCON_BOARD_SFE4003 0x03</span>
<span class="cp">#define FALCON_BOARD_SFN4112F 0x52</span>

<span class="cm">/* Board temperature is about 15°C above ambient when air flow is</span>
<span class="cm"> * limited.  The maximum acceptable ambient temperature varies</span>
<span class="cm"> * depending on the PHY specifications but the critical temperature</span>
<span class="cm"> * above which we should shut down to avoid damage is 80°C. */</span>
<span class="cp">#define FALCON_BOARD_TEMP_BIAS	15</span>
<span class="cp">#define FALCON_BOARD_TEMP_CRIT	(80 + FALCON_BOARD_TEMP_BIAS)</span>

<span class="cm">/* SFC4000 datasheet says: &#39;The maximum permitted junction temperature</span>
<span class="cm"> * is 125°C; the thermal design of the environment for the SFC4000</span>
<span class="cm"> * should aim to keep this well below 100°C.&#39; */</span>
<span class="cp">#define FALCON_JUNC_TEMP_MIN	0</span>
<span class="cp">#define FALCON_JUNC_TEMP_MAX	90</span>
<span class="cp">#define FALCON_JUNC_TEMP_CRIT	125</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Support for LM87 sensor chip used on several boards</span>
<span class="cm"> */</span>
<span class="cp">#define LM87_REG_TEMP_HW_INT_LOCK	0x13</span>
<span class="cp">#define LM87_REG_TEMP_HW_EXT_LOCK	0x14</span>
<span class="cp">#define LM87_REG_TEMP_HW_INT		0x17</span>
<span class="cp">#define LM87_REG_TEMP_HW_EXT		0x18</span>
<span class="cp">#define LM87_REG_TEMP_EXT1		0x26</span>
<span class="cp">#define LM87_REG_TEMP_INT		0x27</span>
<span class="cp">#define LM87_REG_ALARMS1		0x41</span>
<span class="cp">#define LM87_REG_ALARMS2		0x42</span>
<span class="cp">#define LM87_IN_LIMITS(nr, _min, _max)			\</span>
<span class="cp">	0x2B + (nr) * 2, _max, 0x2C + (nr) * 2, _min</span>
<span class="cp">#define LM87_AIN_LIMITS(nr, _min, _max)			\</span>
<span class="cp">	0x3B + (nr), _max, 0x1A + (nr), _min</span>
<span class="cp">#define LM87_TEMP_INT_LIMITS(_min, _max)		\</span>
<span class="cp">	0x39, _max, 0x3A, _min</span>
<span class="cp">#define LM87_TEMP_EXT1_LIMITS(_min, _max)		\</span>
<span class="cp">	0x37, _max, 0x38, _min</span>

<span class="cp">#define LM87_ALARM_TEMP_INT		0x10</span>
<span class="cp">#define LM87_ALARM_TEMP_EXT1		0x20</span>

<span class="cp">#if defined(CONFIG_SENSORS_LM87) || defined(CONFIG_SENSORS_LM87_MODULE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">efx_poke_lm87</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">reg_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">reg_values</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="o">*</span><span class="n">reg_values</span><span class="o">++</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">reg_values</span><span class="o">++</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">falcon_lm87_common_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">LM87_REG_TEMP_HW_INT_LOCK</span><span class="p">,</span> <span class="n">FALCON_BOARD_TEMP_CRIT</span><span class="p">,</span>
	<span class="n">LM87_REG_TEMP_HW_INT</span><span class="p">,</span> <span class="n">FALCON_BOARD_TEMP_CRIT</span><span class="p">,</span>
	<span class="n">LM87_TEMP_EXT1_LIMITS</span><span class="p">(</span><span class="n">FALCON_JUNC_TEMP_MIN</span><span class="p">,</span> <span class="n">FALCON_JUNC_TEMP_MAX</span><span class="p">),</span>
	<span class="n">LM87_REG_TEMP_HW_EXT_LOCK</span><span class="p">,</span> <span class="n">FALCON_JUNC_TEMP_CRIT</span><span class="p">,</span>
	<span class="n">LM87_REG_TEMP_HW_EXT</span><span class="p">,</span> <span class="n">FALCON_JUNC_TEMP_CRIT</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">efx_init_lm87</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">reg_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Read-to-clear alarm/interrupt status */</span>
	<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM87_REG_ALARMS1</span><span class="p">);</span>
	<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM87_REG_ALARMS2</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">efx_poke_lm87</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg_values</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">efx_poke_lm87</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">falcon_lm87_common_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">hwmon_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">efx_fini_lm87</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">efx_check_lm87</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">temp_crit</span><span class="p">,</span> <span class="n">elec_fault</span><span class="p">,</span> <span class="n">is_failure</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">alarms</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* If link is up then do not monitor temperature */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EFX_WORKAROUND_7884</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM87_REG_ALARMS1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">alarms</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM87_REG_ALARMS2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">alarms</span> <span class="o">|=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">alarms</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">temp_crit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="n">LM87_ALARM_TEMP_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM87_REG_TEMP_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="n">FALCON_BOARD_TEMP_CRIT</span><span class="p">)</span>
			<span class="n">temp_crit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="n">LM87_ALARM_TEMP_EXT1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM87_REG_TEMP_EXT1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="n">FALCON_JUNC_TEMP_CRIT</span><span class="p">)</span>
			<span class="n">temp_crit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">elec_fault</span> <span class="o">=</span> <span class="n">alarms</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LM87_ALARM_TEMP_INT</span> <span class="o">|</span> <span class="n">LM87_ALARM_TEMP_EXT1</span><span class="p">);</span>
	<span class="n">is_failure</span> <span class="o">=</span> <span class="n">temp_crit</span> <span class="o">||</span> <span class="n">elec_fault</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alarms</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			  <span class="s">&quot;LM87 detected a hardware %s (status %02x:%02x)&quot;</span>
			  <span class="s">&quot;%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">is_failure</span> <span class="o">?</span> <span class="s">&quot;failure&quot;</span> <span class="o">:</span> <span class="s">&quot;problem&quot;</span><span class="p">,</span>
			  <span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">alarms</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="n">LM87_ALARM_TEMP_INT</span><span class="p">)</span> <span class="o">?</span>
			  <span class="s">&quot;; board is overheating&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="n">LM87_ALARM_TEMP_EXT1</span><span class="p">)</span> <span class="o">?</span>
			  <span class="s">&quot;; controller is overheating&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			  <span class="n">temp_crit</span> <span class="o">?</span> <span class="s">&quot;; reached critical temperature&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			  <span class="n">elec_fault</span> <span class="o">?</span> <span class="s">&quot;; electrical fault&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">is_failure</span> <span class="o">?</span> <span class="o">-</span><span class="n">ERANGE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_SENSORS_LM87 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">efx_init_lm87</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">reg_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">efx_fini_lm87</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">efx_check_lm87</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SENSORS_LM87 */</span><span class="cp"></span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Support for the SFE4001 NIC.</span>
<span class="cm"> *</span>
<span class="cm"> * The SFE4001 does not power-up fully at reset due to its high power</span>
<span class="cm"> * consumption.  We control its power via a PCA9539 I/O expander.</span>
<span class="cm"> * It also has a MAX6647 temperature monitor which we expose to</span>
<span class="cm"> * the lm90 driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This also provides minimal support for reflashing the PHY, which is</span>
<span class="cm"> * initiated by resetting it with the FLASH_CFG_1 pin pulled down.</span>
<span class="cm"> * On SFE4001 rev A2 and later this is connected to the 3V3X output of</span>
<span class="cm"> * the IO-expander.</span>
<span class="cm"> * We represent reflash mode as PHY_MODE_SPECIAL and make it mutually</span>
<span class="cm"> * exclusive with the network device being open.</span>
<span class="cm"> */</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Support for I2C IO Expander device on SFE4001</span>
<span class="cm"> */</span>
<span class="cp">#define	PCA9539 0x74</span>

<span class="cp">#define	P0_IN 0x00</span>
<span class="cp">#define	P0_OUT 0x02</span>
<span class="cp">#define	P0_INVERT 0x04</span>
<span class="cp">#define	P0_CONFIG 0x06</span>

<span class="cp">#define	P0_EN_1V0X_LBN 0</span>
<span class="cp">#define	P0_EN_1V0X_WIDTH 1</span>
<span class="cp">#define	P0_EN_1V2_LBN 1</span>
<span class="cp">#define	P0_EN_1V2_WIDTH 1</span>
<span class="cp">#define	P0_EN_2V5_LBN 2</span>
<span class="cp">#define	P0_EN_2V5_WIDTH 1</span>
<span class="cp">#define	P0_EN_3V3X_LBN 3</span>
<span class="cp">#define	P0_EN_3V3X_WIDTH 1</span>
<span class="cp">#define	P0_EN_5V_LBN 4</span>
<span class="cp">#define	P0_EN_5V_WIDTH 1</span>
<span class="cp">#define	P0_SHORTEN_JTAG_LBN 5</span>
<span class="cp">#define	P0_SHORTEN_JTAG_WIDTH 1</span>
<span class="cp">#define	P0_X_TRST_LBN 6</span>
<span class="cp">#define	P0_X_TRST_WIDTH 1</span>
<span class="cp">#define	P0_DSP_RESET_LBN 7</span>
<span class="cp">#define	P0_DSP_RESET_WIDTH 1</span>

<span class="cp">#define	P1_IN 0x01</span>
<span class="cp">#define	P1_OUT 0x03</span>
<span class="cp">#define	P1_INVERT 0x05</span>
<span class="cp">#define	P1_CONFIG 0x07</span>

<span class="cp">#define	P1_AFE_PWD_LBN 0</span>
<span class="cp">#define	P1_AFE_PWD_WIDTH 1</span>
<span class="cp">#define	P1_DSP_PWD25_LBN 1</span>
<span class="cp">#define	P1_DSP_PWD25_WIDTH 1</span>
<span class="cp">#define	P1_RESERVED_LBN 2</span>
<span class="cp">#define	P1_RESERVED_WIDTH 2</span>
<span class="cp">#define	P1_SPARE_LBN 4</span>
<span class="cp">#define	P1_SPARE_WIDTH 4</span>

<span class="cm">/* Temperature Sensor */</span>
<span class="cp">#define MAX664X_REG_RSL		0x02</span>
<span class="cp">#define MAX664X_REG_WLHO	0x0B</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfe4001_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">ioexp_client</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioexp_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">hwmon_client</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">;</span>

	<span class="cm">/* Turn off all power rails and disable outputs */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P0_OUT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P1_CONFIG</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P0_CONFIG</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* Clear any over-temperature alert */</span>
	<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">hwmon_client</span><span class="p">,</span> <span class="n">MAX664X_REG_RSL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfe4001_poweron</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">ioexp_client</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioexp_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">hwmon_client</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Clear any previous over-temperature alert */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">hwmon_client</span><span class="p">,</span> <span class="n">MAX664X_REG_RSL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Enable port 0 and port 1 outputs on IO expander */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P0_CONFIG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P1_CONFIG</span><span class="p">,</span>
				       <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P1_SPARE_LBN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_on</span><span class="p">;</span>

	<span class="cm">/* If PHY power is on, turn it all off and wait 1 second to</span>
<span class="cm">	 * ensure a full reset.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P0_OUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_on</span><span class="p">;</span>
	<span class="n">out</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_1V2_LBN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_2V5_LBN</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_3V3X_LBN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_5V_LBN</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_1V0X_LBN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;power-cycling PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P0_OUT</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_on</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn on 1.2V, 2.5V, 3.3V and 5V power rails */</span>
		<span class="n">out</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_1V2_LBN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_2V5_LBN</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_3V3X_LBN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_5V_LBN</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P0_X_TRST_LBN</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_3V3X_LBN</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P0_OUT</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_on</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="cm">/* Turn on 1V power rail */</span>
		<span class="n">out</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P0_EN_1V0X_LBN</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P0_OUT</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_on</span><span class="p">;</span>

		<span class="n">netif_info</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			   <span class="s">&quot;waiting for DSP boot (attempt %d)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* In flash config mode, DSP does not turn on AFE, so</span>
<span class="cm">		 * just wait 1 second.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

			<span class="cm">/* Check DSP has asserted AFE power line */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P1_IN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_on</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P1_AFE_PWD_LBN</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;timed out waiting for DSP boot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="nl">fail_on:</span>
	<span class="n">sfe4001_poweroff</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_phy_flash_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_phy_flash_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">enum</span> <span class="n">efx_phy_mode</span> <span class="n">old_mode</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">old_mode</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">buf</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">old_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PHY_MODE_SPECIAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_mode</span> <span class="o">=</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">old_mode</span> <span class="o">^</span> <span class="n">new_mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_RUNNING</span> <span class="o">||</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Reset the PHY, reconfigure the MAC and enable/disable</span>
<span class="cm">		 * MAC stats accordingly. */</span>
		<span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">=</span> <span class="n">new_mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">)</span>
			<span class="n">falcon_stop_nic_stats</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sfe4001_poweron</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">efx_reconfigure_port</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">))</span>
			<span class="n">falcon_start_nic_stats</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">phy_flash_cfg</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_phy_flash_cfg</span><span class="p">,</span> <span class="n">set_phy_flash_cfg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfe4001_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_phy_flash_cfg</span><span class="p">);</span>
	<span class="n">sfe4001_poweroff</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">ioexp_client</span><span class="p">);</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfe4001_check_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_nic_data</span> <span class="o">*</span><span class="n">nic_data</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">nic_data</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* If XAUI link is up then do not monitor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EFX_WORKAROUND_7884</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nic_data</span><span class="o">-&gt;</span><span class="n">xmac_poll_required</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check the powered status of the PHY. Lack of power implies that</span>
<span class="cm">	 * the MAX6647 has shut down power to it, probably due to a temp.</span>
<span class="cm">	 * alarm. Reading the power status rather than the MAX6647 status</span>
<span class="cm">	 * directly because the later is read-to-clear and would thus</span>
<span class="cm">	 * start to power up the PHY again when polled, causing us to blip</span>
<span class="cm">	 * the power undesirably.</span>
<span class="cm">	 * We know we can read from the IO expander because we did</span>
<span class="cm">	 * it during power-on. Assume failure now is bad news. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioexp_client</span><span class="p">,</span> <span class="n">P1_IN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P1_AFE_PWD_LBN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P1_DSP_PWD25_LBN</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Use board power control, not PHY power control */</span>
	<span class="n">sfe4001_poweroff</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">=</span> <span class="n">PHY_MODE_OFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">sfe4001_hwmon_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;max6647&quot;</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* This board uses an I2C expander to provider power to the PHY, which needs to</span>
<span class="cm"> * be turned on before the PHY can be used.</span>
<span class="cm"> * Context: Process context, rtnl lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfe4001_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SENSORS_LM90) || defined(CONFIG_SENSORS_LM90_MODULE)</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">hwmon_client</span> <span class="o">=</span>
		<span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfe4001_hwmon_info</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">hwmon_client</span> <span class="o">=</span>
		<span class="n">i2c_new_dummy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">sfe4001_hwmon_info</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Raise board/PHY high limit from 85 to 90 degrees Celsius */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">,</span>
				       <span class="n">MAX664X_REG_WLHO</span><span class="p">,</span> <span class="mi">90</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_hwmon</span><span class="p">;</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">ioexp_client</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">PCA9539</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">ioexp_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_hwmon</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&amp;</span> <span class="n">PHY_MODE_SPECIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PHY won&#39;t generate a 156.25 MHz clock and MAC stats fetch</span>
<span class="cm">		 * will fail. */</span>
		<span class="n">falcon_stop_nic_stats</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sfe4001_poweron</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_ioexp</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_phy_flash_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_on</span><span class="p">;</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;PHY is powered on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_on:</span>
	<span class="n">sfe4001_poweroff</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
<span class="nl">fail_ioexp:</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">ioexp_client</span><span class="p">);</span>
<span class="nl">fail_hwmon:</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">hwmon_client</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Support for the SFE4002</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">sfe4002_lm87_channel</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* use AIN not FAN inputs */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">sfe4002_lm87_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">),</span>		<span class="cm">/* 2.5V:  1.8V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">),</span>		<span class="cm">/* Vccp1: 1.2V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">),</span>		<span class="cm">/* 3.3V:  3.3V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">),</span>		<span class="cm">/* 5V:    5.0V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">),</span>		<span class="cm">/* 12V:   10.8-14V */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">),</span>		<span class="cm">/* Vccp2: 1.0V +/- 10% */</span>
	<span class="n">LM87_AIN_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">),</span>		<span class="cm">/* AIN1:  1.66V +/- 10% */</span>
	<span class="n">LM87_AIN_LIMITS</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">),</span>		<span class="cm">/* AIN2:  1.5V +/- 10% */</span>
	<span class="n">LM87_TEMP_INT_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">FALCON_BOARD_TEMP_BIAS</span><span class="p">),</span>
	<span class="n">LM87_TEMP_EXT1_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FALCON_JUNC_TEMP_MAX</span><span class="p">),</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">sfe4002_hwmon_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;lm87&quot;</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">),</span>
	<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sfe4002_lm87_channel</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* LED allocations. Note that on rev A0 boards the schematic and the reality</span>
<span class="cm"> * differ: red and green are swapped. Below is the fixed (A1) layout (there</span>
<span class="cm"> * are only 3 A0 boards in existence, so no real reason to make this</span>
<span class="cm"> * conditional).</span>
<span class="cm"> */</span>
<span class="cp">#define SFE4002_FAULT_LED (2)	</span><span class="cm">/* Red */</span><span class="cp"></span>
<span class="cp">#define SFE4002_RX_LED    (0)	</span><span class="cm">/* Green */</span><span class="cp"></span>
<span class="cp">#define SFE4002_TX_LED    (1)	</span><span class="cm">/* Amber */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfe4002_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set the TX and RX LEDs to reflect status and activity, and the</span>
<span class="cm">	 * fault LED off */</span>
	<span class="n">falcon_qt202x_set_led</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFE4002_TX_LED</span><span class="p">,</span>
			      <span class="n">QUAKE_LED_TXLINK</span> <span class="o">|</span> <span class="n">QUAKE_LED_LINK_ACTSTAT</span><span class="p">);</span>
	<span class="n">falcon_qt202x_set_led</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFE4002_RX_LED</span><span class="p">,</span>
			      <span class="n">QUAKE_LED_RXLINK</span> <span class="o">|</span> <span class="n">QUAKE_LED_LINK_ACTSTAT</span><span class="p">);</span>
	<span class="n">falcon_qt202x_set_led</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFE4002_FAULT_LED</span><span class="p">,</span> <span class="n">QUAKE_LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfe4002_set_id_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">enum</span> <span class="n">efx_led_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">falcon_qt202x_set_led</span><span class="p">(</span>
		<span class="n">efx</span><span class="p">,</span> <span class="n">SFE4002_FAULT_LED</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EFX_LED_ON</span><span class="p">)</span> <span class="o">?</span> <span class="n">QUAKE_LED_ON</span> <span class="o">:</span> <span class="n">QUAKE_LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfe4002_check_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="cm">/* A0 board rev. 4002s report a temperature fault the whole time</span>
<span class="cm">	 * (bad sensor) so we mask it out. */</span>
	<span class="kt">unsigned</span> <span class="n">alarm_mask</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">~</span><span class="n">LM87_ALARM_TEMP_EXT1</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">efx_check_lm87</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">alarm_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfe4002_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">efx_init_lm87</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfe4002_hwmon_info</span><span class="p">,</span> <span class="n">sfe4002_lm87_regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Support for the SFN4112F</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">sfn4112f_lm87_channel</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* use AIN not FAN inputs */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">sfn4112f_lm87_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">),</span>		<span class="cm">/* 2.5V:  1.8V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">),</span>		<span class="cm">/* Vccp1: 1.2V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">),</span>		<span class="cm">/* 3.3V:  3.3V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">),</span>		<span class="cm">/* 12V:   10.8-14V */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">),</span>		<span class="cm">/* Vccp2: 1.0V +/- 10% */</span>
	<span class="n">LM87_AIN_LIMITS</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">),</span>		<span class="cm">/* AIN2:  1.5V +/- 10% */</span>
	<span class="n">LM87_TEMP_INT_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">FALCON_BOARD_TEMP_BIAS</span><span class="p">),</span>
	<span class="n">LM87_TEMP_EXT1_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FALCON_JUNC_TEMP_MAX</span><span class="p">),</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">sfn4112f_hwmon_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;lm87&quot;</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">),</span>
	<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sfn4112f_lm87_channel</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define SFN4112F_ACT_LED	0</span>
<span class="cp">#define SFN4112F_LINK_LED	1</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfn4112f_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">falcon_qt202x_set_led</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFN4112F_ACT_LED</span><span class="p">,</span>
			      <span class="n">QUAKE_LED_RXLINK</span> <span class="o">|</span> <span class="n">QUAKE_LED_LINK_ACT</span><span class="p">);</span>
	<span class="n">falcon_qt202x_set_led</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFN4112F_LINK_LED</span><span class="p">,</span>
			      <span class="n">QUAKE_LED_RXLINK</span> <span class="o">|</span> <span class="n">QUAKE_LED_LINK_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfn4112f_set_id_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">enum</span> <span class="n">efx_led_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EFX_LED_OFF</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">QUAKE_LED_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EFX_LED_ON</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">QUAKE_LED_ON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">QUAKE_LED_RXLINK</span> <span class="o">|</span> <span class="n">QUAKE_LED_LINK_STAT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">falcon_qt202x_set_led</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFN4112F_LINK_LED</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfn4112f_check_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Mask out unused sensors */</span>
	<span class="k">return</span> <span class="n">efx_check_lm87</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x48</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfn4112f_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">efx_init_lm87</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfn4112f_hwmon_info</span><span class="p">,</span> <span class="n">sfn4112f_lm87_regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Support for the SFE4003</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">sfe4003_lm87_channel</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* use AIN not FAN inputs */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">sfe4003_lm87_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">),</span>		<span class="cm">/* 2.5V:  1.5V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">),</span>		<span class="cm">/* Vccp1: 1.2V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">),</span>		<span class="cm">/* 3.3V:  3.3V +/- 10% */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">),</span>		<span class="cm">/* 12V:   10.8-14V */</span>
	<span class="n">LM87_IN_LIMITS</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">),</span>		<span class="cm">/* Vccp2: 1.0V +/- 10% */</span>
	<span class="n">LM87_TEMP_INT_LIMITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span> <span class="o">+</span> <span class="n">FALCON_BOARD_TEMP_BIAS</span><span class="p">),</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">sfe4003_hwmon_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;lm87&quot;</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">),</span>
	<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sfe4003_lm87_channel</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Board-specific LED info. */</span>
<span class="cp">#define SFE4003_RED_LED_GPIO	11</span>
<span class="cp">#define SFE4003_LED_ON		1</span>
<span class="cp">#define SFE4003_LED_OFF		0</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfe4003_set_id_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="k">enum</span> <span class="n">efx_led_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="cm">/* The LEDs were not wired to GPIOs before A3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">falcon_txc_set_gpio_val</span><span class="p">(</span>
		<span class="n">efx</span><span class="p">,</span> <span class="n">SFE4003_RED_LED_GPIO</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EFX_LED_ON</span><span class="p">)</span> <span class="o">?</span> <span class="n">SFE4003_LED_ON</span> <span class="o">:</span> <span class="n">SFE4003_LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sfe4003_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="cm">/* The LEDs were not wired to GPIOs before A3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">falcon_txc_set_gpio_dir</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFE4003_RED_LED_GPIO</span><span class="p">,</span> <span class="n">TXC_GPIO_DIR_OUTPUT</span><span class="p">);</span>
	<span class="n">falcon_txc_set_gpio_val</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">SFE4003_RED_LED_GPIO</span><span class="p">,</span> <span class="n">SFE4003_LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfe4003_check_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="cm">/* A0/A1/A2 board rev. 4003s  report a temperature fault the whole time</span>
<span class="cm">	 * (bad sensor) so we mask it out. */</span>
	<span class="kt">unsigned</span> <span class="n">alarm_mask</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">~</span><span class="n">LM87_ALARM_TEMP_EXT1</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">efx_check_lm87</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">alarm_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sfe4003_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">efx_init_lm87</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfe4003_hwmon_info</span><span class="p">,</span> <span class="n">sfe4003_lm87_regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">falcon_board_type</span> <span class="n">board_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">FALCON_BOARD_SFE4001</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">sfe4001_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_phy</span>	<span class="o">=</span> <span class="n">efx_port_dummy_op_void</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fini</span>		<span class="o">=</span> <span class="n">sfe4001_fini</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_id_led</span>	<span class="o">=</span> <span class="n">tenxpress_set_id_led</span><span class="p">,</span>
		<span class="p">.</span><span class="n">monitor</span>	<span class="o">=</span> <span class="n">sfe4001_check_hw</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">FALCON_BOARD_SFE4002</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">sfe4002_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_phy</span>	<span class="o">=</span> <span class="n">sfe4002_init_phy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fini</span>		<span class="o">=</span> <span class="n">efx_fini_lm87</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_id_led</span>	<span class="o">=</span> <span class="n">sfe4002_set_id_led</span><span class="p">,</span>
		<span class="p">.</span><span class="n">monitor</span>	<span class="o">=</span> <span class="n">sfe4002_check_hw</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">FALCON_BOARD_SFE4003</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">sfe4003_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_phy</span>	<span class="o">=</span> <span class="n">sfe4003_init_phy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fini</span>		<span class="o">=</span> <span class="n">efx_fini_lm87</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_id_led</span>	<span class="o">=</span> <span class="n">sfe4003_set_id_led</span><span class="p">,</span>
		<span class="p">.</span><span class="n">monitor</span>	<span class="o">=</span> <span class="n">sfe4003_check_hw</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">FALCON_BOARD_SFN4112F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">sfn4112f_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_phy</span>	<span class="o">=</span> <span class="n">sfn4112f_init_phy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fini</span>		<span class="o">=</span> <span class="n">efx_fini_lm87</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_id_led</span>	<span class="o">=</span> <span class="n">sfn4112f_set_id_led</span><span class="p">,</span>
		<span class="p">.</span><span class="n">monitor</span>	<span class="o">=</span> <span class="n">sfn4112f_check_hw</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">falcon_probe_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">revision_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">falcon_board</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">FALCON_BOARD_TYPE</span><span class="p">(</span><span class="n">revision_info</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">FALCON_BOARD_MAJOR</span><span class="p">(</span><span class="n">revision_info</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">FALCON_BOARD_MINOR</span><span class="p">(</span><span class="n">revision_info</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">board_types</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board_types</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">type_id</span><span class="p">)</span>
			<span class="n">board</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">board_types</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;unknown board type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">type_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
