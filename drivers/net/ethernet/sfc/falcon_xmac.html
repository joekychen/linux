<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › sfc › falcon_xmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>falcon_xmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/****************************************************************************</span>
<span class="cm"> * Driver for Solarflare Solarstorm network controllers and boards</span>
<span class="cm"> * Copyright 2005-2006 Fen Systems Ltd.</span>
<span class="cm"> * Copyright 2006-2010 Solarflare Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> * by the Free Software Foundation, incorporated herein by reference.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;net_driver.h&quot;</span>
<span class="cp">#include &quot;efx.h&quot;</span>
<span class="cp">#include &quot;nic.h&quot;</span>
<span class="cp">#include &quot;regs.h&quot;</span>
<span class="cp">#include &quot;io.h&quot;</span>
<span class="cp">#include &quot;mdio_10g.h&quot;</span>
<span class="cp">#include &quot;workarounds.h&quot;</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * MAC operations</span>
<span class="cm"> *</span>
<span class="cm"> *************************************************************************/</span>

<span class="cm">/* Configure the XAUI driver that is an output from Falcon */</span>
<span class="kt">void</span> <span class="nf">falcon_setup_xaui</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">efx_oword_t</span> <span class="n">sdctl</span><span class="p">,</span> <span class="n">txdrv</span><span class="p">;</span>

	<span class="cm">/* Move the XAUI into low power, unless there is no PHY, in</span>
<span class="cm">	 * which case the XAUI will have to drive a cable. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FR_AB_XX_SD_CTL</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_HIDRVD</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_LODRVD</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_HIDRVC</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_LODRVC</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_HIDRVB</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_LODRVB</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_HIDRVA</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FRF_AB_XX_LODRVA</span><span class="p">,</span> <span class="n">FFE_AB_XX_SD_CTL_DRV_DEF</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdctl</span><span class="p">,</span> <span class="n">FR_AB_XX_SD_CTL</span><span class="p">);</span>

	<span class="n">EFX_POPULATE_OWORD_8</span><span class="p">(</span><span class="n">txdrv</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DEQD</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DEQ_DEF</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DEQC</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DEQ_DEF</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DEQB</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DEQ_DEF</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DEQA</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DEQ_DEF</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DTXD</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DTX_DEF</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DTXC</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DTX_DEF</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DTXB</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DTX_DEF</span><span class="p">,</span>
			     <span class="n">FRF_AB_XX_DTXA</span><span class="p">,</span> <span class="n">FFE_AB_XX_TXDRV_DTX_DEF</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdrv</span><span class="p">,</span> <span class="n">FR_AB_XX_TXDRV_CTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">falcon_reset_xaui</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_nic_data</span> <span class="o">*</span><span class="n">nic_data</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">nic_data</span><span class="p">;</span>
	<span class="n">efx_oword_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t fetch MAC statistics over an XMAC reset */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">nic_data</span><span class="o">-&gt;</span><span class="n">stats_disable_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Start reset sequence */</span>
	<span class="n">EFX_POPULATE_OWORD_1</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_RST_XX_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_PWR_RST</span><span class="p">);</span>

	<span class="cm">/* Wait up to 10 ms for completion, then reinitialise */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_PWR_RST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EFX_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_RST_XX_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">EFX_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_SD_RST_ACT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">falcon_setup_xaui</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">netif_err</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
		  <span class="s">&quot;timed out waiting for XAUI/XGXS reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falcon_ack_status_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_nic_data</span> <span class="o">*</span><span class="n">nic_data</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">nic_data</span><span class="p">;</span>
	<span class="n">efx_oword_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">efx_nic_rev</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EFX_REV_FALCON_B0</span><span class="p">)</span> <span class="o">||</span> <span class="n">LOOPBACK_INTERNAL</span><span class="p">(</span><span class="n">efx</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We expect xgmii faults if the wireside link is down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EFX_WORKAROUND_5147</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We can only use this interrupt to signal the negative edge of</span>
<span class="cm">	 * xaui_align [we have to poll the positive edge]. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic_data</span><span class="o">-&gt;</span><span class="n">xmac_poll_required</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_MGT_INT_MSK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">falcon_xgxs_link_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">efx_oword_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">align_done</span><span class="p">,</span> <span class="n">link_ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sync_status</span><span class="p">;</span>

	<span class="cm">/* Read link status */</span>
	<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_CORE_STAT</span><span class="p">);</span>

	<span class="n">align_done</span> <span class="o">=</span> <span class="n">EFX_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_ALIGN_DONE</span><span class="p">);</span>
	<span class="n">sync_status</span> <span class="o">=</span> <span class="n">EFX_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_SYNC_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">align_done</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sync_status</span> <span class="o">==</span> <span class="n">FFE_AB_XX_STAT_ALL_LANES</span><span class="p">))</span>
		<span class="n">link_ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Clear link status ready for next read */</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_COMMA_DET</span><span class="p">,</span> <span class="n">FFE_AB_XX_STAT_ALL_LANES</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_CHAR_ERR</span><span class="p">,</span> <span class="n">FFE_AB_XX_STAT_ALL_LANES</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_DISPERR</span><span class="p">,</span> <span class="n">FFE_AB_XX_STAT_ALL_LANES</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_CORE_STAT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">link_ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">falcon_xmac_link_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check MAC&#39;s XGXS link status except when using XGMII loopback</span>
<span class="cm">	 * which bypasses the XGXS block.</span>
<span class="cm">	 * If possible, check PHY&#39;s XGXS link status except when using</span>
<span class="cm">	 * MAC loopback.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XGMII</span> <span class="o">||</span>
		<span class="n">falcon_xgxs_link_ok</span><span class="p">(</span><span class="n">efx</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">mmds</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_MMD_PHYXS</span><span class="p">))</span> <span class="o">||</span>
		 <span class="n">LOOPBACK_INTERNAL</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">efx_mdio_phyxgxs_lane_sync</span><span class="p">(</span><span class="n">efx</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falcon_reconfigure_xmac_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_frame_len</span><span class="p">;</span>
	<span class="n">efx_oword_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rx_fc</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">EFX_FC_RX</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">tx_fc</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">EFX_FC_TX</span><span class="p">);</span>

	<span class="cm">/* Configure MAC  - cut-thru mode is hard wired on */</span>
	<span class="n">EFX_POPULATE_OWORD_3</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_RX_JUMBO_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_TX_STAT_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_RX_STAT_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_GLB_CFG</span><span class="p">);</span>

	<span class="cm">/* Configure TX */</span>
	<span class="n">EFX_POPULATE_OWORD_6</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_TXEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_TX_PRMBL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_AUTO_PAD</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_TXCRC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_FCNTL</span><span class="p">,</span> <span class="n">tx_fc</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_IPG</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_TX_CFG</span><span class="p">);</span>

	<span class="cm">/* Configure RX */</span>
	<span class="n">EFX_POPULATE_OWORD_5</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_RXEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_AUTO_DEPAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_ACPT_ALL_MCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_ACPT_ALL_UCAST</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">promiscuous</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_PASS_CRC_ERR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_RX_CFG</span><span class="p">);</span>

	<span class="cm">/* Set frame length */</span>
	<span class="n">max_frame_len</span> <span class="o">=</span> <span class="n">EFX_MAX_FRAME_LEN</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="n">EFX_POPULATE_OWORD_1</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XM_MAX_RX_FRM_SIZE</span><span class="p">,</span> <span class="n">max_frame_len</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_RX_PARAM</span><span class="p">);</span>
	<span class="n">EFX_POPULATE_OWORD_2</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_MAX_TX_FRM_SIZE</span><span class="p">,</span> <span class="n">max_frame_len</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_TX_JUMBO_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_TX_PARAM</span><span class="p">);</span>

	<span class="n">EFX_POPULATE_OWORD_2</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span>
			     <span class="n">FRF_AB_XM_PAUSE_TIME</span><span class="p">,</span> <span class="mh">0xfffe</span><span class="p">,</span> <span class="cm">/* MAX PAUSE TIME */</span>
			     <span class="n">FRF_AB_XM_DIS_FCNTL</span><span class="p">,</span> <span class="o">!</span><span class="n">rx_fc</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_FC</span><span class="p">);</span>

	<span class="cm">/* Set MAC address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_ADR_LO</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XM_ADR_HI</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falcon_reconfigure_xgxs_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">efx_oword_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">xgxs_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XGXS</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">xaui_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XAUI</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">xgmii_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XGMII</span><span class="p">);</span>

	<span class="cm">/* XGXS block is flaky and will need to be reset if moving</span>
<span class="cm">	 * into our out of XGMII, XGXS or XAUI loopbacks. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EFX_WORKAROUND_5147</span><span class="p">(</span><span class="n">efx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">old_xgmii_loopback</span><span class="p">,</span> <span class="n">old_xgxs_loopback</span><span class="p">,</span> <span class="n">old_xaui_loopback</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">reset_xgxs</span><span class="p">;</span>

		<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_CORE_STAT</span><span class="p">);</span>
		<span class="n">old_xgxs_loopback</span> <span class="o">=</span> <span class="n">EFX_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_XGXS_LB_EN</span><span class="p">);</span>
		<span class="n">old_xgmii_loopback</span> <span class="o">=</span>
			<span class="n">EFX_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_XGMII_LB_EN</span><span class="p">);</span>

		<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_SD_CTL</span><span class="p">);</span>
		<span class="n">old_xaui_loopback</span> <span class="o">=</span> <span class="n">EFX_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_LPBKA</span><span class="p">);</span>

		<span class="cm">/* The PHY driver may have turned XAUI off */</span>
		<span class="n">reset_xgxs</span> <span class="o">=</span> <span class="p">((</span><span class="n">xgxs_loopback</span> <span class="o">!=</span> <span class="n">old_xgxs_loopback</span><span class="p">)</span> <span class="o">||</span>
			      <span class="p">(</span><span class="n">xaui_loopback</span> <span class="o">!=</span> <span class="n">old_xaui_loopback</span><span class="p">)</span> <span class="o">||</span>
			      <span class="p">(</span><span class="n">xgmii_loopback</span> <span class="o">!=</span> <span class="n">old_xgmii_loopback</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reset_xgxs</span><span class="p">)</span>
			<span class="n">falcon_reset_xaui</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_CORE_STAT</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_FORCE_SIG</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">xgxs_loopback</span> <span class="o">||</span> <span class="n">xaui_loopback</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">FFE_AB_XX_FORCE_SIG_ALL_LANES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_XGXS_LB_EN</span><span class="p">,</span> <span class="n">xgxs_loopback</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_XGMII_LB_EN</span><span class="p">,</span> <span class="n">xgmii_loopback</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_CORE_STAT</span><span class="p">);</span>

	<span class="n">efx_reado</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_SD_CTL</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_LPBKD</span><span class="p">,</span> <span class="n">xaui_loopback</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_LPBKC</span><span class="p">,</span> <span class="n">xaui_loopback</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_LPBKB</span><span class="p">,</span> <span class="n">xaui_loopback</span><span class="p">);</span>
	<span class="n">EFX_SET_OWORD_FIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRF_AB_XX_LPBKA</span><span class="p">,</span> <span class="n">xaui_loopback</span><span class="p">);</span>
	<span class="n">efx_writeo</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">FR_AB_XX_SD_CTL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Try to bring up the Falcon side of the Falcon-Phy XAUI link */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">falcon_xmac_link_ok_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">mac_up</span> <span class="o">=</span> <span class="n">falcon_xmac_link_ok</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LOOPBACK_MASK</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOOPBACKS_EXTERNAL</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOOPBACKS_WS</span> <span class="o">||</span>
	    <span class="n">efx_phy_mode_disabled</span><span class="p">(</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">))</span>
		<span class="cm">/* XAUI link is expected to be down */</span>
		<span class="k">return</span> <span class="n">mac_up</span><span class="p">;</span>

	<span class="n">falcon_stop_nic_stats</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_up</span> <span class="o">&amp;&amp;</span> <span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="s">&quot;bashing xaui</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">falcon_reset_xaui</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

		<span class="n">mac_up</span> <span class="o">=</span> <span class="n">falcon_xmac_link_ok</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
		<span class="o">--</span><span class="n">tries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">falcon_start_nic_stats</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mac_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">falcon_xmac_check_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">falcon_xmac_link_ok_retry</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">falcon_reconfigure_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_nic_data</span> <span class="o">*</span><span class="n">nic_data</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">nic_data</span><span class="p">;</span>

	<span class="n">falcon_reconfigure_xgxs_core</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
	<span class="n">falcon_reconfigure_xmac_core</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="n">falcon_reconfigure_mac_wrapper</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="n">nic_data</span><span class="o">-&gt;</span><span class="n">xmac_poll_required</span> <span class="o">=</span> <span class="o">!</span><span class="n">falcon_xmac_link_ok_retry</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">falcon_ack_status_intr</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">falcon_update_stats_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">efx_mac_stats</span> <span class="o">*</span><span class="n">mac_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">mac_stats</span><span class="p">;</span>

	<span class="cm">/* Update MAC stats from DMAed values */</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxOctets</span><span class="p">,</span> <span class="n">rx_bytes</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxOctetsOK</span><span class="p">,</span> <span class="n">rx_good_bytes</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts</span><span class="p">,</span> <span class="n">rx_packets</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPktsOK</span><span class="p">,</span> <span class="n">rx_good</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxBroadcastPkts</span><span class="p">,</span> <span class="n">rx_broadcast</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxMulticastPkts</span><span class="p">,</span> <span class="n">rx_multicast</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxUnicastPkts</span><span class="p">,</span> <span class="n">rx_unicast</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxUndersizePkts</span><span class="p">,</span> <span class="n">rx_lt64</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxOversizePkts</span><span class="p">,</span> <span class="n">rx_gtjumbo</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxJabberPkts</span><span class="p">,</span> <span class="n">rx_bad_gtjumbo</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxUndersizeFCSerrorPkts</span><span class="p">,</span> <span class="n">rx_bad_lt64</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxDropEvents</span><span class="p">,</span> <span class="n">rx_overflow</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxFCSerrorPkts</span><span class="p">,</span> <span class="n">rx_bad</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxAlignError</span><span class="p">,</span> <span class="n">rx_align_error</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxSymbolError</span><span class="p">,</span> <span class="n">rx_symbol_error</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxInternalMACError</span><span class="p">,</span> <span class="n">rx_internal_error</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxControlPkts</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPausePkts</span><span class="p">,</span> <span class="n">rx_pause</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts64Octets</span><span class="p">,</span> <span class="n">rx_64</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts65to127Octets</span><span class="p">,</span> <span class="n">rx_65_to_127</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts128to255Octets</span><span class="p">,</span> <span class="n">rx_128_to_255</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts256to511Octets</span><span class="p">,</span> <span class="n">rx_256_to_511</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts512to1023Octets</span><span class="p">,</span> <span class="n">rx_512_to_1023</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts1024to15xxOctets</span><span class="p">,</span> <span class="n">rx_1024_to_15xx</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxPkts15xxtoMaxOctets</span><span class="p">,</span> <span class="n">rx_15xx_to_jumbo</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgRxLengthError</span><span class="p">,</span> <span class="n">rx_length_error</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts</span><span class="p">,</span> <span class="n">tx_packets</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxOctets</span><span class="p">,</span> <span class="n">tx_bytes</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxMulticastPkts</span><span class="p">,</span> <span class="n">tx_multicast</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxBroadcastPkts</span><span class="p">,</span> <span class="n">tx_broadcast</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxUnicastPkts</span><span class="p">,</span> <span class="n">tx_unicast</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxControlPkts</span><span class="p">,</span> <span class="n">tx_control</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPausePkts</span><span class="p">,</span> <span class="n">tx_pause</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts64Octets</span><span class="p">,</span> <span class="n">tx_64</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts65to127Octets</span><span class="p">,</span> <span class="n">tx_65_to_127</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts128to255Octets</span><span class="p">,</span> <span class="n">tx_128_to_255</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts256to511Octets</span><span class="p">,</span> <span class="n">tx_256_to_511</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts512to1023Octets</span><span class="p">,</span> <span class="n">tx_512_to_1023</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts1024to15xxOctets</span><span class="p">,</span> <span class="n">tx_1024_to_15xx</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxPkts1519toMaxOctets</span><span class="p">,</span> <span class="n">tx_15xx_to_jumbo</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxUndersizePkts</span><span class="p">,</span> <span class="n">tx_lt64</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxOversizePkts</span><span class="p">,</span> <span class="n">tx_gtjumbo</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxNonTcpUdpPkt</span><span class="p">,</span> <span class="n">tx_non_tcpudp</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxMacSrcErrPkt</span><span class="p">,</span> <span class="n">tx_mac_src_error</span><span class="p">);</span>
	<span class="n">FALCON_STAT</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="n">XgTxIpSrcErrPkt</span><span class="p">,</span> <span class="n">tx_ip_src_error</span><span class="p">);</span>

	<span class="cm">/* Update derived statistics */</span>
	<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">tx_good_bytes</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">-</span> <span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">tx_bad_bytes</span> <span class="o">-</span>
		 <span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">*</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">rx_bad_bytes</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">-</span> <span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">rx_good_bytes</span> <span class="o">-</span>
		 <span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">rx_control</span> <span class="o">*</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">falcon_poll_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">efx_nic</span> <span class="o">*</span><span class="n">efx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_nic_data</span> <span class="o">*</span><span class="n">nic_data</span> <span class="o">=</span> <span class="n">efx</span><span class="o">-&gt;</span><span class="n">nic_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EFX_WORKAROUND_5147</span><span class="p">(</span><span class="n">efx</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">efx</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">up</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">nic_data</span><span class="o">-&gt;</span><span class="n">xmac_poll_required</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nic_data</span><span class="o">-&gt;</span><span class="n">xmac_poll_required</span> <span class="o">=</span> <span class="o">!</span><span class="n">falcon_xmac_link_ok_retry</span><span class="p">(</span><span class="n">efx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">falcon_ack_status_intr</span><span class="p">(</span><span class="n">efx</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
