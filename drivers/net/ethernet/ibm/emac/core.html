<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › ibm › emac › core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/net/ethernet/ibm/emac/core.c</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for PowerPC 4xx on-chip ethernet controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2007 Benjamin Herrenschmidt, IBM Corp.</span>
<span class="cm"> *                &lt;benh@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the arch/ppc version of the driver:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004, 2005 Zultys Technologies.</span>
<span class="cm"> * Eugene Surovegin &lt;eugene.surovegin@zultys.com&gt; or &lt;ebs@ebshome.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on original work by</span>
<span class="cm"> * 	Matt Porter &lt;mporter@kernel.crashing.org&gt;</span>
<span class="cm"> *	(c) 2003 Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;</span>
<span class="cm"> *      Armin Kuster &lt;akuster@mvista.com&gt;</span>
<span class="cm"> * 	Johnnie Peters &lt;jpeters@mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_net.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/dcr.h&gt;</span>
<span class="cp">#include &lt;asm/dcr-regs.h&gt;</span>

<span class="cp">#include &quot;core.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Lack of dma_unmap_???? calls is intentional.</span>
<span class="cm"> *</span>
<span class="cm"> * API-correct usage requires additional support state information to be</span>
<span class="cm"> * maintained for every RX and TX buffer descriptor (BD). Unfortunately, due to</span>
<span class="cm"> * EMAC design (e.g. TX buffer passed from network stack can be split into</span>
<span class="cm"> * several BDs, dma_map_single/dma_map_page can be used to map particular BD),</span>
<span class="cm"> * maintaining such information will add additional overhead.</span>
<span class="cm"> * Current DMA API implementation for 4xx processors only ensures cache coherency</span>
<span class="cm"> * and dma_unmap_???? routines are empty and are likely to stay this way.</span>
<span class="cm"> * I decided to omit dma_unmap_??? calls because I don&#39;t want to add additional</span>
<span class="cm"> * complexity just for the sake of following some abstract API, when it doesn&#39;t</span>
<span class="cm"> * add any real benefit to the driver. I understand that this decision maybe</span>
<span class="cm"> * controversial, but I really tried to make code API-correct and efficient</span>
<span class="cm"> * at the same time and didn&#39;t come up with code I liked :(.                --ebs</span>
<span class="cm"> */</span>

<span class="cp">#define DRV_NAME        &quot;emac&quot;</span>
<span class="cp">#define DRV_VERSION     &quot;3.54&quot;</span>
<span class="cp">#define DRV_DESC        &quot;PPC 4xx OCP EMAC driver&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span>
    <span class="p">(</span><span class="s">&quot;Eugene Surovegin &lt;eugene.surovegin@zultys.com&gt; or &lt;ebs@ebshome.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * PPC64 doesn&#39;t (yet) have a cacheable_memcpy</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#define cacheable_memcpy(d,s,n) memcpy((d),(s),(n))</span>
<span class="cp">#endif</span>

<span class="cm">/* minimum number of free TX descriptors required to wake up TX process */</span>
<span class="cp">#define EMAC_TX_WAKEUP_THRESH		(NUM_TX_BUFF / 4)</span>

<span class="cm">/* If packet size is less than this number, we allocate small skb and copy packet</span>
<span class="cm"> * contents into it instead of just sending original big skb up</span>
<span class="cm"> */</span>
<span class="cp">#define EMAC_RX_COPY_THRESH		CONFIG_IBM_EMAC_RX_COPY_THRESHOLD</span>

<span class="cm">/* Since multiple EMACs share MDIO lines in various ways, we need</span>
<span class="cm"> * to avoid re-using the same PHY ID in cases where the arch didn&#39;t</span>
<span class="cm"> * setup precise phy_map entries</span>
<span class="cm"> *</span>
<span class="cm"> * XXX This is something that needs to be reworked as we can have multiple</span>
<span class="cm"> * EMAC &quot;sets&quot; (multiple ASICs containing several EMACs) though we can</span>
<span class="cm"> * probably require in that case to have explicit PHY IDs in the device-tree</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">busy_phy_map</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">emac_phy_map_lock</span><span class="p">);</span>

<span class="cm">/* This is the wait queue used to wait on any event related to probe, that</span>
<span class="cm"> * is discovery of MALs, other EMACs, ZMII/RGMIIs, etc...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">emac_probe_wait</span><span class="p">);</span>

<span class="cm">/* Having stable interface names is a doomed idea. However, it would be nice</span>
<span class="cm"> * if we didn&#39;t have completely random interface names at boot too :-) It&#39;s</span>
<span class="cm"> * just a matter of making everybody&#39;s life easier. Since we are doing</span>
<span class="cm"> * threaded probing, it&#39;s a bit harder though. The base idea here is that</span>
<span class="cm"> * we make up a list of all emacs in the device-tree before we register the</span>
<span class="cm"> * driver. Every emac will then wait for the previous one in the list to</span>
<span class="cm"> * initialize before itself. We should also keep that list ordered by</span>
<span class="cm"> * cell_index.</span>
<span class="cm"> * That list is only 4 entries long, meaning that additional EMACs don&#39;t</span>
<span class="cm"> * get ordering guarantees unless EMAC_BOOT_LIST_SIZE is increased.</span>
<span class="cm"> */</span>

<span class="cp">#define EMAC_BOOT_LIST_SIZE	4</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">emac_boot_list</span><span class="p">[</span><span class="n">EMAC_BOOT_LIST_SIZE</span><span class="p">];</span>

<span class="cm">/* How long should I wait for dependent devices ? */</span>
<span class="cp">#define EMAC_PROBE_DEP_TIMEOUT	(HZ * 5)</span>

<span class="cm">/* I don&#39;t want to litter system log with timeout errors</span>
<span class="cm"> * when we have brain-damaged PHY.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_report_timeout_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_440GX_PHY_CLK_FIX</span> <span class="o">|</span>
				  <span class="n">EMAC_FTR_460EX_PHY_CLK_FIX</span> <span class="o">|</span>
				  <span class="n">EMAC_FTR_440EP_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span>
			<span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* EMAC PHY clock workaround:</span>
<span class="cm"> * 440EP/440GR has more sane SDR0_MFR register implementation than 440GX,</span>
<span class="cm"> * which allows controlling each EMAC clock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_rx_clk_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_DCR_NATIVE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_440EP_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_MFR</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="n">SDR0_MFR_ECS</span> <span class="o">&gt;&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_rx_clk_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_DCR_NATIVE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_440EP_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_MFR</span><span class="p">,</span>
			    <span class="n">SDR0_MFR_ECS</span> <span class="o">&gt;&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* PHY polling intervals */</span>
<span class="cp">#define PHY_POLL_LINK_ON	HZ</span>
<span class="cp">#define PHY_POLL_LINK_OFF	(HZ / 5)</span>

<span class="cm">/* Graceful stop timeouts in us.</span>
<span class="cm"> * We should allow up to 1 frame time (full-duplex, ignoring collisions)</span>
<span class="cm"> */</span>
<span class="cp">#define STOP_TIMEOUT_10		1230</span>
<span class="cp">#define STOP_TIMEOUT_100	124</span>
<span class="cp">#define STOP_TIMEOUT_1000	13</span>
<span class="cp">#define STOP_TIMEOUT_1000_JUMBO	73</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">default_mcast_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span>
<span class="p">};</span>

<span class="cm">/* Please, keep in sync with struct ibm_emac_stats/ibm_emac_error_stats */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">emac_stats_keys</span><span class="p">[</span><span class="n">EMAC_ETHTOOL_STATS_COUNT</span><span class="p">][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;rx_packets&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bytes&quot;</span><span class="p">,</span> <span class="s">&quot;tx_packets&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bytes&quot;</span><span class="p">,</span> <span class="s">&quot;rx_packets_csum&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_packets_csum&quot;</span><span class="p">,</span> <span class="s">&quot;tx_undo&quot;</span><span class="p">,</span> <span class="s">&quot;rx_dropped_stack&quot;</span><span class="p">,</span> <span class="s">&quot;rx_dropped_oom&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_dropped_error&quot;</span><span class="p">,</span> <span class="s">&quot;rx_dropped_resize&quot;</span><span class="p">,</span> <span class="s">&quot;rx_dropped_mtu&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_stopped&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bd_errors&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bd_overrun&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bd_bad_packet&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_bd_runt_packet&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bd_short_event&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bd_alignment_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_bd_bad_fcs&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bd_packet_too_long&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bd_out_of_range&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_bd_in_range&quot;</span><span class="p">,</span> <span class="s">&quot;rx_parity&quot;</span><span class="p">,</span> <span class="s">&quot;rx_fifo_overrun&quot;</span><span class="p">,</span> <span class="s">&quot;rx_overrun&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_bad_packet&quot;</span><span class="p">,</span> <span class="s">&quot;rx_runt_packet&quot;</span><span class="p">,</span> <span class="s">&quot;rx_short_event&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_alignment_error&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bad_fcs&quot;</span><span class="p">,</span> <span class="s">&quot;rx_packet_too_long&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_out_of_range&quot;</span><span class="p">,</span> <span class="s">&quot;rx_in_range&quot;</span><span class="p">,</span> <span class="s">&quot;tx_dropped&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bd_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_bd_bad_fcs&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bd_carrier_loss&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bd_excessive_deferral&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_bd_excessive_collisions&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bd_late_collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_bd_multple_collisions&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bd_single_collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_bd_underrun&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bd_sqe&quot;</span><span class="p">,</span> <span class="s">&quot;tx_parity&quot;</span><span class="p">,</span> <span class="s">&quot;tx_underrun&quot;</span><span class="p">,</span> <span class="s">&quot;tx_sqe&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_errors&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">emac_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">emac_clean_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__emac_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">emac_phy_supports_gige</span><span class="p">(</span><span class="kt">int</span> <span class="n">phy_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>  <span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_GMII</span> <span class="o">||</span>
		<span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_RGMII</span> <span class="o">||</span>
		<span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_SGMII</span> <span class="o">||</span>
		<span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_TBI</span> <span class="o">||</span>
		<span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_RTBI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">emac_phy_gpcs</span><span class="p">(</span><span class="kt">int</span> <span class="n">phy_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>  <span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_SGMII</span> <span class="o">||</span>
		<span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_TBI</span> <span class="o">||</span>
		<span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_RTBI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx_enable&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_TXE</span><span class="p">))</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">EMAC_MR0_TXE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_tx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx_disable&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_TXE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span><span class="p">;</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">,</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EMAC_MR0_TXE</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_TXI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="o">--</span><span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">))</span>
			<span class="n">emac_report_timeout_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX disable timeout&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MAL_COMMAC_RX_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">flags</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx_enable&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_RXE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_RXI</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Wait if previous async disable is still in progress */</span>
			<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_RXI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="o">--</span><span class="n">n</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">))</span>
				<span class="n">emac_report_timeout_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="s">&quot;RX disable timeout&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">EMAC_MR0_RXE</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_rx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx_disable&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_RXE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span><span class="p">;</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">,</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EMAC_MR0_RXE</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_RXI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="o">--</span><span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">))</span>
			<span class="n">emac_report_timeout_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX disable timeout&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_netif_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">no_mcast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>	<span class="cm">/* prevent tx timeout */</span>
	<span class="n">mal_poll_disable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_netif_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">no_mcast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mcast_pending</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">__emac_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* NOTE: unconditional netif_wake_queue is only appropriate</span>
<span class="cm">	 * so long as all callers are assured to have free tx slots</span>
<span class="cm">	 * (taken from tg3... though the case where that is wrong is</span>
<span class="cm">	 *  not terribly harmful)</span>
<span class="cm">	 */</span>
	<span class="n">mal_poll_enable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_rx_disable_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx_disable_async&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_RXE</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">,</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EMAC_MR0_RXE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 40x erratum suggests stopping RX channel before reset,</span>
<span class="cm">		 * we stop TX as well</span>
<span class="cm">		 */</span>
		<span class="n">emac_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">emac_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_DCR_NATIVE</span>
	<span class="cm">/* Enable internal clock source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_460EX_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_ETH_CFG</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="n">SDR0_ETH_CFG_ECS</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">,</span> <span class="n">EMAC_MR0_SRST</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EMAC_MR0_SRST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="p">)</span>
		<span class="o">--</span><span class="n">n</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_DCR_NATIVE</span>
	 <span class="cm">/* Enable external clock source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_460EX_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_ETH_CFG</span><span class="p">,</span>
			    <span class="n">SDR0_ETH_CFG_ECS</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">emac_report_timeout_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset timeout&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_hash_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">regs</span> <span class="o">=</span> <span class="n">EMAC_XAHT_REGS</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gaht_base</span> <span class="o">=</span> <span class="n">emac_gaht_base</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gaht_temp</span><span class="p">[</span><span class="n">regs</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hash_mc %d&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">gaht_temp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">gaht_temp</span><span class="p">));</span>

	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mc %pM&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="n">slot</span> <span class="o">=</span> <span class="n">EMAC_XAHT_CRC_TO_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">EMAC_XAHT_SLOT_TO_REG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">EMAC_XAHT_SLOT_TO_MASK</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

		<span class="n">gaht_temp</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">regs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">gaht_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">gaht_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">emac_iff2rmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC_RMR_SP</span> <span class="o">|</span> <span class="n">EMAC_RMR_SFCS</span> <span class="o">|</span> <span class="n">EMAC_RMR_IAE</span> <span class="o">|</span> <span class="n">EMAC_RMR_BAE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
	    <span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC4_RMR_BASE</span><span class="p">;</span>
	<span class="k">else</span>
	    <span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_RMR_BASE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_RMR_PME</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">EMAC_XAHT_SLOTS</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_RMR_PMME</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_RMR_MAE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_APM821XX_REQ_JUMBO_FRAME_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EMAC4_RMR_MJS_MASK</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC4_RMR_MJS</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__emac_calc_base_mr1</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">EMAC_MR1_VLE</span> <span class="o">|</span> <span class="n">EMAC_MR1_IST</span> <span class="o">|</span> <span class="n">EMAC_MR1_TR0_MULT</span><span class="p">;</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;__emac_calc_base_mr1&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">tx_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC_MR1_TFS_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unknown Tx FIFO size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tx_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">rx_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16384</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC_MR1_RFS_16K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC_MR1_RFS_4K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unknown Rx FIFO size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__emac4_calc_base_mr1</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">EMAC_MR1_VLE</span> <span class="o">|</span> <span class="n">EMAC_MR1_IST</span> <span class="o">|</span> <span class="n">EMAC4_MR1_TR</span> <span class="o">|</span>
		<span class="n">EMAC4_MR1_OBCI</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opb_bus_freq</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;__emac4_calc_base_mr1&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">tx_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16384</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC4_MR1_TFS_16K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC4_MR1_TFS_4K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC4_MR1_TFS_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unknown Tx FIFO size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tx_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">rx_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16384</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC4_MR1_RFS_16K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC4_MR1_RFS_4K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2048</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">EMAC4_MR1_RFS_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unknown Rx FIFO size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">emac_calc_base_mr1</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">__emac4_calc_base_mr1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_size</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">__emac_calc_base_mr1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_size</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">emac_calc_trtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EMAC_TRTR_SHIFT_EMAC4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EMAC_TRTR_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">emac_calc_rwmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">low</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">low</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">low</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_size</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">mr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;configure&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr1</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr1</span><span class="p">)</span>
			 <span class="o">|</span> <span class="n">EMAC_MR1_FDE</span> <span class="o">|</span> <span class="n">EMAC_MR1_ILE</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">emac_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">))</span>
		<span class="n">tah_reset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; link = %d duplex = %d, pause = %d, asym_pause = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">duplex</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">pause</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">asym_pause</span><span class="p">);</span>

	<span class="cm">/* Default fifo sizes */</span>
	<span class="n">tx_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size</span><span class="p">;</span>
	<span class="n">rx_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size</span><span class="p">;</span>

	<span class="cm">/* No link, force loopback */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span>
		<span class="n">mr1</span> <span class="o">=</span> <span class="n">EMAC_MR1_FDE</span> <span class="o">|</span> <span class="n">EMAC_MR1_ILE</span><span class="p">;</span>

	<span class="cm">/* Check for full duplex */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC_MR1_FDE</span> <span class="o">|</span> <span class="n">EMAC_MR1_MWSW_001</span><span class="p">;</span>

	<span class="cm">/* Adjust fifo sizes, mr1 and timeouts based on link speed */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span> <span class="o">=</span> <span class="n">STOP_TIMEOUT_10</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">emac_phy_gpcs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC_MR1_MF_1000GPCS</span> <span class="o">|</span> <span class="n">EMAC_MR1_MF_IPPA</span><span class="p">(</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gpcs_address</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gpcs_address</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>

			<span class="cm">/* Put some arbitrary OUI, Manuf &amp; Rev IDs so we can</span>
<span class="cm">			 * identify this GPCS PHY later.</span>
<span class="cm">			 */</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">u1</span><span class="p">.</span><span class="n">emac4</span><span class="p">.</span><span class="n">ipcr</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC_MR1_MF_1000</span><span class="p">;</span>

		<span class="cm">/* Extended fifo sizes */</span>
		<span class="n">tx_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size_gige</span><span class="p">;</span>
		<span class="n">rx_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size_gige</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
				<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC4_MR1_JPSM</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC_MR1_JPSM</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span> <span class="o">=</span> <span class="n">STOP_TIMEOUT_1000_JUMBO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span> <span class="o">=</span> <span class="n">STOP_TIMEOUT_1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC_MR1_MF_100</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span> <span class="o">=</span> <span class="n">STOP_TIMEOUT_100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* make gcc happy */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">rgmii_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">zmii_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>

	<span class="cm">/* on 40x erratum forces us to NOT use integrated flow control,</span>
<span class="cm">	 * let&#39;s hope it works on 44x ;)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_NO_FLOW_CONTROL_40x</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">pause</span><span class="p">)</span>
			<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC_MR1_EIFC</span> <span class="o">|</span> <span class="n">EMAC_MR1_APP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">asym_pause</span><span class="p">)</span>
			<span class="n">mr1</span> <span class="o">|=</span> <span class="n">EMAC_MR1_APP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add base settings &amp; fifo sizes &amp; program MR1 */</span>
	<span class="n">mr1</span> <span class="o">|=</span> <span class="n">emac_calc_base_mr1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_size</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mr1</span><span class="p">,</span> <span class="n">mr1</span><span class="p">);</span>

	<span class="cm">/* Set individual MAC address */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iahr</span><span class="p">,</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ialr</span><span class="p">,</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="cm">/* VLAN Tag Protocol ID */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">vtpid</span><span class="p">,</span> <span class="mh">0x8100</span><span class="p">);</span>

	<span class="cm">/* Receive mode register */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">emac_iff2rmr</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_RMR_MAE</span><span class="p">)</span>
		<span class="n">emac_hash_mc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* FIFOs thresholds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC4_TMR1</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_burst_size</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">tx_size</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC_TMR1</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_burst_size</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">tx_size</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmr1</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trtr</span><span class="p">,</span> <span class="n">emac_calc_trtr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* PAUSE frame is sent when RX FIFO reaches its high-water mark,</span>
<span class="cm">	   there should be still enough space in FIFO to allow the our link</span>
<span class="cm">	   partner time to process this frame and also time to send PAUSE</span>
<span class="cm">	   frame itself.</span>

<span class="cm">	   Here is the worst case scenario for the RX FIFO &quot;headroom&quot;</span>
<span class="cm">	   (from &quot;The Switch Book&quot;) (100Mbps, without preamble, inter-frame gap):</span>

<span class="cm">	   1) One maximum-length frame on TX                    1522 bytes</span>
<span class="cm">	   2) One PAUSE frame time                                64 bytes</span>
<span class="cm">	   3) PAUSE frame decode time allowance                   64 bytes</span>
<span class="cm">	   4) One maximum-length frame on RX                    1522 bytes</span>
<span class="cm">	   5) Round-trip propagation delay of the link (100Mb)    15 bytes</span>
<span class="cm">	   ----------</span>
<span class="cm">	   3187 bytes</span>

<span class="cm">	   I chose to set high-water mark to RX_FIFO_SIZE / 4 (1024 bytes)</span>
<span class="cm">	   low-water mark  to RX_FIFO_SIZE / 8 (512 bytes)</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">emac_calc_rwmr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_size</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span><span class="p">,</span>
			   <span class="n">rx_size</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rwmr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* Set PAUSE timer to the maximum */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* IRQ sources */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC_ISR_OVR</span> <span class="o">|</span> <span class="n">EMAC_ISR_BP</span> <span class="o">|</span> <span class="n">EMAC_ISR_SE</span> <span class="o">|</span>
		<span class="n">EMAC_ISR_ALE</span> <span class="o">|</span> <span class="n">EMAC_ISR_BFCS</span> <span class="o">|</span> <span class="n">EMAC_ISR_PTLE</span> <span class="o">|</span> <span class="n">EMAC_ISR_ORE</span> <span class="o">|</span>
		<span class="n">EMAC_ISR_IRE</span> <span class="o">|</span> <span class="n">EMAC_ISR_TE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
	    <span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC4_ISR_TXPE</span> <span class="o">|</span> <span class="n">EMAC4_ISR_RXPE</span> <span class="cm">/* | EMAC4_ISR_TXUE |</span>
<span class="cm">						  EMAC4_ISR_RXOE | */</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iser</span><span class="p">,</span>  <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* We need to take GPCS PHY out of isolate mode after EMAC reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_phy_gpcs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gpcs_address</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="n">emac_mii_reset_gpcs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">emac_mii_reset_phy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_reinitialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reinitialize&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">emac_netif_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">emac_tx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">emac_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">emac_netif_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_full_tx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;full_tx_reset&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">emac_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mal_disable_tx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_tx_chan</span><span class="p">);</span>
	<span class="n">emac_clean_tx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">emac_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mal_enable_tx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_tx_chan</span><span class="p">);</span>
	<span class="n">emac_tx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">emac_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">emac_instance</span><span class="p">,</span> <span class="n">reset_work</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset_work&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emac_netif_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">emac_full_tx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">emac_netif_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx_timeout&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">emac_phy_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stacr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">stacr</span> <span class="o">&amp;</span> <span class="n">EMAC_STACR_OC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_STACR_OC_INVERT</span><span class="p">))</span>
		<span class="n">done</span> <span class="o">=</span> <span class="o">!</span><span class="n">done</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__emac_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mdio_read(%02x,%02x)&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Enable proper MDIO port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">zmii_get_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">rgmii_get_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">);</span>

	<span class="cm">/* Wait for management interface to become idle */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_phy_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stacr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; -&gt; timeout wait idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Issue read command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC4_STACR_BASE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opb_bus_freq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC_STACR_BASE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opb_bus_freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_STACR_OC_INVERT</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_STACR_OC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_NEW_STACR</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMACX_STACR_STAC_READ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_STACR_STAC_READ</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">EMAC_STACR_PRA_MASK</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">EMAC_STACR_PCDA_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EMAC_STACR_PCDA_SHIFT</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stacr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* Wait for read to complete */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_phy_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stacr</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; -&gt; timeout wait complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">EMAC_STACR_PHYE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mdio_read(%02x, %02x) failed&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="n">EMAC_STACR_PHYD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EMAC_STACR_PHYD_MASK</span><span class="p">);</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mdio_read -&gt; %04x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">bail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">rgmii_put_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">zmii_put_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__emac_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mdio_write(%02x,%02x,%04x)&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Enable proper MDIO port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">zmii_get_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">rgmii_get_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">);</span>

	<span class="cm">/* Wait for management interface to be idle */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_phy_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stacr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; -&gt; timeout wait idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Issue write command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC4_STACR_BASE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opb_bus_freq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">EMAC_STACR_BASE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opb_bus_freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_STACR_OC_INVERT</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_STACR_OC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_NEW_STACR</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMACX_STACR_STAC_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">EMAC_STACR_STAC_WRITE</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">EMAC_STACR_PRA_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">EMAC_STACR_PCDA_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EMAC_STACR_PCDA_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">EMAC_STACR_PHYD_SHIFT</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stacr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* Wait for write to complete */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_phy_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stacr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; -&gt; timeout wait complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">bail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">rgmii_put_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">zmii_put_mdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">__emac_mdio_read</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_instance</span> <span class="o">&amp;&amp;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gpcs_address</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_instance</span> <span class="o">:</span> <span class="n">dev</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">__emac_mdio_write</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_instance</span> <span class="o">&amp;&amp;</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gpcs_address</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span> <span class="o">?</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_instance</span> <span class="o">:</span> <span class="n">dev</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Tx lock BH */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__emac_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rmr</span> <span class="o">=</span> <span class="n">emac_iff2rmr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;__multicast %08x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">rmr</span><span class="p">);</span>

	<span class="cm">/* I decided to relax register access rules here to avoid</span>
<span class="cm">	 * full EMAC reset.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There is a real problem with EMAC4 core if we use MWSW_001 bit</span>
<span class="cm">	 * in MR1 register and do a full EMAC reset.</span>
<span class="cm">	 * One TX BD status update is delayed and, after EMAC reset, it</span>
<span class="cm">	 * never happens, resulting in TX hung (it&#39;ll be recovered by TX</span>
<span class="cm">	 * timeout handler eventually, but this is just gross).</span>
<span class="cm">	 * So we either have to do full TX reset or try to cheat here :)</span>
<span class="cm">	 *</span>
<span class="cm">	 * The only required change is to RX mode register, so I *think* all</span>
<span class="cm">	 * we need is just to stop RX channel. This seems to work on all</span>
<span class="cm">	 * tested SoCs.                                                --ebs</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we need the full reset, we might just trigger the workqueue</span>
<span class="cm">	 * and do it async... a bit nasty but should work --BenH</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mcast_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">emac_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rmr</span> <span class="o">&amp;</span> <span class="n">EMAC_RMR_MAE</span><span class="p">)</span>
		<span class="n">emac_hash_mc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmr</span><span class="p">,</span> <span class="n">rmr</span><span class="p">);</span>
	<span class="n">emac_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Tx lock BH */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;multicast&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">no_mcast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mcast_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__emac_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_resize_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rx_sync_size</span> <span class="o">=</span> <span class="n">emac_rx_sync_size</span><span class="p">(</span><span class="n">new_mtu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rx_skb_size</span> <span class="o">=</span> <span class="n">emac_rx_skb_size</span><span class="p">(</span><span class="n">new_mtu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mr1_jumbo_bit_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="n">emac_netif_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">emac_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mal_disable_rx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_resize</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make a first pass over RX ring and mark BDs ready, dropping</span>
<span class="cm">	 * non-processed packets on the way. We need this as a separate pass</span>
<span class="cm">	 * to simplify error recovery in the case of allocation failure later.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFF</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_FIRST</span><span class="p">)</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_resize</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">MAL_RX_CTRL_EMPTY</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">NUM_RX_BUFF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAL_RX_CTRL_WRAP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reallocate RX ring only if bigger skb buffers are required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_skb_size</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>

	<span class="cm">/* Second pass, allocate new skbs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFF</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">rx_skb_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">EMAC_RX_SKB_HEADROOM</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span>
		    <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rx_sync_size</span><span class="p">,</span>
				   <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">skip:</span>
	<span class="cm">/* Check if we need to change &quot;Jumbo&quot; bit in MR1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_APM821XX_REQ_JUMBO_FRAME_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mr1_jumbo_bit_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mr1_jumbo_bit_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="o">^</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mr1_jumbo_bit_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is to prevent starting RX channel in emac_rx_enable() */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MAL_COMMAC_RX_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="n">emac_full_tx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mal_set_rcbs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">,</span> <span class="n">emac_rx_size</span><span class="p">(</span><span class="n">new_mtu</span><span class="p">));</span>
 <span class="nl">oom:</span>
	<span class="cm">/* Restart RX */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MAL_COMMAC_RX_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mal_enable_rx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">);</span>
	<span class="n">emac_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">emac_netif_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Process ctx, rtnl_lock semaphore */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">EMAC_MIN_MTU</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_mtu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;change_mtu(%d)&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check if we really need to reinitialize RX ring */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emac_rx_skb_size</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span> <span class="o">!=</span> <span class="n">emac_rx_skb_size</span><span class="p">(</span><span class="n">new_mtu</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">emac_resize_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span> <span class="o">=</span> <span class="n">emac_rx_skb_size</span><span class="p">(</span><span class="n">new_mtu</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sync_size</span> <span class="o">=</span> <span class="n">emac_rx_sync_size</span><span class="p">(</span><span class="n">new_mtu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_clean_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_BUFF</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_TX_CTRL_READY</span><span class="p">)</span>
				<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_clean_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFF</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">emac_alloc_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
				    <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">EMAC_RX_SKB_HEADROOM</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span>
	    <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sync_size</span><span class="p">,</span>
			   <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">MAL_RX_CTRL_EMPTY</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="p">(</span><span class="n">NUM_RX_BUFF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAL_RX_CTRL_WRAP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_print_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: link is up, %d %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">?</span> <span class="s">&quot;FDX&quot;</span> <span class="o">:</span> <span class="s">&quot;HDX&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">pause</span> <span class="o">?</span> <span class="s">&quot;, pause enabled&quot;</span> <span class="o">:</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">asym_pause</span> <span class="o">?</span> <span class="s">&quot;, asymmetric pause enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process ctx, rtnl_lock semaphore */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;open&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="cm">/* Setup error IRQ handler */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span><span class="p">,</span> <span class="n">emac_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;EMAC&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to request IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate RX ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFF</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emac_alloc_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to allocate RX ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MAL_COMMAC_RX_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Start PHY polling now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">link_poll_interval</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">poll_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="n">emac_rx_clk_default</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">link_poll_interval</span> <span class="o">=</span> <span class="n">PHY_POLL_LINK_ON</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">emac_rx_clk_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">link_poll_interval</span> <span class="o">=</span> <span class="n">PHY_POLL_LINK_OFF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">,</span> <span class="n">link_poll_interval</span><span class="p">);</span>
		<span class="n">emac_print_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Required for Pause packet support in EMAC */</span>
	<span class="n">dev_mc_add_global</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">default_mcast_addr</span><span class="p">);</span>

	<span class="n">emac_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mal_poll_add</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">);</span>
	<span class="n">mal_enable_tx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_tx_chan</span><span class="p">);</span>
	<span class="n">mal_set_rcbs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">,</span> <span class="n">emac_rx_size</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">));</span>
	<span class="n">mal_enable_rx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">);</span>
	<span class="n">emac_tx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">emac_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">emac_netif_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">oom:</span>
	<span class="n">emac_clean_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* BHs disabled */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int emac_link_differs(struct emac_instance *dev)</span>
<span class="c">{</span>
<span class="c">	u32 r = in_be32(&amp;dev-&gt;emacp-&gt;mr1);</span>

<span class="c">	int duplex = r &amp; EMAC_MR1_FDE ? DUPLEX_FULL : DUPLEX_HALF;</span>
<span class="c">	int speed, pause, asym_pause;</span>

<span class="c">	if (r &amp; EMAC_MR1_MF_1000)</span>
<span class="c">		speed = SPEED_1000;</span>
<span class="c">	else if (r &amp; EMAC_MR1_MF_100)</span>
<span class="c">		speed = SPEED_100;</span>
<span class="c">	else</span>
<span class="c">		speed = SPEED_10;</span>

<span class="c">	switch (r &amp; (EMAC_MR1_EIFC | EMAC_MR1_APP)) {</span>
<span class="c">	case (EMAC_MR1_EIFC | EMAC_MR1_APP):</span>
<span class="c">		pause = 1;</span>
<span class="c">		asym_pause = 0;</span>
<span class="c">		break;</span>
<span class="c">	case EMAC_MR1_APP:</span>
<span class="c">		pause = 0;</span>
<span class="c">		asym_pause = 1;</span>
<span class="c">		break;</span>
<span class="c">	default:</span>
<span class="c">		pause = asym_pause = 0;</span>
<span class="c">	}</span>
<span class="c">	return speed != dev-&gt;phy.speed || duplex != dev-&gt;phy.duplex ||</span>
<span class="c">	    pause != dev-&gt;phy.pause || asym_pause != dev-&gt;phy.asym_pause;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_link_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">),</span>
			     <span class="k">struct</span> <span class="n">emac_instance</span><span class="p">,</span> <span class="n">link_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">link_poll_interval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link timer&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">poll_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">emac_rx_clk_default</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* Get new link parameters */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">emac_netif_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">emac_full_tx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">emac_netif_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">emac_print_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">link_poll_interval</span> <span class="o">=</span> <span class="n">PHY_POLL_LINK_ON</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">emac_rx_clk_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">emac_reinitialize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">emac_print_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">link_poll_interval</span> <span class="o">=</span> <span class="n">PHY_POLL_LINK_OFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">,</span> <span class="n">link_poll_interval</span><span class="p">);</span>
 <span class="nl">bail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_force_link_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_polling</span><span class="p">)</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">,</span>  <span class="n">PHY_POLL_LINK_OFF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Process ctx, rtnl_lock semaphore */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;close&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="n">emac_netif_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>

	<span class="n">emac_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">emac_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mal_disable_rx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">);</span>
	<span class="n">mal_disable_tx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_tx_chan</span><span class="p">);</span>
	<span class="n">mal_poll_del</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">);</span>

	<span class="n">emac_clean_tx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">emac_clean_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">emac_tx_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets_csum</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">EMAC_TX_CTRL_TAH_CSUM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">emac_xmit_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="cm">/* Send the packet out. If the if makes a significant perf</span>
<span class="cm">	 * difference, then we can store the TMR0 value in &quot;dev&quot;</span>
<span class="cm">	 * instead</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmr0</span><span class="p">,</span> <span class="n">EMAC4_TMR0_XMIT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmr0</span><span class="p">,</span> <span class="n">EMAC_TMR0_XMIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">==</span> <span class="n">NUM_TX_BUFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stopped TX queue&quot;</span> <span class="n">NL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tx lock BH */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">EMAC_TX_CTRL_GFCS</span> <span class="o">|</span> <span class="n">EMAC_TX_CTRL_GP</span> <span class="o">|</span> <span class="n">MAL_TX_CTRL_READY</span> <span class="o">|</span>
	    <span class="n">MAL_TX_CTRL_LAST</span> <span class="o">|</span> <span class="n">emac_tx_csum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span> <span class="o">==</span> <span class="n">NUM_TX_BUFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">MAL_TX_CTRL_WRAP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xmit(%u) %d&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
						     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">emac_xmit_finish</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">emac_xmit_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">,</span> <span class="n">u16</span> <span class="n">base_ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">base_ctrl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">MAL_MAX_TX_SIZE</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">chunk</span><span class="p">;</span>

		<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_TX_BUFF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">MAL_TX_CTRL_LAST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">NUM_TX_BUFF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">MAL_TX_CTRL_WRAP</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">chunk</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pd</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tx lock BH disabled (SG version for TAH equipped EMACs) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_start_xmit_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pd</span><span class="p">;</span>

	<span class="cm">/* This is common &quot;fast&quot; path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">nr_frags</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">MAL_MAX_TX_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emac_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">-=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>

	<span class="cm">/* Note, this is only an *estimation*, we can still run out of empty</span>
<span class="cm">	 * slots because of the additional fragmentation into</span>
<span class="cm">	 * MAL_MAX_TX_SIZE-sized chunks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">+</span> <span class="n">nr_frags</span> <span class="o">+</span> <span class="n">mal_tx_chunks</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NUM_TX_BUFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">stop_queue</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">EMAC_TX_CTRL_GFCS</span> <span class="o">|</span> <span class="n">EMAC_TX_CTRL_GP</span> <span class="o">|</span> <span class="n">MAL_TX_CTRL_READY</span> <span class="o">|</span>
	    <span class="n">emac_tx_csum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span><span class="p">;</span>

	<span class="cm">/* skb data */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chunk</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">MAL_MAX_TX_SIZE</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="n">pd</span> <span class="o">=</span>
	    <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span><span class="p">))</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">emac_xmit_split</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">pd</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">!</span><span class="n">nr_frags</span><span class="p">,</span>
				       <span class="n">ctrl</span><span class="p">);</span>
	<span class="cm">/* skb fragments */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">+</span> <span class="n">mal_tx_chunks</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">NUM_TX_BUFF</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">undo_frame</span><span class="p">;</span>

		<span class="n">pd</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">slot</span> <span class="o">=</span> <span class="n">emac_xmit_split</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xmit_sg(%u) %d - %d&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="cm">/* Attach skb to the last slot so we don&#39;t release it too early */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Send the packet out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span> <span class="o">==</span> <span class="n">NUM_TX_BUFF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">MAL_TX_CTRL_WRAP</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_TX_BUFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">emac_xmit_finish</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

 <span class="nl">undo_frame:</span>
	<span class="cm">/* Well, too bad. Our previous estimation was overly optimistic.</span>
<span class="cm">	 * Undo everything.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">--</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="n">NUM_TX_BUFF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">tx_undo</span><span class="p">;</span>

 <span class="nl">stop_queue:</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stopped TX queue&quot;</span> <span class="n">NL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tx lock BHs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_parse_tx_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_error_stats</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BD TX error %04x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_errors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_BFCS</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_bad_fcs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_LCS</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_carrier_loss</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_ED</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_excessive_deferral</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_EC</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_excessive_collisions</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_LC</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_late_collision</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_MC</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_multple_collisions</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_SC</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_single_collision</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_UR</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_underrun</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_TX_ST_SQE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bd_sqe</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_poll_tx</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bad_mask</span><span class="p">;</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;poll_tx, %d %d&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">))</span>
		<span class="n">bad_mask</span> <span class="o">=</span> <span class="n">EMAC_IS_BAD_TX_TAH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bad_mask</span> <span class="o">=</span> <span class="n">EMAC_IS_BAD_TX</span><span class="p">;</span>

	<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_slot</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">again:</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_TX_CTRL_READY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
			<span class="o">++</span><span class="n">n</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_TX_BUFF</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">bad_mask</span><span class="p">))</span>
				<span class="n">emac_parse_tx_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ack_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">&lt;</span> <span class="n">EMAC_TX_WAKEUP_THRESH</span><span class="p">)</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

			<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx %d pkts&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_recycle_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;recycle %d %d&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">EMAC_DMA_ALIGN</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">MAL_RX_CTRL_EMPTY</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="p">(</span><span class="n">NUM_RX_BUFF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAL_RX_CTRL_WRAP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_parse_rx_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_error_stats</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BD RX error %04x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_errors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_OE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_overrun</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_BP</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_bad_packet</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_RP</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_runt_packet</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_SE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_short_event</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_AE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_alignment_error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_BFCS</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_bad_fcs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_PTL</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_packet_too_long</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_ORE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_out_of_range</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EMAC_RX_ST_IRE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bd_in_range</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emac_rx_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IBM_EMAC_TAH</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets_csum</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">emac_rx_sg_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tot_len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tot_len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_mtu</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cacheable_memcpy</span><span class="p">(</span><span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">),</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">emac_recycle_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">emac_recycle_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NAPI poll context */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_poll_rx</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span><span class="p">,</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;poll_rx(%d)&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

 <span class="nl">again:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">budget</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_EMPTY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">data_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">MAL_IS_SINGLE_RX</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">sg</span><span class="p">;</span>

		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="n">EMAC_BAD_RX_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl</span> <span class="o">!=</span> <span class="n">EMAC_RX_TAH_BAD_CSUM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">emac_parse_rx_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_error</span><span class="p">;</span>
			<span class="n">emac_recycle_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_stack</span><span class="p">;</span>
			<span class="n">emac_recycle_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">EMAC_RX_COPY_THRESH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">copy_skb</span> <span class="o">=</span>
			    <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">EMAC_RX_SKB_HEADROOM</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">copy_skb</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="n">EMAC_RX_SKB_HEADROOM</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">cacheable_memcpy</span><span class="p">(</span><span class="n">copy_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
					 <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">emac_recycle_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">copy_skb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">emac_alloc_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="nl">push_packet:</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">emac_rx_csum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">NET_RX_DROP</span><span class="p">))</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_stack</span><span class="p">;</span>
	<span class="nl">next:</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="nl">skip:</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RX_BUFF</span><span class="p">;</span>
		<span class="o">--</span><span class="n">budget</span><span class="p">;</span>
		<span class="o">++</span><span class="n">received</span><span class="p">;</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="nl">sg:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_FIRST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">emac_alloc_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx OOM %d&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
				<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_oom</span><span class="p">;</span>
				<span class="n">emac_recycle_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_rx_sg_append</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_LAST</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="n">EMAC_BAD_RX_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl</span> <span class="o">!=</span> <span class="n">EMAC_RX_TAH_BAD_CSUM</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">emac_parse_rx_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
				<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_error</span><span class="p">;</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">push_packet</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
	<span class="nl">oom:</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx OOM %d&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="cm">/* Drop the packet and recycle skb */</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_oom</span><span class="p">;</span>
		<span class="n">emac_recycle_rx_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">received</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx %d BDs&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">received</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">budget</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">MAL_COMMAC_RX_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_EMPTY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx restart&quot;</span> <span class="n">NL</span><span class="p">);</span>
			<span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dropping partial rx packet&quot;</span> <span class="n">NL</span><span class="p">);</span>
			<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_dropped_error</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sg_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MAL_COMMAC_RX_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mal_enable_rx_channel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">);</span>
		<span class="n">emac_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NAPI poll context */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_peek_rx</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_EMPTY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* NAPI poll context */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_peek_rx_sg</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_EMPTY</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MAL_RX_CTRL_LAST</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RX_BUFF</span><span class="p">;</span>

		<span class="cm">/* I&#39;m just being paranoid here :) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_slot</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Hard IRQ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_rxde</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">.</span><span class="n">rx_stopped</span><span class="p">;</span>
	<span class="n">emac_rx_disable_async</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Hard IRQ */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">emac_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">emac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">emac_error_stats</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">isr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">isr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isr = %08x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC4_ISR_TXPE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_parity</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC4_ISR_RXPE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_parity</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC4_ISR_TXUE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_underrun</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC4_ISR_RXOE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_fifo_overrun</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_OVR</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_overrun</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_BP</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bad_packet</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_RP</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_runt_packet</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_SE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_short_event</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_ALE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_alignment_error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_BFCS</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bad_fcs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_PTLE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_packet_too_long</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_ORE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_out_of_range</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_IRE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_in_range</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_SQE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_sqe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">EMAC_ISR_TE</span><span class="p">)</span>
		<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">emac_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">emac_stats</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">emac_error_stats</span> <span class="o">*</span><span class="n">est</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">nst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nstats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stats&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="cm">/* Compute &quot;legacy&quot; statistics */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_dropped_oom</span> <span class="o">+</span>
					  <span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_dropped_error</span> <span class="o">+</span>
					  <span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_dropped_resize</span> <span class="o">+</span>
					  <span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_dropped_mtu</span><span class="p">);</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="p">;</span>

	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_errors</span><span class="p">;</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_overrun</span> <span class="o">+</span>
					      <span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_fifo_overrun</span> <span class="o">+</span>
					      <span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_overrun</span><span class="p">);</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_alignment_error</span> <span class="o">+</span>
					       <span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_alignment_error</span><span class="p">);</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_bad_fcs</span> <span class="o">+</span>
					     <span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bad_fcs</span><span class="p">);</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_runt_packet</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_short_event</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_packet_too_long</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_out_of_range</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_bd_in_range</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_runt_packet</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_short_event</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_packet_too_long</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_out_of_range</span> <span class="o">+</span>
						<span class="n">est</span><span class="o">-&gt;</span><span class="n">rx_in_range</span><span class="p">);</span>

	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_bd_errors</span> <span class="o">+</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">);</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_bd_underrun</span> <span class="o">+</span>
					      <span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_underrun</span><span class="p">);</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_bd_carrier_loss</span><span class="p">;</span>
	<span class="n">nst</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_bd_excessive_deferral</span> <span class="o">+</span>
					  <span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_bd_excessive_collisions</span> <span class="o">+</span>
					  <span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_bd_late_collision</span> <span class="o">+</span>
					  <span class="n">est</span><span class="o">-&gt;</span><span class="n">tx_bd_multple_collisions</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mal_commac_ops</span> <span class="n">emac_commac_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">poll_tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_poll_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_poll_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">peek_rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_peek_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxde</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_rxde</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mal_commac_ops</span> <span class="n">emac_commac_sg_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">poll_tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_poll_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_poll_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">peek_rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_peek_rx_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxde</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_rxde</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Ethtool support */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_ethtool_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">XCVR_EXTERNAL</span> <span class="o">:</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_ethtool_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">f</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set_settings(%d, %d, %d, 0x%08x)&quot;</span> <span class="n">NL</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">);</span>

	<span class="cm">/* Basic sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_10baseT_Full</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_100baseT_Half</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_1000baseT_Half</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_forced</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span>
						<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_aneg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">f</span><span class="p">)</span> <span class="o">|</span>
					      <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">advertising</span> <span class="o">&amp;</span>
					       <span class="p">(</span><span class="n">ADVERTISED_Pause</span> <span class="o">|</span>
						<span class="n">ADVERTISED_Asym_Pause</span><span class="p">)));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">emac_force_link_update</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_ethtool_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">NUM_RX_BUFF</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">NUM_TX_BUFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_ethtool_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISED_Pause</span> <span class="o">|</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">)))</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">pause</span><span class="p">)</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">asym_pause</span><span class="p">)</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span>
		<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_ethtool_regs_subhdr</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">EMAC4_ETHTOOL_REGS_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_ethtool_regs_subhdr</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">EMAC_ETHTOOL_REGS_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_ethtool_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_ethtool_regs_hdr</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">emac_get_regs_len</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">mal_get_regs_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">zmii_get_regs_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">rgmii_get_regs_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">tah_get_regs_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">emac_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_ethtool_regs_subhdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">EMAC4_ETHTOOL_REGS_VER</span><span class="p">;</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">,</span> <span class="n">EMAC4_ETHTOOL_REGS_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">EMAC4_ETHTOOL_REGS_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">EMAC_ETHTOOL_REGS_VER</span><span class="p">;</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">,</span> <span class="n">EMAC_ETHTOOL_REGS_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">EMAC_ETHTOOL_REGS_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_ethtool_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">emac_ethtool_regs_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">components</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">mal_dump_regs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">emac_dump_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">components</span> <span class="o">|=</span> <span class="n">EMAC_ETHTOOL_REGS_ZMII</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">zmii_dump_regs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">components</span> <span class="o">|=</span> <span class="n">EMAC_ETHTOOL_REGS_RGMII</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">rgmii_dump_regs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">components</span> <span class="o">|=</span> <span class="n">EMAC_ETHTOOL_REGS_TAH</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">tah_dump_regs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_ethtool_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nway_reset&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_aneg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">advertising</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="n">emac_force_link_update</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_ethtool_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stringset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EMAC_ETHTOOL_STATS_COUNT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_ethtool_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emac_stats_keys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">emac_stats_keys</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_ethtool_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">estats</span><span class="p">,</span>
					   <span class="n">u64</span> <span class="o">*</span> <span class="n">tmp_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">tmp_stats</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">estats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_ethtool_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ibm_emac&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;PPC 4xx EMAC-%d %s&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="n">emac_ethtool_get_regs_len</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">emac_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">emac_ethtool_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">emac_ethtool_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">emac_ethtool_get_drvinfo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_regs_len</span> <span class="o">=</span> <span class="n">emac_ethtool_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span> <span class="o">=</span> <span class="n">emac_ethtool_get_regs</span><span class="p">,</span>

	<span class="p">.</span><span class="n">nway_reset</span> <span class="o">=</span> <span class="n">emac_ethtool_nway_reset</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_ringparam</span> <span class="o">=</span> <span class="n">emac_ethtool_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">emac_ethtool_get_pauseparam</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">emac_ethtool_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">emac_ethtool_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">emac_ethtool_get_ethtool_stats</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emac_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioctl %08x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">emac_mdio_read</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
					       <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="n">emac_mdio_write</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">emac_depentry</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">phandle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span>	<span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">ofdev</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">drvdata</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	EMAC_DEP_MAL_IDX	0</span>
<span class="cp">#define	EMAC_DEP_ZMII_IDX	1</span>
<span class="cp">#define	EMAC_DEP_RGMII_IDX	2</span>
<span class="cp">#define	EMAC_DEP_TAH_IDX	3</span>
<span class="cp">#define	EMAC_DEP_MDIO_IDX	4</span>
<span class="cp">#define	EMAC_DEP_PREV_IDX	5</span>
<span class="cp">#define	EMAC_DEP_COUNT		6</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">emac_check_deps</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">emac_depentry</span> <span class="o">*</span><span class="n">deps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">there</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EMAC_DEP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no dependency on that item, allright */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phandle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">there</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* special case for blist as the dependency might go away */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">EMAC_DEP_PREV_IDX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">blist</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">there</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ofdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ofdev</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ofdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">drvdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">drvdata</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">drvdata</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">there</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">there</span> <span class="o">==</span> <span class="n">EMAC_DEP_COUNT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emac_put_deps</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_dev</span><span class="p">)</span>
		<span class="n">of_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">)</span>
		<span class="n">of_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">)</span>
		<span class="n">of_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_dev</span><span class="p">)</span>
		<span class="n">of_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">)</span>
		<span class="n">of_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">emac_of_bus_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We are only intereted in device addition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">BUS_NOTIFY_BOUND_DRIVER</span><span class="p">)</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emac_probe_wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">emac_of_bus_notifier</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">emac_of_bus_notify</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">emac_wait_deps</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_depentry</span> <span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">deps</span><span class="p">));</span>

	<span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_MAL_IDX</span><span class="p">].</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_ph</span><span class="p">;</span>
	<span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_ZMII_IDX</span><span class="p">].</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_ph</span><span class="p">;</span>
	<span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_RGMII_IDX</span><span class="p">].</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_ph</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_ph</span><span class="p">)</span>
		<span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_TAH_IDX</span><span class="p">].</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_ph</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_ph</span><span class="p">)</span>
		<span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_MDIO_IDX</span><span class="p">].</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_ph</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">blist</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">blist</span> <span class="o">&gt;</span> <span class="n">emac_boot_list</span><span class="p">)</span>
		<span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_PREV_IDX</span><span class="p">].</span><span class="n">phandle</span> <span class="o">=</span> <span class="mh">0xffffffffu</span><span class="p">;</span>
	<span class="n">bus_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emac_of_bus_notifier</span><span class="p">);</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">emac_probe_wait</span><span class="p">,</span>
			   <span class="n">emac_check_deps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">deps</span><span class="p">),</span>
			   <span class="n">EMAC_PROBE_DEP_TIMEOUT</span><span class="p">);</span>
	<span class="n">bus_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emac_of_bus_notifier</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">emac_check_deps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">deps</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EMAC_DEP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span><span class="p">)</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ofdev</span><span class="p">)</span>
			<span class="n">of_dev_put</span><span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ofdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_dev</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_MAL_IDX</span><span class="p">].</span><span class="n">ofdev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_ZMII_IDX</span><span class="p">].</span><span class="n">ofdev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_RGMII_IDX</span><span class="p">].</span><span class="n">ofdev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_TAH_IDX</span><span class="p">].</span><span class="n">ofdev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_dev</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_MDIO_IDX</span><span class="p">].</span><span class="n">ofdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_PREV_IDX</span><span class="p">].</span><span class="n">ofdev</span><span class="p">)</span>
		<span class="n">of_dev_put</span><span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">EMAC_DEP_PREV_IDX</span><span class="p">].</span><span class="n">ofdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">emac_read_uint_prop</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fatal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fatal</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: missing %s property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">emac_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_map</span><span class="p">,</span> <span class="n">adv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">;</span>

	<span class="cm">/* PHY-less configuration.</span>
<span class="cm">	 * XXX I probably should move these settings to the dev tree</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_map</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emac_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* PHY-less configuration.</span>
<span class="cm">		 * XXX I probably should move these settings to the dev tree</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">SUPPORTED_MII</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emac_phy_supports_gige</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emac_phy_map_lock</span><span class="p">);</span>
	<span class="n">phy_map</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_map</span> <span class="o">|</span> <span class="n">busy_phy_map</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY maps %08x %08x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">,</span> <span class="n">busy_phy_map</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">emac_mdio_read</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">emac_mdio_write</span><span class="p">;</span>

	<span class="cm">/* Enable internal clock source */</span>
<span class="cp">#ifdef CONFIG_PPC_DCR_NATIVE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_440GX_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_MFR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDR0_MFR_ECS</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* PHY clock workaround */</span>
	<span class="n">emac_rx_clk_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable internal clock source on 440GX*/</span>
<span class="cp">#ifdef CONFIG_PPC_DCR_NATIVE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_440GX_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_MFR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDR0_MFR_ECS</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Configure EMAC with defaults so we can at least use MDIO</span>
<span class="cm">	 * This is needed mostly for 440GX</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_phy_gpcs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* XXX</span>
<span class="cm">		 * Make GPCS PHY address equal to EMAC index.</span>
<span class="cm">		 * We probably should take into account busy_phy_map</span>
<span class="cm">		 * and/or phy_map here.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note that the busy_phy_map is currently global</span>
<span class="cm">		 * while it should probably be per-ASIC...</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gpcs_address</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpcs_address</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gpcs_address</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">emac_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="n">phy_map</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_address</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">phy_map</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy_map</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">busy_phy_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Quick check if there is a PHY at the address */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">emac_mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">||</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_mii_phy_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* Enable external clock source */</span>
<span class="cp">#ifdef CONFIG_PPC_DCR_NATIVE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_440GX_PHY_CLK_FIX</span><span class="p">))</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_MFR</span><span class="p">,</span> <span class="n">SDR0_MFR_ECS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emac_phy_map_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: can&#39;t find PHY!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init PHY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* Disable any PHY features not supported by the platform */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_feat_exc</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_feat_exc</span><span class="p">;</span>

	<span class="cm">/* Setup initial link parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">features</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_NO_FLOW_CONTROL_40x</span><span class="p">))</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISED_Pause</span> <span class="o">|</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
		<span class="cm">/* Restart autonegotiation */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_aneg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">f</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">,</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

		<span class="cm">/* Select highest supported speed/duplex */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_1000baseT_Half</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_100baseT_Half</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_10baseT_Full</span><span class="p">)</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>

		<span class="cm">/* Force link parameters */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_forced</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">emac_init_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="cm">/* Read config from device-tree */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mal-device&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_ph</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mal-tx-channel&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_tx_chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mal-rx-channel&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cell-index&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;max-frame-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_mtu</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rx-fifo-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tx-fifo-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rx-fifo-size-gige&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size_gige</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size_gige</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tx-fifo-size-gige&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size_gige</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size_gige</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;phy-address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;phy-map&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_map</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;gpcs-address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpcs_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gpcs_address</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opb_bus_freq</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tah-device&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_ph</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_ph</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tah-channel&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mdio-device&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_ph</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_ph</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;zmii-device&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_ph</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_ph</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;zmii-channel&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rgmii-device&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_ph</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_ph</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rgmii-channel&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;fifo-entry-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fifo_entry_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_read_uint_prop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mal-burst-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_burst_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_burst_size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="cm">/* PHY mode needs some decoding */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">=</span> <span class="n">of_get_phy_mode</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">=</span> <span class="n">PHY_MODE_NA</span><span class="p">;</span>

	<span class="cm">/* Check EMAC version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac4sync&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="p">(</span><span class="n">EMAC_FTR_EMAC4</span> <span class="o">|</span> <span class="n">EMAC_FTR_EMAC4SYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-460ex&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-460gt&quot;</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_460EX_PHY_CLK_FIX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-405ex&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-405exr&quot;</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_440EP_PHY_CLK_FIX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-apm821xx&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="p">(</span><span class="n">EMAC_APM821XX_REQ_JUMBO_FRAME_SIZE</span> <span class="o">|</span>
					  <span class="n">EMAC_FTR_APM821XX_NO_HALF_DUPLEX</span> <span class="o">|</span>
					  <span class="n">EMAC_FTR_460EX_PHY_CLK_FIX</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac4&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_EMAC4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-440gx&quot;</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_440GX_PHY_CLK_FIX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-440ep&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-440gr&quot;</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_440EP_PHY_CLK_FIX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-405ez&quot;</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IBM_EMAC_NO_FLOW_CTRL</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_NO_FLOW_CONTROL_40x</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Flow control not disabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Fixup some feature bits based on the device tree */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;has-inverted-stacr-oc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_STACR_OC_INVERT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;has-new-stacr-staopc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_HAS_NEW_STACR</span><span class="p">;</span>

	<span class="cm">/* CAB lacks the appropriate properties */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,emac-axon&quot;</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_HAS_NEW_STACR</span> <span class="o">|</span>
			<span class="n">EMAC_FTR_STACR_OC_INVERT</span><span class="p">;</span>

	<span class="cm">/* Enable TAH/ZMII/RGMII features as found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_ph</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IBM_EMAC_TAH</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: TAH support not enabled !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_ph</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IBM_EMAC_ZMII</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ZMII support not enabled !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_ph</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IBM_EMAC_RGMII</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: RGMII support not enabled !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Read MAC-address */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t find local-mac-address property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* IAHT and GAHT filter parameterization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_EMAC4SYNC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">xaht_slots_shift</span> <span class="o">=</span> <span class="n">EMAC4SYNC_XAHT_SLOTS_SHIFT</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">xaht_width_shift</span> <span class="o">=</span> <span class="n">EMAC4SYNC_XAHT_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">xaht_slots_shift</span> <span class="o">=</span> <span class="n">EMAC4_XAHT_SLOTS_SHIFT</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">xaht_width_shift</span> <span class="o">=</span> <span class="n">EMAC4_XAHT_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;features     : 0x%08x / 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">EMAC_FTRS_POSSIBLE</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx_fifo_size : %d (%d gige)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_size_gige</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx_fifo_size : %d (%d gige)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_size_gige</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;max_mtu      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_mtu</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OPB freq     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">opb_bus_freq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">emac_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">emac_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">emac_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">emac_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">emac_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">emac_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">emac_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">emac_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">emac_gige_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">emac_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">emac_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">emac_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">emac_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">emac_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">emac_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">emac_start_xmit_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">emac_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">emac_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">**</span><span class="n">blist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Skip unused/unwired EMACS.  We leave the check for an unused</span>
<span class="cm">	 * property here for now, but new flat device trees should set a</span>
<span class="cm">	 * status property to &quot;disabled&quot; instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;unused&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">of_device_is_available</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Find ourselves in the bootlist if we are there */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EMAC_BOOT_LIST_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emac_boot_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="p">)</span>
			<span class="n">blist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_boot_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* Allocate our net_device structure */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">emac_instance</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_gone</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ofdev</span> <span class="o">=</span> <span class="n">ofdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">blist</span> <span class="o">=</span> <span class="n">blist</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Initialize some embedded data structures */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span> <span class="n">emac_reset_work</span><span class="p">);</span>

	<span class="cm">/* Init various config data based on device-tree */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">emac_init_config</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="cm">/* Get interrupts. EMAC irq is mandatory, WOL irq is optional */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wol_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t map main interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span><span class="p">;</span>

	<span class="cm">/* Map EMAC regs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rsrc_regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get registers address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq_unmap</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>TODO : request<em>mem</em>region</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rsrc_regs</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
			     <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rsrc_regs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t map device registers!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_irq_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for dependent devices */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">emac_wait_deps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: Timeout waiting for dependent devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="cm">/*  display more info about what&#39;s missing ? */</span>
		<span class="k">goto</span> <span class="n">err_reg_unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_instance</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdio_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Register with MAL */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_commac_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">tx_chan_mask</span> <span class="o">=</span> <span class="n">MAL_CHAN_MASK</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_tx_chan</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">rx_chan_mask</span> <span class="o">=</span> <span class="n">MAL_CHAN_MASK</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mal_register_commac</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to register with mal %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_rel_deps</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span> <span class="o">=</span> <span class="n">emac_rx_skb_size</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_sync_size</span> <span class="o">=</span> <span class="n">emac_rx_sync_size</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>

	<span class="cm">/* Get pointers to BD rings */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span> <span class="o">=</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="o">-&gt;</span><span class="n">bd_virt</span> <span class="o">+</span> <span class="n">mal_tx_bd_offset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_tx_chan</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span> <span class="o">=</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="o">-&gt;</span><span class="n">bd_virt</span> <span class="o">+</span> <span class="n">mal_rx_bd_offset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal_rx_chan</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx_desc %p&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx_desc %p&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">);</span>

	<span class="cm">/* Clean rings */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NUM_TX_BUFF</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mal_descriptor</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NUM_RX_BUFF</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mal_descriptor</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NUM_TX_BUFF</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NUM_RX_BUFF</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">));</span>

	<span class="cm">/* Attach to ZMII, if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">zmii_attach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unreg_commac</span><span class="p">;</span>

	<span class="cm">/* Attach to RGMII, if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">rgmii_attach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_detach_zmii</span><span class="p">;</span>

	<span class="cm">/* Attach to TAH, if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">tah_attach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_port</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_detach_rgmii</span><span class="p">;</span>

	<span class="cm">/* Set some link defaults before we can find out real parameters */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">pause</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">asym_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop_timeout</span> <span class="o">=</span> <span class="n">STOP_TIMEOUT_100</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">,</span> <span class="n">emac_link_timer</span><span class="p">);</span>

	<span class="cm">/* Some SoCs like APM821xx does not support Half Duplex mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_APM821XX_NO_HALF_DUPLEX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_feat_exc</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
				     <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
				     <span class="n">SUPPORTED_10baseT_Half</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Find PHY if any */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">emac_init_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_detach_tah</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span><span class="p">;</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_phy_supports_gige</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_gige_netdev_ops</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_commac_sg_ops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emac_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emac_ethtool_ops</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to register net device (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_detach_tah</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set our drvdata last as we don&#39;t want them visible until we are</span>
<span class="cm">	 * fully initialized</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* There&#39;s a new kid in town ! Let&#39;s tell everybody */</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emac_probe_wait</span><span class="p">);</span>


	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: EMAC-%d %s, MAC %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy_mode</span> <span class="o">==</span> <span class="n">PHY_MODE_SGMII</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: in SGMII mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: found %s PHY (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>

	<span class="n">emac_dbg_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Life is good */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* I have a bad feeling about this ... */</span>

 <span class="nl">err_detach_tah:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">))</span>
		<span class="n">tah_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_port</span><span class="p">);</span>
 <span class="nl">err_detach_rgmii:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">rgmii_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">);</span>
 <span class="nl">err_detach_zmii:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">zmii_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">);</span>
 <span class="nl">err_unreg_commac:</span>
	<span class="n">mal_unregister_commac</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">);</span>
 <span class="nl">err_rel_deps:</span>
	<span class="n">emac_put_deps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">err_reg_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">);</span>
 <span class="nl">err_irq_unmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wol_irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wol_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span><span class="p">);</span>
 <span class="nl">err_free:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
 <span class="nl">err_gone:</span>
	<span class="cm">/* if we were on the bootlist, remove us as we won&#39;t show up and</span>
<span class="cm">	 * wake up all waiters to notify them in case they were waiting</span>
<span class="cm">	 * on us</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blist</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">blist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emac_probe_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">emac_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">emac_instance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;remove&quot;</span> <span class="n">NL</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_TAH</span><span class="p">))</span>
		<span class="n">tah_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tah_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_RGMII</span><span class="p">))</span>
		<span class="n">rgmii_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rgmii_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac_has_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EMAC_FTR_HAS_ZMII</span><span class="p">))</span>
		<span class="n">zmii_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">zmii_port</span><span class="p">);</span>

	<span class="n">busy_phy_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;busy_phy_map now %#x&quot;</span> <span class="n">NL</span><span class="p">,</span> <span class="n">busy_phy_map</span><span class="p">);</span>

	<span class="n">mal_unregister_commac</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">commac</span><span class="p">);</span>
	<span class="n">emac_put_deps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">emac_dbg_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emacp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wol_irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wol_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">emac_irq</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* XXX Features in here should be replaced by properties... */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">emac_match</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;network&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span>	<span class="o">=</span> <span class="s">&quot;ibm,emac&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;network&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span>	<span class="o">=</span> <span class="s">&quot;ibm,emac4&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;network&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span>	<span class="o">=</span> <span class="s">&quot;ibm,emac4sync&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">emac_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">emac_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;emac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">emac_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">emac_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">emac_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">emac_make_bootlist</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cell_indices</span><span class="p">[</span><span class="n">EMAC_BOOT_LIST_SIZE</span><span class="p">];</span>

	<span class="cm">/* Collect EMACs */</span>
	<span class="k">while</span><span class="p">((</span><span class="n">np</span> <span class="o">=</span> <span class="n">of_find_all_nodes</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">of_match_node</span><span class="p">(</span><span class="n">emac_match</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;unused&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cell-index&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">cell_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">emac_boot_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">EMAC_BOOT_LIST_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Bubble sort them (doh, what a creative algorithm :-) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">max</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cell_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cell_indices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">np</span> <span class="o">=</span> <span class="n">emac_boot_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">emac_boot_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">emac_boot_list</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">emac_boot_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
				<span class="n">k</span> <span class="o">=</span> <span class="n">cell_indices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">cell_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_indices</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">cell_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">emac_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_DESC</span> <span class="s">&quot;, version &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Init debug stuff */</span>
	<span class="n">emac_init_debug</span><span class="p">();</span>

	<span class="cm">/* Build EMAC boot list */</span>
	<span class="n">emac_make_bootlist</span><span class="p">();</span>

	<span class="cm">/* Init submodules */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mal_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">zmii_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_mal</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rgmii_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_zmii</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tah_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rgmii</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emac_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_tah</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_tah:</span>
	<span class="n">tah_exit</span><span class="p">();</span>
 <span class="nl">err_rgmii:</span>
	<span class="n">rgmii_exit</span><span class="p">();</span>
 <span class="nl">err_zmii:</span>
	<span class="n">zmii_exit</span><span class="p">();</span>
 <span class="nl">err_mal:</span>
	<span class="n">mal_exit</span><span class="p">();</span>
 <span class="nl">err:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">emac_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emac_driver</span><span class="p">);</span>

	<span class="n">tah_exit</span><span class="p">();</span>
	<span class="n">rgmii_exit</span><span class="p">();</span>
	<span class="n">zmii_exit</span><span class="p">();</span>
	<span class="n">mal_exit</span><span class="p">();</span>
	<span class="n">emac_fini_debug</span><span class="p">();</span>

	<span class="cm">/* Destroy EMAC boot list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EMAC_BOOT_LIST_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emac_boot_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">emac_boot_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">emac_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">emac_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
