<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › ibm › ehea › ehea_qmr.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ehea_qmr.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/net/ethernet/ibm/ehea/ehea_qmr.h</span>
<span class="cm"> *</span>
<span class="cm"> *  eHEA ethernet device driver for IBM eServer System p</span>
<span class="cm"> *</span>
<span class="cm"> *  (C) Copyright IBM Corp. 2006</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors:</span>
<span class="cm"> *       Christoph Raisch &lt;raisch@de.ibm.com&gt;</span>
<span class="cm"> *       Jan-Bernd Themann &lt;themann@de.ibm.com&gt;</span>
<span class="cm"> *       Thomas Klein &lt;tklein@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __EHEA_QMR_H__</span>
<span class="cp">#define __EHEA_QMR_H__</span>

<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &quot;ehea.h&quot;</span>
<span class="cp">#include &quot;ehea_hw.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * page size of ehea hardware queues</span>
<span class="cm"> */</span>

<span class="cp">#define EHEA_PAGESHIFT         12</span>
<span class="cp">#define EHEA_PAGESIZE          (1UL &lt;&lt; EHEA_PAGESHIFT)</span>
<span class="cp">#define EHEA_SECTSIZE          (1UL &lt;&lt; 24)</span>
<span class="cp">#define EHEA_PAGES_PER_SECTION (EHEA_SECTSIZE &gt;&gt; EHEA_PAGESHIFT)</span>
<span class="cp">#define EHEA_HUGEPAGESHIFT     34</span>
<span class="cp">#define EHEA_HUGEPAGE_SIZE     (1UL &lt;&lt; EHEA_HUGEPAGESHIFT)</span>
<span class="cp">#define EHEA_HUGEPAGE_PFN_MASK ((EHEA_HUGEPAGE_SIZE - 1) &gt;&gt; PAGE_SHIFT)</span>

<span class="cp">#if ((1UL &lt;&lt; SECTION_SIZE_BITS) &lt; EHEA_SECTSIZE)</span>
<span class="cp">#error eHEA module cannot work if kernel sectionsize &lt; ehea sectionsize</span>
<span class="cp">#endif</span>

<span class="cm">/* Some abbreviations used here:</span>
<span class="cm"> *</span>
<span class="cm"> * WQE  - Work Queue Entry</span>
<span class="cm"> * SWQE - Send Work Queue Entry</span>
<span class="cm"> * RWQE - Receive Work Queue Entry</span>
<span class="cm"> * CQE  - Completion Queue Entry</span>
<span class="cm"> * EQE  - Event Queue Entry</span>
<span class="cm"> * MR   - Memory Region</span>
<span class="cm"> */</span>

<span class="cm">/* Use of WR_ID field for EHEA */</span>
<span class="cp">#define EHEA_WR_ID_COUNT   EHEA_BMASK_IBM(0, 19)</span>
<span class="cp">#define EHEA_WR_ID_TYPE    EHEA_BMASK_IBM(20, 23)</span>
<span class="cp">#define EHEA_SWQE2_TYPE    0x1</span>
<span class="cp">#define EHEA_SWQE3_TYPE    0x2</span>
<span class="cp">#define EHEA_RWQE2_TYPE    0x3</span>
<span class="cp">#define EHEA_RWQE3_TYPE    0x4</span>
<span class="cp">#define EHEA_WR_ID_INDEX   EHEA_BMASK_IBM(24, 47)</span>
<span class="cp">#define EHEA_WR_ID_REFILL  EHEA_BMASK_IBM(48, 63)</span>

<span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l_key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* maximum number of sg entries allowed in a WQE */</span>
<span class="cp">#define EHEA_MAX_WQE_SG_ENTRIES  	252</span>
<span class="cp">#define SWQE2_MAX_IMM            	(0xD0 - 0x30)</span>
<span class="cp">#define SWQE3_MAX_IMM            	224</span>

<span class="cm">/* tx control flags for swqe */</span>
<span class="cp">#define EHEA_SWQE_CRC                   0x8000</span>
<span class="cp">#define EHEA_SWQE_IP_CHECKSUM           0x4000</span>
<span class="cp">#define EHEA_SWQE_TCP_CHECKSUM          0x2000</span>
<span class="cp">#define EHEA_SWQE_TSO                   0x1000</span>
<span class="cp">#define EHEA_SWQE_SIGNALLED_COMPLETION  0x0800</span>
<span class="cp">#define EHEA_SWQE_VLAN_INSERT           0x0400</span>
<span class="cp">#define EHEA_SWQE_IMM_DATA_PRESENT      0x0200</span>
<span class="cp">#define EHEA_SWQE_DESCRIPTORS_PRESENT   0x0100</span>
<span class="cp">#define EHEA_SWQE_WRAP_CTL_REC          0x0080</span>
<span class="cp">#define EHEA_SWQE_WRAP_CTL_FORCE        0x0040</span>
<span class="cp">#define EHEA_SWQE_BIND                  0x0020</span>
<span class="cp">#define EHEA_SWQE_PURGE                 0x0010</span>

<span class="cm">/* sizeof(struct ehea_swqe) less the union */</span>
<span class="cp">#define SWQE_HEADER_SIZE		32</span>

<span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">wr_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ip_start</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ip_end</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">immediate_data_length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcp_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved2b</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wrap_tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">descriptors</span><span class="p">;</span>		<span class="cm">/* number of valid descriptors in WQE */</span>
	<span class="n">u16</span> <span class="n">reserved3</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved4</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mss</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved5</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/*  Send WQE Format 1 */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">EHEA_MAX_WQE_SG_ENTRIES</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">no_immediate_data</span><span class="p">;</span>

		<span class="cm">/*  Send WQE Format 2 */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="n">sg_entry</span><span class="p">;</span>
			<span class="cm">/* 0x30 */</span>
			<span class="n">u8</span> <span class="n">immediate_data</span><span class="p">[</span><span class="n">SWQE2_MAX_IMM</span><span class="p">];</span>
			<span class="cm">/* 0xd0 */</span>
			<span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">EHEA_MAX_WQE_SG_ENTRIES</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">immdata_desc</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="cm">/*  Send WQE Format 3 */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">immediate_data</span><span class="p">[</span><span class="n">SWQE3_MAX_IMM</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">immdata_nodesc</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ehea_rwqe</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">wr_id</span><span class="p">;</span>		<span class="cm">/* work request ID */</span>
	<span class="n">u8</span> <span class="n">reserved1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">data_segments</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved2</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reserved3</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reserved4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">EHEA_MAX_WQE_SG_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define EHEA_CQE_VLAN_TAG_XTRACT   0x0400</span>

<span class="cp">#define EHEA_CQE_TYPE_RQ           0x60</span>
<span class="cp">#define EHEA_CQE_STAT_ERR_MASK     0x700F</span>
<span class="cp">#define EHEA_CQE_STAT_FAT_ERR_MASK 0xF</span>
<span class="cp">#define EHEA_CQE_BLIND_CKSUM       0x8000</span>
<span class="cp">#define EHEA_CQE_STAT_ERR_TCP      0x4000</span>
<span class="cp">#define EHEA_CQE_STAT_ERR_IP       0x2000</span>
<span class="cp">#define EHEA_CQE_STAT_ERR_CRC      0x1000</span>

<span class="cm">/* Defines which bad send cqe stati lead to a port reset */</span>
<span class="cp">#define EHEA_CQE_STAT_RESET_MASK   0x0002</span>

<span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">wr_id</span><span class="p">;</span>		<span class="cm">/* work request ID from WQE */</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">num_bytes_transfered</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">inet_checksum_value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved3</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">page_offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wqe_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qp_token</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved4</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reserved5</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define EHEA_EQE_VALID           EHEA_BMASK_IBM(0, 0)</span>
<span class="cp">#define EHEA_EQE_IS_CQE          EHEA_BMASK_IBM(1, 1)</span>
<span class="cp">#define EHEA_EQE_IDENTIFIER      EHEA_BMASK_IBM(2, 7)</span>
<span class="cp">#define EHEA_EQE_QP_CQ_NUMBER    EHEA_BMASK_IBM(8, 31)</span>
<span class="cp">#define EHEA_EQE_QP_TOKEN        EHEA_BMASK_IBM(32, 63)</span>
<span class="cp">#define EHEA_EQE_CQ_TOKEN        EHEA_BMASK_IBM(32, 63)</span>
<span class="cp">#define EHEA_EQE_KEY             EHEA_BMASK_IBM(32, 63)</span>
<span class="cp">#define EHEA_EQE_PORT_NUMBER     EHEA_BMASK_IBM(56, 63)</span>
<span class="cp">#define EHEA_EQE_EQ_NUMBER       EHEA_BMASK_IBM(48, 63)</span>
<span class="cp">#define EHEA_EQE_SM_ID           EHEA_BMASK_IBM(48, 63)</span>
<span class="cp">#define EHEA_EQE_SM_MECH_NUMBER  EHEA_BMASK_IBM(48, 55)</span>
<span class="cp">#define EHEA_EQE_SM_PORT_NUMBER  EHEA_BMASK_IBM(56, 63)</span>

<span class="cp">#define EHEA_AER_RESTYPE_QP  0x8</span>
<span class="cp">#define EHEA_AER_RESTYPE_CQ  0x4</span>
<span class="cp">#define EHEA_AER_RESTYPE_EQ  0x3</span>

<span class="cm">/* Defines which affiliated errors lead to a port reset */</span>
<span class="cp">#define EHEA_AER_RESET_MASK   0xFFFFFFFFFEFFFFFFULL</span>
<span class="cp">#define EHEA_AERR_RESET_MASK  0xFFFFFFFFFFFFFFFFULL</span>

<span class="k">struct</span> <span class="n">ehea_eqe</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ERROR_DATA_LENGTH  EHEA_BMASK_IBM(52, 63)</span>
<span class="cp">#define ERROR_DATA_TYPE    EHEA_BMASK_IBM(0, 7)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_qeit_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="n">u64</span> <span class="n">q_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_page</span> <span class="o">*</span><span class="n">current_page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q_offset</span> <span class="o">&gt;=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue_length</span><span class="p">)</span>
		<span class="n">q_offset</span> <span class="o">-=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue_length</span><span class="p">;</span>
	<span class="n">current_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue_pages</span><span class="p">)[</span><span class="n">q_offset</span> <span class="o">&gt;&gt;</span> <span class="n">EHEA_PAGESHIFT</span><span class="p">];</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">current_page</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">q_offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EHEA_PAGESIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_qeit_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_qeit_calc</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hw_qeit_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span> <span class="o">+=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">qe_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span> <span class="o">&gt;=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* toggle the valid flag */</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">toggle_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">toggle_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_qeit_get_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">retvalue</span> <span class="o">=</span> <span class="n">hw_qeit_get</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">hw_qeit_inc</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_qeit_get_inc_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">retvalue</span> <span class="o">=</span> <span class="n">hw_qeit_get</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">retvalue</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pref</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">valid</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">toggle_state</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this is a good one */</span>
		<span class="n">hw_qeit_inc</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">pref</span> <span class="o">=</span> <span class="n">hw_qeit_calc</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_qeit_get_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">retvalue</span> <span class="o">=</span> <span class="n">hw_qeit_get</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pref</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid</span><span class="p">;</span>

	<span class="n">pref</span> <span class="o">=</span> <span class="n">hw_qeit_calc</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span><span class="p">);</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span><span class="p">);</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">valid</span> <span class="o">=</span> <span class="n">retvalue</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">valid</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">toggle_state</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_qeit_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hw_qeit_get</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_qeit_eq_get_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">last_entry_in_q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue_length</span> <span class="o">-</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">qe_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">retvalue</span><span class="p">;</span>

	<span class="n">retvalue</span> <span class="o">=</span> <span class="n">hw_qeit_get</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span> <span class="o">+=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">qe_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span> <span class="o">&gt;</span> <span class="n">last_entry_in_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">toggle_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">toggle_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hw_eqit_eq_get_inc_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">retvalue</span> <span class="o">=</span> <span class="n">hw_qeit_get</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">qe</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">retvalue</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">qe</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">toggle_state</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">hw_qeit_eq_get_inc</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ehea_rwqe</span> <span class="o">*</span><span class="nf">ehea_get_next_rwqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="n">rq_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">hw_rqueue1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq_nr</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">hw_rqueue2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">hw_rqueue3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw_qeit_get_inc</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="nf">ehea_get_swqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">my_qp</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="o">*</span><span class="n">wqe_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">hw_squeue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">wqe_p</span><span class="p">;</span>

	<span class="o">*</span><span class="n">wqe_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">EHEA_SG_SQ</span><span class="p">);</span>
	<span class="n">wqe_p</span> <span class="o">=</span> <span class="n">hw_qeit_get_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_qp</span><span class="o">-&gt;</span><span class="n">hw_squeue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wqe_p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ehea_post_swqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">my_qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iosync</span><span class="p">();</span>
	<span class="n">ehea_update_sqa</span><span class="p">(</span><span class="n">my_qp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="nf">ehea_poll_rq1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">wqe_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">hw_rqueue1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">wqe_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">current_q_offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">EHEA_SG_RQ1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hw_qeit_get_valid</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ehea_inc_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_qeit_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ehea_inc_rq1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_qeit_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">hw_rqueue1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="nf">ehea_poll_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_cq</span> <span class="o">*</span><span class="n">my_cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_qeit_get_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_cq</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define EHEA_CQ_REGISTER_ORIG 0</span>
<span class="cp">#define EHEA_EQ_REGISTER_ORIG 0</span>

<span class="k">enum</span> <span class="n">ehea_eq_type</span> <span class="p">{</span>
	<span class="n">EHEA_EQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* event queue              */</span>
	<span class="n">EHEA_NEQ</span>		<span class="cm">/* notification event queue */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ehea_eq</span> <span class="o">*</span><span class="n">ehea_create_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">ehea_eq_type</span> <span class="n">type</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">eqe_gen</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ehea_destroy_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ehea_eqe</span> <span class="o">*</span><span class="n">ehea_poll_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ehea_cq</span> <span class="o">*</span><span class="n">ehea_create_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cqe</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">eq_handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cq_token</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ehea_destroy_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">ehea_create_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ehea_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ehea_destroy_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ehea_reg_kernel_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ehea_gen_smr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_mr</span> <span class="o">*</span><span class="n">old_mr</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ehea_mr</span> <span class="o">*</span><span class="n">shared_mr</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ehea_rem_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">);</span>

<span class="n">u64</span> <span class="n">ehea_error_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="n">res_handle</span><span class="p">,</span>
		    <span class="n">u64</span> <span class="o">*</span><span class="n">aer</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">aerr</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ehea_add_sect_bmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ehea_rem_sect_bmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ehea_create_busmap</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ehea_destroy_busmap</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u64</span> <span class="n">ehea_map_vaddr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">caddr</span><span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* __EHEA_QMR_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
