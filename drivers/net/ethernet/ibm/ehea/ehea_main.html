<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › ibm › ehea › ehea_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ehea_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/net/ethernet/ibm/ehea/ehea_main.c</span>
<span class="cm"> *</span>
<span class="cm"> *  eHEA ethernet device driver for IBM eServer System p</span>
<span class="cm"> *</span>
<span class="cm"> *  (C) Copyright IBM Corp. 2006</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors:</span>
<span class="cm"> *	 Christoph Raisch &lt;raisch@de.ibm.com&gt;</span>
<span class="cm"> *	 Jan-Bernd Themann &lt;themann@de.ibm.com&gt;</span>
<span class="cm"> *	 Thomas Klein &lt;tklein@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/memory.h&gt;</span>
<span class="cp">#include &lt;asm/kexec.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;net/ip.h&gt;</span>

<span class="cp">#include &quot;ehea.h&quot;</span>
<span class="cp">#include &quot;ehea_qmr.h&quot;</span>
<span class="cp">#include &quot;ehea_phyp.h&quot;</span>


<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Christoph Raisch &lt;raisch@de.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IBM eServer HEA Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">msg_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rq1_entries</span> <span class="o">=</span> <span class="n">EHEA_DEF_ENTRIES_RQ1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rq2_entries</span> <span class="o">=</span> <span class="n">EHEA_DEF_ENTRIES_RQ2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rq3_entries</span> <span class="o">=</span> <span class="n">EHEA_DEF_ENTRIES_RQ3</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sq_entries</span> <span class="o">=</span> <span class="n">EHEA_DEF_ENTRIES_SQ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_mcs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prop_carrier_state</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">msg_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rq1_entries</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rq2_entries</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rq3_entries</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sq_entries</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">prop_carrier_state</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_mcs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msg_level</span><span class="p">,</span> <span class="s">&quot;msg_level&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">prop_carrier_state</span><span class="p">,</span> <span class="s">&quot;Propagate carrier state of physical &quot;</span>
		 <span class="s">&quot;port to stack. 1:yes, 0:no.  Default = 0 &quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rq3_entries</span><span class="p">,</span> <span class="s">&quot;Number of entries for Receive Queue 3 &quot;</span>
		 <span class="s">&quot;[2^x - 1], x = [6..14]. Default = &quot;</span>
		 <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">EHEA_DEF_ENTRIES_RQ3</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rq2_entries</span><span class="p">,</span> <span class="s">&quot;Number of entries for Receive Queue 2 &quot;</span>
		 <span class="s">&quot;[2^x - 1], x = [6..14]. Default = &quot;</span>
		 <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">EHEA_DEF_ENTRIES_RQ2</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rq1_entries</span><span class="p">,</span> <span class="s">&quot;Number of entries for Receive Queue 1 &quot;</span>
		 <span class="s">&quot;[2^x - 1], x = [6..14]. Default = &quot;</span>
		 <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">EHEA_DEF_ENTRIES_RQ1</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sq_entries</span><span class="p">,</span> <span class="s">&quot; Number of entries for the Send Queue  &quot;</span>
		 <span class="s">&quot;[2^x - 1], x = [6..14]. Default = &quot;</span>
		 <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">EHEA_DEF_ENTRIES_SQ</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_mcs</span><span class="p">,</span> <span class="s">&quot; Multiple receive queues, 1: enable, 0: disable, &quot;</span>
		 <span class="s">&quot;Default = 1&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">port_name_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">adapter_list</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ehea_driver_flags</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dlpar_mem_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ehea_fw_handle_array</span> <span class="n">ehea_fw_handles</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ehea_bcmc_reg_array</span> <span class="n">ehea_bcmc_regs</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">ehea_probe_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="n">ehea_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">ehea_device_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lhea&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;IBM,lhea&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">ehea_device_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_platform_driver</span> <span class="n">ehea_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ehea&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">ehea_device_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ehea_probe_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ehea_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ehea_dump</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">adr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">deb</span> <span class="o">=</span> <span class="n">adr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">x</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s adr=%p ofs=%04x %016llx %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg</span><span class="p">,</span> <span class="n">deb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">deb</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">*</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">deb</span><span class="p">[</span><span class="mi">8</span><span class="p">]));</span>
		<span class="n">deb</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_schedule_port_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__EHEA_DISABLE_PORT_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_update_firmware_handles</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_fw_handle_entry</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_portres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_fw_handles</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/* Determine number of handles */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_adapters</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EHEA_PORT_UP</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">num_ports</span><span class="o">++</span><span class="p">;</span>
			<span class="n">num_portres</span> <span class="o">+=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">num_fw_handles</span> <span class="o">=</span> <span class="n">num_adapters</span> <span class="o">*</span> <span class="n">EHEA_NUM_ADAPTER_FW_HANDLES</span> <span class="o">+</span>
			 <span class="n">num_ports</span> <span class="o">*</span> <span class="n">EHEA_NUM_PORT_FW_HANDLES</span> <span class="o">+</span>
			 <span class="n">num_portres</span> <span class="o">*</span> <span class="n">EHEA_NUM_PORTRES_FW_HANDLES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_fw_handles</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num_fw_handles</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>  <span class="cm">/* Keep the existing array */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">out_update</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_adapters</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EHEA_PORT_UP</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>

				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_mr</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_mr</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
			<span class="n">num_ports</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">fwh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">num_adapters</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_update:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">;</span>
	<span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_update_bcmc_registrations</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_bcmc_reg_entry</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_mc_list</span> <span class="o">*</span><span class="n">mc_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_registrations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Determine number of registrations */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EHEA_PORT_UP</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">num_registrations</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Broadcast registrations */</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span><span class="n">list</span><span class="p">)</span>
				<span class="n">num_registrations</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_registrations</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num_registrations</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>  <span class="cm">/* Keep the existing array */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">out_update</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EHEA_PORT_UP</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">num_registrations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_update</span><span class="p">;</span>

			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_BROADCAST</span> <span class="o">|</span>
					  <span class="n">EHEA_BCMC_UNTAGGED</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">macaddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">;</span>

			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_BROADCAST</span> <span class="o">|</span>
					  <span class="n">EHEA_BCMC_VLANID_ALL</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">macaddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">;</span>
			<span class="n">num_registrations</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mc_entry</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">num_registrations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out_update</span><span class="p">;</span>

				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_MULTICAST</span> <span class="o">|</span>
						  <span class="n">EHEA_BCMC_UNTAGGED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mc_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_type</span> <span class="o">|=</span> <span class="n">EHEA_BCMC_SCOPE_ALL</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">macaddr</span> <span class="o">=</span> <span class="n">mc_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>

				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_MULTICAST</span> <span class="o">|</span>
						  <span class="n">EHEA_BCMC_VLANID_ALL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mc_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_type</span> <span class="o">|=</span> <span class="n">EHEA_BCMC_SCOPE_ALL</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">macaddr</span> <span class="o">=</span> <span class="n">mc_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
				<span class="n">num_registrations</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out_update:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">;</span>
	<span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="nf">ehea_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">rx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_packets</span><span class="p">;</span>
		<span class="n">rx_bytes</span>   <span class="o">+=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_packets</span><span class="p">;</span>
		<span class="n">tx_bytes</span>   <span class="o">+=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">rx_packets</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port</span><span class="p">,</span> <span class="n">stats_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb2</span> <span class="o">*</span><span class="n">cb2</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>

	<span class="n">cb2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No mem for cb2. Some interface statistics were not updated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">resched</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				      <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				      <span class="n">H_PORT_CB2</span><span class="p">,</span> <span class="n">H_PORT_CB2_ALL</span><span class="p">,</span> <span class="n">cb2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;query_ehea_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_herr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">ehea_dump</span><span class="p">(</span><span class="n">cb2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cb2</span><span class="p">),</span> <span class="s">&quot;net_device_stats&quot;</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">cb2</span><span class="o">-&gt;</span><span class="n">rxmcp</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">cb2</span><span class="o">-&gt;</span><span class="n">rxuerr</span><span class="p">;</span>

<span class="nl">out_herr:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb2</span><span class="p">);</span>
<span class="nl">resched:</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats_work</span><span class="p">,</span>
			      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_refill_rq1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_of_wqes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_arr_rq1</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_index_mask</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fill_wqes</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">os_skbs</span> <span class="o">+</span> <span class="n">nr_of_wqes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__EHEA_STOP_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehea_driver_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_of_wqes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="n">fill_wqes</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fill_wqes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_arr_rq1</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">skb_arr_rq1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							      <span class="n">EHEA_L_PKT_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_arr_rq1</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to allocate enough skb in the array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="n">fill_wqes</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">index</span><span class="o">--</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">&amp;=</span> <span class="n">max_index_mask</span><span class="p">;</span>
		<span class="n">adder</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Ring doorbell */</span>
	<span class="n">ehea_update_rq1a</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">adder</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_init_fill_rq1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_rq1a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_arr_rq1</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_rq1a</span> <span class="o">&gt;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NR_RQ1A bigger than skb array len</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_rq1a</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_arr_rq1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EHEA_L_PKT_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_arr_rq1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough memory to allocate skb array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Ring doorbell */</span>
	<span class="n">ehea_update_rq1a</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_refill_rq_def</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ehea_q_skb_arr</span> <span class="o">*</span><span class="n">q_skba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rq_nr</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">num_wqes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wqe_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_arr</span> <span class="o">=</span> <span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_rwqe</span> <span class="o">*</span><span class="n">rwqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">max_index_mask</span><span class="p">,</span> <span class="n">fill_wqes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fill_wqes</span> <span class="o">=</span> <span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">os_skbs</span> <span class="o">+</span> <span class="n">num_wqes</span><span class="p">;</span>
	<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__EHEA_STOP_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehea_driver_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="n">fill_wqes</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">max_index_mask</span> <span class="o">=</span> <span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fill_wqes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp_addr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="n">fill_wqes</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">os_skbs</span> <span class="o">==</span> <span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
					    <span class="s">&quot;rq%i ran dry - no mem for skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">rq_nr</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">tmp_addr</span> <span class="o">=</span> <span class="n">ehea_map_vaddr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_addr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="n">fill_wqes</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rwqe</span> <span class="o">=</span> <span class="n">ehea_get_next_rwqe</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">rq_nr</span><span class="p">);</span>
		<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_TYPE</span><span class="p">,</span> <span class="n">wqe_type</span><span class="p">)</span>
			    <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_INDEX</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">l_key</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
		<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">tmp_addr</span><span class="p">;</span>
		<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">packet_size</span><span class="p">;</span>
		<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">data_segments</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">&amp;=</span> <span class="n">max_index_mask</span><span class="p">;</span>
		<span class="n">adder</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Ring doorbell */</span>
	<span class="n">iosync</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_nr</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ehea_update_rq2a</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">adder</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ehea_update_rq3a</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">adder</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_refill_rq2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_of_wqes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ehea_refill_rq_def</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				  <span class="n">nr_of_wqes</span><span class="p">,</span> <span class="n">EHEA_RWQE2_TYPE</span><span class="p">,</span>
				  <span class="n">EHEA_RQ2_PKT_SIZE</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_refill_rq3</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_of_wqes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ehea_refill_rq_def</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				  <span class="n">nr_of_wqes</span><span class="p">,</span> <span class="n">EHEA_RWQE3_TYPE</span><span class="p">,</span>
				  <span class="n">EHEA_MAX_PACKET_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ehea_check_cqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">rq_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_TYPE_RQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_ERR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_ERR_TCP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">header_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ehea_fill_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">num_bytes_transfered</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/*remove CRC */</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* The packet was not an IPV4 packet so a complemented checksum was</span>
<span class="cm">	   calculated. The value is found in the Internet Checksum field. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_BLIND_CKSUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_unfold</span><span class="p">(</span><span class="o">~</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">inet_checksum_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>

	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">get_skb_by_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_array</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">arr_len</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">skb_index</span> <span class="o">=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">EHEA_WR_ID_INDEX</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">skb_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arr_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pref</span> <span class="o">=</span> <span class="n">skb_array</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">pref</span><span class="p">);</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="n">EHEA_CACHE_LINE</span><span class="p">);</span>

		<span class="n">pref</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_array</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="n">EHEA_CACHE_LINE</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="n">EHEA_CACHE_LINE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="n">EHEA_CACHE_LINE</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_array</span><span class="p">[</span><span class="n">skb_index</span><span class="p">];</span>
	<span class="n">skb_array</span><span class="p">[</span><span class="n">skb_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">get_skb_by_index_ll</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_array</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">arr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wqe_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">wqe_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arr_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pref</span> <span class="o">=</span> <span class="n">skb_array</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">pref</span><span class="p">);</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="n">EHEA_CACHE_LINE</span><span class="p">);</span>

		<span class="n">pref</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_array</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">pref</span><span class="p">);</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">pref</span> <span class="o">+</span> <span class="n">EHEA_CACHE_LINE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_array</span><span class="p">[</span><span class="n">wqe_index</span><span class="p">];</span>
	<span class="n">skb_array</span><span class="p">[</span><span class="n">wqe_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_treat_poll_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rq</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">processed_rq2</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">processed_rq3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_ERR_TCP</span><span class="p">)</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">p_stats</span><span class="p">.</span><span class="n">err_tcp_cksum</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_ERR_IP</span><span class="p">)</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">p_stats</span><span class="p">.</span><span class="n">err_ip_cksum</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_ERR_CRC</span><span class="p">)</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">p_stats</span><span class="p">.</span><span class="n">err_frame_crc</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">processed_rq2</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb_by_index</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">processed_rq3</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb_by_index</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_FAT_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Critical receive error for QP %d. Resetting port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">init_attr</span><span class="p">.</span><span class="n">qp_nr</span><span class="p">);</span>
			<span class="n">ehea_dump</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">),</span> <span class="s">&quot;CQE&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ehea_schedule_port_reset</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_proc_rwqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_arr_rq1</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_arr_rq2</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_arr_rq3</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_arr_rq1_len</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_arr_rq2_len</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_arr_rq3_len</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">processed</span><span class="p">,</span> <span class="n">processed_rq1</span><span class="p">,</span> <span class="n">processed_rq2</span><span class="p">,</span> <span class="n">processed_rq3</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">processed_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wqe_index</span><span class="p">,</span> <span class="n">last_wqe_index</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">port_reset</span><span class="p">;</span>

	<span class="n">processed</span> <span class="o">=</span> <span class="n">processed_rq1</span> <span class="o">=</span> <span class="n">processed_rq2</span> <span class="o">=</span> <span class="n">processed_rq3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">last_wqe_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cqe</span> <span class="o">=</span> <span class="n">ehea_poll_rq1</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe_index</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">processed</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehea_inc_rq1</span><span class="p">(</span><span class="n">qp</span><span class="p">);</span>
		<span class="n">processed_rq1</span><span class="o">++</span><span class="p">;</span>
		<span class="n">processed</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
			<span class="n">ehea_dump</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">),</span> <span class="s">&quot;CQE&quot;</span><span class="p">);</span>

		<span class="n">last_wqe_index</span> <span class="o">=</span> <span class="n">wqe_index</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehea_check_cqe</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rq</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* LL RQ1 */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb_by_index_ll</span><span class="p">(</span><span class="n">skb_arr_rq1</span><span class="p">,</span>
							  <span class="n">skb_arr_rq1_len</span><span class="p">,</span>
							  <span class="n">wqe_index</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						  <span class="s">&quot;LL rq1: skb=NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							       <span class="n">EHEA_L_PKT_SIZE</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough memory to allocate skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">)</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
						 <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">num_bytes_transfered</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">ehea_fill_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cqe</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RQ2 */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb_by_index</span><span class="p">(</span><span class="n">skb_arr_rq2</span><span class="p">,</span>
						       <span class="n">skb_arr_rq2_len</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">netif_err</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						  <span class="s">&quot;rq2: skb=NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ehea_fill_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cqe</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
				<span class="n">processed_rq2</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* RQ3 */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">get_skb_by_index</span><span class="p">(</span><span class="n">skb_arr_rq3</span><span class="p">,</span>
						       <span class="n">skb_arr_rq3_len</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">netif_err</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						  <span class="s">&quot;rq3: skb=NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ehea_fill_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cqe</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
				<span class="n">processed_rq3</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">processed_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_VLAN_TAG_XTRACT</span><span class="p">)</span>
				<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>

			<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">p_stats</span><span class="p">.</span><span class="n">poll_receive_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">port_reset</span> <span class="o">=</span> <span class="n">ehea_treat_poll_error</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">cqe</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">processed_rq2</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">processed_rq3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_reset</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">ehea_poll_rq1</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">processed</span><span class="p">;</span>
	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">processed_bytes</span><span class="p">;</span>

	<span class="n">ehea_refill_rq1</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">last_wqe_index</span><span class="p">,</span> <span class="n">processed_rq1</span><span class="p">);</span>
	<span class="n">ehea_refill_rq2</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">processed_rq2</span><span class="p">);</span>
	<span class="n">ehea_refill_rq3</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">processed_rq3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SWQE_RESTART_CHECK 0xdeadbeaff00d0000ull</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_sq_restart_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_restart_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">restart_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_sqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">swqe_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">swqe</span> <span class="o">=</span> <span class="n">ehea_get_swqe</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swqe_index</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">swqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SWQE_HEADER_SIZE</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">);</span>

		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_PURGE</span><span class="p">;</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">SWQE_RESTART_CHECK</span><span class="p">;</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_SIGNALLED_COMPLETION</span><span class="p">;</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_IMM_DATA_PRESENT</span><span class="p">;</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">immediate_data_length</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>

		<span class="n">ehea_post_swqe</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">swqe</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">restart_wq</span><span class="p">,</span>
					 <span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_restart_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;HW/SW queues out of sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ehea_schedule_port_reset</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="nf">ehea_proc_cqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">my_quota</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cq</span> <span class="o">*</span><span class="n">send_cq</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quota</span> <span class="o">=</span> <span class="n">my_quota</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cqe_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">swqe_av</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
						<span class="n">pr</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">cqe</span> <span class="o">=</span> <span class="n">ehea_poll_cq</span><span class="p">(</span><span class="n">send_cq</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cqe</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">quota</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehea_inc_cq</span><span class="p">(</span><span class="n">send_cq</span><span class="p">);</span>

		<span class="n">cqe_counter</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">==</span> <span class="n">SWQE_RESTART_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_restart_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">swqe_av</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Bad send completion status=0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
				<span class="n">ehea_dump</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">),</span> <span class="s">&quot;Send CQE&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EHEA_CQE_STAT_RESET_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Resetting port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ehea_schedule_port_reset</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_done</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
			<span class="n">ehea_dump</span><span class="p">(</span><span class="n">cqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqe</span><span class="p">),</span> <span class="s">&quot;CQE&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">EHEA_WR_ID_TYPE</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">)</span>
			   <span class="o">==</span> <span class="n">EHEA_SWQE2_TYPE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">index</span> <span class="o">=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">EHEA_WR_ID_INDEX</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">swqe_av</span> <span class="o">+=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">EHEA_WR_ID_REFILL</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">);</span>
		<span class="n">quota</span><span class="o">--</span><span class="p">;</span>

		<span class="n">cqe</span> <span class="o">=</span> <span class="n">ehea_poll_cq</span><span class="p">(</span><span class="n">send_cq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ehea_update_feca</span><span class="p">(</span><span class="n">send_cq</span><span class="p">,</span> <span class="n">cqe_counter</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">swqe_av</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_refill_th</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_refill_th</span><span class="p">))</span>
			<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">swqe_avail_wq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cqe</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EHEA_POLL_MAX_CQES 65535</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port_res</span><span class="p">,</span>
						<span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cqe</span> <span class="o">*</span><span class="n">cqe_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wqe_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cqe_skb</span> <span class="o">=</span> <span class="n">ehea_proc_cqes</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">EHEA_POLL_MAX_CQES</span><span class="p">);</span>
	<span class="n">rx</span> <span class="o">+=</span> <span class="n">ehea_proc_rwqes</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">rx</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rx</span> <span class="o">!=</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">ehea_reset_cq_ep</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>
		<span class="n">ehea_reset_cq_ep</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>
		<span class="n">ehea_reset_cq_n1</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>
		<span class="n">ehea_reset_cq_n1</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">cqe</span> <span class="o">=</span> <span class="n">ehea_poll_rq1</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe_index</span><span class="p">);</span>
		<span class="n">cqe_skb</span> <span class="o">=</span> <span class="n">ehea_poll_cq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqe</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cqe_skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">napi_reschedule</span><span class="p">(</span><span class="n">napi</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">rx</span><span class="p">;</span>

		<span class="n">cqe_skb</span> <span class="o">=</span> <span class="n">ehea_proc_cqes</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">EHEA_POLL_MAX_CQES</span><span class="p">);</span>
		<span class="n">rx</span> <span class="o">+=</span> <span class="n">ehea_proc_rwqes</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">rx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ehea_recv_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ehea_qp_aff_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_eqe</span> <span class="o">*</span><span class="n">eqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qp_token</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">aer</span><span class="p">,</span> <span class="n">aerr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">eqe</span> <span class="o">=</span> <span class="n">ehea_poll_eq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qp_token</span> <span class="o">=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">EHEA_EQE_QP_TOKEN</span><span class="p">,</span> <span class="n">eqe</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;QP aff_err: entry=0x%llx, token=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">eqe</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="n">qp_token</span><span class="p">);</span>

		<span class="n">qp</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">qp_token</span><span class="p">].</span><span class="n">qp</span><span class="p">;</span>

		<span class="n">resource_type</span> <span class="o">=</span> <span class="n">ehea_error_data</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">aer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aerr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">resource_type</span> <span class="o">==</span> <span class="n">EHEA_AER_RESTYPE_QP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">aer</span> <span class="o">&amp;</span> <span class="n">EHEA_AER_RESET_MASK</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">aerr</span> <span class="o">&amp;</span> <span class="n">EHEA_AERR_RESET_MASK</span><span class="p">))</span>
				 <span class="n">reset_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">reset_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* Reset in case of CQ or EQ error */</span>

		<span class="n">eqe</span> <span class="o">=</span> <span class="n">ehea_poll_eq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Resetting port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ehea_schedule_port_reset</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="nf">ehea_get_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">logical_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">logical_port_id</span> <span class="o">==</span> <span class="n">logical_port</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehea_sense_port_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb0</span> <span class="o">*</span><span class="n">cb0</span><span class="p">;</span>

	<span class="cm">/* may be called via ehea_neq_tasklet() */</span>
	<span class="n">cb0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for cb0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				      <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span> <span class="n">H_PORT_CB0</span><span class="p">,</span>
				      <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_PORT_CB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span>
				      <span class="n">cb0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MAC address */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">cb0</span><span class="o">-&gt;</span><span class="n">port_mac_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Port speed */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cb0</span><span class="o">-&gt;</span><span class="n">port_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">H_SPEED_10M_H</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_10M</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H_SPEED_10M_F</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_10M</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H_SPEED_100M_H</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_100M</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H_SPEED_100M_F</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_100M</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H_SPEED_1G_F</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_1G</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H_SPEED_10G_F</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_10G</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">num_mcs</span> <span class="o">=</span> <span class="n">cb0</span><span class="o">-&gt;</span><span class="n">num_default_qps</span><span class="p">;</span>

	<span class="cm">/* Number of default QPs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_mcs</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span> <span class="o">=</span> <span class="n">cb0</span><span class="o">-&gt;</span><span class="n">num_default_qps</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">ehea_dump</span><span class="p">(</span><span class="n">cb0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cb0</span><span class="p">),</span> <span class="s">&quot;ehea_sense_port_attr&quot;</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ehea_set_portspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb4</span> <span class="o">*</span><span class="n">cb4</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cb4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for cb4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb4</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">port_speed</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				       <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				       <span class="n">H_PORT_CB4</span><span class="p">,</span> <span class="n">H_PORT_CB4_SPEED</span><span class="p">,</span> <span class="n">cb4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">==</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">port_speed</span> <span class="o">==</span> <span class="n">EHEA_SPEED_AUTONEG</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
					      <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
					      <span class="n">H_PORT_CB4</span><span class="p">,</span> <span class="n">H_PORT_CB4_SPEED</span><span class="p">,</span>
					      <span class="n">cb4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">==</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cb4</span><span class="o">-&gt;</span><span class="n">port_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">H_SPEED_10M_H</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_10M</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">H_SPEED_10M_F</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_10M</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">H_SPEED_100M_H</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_100M</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">H_SPEED_100M_F</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_100M</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">H_SPEED_1G_F</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_1G</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">H_SPEED_10G_F</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">EHEA_SPEED_10G</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed sensing port speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">==</span> <span class="n">H_AUTHORITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Hypervisor denied setting port speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed setting port speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop_carrier_state</span> <span class="o">||</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">phy_link</span> <span class="o">==</span> <span class="n">EHEA_PHY_LINK_UP</span><span class="p">))</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb4</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_parse_eqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="n">eqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ec</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ec</span> <span class="o">=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">NEQE_EVENT_CODE</span><span class="p">,</span> <span class="n">eqe</span><span class="p">);</span>
	<span class="n">portnum</span> <span class="o">=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">NEQE_PORTNUM</span><span class="p">,</span> <span class="n">eqe</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">ehea_get_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">portnum</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EHEA_EC_PORTSTATE_CHG</span>:	<span class="cm">/* port state change */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown portnum %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portnum</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">NEQE_PORT_UP</span><span class="p">,</span> <span class="n">eqe</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_sense_port_attr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed resensing port attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;Logical port up: %dMbps %s Duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_speed</span><span class="p">,</span>
					   <span class="n">port</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
					   <span class="s">&quot;Full&quot;</span> <span class="o">:</span> <span class="s">&quot;Half&quot;</span><span class="p">);</span>

				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;Logical port down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">NEQE_EXTSWITCH_PORT_UP</span><span class="p">,</span> <span class="n">eqe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">phy_link</span> <span class="o">=</span> <span class="n">EHEA_PHY_LINK_UP</span><span class="p">;</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;Physical port up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop_carrier_state</span><span class="p">)</span>
				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">phy_link</span> <span class="o">=</span> <span class="n">EHEA_PHY_LINK_DOWN</span><span class="p">;</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;Physical port down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop_carrier_state</span><span class="p">)</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">NEQE_EXTSWITCH_PRIMARY</span><span class="p">,</span> <span class="n">eqe</span><span class="p">))</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;External switch port is primary port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;External switch port is backup port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHEA_EC_ADAPTER_MALFUNC</span>:
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adapter malfunction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHEA_EC_PORT_MALFUNC</span>:
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port malfunction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown event code %x, eqe=0x%llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">eqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_neq_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_eqe</span> <span class="o">*</span><span class="n">eqe</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">event_mask</span><span class="p">;</span>

	<span class="n">eqe</span> <span class="o">=</span> <span class="n">ehea_poll_eq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;eqe=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eqe</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;*eqe=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">eqe</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">ehea_parse_eqe</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqe</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">eqe</span> <span class="o">=</span> <span class="n">ehea_poll_eq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;next eqe=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eqe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">event_mask</span> <span class="o">=</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">NELR_PORTSTATE_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		   <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">NELR_ADAPTER_MALFUNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		   <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">NELR_PORT_MALFUNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ehea_h_reset_events</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span> <span class="n">event_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ehea_interrupt_neq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq_tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_fill_port_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">init_attr</span><span class="p">;</span>

	<span class="n">ehea_init_fill_rq1</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_refill_rq2</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">ehea_refill_rq3</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_reg_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>


	<span class="n">snprintf</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">int_aff_name</span><span class="p">,</span> <span class="n">EHEA_IRQ_NAME_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s-aff&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ibmebus_request_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span>
				  <span class="n">ehea_qp_aff_irq_handler</span><span class="p">,</span>
				  <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">int_aff_name</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed registering irq for qp_aff_irq_handler:ist=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_qpeq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;irq_handle 0x%X for function qp_aff_irq_handler registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">);</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">int_send_name</span><span class="p">,</span> <span class="n">EHEA_IRQ_NAME_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="s">&quot;%s-queue%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ibmebus_request_irq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span>
					  <span class="n">ehea_recv_irq_handler</span><span class="p">,</span>
					  <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">int_send_name</span><span class="p">,</span>
					  <span class="n">pr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed registering irq for ehea_queue port_res_nr:%d, ist=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">i</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_req</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;irq_handle 0x%X for function ehea_queue_int %d registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>


<span class="nl">out_free_req:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ist</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">;</span>
		<span class="n">ibmebus_free_irq</span><span class="p">(</span><span class="n">ist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

<span class="nl">out_free_qpeq:</span>
	<span class="n">ibmebus_free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_free_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* send */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ibmebus_free_irq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;free send irq for res %d with handle 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* associated events */</span>
	<span class="n">ibmebus_free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;associated event interrupt for handle 0x%X freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_configure_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb0</span> <span class="o">*</span><span class="n">cb0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cb0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">port_rc</span> <span class="o">=</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">PXLY_RC_VALID</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		     <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">PXLY_RC_IP_CHKSUM</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		     <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">PXLY_RC_TCP_UDP_CHKSUM</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		     <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">PXLY_RC_VLAN_XTRACT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		     <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">PXLY_RC_VLAN_TAG_FILTER</span><span class="p">,</span>
				      <span class="n">PXLY_RC_VLAN_FILTER</span><span class="p">)</span>
		     <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">PXLY_RC_JUMBO_FRAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_mcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_mcs</span><span class="p">)</span>
			<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">default_qpn_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">init_attr</span><span class="p">.</span><span class="n">qp_nr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">default_qpn_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">init_attr</span><span class="p">.</span><span class="n">qp_nr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">ehea_dump</span><span class="p">(</span><span class="n">cb0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cb0</span><span class="p">),</span> <span class="s">&quot;ehea_configure_port&quot;</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_PORT_CB0_PRC</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	     <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_PORT_CB0_DEFQPNARRAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				       <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				       <span class="n">H_PORT_CB0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cb0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_gen_smrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_gen_smr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_mr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_gen_smr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_mr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">ehea_rem_mr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_mr</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Generating SMRS failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_rem_smrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ehea_rem_mr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_mr</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ehea_rem_mr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_mr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_init_q_skba</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_q_skb_arr</span> <span class="o">*</span><span class="n">q_skba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_q_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">arr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_q_entries</span><span class="p">;</span>

	<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">arr</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">arr_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">max_q_entries</span><span class="p">;</span>
	<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">q_skba</span><span class="o">-&gt;</span><span class="n">os_skbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_init_port_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">port_res_cfg</span> <span class="o">*</span><span class="n">pr_cfg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue_token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ehea_eq_type</span> <span class="n">eq_type</span> <span class="o">=</span> <span class="n">EHEA_EQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_bytes</span><span class="p">,</span> <span class="n">rx_bytes</span><span class="p">,</span> <span class="n">tx_packets</span><span class="p">,</span> <span class="n">rx_packets</span><span class="p">;</span>

	<span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">tx_packets</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">rx_packets</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port_res</span><span class="p">));</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">rx_packets</span><span class="p">;</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span> <span class="o">=</span> <span class="n">ehea_create_eq</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eq_type</span><span class="p">,</span> <span class="n">EHEA_MAX_ENTRIES_EQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;create_eq failed (eq)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span> <span class="o">=</span> <span class="n">ehea_create_cq</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pr_cfg</span><span class="o">-&gt;</span><span class="n">max_entries_rcq</span><span class="p">,</span>
				     <span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				     <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;create_cq failed (cq_recv)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span> <span class="o">=</span> <span class="n">ehea_create_cq</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pr_cfg</span><span class="o">-&gt;</span><span class="n">max_entries_scq</span><span class="p">,</span>
				     <span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				     <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;create_cq failed (cq_send)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Send CQ: act_nr_cqes=%d, Recv CQ: act_nr_cqes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">act_nr_of_cqes</span><span class="p">,</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">act_nr_of_cqes</span><span class="p">);</span>

	<span class="n">init_attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">init_attr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for ehea_qp_init_attr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">low_lat_rq1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">signalingtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* generate CQE if specified in WQE */</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">rq_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">qp_token</span> <span class="o">=</span> <span class="n">queue_token</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">max_nr_send_wqes</span> <span class="o">=</span> <span class="n">pr_cfg</span><span class="o">-&gt;</span><span class="n">max_entries_sq</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">max_nr_rwqes_rq1</span> <span class="o">=</span> <span class="n">pr_cfg</span><span class="o">-&gt;</span><span class="n">max_entries_rq1</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">max_nr_rwqes_rq2</span> <span class="o">=</span> <span class="n">pr_cfg</span><span class="o">-&gt;</span><span class="n">max_entries_rq2</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">max_nr_rwqes_rq3</span> <span class="o">=</span> <span class="n">pr_cfg</span><span class="o">-&gt;</span><span class="n">max_entries_rq3</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">wqe_size_enc_sq</span> <span class="o">=</span> <span class="n">EHEA_SG_SQ</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">wqe_size_enc_rq1</span> <span class="o">=</span> <span class="n">EHEA_SG_RQ1</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">wqe_size_enc_rq2</span> <span class="o">=</span> <span class="n">EHEA_SG_RQ2</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">wqe_size_enc_rq3</span> <span class="o">=</span> <span class="n">EHEA_SG_RQ3</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">rq2_threshold</span> <span class="o">=</span> <span class="n">EHEA_RQ2_THRESHOLD</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">rq3_threshold</span> <span class="o">=</span> <span class="n">EHEA_RQ3_THRESHOLD</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">port_nr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">send_cq_handle</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">recv_cq_handle</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
	<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">aff_eq_handle</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="n">ehea_create_qp</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="n">init_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;create_qp failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;QP: qp_nr=%d</span><span class="se">\n</span><span class="s"> act_nr_snd_wqe=%d</span><span class="se">\n</span><span class="s"> nr_rwqe_rq1=%d</span><span class="se">\n</span><span class="s"> nr_rwqe_rq2=%d</span><span class="se">\n</span><span class="s"> nr_rwqe_rq3=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">qp_nr</span><span class="p">,</span>
			<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_send_wqes</span><span class="p">,</span>
			<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq1</span><span class="p">,</span>
			<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq2</span><span class="p">,</span>
			<span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq3</span><span class="p">);</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba_size</span> <span class="o">=</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_send_wqes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_init_q_skba</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba_size</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">ehea_init_q_skba</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">,</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">ehea_init_q_skba</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">,</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">ehea_init_q_skba</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">,</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_refill_th</span> <span class="o">=</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_send_wqes</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehea_gen_smrs</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">,</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_send_wqes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">init_attr</span><span class="p">);</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">ehea_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">init_attr</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">ehea_destroy_qp</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>
	<span class="n">ehea_destroy_cq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>
	<span class="n">ehea_destroy_cq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>
	<span class="n">ehea_destroy_eq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_clean_portres</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">)</span>
		<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_destroy_qp</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehea_destroy_cq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_cq</span><span class="p">);</span>
		<span class="n">ehea_destroy_cq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_cq</span><span class="p">);</span>
		<span class="n">ehea_destroy_eq</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">eq</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_rem_smrs</span><span class="p">(</span><span class="n">pr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_swqe2_immediate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">lkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">skb_data_size</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">imm_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">swqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">immdata_desc</span><span class="p">.</span><span class="n">immediate_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="o">*</span><span class="n">sg1entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">swqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">immdata_desc</span><span class="p">.</span><span class="n">sg_entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">immediate_len</span> <span class="o">=</span> <span class="n">SWQE2_MAX_IMM</span><span class="p">;</span>

	<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_TSO</span><span class="p">;</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * For TSO packets we only copy the headers into the</span>
<span class="cm">		 * immediate area.</span>
<span class="cm">		 */</span>
		<span class="n">immediate_len</span> <span class="o">=</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">||</span> <span class="n">skb_data_size</span> <span class="o">&gt;=</span> <span class="n">SWQE2_MAX_IMM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">imm_data</span><span class="p">,</span> <span class="n">immediate_len</span><span class="p">);</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">immediate_data_length</span> <span class="o">=</span> <span class="n">immediate_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_data_size</span> <span class="o">&gt;</span> <span class="n">immediate_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sg1entry</span><span class="o">-&gt;</span><span class="n">l_key</span> <span class="o">=</span> <span class="n">lkey</span><span class="p">;</span>
			<span class="n">sg1entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_data_size</span> <span class="o">-</span> <span class="n">immediate_len</span><span class="p">;</span>
			<span class="n">sg1entry</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span>
				<span class="n">ehea_map_vaddr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">immediate_len</span><span class="p">);</span>
			<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">imm_data</span><span class="p">,</span> <span class="n">skb_data_size</span><span class="p">);</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">immediate_data_length</span> <span class="o">=</span> <span class="n">skb_data_size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_swqe2_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">,</span> <span class="o">*</span><span class="n">sg1entry</span><span class="p">,</span> <span class="o">*</span><span class="n">sgentry</span><span class="p">;</span>
	<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nfrags</span><span class="p">,</span> <span class="n">sg1entry_contains_frag_data</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nfrags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">sg1entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">swqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">immdata_desc</span><span class="p">.</span><span class="n">sg_entry</span><span class="p">;</span>
	<span class="n">sg_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehea_vsgentry</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">swqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">immdata_desc</span><span class="p">.</span><span class="n">sg_list</span><span class="p">;</span>
	<span class="n">sg1entry_contains_frag_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">write_swqe2_immediate</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">swqe</span><span class="p">,</span> <span class="n">lkey</span><span class="p">);</span>

	<span class="cm">/* write descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfrags</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">swqe</span><span class="o">-&gt;</span><span class="n">descriptors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* sg1entry not yet used */</span>
			<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="cm">/* copy sg1entry data */</span>
			<span class="n">sg1entry</span><span class="o">-&gt;</span><span class="n">l_key</span> <span class="o">=</span> <span class="n">lkey</span><span class="p">;</span>
			<span class="n">sg1entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">sg1entry</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span>
				<span class="n">ehea_map_vaddr</span><span class="p">(</span><span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
			<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sg1entry_contains_frag_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sg1entry_contains_frag_data</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfrags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">sgentry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">sg1entry_contains_frag_data</span><span class="p">];</span>

			<span class="n">sgentry</span><span class="o">-&gt;</span><span class="n">l_key</span> <span class="o">=</span> <span class="n">lkey</span><span class="p">;</span>
			<span class="n">sgentry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">sgentry</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">ehea_map_vaddr</span><span class="p">(</span><span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
			<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_broadcast_reg_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hcallid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_type</span><span class="p">;</span>

	<span class="cm">/* De/Register untagged packets */</span>
	<span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_BROADCAST</span> <span class="o">|</span> <span class="n">EHEA_BCMC_UNTAGGED</span><span class="p">;</span>
	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_reg_dereg_bcmc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				     <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				     <span class="n">reg_type</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hcallid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%sregistering bc address failed (tagged)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hcallid</span> <span class="o">==</span> <span class="n">H_REG_BCMC</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;de&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_herr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* De/Register VLAN packets */</span>
	<span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_BROADCAST</span> <span class="o">|</span> <span class="n">EHEA_BCMC_VLANID_ALL</span><span class="p">;</span>
	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_reg_dereg_bcmc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				     <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				     <span class="n">reg_type</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hcallid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%sregistering bc address failed (vlan)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hcallid</span> <span class="o">==</span> <span class="n">H_REG_BCMC</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;de&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_herr:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb0</span> <span class="o">*</span><span class="n">cb0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">mac_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for cb0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cb0</span><span class="o">-&gt;</span><span class="n">port_mac_addr</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mac_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">port_mac_addr</span> <span class="o">=</span> <span class="n">cb0</span><span class="o">-&gt;</span><span class="n">port_mac_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				       <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span> <span class="n">H_PORT_CB0</span><span class="p">,</span>
				       <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_PORT_CB0_MAC</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cb0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* Deregister old MAC in pHYP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EHEA_PORT_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_broadcast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">H_DEREG_BCMC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_upregs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">cb0</span><span class="o">-&gt;</span><span class="n">port_mac_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* Register new MAC in pHYP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EHEA_PORT_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_broadcast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">H_REG_BCMC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_upregs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_upregs:</span>
	<span class="n">ehea_update_bcmc_registrations</span><span class="p">();</span>
<span class="nl">out_free:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_promiscuous_error</span><span class="p">(</span><span class="n">u64</span> <span class="n">hret</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">==</span> <span class="n">H_AUTHORITY</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Hypervisor denied %sabling promiscuous mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">enable</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed %sabling promiscuous mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">enable</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_promiscuous</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb7</span> <span class="o">*</span><span class="n">cb7</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cb7</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for cb7</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Modify Pxs_DUCQPN in CB7 */</span>
	<span class="n">cb7</span><span class="o">-&gt;</span><span class="n">def_uc_qpn</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				       <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				       <span class="n">H_PORT_CB7</span><span class="p">,</span> <span class="n">H_PORT_CB7_DUCQPN</span><span class="p">,</span> <span class="n">cb7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehea_promiscuous_error</span><span class="p">(</span><span class="n">hret</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb7</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ehea_multicast_reg_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mc_mac_addr</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">hcallid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_type</span><span class="p">;</span>

	<span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_MULTICAST</span> <span class="o">|</span> <span class="n">EHEA_BCMC_UNTAGGED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc_mac_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reg_type</span> <span class="o">|=</span> <span class="n">EHEA_BCMC_SCOPE_ALL</span><span class="p">;</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_reg_dereg_bcmc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				     <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				     <span class="n">reg_type</span><span class="p">,</span> <span class="n">mc_mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hcallid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">reg_type</span> <span class="o">=</span> <span class="n">EHEA_BCMC_MULTICAST</span> <span class="o">|</span> <span class="n">EHEA_BCMC_VLANID_ALL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc_mac_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reg_type</span> <span class="o">|=</span> <span class="n">EHEA_BCMC_SCOPE_ALL</span><span class="p">;</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_reg_dereg_bcmc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				     <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				     <span class="n">reg_type</span><span class="p">,</span> <span class="n">mc_mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hcallid</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">hret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_drop_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_mc_list</span> <span class="o">*</span><span class="n">mc_entry</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mc_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_mc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_multicast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mc_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span>
						 <span class="n">H_DEREG_BCMC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed deregistering mcast MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mc_entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_allmulti</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">allmulti</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable ALLMULTI */</span>
			<span class="n">ehea_drop_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_multicast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H_REG_BCMC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hret</span><span class="p">)</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">allmulti</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;failed enabling IFF_ALLMULTI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable ALLMULTI */</span>
			<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_multicast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H_DEREG_BCMC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hret</span><span class="p">)</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">allmulti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;failed disabling IFF_ALLMULTI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_add_multicast_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mc_mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_mc_list</span> <span class="o">*</span><span class="n">ehea_mcl_entry</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>

	<span class="n">ehea_mcl_entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ehea_mcl_entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehea_mcl_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for mcl_entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_mcl_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_mcl_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">mc_mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_multicast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ehea_mcl_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span>
					 <span class="n">H_REG_BCMC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hret</span><span class="p">)</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_mcl_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed registering mcast MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ehea_mcl_entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ehea_promiscuous</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehea_allmulti</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ehea_allmulti</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_drop_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Dropping the current multicast list failed.</span>
<span class="cm">			 * Enabling ALL_MULTI is the best we can do.</span>
<span class="cm">			 */</span>
			<span class="n">ehea_allmulti</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_mac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Mcast registration limit reached (0x%llx). Use ALLMULTI!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_mac</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
			<span class="n">ehea_add_multicast_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ehea_update_bcmc_registrations</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">EHEA_MAX_PACKET_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xmit_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_IMM_DATA_PRESENT</span> <span class="o">|</span> <span class="n">EHEA_SWQE_CRC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_IP_CHECKSUM</span><span class="p">;</span>

	<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">ip_start</span> <span class="o">=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">ip_end</span> <span class="o">=</span> <span class="n">swqe</span><span class="o">-&gt;</span><span class="n">ip_start</span> <span class="o">+</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPPROTO_UDP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
			<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_TCP_CHECKSUM</span><span class="p">;</span>

		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tcp_offset</span> <span class="o">=</span> <span class="n">swqe</span><span class="o">-&gt;</span><span class="n">ip_end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
				   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPPROTO_TCP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
			<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_TCP_CHECKSUM</span><span class="p">;</span>

		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tcp_offset</span> <span class="o">=</span> <span class="n">swqe</span><span class="o">-&gt;</span><span class="n">ip_end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
				   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_xmit2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_DESCRIPTORS_PRESENT</span><span class="p">;</span>

	<span class="n">xmit_common</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">swqe</span><span class="p">);</span>

	<span class="n">write_swqe2_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">swqe</span><span class="p">,</span> <span class="n">lkey</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_xmit3</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">imm_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">swqe</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">immdata_nodesc</span><span class="p">.</span><span class="n">immediate_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">xmit_common</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">swqe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">imm_data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imm_data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">immediate_data_length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lkey</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">swqe_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>

	<span class="n">pr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)];</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="n">swqe</span> <span class="o">=</span> <span class="n">ehea_get_swqe</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swqe_index</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">swqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SWQE_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_VLAN_INSERT</span><span class="p">;</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">SWQE3_MAX_IMM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">sig_iv</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sig_comp_iv</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">swqe_num</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_id_counter</span><span class="p">;</span>
		<span class="n">ehea_xmit3</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">swqe</span><span class="p">);</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_TYPE</span><span class="p">,</span> <span class="n">EHEA_SWQE3_TYPE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_COUNT</span><span class="p">,</span> <span class="n">swqe_num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_ll_count</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">sig_iv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">|=</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_REFILL</span><span class="p">,</span>
						      <span class="n">sig_iv</span><span class="p">);</span>
			<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_SIGNALLED_COMPLETION</span><span class="p">;</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_ll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_ll_count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">wr_id</span> <span class="o">=</span>
			<span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_TYPE</span><span class="p">,</span> <span class="n">EHEA_SWQE2_TYPE</span><span class="p">)</span>
		      <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_COUNT</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_id_counter</span><span class="p">)</span>
		      <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_REFILL</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		      <span class="o">|</span> <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">EHEA_WR_ID_INDEX</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">index</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">lkey</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">send_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>
		<span class="n">ehea_xmit2</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">swqe</span><span class="p">,</span> <span class="n">lkey</span><span class="p">);</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_SIGNALLED_COMPLETION</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_id_counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;post swqe on QP %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">init_attr</span><span class="p">.</span><span class="n">qp_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">ehea_dump</span><span class="p">(</span><span class="n">swqe</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s">&quot;swqe&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__EHEA_STOP_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehea_driver_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_PURGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ehea_post_swqe</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">swqe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr</span><span class="o">-&gt;</span><span class="n">p_stats</span><span class="p">.</span><span class="n">queue_stopped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb1</span> <span class="o">*</span><span class="n">cb1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cb1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for cb1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_port</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				      <span class="n">H_PORT_CB1</span><span class="p">,</span> <span class="n">H_PORT_CB1_ALL</span><span class="p">,</span> <span class="n">cb1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid</span> <span class="o">/</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">cb1</span><span class="o">-&gt;</span><span class="n">vlan_filter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="mh">0x8000000000000000</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)));</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_port</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				       <span class="n">H_PORT_CB1</span><span class="p">,</span> <span class="n">H_PORT_CB1_ALL</span><span class="p">,</span> <span class="n">cb1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;modify_ehea_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb1</span> <span class="o">*</span><span class="n">cb1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cb1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for cb1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_port</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				      <span class="n">H_PORT_CB1</span><span class="p">,</span> <span class="n">H_PORT_CB1_ALL</span><span class="p">,</span> <span class="n">cb1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid</span> <span class="o">/</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">cb1</span><span class="o">-&gt;</span><span class="n">vlan_filter</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="mh">0x8000000000000000</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)));</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_port</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
				       <span class="n">H_PORT_CB1</span><span class="p">,</span> <span class="n">H_PORT_CB1_ALL</span><span class="p">,</span> <span class="n">cb1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;modify_ehea_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_activate_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dummy16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dummy64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_modify_qp_cb0</span> <span class="o">*</span><span class="n">cb0</span><span class="p">;</span>

	<span class="n">cb0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span> <span class="n">cb0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_qp failed (1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">=</span> <span class="n">H_QP_CR_STATE_INITIALIZED</span><span class="p">;</span>
	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				     <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_QP_CTL_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cb0</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;modify_ehea_qp failed (1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span> <span class="n">cb0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_qp failed (2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">=</span> <span class="n">H_QP_CR_ENABLED</span> <span class="o">|</span> <span class="n">H_QP_CR_STATE_INITIALIZED</span><span class="p">;</span>
	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				     <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_QP_CTL_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cb0</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;modify_ehea_qp failed (2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span> <span class="n">cb0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_qp failed (3)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">=</span> <span class="n">H_QP_CR_ENABLED</span> <span class="o">|</span> <span class="n">H_QP_CR_STATE_RDY2SND</span><span class="p">;</span>
	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				     <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_QP_CTL_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cb0</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;modify_ehea_qp failed (3)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
				    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span> <span class="n">cb0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_qp failed (4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_port_res_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">def_qps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_res_cfg</span> <span class="n">pr_cfg</span><span class="p">,</span> <span class="n">pr_cfg_small_rx</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ehea_eq_type</span> <span class="n">eq_type</span> <span class="o">=</span> <span class="n">EHEA_EQ</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span> <span class="o">=</span> <span class="n">ehea_create_eq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eq_type</span><span class="p">,</span>
				   <span class="n">EHEA_MAX_ENTRIES_EQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ehea_create_eq failed (qp_eq)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_kill_eq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_cfg</span><span class="p">.</span><span class="n">max_entries_rcq</span> <span class="o">=</span> <span class="n">rq1_entries</span> <span class="o">+</span> <span class="n">rq2_entries</span> <span class="o">+</span> <span class="n">rq3_entries</span><span class="p">;</span>
	<span class="n">pr_cfg</span><span class="p">.</span><span class="n">max_entries_scq</span> <span class="o">=</span> <span class="n">sq_entries</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pr_cfg</span><span class="p">.</span><span class="n">max_entries_sq</span> <span class="o">=</span> <span class="n">sq_entries</span><span class="p">;</span>
	<span class="n">pr_cfg</span><span class="p">.</span><span class="n">max_entries_rq1</span> <span class="o">=</span> <span class="n">rq1_entries</span><span class="p">;</span>
	<span class="n">pr_cfg</span><span class="p">.</span><span class="n">max_entries_rq2</span> <span class="o">=</span> <span class="n">rq2_entries</span><span class="p">;</span>
	<span class="n">pr_cfg</span><span class="p">.</span><span class="n">max_entries_rq3</span> <span class="o">=</span> <span class="n">rq3_entries</span><span class="p">;</span>

	<span class="n">pr_cfg_small_rx</span><span class="p">.</span><span class="n">max_entries_rcq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_cfg_small_rx</span><span class="p">.</span><span class="n">max_entries_scq</span> <span class="o">=</span> <span class="n">sq_entries</span><span class="p">;</span>
	<span class="n">pr_cfg_small_rx</span><span class="p">.</span><span class="n">max_entries_sq</span> <span class="o">=</span> <span class="n">sq_entries</span><span class="p">;</span>
	<span class="n">pr_cfg_small_rx</span><span class="p">.</span><span class="n">max_entries_rq1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_cfg_small_rx</span><span class="p">.</span><span class="n">max_entries_rq2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_cfg_small_rx</span><span class="p">.</span><span class="n">max_entries_rq3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_init_port_res</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pr_cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_clean_pr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">def_qps</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_init_port_res</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">pr_cfg_small_rx</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_clean_pr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_clean_pr:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ehea_clean_portres</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="nl">out_kill_eq:</span>
	<span class="n">ehea_destroy_eq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_clean_all_portres</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">ehea_clean_portres</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">ehea_destroy_eq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">qp_eq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_remove_adapter_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_ports</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ehea_rem_mr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_add_adapter_mr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_ports</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ehea_reg_kernel_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EHEA_PORT_UP</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_port_res_setup</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;port_res_failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set default QP for this port */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_configure_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ehea_configure_port failed. ret:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_clean_pr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_reg_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reg_interrupts failed. ret:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_clean_pr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_activate_qp</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;activate_qp failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_irqs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_fill_port_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out_free_irqs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_irqs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_broadcast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">H_REG_BCMC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_irqs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EHEA_PORT_UP</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_free_irqs:</span>
	<span class="n">ehea_free_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out_clean_pr:</span>
	<span class="n">ehea_clean_all_portres</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed starting. ret=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ehea_update_bcmc_registrations</span><span class="p">();</span>
	<span class="n">ehea_update_firmware_handles</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">port_napi_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">port_napi_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabling port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_napi_enable</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats_work</span><span class="p">,</span>
			      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EHEA_PORT_DOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ehea_drop_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ehea_allmulti</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ehea_broadcast_reg_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">H_DEREG_BCMC</span><span class="p">);</span>

	<span class="n">ehea_free_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EHEA_PORT_DOWN</span><span class="p">;</span>

	<span class="n">ehea_update_bcmc_registrations</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_clean_all_portres</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed freeing resources. ret=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ehea_update_firmware_handles</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__EHEA_DISABLE_PORT_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats_work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">port_napi_disable</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__EHEA_DISABLE_PORT_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_purge_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">orig_qp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="n">qp</span> <span class="o">=</span> <span class="o">*</span><span class="n">orig_qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="p">.</span><span class="n">init_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_swqe</span> <span class="o">*</span><span class="n">swqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wqe_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_send_wqes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swqe</span> <span class="o">=</span> <span class="n">ehea_get_swqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe_index</span><span class="p">);</span>
		<span class="n">swqe</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">EHEA_SWQE_PURGE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_flush_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">swqe_max</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">sq_skba_size</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_ll_count</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">swqe_avail_wq</span><span class="p">,</span>
			 <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">swqe_avail</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">swqe_max</span><span class="p">,</span>
			 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;WARNING: sq not flushed completely</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_stop_qps</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hcp_modify_qp_cb0</span> <span class="o">*</span><span class="n">cb0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dummy64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dummy16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cb0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">;</span>

		<span class="cm">/* Purge send queue */</span>
		<span class="n">ehea_purge_sq</span><span class="p">(</span><span class="n">qp</span><span class="p">);</span>

		<span class="cm">/* Disable queue pair */</span>
		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
					    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span>
					    <span class="n">cb0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_qp failed (1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">&amp;</span> <span class="n">H_QP_CR_RES_STATE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">H_QP_CR_ENABLED</span><span class="p">;</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
					     <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_QP_CTL_REG</span><span class="p">,</span>
							    <span class="mi">1</span><span class="p">),</span> <span class="n">cb0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;modify_ehea_qp failed (1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
					    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span>
					    <span class="n">cb0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;query_ehea_qp failed (2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* deregister shared memory regions */</span>
		<span class="n">dret</span> <span class="o">=</span> <span class="n">ehea_rem_smrs</span><span class="p">(</span><span class="n">pr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unreg shared memory region failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_update_rqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">orig_qp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="n">qp</span> <span class="o">=</span> <span class="o">*</span><span class="n">orig_qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp_init_attr</span> <span class="o">*</span><span class="n">init_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qp</span><span class="p">.</span><span class="n">init_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_rwqe</span> <span class="o">*</span><span class="n">rwqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skba_rq2</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq2_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skba_rq3</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq3_skba</span><span class="p">.</span><span class="n">arr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lkey</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">recv_mr</span><span class="p">.</span><span class="n">lkey</span><span class="p">;</span>


	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rwqe</span> <span class="o">=</span> <span class="n">ehea_get_next_rwqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">l_key</span> <span class="o">=</span> <span class="n">lkey</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">EHEA_WR_ID_INDEX</span><span class="p">,</span> <span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skba_rq2</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
			<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">ehea_map_vaddr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">init_attr</span><span class="o">-&gt;</span><span class="n">act_nr_rwqes_rq3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rwqe</span> <span class="o">=</span> <span class="n">ehea_get_next_rwqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">l_key</span> <span class="o">=</span> <span class="n">lkey</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">EHEA_BMASK_GET</span><span class="p">(</span><span class="n">EHEA_WR_ID_INDEX</span><span class="p">,</span> <span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skba_rq3</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
			<span class="n">rwqe</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">ehea_map_vaddr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_restart_qps</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hcp_modify_qp_cb0</span> <span class="o">*</span><span class="n">cb0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dummy64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dummy16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cb0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="o">*</span><span class="n">pr</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_gen_smrs</span><span class="p">(</span><span class="n">pr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;creation of shared memory regions failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ehea_update_rqs</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>

		<span class="cm">/* Enable queue pair */</span>
		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
					    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span>
					    <span class="n">cb0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;query_ehea_qp failed (1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">&amp;</span> <span class="n">H_QP_CR_RES_STATE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cb0</span><span class="o">-&gt;</span><span class="n">qp_ctl_reg</span> <span class="o">|=</span> <span class="n">H_QP_CR_ENABLED</span><span class="p">;</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
					     <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_QP_CTL_REG</span><span class="p">,</span>
							    <span class="mi">1</span><span class="p">),</span> <span class="n">cb0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">dummy64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;modify_ehea_qp failed (1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_qp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">,</span>
					    <span class="n">EHEA_BMASK_SET</span><span class="p">(</span><span class="n">H_QPCB0_ALL</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span>
					    <span class="n">cb0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;query_ehea_qp failed (2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* refill entire queue */</span>
		<span class="n">ehea_refill_rq1</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">rq1_skba</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ehea_refill_rq2</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ehea_refill_rq3</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_reset_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port</span><span class="p">,</span> <span class="n">reset_task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlpar_mem_lock</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">resets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">port_napi_disable</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">ehea_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ehea_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">port_napi_enable</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlpar_mem_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_rereg_mrs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;LPAR memory changed - re-initializing driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_ports</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Shutdown all ports */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
					<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">ehea_flush_sq</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_stop_qps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">port_napi_disable</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">reset_sq_restart_flag</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Unregister old memory region */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_rem_mr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unregister MR failed - driver inoperable!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__EHEA_STOP_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehea_driver_flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_ports</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Register new memory region */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_reg_kernel_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;register MR failed - driver inoperable!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Restart all ports */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
						<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_restart_qps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">check_sqs</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
							<span class="n">port_napi_enable</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
							<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to restart QPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;re-initializing driver complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_tx_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__EHEA_STOP_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehea_driver_flags</span><span class="p">))</span>
		<span class="n">ehea_schedule_port_reset</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_sense_adapter_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hcp_query_ehea</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_herr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_mac</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">max_mc_mac</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_herr:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_get_jumboframe_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">jumbo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hcp_ehea_port_cb4</span> <span class="o">*</span><span class="n">cb4</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">jumbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* (Try to) enable *jumbo frames */</span>
	<span class="n">cb4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem for cb4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_query_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
					      <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">,</span>
					      <span class="n">H_PORT_CB4</span><span class="p">,</span>
					      <span class="n">H_PORT_CB4_JUMBO</span><span class="p">,</span> <span class="n">cb4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">==</span> <span class="n">H_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cb4</span><span class="o">-&gt;</span><span class="n">jumbo_frame</span><span class="p">)</span>
				<span class="o">*</span><span class="n">jumbo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">cb4</span><span class="o">-&gt;</span><span class="n">jumbo_frame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hret</span> <span class="o">=</span> <span class="n">ehea_h_modify_ehea_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span>
							       <span class="n">handle</span><span class="p">,</span>
							       <span class="n">port</span><span class="o">-&gt;</span>
							       <span class="n">logical_port_id</span><span class="p">,</span>
							       <span class="n">H_PORT_CB4</span><span class="p">,</span>
							       <span class="n">H_PORT_CB4_JUMBO</span><span class="p">,</span>
							       <span class="n">cb4</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hret</span> <span class="o">==</span> <span class="n">H_SUCCESS</span><span class="p">)</span>
					<span class="o">*</span><span class="n">jumbo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cb4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ehea_show_port_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port</span><span class="p">,</span> <span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">log_port_id</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">S_IROTH</span><span class="p">,</span> <span class="n">ehea_show_port_id</span><span class="p">,</span>
		   <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">logical_port_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehea_port</span><span class="p">,</span> <span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">ehea_register_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ibmebus_bus_type</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;port%d&quot;</span><span class="p">,</span> <span class="n">port_name_cnt</span><span class="o">++</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">logical_port_release</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">of_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to register device. ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_log_port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to register attributes, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unreg_of_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

<span class="nl">out_unreg_of_dev:</span>
	<span class="n">of_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_unregister_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_log_port_id</span><span class="p">);</span>
	<span class="n">of_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ehea_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ehea_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ehea_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ehea_start_xmit</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">ehea_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">ehea_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ehea_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ehea_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">ehea_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">ehea_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>	<span class="o">=</span> <span class="n">ehea_vlan_rx_kill_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ehea_tx_watchdog</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="nf">ehea_setup_single_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">logical_port_id</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">port_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jumbo</span><span class="p">;</span>

	<span class="cm">/* allocate memory for the port structures */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span><span class="p">),</span> <span class="n">EHEA_MAX_PORT_RES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_lock</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EHEA_PORT_DOWN</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">sig_comp_iv</span> <span class="o">=</span> <span class="n">sq_entries</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">logical_port_id</span> <span class="o">=</span> <span class="n">logical_port_id</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">msg_level</span><span class="p">,</span> <span class="n">EHEA_MSG_DEFAULT</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_mc_list</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_ethdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_sense_port_attr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_mc_list</span><span class="p">;</span>

	<span class="n">netif_set_real_num_rx_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">);</span>
	<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_def_qps</span><span class="p">);</span>

	<span class="n">port_dev</span> <span class="o">=</span> <span class="n">ehea_register_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">dn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_mc_list</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port_dev</span><span class="p">);</span>

	<span class="cm">/* initialize net_device structure */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehea_netdev_ops</span><span class="p">;</span>
	<span class="n">ehea_set_ethtool_ops</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span>
		      <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_FRAGLIST</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span>
		      <span class="o">|</span> <span class="n">NETIF_F_HIGHDMA</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_TX</span>
		      <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_FILTER</span>
		      <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_HIGHDMA</span> <span class="o">|</span>
			<span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">EHEA_WATCH_DOG_TIMEOUT</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">,</span> <span class="n">ehea_reset_port</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats_work</span><span class="p">,</span> <span class="n">ehea_update_stats</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">swqe_avail_wq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">restart_wq</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;register_netdev failed. ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unreg_port</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_get_jumboframe_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jumbo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed determining jumbo frame status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Jumbo frames are %sabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">jumbo</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_ports</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">port</span><span class="p">;</span>

<span class="nl">out_unreg_port:</span>
	<span class="n">ehea_unregister_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

<span class="nl">out_free_mc_list:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>

<span class="nl">out_free_ethdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;setting up logical port with id=%d failed, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">logical_port_id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_shutdown_single_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats_work</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">ehea_unregister_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_ports</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_setup_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">lhea_dn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">eth_dn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dn_log_port_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lhea_dn</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">eth_dn</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">lhea_dn</span><span class="p">,</span> <span class="n">eth_dn</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">dn_log_port_id</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">eth_dn</span><span class="p">,</span> <span class="s">&quot;ibm,hea-port-no&quot;</span><span class="p">,</span>
						 <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn_log_port_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;bad device node: eth_dn name=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">eth_dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ehea_add_adapter_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;creating MR failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">eth_dn</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ehea_setup_single_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
							  <span class="o">*</span><span class="n">dn_log_port_id</span><span class="p">,</span>
							  <span class="n">eth_dn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				    <span class="s">&quot;logical port id #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">dn_log_port_id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ehea_remove_adapter_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="nf">ehea_get_eth_dn</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">logical_port_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">lhea_dn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">eth_dn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dn_log_port_id</span><span class="p">;</span>

	<span class="n">lhea_dn</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">eth_dn</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">lhea_dn</span><span class="p">,</span> <span class="n">eth_dn</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">dn_log_port_id</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">eth_dn</span><span class="p">,</span> <span class="s">&quot;ibm,hea-port-no&quot;</span><span class="p">,</span>
						 <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dn_log_port_id</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dn_log_port_id</span> <span class="o">==</span> <span class="n">logical_port_id</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">eth_dn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ehea_probe_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">eth_dn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">logical_port_id</span><span class="p">;</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logical_port_id</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">ehea_get_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">logical_port_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;adding port with logical port id=%d failed: port already configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">logical_port_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eth_dn</span> <span class="o">=</span> <span class="n">ehea_get_eth_dn</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">logical_port_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eth_dn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;no logical port with id %d found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logical_port_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehea_add_adapter_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;creating MR failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">ehea_setup_single_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">logical_port_id</span><span class="p">,</span> <span class="n">eth_dn</span><span class="p">);</span>

	<span class="n">of_node_put</span><span class="p">(</span><span class="n">eth_dn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;added: (logical port id=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">logical_port_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ehea_remove_adapter_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ehea_remove_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">logical_port_id</span><span class="p">;</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logical_port_id</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">ehea_get_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">logical_port_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;removed: (logical port id=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">logical_port_id</span><span class="p">);</span>

		<span class="n">ehea_shutdown_single_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;removing port with logical port id=%d failed. port not configured.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">logical_port_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ehea_remove_adapter_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">probe_port</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ehea_probe_port</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">remove_port</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ehea_remove_port</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_create_device_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_probe_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_remove_port</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_remove_device_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_probe_port</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_remove_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ehea_probe_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">adapter_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Invalid ibmebus device probed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adapter</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no mem for ehea_adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ofdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">adapter_handle</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;ibm,hea-handle&quot;</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_handle</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="o">*</span><span class="n">adapter_handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed getting handle for adapter&quot;</span>
			<span class="s">&quot; &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_ad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">EHEA_PD_ID</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>


	<span class="cm">/* initialize adapter and ports */</span>
	<span class="cm">/* get adapter properties */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_sense_adapter_attr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sense_adapter_attr failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_ad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span> <span class="o">=</span> <span class="n">ehea_create_eq</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				      <span class="n">EHEA_NEQ</span><span class="p">,</span> <span class="n">EHEA_MAX_ENTRIES_EQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NEQ creation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_ad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq_tasklet</span><span class="p">,</span> <span class="n">ehea_neq_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_create_device_sysfs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kill_eq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_setup_ports</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup_ports failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_rem_dev_sysfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ibmebus_request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span>
				  <span class="n">ehea_interrupt_neq</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
				  <span class="s">&quot;ehea_neq&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;requesting NEQ IRQ failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_shutdown_ports</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle any events that might be pending. */</span>
	<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq_tasklet</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_shutdown_ports:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ehea_shutdown_single_port</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">out_rem_dev_sysfs:</span>
	<span class="n">ehea_remove_device_sysfs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out_kill_eq:</span>
	<span class="n">ehea_destroy_eq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="p">);</span>

<span class="nl">out_free_ad:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">ehea_update_firmware_handles</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ehea_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EHEA_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ehea_shutdown_single_port</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">ehea_remove_device_sysfs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ibmebus_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">ist1</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq_tasklet</span><span class="p">);</span>

	<span class="n">ehea_destroy_eq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">neq</span><span class="p">);</span>
	<span class="n">ehea_remove_adapter_mr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ehea_update_firmware_handles</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehea_crash_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">arr</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ehea_h_free_resource</span><span class="p">(</span><span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span><span class="p">,</span>
					     <span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fwh</span><span class="p">,</span>
					     <span class="n">FORCE_FREE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ehea_h_reg_dereg_bcmc</span><span class="p">(</span><span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adh</span><span class="p">,</span>
					      <span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span><span class="p">,</span>
					      <span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_type</span><span class="p">,</span>
					      <span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">macaddr</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span> <span class="n">H_DEREG_BCMC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_mem_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
                             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">memory_notify</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlpar_mem_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEM_CANCEL_OFFLINE</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;memory offlining canceled&quot;</span><span class="p">);</span>
		<span class="cm">/* Readd canceled memory block */</span>
	<span class="k">case</span> <span class="n">MEM_ONLINE</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;memory is going online&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">__EHEA_STOP_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehea_driver_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehea_add_sect_bmap</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">start_pfn</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="n">ehea_rereg_mrs</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEM_GOING_OFFLINE</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;memory is going offline&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">__EHEA_STOP_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehea_driver_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehea_rem_sect_bmap</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">start_pfn</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="n">ehea_rereg_mrs</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ehea_update_firmware_handles</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlpar_mem_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">ehea_mem_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">ehea_mem_notifier</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehea_reboot_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">SYS_RESTART</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Reboot: freeing all eHEA resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ibmebus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_driver</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">ehea_reboot_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">ehea_reboot_notifier</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_module_parm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rq1_entries</span> <span class="o">&lt;</span> <span class="n">EHEA_MIN_ENTRIES_QP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rq1_entries</span> <span class="o">&gt;</span> <span class="n">EHEA_MAX_ENTRIES_RQ1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad parameter: rq1_entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rq2_entries</span> <span class="o">&lt;</span> <span class="n">EHEA_MIN_ENTRIES_QP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rq2_entries</span> <span class="o">&gt;</span> <span class="n">EHEA_MAX_ENTRIES_RQ2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad parameter: rq2_entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rq3_entries</span> <span class="o">&lt;</span> <span class="n">EHEA_MIN_ENTRIES_QP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rq3_entries</span> <span class="o">&gt;</span> <span class="n">EHEA_MAX_ENTRIES_RQ3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad parameter: rq3_entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sq_entries</span> <span class="o">&lt;</span> <span class="n">EHEA_MIN_ENTRIES_QP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sq_entries</span> <span class="o">&gt;</span> <span class="n">EHEA_MAX_ENTRIES_SQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad parameter: sq_entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ehea_show_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">EHEA_CAPABILITIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">capabilities</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">S_IROTH</span><span class="p">,</span>
		   <span class="n">ehea_show_capabilities</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ehea_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;IBM eHEA ethernet device driver (Release %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_fw_handles</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ehea_fw_handles</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_bcmc_regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ehea_bcmc_regs</span><span class="p">));</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_module_parm</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ehea_create_busmap</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_reboot_nb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;failed registering reboot notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_mem_nb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;failed registering memory remove notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">crash_shutdown_register</span><span class="p">(</span><span class="n">ehea_crash_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;failed registering crash handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ibmebus_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed registering eHEA device driver on ebus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">driver_attr_capabilities</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to register capabilities attribute, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">out3:</span>
	<span class="n">ibmebus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_driver</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">unregister_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_mem_nb</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_reboot_nb</span><span class="p">);</span>
	<span class="n">crash_shutdown_unregister</span><span class="p">(</span><span class="n">ehea_crash_handler</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ehea_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_capabilities</span><span class="p">);</span>
	<span class="n">ibmebus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_driver</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_reboot_nb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">crash_shutdown_unregister</span><span class="p">(</span><span class="n">ehea_crash_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;failed unregistering crash handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">unregister_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehea_mem_nb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ehea_fw_handles</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ehea_bcmc_regs</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">ehea_destroy_busmap</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ehea_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ehea_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
