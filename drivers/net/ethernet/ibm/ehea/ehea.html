<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › ibm › ehea › ehea.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ehea.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/net/ethernet/ibm/ehea/ehea.h</span>
<span class="cm"> *</span>
<span class="cm"> *  eHEA ethernet device driver for IBM eServer System p</span>
<span class="cm"> *</span>
<span class="cm"> *  (C) Copyright IBM Corp. 2006</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors:</span>
<span class="cm"> *       Christoph Raisch &lt;raisch@de.ibm.com&gt;</span>
<span class="cm"> *       Jan-Bernd Themann &lt;themann@de.ibm.com&gt;</span>
<span class="cm"> *       Thomas Klein &lt;tklein@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __EHEA_H__</span>
<span class="cp">#define __EHEA_H__</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &lt;asm/ibmebus.h&gt;</span>
<span class="cp">#include &lt;asm/abs_addr.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#define DRV_NAME	&quot;ehea&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;EHEA_0107&quot;</span>

<span class="cm">/* eHEA capability flags */</span>
<span class="cp">#define DLPAR_PORT_ADD_REM 1</span>
<span class="cp">#define DLPAR_MEM_ADD      2</span>
<span class="cp">#define DLPAR_MEM_REM      4</span>
<span class="cp">#define EHEA_CAPABILITIES  (DLPAR_PORT_ADD_REM | DLPAR_MEM_ADD | DLPAR_MEM_REM)</span>

<span class="cp">#define EHEA_MSG_DEFAULT (NETIF_MSG_LINK | NETIF_MSG_TIMER \</span>
<span class="cp">	| NETIF_MSG_RX_ERR | NETIF_MSG_TX_ERR)</span>

<span class="cp">#define EHEA_MAX_ENTRIES_RQ1 32767</span>
<span class="cp">#define EHEA_MAX_ENTRIES_RQ2 16383</span>
<span class="cp">#define EHEA_MAX_ENTRIES_RQ3 16383</span>
<span class="cp">#define EHEA_MAX_ENTRIES_SQ  32767</span>
<span class="cp">#define EHEA_MIN_ENTRIES_QP  127</span>

<span class="cp">#define EHEA_SMALL_QUEUES</span>

<span class="cp">#ifdef EHEA_SMALL_QUEUES</span>
<span class="cp">#define EHEA_MAX_CQE_COUNT      1023</span>
<span class="cp">#define EHEA_DEF_ENTRIES_SQ     1023</span>
<span class="cp">#define EHEA_DEF_ENTRIES_RQ1    1023</span>
<span class="cp">#define EHEA_DEF_ENTRIES_RQ2    1023</span>
<span class="cp">#define EHEA_DEF_ENTRIES_RQ3    511</span>
<span class="cp">#else</span>
<span class="cp">#define EHEA_MAX_CQE_COUNT      4080</span>
<span class="cp">#define EHEA_DEF_ENTRIES_SQ     4080</span>
<span class="cp">#define EHEA_DEF_ENTRIES_RQ1    8160</span>
<span class="cp">#define EHEA_DEF_ENTRIES_RQ2    2040</span>
<span class="cp">#define EHEA_DEF_ENTRIES_RQ3    2040</span>
<span class="cp">#endif</span>

<span class="cp">#define EHEA_MAX_ENTRIES_EQ 20</span>

<span class="cp">#define EHEA_SG_SQ  2</span>
<span class="cp">#define EHEA_SG_RQ1 1</span>
<span class="cp">#define EHEA_SG_RQ2 0</span>
<span class="cp">#define EHEA_SG_RQ3 0</span>

<span class="cp">#define EHEA_MAX_PACKET_SIZE    9022	</span><span class="cm">/* for jumbo frames */</span><span class="cp"></span>
<span class="cp">#define EHEA_RQ2_PKT_SIZE       2048</span>
<span class="cp">#define EHEA_L_PKT_SIZE         256	</span><span class="cm">/* low latency */</span><span class="cp"></span>

<span class="cm">/* Send completion signaling */</span>

<span class="cm">/* Protection Domain Identifier */</span>
<span class="cp">#define EHEA_PD_ID        0xaabcdeff</span>

<span class="cp">#define EHEA_RQ2_THRESHOLD 	   1</span>
<span class="cp">#define EHEA_RQ3_THRESHOLD	   4	</span><span class="cm">/* use RQ3 threshold of 2048 bytes */</span><span class="cp"></span>

<span class="cp">#define EHEA_SPEED_10G         10000</span>
<span class="cp">#define EHEA_SPEED_1G           1000</span>
<span class="cp">#define EHEA_SPEED_100M          100</span>
<span class="cp">#define EHEA_SPEED_10M            10</span>
<span class="cp">#define EHEA_SPEED_AUTONEG         0</span>

<span class="cm">/* Broadcast/Multicast registration types */</span>
<span class="cp">#define EHEA_BCMC_SCOPE_ALL	0x08</span>
<span class="cp">#define EHEA_BCMC_SCOPE_SINGLE	0x00</span>
<span class="cp">#define EHEA_BCMC_MULTICAST	0x04</span>
<span class="cp">#define EHEA_BCMC_BROADCAST	0x00</span>
<span class="cp">#define EHEA_BCMC_UNTAGGED	0x02</span>
<span class="cp">#define EHEA_BCMC_TAGGED	0x00</span>
<span class="cp">#define EHEA_BCMC_VLANID_ALL	0x01</span>
<span class="cp">#define EHEA_BCMC_VLANID_SINGLE	0x00</span>

<span class="cp">#define EHEA_CACHE_LINE          128</span>

<span class="cm">/* Memory Regions */</span>
<span class="cp">#define EHEA_MR_ACC_CTRL       0x00800000</span>

<span class="cp">#define EHEA_BUSMAP_START      0x8000000000000000ULL</span>
<span class="cp">#define EHEA_INVAL_ADDR        0xFFFFFFFFFFFFFFFFULL</span>
<span class="cp">#define EHEA_DIR_INDEX_SHIFT 13                   </span><span class="cm">/* 8k Entries in 64k block */</span><span class="cp"></span>
<span class="cp">#define EHEA_TOP_INDEX_SHIFT (EHEA_DIR_INDEX_SHIFT * 2)</span>
<span class="cp">#define EHEA_MAP_ENTRIES (1 &lt;&lt; EHEA_DIR_INDEX_SHIFT)</span>
<span class="cp">#define EHEA_MAP_SIZE (0x10000)                   </span><span class="cm">/* currently fixed map size */</span><span class="cp"></span>
<span class="cp">#define EHEA_INDEX_MASK (EHEA_MAP_ENTRIES - 1)</span>


<span class="cp">#define EHEA_WATCH_DOG_TIMEOUT 10*HZ</span>

<span class="cm">/* utility functions */</span>

<span class="kt">void</span> <span class="n">ehea_dump</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">adr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>

<span class="cp">#define EHEA_BMASK(pos, length) (((pos) &lt;&lt; 16) + (length))</span>

<span class="cp">#define EHEA_BMASK_IBM(from, to) (((63 - to) &lt;&lt; 16) + ((to) - (from) + 1))</span>

<span class="cp">#define EHEA_BMASK_SHIFTPOS(mask) (((mask) &gt;&gt; 16) &amp; 0xffff)</span>

<span class="cp">#define EHEA_BMASK_MASK(mask) \</span>
<span class="cp">	(0xffffffffffffffffULL &gt;&gt; ((64 - (mask)) &amp; 0xffff))</span>

<span class="cp">#define EHEA_BMASK_SET(mask, value) \</span>
<span class="cp">	((EHEA_BMASK_MASK(mask) &amp; ((u64)(value))) &lt;&lt; EHEA_BMASK_SHIFTPOS(mask))</span>

<span class="cp">#define EHEA_BMASK_GET(mask, value) \</span>
<span class="cp">	(EHEA_BMASK_MASK(mask) &amp; (((u64)(value)) &gt;&gt; EHEA_BMASK_SHIFTPOS(mask)))</span>

<span class="cm">/*</span>
<span class="cm"> * Generic ehea page</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_page</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">entries</span><span class="p">[</span><span class="n">PAGE_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Generic queue in linux kernel virtual memory</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">hw_queue</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">current_q_offset</span><span class="p">;</span>		<span class="cm">/* current queue entry */</span>
	<span class="k">struct</span> <span class="n">ehea_page</span> <span class="o">**</span><span class="n">queue_pages</span><span class="p">;</span>	<span class="cm">/* array of pages belonging to queue */</span>
	<span class="n">u32</span> <span class="n">qe_size</span><span class="p">;</span>			<span class="cm">/* queue entry size */</span>
	<span class="n">u32</span> <span class="n">queue_length</span><span class="p">;</span>      		<span class="cm">/* queue length allocated in bytes */</span>
	<span class="n">u32</span> <span class="n">pagesize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">toggle_state</span><span class="p">;</span>		<span class="cm">/* toggle flag - per page */</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">;</span>			<span class="cm">/* 64 bit alignment */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * For pSeries this is a 64bit memory address where</span>
<span class="cm"> * I/O memory is mapped into CPU address space</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">h_epa</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">h_epa_user</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">h_epas</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">h_epa</span> <span class="n">kernel</span><span class="p">;</span>	<span class="cm">/* kernel space accessible resource,</span>
<span class="cm">				   set to 0 if unused */</span>
	<span class="k">struct</span> <span class="n">h_epa_user</span> <span class="n">user</span><span class="p">;</span>	<span class="cm">/* user space accessible resource</span>
<span class="cm">				   set to 0 if unused */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Memory map data structures</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_dir_bmap</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ent</span><span class="p">[</span><span class="n">EHEA_MAP_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">ehea_top_bmap</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_dir_bmap</span> <span class="o">*</span><span class="n">dir</span><span class="p">[</span><span class="n">EHEA_MAP_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">ehea_bmap</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_top_bmap</span> <span class="o">*</span><span class="n">top</span><span class="p">[</span><span class="n">EHEA_MAP_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ehea_qp</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ehea_cq</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ehea_eq</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ehea_port</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ehea_av</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Queue attributes passed to ehea_create_qp()</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_qp_init_attr</span> <span class="p">{</span>
	<span class="cm">/* input parameter */</span>
	<span class="n">u32</span> <span class="n">qp_token</span><span class="p">;</span>           <span class="cm">/* queue token */</span>
	<span class="n">u8</span> <span class="n">low_lat_rq1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">signalingtype</span><span class="p">;</span>       <span class="cm">/* cqe generation flag */</span>
	<span class="n">u8</span> <span class="n">rq_count</span><span class="p">;</span>            <span class="cm">/* num of receive queues */</span>
	<span class="n">u8</span> <span class="n">eqe_gen</span><span class="p">;</span>             <span class="cm">/* eqe generation flag */</span>
	<span class="n">u16</span> <span class="n">max_nr_send_wqes</span><span class="p">;</span>   <span class="cm">/* max number of send wqes */</span>
	<span class="n">u16</span> <span class="n">max_nr_rwqes_rq1</span><span class="p">;</span>   <span class="cm">/* max number of receive wqes */</span>
	<span class="n">u16</span> <span class="n">max_nr_rwqes_rq2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_nr_rwqes_rq3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wqe_size_enc_sq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wqe_size_enc_rq1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wqe_size_enc_rq2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wqe_size_enc_rq3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">swqe_imm_data_len</span><span class="p">;</span>   <span class="cm">/* immediate data length for swqes */</span>
	<span class="n">u16</span> <span class="n">port_nr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rq2_threshold</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rq3_threshold</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">send_cq_handle</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">recv_cq_handle</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">aff_eq_handle</span><span class="p">;</span>

	<span class="cm">/* output parameter */</span>
	<span class="n">u32</span> <span class="n">qp_nr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">act_nr_send_wqes</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">act_nr_rwqes_rq1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">act_nr_rwqes_rq2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">act_nr_rwqes_rq3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">act_wqe_size_enc_sq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">act_wqe_size_enc_rq1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">act_wqe_size_enc_rq2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">act_wqe_size_enc_rq3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_sq_pages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_rq1_pages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_rq2_pages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_rq3_pages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">liobn_sq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">liobn_rq1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">liobn_rq2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">liobn_rq3</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Event Queue attributes, passed as parameter</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_eq_attr</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_nr_of_eqes</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eqe_gen</span><span class="p">;</span>        <span class="cm">/* generate eqe flag */</span>
	<span class="n">u64</span> <span class="n">eq_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">act_nr_of_eqes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ist1</span><span class="p">;</span>          <span class="cm">/* Interrupt service token */</span>
	<span class="n">u32</span> <span class="n">ist2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ist3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ist4</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Event Queue</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_eq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="n">hw_queue</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fw_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">h_epas</span> <span class="n">epas</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">spinlock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_eq_attr</span> <span class="n">attr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * HEA Queues</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fw_handle</span><span class="p">;</span>			<span class="cm">/* QP handle for firmware calls */</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="n">hw_squeue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="n">hw_rqueue1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="n">hw_rqueue2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="n">hw_rqueue3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">h_epas</span> <span class="n">epas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_qp_init_attr</span> <span class="n">init_attr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Completion Queue attributes</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_cq_attr</span> <span class="p">{</span>
	<span class="cm">/* input parameter */</span>
	<span class="n">u32</span> <span class="n">max_nr_of_cqes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cq_token</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">eq_handle</span><span class="p">;</span>

	<span class="cm">/* output parameter */</span>
	<span class="n">u32</span> <span class="n">act_nr_of_cqes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_pages</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Completion Queue</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_cq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fw_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_queue</span> <span class="n">hw_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">h_epas</span> <span class="n">epas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cq_attr</span> <span class="n">attr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Memory Region</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_mr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lkey</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Port state information</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">port_stats</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">poll_receive_errors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_stopped</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err_tcp_cksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err_ip_cksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err_frame_crc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define EHEA_IRQ_NAME_SIZE 20</span>

<span class="cm">/*</span>
<span class="cm"> * Queue SKB Array</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_q_skb_arr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">arr</span><span class="p">;</span>		<span class="cm">/* skb array for queue */</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>                	<span class="cm">/* array length */</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>			<span class="cm">/* array index */</span>
	<span class="kt">int</span> <span class="n">os_skbs</span><span class="p">;</span>			<span class="cm">/* rq2/rq3 only: outstanding skbs */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Port resources</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_stats</span> <span class="n">p_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_mr</span> <span class="n">send_mr</span><span class="p">;</span>       	<span class="cm">/* send memory region */</span>
	<span class="k">struct</span> <span class="n">ehea_mr</span> <span class="n">recv_mr</span><span class="p">;</span>       	<span class="cm">/* receive memory region */</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">int_recv_name</span><span class="p">[</span><span class="n">EHEA_IRQ_NAME_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">int_send_name</span><span class="p">[</span><span class="n">EHEA_IRQ_NAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ehea_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cq</span> <span class="o">*</span><span class="n">send_cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_cq</span> <span class="o">*</span><span class="n">recv_cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_eq</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_q_skb_arr</span> <span class="n">rq1_skba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_q_skb_arr</span> <span class="n">rq2_skba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_q_skb_arr</span> <span class="n">rq3_skba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_q_skb_arr</span> <span class="n">sq_skba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sq_skba_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">swqe_refill_th</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">swqe_avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">swqe_ll_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swqe_id_counter</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sq_restart_flag</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define EHEA_MAX_PORTS 16</span>

<span class="cp">#define EHEA_NUM_PORTRES_FW_HANDLES    6  </span><span class="cm">/* QP handle, SendCQ handle,</span>
<span class="cm">					     RecvCQ handle, EQ handle,</span>
<span class="cm">					     SendMR handle, RecvMR handle */</span><span class="cp"></span>
<span class="cp">#define EHEA_NUM_PORT_FW_HANDLES       1  </span><span class="cm">/* EQ handle */</span><span class="cp"></span>
<span class="cp">#define EHEA_NUM_ADAPTER_FW_HANDLES    2  </span><span class="cm">/* MR handle, NEQ handle */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">[</span><span class="n">EHEA_MAX_PORTS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ehea_eq</span> <span class="o">*</span><span class="n">neq</span><span class="p">;</span>       <span class="cm">/* notification event queue */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">neq_tasklet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_mr</span> <span class="n">mr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pd</span><span class="p">;</span>                    <span class="cm">/* protection domain */</span>
	<span class="n">u64</span> <span class="n">max_mc_mac</span><span class="p">;</span>            <span class="cm">/* max number of multicast mac addresses */</span>
	<span class="kt">int</span> <span class="n">active_ports</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">ehea_mc_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">macaddr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* kdump support */</span>
<span class="k">struct</span> <span class="n">ehea_fw_handle_entry</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">adh</span><span class="p">;</span>               <span class="cm">/* Adapter Handle */</span>
	<span class="n">u64</span> <span class="n">fwh</span><span class="p">;</span>               <span class="cm">/* Firmware Handle */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ehea_fw_handle_array</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_fw_handle_entry</span> <span class="o">*</span><span class="n">arr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_entries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ehea_bcmc_reg_entry</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">adh</span><span class="p">;</span>               <span class="cm">/* Adapter Handle */</span>
	<span class="n">u32</span> <span class="n">port_id</span><span class="p">;</span>           <span class="cm">/* Logical Port Id */</span>
	<span class="n">u8</span> <span class="n">reg_type</span><span class="p">;</span>           <span class="cm">/* Registration Type */</span>
	<span class="n">u64</span> <span class="n">macaddr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ehea_bcmc_reg_array</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_bcmc_reg_entry</span> <span class="o">*</span><span class="n">arr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_entries</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define EHEA_PORT_UP 1</span>
<span class="cp">#define EHEA_PORT_DOWN 0</span>
<span class="cp">#define EHEA_PHY_LINK_UP 1</span>
<span class="cp">#define EHEA_PHY_LINK_DOWN 0</span>
<span class="cp">#define EHEA_MAX_PORT_RES 16</span>
<span class="k">struct</span> <span class="n">ehea_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehea_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>	 <span class="cm">/* adapter that owns this port */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehea_port_res</span> <span class="n">port_res</span><span class="p">[</span><span class="n">EHEA_MAX_PORT_RES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">platform_device</span>  <span class="n">ofdev</span><span class="p">;</span> <span class="cm">/* Open Firmware Device */</span>
	<span class="k">struct</span> <span class="n">ehea_mc_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">;</span>	 <span class="cm">/* Multicast MAC addresses */</span>
	<span class="k">struct</span> <span class="n">ehea_eq</span> <span class="o">*</span><span class="n">qp_eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">reset_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">stats_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">port_lock</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">int_aff_name</span><span class="p">[</span><span class="n">EHEA_IRQ_NAME_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">allmulti</span><span class="p">;</span>			 <span class="cm">/* Indicates IFF_ALLMULTI state */</span>
	<span class="kt">int</span> <span class="n">promisc</span><span class="p">;</span>		 	 <span class="cm">/* Indicates IFF_PROMISC state */</span>
	<span class="kt">int</span> <span class="n">num_mcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mac_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">logical_port_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_speed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sig_comp_iv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_link</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">full_duplex</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_def_qps</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">swqe_avail_wq</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">restart_wq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">port_res_cfg</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_entries_rcq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_entries_scq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_entries_sq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_entries_rq1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_entries_rq2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_entries_rq3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ehea_flag_bits</span> <span class="p">{</span>
	<span class="n">__EHEA_STOP_XFER</span><span class="p">,</span>
	<span class="n">__EHEA_DISABLE_PORT_RESET</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">ehea_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ehea_sense_port_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ehea_set_portspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehea_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_speed</span><span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* __EHEA_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
