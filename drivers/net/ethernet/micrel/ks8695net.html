<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › micrel › ks8695net.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ks8695net.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Micrel KS8695 (Centaur) Ethernet.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008 Simtec Electronics</span>
<span class="cm"> *		  Daniel Silverstone &lt;dsilvers@simtec.co.uk&gt;</span>
<span class="cm"> *		  Vincent Sanders &lt;vince@simtec.co.uk&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;mach/regs-switch.h&gt;</span>
<span class="cp">#include &lt;mach/regs-misc.h&gt;</span>
<span class="cp">#include &lt;asm/mach/irq.h&gt;</span>
<span class="cp">#include &lt;mach/regs-irq.h&gt;</span>

<span class="cp">#include &quot;ks8695net.h&quot;</span>

<span class="cp">#define MODULENAME	&quot;ks8695_ether&quot;</span>
<span class="cp">#define MODULEVERSION	&quot;1.02&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Transmit and device reset timeout, default 5 seconds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

<span class="cm">/* Hardware structures */</span>

<span class="cm">/**</span>
<span class="cm"> *	struct rx_ring_desc - Receive descriptor ring element</span>
<span class="cm"> *	@status: The status of the descriptor element (E.g. who owns it)</span>
<span class="cm"> *	@length: The number of bytes in the block pointed to by data_ptr</span>
<span class="cm"> *	@data_ptr: The physical address of the data block to receive into</span>
<span class="cm"> *	@next_desc: The physical address of the next descriptor element.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rx_ring_desc</span> <span class="p">{</span>
	<span class="n">__le32</span>	<span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">length</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">data_ptr</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">next_desc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	struct tx_ring_desc - Transmit descriptor ring element</span>
<span class="cm"> *	@owner: Who owns the descriptor</span>
<span class="cm"> *	@status: The number of bytes in the block pointed to by data_ptr</span>
<span class="cm"> *	@data_ptr: The physical address of the data block to receive into</span>
<span class="cm"> *	@next_desc: The physical address of the next descriptor element.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="p">{</span>
	<span class="n">__le32</span>	<span class="n">owner</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">data_ptr</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">next_desc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	struct ks8695_skbuff - sk_buff wrapper for rx/tx rings.</span>
<span class="cm"> *	@skb: The buffer in the ring</span>
<span class="cm"> *	@dma_ptr: The mapped DMA pointer of the buffer</span>
<span class="cm"> *	@length: The number of bytes mapped to dma_ptr</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ks8695_skbuff</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">dma_ptr</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Private device structure */</span>

<span class="cp">#define MAX_TX_DESC 8</span>
<span class="cp">#define MAX_TX_DESC_MASK 0x7</span>
<span class="cp">#define MAX_RX_DESC 16</span>
<span class="cp">#define MAX_RX_DESC_MASK 0xf</span>

<span class="cm">/*napi_weight have better more than rx DMA buffers*/</span>
<span class="cp">#define NAPI_WEIGHT   64</span>

<span class="cp">#define MAX_RXBUF_SIZE 0x700</span>

<span class="cp">#define TX_RING_DMA_SIZE (sizeof(struct tx_ring_desc) * MAX_TX_DESC)</span>
<span class="cp">#define RX_RING_DMA_SIZE (sizeof(struct rx_ring_desc) * MAX_RX_DESC)</span>
<span class="cp">#define RING_DMA_SIZE (TX_RING_DMA_SIZE + RX_RING_DMA_SIZE)</span>

<span class="cm">/**</span>
<span class="cm"> *	enum ks8695_dtype - Device type</span>
<span class="cm"> *	@KS8695_DTYPE_WAN: This device is a WAN interface</span>
<span class="cm"> *	@KS8695_DTYPE_LAN: This device is a LAN interface</span>
<span class="cm"> *	@KS8695_DTYPE_HPNA: This device is an HPNA interface</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ks8695_dtype</span> <span class="p">{</span>
	<span class="n">KS8695_DTYPE_WAN</span><span class="p">,</span>
	<span class="n">KS8695_DTYPE_LAN</span><span class="p">,</span>
	<span class="n">KS8695_DTYPE_HPNA</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	struct ks8695_priv - Private data for the KS8695 Ethernet</span>
<span class="cm"> *	@in_suspend: Flag to indicate if we&#39;re suspending/resuming</span>
<span class="cm"> *	@ndev: The net_device for this interface</span>
<span class="cm"> *	@dev: The platform device object for this interface</span>
<span class="cm"> *	@dtype: The type of this device</span>
<span class="cm"> *	@io_regs: The ioremapped registers for this interface</span>
<span class="cm"> *      @napi : Add support NAPI for Rx</span>
<span class="cm"> *	@rx_irq_name: The textual name of the RX IRQ from the platform data</span>
<span class="cm"> *	@tx_irq_name: The textual name of the TX IRQ from the platform data</span>
<span class="cm"> *	@link_irq_name: The textual name of the link IRQ from the</span>
<span class="cm"> *			platform data if available</span>
<span class="cm"> *	@rx_irq: The IRQ number for the RX IRQ</span>
<span class="cm"> *	@tx_irq: The IRQ number for the TX IRQ</span>
<span class="cm"> *	@link_irq: The IRQ number for the link IRQ if available</span>
<span class="cm"> *	@regs_req: The resource request for the registers region</span>
<span class="cm"> *	@phyiface_req: The resource request for the phy/switch region</span>
<span class="cm"> *		       if available</span>
<span class="cm"> *	@phyiface_regs: The ioremapped registers for the phy/switch if available</span>
<span class="cm"> *	@ring_base: The base pointer of the dma coherent memory for the rings</span>
<span class="cm"> *	@ring_base_dma: The DMA mapped equivalent of ring_base</span>
<span class="cm"> *	@tx_ring: The pointer in ring_base of the TX ring</span>
<span class="cm"> *	@tx_ring_used: The number of slots in the TX ring which are occupied</span>
<span class="cm"> *	@tx_ring_next_slot: The next slot to fill in the TX ring</span>
<span class="cm"> *	@tx_ring_dma: The DMA mapped equivalent of tx_ring</span>
<span class="cm"> *	@tx_buffers: The sk_buff mappings for the TX ring</span>
<span class="cm"> *	@txq_lock: A lock to protect the tx_buffers tx_ring_used etc variables</span>
<span class="cm"> *	@rx_ring: The pointer in ring_base of the RX ring</span>
<span class="cm"> *	@rx_ring_dma: The DMA mapped equivalent of rx_ring</span>
<span class="cm"> *	@rx_buffers: The sk_buff mappings for the RX ring</span>
<span class="cm"> *	@next_rx_desc_read: The next RX descriptor to read from on IRQ</span>
<span class="cm"> *      @rx_lock: A lock to protect Rx irq function</span>
<span class="cm"> *	@msg_enable: The flags for which messages to emit</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">in_suspend</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ks8695_dtype</span> <span class="n">dtype</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">io_regs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">napi_struct</span>	<span class="n">napi</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rx_irq_name</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_irq_name</span><span class="p">,</span> <span class="o">*</span><span class="n">link_irq_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_irq</span><span class="p">,</span> <span class="n">tx_irq</span><span class="p">,</span> <span class="n">link_irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">regs_req</span><span class="p">,</span> <span class="o">*</span><span class="n">phyiface_req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">phyiface_regs</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">ring_base</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ring_base_dma</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_ring_used</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_ring_next_slot</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_ring_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ks8695_skbuff</span> <span class="n">tx_buffers</span><span class="p">[</span><span class="n">MAX_TX_DESC</span><span class="p">];</span>
	<span class="n">spinlock_t</span> <span class="n">txq_lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rx_ring_desc</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rx_ring_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ks8695_skbuff</span> <span class="n">rx_buffers</span><span class="p">[</span><span class="n">MAX_RX_DESC</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">next_rx_desc_read</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">rx_lock</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">msg_enable</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Register access */</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_readreg - Read from a KS8695 ethernet register</span>
<span class="cm"> *	@ksp: The device to read from</span>
<span class="cm"> *	@reg: The register to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">ks8695_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">io_regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_writereg - Write to a KS8695 ethernet register</span>
<span class="cm"> *	@ksp: The device to write to</span>
<span class="cm"> *	@reg: The register to write</span>
<span class="cm"> *	@value: The value to write to the register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ks8695_writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">io_regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Utility functions */</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_port_type - Retrieve port-type as user-friendly string</span>
<span class="cm"> *	@ksp: The device to return the type for</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a string indicating which of the WAN, LAN or HPNA</span>
<span class="cm"> *	ports this device is likely to represent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">ks8695_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KS8695_DTYPE_LAN</span>:
		<span class="k">return</span> <span class="s">&quot;LAN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KS8695_DTYPE_WAN</span>:
		<span class="k">return</span> <span class="s">&quot;WAN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KS8695_DTYPE_HPNA</span>:
		<span class="k">return</span> <span class="s">&quot;HPNA&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_update_mac - Update the MAC registers in the device</span>
<span class="cm"> *	@ksp: The device to update</span>
<span class="cm"> *</span>
<span class="cm"> *	Updates the MAC registers in the KS8695 device from the address in the</span>
<span class="cm"> *	net_device structure associated with this interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_update_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Update the HW with the MAC from the net_device */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">machigh</span><span class="p">,</span> <span class="n">maclow</span><span class="p">;</span>

	<span class="n">maclow</span>	<span class="o">=</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">));</span>
	<span class="n">machigh</span> <span class="o">=</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">));</span>

	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_MAL</span><span class="p">,</span> <span class="n">maclow</span><span class="p">);</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_MAH</span><span class="p">,</span> <span class="n">machigh</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_refill_rxbuffers - Re-fill the RX buffer ring</span>
<span class="cm"> *	@ksp: The device to refill</span>
<span class="cm"> *</span>
<span class="cm"> *	Iterates the RX ring of the device looking for empty slots.</span>
<span class="cm"> *	For each empty slot, we allocate and map a new SKB and give it</span>
<span class="cm"> *	to the hardware.</span>
<span class="cm"> *	This can be called from interrupt context safely.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_refill_rxbuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Run around the RX ring, filling in any missing sk_buff&#39;s */</span>
	<span class="kt">int</span> <span class="n">buff_n</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buff_n</span> <span class="o">&lt;</span> <span class="n">MAX_RX_DESC</span><span class="p">;</span> <span class="o">++</span><span class="n">buff_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span>
				<span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">MAX_RXBUF_SIZE</span><span class="p">);</span>
			<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Failed to allocate one, perhaps</span>
<span class="cm">				 * we&#39;ll try again later.</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						 <span class="n">MAX_RXBUF_SIZE</span><span class="p">,</span>
						 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* Failed to DMA map this SKB, try later */</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">dma_ptr</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">MAX_RXBUF_SIZE</span><span class="p">;</span>

			<span class="cm">/* Record this into the DMA ring */</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MAX_RXBUF_SIZE</span><span class="p">);</span>

			<span class="n">wmb</span><span class="p">();</span>

			<span class="cm">/* And give ownership over to the hardware */</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RDES_OWN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Maximum number of multicast addresses which the KS8695 HW supports */</span>
<span class="cp">#define KS8695_NR_ADDRESSES	16</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_init_partial_multicast - Init the mcast addr registers</span>
<span class="cm"> *	@ksp: The device to initialise</span>
<span class="cm"> *	@addr: The multicast address list to use</span>
<span class="cm"> *	@nr_addr: The number of addresses in the list</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is a helper for ks8695_set_multicast - it writes</span>
<span class="cm"> *	the additional-address registers in the KS8695 ethernet device</span>
<span class="cm"> *	and cleans up any others left behind.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_init_partial_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ran out of space in chip? */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">KS8695_NR_ADDRESSES</span><span class="p">);</span>

		<span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_AAL_</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">low</span><span class="p">);</span>
		<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_AAH_</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">AAH_E</span> <span class="o">|</span> <span class="n">high</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the remaining Additional Station Addresses */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">KS8695_NR_ADDRESSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_AAL_</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_AAH_</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handling */</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_tx_irq - Transmit IRQ handler</span>
<span class="cm"> *	@irq: The IRQ which went off (ignored)</span>
<span class="cm"> *	@dev_id: The net_device for the interrupt</span>
<span class="cm"> *</span>
<span class="cm"> *	Process the TX ring, clearing out any transmitted slots.</span>
<span class="cm"> *	Allows the net_device to pass us new packets once slots are</span>
<span class="cm"> *	freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ks8695_tx_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">buff_n</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buff_n</span> <span class="o">&lt;</span> <span class="n">MAX_TX_DESC</span><span class="p">;</span> <span class="o">++</span><span class="n">buff_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">owner</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TDES_OWN</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rmb</span><span class="p">();</span>
			<span class="cm">/* An SKB which is not owned by HW is present */</span>
			<span class="cm">/* Update the stats for the net_device */</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>

			<span class="cm">/* Free the packet from the ring */</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Free the sk_buff */</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">dma_ptr</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
					 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_used</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_get_rx_enable_bit - Get rx interrupt enable/status bit</span>
<span class="cm"> *	@ksp: Private data for the KS8695 Ethernet</span>
<span class="cm"> *</span>
<span class="cm"> *    For KS8695 document:</span>
<span class="cm"> *    Interrupt Enable Register (offset 0xE204)</span>
<span class="cm"> *        Bit29 : WAN MAC Receive Interrupt Enable</span>
<span class="cm"> *        Bit16 : LAN MAC Receive Interrupt Enable</span>
<span class="cm"> *    Interrupt Status Register (Offset 0xF208)</span>
<span class="cm"> *        Bit29: WAN MAC Receive Status</span>
<span class="cm"> *        Bit16: LAN MAC Receive Status</span>
<span class="cm"> *    So, this Rx interrupt enable/status bit number is equal</span>
<span class="cm"> *    as Rx IRQ number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">ks8695_get_rx_enable_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_rx_irq - Receive IRQ handler</span>
<span class="cm"> *	@irq: The IRQ which went off (ignored)</span>
<span class="cm"> *	@dev_id: The net_device for the interrupt</span>
<span class="cm"> *</span>
<span class="cm"> *	Inform NAPI that packet reception needs to be scheduled</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ks8695_rx_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">KS8695_IRQ_VA</span> <span class="o">+</span> <span class="n">KS8695_INTEN</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ks8695_get_rx_enable_bit</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
		<span class="cm">/*disable rx interrupt*/</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask_bit</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">status</span> <span class="p">,</span> <span class="n">KS8695_IRQ_VA</span> <span class="o">+</span> <span class="n">KS8695_INTEN</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_rx - Receive packets called by NAPI poll method</span>
<span class="cm"> *	@ksp: Private data for the KS8695 Ethernet</span>
<span class="cm"> *	@budget: Number of packets allowed to process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8695_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buff_n</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pktlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buff_n</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">next_rx_desc_read</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">received</span> <span class="o">&lt;</span> <span class="n">budget</span>
			<span class="o">&amp;&amp;</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">status</span> <span class="o">&amp;</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RDES_OWN</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">rmb</span><span class="p">();</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>

			<span class="cm">/* Found an SKB which we own, this means we</span>
<span class="cm">			 * received a packet</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RDES_FS</span> <span class="o">|</span> <span class="n">RDES_LS</span><span class="p">))</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">RDES_FS</span> <span class="o">|</span> <span class="n">RDES_LS</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* This packet is not the first and</span>
<span class="cm">				 * the last segment.  Therefore it is</span>
<span class="cm">				 * a &quot;spanning&quot; packet and we can&#39;t</span>
<span class="cm">				 * handle it</span>
<span class="cm">				 */</span>
				<span class="k">goto</span> <span class="n">rx_failure</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RDES_ES</span> <span class="o">|</span> <span class="n">RDES_RE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* It&#39;s an error packet */</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RDES_TL</span><span class="p">)</span>
					<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RDES_RF</span><span class="p">)</span>
					<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RDES_CE</span><span class="p">)</span>
					<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RDES_RE</span><span class="p">)</span>
					<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="k">goto</span> <span class="n">rx_failure</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pktlen</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RDES_FLEN</span><span class="p">;</span>
			<span class="n">pktlen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Drop the CRC */</span>

			<span class="cm">/* Retrieve the sk_buff */</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>

			<span class="cm">/* Clear it from the ring */</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Unmap the SKB */</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">dma_ptr</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

			<span class="cm">/* Relinquish the SKB to the network layer */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
			<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="cm">/* Record stats */</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pktlen</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rx_finished</span><span class="p">;</span>

<span class="nl">rx_failure:</span>
			<span class="cm">/* This ring entry is an error, but we can</span>
<span class="cm">			 * re-use the skb</span>
<span class="cm">			 */</span>
			<span class="cm">/* Give the ring entry back to the hardware */</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RDES_OWN</span><span class="p">);</span>
<span class="nl">rx_finished:</span>
			<span class="n">received</span><span class="o">++</span><span class="p">;</span>
			<span class="n">buff_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_RX_DESC_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* And note which RX descriptor we last did */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">next_rx_desc_read</span> <span class="o">=</span> <span class="n">buff_n</span><span class="p">;</span>

	<span class="cm">/* And refill the buffers */</span>
	<span class="n">ks8695_refill_rxbuffers</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="cm">/* Kick the RX DMA engine, in case it became suspended */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRSC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	ks8695_poll - Receive packet by NAPI poll method</span>
<span class="cm"> *	@ksp: Private data for the KS8695 Ethernet</span>
<span class="cm"> *	@budget: The remaining number packets for network subsystem</span>
<span class="cm"> *</span>
<span class="cm"> *     Invoked by the network core when it requests for new</span>
<span class="cm"> *     packets from the driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8695_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ks8695_priv</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">work_done</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">isr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">KS8695_IRQ_VA</span> <span class="o">+</span> <span class="n">KS8695_INTEN</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ks8695_get_rx_enable_bit</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="n">ks8695_rx</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">__napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="cm">/*enable rx interrupt*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">isr</span> <span class="o">|</span> <span class="n">mask_bit</span><span class="p">,</span> <span class="n">KS8695_IRQ_VA</span> <span class="o">+</span> <span class="n">KS8695_INTEN</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_link_irq - Link change IRQ handler</span>
<span class="cm"> *	@irq: The IRQ which went off (ignored)</span>
<span class="cm"> *	@dev_id: The net_device for the interrupt</span>
<span class="cm"> *</span>
<span class="cm"> *	The WAN interface can generate an IRQ when the link changes,</span>
<span class="cm"> *	report this to the net layer and the user.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ks8695_link_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">ksp</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;%s: Link is now up (10%sMbps/%s-duplex)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WSS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;0&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WDS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Full&quot;</span> <span class="o">:</span> <span class="s">&quot;Half&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">ksp</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Link is now down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* KS8695 Device functions */</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_reset - Reset a KS8695 ethernet interface</span>
<span class="cm"> *	@ksp: The interface to reset</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform an engine reset of the interface and re-program it</span>
<span class="cm"> *	with sensible defaults.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reset_timeout</span> <span class="o">=</span> <span class="n">watchdog</span><span class="p">;</span>
	<span class="cm">/* Issue the reset via the TX DMA control register */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">,</span> <span class="n">DTXC_TRST</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reset_timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DTXC_TRST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Timeout waiting for DMA engines to reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* And blithely carry on */</span>
	<span class="p">}</span>

	<span class="cm">/* Definitely wait long enough before attempting to program</span>
<span class="cm">	 * the engines</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* RX: unicast and broadcast */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">,</span> <span class="n">DRXC_RU</span> <span class="o">|</span> <span class="n">DRXC_RB</span><span class="p">);</span>
	<span class="cm">/* TX: pad and add CRC */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">,</span> <span class="n">DTXC_TEP</span> <span class="o">|</span> <span class="n">DTXC_TAC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_shutdown - Shut down a KS8695 ethernet interface</span>
<span class="cm"> *	@ksp: The interface to shut down</span>
<span class="cm"> *</span>
<span class="cm"> *	This disables packet RX/TX, cleans up IRQs, drains the rings,</span>
<span class="cm"> *	and basically places the interface into a clean shutdown</span>
<span class="cm"> *	state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buff_n</span><span class="p">;</span>

	<span class="cm">/* Disable packet transmission */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">);</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DTXC_TE</span><span class="p">);</span>

	<span class="cm">/* Disable packet reception */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">);</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DRXC_RE</span><span class="p">);</span>

	<span class="cm">/* Release the IRQs */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Throw away any pending TX packets */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buff_n</span> <span class="o">&lt;</span> <span class="n">MAX_TX_DESC</span><span class="p">;</span> <span class="o">++</span><span class="n">buff_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Remove this SKB from the TX ring */</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Unmap and bin this SKB */</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">dma_ptr</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
					 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Purge the RX buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buff_n</span> <span class="o">&lt;</span> <span class="n">MAX_RX_DESC</span><span class="p">;</span> <span class="o">++</span><span class="n">buff_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Remove the SKB from the RX ring */</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Unmap and bin the SKB */</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">dma_ptr</span><span class="p">,</span>
					 <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	ks8695_setup_irq - IRQ setup helper function</span>
<span class="cm"> *	@irq: The IRQ number to claim</span>
<span class="cm"> *	@irq_name: The name to give the IRQ claimant</span>
<span class="cm"> *	@handler: The function to call to handle the IRQ</span>
<span class="cm"> *	@ndev: The net_device to pass in as the dev_id argument to the handler</span>
<span class="cm"> *</span>
<span class="cm"> *	Return 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_setup_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irq_name</span><span class="p">,</span>
		 <span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">irq_name</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failure to request IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_init_net - Initialise a KS8695 ethernet interface</span>
<span class="cm"> *	@ksp: The interface to initialise</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine fills the RX ring, initialises the DMA engines,</span>
<span class="cm"> *	allocates the IRQs and then starts the packet TX and RX</span>
<span class="cm"> *	engines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_init_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ks8695_refill_rxbuffers</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="cm">/* Initialise the DMA engines */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_RDLB</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_TDLB</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>

	<span class="cm">/* Request the IRQs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ks8695_setup_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_irq_name</span><span class="p">,</span>
			       <span class="n">ks8695_rx_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ks8695_setup_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_irq_name</span><span class="p">,</span>
			       <span class="n">ks8695_tx_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ks8695_setup_irq</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq_name</span><span class="p">,</span>
				       <span class="n">ks8695_link_irq</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the ring indices */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">next_rx_desc_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_next_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Bring up transmission */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">);</span>
	<span class="cm">/* Enable packet transmission */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">|</span> <span class="n">DTXC_TE</span><span class="p">);</span>

	<span class="cm">/* Bring up the reception */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">);</span>
	<span class="cm">/* Enable packet reception */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">|</span> <span class="n">DRXC_RE</span><span class="p">);</span>
	<span class="cm">/* And start the DMA engine */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRSC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* All done */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_release_device - HW resource release for KS8695 e-net</span>
<span class="cm"> *	@ksp: The device to be freed</span>
<span class="cm"> *</span>
<span class="cm"> *	This unallocates io memory regions, dma-coherent regions etc</span>
<span class="cm"> *	which were allocated in ks8695_probe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_release_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Unmap the registers */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">io_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span><span class="p">);</span>

	<span class="cm">/* And release the request */</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">regs_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">regs_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_resource</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_req</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free the ring buffers */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RING_DMA_SIZE</span><span class="p">,</span>
			  <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Ethtool support */</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_get_msglevel - Get the messages enabled for emission</span>
<span class="cm"> *	@ndev: The network device to read from</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">ks8695_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_set_msglevel - Set the messages enabled for emission</span>
<span class="cm"> *	@ndev: The network device to configure</span>
<span class="cm"> *	@value: The messages to set for emission</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_wan_get_settings - Get device-specific settings.</span>
<span class="cm"> *	@ndev: The network device to read settings from</span>
<span class="cm"> *	@cmd: The ethtool structure to read into</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_wan_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* All ports on the KS8695 support these... */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			  <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			  <span class="n">SUPPORTED_TP</span> <span class="o">|</span> <span class="n">SUPPORTED_MII</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_TP</span> <span class="o">|</span> <span class="n">ADVERTISED_MII</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_Pause</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WAND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* auto-negotiation is enabled */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANA100F</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANA100H</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANA10F</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANA10H</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANAP</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Pause</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>

		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WSS</span><span class="p">)</span> <span class="o">?</span> <span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WDS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* auto-negotiation is disabled */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>

		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANF100</span><span class="p">)</span> <span class="o">?</span>
					    <span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANFF</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_wan_set_settings - Set device-specific settings.</span>
<span class="cm"> *	@ndev: The network device to configure</span>
<span class="cm"> *	@cmd: The settings to configure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_wan_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_100</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">PORT_MII</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">!=</span> <span class="n">XCVR_INTERNAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
				<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
				<span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
				<span class="n">ADVERTISED_100baseT_Full</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>

		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WMC_WAND</span> <span class="o">|</span> <span class="n">WMC_WANA100F</span> <span class="o">|</span> <span class="n">WMC_WANA100H</span> <span class="o">|</span>
			  <span class="n">WMC_WANA10F</span> <span class="o">|</span> <span class="n">WMC_WANA10H</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANA100F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANA100H</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANA10F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANA10H</span><span class="p">;</span>

		<span class="cm">/* force a re-negotiation */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANR</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>

		<span class="cm">/* disable auto-negotiation */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WAND</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WMC_WANF100</span> <span class="o">|</span> <span class="n">WMC_WANFF</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANF100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANFF</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_wan_nwayreset - Restart the autonegotiation on the port.</span>
<span class="cm"> *	@ndev: The network device to restart autoneotiation on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_wan_nwayreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WAND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">WMC_WANR</span><span class="p">,</span>
		       <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* auto-negotiation not enabled */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_wan_get_pause - Retrieve network pause/flow-control advertising</span>
<span class="cm"> *	@ndev: The device to retrieve settings from</span>
<span class="cm"> *	@param: The structure to fill out with the information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_wan_get_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>

	<span class="cm">/* advertise Pause */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">WMC_WANAP</span><span class="p">);</span>

	<span class="cm">/* current Rx Flow-control */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">DRXC_RFCE</span><span class="p">);</span>

	<span class="cm">/* current Tx Flow-control */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTXC</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">DTXC_TFCE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_get_drvinfo - Retrieve driver information</span>
<span class="cm"> *	@ndev: The network device to retrieve info about</span>
<span class="cm"> *	@info: The info structure to fill out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">MODULENAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">MODULEVERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ks8695_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_msglevel</span>	<span class="o">=</span> <span class="n">ks8695_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>	<span class="o">=</span> <span class="n">ks8695_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">ks8695_get_drvinfo</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ks8695_wan_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_msglevel</span>	<span class="o">=</span> <span class="n">ks8695_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>	<span class="o">=</span> <span class="n">ks8695_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">ks8695_wan_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">ks8695_wan_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>	<span class="o">=</span> <span class="n">ks8695_wan_nwayreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>	<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">ks8695_wan_get_pause</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">ks8695_get_drvinfo</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Network device interface functions */</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_set_mac - Update MAC in net dev and HW</span>
<span class="cm"> *	@ndev: The network device to update</span>
<span class="cm"> *	@addr: The new MAC address to set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">ks8695_update_mac</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Updated MAC address to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_set_multicast - Set up the multicast behaviour of the interface</span>
<span class="cm"> *	@ndev: The net_device to configure</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine, called by the net layer, configures promiscuity</span>
<span class="cm"> *	and multicast reception behaviour for the interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable promiscuous mode */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DRXC_RA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable promiscuous mode */</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DRXC_RA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable all multicast mode */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DRXC_RM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">KS8695_NR_ADDRESSES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* more specific multicast addresses than can be</span>
<span class="cm">		 * handled in hardware</span>
<span class="cm">		 */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DRXC_RM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* enable specific multicasts */</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DRXC_RM</span><span class="p">;</span>
		<span class="n">ks8695_init_partial_multicast</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DRXC</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_timeout - Handle a network tx/rx timeout.</span>
<span class="cm"> *	@ndev: The net_device which timed out.</span>
<span class="cm"> *</span>
<span class="cm"> *	A network transaction timed out, reset the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ks8695_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ks8695_shutdown</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="n">ks8695_reset</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="n">ks8695_update_mac</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="cm">/* We ignore the return from this since it managed to init</span>
<span class="cm">	 * before it probably will be okay to init again.</span>
<span class="cm">	 */</span>
	<span class="n">ks8695_init_net</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="cm">/* Reconfigure promiscuity etc */</span>
	<span class="n">ks8695_set_multicast</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* And start the TX queue once more */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_start_xmit - Start a packet transmission</span>
<span class="cm"> *	@skb: The packet to transmit</span>
<span class="cm"> *	@ndev: The network device to send the packet on</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine, called by the net layer, takes ownership of the</span>
<span class="cm"> *	sk_buff and adds it to the TX ring. It then kicks the TX DMA</span>
<span class="cm"> *	engine to ensure transmission begins.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">buff_n</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dmap</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">txq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_used</span> <span class="o">==</span> <span class="n">MAX_TX_DESC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Somehow we got entered when we have no room */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">txq_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buff_n</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_next_slot</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">dmap</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Failed to DMA map this SKB, give it back for now */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">txq_lock</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Could not map DMA memory for &quot;</span>\
			<span class="s">&quot;transmission, trying later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">dma_ptr</span> <span class="o">=</span> <span class="n">dmap</span><span class="p">;</span>
	<span class="cm">/* Mapped okay, store the buffer pointer and length for later */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Fill out the TX descriptor */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">data_ptr</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">dma_ptr</span><span class="p">);</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TDES_IC</span> <span class="o">|</span> <span class="n">TDES_FS</span> <span class="o">|</span> <span class="n">TDES_LS</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">TDES_TBS</span><span class="p">));</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Hand it over to the hardware */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">owner</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TDES_OWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_used</span> <span class="o">==</span> <span class="n">MAX_TX_DESC</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Kick the TX DMA in case it decided to go IDLE */</span>
	<span class="n">ks8695_writereg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_DTSC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* And update the next ring slot */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_next_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_TX_DESC_MASK</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">txq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_stop - Stop (shutdown) a KS8695 ethernet interface</span>
<span class="cm"> *	@ndev: The net_device to stop</span>
<span class="cm"> *</span>
<span class="cm"> *	This disables the TX queue and cleans up a KS8695 ethernet</span>
<span class="cm"> *	device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">ks8695_shutdown</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_open - Open (bring up) a KS8695 ethernet interface</span>
<span class="cm"> *	@ndev: The net_device to open</span>
<span class="cm"> *</span>
<span class="cm"> *	This resets, configures the MAC, initialises the RX ring and</span>
<span class="cm"> *	DMA engines and starts the TX queue for a KS8695 ethernet</span>
<span class="cm"> *	device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">ks8695_reset</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="n">ks8695_update_mac</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ks8695_init_net</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ks8695_shutdown</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Platform device driver */</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_init_switch - Init LAN switch to known good defaults.</span>
<span class="cm"> *	@ksp: The device to initialise</span>
<span class="cm"> *</span>
<span class="cm"> *	This initialises the LAN switch in the KS8695 to a known-good</span>
<span class="cm"> *	set of defaults.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">ks8695_init_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Default value for SEC0 according to datasheet */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="mh">0x40819e00</span><span class="p">;</span>

	<span class="cm">/* LED0 = Speed	 LED1 = Link/Activity */</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SEC0_LLED1S</span> <span class="o">|</span> <span class="n">SEC0_LLED0S</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LLED0S_LINK</span> <span class="o">|</span> <span class="n">LLED1S_LINK_ACTIVITY</span><span class="p">);</span>

	<span class="cm">/* Enable Switch */</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SEC0_ENABLE</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_SEC0</span><span class="p">);</span>

	<span class="cm">/* Defaults for SEC1 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x9400100</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_SEC1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_init_wan_phy - Initialise the WAN PHY to sensible defaults</span>
<span class="cm"> *	@ksp: The device to initialise</span>
<span class="cm"> *</span>
<span class="cm"> *	This initialises a KS8695&#39;s WAN phy to sensible values for</span>
<span class="cm"> *	autonegotiation etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">ks8695_init_wan_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Support auto-negotiation */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">WMC_WANAP</span> <span class="o">|</span> <span class="n">WMC_WANA100F</span> <span class="o">|</span> <span class="n">WMC_WANA100H</span> <span class="o">|</span>
		<span class="n">WMC_WANA10F</span> <span class="o">|</span> <span class="n">WMC_WANA10H</span><span class="p">);</span>

	<span class="cm">/* LED0 = Activity , LED1 = Link */</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WLED0S_ACTIVITY</span> <span class="o">|</span> <span class="n">WLED1S_LINK</span><span class="p">);</span>

	<span class="cm">/* Restart Auto-negotiation */</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WMC_WANR</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WMC</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_WPPM</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">+</span> <span class="n">KS8695_PPS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ks8695_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ks8695_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ks8695_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ks8695_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ks8695_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ks8695_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ks8695_set_multicast</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_probe - Probe and initialise a KS8695 ethernet interface</span>
<span class="cm"> *	@pdev: The platform device to probe</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialise a KS8695 ethernet device from platform data.</span>
<span class="cm"> *</span>
<span class="cm"> *	This driver requires at least one IORESOURCE_MEM for the</span>
<span class="cm"> *	registers and two IORESOURCE_IRQ for the RX and TX IRQs</span>
<span class="cm"> *	respectively. It can optionally take an additional</span>
<span class="cm"> *	IORESOURCE_MEM for the switch or phy in the case of the lan or</span>
<span class="cm"> *	wan ports, and an IORESOURCE_IRQ for the link IRQ for the wan</span>
<span class="cm"> *	port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ks8695_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">regs_res</span><span class="p">,</span> <span class="o">*</span><span class="n">phyiface_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rxirq_res</span><span class="p">,</span> <span class="o">*</span><span class="n">txirq_res</span><span class="p">,</span> <span class="o">*</span><span class="n">linkirq_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buff_n</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">machigh</span><span class="p">,</span> <span class="n">maclow</span><span class="p">;</span>

	<span class="cm">/* Initialise a net_device */</span>
	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8695_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ks8695_probe() called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Configure our private structure a little */</span>
	<span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">NETIF_MSG_LINK</span><span class="p">;</span>

	<span class="cm">/* Retrieve resources */</span>
	<span class="n">regs_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">phyiface_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rxirq_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">txirq_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">linkirq_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">regs_res</span> <span class="o">&amp;&amp;</span> <span class="n">rxirq_res</span> <span class="o">&amp;&amp;</span> <span class="n">txirq_res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;insufficient resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">regs_req</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">regs_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					   <span class="n">resource_size</span><span class="p">(</span><span class="n">regs_res</span><span class="p">),</span>
					   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">regs_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot claim register space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">io_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">regs_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">regs_res</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">io_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to ioremap registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phyiface_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_req</span> <span class="o">=</span>
			<span class="n">request_mem_region</span><span class="p">(</span><span class="n">phyiface_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					   <span class="n">resource_size</span><span class="p">(</span><span class="n">phyiface_res</span><span class="p">),</span>
					   <span class="n">phyiface_res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cannot claim switch register space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">phyiface_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					     <span class="n">resource_size</span><span class="p">(</span><span class="n">phyiface_res</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to ioremap switch registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">=</span> <span class="n">rxirq_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_irq_name</span> <span class="o">=</span> <span class="n">rxirq_res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">rxirq_res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;Ethernet RX&quot;</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_irq</span> <span class="o">=</span> <span class="n">txirq_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_irq_name</span> <span class="o">=</span> <span class="n">txirq_res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">txirq_res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;Ethernet TX&quot;</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">linkirq_res</span> <span class="o">?</span> <span class="n">linkirq_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">linkirq_res</span> <span class="o">&amp;&amp;</span> <span class="n">linkirq_res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">linkirq_res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;Ethernet Link&quot;</span><span class="p">;</span>

	<span class="cm">/* driver system setup */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks8695_netdev_ops</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	 <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">watchdog</span><span class="p">);</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">ks8695_poll</span><span class="p">,</span> <span class="n">NAPI_WEIGHT</span><span class="p">);</span>

	<span class="cm">/* Retrieve the default MAC addr from the chip. */</span>
	<span class="cm">/* The bootloader should have left it in there for us. */</span>

	<span class="n">machigh</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_MAH</span><span class="p">);</span>
	<span class="n">maclow</span> <span class="o">=</span> <span class="n">ks8695_readreg</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">KS8695_MAL</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">machigh</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">machigh</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">maclow</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">maclow</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">maclow</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">maclow</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Invalid ethernet MAC address. Please &quot;</span>
			 <span class="s">&quot;set using ifconfig</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* In order to be efficient memory-wise, we allocate both</span>
<span class="cm">	 * rings in one go.</span>
<span class="cm">	 */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RING_DMA_SIZE</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Specify the TX DMA ring buffer */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base_dma</span><span class="p">;</span>

	<span class="cm">/* And initialise the queue&#39;s lock */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">txq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="cm">/* Specify the RX DMA ring buffer */</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base</span> <span class="o">+</span> <span class="n">TX_RING_DMA_SIZE</span><span class="p">;</span>
	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">=</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">ring_base_dma</span> <span class="o">+</span> <span class="n">TX_RING_DMA_SIZE</span><span class="p">;</span>

	<span class="cm">/* Zero the descriptor rings */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TX_RING_DMA_SIZE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RX_RING_DMA_SIZE</span><span class="p">);</span>

	<span class="cm">/* Build the rings */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buff_n</span> <span class="o">&lt;</span> <span class="n">MAX_TX_DESC</span><span class="p">;</span> <span class="o">++</span><span class="n">buff_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span>
				    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_ring_desc</span><span class="p">)</span> <span class="o">*</span>
				     <span class="p">((</span><span class="n">buff_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_TX_DESC_MASK</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">buff_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buff_n</span> <span class="o">&lt;</span> <span class="n">MAX_RX_DESC</span><span class="p">;</span> <span class="o">++</span><span class="n">buff_n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">buff_n</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span>
				    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring_desc</span><span class="p">)</span> <span class="o">*</span>
				     <span class="p">((</span><span class="n">buff_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_RX_DESC_MASK</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="cm">/* Initialise the port (physically) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">&amp;&amp;</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ks8695_init_switch</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
		<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">KS8695_DTYPE_LAN</span><span class="p">;</span>
		<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ks8695_ethtool_ops</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">phyiface_regs</span> <span class="o">&amp;&amp;</span> <span class="n">ksp</span><span class="o">-&gt;</span><span class="n">link_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ks8695_init_wan_phy</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
		<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">KS8695_DTYPE_WAN</span><span class="p">;</span>
		<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ks8695_wan_ethtool_ops</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No initialisation since HPNA does not have a PHY */</span>
		<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">KS8695_DTYPE_HPNA</span><span class="p">;</span>
		<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ks8695_ethtool_ops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* And bring up the net_device with the net core */</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ks8695 ethernet (%s) MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ks8695_port_type</span><span class="p">(</span><span class="n">ksp</span><span class="p">),</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Report the failure to register the net_device */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ks8695net: failed to register netdev.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All is well */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Error exit path */</span>
<span class="nl">failure:</span>
	<span class="n">ks8695_release_device</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_drv_suspend - Suspend a KS8695 ethernet platform device.</span>
<span class="cm"> *	@pdev: The device to suspend</span>
<span class="cm"> *	@state: The suspend state</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine detaches and shuts down a KS8695 ethernet device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_drv_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">ks8695_shutdown</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_drv_resume - Resume a KS8695 ethernet platform device.</span>
<span class="cm"> *	@pdev: The device to resume</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine re-initialises and re-attaches a KS8695 ethernet</span>
<span class="cm"> *	device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ks8695_drv_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ks8695_reset</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
		<span class="n">ks8695_init_net</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
		<span class="n">ks8695_set_multicast</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ksp</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ks8695_drv_remove - Remove a KS8695 net device on driver unload.</span>
<span class="cm"> *	@pdev: The platform device to remove</span>
<span class="cm"> *</span>
<span class="cm"> *	This unregisters and releases a KS8695 ethernet device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span>
<span class="nf">ks8695_drv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ks8695_priv</span> <span class="o">*</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ksp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ks8695_release_device</span><span class="p">(</span><span class="n">ksp</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;released and freed device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ks8695_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MODULENAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ks8695_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ks8695_drv_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ks8695_drv_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ks8695_drv_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Module interface */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">ks8695_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Ethernet driver, V%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">MODULENAME</span><span class="p">,</span> <span class="n">MODULEVERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks8695_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">ks8695_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks8695_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ks8695_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ks8695_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Simtec Electronics&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Micrel KS8695 (Centaur) Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">MODULENAME</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">watchdog</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">watchdog</span><span class="p">,</span> <span class="s">&quot;transmit timeout in milliseconds&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
