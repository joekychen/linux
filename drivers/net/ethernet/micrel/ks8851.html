<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › micrel › ks8851.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ks8851.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* drivers/net/ethernet/micrel/ks8851.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Simtec Electronics</span>
<span class="cm"> *	http://www.simtec.co.uk/</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define DEBUG</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/cache.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/eeprom_93cx6.h&gt;</span>

<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>

<span class="cp">#include &quot;ks8851.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * struct ks8851_rxctrl - KS8851 driver rx control</span>
<span class="cm"> * @mchash: Multicast hash-table data.</span>
<span class="cm"> * @rxcr1: KS_RXCR1 register setting</span>
<span class="cm"> * @rxcr2: KS_RXCR2 register setting</span>
<span class="cm"> *</span>
<span class="cm"> * Representation of the settings needs to control the receive filtering</span>
<span class="cm"> * such as the multicast hash-filter and the receive register settings. This</span>
<span class="cm"> * is used to make the job of working out if the receive settings change and</span>
<span class="cm"> * then issuing the new settings to the worker that will send the necessary</span>
<span class="cm"> * commands.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ks8851_rxctrl</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">mchash</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span>	<span class="n">rxcr1</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">rxcr2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * union ks8851_tx_hdr - tx header data</span>
<span class="cm"> * @txb: The header as bytes</span>
<span class="cm"> * @txw: The header as 16bit, little-endian words</span>
<span class="cm"> *</span>
<span class="cm"> * A dual representation of the tx header data to allow</span>
<span class="cm"> * access to individual bytes, and to allow 16bit accesses</span>
<span class="cm"> * with 16bit alignment.</span>
<span class="cm"> */</span>
<span class="k">union</span> <span class="n">ks8851_tx_hdr</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">txb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__le16</span>	<span class="n">txw</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct ks8851_net - KS8851 driver private data</span>
<span class="cm"> * @netdev: The network device we&#39;re bound to</span>
<span class="cm"> * @spidev: The spi device we&#39;re bound to.</span>
<span class="cm"> * @lock: Lock to ensure that the device is not accessed when busy.</span>
<span class="cm"> * @statelock: Lock on this structure for tx list.</span>
<span class="cm"> * @mii: The MII state information for the mii calls.</span>
<span class="cm"> * @rxctrl: RX settings for @rxctrl_work.</span>
<span class="cm"> * @tx_work: Work queue for tx packets</span>
<span class="cm"> * @irq_work: Work queue for servicing interrupts</span>
<span class="cm"> * @rxctrl_work: Work queue for updating RX mode and multicast lists</span>
<span class="cm"> * @txq: Queue of packets for transmission.</span>
<span class="cm"> * @spi_msg1: pre-setup SPI transfer with one message, @spi_xfer1.</span>
<span class="cm"> * @spi_msg2: pre-setup SPI transfer with two messages, @spi_xfer2.</span>
<span class="cm"> * @txh: Space for generating packet TX header in DMA-able data</span>
<span class="cm"> * @rxd: Space for receiving SPI data, in DMA-able space.</span>
<span class="cm"> * @txd: Space for transmitting SPI data, in DMA-able space.</span>
<span class="cm"> * @msg_enable: The message flags controlling driver output (see ethtool).</span>
<span class="cm"> * @fid: Incrementing frame id tag.</span>
<span class="cm"> * @rc_ier: Cached copy of KS_IER.</span>
<span class="cm"> * @rc_ccr: Cached copy of KS_CCR.</span>
<span class="cm"> * @rc_rxqcr: Cached copy of KS_RXQCR.</span>
<span class="cm"> * @eeprom_size: Companion eeprom size in Bytes, 0 if no eeprom</span>
<span class="cm"> * @eeprom: 93CX6 EEPROM state for accessing on-board EEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> * The @lock ensures that the chip is protected when certain operations are</span>
<span class="cm"> * in progress. When the read or write packet transfer is in progress, most</span>
<span class="cm"> * of the chip registers are not ccessible until the transfer is finished and</span>
<span class="cm"> * the DMA has been de-asserted.</span>
<span class="cm"> *</span>
<span class="cm"> * The @statelock is used to protect information in the structure which may</span>
<span class="cm"> * need to be accessed via several sources, such as the network driver layer</span>
<span class="cm"> * or one of the work queues.</span>
<span class="cm"> *</span>
<span class="cm"> * We align the buffers we may use for rx/tx to ensure that if the SPI driver</span>
<span class="cm"> * wants to DMA map them, it will not have any problems with data the driver</span>
<span class="cm"> * modifies.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_device</span>	<span class="o">*</span><span class="n">spidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">statelock</span><span class="p">;</span>

	<span class="k">union</span> <span class="n">ks8851_tx_hdr</span>	<span class="n">txh</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">rxd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">txd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">u32</span>			<span class="n">msg_enable</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">tx_space</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">fid</span><span class="p">;</span>

	<span class="n">u16</span>			<span class="n">rc_ier</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">rc_rxqcr</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">rc_ccr</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">eeprom_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mii_if_info</span>	<span class="n">mii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ks8851_rxctrl</span>	<span class="n">rxctrl</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">tx_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">irq_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">rxctrl_work</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff_head</span>	<span class="n">txq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">spi_message</span>	<span class="n">spi_msg1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span>	<span class="n">spi_msg2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span>	<span class="n">spi_xfer1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span>	<span class="n">spi_xfer2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">eeprom_93cx6</span>	<span class="n">eeprom</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">msg_enable</span><span class="p">;</span>

<span class="cm">/* shift for byte-enable data */</span>
<span class="cp">#define BYTE_EN(_x)	((_x) &lt;&lt; 2)</span>

<span class="cm">/* turn register number and byte-enable mask into data for start of packet */</span>
<span class="cp">#define MK_OP(_byteen, _reg) (BYTE_EN(_byteen) | (_reg)  &lt;&lt; (8+2) | (_reg) &gt;&gt; 6)</span>

<span class="cm">/* SPI register read/write calls.</span>
<span class="cm"> *</span>
<span class="cm"> * All these calls issue SPI transactions to access the chip&#39;s registers. They</span>
<span class="cm"> * all require that the necessary lock is held to prevent accesses when the</span>
<span class="cm"> * chip is busy transferring packet data (RX/TX FIFO accesses).</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_wrreg16 - write 16bit register value to chip</span>
<span class="cm"> * @ks: The chip state</span>
<span class="cm"> * @reg: The register address</span>
<span class="cm"> * @val: The value to write</span>
<span class="cm"> *</span>
<span class="cm"> * Issue a write to put the value @val into the register specified in @reg.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_wrreg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">xfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg1</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">txb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">txb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MK_OP</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mh">0xC</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">KS_SPIOP_WR</span><span class="p">);</span>
	<span class="n">txb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_sync</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spidev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;spi_sync() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_wrreg8 - write 8bit register value to chip</span>
<span class="cm"> * @ks: The chip state</span>
<span class="cm"> * @reg: The register address</span>
<span class="cm"> * @val: The value to write</span>
<span class="cm"> *</span>
<span class="cm"> * Issue a write to put the value @val into the register specified in @reg.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_wrreg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">xfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg1</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">txb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">txb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MK_OP</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">KS_SPIOP_WR</span><span class="p">);</span>
	<span class="n">txb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_sync</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spidev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;spi_sync() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rx_1msg - select whether to use one or two messages for spi read</span>
<span class="cm"> * @ks: The device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Return whether to generate a single message with a tx and rx buffer</span>
<span class="cm"> * supplied to spi_sync(), or alternatively send the tx and rx buffers</span>
<span class="cm"> * as separate messages.</span>
<span class="cm"> *</span>
<span class="cm"> * Depending on the hardware in use, a single message may be more efficient</span>
<span class="cm"> * on interrupts or work done by the driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This currently always returns true until we add some per-device data passed</span>
<span class="cm"> * from the platform code to specify which mode is better.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ks8851_rx_1msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rdreg - issue read register command and return the data</span>
<span class="cm"> * @ks: The device state</span>
<span class="cm"> * @op: The register address and byte enables in message format.</span>
<span class="cm"> * @rxb: The RX buffer to return the result into</span>
<span class="cm"> * @rxl: The length of data expected.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the low level read call that issues the necessary spi message(s)</span>
<span class="cm"> * to read data from the register specified in @op.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_rdreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">op</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">rxl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">xfer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">txb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">trx</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">txb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">op</span> <span class="o">|</span> <span class="n">KS_SPIOP_RD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ks8851_rx_1msg</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg1</span><span class="p">;</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer1</span><span class="p">;</span>

		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>
		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">trx</span><span class="p">;</span>
		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">rxl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg2</span><span class="p">;</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer2</span><span class="p">;</span>

		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>
		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">xfer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">trx</span><span class="p">;</span>
		<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">rxl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_sync</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spidev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;read: spi_sync() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ks8851_rx_1msg</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxb</span><span class="p">,</span> <span class="n">trx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rxl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxb</span><span class="p">,</span> <span class="n">trx</span><span class="p">,</span> <span class="n">rxl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rdreg8 - read 8 bit register from device</span>
<span class="cm"> * @ks: The chip information</span>
<span class="cm"> * @reg: The register address</span>
<span class="cm"> *</span>
<span class="cm"> * Read a 8bit register from the chip, returning the result</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ks8851_rdreg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rxb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">ks8851_rdreg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">MK_OP</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">reg</span><span class="p">),</span> <span class="n">rxb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rxb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rdreg16 - read 16 bit register from device</span>
<span class="cm"> * @ks: The chip information</span>
<span class="cm"> * @reg: The register address</span>
<span class="cm"> *</span>
<span class="cm"> * Read a 16bit register from the chip, returning the result</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ks8851_rdreg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ks8851_rdreg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">MK_OP</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mh">0xC</span> <span class="o">:</span> <span class="mh">0x3</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rdreg32 - read 32 bit register from device</span>
<span class="cm"> * @ks: The chip information</span>
<span class="cm"> * @reg: The register address</span>
<span class="cm"> *</span>
<span class="cm"> * Read a 32bit register from the chip.</span>
<span class="cm"> *</span>
<span class="cm"> * Note, this read requires the address be aligned to 4 bytes.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ks8851_rdreg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">ks8851_rdreg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">MK_OP</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_soft_reset - issue one of the soft reset to the device</span>
<span class="cm"> * @ks: The device state.</span>
<span class="cm"> * @op: The bit(s) to set in the GRR</span>
<span class="cm"> *</span>
<span class="cm"> * Issue the relevant soft-reset command to the device&#39;s GRR register</span>
<span class="cm"> * specified by @op.</span>
<span class="cm"> *</span>
<span class="cm"> * Note, the delays are in there as a caution to ensure that the reset</span>
<span class="cm"> * has time to take effect and then complete. Since the datasheet does</span>
<span class="cm"> * not currently specify the exact sequence, we have chosen something</span>
<span class="cm"> * that seems to work with our device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_GRR</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* wait a short time to effect reset */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_GRR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* wait for condition to clear */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_set_powermode - set power mode of the device</span>
<span class="cm"> * @ks: The device state</span>
<span class="cm"> * @pwrmode: The power mode value to write to KS_PMECR.</span>
<span class="cm"> *</span>
<span class="cm"> * Change the power mode of the chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_set_powermode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pwrmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pmecr</span><span class="p">;</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;setting power mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwrmode</span><span class="p">);</span>

	<span class="n">pmecr</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_PMECR</span><span class="p">);</span>
	<span class="n">pmecr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PMECR_PM_MASK</span><span class="p">;</span>
	<span class="n">pmecr</span> <span class="o">|=</span> <span class="n">pwrmode</span><span class="p">;</span>

	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_PMECR</span><span class="p">,</span> <span class="n">pmecr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_write_mac_addr - write mac address to device registers</span>
<span class="cm"> * @dev: The network device</span>
<span class="cm"> *</span>
<span class="cm"> * Update the KS8851 MAC address registers from the address in @dev.</span>
<span class="cm"> *</span>
<span class="cm"> * This call assumes that the chip is not running, so there is no need to</span>
<span class="cm"> * shutdown the RXQ process whilst setting this.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_write_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up chip in case it was powered off when stopped; otherwise,</span>
<span class="cm">	 * the first write to the MAC address does not take effect.</span>
<span class="cm">	 */</span>
	<span class="n">ks8851_set_powermode</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">PMECR_PM_NORMAL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ks8851_wrreg8</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_MAR</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ks8851_set_powermode</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">PMECR_PM_SOFTDOWN</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_read_mac_addr - read mac address from device registers</span>
<span class="cm"> * @dev: The network device</span>
<span class="cm"> *</span>
<span class="cm"> * Update our copy of the KS8851 MAC address from the registers of @dev.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_read_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks8851_rdreg8</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_MAR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_init_mac - initialise the mac address</span>
<span class="cm"> * @ks: The device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Get or create the initial mac address for the device and then set that</span>
<span class="cm"> * into the station address register. If there is an EEPROM present, then</span>
<span class="cm"> * we try that. If no valid mac address is found we use random_ether_addr()</span>
<span class="cm"> * to create a new one.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_init_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* first, try reading what we&#39;ve got already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_ccr</span> <span class="o">&amp;</span> <span class="n">CCR_EEPROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ks8851_read_mac_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;invalid mac address read %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ks8851_write_mac_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_irq - device interrupt handler</span>
<span class="cm"> * @irq: Interrupt number passed from the IRQ handler.</span>
<span class="cm"> * @pw: The private word passed to register_irq(), our struct ks8851_net.</span>
<span class="cm"> *</span>
<span class="cm"> * Disable the interrupt from happening again until we&#39;ve processed the</span>
<span class="cm"> * current status by scheduling ks8851_irq_work().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ks8851_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">pw</span><span class="p">;</span>

	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rdfifo - read data from the receive fifo</span>
<span class="cm"> * @ks: The device state.</span>
<span class="cm"> * @buff: The buffer address</span>
<span class="cm"> * @len: The length of the data to read</span>
<span class="cm"> *</span>
<span class="cm"> * Issue an RXQ FIFO read command and read the @len amount of data from</span>
<span class="cm"> * the FIFO into the buffer specified by @buff.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_rdfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">xfer</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		  <span class="s">&quot;%s: %d@%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>

	<span class="cm">/* set the operation we&#39;re issuing */</span>
	<span class="n">txb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KS_SPIOP_RXFIFO</span><span class="p">;</span>

	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">xfer</span><span class="o">++</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_sync</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spidev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;%s: spi_sync() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_dbg_dumpkkt - dump initial packet contents to debug</span>
<span class="cm"> * @ks: The device state</span>
<span class="cm"> * @rxpkt: The data for the received packet</span>
<span class="cm"> *</span>
<span class="cm"> * Dump the initial data from the packet to dev_dbg().</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_dbg_dumpkkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rxpkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		   <span class="s">&quot;pkt %02x%02x%02x%02x %02x%02x%02x%02x %02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rxpkt</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		   <span class="n">rxpkt</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
		   <span class="n">rxpkt</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">rxpkt</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rx_pkts - receive packets from the host</span>
<span class="cm"> * @ks: The device information.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called from the IRQ work queue when the system detects that there</span>
<span class="cm"> * are packets in the receive queue. Find out how many packets there are and</span>
<span class="cm"> * read them from the FIFO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_rx_pkts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rxfc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rxlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rxstat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rxpkt</span><span class="p">;</span>

	<span class="n">rxfc</span> <span class="o">=</span> <span class="n">ks8851_rdreg8</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXFC</span><span class="p">);</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		  <span class="s">&quot;%s: %d packets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rxfc</span><span class="p">);</span>

	<span class="cm">/* Currently we&#39;re issuing a read per packet, but we could possibly</span>
<span class="cm">	 * improve the code by issuing a single read, getting the receive</span>
<span class="cm">	 * header, allocating the packet and then reading the packet data</span>
<span class="cm">	 * out in one go.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This form of operation would require us to hold the SPI bus&#39;</span>
<span class="cm">	 * chipselect low during the entie transaction to avoid any</span>
<span class="cm">	 * reset to the data stream coming from the chip.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">rxfc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rxfc</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxh</span> <span class="o">=</span> <span class="n">ks8851_rdreg32</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXFHSR</span><span class="p">);</span>
		<span class="n">rxstat</span> <span class="o">=</span> <span class="n">rxh</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">rxlen</span> <span class="o">=</span> <span class="n">rxh</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;rx: stat 0x%04x, len 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxstat</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">);</span>

		<span class="cm">/* the length of the packet includes the 32bit CRC */</span>

		<span class="cm">/* set dma read address */</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXFDPR</span><span class="p">,</span> <span class="n">RXFDPR_RXFPAI</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* start the packet dma process, and set auto-dequeue rx */</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXQCR</span><span class="p">,</span>
			       <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_rxqcr</span> <span class="o">|</span> <span class="n">RXQCR_SDA</span> <span class="o">|</span> <span class="n">RXQCR_ADRFE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxlen</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxalign</span><span class="p">;</span>

			<span class="n">rxlen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">rxalign</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">rxlen</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">rxalign</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* 4 bytes of status header + 4 bytes of</span>
<span class="cm">				 * garbage: we put them before ethernet</span>
<span class="cm">				 * header, so that they are copied,</span>
<span class="cm">				 * but ignored.</span>
<span class="cm">				 */</span>

				<span class="n">rxpkt</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>

				<span class="n">ks8851_rdfifo</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">rxpkt</span><span class="p">,</span> <span class="n">rxalign</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span>
					<span class="n">ks8851_dbg_dumpkkt</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">rxpkt</span><span class="p">);</span>

				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
				<span class="n">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

				<span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rxlen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXQCR</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_rxqcr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_irq_work - work queue handler for dealing with interrupt requests</span>
<span class="cm"> * @work: The work structure that was scheduled by schedule_work()</span>
<span class="cm"> *</span>
<span class="cm"> * This is the handler invoked when the ks8851_irq() is called to find out</span>
<span class="cm"> * what happened, as we cannot allow ourselves to sleep whilst waiting for</span>
<span class="cm"> * anything other process has the chip&#39;s lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Read the interrupt status, work out what needs to be done and then clear</span>
<span class="cm"> * any of the interrupts that are not needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_irq_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ks8851_net</span><span class="p">,</span> <span class="n">irq_work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_ISR</span><span class="p">);</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		  <span class="s">&quot;%s: status 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_LCI</span><span class="p">)</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IRQ_LCI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_LDI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pmecr</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_PMECR</span><span class="p">);</span>
		<span class="n">pmecr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PMECR_WKEVT_MASK</span><span class="p">;</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_PMECR</span><span class="p">,</span> <span class="n">pmecr</span> <span class="o">|</span> <span class="n">PMECR_WKEVT_LINK</span><span class="p">);</span>

		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IRQ_LDI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXPSI</span><span class="p">)</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IRQ_RXPSI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_TXI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IRQ_TXI</span><span class="p">;</span>

		<span class="cm">/* no lock here, tx queue should have been stopped */</span>

		<span class="cm">/* update our idea of how much tx space is available to the</span>
<span class="cm">		 * system */</span>
		<span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_space</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_TXMIR</span><span class="p">);</span>

		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;%s: txspace %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_space</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXI</span><span class="p">)</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IRQ_RXI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_SPIBEI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: spi bus error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IRQ_SPIBEI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_ISR</span><span class="p">,</span> <span class="n">handled</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the datasheet says to disable the rx interrupt during</span>
<span class="cm">		 * packet read-out, however we&#39;re masking the interrupt</span>
<span class="cm">		 * from the device so do not bother masking just the RX</span>
<span class="cm">		 * from the device. */</span>

		<span class="n">ks8851_rx_pkts</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if something stopped the rx process, probably due to wanting</span>
<span class="cm">	 * to change the rx settings, then do something about restarting</span>
<span class="cm">	 * it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXPSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ks8851_rxctrl</span> <span class="o">*</span><span class="n">rxc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxctrl</span><span class="p">;</span>

		<span class="cm">/* update the multicast hash table */</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_MAHTR0</span><span class="p">,</span> <span class="n">rxc</span><span class="o">-&gt;</span><span class="n">mchash</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_MAHTR1</span><span class="p">,</span> <span class="n">rxc</span><span class="o">-&gt;</span><span class="n">mchash</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_MAHTR2</span><span class="p">,</span> <span class="n">rxc</span><span class="o">-&gt;</span><span class="n">mchash</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_MAHTR3</span><span class="p">,</span> <span class="n">rxc</span><span class="o">-&gt;</span><span class="n">mchash</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXCR2</span><span class="p">,</span> <span class="n">rxc</span><span class="o">-&gt;</span><span class="n">rxcr2</span><span class="p">);</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXCR1</span><span class="p">,</span> <span class="n">rxc</span><span class="o">-&gt;</span><span class="n">rxcr1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_LCI</span><span class="p">)</span>
		<span class="n">mii_check_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_TXI</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * calc_txlen - calculate size of message to send packet</span>
<span class="cm"> * @len: Length of data</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the size of the TXFIFO message needed to send</span>
<span class="cm"> * this packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">calc_txlen</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_wrpkt - write packet to TX FIFO</span>
<span class="cm"> * @ks: The device state.</span>
<span class="cm"> * @txp: The sk_buff to transmit.</span>
<span class="cm"> * @irq: IRQ on completion of the packet.</span>
<span class="cm"> *</span>
<span class="cm"> * Send the @txp to the chip. This means creating the relevant packet header</span>
<span class="cm"> * specifying the length of the packet and the other information the chip</span>
<span class="cm"> * needs, such as IRQ on completion. Send the header and the packet data to</span>
<span class="cm"> * the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_wrpkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">xfer</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">fid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;%s: skb %p, %d@%p, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">__func__</span><span class="p">,</span> <span class="n">txp</span><span class="p">,</span> <span class="n">txp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">txp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">fid</span><span class="o">++</span><span class="p">;</span>
	<span class="n">fid</span> <span class="o">&amp;=</span> <span class="n">TXFR_TXFID_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">fid</span> <span class="o">|=</span> <span class="n">TXFR_TXIC</span><span class="p">;</span>	<span class="cm">/* irq on completion */</span>

	<span class="cm">/* start header at txb[1] to align txw entries */</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">txh</span><span class="p">.</span><span class="n">txb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KS_SPIOP_TXFIFO</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">txh</span><span class="p">.</span><span class="n">txw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">txh</span><span class="p">.</span><span class="n">txw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">txp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txh</span><span class="p">.</span><span class="n">txb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">xfer</span><span class="o">++</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">txp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">txp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_sync</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spidev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;%s: spi_sync() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_done_tx - update and then free skbuff after transmitting</span>
<span class="cm"> * @ks: The device state</span>
<span class="cm"> * @txb: The buffer transmitted</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_done_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_tx_work - process tx packet(s)</span>
<span class="cm"> * @work: The work strucutre what was scheduled.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called when a number of packets have been scheduled for</span>
<span class="cm"> * transmission and need to be sent to the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_tx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ks8851_net</span><span class="p">,</span> <span class="n">tx_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">last</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXQCR</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_rxqcr</span> <span class="o">|</span> <span class="n">RXQCR_SDA</span><span class="p">);</span>
			<span class="n">ks8851_wrpkt</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">txb</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
			<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXQCR</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_rxqcr</span><span class="p">);</span>
			<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_TXQCR</span><span class="p">,</span> <span class="n">TXQCR_METFE</span><span class="p">);</span>

			<span class="n">ks8851_done_tx</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">txb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_net_open - open network device</span>
<span class="cm"> * @dev: The network device being opened.</span>
<span class="cm"> *</span>
<span class="cm"> * Called when the network device is marked active, such as a user executing</span>
<span class="cm"> * &#39;ifconfig up&#39; on the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* lock the card, even if we may not actually be doing anything</span>
<span class="cm">	 * else at the moment */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;opening</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* bring chip out of any power saving mode it was in */</span>
	<span class="n">ks8851_set_powermode</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">PMECR_PM_NORMAL</span><span class="p">);</span>

	<span class="cm">/* issue a soft reset to the RX/TX QMU to put it into a known</span>
<span class="cm">	 * state. */</span>
	<span class="n">ks8851_soft_reset</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">GRR_QMU</span><span class="p">);</span>

	<span class="cm">/* setup transmission parameters */</span>

	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_TXCR</span><span class="p">,</span> <span class="p">(</span><span class="n">TXCR_TXE</span> <span class="o">|</span> <span class="cm">/* enable transmit process */</span>
				     <span class="n">TXCR_TXPE</span> <span class="o">|</span> <span class="cm">/* pad to min length */</span>
				     <span class="n">TXCR_TXCRC</span> <span class="o">|</span> <span class="cm">/* add CRC */</span>
				     <span class="n">TXCR_TXFCE</span><span class="p">));</span> <span class="cm">/* enable flow control */</span>

	<span class="cm">/* auto-increment tx data, reset tx pointer */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_TXFDPR</span><span class="p">,</span> <span class="n">TXFDPR_TXFPAI</span><span class="p">);</span>

	<span class="cm">/* setup receiver control */</span>

	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXCR1</span><span class="p">,</span> <span class="p">(</span><span class="n">RXCR1_RXPAFMA</span> <span class="o">|</span> <span class="cm">/*  from mac filter */</span>
				      <span class="n">RXCR1_RXFCE</span> <span class="o">|</span> <span class="cm">/* enable flow control */</span>
				      <span class="n">RXCR1_RXBE</span> <span class="o">|</span> <span class="cm">/* broadcast enable */</span>
				      <span class="n">RXCR1_RXUE</span> <span class="o">|</span> <span class="cm">/* unicast enable */</span>
				      <span class="n">RXCR1_RXE</span><span class="p">));</span> <span class="cm">/* enable rx block */</span>

	<span class="cm">/* transfer entire frames out in one go */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXCR2</span><span class="p">,</span> <span class="n">RXCR2_SRDBL_FRAME</span><span class="p">);</span>

	<span class="cm">/* set receive counter timeouts */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXDTTR</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span> <span class="cm">/* 1ms after first frame to IRQ */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXDBCTR</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span> <span class="cm">/* &gt;4Kbytes in buffer to IRQ */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXFCTR</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>  <span class="cm">/* 10 frames to IRQ */</span>

	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_rxqcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXQCR_RXFCTE</span> <span class="o">|</span>  <span class="cm">/* IRQ on frame count exceeded */</span>
			<span class="n">RXQCR_RXDBCTE</span> <span class="o">|</span> <span class="cm">/* IRQ on byte count exceeded */</span>
			<span class="n">RXQCR_RXDTTE</span><span class="p">);</span>  <span class="cm">/* IRQ on time exceeded */</span>

	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXQCR</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_rxqcr</span><span class="p">);</span>

	<span class="cm">/* clear then enable interrupts */</span>

<span class="cp">#define STD_IRQ (IRQ_LCI |	</span><span class="cm">/* Link Change */</span><span class="cp">	\</span>
<span class="cp">		 IRQ_TXI |	</span><span class="cm">/* TX done */</span><span class="cp">		\</span>
<span class="cp">		 IRQ_RXI |	</span><span class="cm">/* RX done */</span><span class="cp">		\</span>
<span class="cp">		 IRQ_SPIBEI |	</span><span class="cm">/* SPI bus error */</span><span class="cp">	\</span>
<span class="cp">		 IRQ_TXPSI |	</span><span class="cm">/* TX process stop */</span><span class="cp">	\</span>
<span class="cp">		 IRQ_RXPSI)	</span><span class="cm">/* RX process stop */</span><span class="cp"></span>

	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_ier</span> <span class="o">=</span> <span class="n">STD_IRQ</span><span class="p">;</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_ISR</span><span class="p">,</span> <span class="n">STD_IRQ</span><span class="p">);</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_IER</span><span class="p">,</span> <span class="n">STD_IRQ</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;network device up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_net_stop - close network device</span>
<span class="cm"> * @dev: The device being closed.</span>
<span class="cm"> *</span>
<span class="cm"> * Called to close down a network device which has been active. Cancell any</span>
<span class="cm"> * work, shutdown the RX and TX process and then place the chip into a low</span>
<span class="cm"> * power state whilst it is not being used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_net_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;shutting down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* turn off the IRQs and ack any outstanding */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_IER</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_ISR</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* stop any outstanding work */</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">);</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxctrl_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* shutdown RX process */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXCR1</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* shutdown TX process */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_TXCR</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* set powermode to soft power down to save power */</span>
	<span class="n">ks8851_set_powermode</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">PMECR_PM_SOFTDOWN</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* ensure any queued tx buffers are dumped */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;%s: freeing txb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">txb</span><span class="p">);</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_start_xmit - transmit packet</span>
<span class="cm"> * @skb: The buffer to transmit</span>
<span class="cm"> * @dev: The device used to transmit the packet.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the network layer to transmit the @skb. Queue the packet for</span>
<span class="cm"> * the device and schedule the necessary work to transmit the packet when</span>
<span class="cm"> * it is free.</span>
<span class="cm"> *</span>
<span class="cm"> * We do this to firstly avoid sleeping with the network device locked,</span>
<span class="cm"> * and secondly so we can round up more than one packet to transmit which</span>
<span class="cm"> * means we can try and avoid generating too many transmit done interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ks8851_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">needed</span> <span class="o">=</span> <span class="n">calc_txlen</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">netdev_tx_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		  <span class="s">&quot;%s: skb %p, %d@%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">statelock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needed</span> <span class="o">&gt;</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_space</span> <span class="o">-=</span> <span class="n">needed</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">statelock</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_rxctrl_work - work handler to change rx mode</span>
<span class="cm"> * @work: The work structure this belongs to.</span>
<span class="cm"> *</span>
<span class="cm"> * Lock the device and issue the necessary changes to the receive mode from</span>
<span class="cm"> * the network device layer. This is done so that we can do this without</span>
<span class="cm"> * having to sleep whilst holding the network device lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Since the recommendation from Micrel is that the RXQ is shutdown whilst the</span>
<span class="cm"> * receive parameters are programmed, we issue a write to disable the RXQ and</span>
<span class="cm"> * then wait for the interrupt handler to be triggered once the RXQ shutdown is</span>
<span class="cm"> * complete. The interrupt handler then writes the new values into the chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_rxctrl_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ks8851_net</span><span class="p">,</span> <span class="n">rxctrl_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* need to shutdown RXQ before modifying filter parameters */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_RXCR1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ks8851_rxctrl</span> <span class="n">rxctrl</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxctrl</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* interface to receive everything */</span>

		<span class="n">rxctrl</span><span class="p">.</span><span class="n">rxcr1</span> <span class="o">=</span> <span class="n">RXCR1_RXAE</span> <span class="o">|</span> <span class="n">RXCR1_RXINVF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* accept all multicast packets */</span>

		<span class="n">rxctrl</span><span class="p">.</span><span class="n">rxcr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXCR1_RXME</span> <span class="o">|</span> <span class="n">RXCR1_RXAE</span> <span class="o">|</span>
				<span class="n">RXCR1_RXPAFMA</span> <span class="o">|</span> <span class="n">RXCR1_RXMAFMA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_MULTICAST</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

		<span class="cm">/* accept some multicast */</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>  <span class="cm">/* get top six bits */</span>

			<span class="n">rxctrl</span><span class="p">.</span><span class="n">mchash</span><span class="p">[</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">rxctrl</span><span class="p">.</span><span class="n">rxcr1</span> <span class="o">=</span> <span class="n">RXCR1_RXME</span> <span class="o">|</span> <span class="n">RXCR1_RXPAFMA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* just accept broadcast / unicast */</span>
		<span class="n">rxctrl</span><span class="p">.</span><span class="n">rxcr1</span> <span class="o">=</span> <span class="n">RXCR1_RXPAFMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rxctrl</span><span class="p">.</span><span class="n">rxcr1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RXCR1_RXUE</span> <span class="o">|</span> <span class="cm">/* unicast enable */</span>
			 <span class="n">RXCR1_RXBE</span> <span class="o">|</span> <span class="cm">/* broadcast enable */</span>
			 <span class="n">RXCR1_RXE</span> <span class="o">|</span> <span class="cm">/* RX process enable */</span>
			 <span class="n">RXCR1_RXFCE</span><span class="p">);</span> <span class="cm">/* enable flow control */</span>

	<span class="n">rxctrl</span><span class="p">.</span><span class="n">rxcr2</span> <span class="o">|=</span> <span class="n">RXCR2_SRDBL_FRAME</span><span class="p">;</span>

	<span class="cm">/* schedule work to do the actual set of the data if needed */</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">statelock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxctrl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxctrl</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxctrl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxctrl</span><span class="p">));</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxctrl_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">statelock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_assign_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NET_ADDR_RANDOM</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ks8851_write_mac_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ks8851_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ks8851_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ks8851_net_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">ks8851_net_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ks8851_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ks8851_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ks8851_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ethtool support */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;KS8851&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;1.00&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ks8851_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ks8851_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* EEPROM support */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_eeprom_regread</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom_93cx6</span> <span class="o">*</span><span class="n">ee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_EEPCR</span><span class="p">);</span>

	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">reg_data_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EEPCR_EESB</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">reg_data_clock</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EEPCR_EESCK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">reg_chip_select</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EEPCR_EECS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_eeprom_regwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom_93cx6</span> <span class="o">*</span><span class="n">ee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">val</span> <span class="o">=</span> <span class="n">EEPCR_EESA</span><span class="p">;</span>	<span class="cm">/* default - eeprom access on */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">drive_data</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">EEPCR_EESRWA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">reg_data_in</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">EEPCR_EEDO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">reg_data_clock</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">EEPCR_EESCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">reg_chip_select</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">EEPCR_EECS</span><span class="p">;</span>

	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_EEPCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_eeprom_claim - claim device EEPROM and activate the interface</span>
<span class="cm"> * @ks: The network device state.</span>
<span class="cm"> *</span>
<span class="cm"> * Check for the presence of an EEPROM, and then activate software access</span>
<span class="cm"> * to the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_eeprom_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_ccr</span> <span class="o">&amp;</span> <span class="n">CCR_EEPROM</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* start with clock low, cs high */</span>
	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_EEPCR</span><span class="p">,</span> <span class="n">EEPCR_EESA</span> <span class="o">|</span> <span class="n">EEPCR_EECS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_eeprom_release - release the EEPROM interface</span>
<span class="cm"> * @ks: The device state</span>
<span class="cm"> *</span>
<span class="cm"> * Release the software access to the device EEPROM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_eeprom_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_EEPCR</span><span class="p">);</span>

	<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_EEPCR</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EEPCR_EESA</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define KS_EEPROM_MAGIC (0x00008851)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* currently only support byte writing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">KS_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ks8851_eeprom_claim</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_wren</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* ethtool currently only supports writing bytes, which means</span>
<span class="cm">	 * we have to read/modify/write our 16bit EEPROMs */</span>

	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">offset</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="o">*</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xff00</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eeprom_93cx6_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">offset</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">eeprom_93cx6_wren</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ks8851_eeprom_release</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* must be 2 byte aligned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ks8851_eeprom_claim</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">KS_EEPROM_MAGIC</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_multiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">offset</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">ks8851_eeprom_release</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* currently, we assume it is an 93C46 attached, so return 128 */</span>
	<span class="k">return</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_ccr</span> <span class="o">&amp;</span> <span class="n">CCR_EEPROM</span> <span class="o">?</span> <span class="mi">128</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ks8851_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">ks8851_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>	<span class="o">=</span> <span class="n">ks8851_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>	<span class="o">=</span> <span class="n">ks8851_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">ks8851_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">ks8851_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>	<span class="o">=</span> <span class="n">ks8851_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>	<span class="o">=</span> <span class="n">ks8851_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>	<span class="o">=</span> <span class="n">ks8851_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>	<span class="o">=</span> <span class="n">ks8851_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>	<span class="o">=</span> <span class="n">ks8851_set_eeprom</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* MII interface controls */</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_phy_reg - convert MII register into a KS8851 register</span>
<span class="cm"> * @reg: MII register number.</span>
<span class="cm"> *</span>
<span class="cm"> * Return the KS8851 register number for the corresponding MII PHY register</span>
<span class="cm"> * if possible. Return zero if the MII register has no direct mapping to the</span>
<span class="cm"> * KS8851 register set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_phy_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MII_BMCR</span>:
		<span class="k">return</span> <span class="n">KS_P1MBCR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_BMSR</span>:
		<span class="k">return</span> <span class="n">KS_P1MBSR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_PHYSID1</span>:
		<span class="k">return</span> <span class="n">KS_PHY1ILR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_PHYSID2</span>:
		<span class="k">return</span> <span class="n">KS_PHY1IHR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_ADVERTISE</span>:
		<span class="k">return</span> <span class="n">KS_P1ANAR</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_LPA</span>:
		<span class="k">return</span> <span class="n">KS_P1ANLPR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mh">0x0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_phy_read - MII interface PHY register read.</span>
<span class="cm"> * @dev: The network device the PHY is on.</span>
<span class="cm"> * @phy_addr: Address of PHY (ignored as we only have one)</span>
<span class="cm"> * @reg: The register to read.</span>
<span class="cm"> *</span>
<span class="cm"> * This call reads data from the PHY register specified in @reg. Since the</span>
<span class="cm"> * device does not support all the MII registers, the non-existent values</span>
<span class="cm"> * are always returned as zero.</span>
<span class="cm"> *</span>
<span class="cm"> * We return zero for unsupported registers as the MII code does not check</span>
<span class="cm"> * the value returned for any error status, and simply returns it to the</span>
<span class="cm"> * caller. The mii-tool that the driver was tested with takes any -ve error</span>
<span class="cm"> * as real PHY capabilities, thus displaying incorrect data to the user.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ksreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">ksreg</span> <span class="o">=</span> <span class="n">ks8851_phy_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ksreg</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* no error return allowed, so use zero */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">ksreg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ks8851_phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ksreg</span><span class="p">;</span>

	<span class="n">ksreg</span> <span class="o">=</span> <span class="n">ks8851_phy_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ksreg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ks8851_wrreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">ksreg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ks8851_read_selftest - read the selftest memory info.</span>
<span class="cm"> * @ks: The device state</span>
<span class="cm"> *</span>
<span class="cm"> * Read and check the TX/RX memory selftest information.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_read_selftest</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">both_done</span> <span class="o">=</span> <span class="n">MBIR_TXMBF</span> <span class="o">|</span> <span class="n">MBIR_RXMBF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rd</span><span class="p">;</span>

	<span class="n">rd</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_MBIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rd</span> <span class="o">&amp;</span> <span class="n">both_done</span><span class="p">)</span> <span class="o">!=</span> <span class="n">both_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Memory selftest not finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span> <span class="o">&amp;</span> <span class="n">MBIR_TXMBFA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;TX memory selftest fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span> <span class="o">&amp;</span> <span class="n">MBIR_RXMBFA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;RX memory selftest fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* driver bus management functions */</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ks8851_net_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ks8851_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ks8851_net_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ks8851_suspend NULL</span>
<span class="cp">#define ks8851_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ks8851_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">ks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cider</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ks8851_net</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ks</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">spidev</span> <span class="o">=</span> <span class="n">spi</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_space</span> <span class="o">=</span> <span class="mi">6144</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">statelock</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">ks8851_tx_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">,</span> <span class="n">ks8851_irq_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rxctrl_work</span><span class="p">,</span> <span class="n">ks8851_rxctrl_work</span><span class="p">);</span>

	<span class="cm">/* initialise pre-made spi transfer messages */</span>

	<span class="n">spi_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg1</span><span class="p">);</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg1</span><span class="p">);</span>

	<span class="n">spi_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg2</span><span class="p">);</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg2</span><span class="p">);</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_xfer2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">spi_msg2</span><span class="p">);</span>

	<span class="cm">/* setup EEPROM state */</span>

	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ks</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">PCI_EEPROM_WIDTH_93C46</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">register_read</span> <span class="o">=</span> <span class="n">ks8851_eeprom_regread</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">register_write</span> <span class="o">=</span> <span class="n">ks8851_eeprom_regwrite</span><span class="p">;</span>

	<span class="cm">/* setup mii state */</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span>	<span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span>	<span class="o">=</span> <span class="n">ks8851_phy_read</span><span class="p">;</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span>	<span class="o">=</span> <span class="n">ks8851_phy_write</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;message enable is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_enable</span><span class="p">);</span>

	<span class="cm">/* set the default message enable */</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">msg_enable</span><span class="p">,</span> <span class="p">(</span><span class="n">NETIF_MSG_DRV</span> <span class="o">|</span>
						     <span class="n">NETIF_MSG_PROBE</span> <span class="o">|</span>
						     <span class="n">NETIF_MSG_LINK</span><span class="p">));</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ks8851_ethtool_ops</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ks</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_100BASET</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ks8851_netdev_ops</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* issue a global soft reset to reset the device. */</span>
	<span class="n">ks8851_soft_reset</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">GRR_GSR</span><span class="p">);</span>

	<span class="cm">/* simple check for a valid chip being connected to the bus */</span>
	<span class="n">cider</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_CIDER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cider</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CIDER_REV_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CIDER_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read device ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* cache the contents of the CCR register for EEPROM, etc. */</span>
	<span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_ccr</span> <span class="o">=</span> <span class="n">ks8851_rdreg16</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">KS_CCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_ccr</span> <span class="o">&amp;</span> <span class="n">CCR_EEPROM</span><span class="p">)</span>
		<span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ks</span><span class="o">-&gt;</span><span class="n">eeprom_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ks8851_read_selftest</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>
	<span class="n">ks8851_init_mac</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ks8851_irq</span><span class="p">,</span> <span class="n">IRQF_TRIGGER_LOW</span><span class="p">,</span>
			  <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register network device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;revision %d, MAC %pM, IRQ %d, %s EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">CIDER_REV_GET</span><span class="p">(</span><span class="n">cider</span><span class="p">),</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		    <span class="n">ks</span><span class="o">-&gt;</span><span class="n">rc_ccr</span> <span class="o">&amp;</span> <span class="n">CCR_EEPROM</span> <span class="o">?</span> <span class="s">&quot;has&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


<span class="nl">err_netdev:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ks</span><span class="p">);</span>

<span class="nl">err_id:</span>
<span class="nl">err_irq:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ks8851_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ks8851_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_driver</span> <span class="n">ks8851_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ks8851&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ks8851_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ks8851_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ks8851_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ks8851_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ks8851_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks8851_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ks8851_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ks8851_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ks8851_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ks8851_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;KS8851 Network driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Dooks &lt;ben@simtec.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">msg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;Message verbosity level (0=none, 31=all)&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;spi:ks8851&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
