<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › emulex › benet › be_cmds.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>be_cmds.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005 - 2011 Emulex</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.  The full GNU General</span>
<span class="cm"> * Public License is included in this distribution in the file called COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;be.h&quot;</span>
<span class="cp">#include &quot;be_cmds.h&quot;</span>

<span class="cm">/* Must be a power of 2 or else MODULO will BUG_ON */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">be_get_temp_freq</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">embedded_payload</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wrb</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">embedded_payload</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_mcc_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_error</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">mccq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">DB_MCCQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_MCCQ_NUM_POSTED_SHIFT</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">DB_MCCQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* To check if valid bit is set, check the entire word as we don&#39;t know</span>
<span class="cm"> * the endianness of the data (old entry is host endian while a new entry is</span>
<span class="cm"> * little endian) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">be_mcc_compl_is_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">((</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_VALID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Need to reset the entire word that houses the valid bit */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">be_mcc_compl_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span> <span class="o">*</span><span class="nf">be_decode_resp_hdr</span><span class="p">(</span><span class="n">u32</span> <span class="n">tag0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tag1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">tag1</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">tag0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mcc_compl_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">compl_status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span> <span class="o">*</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">subsystem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Just swap the status to host endian; mcc tag is opaquely copied</span>
<span class="cm">	 * from mcc_wrb */</span>
	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">compl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">compl_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">CQE_STATUS_COMPL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">CQE_STATUS_COMPL_MASK</span><span class="p">;</span>

	<span class="n">resp_hdr</span> <span class="o">=</span> <span class="n">be_decode_resp_hdr</span><span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">tag0</span><span class="p">,</span> <span class="n">compl</span><span class="o">-&gt;</span><span class="n">tag1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
		<span class="n">subsystem</span> <span class="o">=</span> <span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">subsystem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">OPCODE_COMMON_WRITE_FLASHROM</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">OPCODE_COMMON_WRITE_OBJECT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">subsystem</span> <span class="o">==</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_status</span> <span class="o">=</span> <span class="n">compl_status</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_compl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compl_status</span> <span class="o">==</span> <span class="n">MCC_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">OPCODE_ETH_GET_STATISTICS</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">OPCODE_ETH_GET_PPORT_STATS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">subsystem</span> <span class="o">==</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">be_parse_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">OPCODE_COMMON_GET_CNTL_ADDITIONAL_ATTRIBUTES</span> <span class="o">&amp;&amp;</span>
		    <span class="n">subsystem</span> <span class="o">==</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">be_cmd_resp_get_cntl_addnl_attribs</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">resp_hdr</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">drv_stats</span><span class="p">.</span><span class="n">be_on_die_temperature</span> <span class="o">=</span>
				<span class="n">resp</span><span class="o">-&gt;</span><span class="n">on_die_temperature</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">OPCODE_COMMON_GET_CNTL_ADDITIONAL_ATTRIBUTES</span><span class="p">)</span>
			<span class="n">be_get_temp_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">compl_status</span> <span class="o">==</span> <span class="n">MCC_STATUS_NOT_SUPPORTED</span> <span class="o">||</span>
			<span class="n">compl_status</span> <span class="o">==</span> <span class="n">MCC_STATUS_ILLEGAL_REQUEST</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">compl_status</span> <span class="o">==</span> <span class="n">MCC_STATUS_UNAUTHORIZED_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;opcode %d-%d is not permitted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">opcode</span><span class="p">,</span> <span class="n">subsystem</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">CQE_STATUS_EXTD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">CQE_STATUS_EXTD_MASK</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;opcode %d-%d failed:status %d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">opcode</span><span class="p">,</span> <span class="n">subsystem</span><span class="p">,</span> <span class="n">compl_status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">compl_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Link state evt is a string of bytes; no need for endian swapping */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_async_link_state_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_async_event_link_state</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* When link status changes, link speed must be re-queried from FW */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* For the initial link status do not rely on the ASYNC event as</span>
<span class="cm">	 * it may not be received in some cases.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BE_FLAGS_LINK_STATUS_INIT</span><span class="p">)</span>
		<span class="n">be_link_status_update</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">port_link_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Grp5 CoS Priority evt */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_async_grp5_cos_priority_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_async_event_grp5_cos_priority</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_prio_bmap</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">available_priority_bmap</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recommended_prio</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VLAN_PRIO_MASK</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recommended_prio</span> <span class="o">=</span>
			<span class="n">evt</span><span class="o">-&gt;</span><span class="n">reco_default_priority</span> <span class="o">&lt;&lt;</span> <span class="n">VLAN_PRIO_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Grp5 QOS Speed evt */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_async_grp5_qos_speed_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_async_event_grp5_qos_link_speed</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">physical_port</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* qos_link_speed is in units of 10 Mbps */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">qos_link_speed</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*Grp5 PVID evt*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_async_grp5_pvid_state_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_async_event_grp5_pvid_state</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VLAN_VID_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_async_grp5_evt_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">trailer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">event_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">event_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">trailer</span> <span class="o">&gt;&gt;</span> <span class="n">ASYNC_TRAILER_EVENT_TYPE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">ASYNC_TRAILER_EVENT_TYPE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASYNC_EVENT_COS_PRIORITY</span>:
		<span class="n">be_async_grp5_cos_priority_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">be_async_event_grp5_cos_priority</span> <span class="o">*</span><span class="p">)</span><span class="n">evt</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASYNC_EVENT_QOS_SPEED</span>:
		<span class="n">be_async_grp5_qos_speed_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">be_async_event_grp5_qos_link_speed</span> <span class="o">*</span><span class="p">)</span><span class="n">evt</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASYNC_EVENT_PVID_STATE</span>:
		<span class="n">be_async_grp5_pvid_state_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">be_async_event_grp5_pvid_state</span> <span class="o">*</span><span class="p">)</span><span class="n">evt</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown grp5 event!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_link_state_evt</span><span class="p">(</span><span class="n">u32</span> <span class="n">trailer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">trailer</span> <span class="o">&gt;&gt;</span> <span class="n">ASYNC_TRAILER_EVENT_CODE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">ASYNC_TRAILER_EVENT_CODE_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ASYNC_EVENT_CODE_LINK_STATE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_grp5_evt</span><span class="p">(</span><span class="n">u32</span> <span class="n">trailer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">trailer</span> <span class="o">&gt;&gt;</span> <span class="n">ASYNC_TRAILER_EVENT_CODE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">ASYNC_TRAILER_EVENT_CODE_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ASYNC_EVENT_CODE_GRP_5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="nf">be_mcc_compl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mcc_cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">mcc_cq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_mcc_compl_is_new</span><span class="p">(</span><span class="n">compl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">mcc_cq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">compl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_async_mcc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_cq_lock</span><span class="p">);</span>

	<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">rearm_cq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_cq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_async_mcc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">rearm_cq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_process_mcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_obj</span> <span class="o">*</span><span class="n">mcc_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_cq_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">compl</span> <span class="o">=</span> <span class="n">be_mcc_compl_get</span><span class="p">(</span><span class="n">adapter</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_ASYNC_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Interpret flags as an async trailer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_link_state_evt</span><span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">be_async_link_state_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">be_async_event_link_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">compl</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_grp5_evt</span><span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">be_async_grp5_evt_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_COMPLETED_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_compl_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcc_obj</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">be_mcc_compl_use</span><span class="p">(</span><span class="n">compl</span><span class="p">);</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
		<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mcc_obj</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mcc_obj</span><span class="o">-&gt;</span><span class="n">rearm_cq</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_cq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait till no more pending mcc requests are present */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mcc_wait_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define mcc_timeout		120000 </span><span class="cm">/* 12s timeout */</span><span class="cp"></span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_obj</span> <span class="o">*</span><span class="n">mcc_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mcc_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be_error</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">be_process_mcc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcc_obj</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">mcc_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_timeout</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Notify MCC requests and wait for completion */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mcc_notify_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_obj</span> <span class="o">*</span><span class="n">mcc_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mcc_obj</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>

	<span class="n">index_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="n">mcc_obj</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_index_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcc_obj</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="n">be_decode_resp_hdr</span><span class="p">(</span><span class="n">wrb</span><span class="o">-&gt;</span><span class="n">tag0</span><span class="p">,</span> <span class="n">wrb</span><span class="o">-&gt;</span><span class="n">tag1</span><span class="p">);</span>

	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_wait_compl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mbox_db_ready_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">msecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ready</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be_error</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">ready</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ready</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">ready</span> <span class="o">&amp;=</span> <span class="n">MPU_MAILBOX_DB_RDY_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ready</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msecs</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_timeout</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">be_detect_dump_ue</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">msecs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert the mailbox address into the doorbell in two steps</span>
<span class="cm"> * Polls on the mbox doorbell till a command completion (or a timeout) occurs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mbox_notify_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">MPU_MAILBOX_DB_OFFSET</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_mailbox</span> <span class="o">*</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">;</span>

	<span class="cm">/* wait for ready to be set */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_db_ready_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">MPU_MAILBOX_DB_HI_MASK</span><span class="p">;</span>
	<span class="cm">/* at bits 2 - 31 place mbox dma addr msb bits 34 - 63 */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="cm">/* wait for ready to be set */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_db_ready_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* at bits 2 - 31 place mbox dma addr lsb bits 4 - 33 */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_db_ready_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* A cq entry has been made now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_mcc_compl_is_new</span><span class="p">(</span><span class="n">compl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_compl_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">);</span>
		<span class="n">be_mcc_compl_use</span><span class="p">(</span><span class="n">compl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid mailbox completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_POST_stage_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">sem</span>  <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">MPU_EP_SEMAPHORE_IF_TYPE2_OFFSET</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sem</span>  <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">+</span> <span class="n">MPU_EP_SEMAPHORE_OFFSET</span><span class="p">);</span>

	<span class="o">*</span><span class="n">stage</span> <span class="o">=</span> <span class="n">sem</span> <span class="o">&amp;</span> <span class="n">EP_SEMAPHORE_POST_STAGE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sem</span> <span class="o">&gt;&gt;</span> <span class="n">EP_SEMAPHORE_POST_ERR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EP_SEMAPHORE_POST_ERR_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_POST</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">stage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_POST_stage_get</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;POST error; stage=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stage</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">!=</span> <span class="n">POST_STAGE_ARMFW_RDY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting for POST aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">timeout</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;POST timeout; stage=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stage</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">be_sge</span> <span class="o">*</span><span class="nf">nonembedded_sgl</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">wrb</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/* Don&#39;t touch the hdr after it&#39;s prepared */</span>
<span class="cm">/* mem will be NULL for embedded commands */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_hdr</span> <span class="o">*</span><span class="n">req_hdr</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">subsystem</span><span class="p">,</span> <span class="n">u8</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_sge</span> <span class="o">*</span><span class="n">sge</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">req_hdr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">req_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">subsystem</span> <span class="o">=</span> <span class="n">subsystem</span><span class="p">;</span>
	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req_hdr</span><span class="p">));</span>
	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">tag0</span> <span class="o">=</span> <span class="n">req_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">tag1</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">req_addr</span><span class="p">);</span>

	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">payload_length</span> <span class="o">=</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">embedded</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="n">MCC_WRB_SGE_CNT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">MCC_WRB_SGE_CNT_SHIFT</span><span class="p">;</span>
		<span class="n">sge</span> <span class="o">=</span> <span class="n">nonembedded_sgl</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">sge</span><span class="o">-&gt;</span><span class="n">pa_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
		<span class="n">sge</span><span class="o">-&gt;</span><span class="n">pa_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">sge</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">embedded</span> <span class="o">|=</span> <span class="n">MCC_WRB_EMBEDDED_MASK</span><span class="p">;</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span> <span class="o">*</span><span class="n">pages</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max_pages</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf_pages</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span> <span class="n">max_pages</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma</span><span class="p">));</span>
		<span class="n">dma</span> <span class="o">+=</span> <span class="n">PAGE_SIZE_4K</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Converts interrupt delay in microseconds to multiplier value */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">eq_delay_to_mult</span><span class="p">(</span><span class="n">u32</span> <span class="n">usec_delay</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define MAX_INTR_RATE			651042</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">round</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">multiplier</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usec_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">interrupt_rate</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="n">usec_delay</span><span class="p">;</span>
		<span class="cm">/* Max delay, corresponding to the lowest interrupt rate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_INTR_RATE</span> <span class="o">-</span> <span class="n">interrupt_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">round</span><span class="p">;</span>
			<span class="n">multiplier</span> <span class="o">/=</span> <span class="n">interrupt_rate</span><span class="p">;</span>
			<span class="cm">/* Round the multiplier to the closest value.*/</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">+</span> <span class="n">round</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">round</span><span class="p">;</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">multiplier</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">1023</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">multiplier</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="nf">wrb_from_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span>
		<span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span> <span class="o">*</span><span class="p">)(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">wrb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">wrb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="nf">wrb_from_mccq</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mccq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of MCCQ wrbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">mccq</span><span class="p">);</span>
	<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">mccq</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">wrb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tell fw we&#39;re about to start firing cmds by writing a</span>
<span class="cm"> * special pattern across the wrb hdr; uses mbox</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">be_cmd_fw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x56</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tell fw we&#39;re done with firing cmds by writing a</span>
<span class="cm"> * special pattern across the wrb hdr; uses mbox</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">be_cmd_fw_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xBB</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xCC</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xDD</span><span class="p">;</span>
	<span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">be_cmd_eq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eq_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_eq_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_EQ_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span>  <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* 4byte eqe*/</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
			<span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">/</span><span class="mi">256</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">delaymult</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
			<span class="n">eq_delay_to_mult</span><span class="p">(</span><span class="n">eq_delay</span><span class="p">));</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_eq_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">eq_id</span><span class="p">);</span>
		<span class="n">eq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Use MCC */</span>
<span class="kt">int</span> <span class="nf">be_cmd_mac_addr_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">permanent</span><span class="p">,</span> <span class="n">u32</span> <span class="n">if_handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pmac_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_mac_query</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_NTWK_MAC_QUERY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">permanent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">permanent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">if_handle</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">pmac_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pmac_id</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">permanent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_mac_query</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous MCCQ */</span>
<span class="kt">int</span> <span class="nf">be_cmd_pmac_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">if_id</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_pmac_add</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_NTWK_PMAC_ADD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">if_id</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_pmac_add</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pmac_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	 <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MCC_STATUS_UNAUTHORIZED_REQUEST</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous MCCQ */</span>
<span class="kt">int</span> <span class="nf">be_cmd_pmac_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">if_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pmac_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_pmac_del</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_NTWK_PMAC_DEL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">dom</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">if_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pmac_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pmac_id</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses Mbox */</span>
<span class="kt">int</span> <span class="nf">be_cmd_cq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_delay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">coalesce_wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_cq_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_CQ_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span>  <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 1 for 4K */</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_lancer</span><span class="p">,</span> <span class="n">nodelay</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
								<span class="n">no_delay</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_lancer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
						<span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">/</span><span class="mi">256</span><span class="p">));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_lancer</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_lancer</span><span class="p">,</span> <span class="n">eventable</span><span class="p">,</span>
								<span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_lancer</span><span class="p">,</span> <span class="n">eqid</span><span class="p">,</span>
								<span class="n">ctxt</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_be</span><span class="p">,</span> <span class="n">coalescwm</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
								<span class="n">coalesce_wm</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_be</span><span class="p">,</span> <span class="n">nodelay</span><span class="p">,</span>
								<span class="n">ctxt</span><span class="p">,</span> <span class="n">no_delay</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_be</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
						<span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">/</span><span class="mi">256</span><span class="p">));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_be</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_be</span><span class="p">,</span> <span class="n">eventable</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context_be</span><span class="p">,</span> <span class="n">eqid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_cq_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">be_encoded_q_len</span><span class="p">(</span><span class="kt">int</span> <span class="n">q_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len_encoded</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">q_len</span><span class="p">);</span> <span class="cm">/* log2(len) + 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len_encoded</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">len_encoded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len_encoded</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_mccq_ext_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_mcc_ext_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_MCC_CREATE_EXT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cq_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_lancer</span><span class="p">,</span> <span class="n">ring_size</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
						<span class="n">be_encoded_q_len</span><span class="p">(</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_lancer</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_lancer</span><span class="p">,</span> <span class="n">async_cq_id</span><span class="p">,</span>
								<span class="n">ctxt</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_lancer</span><span class="p">,</span> <span class="n">async_cq_valid</span><span class="p">,</span>
								 <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_be</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_be</span><span class="p">,</span> <span class="n">ring_size</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
						<span class="n">be_encoded_q_len</span><span class="p">(</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_be</span><span class="p">,</span> <span class="n">cq_id</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Subscribe to Link State and Group 5 Events(bits 1 and 5 set) */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">async_event_bitmap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000022</span><span class="p">);</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_mcc_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">mccq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">mccq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_mccq_org_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_mcc_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_MCC_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_be</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_be</span><span class="p">,</span> <span class="n">ring_size</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
			<span class="n">be_encoded_q_len</span><span class="p">(</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context_be</span><span class="p">,</span> <span class="n">cq_id</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_mcc_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">mccq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">mccq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_mccq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_mccq_ext_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mccq</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Upgrade to F/W ver 2.102.235.0 &quot;</span>
			<span class="s">&quot;or newer to avoid conflicting priorities between NIC &quot;</span>
			<span class="s">&quot;and FCoE traffic&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_mccq_org_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mccq</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_txq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_eth_tx_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
		<span class="n">OPCODE_ETH_TX_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_tx_context</span><span class="p">,</span> <span class="n">if_id</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ulp_num</span> <span class="o">=</span> <span class="n">BE_ULP1_NUM</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BE_ETH_TX_RING_TYPE_STANDARD</span><span class="p">;</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_tx_context</span><span class="p">,</span> <span class="n">tx_ring_size</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		<span class="n">be_encoded_q_len</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_tx_context</span><span class="p">,</span> <span class="n">ctx_valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_tx_context</span><span class="p">,</span> <span class="n">cq_id_send</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_eth_tx_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses MCC */</span>
<span class="kt">int</span> <span class="nf">be_cmd_rxq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rxq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cq_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">frag_size</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">if_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rss</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rss_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_eth_rx_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
				<span class="n">OPCODE_ETH_RX_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cq_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">frag_size</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">frag_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">interface_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">if_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">BE_MAX_JUMBO_FRAME_SIZE</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rss_queue</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rss</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_eth_rx_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rss_id</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">rss_id</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Generic destroyer function for all types of queues</span>
<span class="cm"> * Uses Mbox</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">be_cmd_q_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">queue_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_q_destroy</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subsys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">queue_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QTYPE_EQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_EQ_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_CQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_CQ_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_TXQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_ETH_TX_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_RXQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_ETH_RX_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_MCCQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_MCC_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">subsys</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses MCC */</span>
<span class="kt">int</span> <span class="nf">be_cmd_rxq_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_q_destroy</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
			<span class="n">OPCODE_ETH_RX_DESTROY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create an rx filtering policy configuration on an i/f</span>
<span class="cm"> * Uses MCCQ</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">be_cmd_if_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap_flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">en_flags</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">if_handle</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_if_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_NTWK_INTERFACE_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">capability_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cap_flags</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">enable_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">en_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">pmac_invalid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_if_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="o">*</span><span class="n">if_handle</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">interface_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pmac_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses MCCQ */</span>
<span class="kt">int</span> <span class="nf">be_cmd_if_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interface_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_if_destroy</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interface_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_NTWK_INTERFACE_DESTROY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">interface_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">interface_id</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get stats is a non embedded command: the request is not embedded inside</span>
<span class="cm"> * WRB but is a separate dma memory block</span>
<span class="cm"> * Uses asynchronous MCC</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">nonemb_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MODULO</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_counter</span><span class="p">,</span> <span class="n">be_get_temp_freq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">be_cmd_get_die_temperature</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nonemb_cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
		<span class="n">OPCODE_ETH_GET_STATISTICS</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN3</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd_sent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Lancer Stats */</span>
<span class="kt">int</span> <span class="nf">lancer_cmd_get_pport_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">nonemb_cmd</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lancer_cmd_req_pport_stats</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">nonemb_cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
			<span class="n">OPCODE_ETH_GET_PPORT_STATS</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span>
			<span class="n">nonemb_cmd</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">pport_num</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hba_port_num</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">reset_stats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd_sent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_link_status_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_speed</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="o">*</span><span class="n">link_speed</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">link_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_link_status</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">LINK_DOWN</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_NTWK_LINK_STATUS_QUERY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN3</span> <span class="o">||</span> <span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">dom</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_link_status</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">mac_speed</span> <span class="o">!=</span> <span class="n">PHY_LINK_SPEED_ZERO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link_speed</span><span class="p">)</span>
				<span class="o">*</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">link_speed</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac_speed</span><span class="p">)</span>
				<span class="o">*</span><span class="n">mac_speed</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">mac_speed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_status</span><span class="p">)</span>
			<span class="o">*</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">logical_link_status</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_die_temperature</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_cntl_addnl_attribs</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_GET_CNTL_ADDITIONAL_ATTRIBUTES</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span>
		<span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_reg_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">log_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_fat</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_MANAGE_FAT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">fat_operation</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">QUERY_FAT</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_get_fat</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">log_size</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">log_size</span><span class="p">)</span>
			<span class="o">*</span><span class="n">log_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">log_size</span><span class="p">)</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_cmd_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">get_fat_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_fat</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span>
				<span class="n">log_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">total_size</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_get_fat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Memory allocation failure while retrieving FAT data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">total_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">60</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
		<span class="n">total_size</span> <span class="o">-=</span> <span class="n">buf_size</span><span class="p">;</span>

		<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>

		<span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_get_fat</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf_size</span><span class="p">;</span>
		<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
				<span class="n">OPCODE_COMMON_MANAGE_FAT</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">get_fat_cmd</span><span class="p">);</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">fat_operation</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RETRIEVE_FAT</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">read_log_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">log_offset</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">read_log_length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf_size</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">data_buffer_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf_size</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">be_cmd_resp_get_fat</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">resp</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">read_log_length</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FAT Table Retrieve error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">buf_size</span><span class="p">;</span>
		<span class="n">log_offset</span> <span class="o">+=</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			<span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			<span class="n">get_fat_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_ver</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">fw_on_flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_fw_version</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_GET_FW_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_get_fw_version</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">fw_ver</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">firmware_version_string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_on_flash</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">fw_on_flash</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">fw_on_flash_version_string</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set the EQ delay interval of an EQ to specified value</span>
<span class="cm"> * Uses async mcc</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">be_cmd_modify_eqd</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eq_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eqd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_modify_eq_delay</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_MODIFY_EQ_DELAY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_eq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">eq_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">eq_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delay_multiplier</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">eqd</span><span class="p">);</span>

	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses sycnhronous mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_vlan_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">if_id</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">vtag_array</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">num</span><span class="p">,</span> <span class="n">bool</span> <span class="n">untagged</span><span class="p">,</span> <span class="n">bool</span> <span class="n">promiscuous</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_vlan_config</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_NTWK_VLAN_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">interface_id</span> <span class="o">=</span> <span class="n">if_id</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="n">promiscuous</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">untagged</span> <span class="o">=</span> <span class="n">untagged</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_vlan</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">promiscuous</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">normal_vlan</span><span class="p">,</span> <span class="n">vtag_array</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_vlan</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vtag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_rx_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_filter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_rx_filter</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
				<span class="n">OPCODE_COMMON_NTWK_RX_FILTER</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span>
				<span class="n">wrb</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_flags_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BE_IF_FLAGS_PROMISCUOUS</span> <span class="o">|</span>
					<span class="n">BE_IF_FLAGS_VLAN_PROMISCUOUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">ON</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BE_IF_FLAGS_PROMISCUOUS</span> <span class="o">|</span>
						<span class="n">BE_IF_FLAGS_VLAN_PROMISCUOUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_flags_mask</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BE_IF_FLAGS_MCAST_PROMISCUOUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_flags_mask</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BE_IF_FLAGS_MULTICAST</span><span class="p">);</span>

		<span class="cm">/* Reset mcast promisc mode if already set by setting mask</span>
<span class="cm">		 * and not setting flags field</span>
<span class="cm">		 */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_flags_mask</span> <span class="o">|=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BE_IF_FLAGS_MCAST_PROMISCUOUS</span><span class="p">);</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">mcast_num</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mcast_mac</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">byte</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchrounous mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_set_flow_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_fc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_set_flow_control</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_SET_FLOW_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tx_flow_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">tx_fc</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rx_flow_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">rx_fc</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses sycn mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_flow_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_fc</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_flow_control</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_GET_FLOW_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_get_flow_control</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span>
						<span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tx_fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">tx_flow_control</span><span class="p">);</span>
		<span class="o">*</span><span class="n">rx_fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rx_flow_control</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses mbox */</span>
<span class="kt">int</span> <span class="nf">be_cmd_query_fw_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">port_num</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_query_fw_cfg</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_QUERY_FIRMWARE_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_query_fw_cfg</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="o">*</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">phys_port</span><span class="p">);</span>
		<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">function_mode</span><span class="p">);</span>
		<span class="o">*</span><span class="n">caps</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">function_caps</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses mbox */</span>
<span class="kt">int</span> <span class="nf">be_cmd_reset_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_hdr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_FUNCTION_RESET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_rss_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rsstable</span><span class="p">,</span> <span class="n">u16</span> <span class="n">table_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_rss_config</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">myhash</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x15d43fa5</span><span class="p">,</span> <span class="mh">0x2534685a</span><span class="p">,</span> <span class="mh">0x5f87693a</span><span class="p">,</span> <span class="mh">0x5668494e</span><span class="p">,</span>
			<span class="mh">0x33cf6a53</span><span class="p">,</span> <span class="mh">0x383334c6</span><span class="p">,</span> <span class="mh">0x76ac4257</span><span class="p">,</span> <span class="mh">0x59b242b2</span><span class="p">,</span>
			<span class="mh">0x3ea83c02</span><span class="p">,</span> <span class="mh">0x4a110304</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
		<span class="n">OPCODE_ETH_RSS_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">if_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">enable_rss</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RSS_ENABLE_TCP_IPV4</span> <span class="o">|</span> <span class="n">RSS_ENABLE_IPV4</span> <span class="o">|</span>
				      <span class="n">RSS_ENABLE_TCP_IPV6</span> <span class="o">|</span> <span class="n">RSS_ENABLE_IPV6</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cpu_table_size_log2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fls</span><span class="p">(</span><span class="n">table_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cpu_table</span><span class="p">,</span> <span class="n">rsstable</span><span class="p">,</span> <span class="n">table_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">myhash</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">myhash</span><span class="p">));</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses sync mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_set_beacon_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_num</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">bcn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sts</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_enable_disable_beacon</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_ENABLE_DISABLE_BEACON</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">beacon_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">beacon_duration</span> <span class="o">=</span> <span class="n">bcn</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status_duration</span> <span class="o">=</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses sync mcc */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_beacon_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_num</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_beacon_state</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_GET_BEACON_STATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_get_beacon_state</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span>
						<span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">beacon_state</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lancer_cmd_write_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_offset</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj_name</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">data_written</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addn_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lancer_cmd_req_write_object</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lancer_cmd_resp_write_object</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
				<span class="n">OPCODE_COMMON_WRITE_OBJECT</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lancer_cmd_req_write_object</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_lancer_write_obj_context</span><span class="p">,</span>
			<span class="n">write_length</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_lancer_write_obj_context</span><span class="p">,</span>
				<span class="n">eof</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_lancer_write_obj_context</span><span class="p">,</span>
				<span class="n">eof</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">write_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_offset</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">object_name</span><span class="p">,</span> <span class="n">obj_name</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">descriptor_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">addr_low</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lancer_cmd_req_write_object</span><span class="p">))</span>
				<span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">addr_high</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lancer_cmd_req_write_object</span><span class="p">)));</span>

	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_compl</span><span class="p">,</span>
					 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">30000</span><span class="p">)))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_status</span><span class="p">;</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data_written</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">actual_write_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">addn_status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">additional_status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lancer_cmd_read_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_offset</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj_name</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">data_read</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addn_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lancer_cmd_req_read_object</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lancer_cmd_resp_read_object</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_READ_OBJECT</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lancer_cmd_req_read_object</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">desired_read_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">read_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_offset</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">object_name</span><span class="p">,</span> <span class="n">obj_name</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">descriptor_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">addr_low</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">addr_high</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data_read</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">actual_read_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">addn_status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">additional_status</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_write_flashrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">flash_type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flash_opcode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_write_flashrom</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_WRITE_FLASHROM</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">op_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flash_type</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flash_opcode</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_buf_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf_size</span><span class="p">);</span>

	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_compl</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">40000</span><span class="p">)))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_get_flash_crc</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">flashed_crc</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_write_flashrom</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_READ_FLASHROM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">op_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">OPTYPE_REDBOOT</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FLASHROM_OPER_REPORT</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_buf_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x4</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">flashed_crc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_enable_magic_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">nonemb_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_acpi_wol_magic_config</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">nonemb_cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
		<span class="n">OPCODE_ETH_ACPI_WOL_MAGIC_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span>
		<span class="n">nonemb_cmd</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">magic_mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_set_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_num</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">loopback_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_set_lmode</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_LOWLEVEL</span><span class="p">,</span>
			<span class="n">OPCODE_LOWLEVEL_SET_LOOPBACK_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">src_port</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dest_port</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">loopback_type</span> <span class="o">=</span> <span class="n">loopback_type</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">loopback_state</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_loopback_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_num</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">loopback_type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pkt_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num_pkts</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_loopback_test</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_LOWLEVEL</span><span class="p">,</span>
			<span class="n">OPCODE_LOWLEVEL_LOOPBACK_TEST</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">pattern</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">src_port</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">port_num</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dest_port</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">port_num</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pkt_size</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pkts</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">num_pkts</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">loopback_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">loopback_type</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_loopback_test</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_ddr_dma_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pattern</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_ddrdma_test</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_LOWLEVEL</span><span class="p">,</span>
			<span class="n">OPCODE_LOWLEVEL_HOST_DDR_DMA</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">pattern</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">byte_cnt</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">byte_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_buff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pattern</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_ddrdma_test</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rcv_buff</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_buff</span><span class="p">,</span> <span class="n">byte_cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">resp</span><span class="o">-&gt;</span><span class="n">snd_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_get_seeprom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">nonemb_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_seeprom_read</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_sge</span> <span class="o">*</span><span class="n">sge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">nonemb_cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="n">sge</span> <span class="o">=</span> <span class="n">nonembedded_sgl</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_SEEPROM_READ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span>
			<span class="n">nonemb_cmd</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_get_phy_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_phy_info</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_get_phy_info</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_GET_PHY_DETAILS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span>
			<span class="n">wrb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_phy_info</span> <span class="o">*</span><span class="n">resp_phy_info</span> <span class="o">=</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_hdr</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp_phy_info</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">interface_type</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp_phy_info</span><span class="o">-&gt;</span><span class="n">interface_type</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">auto_speeds_supported</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp_phy_info</span><span class="o">-&gt;</span><span class="n">auto_speeds_supported</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">fixed_speeds_supported</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp_phy_info</span><span class="o">-&gt;</span><span class="n">fixed_speeds_supported</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">misc_params</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp_phy_info</span><span class="o">-&gt;</span><span class="n">misc_params</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_set_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bps</span><span class="p">,</span> <span class="n">u32</span> <span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_set_qos</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_SET_QOS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">valid_bits</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BE_QOS_BITS_NIC</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">max_bps_nic</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bps</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_get_cntl_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_cntl_attribs</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_resp_cntl_attribs</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">mgmt_controller_attrib</span> <span class="o">*</span><span class="n">attribs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">attribs_cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attribs_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dma_mem</span><span class="p">));</span>
	<span class="n">attribs_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_cntl_attribs</span><span class="p">);</span>
	<span class="n">attribs_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">attribs_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">attribs_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attribs_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Memory allocation failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">attribs_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			 <span class="n">OPCODE_COMMON_GET_CNTL_ATTRIBUTES</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">attribs_cmd</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attribs</span> <span class="o">=</span> <span class="n">attribs_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hba_port_num</span> <span class="o">=</span> <span class="n">attribs</span><span class="o">-&gt;</span><span class="n">hba_attribs</span><span class="p">.</span><span class="n">phy_port</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">attribs_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">attribs_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
					<span class="n">attribs_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses mbox */</span>
<span class="kt">int</span> <span class="nf">be_cmd_req_native_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_set_func_cap</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_SET_DRIVER_FUNCTION_CAP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">valid_cap_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CAPABILITY_SW_TIMESTAMPS</span> <span class="o">|</span>
				<span class="n">CAPABILITY_BE3_NATIVE_ERX_API</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cap_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CAPABILITY_BE3_NATIVE_ERX_API</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_set_func_cap</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">be3_native</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">CAPABILITY_BE3_NATIVE_ERX_API</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous MCCQ */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_mac_from_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">domain</span><span class="p">,</span>
			<span class="n">bool</span> <span class="o">*</span><span class="n">pmac_id_active</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_mac_list</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mac_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">get_mac_list_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">get_mac_list_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dma_mem</span><span class="p">));</span>
	<span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_get_mac_list</span><span class="p">);</span>
	<span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Memory allocation failure during GET_MAC_LIST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
				<span class="n">OPCODE_COMMON_GET_MAC_LIST</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span>
				<span class="n">wrb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">get_mac_list_cmd</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_ADDRESS_TYPE_NETWORK</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">perm_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_get_mac_list</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span>
						<span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
		<span class="n">mac_count</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">true_mac_count</span> <span class="o">+</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">pseudo_mac_count</span><span class="p">;</span>
		<span class="cm">/* Mac list returned could contain one or more active mac_ids</span>
<span class="cm">		 * or one or more pseudo permanant mac addresses. If an active</span>
<span class="cm">		 * mac_id is present, return first active mac_id found</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mac_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">get_list_macaddr</span> <span class="o">*</span><span class="n">mac_entry</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">mac_addr_size</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">mac_id</span><span class="p">;</span>

			<span class="n">mac_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">macaddr_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mac_addr_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mac_entry</span><span class="o">-&gt;</span><span class="n">mac_addr_size</span><span class="p">);</span>
			<span class="cm">/* mac_id is a 32 bit value and mac_addr size</span>
<span class="cm">			 * is 6 bytes</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">pmac_id_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">mac_id</span> <span class="o">=</span> <span class="n">mac_entry</span><span class="o">-&gt;</span><span class="n">mac_addr_id</span><span class="p">.</span><span class="n">s_mac_id</span><span class="p">.</span><span class="n">mac_id</span><span class="p">;</span>
				<span class="o">*</span><span class="n">pmac_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mac_id</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* If no active mac_id found, return first pseudo mac addr */</span>
		<span class="o">*</span><span class="n">pmac_id_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">macaddr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr_id</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span>
								<span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			<span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">get_mac_list_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Uses synchronous MCCQ */</span>
<span class="kt">int</span> <span class="nf">be_cmd_set_mac_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_array</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">mac_count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_set_mac_list</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dma_mem</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_set_mac_list</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
				<span class="n">OPCODE_COMMON_SET_MAC_LIST</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span>
				<span class="n">wrb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mac_count</span> <span class="o">=</span> <span class="n">mac_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_count</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac_array</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="o">*</span><span class="n">mac_count</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_set_hsw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pvid</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">domain</span><span class="p">,</span> <span class="n">u16</span> <span class="n">intf_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_set_hsw_config</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_SET_HSW_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_set_hsw_context</span><span class="p">,</span> <span class="n">interface_id</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">intf_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_set_hsw_context</span><span class="p">,</span> <span class="n">pvid_valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_set_hsw_context</span><span class="p">,</span> <span class="n">pvid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">pvid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get Hyper switch config */</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_hsw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pvid</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">domain</span><span class="p">,</span> <span class="n">u16</span> <span class="n">intf_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_hsw_config</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_GET_HSW_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_get_hsw_req_context</span><span class="p">,</span> <span class="n">interface_id</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
								<span class="n">intf_id</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_get_hsw_req_context</span><span class="p">,</span> <span class="n">pvid_valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_get_hsw_config</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span>
						<span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_get_hsw_resp_context</span><span class="p">,</span>
							<span class="n">pvid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pvid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vid</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_get_acpi_wol_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_acpi_wol_magic_config_v1</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dma_mem</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_acpi_wol_magic_config_v1</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Memory allocation failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ETH</span><span class="p">,</span>
			       <span class="n">OPCODE_ETH_ACPI_WOL_MAGIC_CONFIG</span><span class="p">,</span>
			       <span class="n">payload_len</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">query_options</span> <span class="o">=</span> <span class="n">BE_GET_WOL_CAP</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_acpi_wol_magic_config_v1</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_acpi_wol_magic_config_v1</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>

		<span class="cm">/* the command could succeed misleadingly on old f/w</span>
<span class="cm">		 * which is not aware of the V1 version. fake an error. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">response_length</span> <span class="o">&lt;</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol_cap</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">wol_settings</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>
<span class="kt">int</span> <span class="nf">be_cmd_get_ext_fat_capabilites</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_get_ext_fat_caps</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			       <span class="n">OPCODE_COMMON_GET_EXT_FAT_CAPABILITES</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">parameter_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_set_ext_fat_capabilites</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">be_fat_conf_params</span> <span class="o">*</span><span class="n">configs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_set_ext_fat_caps</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">set_params</span><span class="p">,</span> <span class="n">configs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_fat_conf_params</span><span class="p">));</span>
	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			       <span class="n">OPCODE_COMMON_SET_EXT_FAT_CAPABILITES</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_roce_mcc_cmd</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">netdev_handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">wrb_payload</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">wrb_payload_size</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">cmd_status</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ext_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev_handle</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrb_payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_hdr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>

	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mccq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="n">be_wrb_cmd_hdr_prepare</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">subsystem</span><span class="p">,</span>
			       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">wrb_payload_size</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">wrb_payload</span><span class="p">,</span> <span class="n">wrb_payload_size</span><span class="p">);</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">wrb_payload_size</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_notify_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ext_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrb_payload</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">response_length</span><span class="p">);</span>
	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">wrb_payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">response_length</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">be_roce_mcc_cmd</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
