<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › emulex › benet › be.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>be.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005 - 2011 Emulex</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.  The full GNU General</span>
<span class="cm"> * Public License is included in this distribution in the file called COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> */</span>

<span class="cp">#ifndef BE_H</span>
<span class="cp">#define BE_H</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/u64_stats_sync.h&gt;</span>

<span class="cp">#include &quot;be_hw.h&quot;</span>
<span class="cp">#include &quot;be_roce.h&quot;</span>

<span class="cp">#define DRV_VER			&quot;4.2.220u&quot;</span>
<span class="cp">#define DRV_NAME		&quot;be2net&quot;</span>
<span class="cp">#define BE_NAME			&quot;ServerEngines BladeEngine2 10Gbps NIC&quot;</span>
<span class="cp">#define BE3_NAME		&quot;ServerEngines BladeEngine3 10Gbps NIC&quot;</span>
<span class="cp">#define OC_NAME			&quot;Emulex OneConnect 10Gbps NIC&quot;</span>
<span class="cp">#define OC_NAME_BE		OC_NAME	&quot;(be3)&quot;</span>
<span class="cp">#define OC_NAME_LANCER		OC_NAME &quot;(Lancer)&quot;</span>
<span class="cp">#define OC_NAME_SH		OC_NAME &quot;(Skyhawk)&quot;</span>
<span class="cp">#define DRV_DESC		&quot;ServerEngines BladeEngine 10Gbps NIC Driver&quot;</span>

<span class="cp">#define BE_VENDOR_ID 		0x19a2</span>
<span class="cp">#define EMULEX_VENDOR_ID	0x10df</span>
<span class="cp">#define BE_DEVICE_ID1		0x211</span>
<span class="cp">#define BE_DEVICE_ID2		0x221</span>
<span class="cp">#define OC_DEVICE_ID1		0x700	</span><span class="cm">/* Device Id for BE2 cards */</span><span class="cp"></span>
<span class="cp">#define OC_DEVICE_ID2		0x710	</span><span class="cm">/* Device Id for BE3 cards */</span><span class="cp"></span>
<span class="cp">#define OC_DEVICE_ID3		0xe220	</span><span class="cm">/* Device id for Lancer cards */</span><span class="cp"></span>
<span class="cp">#define OC_DEVICE_ID4           0xe228   </span><span class="cm">/* Device id for VF in Lancer */</span><span class="cp"></span>
<span class="cp">#define OC_DEVICE_ID5		0x720	</span><span class="cm">/* Device Id for Skyhawk cards */</span><span class="cp"></span>
<span class="cp">#define OC_SUBSYS_DEVICE_ID1	0xE602</span>
<span class="cp">#define OC_SUBSYS_DEVICE_ID2	0xE642</span>
<span class="cp">#define OC_SUBSYS_DEVICE_ID3	0xE612</span>
<span class="cp">#define OC_SUBSYS_DEVICE_ID4	0xE652</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">nic_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OC_DEVICE_ID1</span>:
		<span class="k">return</span> <span class="n">OC_NAME</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OC_DEVICE_ID2</span>:
		<span class="k">return</span> <span class="n">OC_NAME_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OC_DEVICE_ID3</span>:
	<span class="k">case</span> <span class="n">OC_DEVICE_ID4</span>:
		<span class="k">return</span> <span class="n">OC_NAME_LANCER</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_DEVICE_ID2</span>:
		<span class="k">return</span> <span class="n">BE3_NAME</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OC_DEVICE_ID5</span>:
		<span class="k">return</span> <span class="n">OC_NAME_SH</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">BE_NAME</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Number of bytes of an RX frame that are copied to skb-&gt;data */</span>
<span class="cp">#define BE_HDR_LEN		((u16) 64)</span>
<span class="cm">/* allocate extra space to allow tunneling decapsulation without head reallocation */</span>
<span class="cp">#define BE_RX_SKB_ALLOC_SIZE (BE_HDR_LEN + 64)</span>

<span class="cp">#define BE_MAX_JUMBO_FRAME_SIZE	9018</span>
<span class="cp">#define BE_MIN_MTU		256</span>

<span class="cp">#define BE_NUM_VLANS_SUPPORTED	64</span>
<span class="cp">#define BE_MAX_EQD		96u</span>
<span class="cp">#define	BE_MAX_TX_FRAG_COUNT	30</span>

<span class="cp">#define EVNT_Q_LEN		1024</span>
<span class="cp">#define TX_Q_LEN		2048</span>
<span class="cp">#define TX_CQ_LEN		1024</span>
<span class="cp">#define RX_Q_LEN		1024	</span><span class="cm">/* Does not support any other value */</span><span class="cp"></span>
<span class="cp">#define RX_CQ_LEN		1024</span>
<span class="cp">#define MCC_Q_LEN		128	</span><span class="cm">/* total size not to exceed 8 pages */</span><span class="cp"></span>
<span class="cp">#define MCC_CQ_LEN		256</span>

<span class="cp">#define BE3_MAX_RSS_QS		8</span>
<span class="cp">#define BE2_MAX_RSS_QS		4</span>
<span class="cp">#define MAX_RSS_QS		BE3_MAX_RSS_QS</span>
<span class="cp">#define MAX_RX_QS		(MAX_RSS_QS + 1) </span><span class="cm">/* RSS qs + 1 def Rx */</span><span class="cp"></span>

<span class="cp">#define MAX_TX_QS		8</span>
<span class="cp">#define MAX_ROCE_EQS		5</span>
<span class="cp">#define MAX_MSIX_VECTORS	(MAX_RSS_QS + MAX_ROCE_EQS) </span><span class="cm">/* RSS qs + RoCE */</span><span class="cp"></span>
<span class="cp">#define BE_TX_BUDGET		256</span>
<span class="cp">#define BE_NAPI_WEIGHT		64</span>
<span class="cp">#define MAX_RX_POST		BE_NAPI_WEIGHT </span><span class="cm">/* Frags posted at a time */</span><span class="cp"></span>
<span class="cp">#define RX_FRAGS_REFILL_WM	(RX_Q_LEN - MAX_RX_POST)</span>

<span class="cp">#define FW_VER_LEN		32</span>

<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">dma_mem</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">entry_size</span><span class="p">;</span>	<span class="cm">/* Size of an element in the queue */</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tail</span><span class="p">,</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">created</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">used</span><span class="p">;</span>	<span class="cm">/* Number of valid elements in the queue */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">MODULO</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">limit</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">index_adv</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">MODULO</span><span class="p">((</span><span class="o">*</span><span class="n">index</span> <span class="o">+</span> <span class="n">val</span><span class="p">),</span> <span class="n">limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">index_inc</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">MODULO</span><span class="p">((</span><span class="o">*</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">queue_head_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">*</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">queue_tail_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">*</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">queue_index_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">queue_head_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">index_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">index_dec</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">MODULO</span><span class="p">((</span><span class="o">*</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">queue_tail_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">index_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="n">q</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">desc</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* Adaptive interrupt coalescing (AIC) info */</span>
	<span class="n">bool</span> <span class="n">enable_aic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">min_eqd</span><span class="p">;</span>		<span class="cm">/* in usecs */</span>
	<span class="n">u32</span> <span class="n">max_eqd</span><span class="p">;</span>		<span class="cm">/* in usecs */</span>
	<span class="n">u32</span> <span class="n">eqd</span><span class="p">;</span>		<span class="cm">/* configured val when aic is off */</span>
	<span class="n">u32</span> <span class="n">cur_eqd</span><span class="p">;</span>		<span class="cm">/* in usecs */</span>

	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>			<span class="cm">/* array index */</span>
	<span class="n">u16</span> <span class="n">tx_budget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">be_mcc_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="n">cq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rearm_cq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_tx_stats</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_pkts</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_reqs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_wrbs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_compl</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">tx_jiffies</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_stops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">u64_stats_sync</span> <span class="n">sync</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">u64_stats_sync</span> <span class="n">sync_compl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="n">cq</span><span class="p">;</span>
	<span class="cm">/* Remember the skbs that were transmitted */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sent_skb_list</span><span class="p">[</span><span class="n">TX_Q_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">be_tx_stats</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>

<span class="cm">/* Struct to remember the pages posted for rx frags */</span>
<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">page_offset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">last_page_user</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_rx_stats</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_pkts</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_pkts_prev</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">rx_jiffies</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drops_no_skbs</span><span class="p">;</span>	<span class="cm">/* skb allocation errors */</span>
	<span class="n">u32</span> <span class="n">rx_drops_no_frags</span><span class="p">;</span>	<span class="cm">/* HW has no fetched frags */</span>
	<span class="n">u32</span> <span class="n">rx_post_fail</span><span class="p">;</span>	<span class="cm">/* page post alloc failures */</span>
	<span class="n">u32</span> <span class="n">rx_compl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_mcast_pkts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_compl_err</span><span class="p">;</span>	<span class="cm">/* completions with err set */</span>
	<span class="n">u32</span> <span class="n">rx_pps</span><span class="p">;</span>		<span class="cm">/* pkts per second */</span>
	<span class="k">struct</span> <span class="n">u64_stats_sync</span> <span class="n">sync</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">rss_hash</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pkt_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxq_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vlanf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_rcvd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ipf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcpf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">udpf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ip_csum</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">l4_csum</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ipv6</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vtm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pkt_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="n">rxcp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="n">page_info_tbl</span><span class="p">[</span><span class="n">RX_Q_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">be_rx_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rss_id</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rx_post_starved</span><span class="p">;</span>	<span class="cm">/* Zero rx frags have been posted to BE */</span>
<span class="p">}</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">be_drv_stats</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">be_on_die_temperature</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eth_red_drops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drops_no_pbuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drops_no_txpb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drops_no_erx_descr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drops_no_tpre_descr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drops_too_many_frags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">forwarded_packets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_drops_mtu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_alignment_symbol_errors</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_pause_frames</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_priority_pause_frames</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_control_frames</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_in_range_errors</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_out_range_errors</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_frame_too_long</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_address_mismatch_drops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_dropped_too_small</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_dropped_too_short</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_dropped_header_too_small</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_dropped_tcp_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_dropped_runt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_ip_checksum_errs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_tcp_checksum_errs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_udp_checksum_errs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_pauseframes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_priority_pauseframes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_controlframes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxpp_fifo_overflow_drop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_input_fifo_overflow_drop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pmem_fifo_overflow_drop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">jabber_events</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">if_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmac_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">def_vid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_rate</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">vf_state</span> <span class="p">{</span>
	<span class="n">ENABLED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ASSIGNED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#define BE_FLAGS_LINK_STATUS_INIT		1</span>
<span class="cp">#define BE_FLAGS_WORKER_SCHEDULED		(1 &lt;&lt; 3)</span>
<span class="cp">#define BE_UC_PMAC_COUNT		30</span>
<span class="cp">#define BE_VF_UC_PMAC_COUNT		2</span>

<span class="k">struct</span> <span class="n">phy_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">transceiver</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fc_autoneg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">interface_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc_params</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">auto_speeds_supported</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fixed_speeds_supported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">forced_port_speed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dac_cable_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">advertising</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">supported</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">be_adapter</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">csr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>		<span class="cm">/* Door Bell */</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mbox_lock</span><span class="p">;</span> <span class="cm">/* For serializing mbox cmds to BE card */</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">mbox_mem</span><span class="p">;</span>
	<span class="cm">/* Mbox mem is adjusted to align to 16 bytes. The allocated addr</span>
<span class="cm">	 * is stored for freeing purpose */</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">mbox_mem_alloced</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">be_mcc_obj</span> <span class="n">mcc_obj</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mcc_lock</span><span class="p">;</span>	<span class="cm">/* For serializing mcc cmds to BE card */</span>
	<span class="n">spinlock_t</span> <span class="n">mcc_cq_lock</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">num_msix_vec</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_evt_qs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="n">eq_obj</span><span class="p">[</span><span class="n">MAX_MSIX_VECTORS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">msix_entries</span><span class="p">[</span><span class="n">MAX_MSIX_VECTORS</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">isr_registered</span><span class="p">;</span>

	<span class="cm">/* TX Rings */</span>
	<span class="n">u32</span> <span class="n">num_tx_qs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="n">tx_obj</span><span class="p">[</span><span class="n">MAX_TX_QS</span><span class="p">];</span>

	<span class="cm">/* Rx rings */</span>
	<span class="n">u32</span> <span class="n">num_rx_qs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="n">rx_obj</span><span class="p">[</span><span class="n">MAX_RX_QS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">big_page_size</span><span class="p">;</span>	<span class="cm">/* Compounded page size shared by rx wrbs */</span>

	<span class="n">u8</span> <span class="n">eq_next_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_drv_stats</span> <span class="n">drv_stats</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">vlans_added</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_vlans</span><span class="p">;</span>	<span class="cm">/* Number of vlans supported */</span>
	<span class="n">u8</span> <span class="n">vlan_tag</span><span class="p">[</span><span class="n">VLAN_N_VID</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">vlan_prio_bmap</span><span class="p">;</span>	<span class="cm">/* Available Priority BitMap */</span>
	<span class="n">u16</span> <span class="n">recommended_prio</span><span class="p">;</span>	<span class="cm">/* Recommended Priority */</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">rx_filter</span><span class="p">;</span> <span class="cm">/* Cmd DMA mem for rx-filter */</span>

	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">stats_cmd</span><span class="p">;</span>
	<span class="cm">/* Work queue used to perform periodic tasks like getting statistics */</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">work_counter</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/* Ethtool knobs and info */</span>
	<span class="kt">char</span> <span class="n">fw_ver</span><span class="p">[</span><span class="n">FW_VER_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">if_handle</span><span class="p">;</span>		<span class="cm">/* Used to configure filtering */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pmac_id</span><span class="p">;</span>		<span class="cm">/* MAC addr handle used by BE card */</span>
	<span class="n">u32</span> <span class="n">beacon_state</span><span class="p">;</span>	<span class="cm">/* for set_phys_id */</span>

	<span class="n">bool</span> <span class="n">eeh_err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ue_detected</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fw_timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_num</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">promiscuous</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">function_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">function_caps</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_fc</span><span class="p">;</span>		<span class="cm">/* Rx flow control */</span>
	<span class="n">u32</span> <span class="n">tx_fc</span><span class="p">;</span>		<span class="cm">/* Tx flow control */</span>
	<span class="n">bool</span> <span class="n">stats_cmd_sent</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">generation</span><span class="p">;</span>		<span class="cm">/* BladeEngine ASIC generation */</span>
	<span class="n">u32</span> <span class="n">if_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>	<span class="cm">/* Door Bell */</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">total_size</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">io_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">roce_db</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_msix_roce_vec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ocrdma_dev</span> <span class="o">*</span><span class="n">ocrdma_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">flash_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">flash_compl</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">num_vfs</span><span class="p">;</span>		<span class="cm">/* Number of VFs provisioned by PF driver */</span>
	<span class="n">u32</span> <span class="n">dev_num_vfs</span><span class="p">;</span>	<span class="cm">/* Number of VFs supported by HW */</span>
	<span class="n">u8</span> <span class="n">virtfn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">be3_native</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sli_family</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hba_port_num</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pvid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_info</span> <span class="n">phy</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wol_cap</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_pmac_cnt</span><span class="p">;</span>	<span class="cm">/* Max secondary UC MACs programmable */</span>
	<span class="n">u32</span> <span class="n">uc_macs</span><span class="p">;</span>		<span class="cm">/* Count of secondary UC MAC programmed */</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define be_physfn(adapter)		(!adapter-&gt;virtfn)</span>
<span class="cp">#define	sriov_enabled(adapter)		(adapter-&gt;num_vfs &gt; 0)</span>
<span class="cp">#define	sriov_want(adapter)		(adapter-&gt;dev_num_vfs &amp;&amp; num_vfs &amp;&amp; \</span>
<span class="cp">					 be_physfn(adapter))</span>
<span class="cp">#define for_all_vfs(adapter, vf_cfg, i)					\</span>
<span class="cp">	for (i = 0, vf_cfg = &amp;adapter-&gt;vf_cfg[i]; i &lt; adapter-&gt;num_vfs;	\</span>
<span class="cp">		i++, vf_cfg++)</span>

<span class="cm">/* BladeEngine Generation numbers */</span>
<span class="cp">#define BE_GEN2 2</span>
<span class="cp">#define BE_GEN3 3</span>

<span class="cp">#define ON				1</span>
<span class="cp">#define OFF				0</span>
<span class="cp">#define lancer_chip(adapter)	((adapter-&gt;pdev-&gt;device == OC_DEVICE_ID3) || \</span>
<span class="cp">				 (adapter-&gt;pdev-&gt;device == OC_DEVICE_ID4))</span>

<span class="cp">#define be_roce_supported(adapter) ((adapter-&gt;if_type == SLI_INTF_TYPE_3 || \</span>
<span class="cp">				adapter-&gt;sli_family == SKYHAWK_SLI_FAMILY) &amp;&amp; \</span>
<span class="cp">				(adapter-&gt;function_mode &amp; RDMA_ENABLED))</span>

<span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">be_ethtool_ops</span><span class="p">;</span>

<span class="cp">#define msix_enabled(adapter)		(adapter-&gt;num_msix_vec &gt; 0)</span>
<span class="cp">#define num_irqs(adapter)		(msix_enabled(adapter) ?	\</span>
<span class="cp">						adapter-&gt;num_msix_vec : 1)</span>
<span class="cp">#define tx_stats(txo)			(&amp;(txo)-&gt;stats)</span>
<span class="cp">#define rx_stats(rxo)			(&amp;(rxo)-&gt;stats)</span>

<span class="cm">/* The default RXQ is the last RXQ */</span>
<span class="cp">#define default_rxo(adpt)		(&amp;adpt-&gt;rx_obj[adpt-&gt;num_rx_qs - 1])</span>

<span class="cp">#define for_all_rx_queues(adapter, rxo, i)				\</span>
<span class="cp">	for (i = 0, rxo = &amp;adapter-&gt;rx_obj[i]; i &lt; adapter-&gt;num_rx_qs;	\</span>
<span class="cp">		i++, rxo++)</span>

<span class="cm">/* Skip the default non-rss queue (last one)*/</span>
<span class="cp">#define for_all_rss_queues(adapter, rxo, i)				\</span>
<span class="cp">	for (i = 0, rxo = &amp;adapter-&gt;rx_obj[i]; i &lt; (adapter-&gt;num_rx_qs - 1);\</span>
<span class="cp">		i++, rxo++)</span>

<span class="cp">#define for_all_tx_queues(adapter, txo, i)				\</span>
<span class="cp">	for (i = 0, txo = &amp;adapter-&gt;tx_obj[i]; i &lt; adapter-&gt;num_tx_qs;	\</span>
<span class="cp">		i++, txo++)</span>

<span class="cp">#define for_all_evt_queues(adapter, eqo, i)				\</span>
<span class="cp">	for (i = 0, eqo = &amp;adapter-&gt;eq_obj[i]; i &lt; adapter-&gt;num_evt_qs; \</span>
<span class="cp">		i++, eqo++)</span>

<span class="cp">#define is_mcc_eqo(eqo)			(eqo-&gt;idx == 0)</span>
<span class="cp">#define mcc_eqo(adapter)		(&amp;adapter-&gt;eq_obj[0])</span>

<span class="cp">#define PAGE_SHIFT_4K		12</span>
<span class="cp">#define PAGE_SIZE_4K		(1 &lt;&lt; PAGE_SHIFT_4K)</span>

<span class="cm">/* Returns number of pages spanned by the data starting at the given addr */</span>
<span class="cp">#define PAGES_4K_SPANNED(_address, size) 				\</span>
<span class="cp">		((u32)((((size_t)(_address) &amp; (PAGE_SIZE_4K - 1)) + 	\</span>
<span class="cp">			(size) + (PAGE_SIZE_4K - 1)) &gt;&gt; PAGE_SHIFT_4K))</span>

<span class="cm">/* Returns bit offset within a DWORD of a bitfield */</span>
<span class="cp">#define AMAP_BIT_OFFSET(_struct, field)  				\</span>
<span class="cp">		(((size_t)&amp;(((_struct *)0)-&gt;field))%32)</span>

<span class="cm">/* Returns the bit mask of the field that is NOT shifted into location. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">amap_mask</span><span class="p">(</span><span class="n">u32</span> <span class="n">bitsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">bitsize</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">?</span> <span class="mh">0xFFFFFFFF</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitsize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">amap_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dw_offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">dw_offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dw</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AMAP_SET_BITS(_struct, field, ptr, val)				\</span>
<span class="cp">		amap_set(ptr,						\</span>
<span class="cp">			offsetof(_struct, field)/32,			\</span>
<span class="cp">			amap_mask(sizeof(((_struct *)0)-&gt;field)),	\</span>
<span class="cp">			AMAP_BIT_OFFSET(_struct, field),		\</span>
<span class="cp">			val)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">amap_get</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dw_offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">dw</span> <span class="o">+</span> <span class="n">dw_offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define AMAP_GET_BITS(_struct, field, ptr)				\</span>
<span class="cp">		amap_get(ptr,						\</span>
<span class="cp">			offsetof(_struct, field)/32,			\</span>
<span class="cp">			amap_mask(sizeof(((_struct *)0)-&gt;field)),	\</span>
<span class="cp">			AMAP_BIT_OFFSET(_struct, field))</span>

<span class="cp">#define be_dws_cpu_to_le(wrb, len)	swap_dws(wrb, len)</span>
<span class="cp">#define be_dws_le_to_cpu(wrb, len)	swap_dws(wrb, len)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">swap_dws</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">wrb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dw</span> <span class="o">=</span> <span class="n">wrb</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dw</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">dw</span><span class="p">);</span>
		<span class="n">dw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* __BIG_ENDIAN */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">is_tcp_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span> <span class="o">==</span> <span class="n">NEXTHDR_TCP</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">is_udp_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span> <span class="o">==</span> <span class="n">NEXTHDR_UDP</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">be_vf_eth_addr_generate</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">jhash</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="cm">/* Use the OUI from the current MAC address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">be_multi_rxq</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_qs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">be_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span> <span class="o">||</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ue_detected</span> <span class="o">||</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">be_is_wol_excluded</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OC_SUBSYS_DEVICE_ID1</span>:
	<span class="k">case</span> <span class="n">OC_SUBSYS_DEVICE_ID2</span>:
	<span class="k">case</span> <span class="n">OC_SUBSYS_DEVICE_ID3</span>:
	<span class="k">case</span> <span class="n">OC_SUBSYS_DEVICE_ID4</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">be_type_2_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">SLI_INTF_TYPE_2</span> <span class="o">||</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">SLI_INTF_TYPE_3</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">be_cq_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">arm</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">num_popped</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">be_link_status_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_status</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">be_parse_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">be_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">func</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">bool</span> <span class="n">be_is_wol_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">bool</span> <span class="n">be_pause_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">u32</span> <span class="n">be_get_fw_log_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * internal function to initialize-cleanup roce device.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">be_roce_dev_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">be_roce_dev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * internal function to open-close roce device during ifup-ifdown.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">be_roce_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">be_roce_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#endif				</span><span class="cm">/* BE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
