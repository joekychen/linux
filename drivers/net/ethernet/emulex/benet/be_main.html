<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › emulex › benet › be_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>be_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005 - 2011 Emulex</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.  The full GNU General</span>
<span class="cm"> * Public License is included in this distribution in the file called COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;be.h&quot;</span>
<span class="cp">#include &quot;be_cmds.h&quot;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VER</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">be_dev_ids</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESC</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_VER</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;ServerEngines Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_vfs</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">num_vfs</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_vfs</span><span class="p">,</span> <span class="s">&quot;Number of PCI VFs to initialize&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">rx_frag_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_frag_size</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_frag_size</span><span class="p">,</span> <span class="s">&quot;Size of a fragment that holds rcvd data.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">be_dev_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">BE_DEVICE_ID1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">BE_DEVICE_ID2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">EMULEX_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID3</span><span class="p">)},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">EMULEX_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID4</span><span class="p">)},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">EMULEX_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID5</span><span class="p">)},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">be_dev_ids</span><span class="p">);</span>
<span class="cm">/* UE Status Low CSR */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">ue_status_low_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;CEV&quot;</span><span class="p">,</span>
	<span class="s">&quot;CTX&quot;</span><span class="p">,</span>
	<span class="s">&quot;DBUF&quot;</span><span class="p">,</span>
	<span class="s">&quot;ERX&quot;</span><span class="p">,</span>
	<span class="s">&quot;Host&quot;</span><span class="p">,</span>
	<span class="s">&quot;MPU&quot;</span><span class="p">,</span>
	<span class="s">&quot;NDMA&quot;</span><span class="p">,</span>
	<span class="s">&quot;PTC &quot;</span><span class="p">,</span>
	<span class="s">&quot;RDMA &quot;</span><span class="p">,</span>
	<span class="s">&quot;RXF &quot;</span><span class="p">,</span>
	<span class="s">&quot;RXIPS &quot;</span><span class="p">,</span>
	<span class="s">&quot;RXULP0 &quot;</span><span class="p">,</span>
	<span class="s">&quot;RXULP1 &quot;</span><span class="p">,</span>
	<span class="s">&quot;RXULP2 &quot;</span><span class="p">,</span>
	<span class="s">&quot;TIM &quot;</span><span class="p">,</span>
	<span class="s">&quot;TPOST &quot;</span><span class="p">,</span>
	<span class="s">&quot;TPRE &quot;</span><span class="p">,</span>
	<span class="s">&quot;TXIPS &quot;</span><span class="p">,</span>
	<span class="s">&quot;TXULP0 &quot;</span><span class="p">,</span>
	<span class="s">&quot;TXULP1 &quot;</span><span class="p">,</span>
	<span class="s">&quot;UC &quot;</span><span class="p">,</span>
	<span class="s">&quot;WDMA &quot;</span><span class="p">,</span>
	<span class="s">&quot;TXULP2 &quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST1 &quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_OB_LINK &quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_OB_LINK &quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST_GPIO &quot;</span><span class="p">,</span>
	<span class="s">&quot;MBOX &quot;</span><span class="p">,</span>
	<span class="s">&quot;AXGMAC0&quot;</span><span class="p">,</span>
	<span class="s">&quot;AXGMAC1&quot;</span><span class="p">,</span>
	<span class="s">&quot;JTAG&quot;</span><span class="p">,</span>
	<span class="s">&quot;MPU_INTPEND&quot;</span>
<span class="p">};</span>
<span class="cm">/* UE Status High CSR */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">ue_status_hi_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;LPCMEMHOST&quot;</span><span class="p">,</span>
	<span class="s">&quot;MGMT_MAC&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCS0ONLINE&quot;</span><span class="p">,</span>
	<span class="s">&quot;MPU_IRAM&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCS1ONLINE&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCTL0&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCTL1&quot;</span><span class="p">,</span>
	<span class="s">&quot;PMEM&quot;</span><span class="p">,</span>
	<span class="s">&quot;RR&quot;</span><span class="p">,</span>
	<span class="s">&quot;TXPB&quot;</span><span class="p">,</span>
	<span class="s">&quot;RXPP&quot;</span><span class="p">,</span>
	<span class="s">&quot;XAUI&quot;</span><span class="p">,</span>
	<span class="s">&quot;TXP&quot;</span><span class="p">,</span>
	<span class="s">&quot;ARM&quot;</span><span class="p">,</span>
	<span class="s">&quot;IPC&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST2&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST3&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST4&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST5&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST6&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST7&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST8&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST9&quot;</span><span class="p">,</span>
	<span class="s">&quot;NETC&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span>
<span class="p">};</span>

<span class="cm">/* Is BE in a multi-channel mode */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">be_is_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_mode</span> <span class="o">&amp;</span> <span class="n">FLEX10_MODE</span> <span class="o">||</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_mode</span> <span class="o">&amp;</span> <span class="n">VNIC_MODE</span> <span class="o">||</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_mode</span> <span class="o">&amp;</span> <span class="n">UMC_ENABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span>
				  <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_queue_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">entry_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">));</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_intr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_MEMBAR_CTRL_INT_CTRL_OFFSET</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MEMBAR_CTRL_INT_CTRL_HOSTINTR_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">MEMBAR_CTRL_INT_CTRL_HOSTINTR_MASK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEMBAR_CTRL_INT_CTRL_HOSTINTR_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">PCICFG_MEMBAR_CTRL_INT_CTRL_OFFSET</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_rxq_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">posted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">qid</span> <span class="o">&amp;</span> <span class="n">DB_RQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">posted</span> <span class="o">&lt;&lt;</span> <span class="n">DB_RQ_NUM_POSTED_SHIFT</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">DB_RQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_txq_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">posted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">qid</span> <span class="o">&amp;</span> <span class="n">DB_TXULP_RING_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">posted</span> <span class="o">&amp;</span> <span class="n">DB_TXULP_NUM_POSTED_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DB_TXULP_NUM_POSTED_SHIFT</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">DB_TXULP1_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_eq_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">arm</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clear_int</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_popped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">qid</span> <span class="o">&amp;</span> <span class="n">DB_EQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">qid</span> <span class="o">&amp;</span> <span class="n">DB_EQ_RING_ID_EXT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">DB_EQ_RING_ID_EXT_MASK_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arm</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_REARM_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear_int</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_CLR_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_EVNT_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">num_popped</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_NUM_POPPED_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">DB_EQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_cq_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">arm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_popped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">qid</span> <span class="o">&amp;</span> <span class="n">DB_CQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">qid</span> <span class="o">&amp;</span> <span class="n">DB_CQ_RING_ID_EXT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">DB_CQ_RING_ID_EXT_MASK_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arm</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_CQ_REARM_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">num_popped</span> <span class="o">&lt;&lt;</span> <span class="n">DB_CQ_NUM_POPPED_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">DB_CQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mac_addr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pmac_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_mac_addr_query</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">current_mac</span><span class="p">,</span>
				<span class="n">MAC_ADDRESS_TYPE_NETWORK</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">current_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_pmac_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">be_cmd_pmac_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="n">pmac_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC %pM set Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">populate_be2_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_hw_stats_v0</span> <span class="o">*</span><span class="n">hw_stats</span> <span class="o">=</span> <span class="n">hw_stats_from_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_pmem_stats</span> <span class="o">*</span><span class="n">pmem_sts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">pmem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rxf_stats_v0</span> <span class="o">*</span><span class="n">rxf_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rxf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_port_rxf_stats_v0</span> <span class="o">*</span><span class="n">port_stats</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">be_drv_stats</span> <span class="o">*</span><span class="n">drvs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">drv_stats</span><span class="p">;</span>

	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">hw_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw_stats</span><span class="p">));</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_pause_frames</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_pause_frames</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_control_frames</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_control_frames</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_runt</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_runt</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_ip_checksum_errs</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_ip_checksum_errs</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_tcp_checksum_errs</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_tcp_checksum_errs</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_udp_checksum_errs</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_udp_checksum_errs</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rxpp_fifo_overflow_drop</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_overflow</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_tcp_length</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_tcp_length</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_small</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_small</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_short</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_short</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_out_range_errors</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_out_range_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_input_fifo_overflow_drop</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_input_fifo_overflow</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_header_too_small</span> <span class="o">=</span>
		<span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_header_too_small</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_address_mismatch_drops</span> <span class="o">=</span>
					<span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_address_mismatch_drops</span> <span class="o">+</span>
					<span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_vlan_mismatch_drops</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_alignment_symbol_errors</span> <span class="o">=</span>
		<span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_alignment_symbol_errors</span><span class="p">;</span>

	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">tx_pauseframes</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">tx_pauseframes</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">tx_controlframes</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">tx_controlframes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">jabber_events</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">port1_jabber_events</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">jabber_events</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">port0_jabber_events</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_no_pbuf</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_no_pbuf</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_no_erx_descr</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_no_erx_descr</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">forwarded_packets</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">forwarded_packets</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_mtu</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_mtu</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_no_tpre_descr</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_no_tpre_descr</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_too_many_frags</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_too_many_frags</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">drv_stats</span><span class="p">.</span><span class="n">eth_red_drops</span> <span class="o">=</span> <span class="n">pmem_sts</span><span class="o">-&gt;</span><span class="n">eth_red_drops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">populate_be3_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_hw_stats_v1</span> <span class="o">*</span><span class="n">hw_stats</span> <span class="o">=</span> <span class="n">hw_stats_from_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_pmem_stats</span> <span class="o">*</span><span class="n">pmem_sts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">pmem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rxf_stats_v1</span> <span class="o">*</span><span class="n">rxf_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rxf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_port_rxf_stats_v1</span> <span class="o">*</span><span class="n">port_stats</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">be_drv_stats</span> <span class="o">*</span><span class="n">drvs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">drv_stats</span><span class="p">;</span>

	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">hw_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw_stats</span><span class="p">));</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">pmem_fifo_overflow_drop</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">pmem_fifo_overflow_drop</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_priority_pause_frames</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_priority_pause_frames</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_pause_frames</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_pause_frames</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_control_frames</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_control_frames</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_runt</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_runt</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_ip_checksum_errs</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_ip_checksum_errs</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_tcp_checksum_errs</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_tcp_checksum_errs</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_udp_checksum_errs</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_udp_checksum_errs</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_tcp_length</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_tcp_length</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_small</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_small</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_short</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_short</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_out_range_errors</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_out_range_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_header_too_small</span> <span class="o">=</span>
		<span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_header_too_small</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_input_fifo_overflow_drop</span> <span class="o">=</span>
		<span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_input_fifo_overflow_drop</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_address_mismatch_drops</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_address_mismatch_drops</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_alignment_symbol_errors</span> <span class="o">=</span>
		<span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rx_alignment_symbol_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rxpp_fifo_overflow_drop</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">rxpp_fifo_overflow_drop</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">tx_pauseframes</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">tx_pauseframes</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">tx_controlframes</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">tx_controlframes</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">jabber_events</span> <span class="o">=</span> <span class="n">port_stats</span><span class="o">-&gt;</span><span class="n">jabber_events</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_no_pbuf</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_no_pbuf</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_no_erx_descr</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_no_erx_descr</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">forwarded_packets</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">forwarded_packets</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_mtu</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_mtu</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_no_tpre_descr</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_no_tpre_descr</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_too_many_frags</span> <span class="o">=</span> <span class="n">rxf_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_too_many_frags</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">drv_stats</span><span class="p">.</span><span class="n">eth_red_drops</span> <span class="o">=</span> <span class="n">pmem_sts</span><span class="o">-&gt;</span><span class="n">eth_red_drops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">populate_lancer_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">be_drv_stats</span> <span class="o">*</span><span class="n">drvs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">drv_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lancer_pport_stats</span> <span class="o">*</span><span class="n">pport_stats</span> <span class="o">=</span>
					<span class="n">pport_stats_from_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">pport_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pport_stats</span><span class="p">));</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_pause_frames</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_pause_frames_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_control_frames</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_control_frames_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_frames_too_long_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_runt</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_runt</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_ip_checksum_errs</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_ip_checksum_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_tcp_checksum_errs</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_tcp_checksum_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_udp_checksum_errs</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_udp_checksum_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_tcp_length</span> <span class="o">=</span>
				<span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_invalid_tcp_length</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_small</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_small</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_short</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_short</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_out_range_errors</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_out_of_range_errors</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_header_too_small</span> <span class="o">=</span>
				<span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped_header_too_small</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_input_fifo_overflow_drop</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_overflow</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_address_mismatch_drops</span> <span class="o">=</span>
					<span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_address_mismatch_drops</span> <span class="o">+</span>
					<span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_vlan_mismatch_drops</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_alignment_symbol_errors</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_symbol_errors_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rxpp_fifo_overflow_drop</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_overflow</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">tx_pauseframes</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">tx_pause_frames_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">tx_controlframes</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">tx_control_frames_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">jabber_events</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_jabbers</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">forwarded_packets</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">num_forwards_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_mtu</span> <span class="o">=</span> <span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_mtu_lo</span><span class="p">;</span>
	<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_too_many_frags</span> <span class="o">=</span>
				<span class="n">pport_stats</span><span class="o">-&gt;</span><span class="n">rx_drops_too_many_frags_lo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">accumulate_16bit_val</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">acc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define lo(x)			(x &amp; 0xFFFF)</span>
<span class="cp">#define hi(x)			(x &amp; 0xFFFF0000)</span>
	<span class="n">bool</span> <span class="n">wrapped</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">newacc</span> <span class="o">=</span> <span class="n">hi</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)</span> <span class="o">+</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
		<span class="n">newacc</span> <span class="o">+=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)</span> <span class="o">=</span> <span class="n">newacc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_parse_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_erx_stats_v1</span> <span class="o">*</span><span class="n">erx</span> <span class="o">=</span> <span class="n">be_erx_stats_from_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">populate_lancer_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		 <span class="k">else</span>
			<span class="n">populate_be3_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">populate_be2_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* as erx_v1 is longer than v0, ok to use v1 defn for v0 access */</span>
	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* below erx HW counter can actually wrap around after</span>
<span class="cm">		 * 65535. Driver accumulates a 32-bit value</span>
<span class="cm">		 */</span>
		<span class="n">accumulate_16bit_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_drops_no_frags</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">erx</span><span class="o">-&gt;</span><span class="n">rx_drops_no_fragments</span><span class="p">[</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="nf">be_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_drv_stats</span> <span class="o">*</span><span class="n">drvs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">drv_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pkts</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">be_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
			<span class="n">pkts</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_pkts</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">pkts</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">+=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_mcast_pkts</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_drops_no_skbs</span> <span class="o">+</span>
					<span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_drops_no_frags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_all_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">be_tx_stats</span> <span class="o">*</span><span class="n">tx_stats</span> <span class="o">=</span> <span class="n">tx_stats</span><span class="p">(</span><span class="n">txo</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
			<span class="n">pkts</span> <span class="o">=</span> <span class="n">tx_stats</span><span class="p">(</span><span class="n">txo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_pkts</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">tx_stats</span><span class="p">(</span><span class="n">txo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">pkts</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bad pkts received */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_alignment_symbol_errors</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_out_range_errors</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_small</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_too_short</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_header_too_small</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_tcp_length</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_dropped_runt</span><span class="p">;</span>

	<span class="cm">/* detailed rx errors */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_in_range_errors</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_out_range_errors</span> <span class="o">+</span>
		<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">;</span>

	<span class="cm">/* frame alignment errors */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_alignment_symbol_errors</span><span class="p">;</span>

	<span class="cm">/* receiver fifo overrun */</span>
	<span class="cm">/* drops_no_pbuf is no per i/f, it&#39;s per BE card */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rxpp_fifo_overflow_drop</span> <span class="o">+</span>
				<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_input_fifo_overflow_drop</span> <span class="o">+</span>
				<span class="n">drvs</span><span class="o">-&gt;</span><span class="n">rx_drops_no_pbuf</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_link_status_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BE_FLAGS_LINK_STATUS_INIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BE_FLAGS_LINK_STATUS_INIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">LINK_UP</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_tx_stats_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">wrb_cnt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">copied</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gso_segs</span><span class="p">,</span> <span class="n">bool</span> <span class="n">stopped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_tx_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">tx_stats</span><span class="p">(</span><span class="n">txo</span><span class="p">);</span>

	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_reqs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_wrbs</span> <span class="o">+=</span> <span class="n">wrb_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">copied</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_pkts</span> <span class="o">+=</span> <span class="p">(</span><span class="n">gso_segs</span> <span class="o">?</span> <span class="n">gso_segs</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stopped</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_stops</span><span class="o">++</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Determine number of WRB entries needed to xmit data in an skb */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">wrb_cnt_for_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
								<span class="n">bool</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>

	<span class="n">cnt</span> <span class="o">+=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>

	<span class="cm">/* to account for hdr wrb */</span>
	<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dummy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* add a dummy to make it an even num */</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dummy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">BE_MAX_TX_FRAG_COUNT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wrb_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eth_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_pa_hi</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_pa_lo</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="n">ETH_WRB_FRAG_LEN_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">be_get_tx_vlan_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">vlan_prio</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">;</span>

	<span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">vlan_prio</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlan_tag</span> <span class="o">&amp;</span> <span class="n">VLAN_PRIO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">VLAN_PRIO_SHIFT</span><span class="p">;</span>
	<span class="cm">/* If vlan priority provided by OS is NOT in available bmap */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_prio_bmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vlan_prio</span><span class="p">)))</span>
		<span class="n">vlan_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlan_tag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VLAN_PRIO_MASK</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recommended_prio</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vlan_tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wrb_fill_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_eth_hdr_wrb</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wrb_cnt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">lso</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">lso_mss</span><span class="p">,</span>
			<span class="n">hdr</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso_v6</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">lso6</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sli_family</span>  <span class="o">==</span>
							<span class="n">LANCER_A0_SLI_FAMILY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">ipcs</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_tcp_pkt</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
				<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span>
								<span class="n">tcpcs</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_udp_pkt</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
				<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span>
								<span class="n">udpcs</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_tcp_pkt</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">tcpcs</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_udp_pkt</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">udpcs</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">be_get_tx_vlan_tag</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">num_wrb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">wrb_cnt</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_hdr_wrb</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unmap_tx_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_eth_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">unmap_single</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>

	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_pa_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_pa_lo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unmap_single</span><span class="p">)</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">,</span>
					 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">make_tx_wrbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wrb_cnt</span><span class="p">,</span> <span class="n">bool</span> <span class="n">dummy_wrb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">busaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">first_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eth_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eth_hdr_wrb</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">map_single</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">map_head</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">map_head</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">busaddr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">dma_err</span><span class="p">;</span>
		<span class="n">map_single</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">wrb_fill</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="n">busaddr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
		<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">busaddr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">dma_err</span><span class="p">;</span>
		<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">wrb_fill</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="n">busaddr</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
		<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dummy_wrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">wrb_fill</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
		<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wrb_fill_hdr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">first_skb</span><span class="p">,</span> <span class="n">wrb_cnt</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="nl">dma_err:</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">map_head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">unmap_tx_frag</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span> <span class="n">map_single</span><span class="p">);</span>
		<span class="n">map_single</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">copied</span> <span class="o">-=</span> <span class="n">wrb</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">;</span>
		<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">be_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_obj</span><span class="p">[</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wrb_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dummy_wrb</span><span class="p">,</span> <span class="n">stopped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* For vlan tagged pkts, BE</span>
<span class="cm">	 * 1) calculates checksum even when CSO is not requested</span>
<span class="cm">	 * 2) calculates checksum wrongly for padded pkt less than</span>
<span class="cm">	 * 60 bytes long.</span>
<span class="cm">	 * As a workaround disable TX vlan offloading in such cases.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">!=</span> <span class="n">CHECKSUM_PARTIAL</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_share_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">__vlan_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">be_get_tx_vlan_tag</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wrb_cnt</span> <span class="o">=</span> <span class="n">wrb_cnt_for_skb</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_wrb</span><span class="p">);</span>

	<span class="n">copied</span> <span class="o">=</span> <span class="n">make_tx_wrbs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">wrb_cnt</span><span class="p">,</span> <span class="n">dummy_wrb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">gso_segs</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_segs</span><span class="p">;</span>

		<span class="cm">/* record the sent skb in the sent_skb table */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">sent_skb_list</span><span class="p">[</span><span class="n">start</span><span class="p">]);</span>
		<span class="n">txo</span><span class="o">-&gt;</span><span class="n">sent_skb_list</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* Ensure txq has space for the next skb; Else stop the queue</span>
<span class="cm">		 * *BEFORE* ringing the tx doorbell, so that we serialze the</span>
<span class="cm">		 * tx compls of the current transmit which&#39;ll wake up the queue</span>
<span class="cm">		 */</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">wrb_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">BE_MAX_TX_FRAG_COUNT</span> <span class="o">+</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">))</span> <span class="o">&gt;=</span>
								<span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_stop_subqueue</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="n">stopped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">be_txq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">wrb_cnt</span><span class="p">);</span>

		<span class="n">be_tx_stats_update</span><span class="p">(</span><span class="n">txo</span><span class="p">,</span> <span class="n">wrb_cnt</span><span class="p">,</span> <span class="n">copied</span><span class="p">,</span> <span class="n">gso_segs</span><span class="p">,</span> <span class="n">stopped</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">tx_drop:</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">BE_MIN_MTU</span> <span class="o">||</span>
			<span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">BE_MAX_JUMBO_FRAME_SIZE</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;MTU must be between %d and %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">BE_MIN_MTU</span><span class="p">,</span>
			<span class="p">(</span><span class="n">BE_MAX_JUMBO_FRAME_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">)));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MTU changed from %d to %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A max of 64 (BE_NUM_VLANS_SUPPORTED) vlans can be configured in BE.</span>
<span class="cm"> * If the user configures more, place BE in vlan promiscuous mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_vid_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">vf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vf_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf_num</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">vtag</span><span class="p">[</span><span class="n">BE_NUM_VLANS_SUPPORTED</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">ntags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_vlan_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="n">vtag</span><span class="p">,</span>
					    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* No need to further configure vids if in promiscuous mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">promiscuous</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans_added</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_vlans</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">set_vlan_promisc</span><span class="p">;</span>

	<span class="cm">/* Construct VLAN Table to give to HW */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VLAN_N_VID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">vtag</span><span class="p">[</span><span class="n">ntags</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_vlan_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
				    <span class="n">vtag</span><span class="p">,</span> <span class="n">ntags</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set to VLAN promisc mode as setting VLAN filter failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Exhausted VLAN HW filters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling HW VLAN filtering.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">set_vlan_promisc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="nl">set_vlan_promisc:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_vlan_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_vlan_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans_added</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_vlans</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_vid_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans_added</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">ret:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_vlan_rem_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans_added</span> <span class="o">&lt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_vlans</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_vid_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans_added</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">ret:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_cmd_rx_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">IFF_PROMISC</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BE was previously in promiscuous mode; disable it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">promiscuous</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">be_cmd_rx_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">IFF_PROMISC</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans_added</span><span class="p">)</span>
			<span class="n">be_vid_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable multicast promisc if num configured exceeds what we support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span>
			<span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">BE_MAX_MC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_cmd_rx_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">IFF_ALLMULTI</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev_uc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">uc_macs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* First slot is claimed by the Primary MAC */</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">uc_macs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">uc_macs</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">be_cmd_pmac_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netdev_uc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_pmac_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">be_cmd_rx_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">IFF_PROMISC</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netdev_for_each_uc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">uc_macs</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* First slot is for Primary MAC */</span>
			<span class="n">be_cmd_pmac_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">uc_macs</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_rx_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">IFF_MULTICAST</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="cm">/* Set to MCAST promisc mode if setting MULTICAST address fails */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Exhausted multicast HW filters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling HW multicast filtering.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">be_cmd_rx_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">IFF_ALLMULTI</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_set_vf_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sriov_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="o">||</span> <span class="n">vf</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_set_mac_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>  <span class="n">mac</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_pmac_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
					 <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_pmac_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC %pM set on VF %d Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mac</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_get_vf_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ifla_vf_info</span> <span class="o">*</span><span class="n">vi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sriov_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">vf</span> <span class="o">=</span> <span class="n">vf</span><span class="p">;</span>
	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">;</span>
	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">=</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">;</span>
	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">qos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_set_vf_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">u8</span> <span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sriov_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">||</span> <span class="n">vlan</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">].</span><span class="n">vlan_tag</span> <span class="o">!=</span> <span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If this is new value, program it. Else skip. */</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">].</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_set_hsw_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vlan</span><span class="p">,</span>
				<span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">].</span><span class="n">if_handle</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Reset Transparent Vlan Tagging. */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">].</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vlan</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">].</span><span class="n">def_vid</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_set_hsw_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">].</span><span class="n">if_handle</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;VLAN %d config on VF %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_set_vf_tx_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sriov_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;tx rate must be between 100 and 10000 Mbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_set_qos</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;tx rate %d on VF %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">[</span><span class="n">vf</span><span class="p">].</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_find_vfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vf_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">assigned_vfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vf_fn</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">stride</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_SRIOV</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_SRIOV_VF_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_SRIOV_VF_STRIDE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stride</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vf_fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">stride</span> <span class="o">*</span> <span class="n">vfs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="n">vf_fn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfs</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">PCI_DEV_FLAGS_ASSIGNED</span><span class="p">)</span>
				<span class="n">assigned_vfs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vf_state</span> <span class="o">==</span> <span class="n">ASSIGNED</span><span class="p">)</span> <span class="o">?</span> <span class="n">assigned_vfs</span> <span class="o">:</span> <span class="n">vfs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_eqd_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_rx_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_obj</span><span class="p">[</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">ulong</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_jiffies</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pkts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">eqd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">enable_aic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eqd</span> <span class="o">=</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">eqd</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">modify_eqd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_qs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_obj</span><span class="p">[</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">]);</span>

	<span class="cm">/* Wrapped around */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_jiffies</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update once a second */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="n">HZ</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
		<span class="n">pkts</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_pkts</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_pps</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">pkts</span> <span class="o">-</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_pkts_prev</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_pkts_prev</span> <span class="o">=</span> <span class="n">pkts</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_jiffies</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">eqd</span> <span class="o">=</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_pps</span> <span class="o">/</span> <span class="mi">110000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">eqd</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">eqd</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">max_eqd</span><span class="p">);</span>
	<span class="n">eqd</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">eqd</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">min_eqd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eqd</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">eqd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">modify_eqd:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eqd</span> <span class="o">!=</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">cur_eqd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_cmd_modify_eqd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">eqd</span><span class="p">);</span>
		<span class="n">eqo</span><span class="o">-&gt;</span><span class="n">cur_eqd</span> <span class="o">=</span> <span class="n">eqd</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_rx_stats_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_rx_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">);</span>

	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_compl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_pkts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">BE_MULTICAST_PACKET</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_mcast_pkts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_compl_err</span><span class="o">++</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">csum_passed</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* L4 checksum is not reliable for non TCP/UDP packets.</span>
<span class="cm">	 * Also ignore ipcksm for ipv6 pkts */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">tcpf</span> <span class="o">||</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">udpf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">l4_csum</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">ip_csum</span> <span class="o">||</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="o">*</span><span class="nf">get_rx_page_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">frag_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="o">*</span><span class="n">rx_page_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>

	<span class="n">rx_page_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">page_info_tbl</span><span class="p">[</span><span class="n">frag_idx</span><span class="p">];</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rx_page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_page_info</span><span class="o">-&gt;</span><span class="n">last_page_user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">rx_page_info</span><span class="p">,</span> <span class="n">bus</span><span class="p">),</span>
			       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">big_page_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">rx_page_info</span><span class="o">-&gt;</span><span class="n">last_page_user</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rx_page_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Throwaway the data in the Rx completion */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_rx_compl_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="o">*</span><span class="n">page_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_rcvd</span> <span class="o">=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">num_rcvd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rcvd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_info</span> <span class="o">=</span> <span class="n">get_rx_page_info</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">);</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">page_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">page_info</span><span class="p">));</span>
		<span class="n">index_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * skb_fill_rx_data forms a complete skb for an ether frame</span>
<span class="cm"> * indicated by rxcp.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">skb_fill_rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="o">*</span><span class="n">page_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">curr_frag_len</span><span class="p">,</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>

	<span class="n">page_info</span> <span class="o">=</span> <span class="n">get_rx_page_info</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>

	<span class="cm">/* Copy data in the first descriptor of this completion */</span>
	<span class="n">curr_frag_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">,</span> <span class="n">rx_frag_size</span><span class="p">);</span>

	<span class="cm">/* Copy the header portion into skb_data */</span>
	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">BE_HDR_LEN</span><span class="p">,</span> <span class="n">curr_frag_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">curr_frag_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr_frag_len</span> <span class="o">&lt;=</span> <span class="n">BE_HDR_LEN</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* tiny packet */</span>
		<span class="cm">/* Complete packet has now been moved to data */</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">curr_frag_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skb_frag_set_page</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">=</span>
					<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_frag_len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">curr_frag_len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">rx_frag_size</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">&lt;=</span> <span class="n">rx_frag_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">num_rcvd</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* More frags present for this completion */</span>
	<span class="n">index_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">remaining</span> <span class="o">=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">-</span> <span class="n">curr_frag_len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">num_rcvd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_info</span> <span class="o">=</span> <span class="n">get_rx_page_info</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">);</span>
		<span class="n">curr_frag_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">rx_frag_size</span><span class="p">);</span>

		<span class="cm">/* Coalesce all frags from the same physical page in one slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Fresh page */</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb_frag_set_page</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">=</span>
							<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>
			<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">put_page</span><span class="p">(</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">skb_frag_size_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">curr_frag_len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">curr_frag_len</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">curr_frag_len</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">rx_frag_size</span><span class="p">;</span>
		<span class="n">remaining</span> <span class="o">-=</span> <span class="n">curr_frag_len</span><span class="p">;</span>
		<span class="n">index_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process the RX completion indicated by rxcp when GRO is disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_rx_compl_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">BE_RX_SKB_ALLOC_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_drops_no_skbs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">be_rx_compl_discard</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_fill_rx_data</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">csum_passed</span><span class="p">(</span><span class="n">rxcp</span><span class="p">)))</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxo</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rss_hash</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>

	<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process the RX completion indicated by rxcp when GRO is enabled */</span>
<span class="kt">void</span> <span class="nf">be_rx_compl_process_gro</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="o">*</span><span class="n">page_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">curr_frag_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">napi_get_frags</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_rx_compl_discard</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">remaining</span> <span class="o">=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">num_rcvd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_info</span> <span class="o">=</span> <span class="n">get_rx_page_info</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">);</span>

		<span class="n">curr_frag_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">rx_frag_size</span><span class="p">);</span>

		<span class="cm">/* Coalesce all frags from the same physical page in one slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First frag or Fresh page */</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb_frag_set_page</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">page_offset</span> <span class="o">=</span>
							<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>
			<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">put_page</span><span class="p">(</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">skb_frag_size_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">curr_frag_len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">rx_frag_size</span><span class="p">;</span>
		<span class="n">remaining</span> <span class="o">-=</span> <span class="n">curr_frag_len</span><span class="p">;</span>
		<span class="n">index_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">page_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">page_info</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">);</span>

	<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxo</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rss_hash</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>

	<span class="n">napi_gro_frags</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_parse_rx_compl_v1</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eth_rx_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">pktsize</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">vtp</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">tcpf</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">tcpf</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">udpf</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">udpf</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">ip_csum</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">ipcksm</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">l4_csum</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">l4_cksm</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">ipv6</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">fragndx</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">num_rcvd</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">cast_enc</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rss_hash</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">rsshash</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vtm</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">vtm</span><span class="p">,</span>
					  <span class="n">compl</span><span class="p">);</span>
		<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">,</span>
					       <span class="n">compl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_parse_rx_compl_v0</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eth_rx_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">pktsize</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">vtp</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">tcpf</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">tcpf</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">udpf</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">udpf</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">ip_csum</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">ipcksm</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">l4_csum</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">l4_cksm</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">ipv6</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">ip_version</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rxq_idx</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">fragndx</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">num_rcvd</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">cast_enc</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">rss_hash</span> <span class="o">=</span>
		<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">rsshash</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vtm</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">vtm</span><span class="p">,</span>
					  <span class="n">compl</span><span class="p">);</span>
		<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">,</span>
					       <span class="n">compl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v0</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="nf">be_rx_compl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_eth_rx_compl</span> <span class="o">*</span><span class="n">compl</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">rxcp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="cm">/* For checking the valid bit it is Ok to use either definition as the</span>
<span class="cm">	 * valid bit is at the same position in both v0 and v1 Rx compl */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rmb</span><span class="p">();</span>
	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">compl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">compl</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">be3_native</span><span class="p">)</span>
		<span class="n">be_parse_rx_compl_v1</span><span class="p">(</span><span class="n">compl</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">be_parse_rx_compl_v0</span><span class="p">(</span><span class="n">compl</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* vlanf could be wrongly set in some cards.</span>
<span class="cm">		 * ignore if vtm is not set */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_mode</span> <span class="o">&amp;</span> <span class="n">FLEX10_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vtm</span><span class="p">)</span>
			<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">==</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span> <span class="o">&amp;</span> <span class="n">VLAN_VID_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">[</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">])</span>
			<span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">vlanf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* As the compl has been parsed, reset it; we wont touch it again */</span>
	<span class="n">compl</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_rx_compl_v1</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">queue_tail_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rxcp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">be_alloc_pages</span><span class="p">(</span><span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gfp</span> <span class="o">|=</span> <span class="n">__GFP_COMP</span><span class="p">;</span>
	<span class="k">return</span>  <span class="n">alloc_pages</span><span class="p">(</span><span class="n">gfp</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a page, split it to fragments of size rx_frag_size and post as</span>
<span class="cm"> * receive buffers to BE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_post_rx_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="o">*</span><span class="n">page_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_page_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pagep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eth_rx_d</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">page_dmaaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frag_dmaaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">posted</span><span class="p">,</span> <span class="n">page_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">page_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">page_info_tbl</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">posted</span> <span class="o">&lt;</span> <span class="n">MAX_RX_POST</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span> <span class="n">posted</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pagep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pagep</span> <span class="o">=</span> <span class="n">be_alloc_pages</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">big_page_size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pagep</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rx_stats</span><span class="p">(</span><span class="n">rxo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_post_fail</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">page_dmaaddr</span> <span class="o">=</span> <span class="n">dma_map_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pagep</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">big_page_size</span><span class="p">,</span>
						    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">get_page</span><span class="p">(</span><span class="n">pagep</span><span class="p">);</span>
			<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">=</span> <span class="n">page_offset</span> <span class="o">+</span> <span class="n">rx_frag_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">page_offset</span> <span class="o">=</span> <span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>
		<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">pagep</span><span class="p">;</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">page_info</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">page_dmaaddr</span><span class="p">);</span>
		<span class="n">frag_dmaaddr</span> <span class="o">=</span> <span class="n">page_dmaaddr</span> <span class="o">+</span> <span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>

		<span class="n">rxd</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">fragpa_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">frag_dmaaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">fragpa_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">frag_dmaaddr</span><span class="p">));</span>

		<span class="cm">/* Any space left in the current big page for another frag? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">page_offset</span> <span class="o">+</span> <span class="n">rx_frag_size</span> <span class="o">+</span> <span class="n">rx_frag_size</span><span class="p">)</span> <span class="o">&gt;</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">big_page_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pagep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">page_info</span><span class="o">-&gt;</span><span class="n">last_page_user</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prev_page_info</span> <span class="o">=</span> <span class="n">page_info</span><span class="p">;</span>
		<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
		<span class="n">page_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">page_info_tbl</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pagep</span><span class="p">)</span>
		<span class="n">prev_page_info</span><span class="o">-&gt;</span><span class="n">last_page_user</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">posted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">posted</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
		<span class="n">be_rxq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Let be_worker replenish when memory is available */</span>
		<span class="n">rxo</span><span class="o">-&gt;</span><span class="n">rx_post_starved</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">be_eth_tx_compl</span> <span class="o">*</span><span class="nf">be_tx_compl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">tx_cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_eth_tx_compl</span> <span class="o">*</span><span class="n">txcp</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">tx_cq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txcp</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_tx_compl</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rmb</span><span class="p">();</span>
	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">txcp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txcp</span><span class="p">));</span>

	<span class="n">txcp</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_tx_compl</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">tx_cq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">txcp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">be_tx_compl_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">,</span> <span class="n">u16</span> <span class="n">last_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eth_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">sent_skbs</span> <span class="o">=</span> <span class="n">txo</span><span class="o">-&gt;</span><span class="n">sent_skb_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sent_skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cur_index</span><span class="p">,</span> <span class="n">num_wrbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* account for hdr wrb */</span>
	<span class="n">bool</span> <span class="n">unmap_skb_hdr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">sent_skb</span> <span class="o">=</span> <span class="n">sent_skbs</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">];</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sent_skb</span><span class="p">);</span>
	<span class="n">sent_skbs</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* skip header wrb */</span>
	<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cur_index</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
		<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">unmap_tx_frag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">wrb</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">unmap_skb_hdr</span> <span class="o">&amp;&amp;</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">sent_skb</span><span class="p">)));</span>
		<span class="n">unmap_skb_hdr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">num_wrbs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cur_index</span> <span class="o">!=</span> <span class="n">last_index</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">sent_skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num_wrbs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the number of events in the event queue */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">events_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_eq_entry</span> <span class="o">*</span><span class="n">eqe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">evt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">eqe</span><span class="o">-&gt;</span><span class="n">evt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">queue_tail_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">rearm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">events_get</span><span class="p">(</span><span class="n">eqo</span><span class="p">);</span>

	<span class="cm">/* Deal with any spurious interrupts that come without events */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num</span><span class="p">)</span>
		<span class="n">rearm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">||</span> <span class="n">msix_enabled</span><span class="p">(</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">be_eq_notify</span><span class="p">(</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rearm</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Leaves the EQ is disarmed state */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_eq_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">events_get</span><span class="p">(</span><span class="n">eqo</span><span class="p">);</span>

	<span class="n">be_eq_notify</span><span class="p">(</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_rx_cq_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_rx_page_info</span> <span class="o">*</span><span class="n">page_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rx_cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tail</span><span class="p">;</span>

	<span class="cm">/* First cleanup pending rx completions */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">rxcp</span> <span class="o">=</span> <span class="n">be_rx_compl_get</span><span class="p">(</span><span class="n">rxo</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_rx_compl_discard</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
		<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Then free posted rx buffer that were not used */</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">))</span> <span class="o">%</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tail</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">page_info</span> <span class="o">=</span> <span class="n">get_rx_page_info</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">page_info</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">page_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">page_info</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">));</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_tx_compl_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eth_tx_compl</span> <span class="o">*</span><span class="n">txcp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">end_idx</span><span class="p">,</span> <span class="n">cmpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_wrbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sent_skb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dummy_wrb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pending_txqs</span><span class="p">;</span>

	<span class="cm">/* Wait for a max of 200ms for all the tx-completions to arrive. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pending_txqs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_qs</span><span class="p">;</span>

		<span class="n">for_all_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">txcp</span> <span class="o">=</span> <span class="n">be_tx_compl_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">end_idx</span> <span class="o">=</span>
					<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_tx_compl</span><span class="p">,</span>
						      <span class="n">wrb_index</span><span class="p">,</span> <span class="n">txcp</span><span class="p">);</span>
				<span class="n">num_wrbs</span> <span class="o">+=</span> <span class="n">be_tx_compl_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span>
								<span class="n">end_idx</span><span class="p">);</span>
				<span class="n">cmpl</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmpl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">cmpl</span><span class="p">);</span>
				<span class="n">atomic_sub</span><span class="p">(</span><span class="n">num_wrbs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
				<span class="n">cmpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">num_wrbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pending_txqs</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending_txqs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">++</span><span class="n">timeo</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="n">for_all_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d pending tx-compls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">));</span>

		<span class="cm">/* free posted tx for which compls will never arrive */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sent_skb</span> <span class="o">=</span> <span class="n">txo</span><span class="o">-&gt;</span><span class="n">sent_skb_list</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">];</span>
			<span class="n">end_idx</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
			<span class="n">num_wrbs</span> <span class="o">=</span> <span class="n">wrb_cnt_for_skb</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">sent_skb</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">dummy_wrb</span><span class="p">);</span>
			<span class="n">index_adv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_idx</span><span class="p">,</span> <span class="n">num_wrbs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">num_wrbs</span> <span class="o">=</span> <span class="n">be_tx_compl_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">);</span>
			<span class="n">atomic_sub</span><span class="p">(</span><span class="n">num_wrbs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_evt_queues_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_eq_clean</span><span class="p">(</span><span class="n">eqo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">created</span><span class="p">)</span>
			<span class="n">be_cmd_q_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_EQ</span><span class="p">);</span>
		<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_evt_queues_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_evt_qs</span> <span class="o">=</span> <span class="n">num_irqs</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eqo</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
		<span class="n">eqo</span><span class="o">-&gt;</span><span class="n">tx_budget</span> <span class="o">=</span> <span class="n">BE_TX_BUDGET</span><span class="p">;</span>
		<span class="n">eqo</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">eqo</span><span class="o">-&gt;</span><span class="n">max_eqd</span> <span class="o">=</span> <span class="n">BE_MAX_EQD</span><span class="p">;</span>
		<span class="n">eqo</span><span class="o">-&gt;</span><span class="n">enable_aic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">EVNT_Q_LEN</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eq_entry</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">be_cmd_eq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">cur_eqd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_mcc_queues_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
		<span class="n">be_cmd_q_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_MCCQ</span><span class="p">);</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
		<span class="n">be_cmd_q_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Must be called only after TX qs are created as MCC shares TX EQ */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mcc_queues_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>

	<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">MCC_CQ_LEN</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_compl</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Use the default EQ for MCC completions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_cmd_cq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcc_eqo</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mcc_cq_free</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">MCC_Q_LEN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_wrb</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">mcc_cq_destroy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_cmd_mccq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">cq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mcc_q_free</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">mcc_q_free:</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
<span class="nl">mcc_cq_destroy:</span>
	<span class="n">be_cmd_q_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
<span class="nl">mcc_cq_free:</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_tx_queues_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_all_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
			<span class="n">be_cmd_q_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_TXQ</span><span class="p">);</span>
		<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>

		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
			<span class="n">be_cmd_q_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
		<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_num_txqs_want</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sriov_want</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">||</span> <span class="n">be_is_mc</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">MAX_TX_QS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_tx_cqs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_qs</span> <span class="o">=</span> <span class="n">be_num_txqs_want</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_qs</span> <span class="o">!=</span> <span class="n">MAX_TX_QS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_qs</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">for_all_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">TX_CQ_LEN</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eth_tx_compl</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="cm">/* If num_evt_qs is less than num_tx_qs, then more than</span>
<span class="cm">		 * one txq share an eq</span>
<span class="cm">		 */</span>
		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eq_obj</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_evt_qs</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_cq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_tx_qs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">for_all_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">TX_Q_LEN</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eth_wrb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_txq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_rx_cqs_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
			<span class="n">be_cmd_q_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
		<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_rx_cqs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">,</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We&#39;ll create as many RSS rings as there are irqs.</span>
<span class="cm">	 * But when there&#39;s only one irq there&#39;s no use creating RSS rings</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_qs</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_irqs</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">num_irqs</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">big_page_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">get_order</span><span class="p">(</span><span class="n">rx_frag_size</span><span class="p">))</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
		<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">RX_CQ_LEN</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eth_rx_compl</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eq_obj</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_evt_qs</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">be_cmd_cq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_qs</span> <span class="o">!=</span> <span class="n">MAX_RX_QS</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Created only %d receive queues&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_qs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">be_intx</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_evts</span><span class="p">;</span>

	<span class="cm">/* With INTx only one EQ is used */</span>
	<span class="n">num_evts</span> <span class="o">=</span> <span class="n">event_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eq_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_evts</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">be_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">event_handle</span><span class="p">(</span><span class="n">eqo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">do_gro</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">tcpf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_process_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">rx_cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_compl_info</span> <span class="o">*</span><span class="n">rxcp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">;</span> <span class="n">work_done</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxcp</span> <span class="o">=</span> <span class="n">be_rx_compl_get</span><span class="p">(</span><span class="n">rxo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxcp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Is it a flush compl that has no data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">num_rcvd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">loop_continue</span><span class="p">;</span>

		<span class="cm">/* Discard compl with partial DMA Lancer B0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">be_rx_compl_discard</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">loop_continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* On BE drop pkts that arrive due to imperfect filtering in</span>
<span class="cm">		 * promiscuous mode on some skews</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rxcp</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">be_rx_compl_discard</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">loop_continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_gro</span><span class="p">(</span><span class="n">rxcp</span><span class="p">))</span>
			<span class="n">be_rx_compl_process_gro</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">napi</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">be_rx_compl_process</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
<span class="nl">loop_continue:</span>
		<span class="n">be_rx_stats_update</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">rxcp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">work_done</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RX_FRAGS_REFILL_WM</span><span class="p">)</span>
			<span class="n">be_post_rx_frags</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">be_process_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_eth_tx_compl</span> <span class="o">*</span><span class="n">txcp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_wrbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">;</span> <span class="n">work_done</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txcp</span> <span class="o">=</span> <span class="n">be_tx_compl_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txcp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">num_wrbs</span> <span class="o">+=</span> <span class="n">be_tx_compl_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span>
				<span class="n">AMAP_GET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eth_tx_compl</span><span class="p">,</span>
					<span class="n">wrb_index</span><span class="p">,</span> <span class="n">txcp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">work_done</span><span class="p">);</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">num_wrbs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">);</span>

		<span class="cm">/* As Tx wrbs have been freed up, wake up netdev queue</span>
<span class="cm">		 * if it was stopped due to lack of tx wrbs.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__netif_subqueue_stopped</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">txo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_wake_subqueue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_stats</span><span class="p">(</span><span class="n">txo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sync_compl</span><span class="p">);</span>
		<span class="n">tx_stats</span><span class="p">(</span><span class="n">txo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_compl</span> <span class="o">+=</span> <span class="n">work_done</span><span class="p">;</span>
		<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_stats</span><span class="p">(</span><span class="n">txo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sync_compl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">);</span> <span class="cm">/* Done */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_eq_obj</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_done</span><span class="p">;</span>

	<span class="cm">/* Process all TXQs serviced by this EQ */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_qs</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_evt_qs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_done</span> <span class="o">=</span> <span class="n">be_process_tx</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_obj</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">eqo</span><span class="o">-&gt;</span><span class="n">tx_budget</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_done</span><span class="p">)</span>
			<span class="n">max_work</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This loop will iterate twice for EQ0 in which</span>
<span class="cm">	 * completions of the last RXQ (default one) are also processed</span>
<span class="cm">	 * For other EQs the loop iterates only once</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_qs</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_evt_qs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">work</span> <span class="o">=</span> <span class="n">be_process_rx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_obj</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">napi</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
		<span class="n">max_work</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">max_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcc_eqo</span><span class="p">(</span><span class="n">eqo</span><span class="p">))</span>
		<span class="n">be_process_mcc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_work</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">be_eq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* As we&#39;ll continue in polling mode, count and clear events */</span>
		<span class="n">be_eq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">events_get</span><span class="p">(</span><span class="n">eqo</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_work</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_detect_dump_ue</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ue_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ue_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ue_lo_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ue_hi_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sliport_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sliport_err1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sliport_err2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span> <span class="o">||</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ue_detected</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sliport_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">SLIPORT_STATUS_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sliport_status</span> <span class="o">&amp;</span> <span class="n">SLIPORT_STATUS_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sliport_err1</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span>
					<span class="n">SLIPORT_ERROR1_OFFSET</span><span class="p">);</span>
			<span class="n">sliport_err2</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span>
					<span class="n">SLIPORT_ERROR2_OFFSET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">PCICFG_UE_STATUS_LOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ue_lo</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">PCICFG_UE_STATUS_HIGH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ue_hi</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">PCICFG_UE_STATUS_LOW_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ue_lo_mask</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">PCICFG_UE_STATUS_HI_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ue_hi_mask</span><span class="p">);</span>

		<span class="n">ue_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ue_lo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ue_lo_mask</span><span class="p">));</span>
		<span class="n">ue_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ue_hi</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ue_hi_mask</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ue_lo</span> <span class="o">||</span> <span class="n">ue_hi</span> <span class="o">||</span>
		<span class="n">sliport_status</span> <span class="o">&amp;</span> <span class="n">SLIPORT_STATUS_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ue_detected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unrecoverable error in the card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ue_lo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ue_lo</span><span class="p">;</span> <span class="n">ue_lo</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ue_lo</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;UE: %s bit set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ue_status_low_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ue_hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ue_hi</span><span class="p">;</span> <span class="n">ue_hi</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ue_hi</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;UE: %s bit set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ue_status_hi_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sliport_status</span> <span class="o">&amp;</span> <span class="n">SLIPORT_STATUS_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;sliport status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sliport_status</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;sliport error1 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sliport_err1</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;sliport error2 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sliport_err2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_msix_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msix_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">be_num_rss_want</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_caps</span> <span class="o">&amp;</span> <span class="n">BE_FUNCTION_CAPS_RSS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">sriov_want</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">be_is_mc</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">be3_native</span><span class="p">)</span> <span class="o">?</span> <span class="n">BE3_MAX_RSS_QS</span> <span class="o">:</span> <span class="n">BE2_MAX_RSS_QS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_msix_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define BE_MIN_MSIX_VECTORS		1</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">num_vec</span><span class="p">,</span> <span class="n">num_roce_vec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If RSS queues are not used, need a vec for default RX Q */</span>
	<span class="n">num_vec</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">be_num_rss_want</span><span class="p">(</span><span class="n">adapter</span><span class="p">),</span> <span class="n">num_online_cpus</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_roce_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">num_roce_vec</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">MAX_ROCE_MSIX_VECTORS</span><span class="p">,</span>
					<span class="p">(</span><span class="n">num_online_cpus</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">num_roce_vec</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">num_roce_vec</span><span class="p">,</span> <span class="n">MAX_ROCE_EQS</span><span class="p">);</span>
		<span class="n">num_vec</span> <span class="o">+=</span> <span class="n">num_roce_vec</span><span class="p">;</span>
		<span class="n">num_vec</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">num_vec</span><span class="p">,</span> <span class="n">MAX_MSIX_VECTORS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">num_vec</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">num_vec</span><span class="p">,</span> <span class="n">BE_MIN_MSIX_VECTORS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_vec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span> <span class="n">num_vec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">BE_MIN_MSIX_VECTORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_vec</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span>
				<span class="n">num_vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_roce_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_vec</span> <span class="o">&gt;</span> <span class="n">num_roce_vec</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vec</span> <span class="o">=</span> <span class="n">num_vec</span> <span class="o">-</span> <span class="n">num_roce_vec</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_roce_vec</span> <span class="o">=</span>
				<span class="n">num_vec</span> <span class="o">-</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vec</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vec</span> <span class="o">=</span> <span class="n">num_vec</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_roce_vec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_msix_vec</span> <span class="o">=</span> <span class="n">num_vec</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">be_msix_vec_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_msix_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span><span class="p">;</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;%s-q%d&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">be_msix_vec_get</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">be_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">eqo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_msix</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_msix:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">eqo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eq_obj</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">eqo</span><span class="o">--</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">be_msix_vec_get</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">),</span> <span class="n">eqo</span><span class="p">);</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSIX Request IRQ failed - err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">status</span><span class="p">);</span>
	<span class="n">be_msix_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_irq_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msix_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_msix_register</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="cm">/* INTx is not supported for VF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* INTx */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">be_intx</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;INTx request IRQ failed - err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_irq_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_registered</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* INTx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msix_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MSIx */</span>
	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">be_msix_vec_get</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">),</span> <span class="n">eqo</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_registered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_rx_qs_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">be_cmd_rxq_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
			<span class="cm">/* After the rxq is invalidated, wait for a grace time</span>
<span class="cm">			 * of 1ms for all dma to end and the flush compl to</span>
<span class="cm">			 * arrive</span>
<span class="cm">			 */</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">be_rx_cq_clean</span><span class="p">(</span><span class="n">rxo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">be_queue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">be_roce_dev_close</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_async_mcc_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">be_intr_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msix_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">be_msix_vec_get</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">be_eq_clean</span><span class="p">(</span><span class="n">eqo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">be_irq_unregister</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Wait for all pending tx completions to arrive so that</span>
<span class="cm">	 * all tx skbs are freed.</span>
<span class="cm">	 */</span>
	<span class="n">be_tx_compl_clean</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_rx_qs_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_rx_qs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsstable</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">RX_Q_LEN</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eth_rx_d</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The FW would like the default RXQ to be created first */</span>
	<span class="n">rxo</span> <span class="o">=</span> <span class="n">default_rxo</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">be_cmd_rxq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rx_frag_size</span><span class="p">,</span>
			       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">rss_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">for_all_rss_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">be_cmd_rxq_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
				       <span class="n">rx_frag_size</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
				       <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">rss_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_multi_rxq</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_qs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">for_all_rss_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">rsstable</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">rss_id</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">be_cmd_rss_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rsstable</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First time posting */</span>
	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">be_post_rx_frags</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_tx_obj</span> <span class="o">*</span><span class="n">txo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_rx_qs_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">be_irq_register</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">be_intr_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">for_all_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">be_cq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">txo</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_async_mcc_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">be_eq_notify</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_link_status_query</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">link_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">be_link_status_update</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">link_status</span><span class="p">);</span>

	<span class="n">be_roce_dev_open</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">be_close</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_setup_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_acpi_wol_magic_config</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
				    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">PCICFG_PM_CONTROL_OFFSET</span><span class="p">,</span> <span class="n">PCICFG_PM_CONTROL_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Could not enable Wake-on-lan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_enable_magic_wol</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_enable_magic_wol</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a seed MAC address from the PF MAC Address using jhash.</span>
<span class="cm"> * MAC Address for VFs are assigned incrementally starting from the seed.</span>
<span class="cm"> * These addresses are programmed in the ASIC by the PF and the VF driver</span>
<span class="cm"> * queries for the MAC address during its probe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">be_vf_eth_addr_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span><span class="p">;</span>

	<span class="n">be_vf_eth_addr_generate</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>

	<span class="n">for_all_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="p">,</span> <span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_set_mac_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>  <span class="n">mac</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_pmac_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span>
						 <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Mac address assignment failed for VF %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_vf_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_find_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ASSIGNED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VFs are assigned to VMs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_all_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="p">,</span> <span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">be_cmd_set_mac_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">be_cmd_pmac_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
					<span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">be_cmd_if_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_disable_sriov</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BE_FLAGS_WORKER_SCHEDULED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BE_FLAGS_WORKER_SCHEDULED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sriov_enabled</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">be_vf_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">uc_macs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">uc_macs</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">be_cmd_pmac_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_cmd_if_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_mcc_queues_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">be_rx_cqs_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">be_tx_queues_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">be_evt_queues_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* tell fw we&#39;re done with firing cmds */</span>
	<span class="n">be_cmd_fw_clean</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_msix_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_CUST_SCRATCHPAD_CSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_vf_setup_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vf</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vf_cfg</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vf_cfg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">for_all_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="p">,</span> <span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">pmac_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_vf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_vf_cfg</span> <span class="o">*</span><span class="n">vf_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap_flags</span><span class="p">,</span> <span class="n">en_flags</span><span class="p">,</span> <span class="n">vf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">def_vlan</span><span class="p">,</span> <span class="n">lnk_speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">enabled_vfs</span><span class="p">;</span>

	<span class="n">enabled_vfs</span> <span class="o">=</span> <span class="n">be_find_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled_vfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d VFs are already enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled_vfs</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ignoring num_vfs=%d setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_vfs</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_vfs</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_num_vfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device supports %d VFs and not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_num_vfs</span><span class="p">,</span> <span class="n">num_vfs</span><span class="p">);</span>
		<span class="n">num_vfs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_num_vfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_enable_sriov</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">num_vfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_vfs</span> <span class="o">=</span> <span class="n">num_vfs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Platform doesn&#39;t support SRIOV though device supports it */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SRIOV enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_vf_setup_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cap_flags</span> <span class="o">=</span> <span class="n">en_flags</span> <span class="o">=</span> <span class="n">BE_IF_FLAGS_UNTAGGED</span> <span class="o">|</span> <span class="n">BE_IF_FLAGS_BROADCAST</span> <span class="o">|</span>
				<span class="n">BE_IF_FLAGS_MULTICAST</span><span class="p">;</span>
	<span class="n">for_all_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="p">,</span> <span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_if_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cap_flags</span><span class="p">,</span> <span class="n">en_flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled_vfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_vf_eth_addr_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_all_vfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="p">,</span> <span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_link_status_query</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lnk_speed</span><span class="p">,</span>
						  <span class="nb">NULL</span><span class="p">,</span> <span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="n">lnk_speed</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_get_hsw_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">def_vlan</span><span class="p">,</span>
				<span class="n">vf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">vf_cfg</span><span class="o">-&gt;</span><span class="n">def_vid</span> <span class="o">=</span> <span class="n">def_vlan</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_setup_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_prio_bmap</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">be3_native</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eq_next_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">forced_port_speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_add_mac_from_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pmac_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pmac_id_active</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_get_mac_from_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmac_id_active</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">pmac_id</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_none</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_id_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_mac_addr_query</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span>
				<span class="n">MAC_ADDRESS_TYPE_NETWORK</span><span class="p">,</span>
				<span class="nb">false</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="n">pmac_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmac_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_pmac_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">do_none:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Routine to query per function resource limits */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_get_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dev_num_vfs</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_SRIOV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_SRIOV_TOTAL_VF</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dev_num_vfs</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_num_vfs</span> <span class="o">=</span> <span class="n">dev_num_vfs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap_flags</span><span class="p">,</span> <span class="n">en_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_fc</span><span class="p">,</span> <span class="n">rx_fc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">be_setup_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_get_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_cmd_req_native_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_msix_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_evt_queues_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_tx_cqs_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_rx_cqs_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_queues_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_mac_addr_query</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">MAC_ADDRESS_TYPE_NETWORK</span><span class="p">,</span>
			<span class="nb">true</span> <span class="cm">/*permanent */</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">en_flags</span> <span class="o">=</span> <span class="n">BE_IF_FLAGS_UNTAGGED</span> <span class="o">|</span> <span class="n">BE_IF_FLAGS_BROADCAST</span> <span class="o">|</span>
			<span class="n">BE_IF_FLAGS_MULTICAST</span> <span class="o">|</span> <span class="n">BE_IF_FLAGS_PASS_L3L4_ERRORS</span><span class="p">;</span>
	<span class="n">cap_flags</span> <span class="o">=</span> <span class="n">en_flags</span> <span class="o">|</span> <span class="n">BE_IF_FLAGS_MCAST_PROMISCUOUS</span> <span class="o">|</span>
			<span class="n">BE_IF_FLAGS_VLAN_PROMISCUOUS</span> <span class="o">|</span> <span class="n">BE_IF_FLAGS_PROMISCUOUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_caps</span> <span class="o">&amp;</span> <span class="n">BE_FUNCTION_CAPS_RSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap_flags</span> <span class="o">|=</span> <span class="n">BE_IF_FLAGS_RSS</span><span class="p">;</span>
		<span class="n">en_flags</span> <span class="o">|=</span> <span class="n">BE_IF_FLAGS_RSS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_if_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cap_flags</span><span class="p">,</span> <span class="n">en_flags</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	 <span class="cm">/* The VF&#39;s permanent mac queried from card is incorrect.</span>
<span class="cm">	  * For BEx: Query the mac configued by the PF using if_handle</span>
<span class="cm">	  * For Lancer: Get and use mac_list to obtain mac address.</span>
<span class="cm">	  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">be_add_mac_from_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_mac_addr_query</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span>
					<span class="n">MAC_ADDRESS_TYPE_NETWORK</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_tx_qs_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">be_cmd_get_fw_ver</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">be_vid_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_set_rx_mode</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">be_cmd_get_flow_control</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_fc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_fc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_fc</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_fc</span> <span class="o">||</span> <span class="n">tx_fc</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_fc</span><span class="p">)</span>
		<span class="n">be_cmd_set_flow_control</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_fc</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_fc</span><span class="p">);</span>

	<span class="n">pcie_set_readrq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num_vfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_num_vfs</span><span class="p">)</span>
			<span class="n">be_vf_setup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device doesn&#39;t support SRIOV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">be_cmd_get_phy_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_pause_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">fc_autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BE_FLAGS_WORKER_SCHEDULED</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_CUST_SCRATCHPAD_CSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">be_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">event_handle</span><span class="p">(</span><span class="n">eqo</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define FW_FILE_HDR_SIGN 	&quot;ServerEngines Corp. &quot;</span>
<span class="kt">char</span> <span class="n">flash_cookie</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span>      <span class="p">{</span><span class="s">&quot;*** SE FLAS&quot;</span><span class="p">,</span> <span class="s">&quot;H DIRECTORY *** &quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">be_flash_redboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">img_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">image_size</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">hdr_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crc_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flashed_crc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">crc_offset</span> <span class="o">=</span> <span class="n">hdr_size</span> <span class="o">+</span> <span class="n">img_start</span> <span class="o">+</span> <span class="n">image_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">crc_offset</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_get_flash_crc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">flashed_crc</span><span class="p">,</span>
			<span class="p">(</span><span class="n">image_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;could not get crc from flash, not flashing redboot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*update redboot only if crc does not match*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">flashed_crc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">phy_flashing_required</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">TN_8022</span> <span class="o">&amp;&amp;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">interface_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_BASET_10GB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_comp_in_ufi</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">flash_section_info</span> <span class="o">*</span><span class="n">fsec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flash_section_info_g2</span> <span class="o">*</span><span class="n">fsec_g2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">!=</span> <span class="n">BE_GEN3</span><span class="p">)</span>
		<span class="n">fsec_g2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">flash_section_info_g2</span> <span class="o">*</span><span class="p">)</span><span class="n">fsec</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FLASH_COMP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsec_g2</span><span class="p">)</span>
			<span class="n">img_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fsec_g2</span><span class="o">-&gt;</span><span class="n">fsec_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">img_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fsec</span><span class="o">-&gt;</span><span class="n">fsec_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">img_type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">struct</span> <span class="n">flash_section_info</span> <span class="o">*</span><span class="nf">get_fsec_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">header_size</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flash_section_info</span> <span class="o">*</span><span class="n">fsec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">header_size</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fsec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">flash_section_info</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">flash_cookie</span><span class="p">,</span> <span class="n">fsec</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flash_cookie</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">fsec</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">flash_cmd</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">num_of_images</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">filehdr_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">img_hdrs_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_of_images</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">image_hdr</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flash_op</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_bytes</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_write_flashrom</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">flash_cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">flash_comp</span> <span class="o">*</span><span class="n">pflashcomp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_comp</span><span class="p">,</span> <span class="n">hdr_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flash_section_info</span> <span class="o">*</span><span class="n">fsec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">flash_comp</span> <span class="n">gen3_flash_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">FLASH_iSCSI_PRIMARY_IMAGE_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_ISCSI_ACTIVE</span><span class="p">,</span>
			<span class="n">FLASH_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_iSCSI</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_REDBOOT_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_REDBOOT</span><span class="p">,</span>
			<span class="n">FLASH_REDBOOT_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_BOOT_CODE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_iSCSI_BIOS_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_BIOS</span><span class="p">,</span>
			<span class="n">FLASH_BIOS_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_OPTION_ROM_ISCSI</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_PXE_BIOS_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_PXE_BIOS</span><span class="p">,</span>
			<span class="n">FLASH_BIOS_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_OPTION_ROM_PXE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_FCoE_BIOS_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_FCOE_BIOS</span><span class="p">,</span>
			<span class="n">FLASH_BIOS_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_OPTION_ROM_FCoE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_iSCSI_BACKUP_IMAGE_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_ISCSI_BACKUP</span><span class="p">,</span>
			<span class="n">FLASH_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_BACKUP_iSCSI</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_FCoE_PRIMARY_IMAGE_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_FCOE_FW_ACTIVE</span><span class="p">,</span>
			<span class="n">FLASH_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_FCoE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_FCoE_BACKUP_IMAGE_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_FCOE_FW_BACKUP</span><span class="p">,</span>
			<span class="n">FLASH_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_BACKUP_FCoE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_NCSI_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_NCSI_FW</span><span class="p">,</span>
			<span class="n">FLASH_NCSI_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_NCSI</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_PHY_FW_START_g3</span><span class="p">,</span> <span class="n">OPTYPE_PHY_FW</span><span class="p">,</span>
			<span class="n">FLASH_PHY_FW_IMAGE_MAX_SIZE_g3</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_PHY</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">flash_comp</span> <span class="n">gen2_flash_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">FLASH_iSCSI_PRIMARY_IMAGE_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_ISCSI_ACTIVE</span><span class="p">,</span>
			<span class="n">FLASH_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_iSCSI</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_REDBOOT_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_REDBOOT</span><span class="p">,</span>
			<span class="n">FLASH_REDBOOT_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_BOOT_CODE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_iSCSI_BIOS_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_BIOS</span><span class="p">,</span>
			<span class="n">FLASH_BIOS_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_OPTION_ROM_ISCSI</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_PXE_BIOS_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_PXE_BIOS</span><span class="p">,</span>
			<span class="n">FLASH_BIOS_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_OPTION_ROM_PXE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_FCoE_BIOS_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_FCOE_BIOS</span><span class="p">,</span>
			<span class="n">FLASH_BIOS_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_OPTION_ROM_FCoE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_iSCSI_BACKUP_IMAGE_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_ISCSI_BACKUP</span><span class="p">,</span>
			<span class="n">FLASH_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_BACKUP_iSCSI</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_FCoE_PRIMARY_IMAGE_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_FCOE_FW_ACTIVE</span><span class="p">,</span>
			<span class="n">FLASH_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_FCoE</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">FLASH_FCoE_BACKUP_IMAGE_START_g2</span><span class="p">,</span> <span class="n">OPTYPE_FCOE_FW_BACKUP</span><span class="p">,</span>
			 <span class="n">FLASH_IMAGE_MAX_SIZE_g2</span><span class="p">,</span> <span class="n">IMAGE_FIRMWARE_BACKUP_FCoE</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pflashcomp</span> <span class="o">=</span> <span class="n">gen3_flash_types</span><span class="p">;</span>
		<span class="n">filehdr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_file_hdr_g3</span><span class="p">);</span>
		<span class="n">num_comp</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gen3_flash_types</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pflashcomp</span> <span class="o">=</span> <span class="n">gen2_flash_types</span><span class="p">;</span>
		<span class="n">filehdr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_file_hdr_g2</span><span class="p">);</span>
		<span class="n">num_comp</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gen2_flash_types</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Get flash section info*/</span>
	<span class="n">fsec</span> <span class="o">=</span> <span class="n">get_fsec_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">filehdr_size</span> <span class="o">+</span> <span class="n">img_hdrs_size</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Invalid Cookie. UFI corrupted ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_comp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_comp_in_ufi</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fsec</span><span class="p">,</span> <span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">img_type</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optype</span> <span class="o">==</span> <span class="n">OPTYPE_NCSI_FW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="s">&quot;3.102.148.0&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optype</span> <span class="o">==</span> <span class="n">OPTYPE_PHY_FW</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_flashing_required</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hdr_size</span> <span class="o">=</span> <span class="n">filehdr_size</span> <span class="o">+</span>
			   <span class="p">(</span><span class="n">num_of_images</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">image_hdr</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optype</span> <span class="o">==</span> <span class="n">OPTYPE_REDBOOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">be_flash_redboot</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
				       <span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span> <span class="n">hdr_size</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Flash the component */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">filehdr_size</span> <span class="o">+</span> <span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">img_hdrs_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">total_bytes</span> <span class="o">=</span> <span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">total_bytes</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
				<span class="n">num_bytes</span> <span class="o">=</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">total_bytes</span><span class="p">;</span>
			<span class="n">total_bytes</span> <span class="o">-=</span> <span class="n">num_bytes</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_bytes</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optype</span> <span class="o">==</span> <span class="n">OPTYPE_PHY_FW</span><span class="p">)</span>
					<span class="n">flash_op</span> <span class="o">=</span> <span class="n">FLASHROM_OPER_PHY_FLASH</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">flash_op</span> <span class="o">=</span> <span class="n">FLASHROM_OPER_FLASH</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optype</span> <span class="o">==</span> <span class="n">OPTYPE_PHY_FW</span><span class="p">)</span>
					<span class="n">flash_op</span> <span class="o">=</span> <span class="n">FLASHROM_OPER_PHY_SAVE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">flash_op</span> <span class="o">=</span> <span class="n">FLASHROM_OPER_SAVE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_buf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">num_bytes</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_write_flashrom</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">flash_cmd</span><span class="p">,</span>
				<span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optype</span><span class="p">,</span> <span class="n">flash_op</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">ILLEGAL_IOCTL_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">pflashcomp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">optype</span> <span class="o">==</span>
						<span class="n">OPTYPE_PHY_FW</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;cmd to write to flash rom failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ufigen_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_file_hdr_g2</span> <span class="o">*</span><span class="n">fhdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fhdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fhdr</span><span class="o">-&gt;</span><span class="n">build</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;3&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BE_GEN3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fhdr</span><span class="o">-&gt;</span><span class="n">build</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BE_GEN2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lancer_fw_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define LANCER_FW_DOWNLOAD_CHUNK      (32 * 1024)</span>
<span class="cp">#define LANCER_FW_DOWNLOAD_LOCATION   &quot;/prg&quot;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">flash_cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dest_image_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">image_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">add_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;FW Image not properly aligned. &quot;</span>
			<span class="s">&quot;Length must be 4 byte aligned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">lancer_fw_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flash_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lancer_cmd_req_write_object</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">LANCER_FW_DOWNLOAD_CHUNK</span><span class="p">;</span>
	<span class="n">flash_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">flash_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">flash_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flash_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Memory allocation failure while flashing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">lancer_fw_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dest_image_ptr</span> <span class="o">=</span> <span class="n">flash_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lancer_cmd_req_write_object</span><span class="p">);</span>
	<span class="n">image_size</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">data_ptr</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">image_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunk_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">LANCER_FW_DOWNLOAD_CHUNK</span><span class="p">);</span>

		<span class="cm">/* Copy the image chunk content. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest_image_ptr</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_cmd_write_object</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash_cmd</span><span class="p">,</span>
				<span class="n">chunk_size</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">LANCER_FW_DOWNLOAD_LOCATION</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data_written</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">data_written</span><span class="p">;</span>
		<span class="n">data_ptr</span> <span class="o">+=</span> <span class="n">data_written</span><span class="p">;</span>
		<span class="n">image_size</span> <span class="o">-=</span> <span class="n">data_written</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Commit the FW written */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_cmd_write_object</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash_cmd</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">LANCER_FW_DOWNLOAD_LOCATION</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">data_written</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">flash_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">flash_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
				<span class="n">flash_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Firmware load error. &quot;</span>
			<span class="s">&quot;Status code: 0x%x Additional Status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">,</span> <span class="n">add_status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">lancer_fw_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware flashed successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">lancer_fw_exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_fw_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span><span class="o">*</span> <span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flash_file_hdr_g2</span> <span class="o">*</span><span class="n">fhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flash_file_hdr_g3</span> <span class="o">*</span><span class="n">fhdr3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">image_hdr</span> <span class="o">*</span><span class="n">img_hdr_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">flash_cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_imgs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">flash_file_hdr_g2</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">flash_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_write_flashrom</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">flash_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">flash_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">flash_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flash_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Memory allocation failure while flashing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">be_fw_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">get_ufigen_type</span><span class="p">(</span><span class="n">fhdr</span><span class="p">)</span> <span class="o">==</span> <span class="n">BE_GEN3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fhdr3</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">flash_file_hdr_g3</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">num_imgs</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fhdr3</span><span class="o">-&gt;</span><span class="n">num_imgs</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_imgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">img_hdr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">image_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
					<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_file_hdr_g3</span><span class="p">)</span> <span class="o">+</span>
					 <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">image_hdr</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">img_hdr_ptr</span><span class="o">-&gt;</span><span class="n">imageid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">be_flash_data</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash_cmd</span><span class="p">,</span>
							<span class="n">num_imgs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">get_ufigen_type</span><span class="p">(</span><span class="n">fhdr</span><span class="p">)</span> <span class="o">==</span> <span class="n">BE_GEN2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_flash_data</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;UFI and Interface are not compatible for flashing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">flash_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">flash_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			  <span class="n">flash_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware load error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">be_fw_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware flashed successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">be_fw_exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fw_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Firmware load not allowed (interface is down)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fw_exit</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Flashing firmware file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_fw_download</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_fw_download</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>

<span class="nl">fw_exit:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">be_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">be_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">be_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">be_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">be_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">be_mac_addr_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">be_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">be_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">be_vlan_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>	<span class="o">=</span> <span class="n">be_vlan_rem_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_vf_mac</span>		<span class="o">=</span> <span class="n">be_set_vf_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_vf_vlan</span>	<span class="o">=</span> <span class="n">be_set_vf_vlan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_vf_tx_rate</span>	<span class="o">=</span> <span class="n">be_set_vf_tx_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_vf_config</span>	<span class="o">=</span> <span class="n">be_get_vf_config</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">be_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_netdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
		<span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_multi_rxq</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXHASH</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
		<span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IPV6_CSUM</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_UNICAST_FLT</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_MULTICAST</span><span class="p">;</span>

	<span class="n">netif_set_gso_max_size</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">be_netdev_ops</span><span class="p">;</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">be_ethtool_ops</span><span class="p">);</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eqo</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">be_poll</span><span class="p">,</span> <span class="n">BE_NAPI_WEIGHT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_unmap_pci_bars</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">base</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lancer_roce_map_pci_bars</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">total_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_map_pci_bars</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">db_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be_type_2_3</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span>
					<span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">SLI_INTF_TYPE_3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lancer_roce_map_pci_bars</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">pci_map_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">db_reg</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">db_reg</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">db_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">db_reg</span><span class="p">),</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">db_reg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pci_map_err</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sli_family</span> <span class="o">==</span> <span class="n">SKYHAWK_SLI_FAMILY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">=</span>
				<span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">db_reg</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">roce_db</span><span class="p">.</span><span class="n">total_size</span> <span class="o">=</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">db_reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">pci_map_err:</span>
	<span class="n">be_unmap_pci_bars</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_ctrl_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_mem_alloced</span><span class="p">;</span>

	<span class="n">be_unmap_pci_bars</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span>
				  <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_filter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span>
				  <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_ctrl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem_alloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_mem_alloced</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem_align</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_filter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_map_pci_bars</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unmap_pci_bars</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span><span class="p">);</span>
	<span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span><span class="p">));</span>

	<span class="n">rx_filter</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_rx_filter</span><span class="p">);</span>
	<span class="n">rx_filter</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_filter</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rx_filter</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_filter</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_mbox</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_filter</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_filter</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcc_cq_lock</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flash_compl</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_mbox:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			  <span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

<span class="nl">unmap_pci_bars:</span>
	<span class="n">be_unmap_pci_bars</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_stats_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_stats_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_get_stats_v0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lancer_cmd_req_pport_stats</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_get_stats_v1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">be_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">be_roce_dev_remove</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">be_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_stats_cleanup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_ctrl_cleanup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">be_is_wol_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol_cap</span> <span class="o">&amp;</span> <span class="n">BE_WOL_CAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">be_is_wol_excluded</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">be_get_fw_log_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">extfat_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_fat_conf_params</span> <span class="o">*</span><span class="n">cfgs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">extfat_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dma_mem</span><span class="p">));</span>
	<span class="n">extfat_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_get_ext_fat_caps</span><span class="p">);</span>
	<span class="n">extfat_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">extfat_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">extfat_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extfat_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Memory allocation failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_get_ext_fat_capabilites</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extfat_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfgs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_fat_conf_params</span> <span class="o">*</span><span class="p">)(</span><span class="n">extfat_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">+</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cfgs</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">num_modes</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfgs</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">trace_lvl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_UART</span><span class="p">)</span>
				<span class="n">level</span> <span class="o">=</span> <span class="n">cfgs</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">trace_lvl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dbg_lvl</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">extfat_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">extfat_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			    <span class="n">extfat_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_get_initial_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_query_fw_cfg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_caps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">function_mode</span> <span class="o">&amp;</span> <span class="n">FLEX10_MODE</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_vlans</span> <span class="o">=</span> <span class="n">BE_NUM_VLANS_SUPPORTED</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_vlans</span> <span class="o">=</span> <span class="n">BE_NUM_VLANS_SUPPORTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_pmac_cnt</span> <span class="o">=</span> <span class="n">BE_UC_PMAC_COUNT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_pmac_cnt</span> <span class="o">=</span> <span class="n">BE_VF_UC_PMAC_COUNT</span><span class="p">;</span>

	<span class="cm">/* primary mac needs 1 pmac entry */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_pmac_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmac_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_get_cntl_attributes</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_get_acpi_wol_cap</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* in case of a failure to get wol capabillities</span>
<span class="cm">		 * check the exclusion list to determine WOL capability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be_is_wol_excluded</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol_cap</span> <span class="o">|=</span> <span class="n">BE_WOL_CAP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_is_wol_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">level</span> <span class="o">=</span> <span class="n">be_get_fw_log_level</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">FW_LOG_LEVEL_DEFAULT</span> <span class="o">?</span> <span class="n">NETIF_MSG_HW</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_dev_type_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sli_intf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">if_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BE_DEVICE_ID1</span>:
	<span class="k">case</span> <span class="n">OC_DEVICE_ID1</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">BE_GEN2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_DEVICE_ID2</span>:
	<span class="k">case</span> <span class="n">OC_DEVICE_ID2</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">BE_GEN3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OC_DEVICE_ID3</span>:
	<span class="k">case</span> <span class="n">OC_DEVICE_ID4</span>:
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SLI_INTF_REG_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli_intf</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">sli_intf</span> <span class="o">&amp;</span> <span class="n">SLI_INTF_IF_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
						<span class="n">SLI_INTF_IF_TYPE_SHIFT</span><span class="p">;</span>
		<span class="n">if_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">sli_intf</span> <span class="o">&amp;</span> <span class="n">SLI_INTF_IF_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
						<span class="n">SLI_INTF_IF_TYPE_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">sli_intf</span> <span class="o">&amp;</span> <span class="n">SLI_INTF_VALID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SLI_INTF_VALID</span><span class="p">)</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">be_type_2_3</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SLI_INTF reg val is not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sli_family</span> <span class="o">=</span> <span class="p">((</span><span class="n">sli_intf</span> <span class="o">&amp;</span> <span class="n">SLI_INTF_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="n">SLI_INTF_FAMILY_SHIFT</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">BE_GEN3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OC_DEVICE_ID5</span>:
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SLI_INTF_REG_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli_intf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sli_intf</span> <span class="o">&amp;</span> <span class="n">SLI_INTF_VALID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SLI_INTF_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SLI_INTF reg val is not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sli_family</span> <span class="o">=</span> <span class="p">((</span><span class="n">sli_intf</span> <span class="o">&amp;</span> <span class="n">SLI_INTF_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					 <span class="n">SLI_INTF_FAMILY_SHIFT</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">BE_GEN3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SLI_INTF_REG_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli_intf</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">virtfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sli_intf</span> <span class="o">&amp;</span> <span class="n">SLI_INTF_FT_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lancer_wait_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define SLIPORT_READY_TIMEOUT 30</span>
	<span class="n">u32</span> <span class="n">sliport_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SLIPORT_READY_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sliport_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">SLIPORT_STATUS_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sliport_status</span> <span class="o">&amp;</span> <span class="n">SLIPORT_STATUS_RDY_MASK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">SLIPORT_READY_TIMEOUT</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lancer_test_and_set_rdy_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sliport_status</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">reset_needed</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_wait_ready</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sliport_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">SLIPORT_STATUS_OFFSET</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sliport_status</span> <span class="o">&amp;</span> <span class="n">SLIPORT_STATUS_ERR_MASK</span><span class="p">;</span>
		<span class="n">reset_needed</span> <span class="o">=</span> <span class="n">sliport_status</span> <span class="o">&amp;</span> <span class="n">SLIPORT_STATUS_RN_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">reset_needed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">SLI_PORT_CONTROL_IP_MASK</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">SLIPORT_CONTROL_OFFSET</span><span class="p">);</span>

			<span class="cm">/* check adapter has corrected the error */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_wait_ready</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">sliport_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span>
							<span class="n">SLIPORT_STATUS_OFFSET</span><span class="p">);</span>
			<span class="n">sliport_status</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SLIPORT_STATUS_ERR_MASK</span> <span class="o">|</span>
						<span class="n">SLIPORT_STATUS_RN_MASK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="n">sliport_status</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">reset_needed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lancer_test_and_recover_fn_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sliport_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span> <span class="o">||</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ue_detected</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sliport_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">SLIPORT_STATUS_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sliport_status</span> <span class="o">&amp;</span> <span class="n">SLIPORT_STATUS_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Adapter in error state.&quot;</span>
				<span class="s">&quot;Trying to recover.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_test_and_set_rdy_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">be_close</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="n">be_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_timeout</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">be_setup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">be_open</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Adapter error recovery succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Adapter error recovery failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_adapter</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_rx_obj</span> <span class="o">*</span><span class="n">rxo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">eqo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">lancer_test_and_recover_fn_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">be_detect_dump_ue</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* when interrupts are not yet enabled, just reap any pending</span>
<span class="cm">	* mcc completions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">be_process_mcc</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reschedule</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd_sent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">lancer_cmd_get_pport_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">be_cmd_get_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_all_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rxo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxo</span><span class="o">-&gt;</span><span class="n">rx_post_starved</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxo</span><span class="o">-&gt;</span><span class="n">rx_post_starved</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">be_post_rx_frags</span><span class="p">(</span><span class="n">rxo</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">for_all_evt_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">be_eqd_update</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">eqo</span><span class="p">);</span>

<span class="nl">reschedule:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_counter</span><span class="o">++</span><span class="p">;</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">be_reset_required</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_CUST_SCRATCHPAD_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">be_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pdev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_none</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_dev</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_adapter</span><span class="p">),</span> <span class="n">MAX_TX_QS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rel_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_dev_type_check</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_netdev</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not set PCI DMA Mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_netdev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_ctrl_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_wait_ready</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">SLI_PORT_CONTROL_IP_MASK</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">SLIPORT_CONTROL_OFFSET</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">lancer_test_and_set_rdy_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adapter in non recoverable error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ctrl_clean</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* sync up with fw&#39;s ready state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_physfn</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_POST</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ctrl_clean</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* tell fw we&#39;re ready to fire cmds */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_fw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ctrl_clean</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_reset_required</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_reset_function</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ctrl_clean</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The INTR bit may be set in the card when probed by a kdump kernel</span>
<span class="cm">	 * after a crash.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lancer_chip</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">be_intr_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_stats_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ctrl_clean</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_get_initial_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">stats_clean</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">be_worker</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_fc</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_fc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_setup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">msix_disable</span><span class="p">;</span>

	<span class="n">be_netdev_init</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unsetup</span><span class="p">;</span>

	<span class="n">be_roce_dev_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nic_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unsetup:</span>
	<span class="n">be_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">msix_disable:</span>
	<span class="n">be_msix_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">stats_clean:</span>
	<span class="n">be_stats_cleanup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">ctrl_clean:</span>
	<span class="n">be_ctrl_cleanup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">rel_reg:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">disable_dev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">do_none:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nic_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span>  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span>
		<span class="n">be_setup_wol</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">be_close</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">be_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span>  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* tell fw we&#39;re ready to fire cmds */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_fw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">be_setup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">be_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span>
		<span class="n">be_setup_wol</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * An FLR will stop BE from DMAing any data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span>
		<span class="n">be_setup_wol</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">be_cmd_reset_function</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">be_eeh_err_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span>  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EEH error detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">be_close</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">be_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* The error could cause the FW to trigger a flash debug dump.</span>
<span class="cm">	 * Resetting the card while flash dump is in progress</span>
<span class="cm">	 * can cause it not to recover; wait for it to finish</span>
<span class="cm">	 */</span>
	<span class="n">ssleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">be_eeh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EEH reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eeh_err</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ue_detected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_timeout</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Check if card is ok and fw is ready */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_POST</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_eeh_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span>  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EEH resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* tell fw we&#39;re ready to fire cmds */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_fw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_setup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EEH resume failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">be_eeh_handlers</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">be_eeh_err_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">be_eeh_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">be_eeh_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">be_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">be_dev_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">be_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">be_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">be_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">be_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">be_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">be_eeh_handlers</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">be_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_frag_size</span> <span class="o">!=</span> <span class="mi">8192</span> <span class="o">&amp;&amp;</span> <span class="n">rx_frag_size</span> <span class="o">!=</span> <span class="mi">4096</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rx_frag_size</span> <span class="o">!=</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
			<span class="s">&quot; : Module param rx_frag_size must be 2048/4096/8192.&quot;</span>
			<span class="s">&quot; Using 2048</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_frag_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">be_init_module</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">be_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">be_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
