<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › 3c507.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>3c507.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* 3c507.c: An EtherLink16 device driver for Linux. */</span>
<span class="cm">/*</span>
<span class="cm">	Written 1993,1994 by Donald Becker.</span>

<span class="cm">	Copyright 1993 United States Government as represented by the</span>
<span class="cm">	Director, National Security Agency.</span>

<span class="cm">	This software may be used and distributed according to the terms</span>
<span class="cm">	of the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">	The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>


<span class="cm">	Thanks go to jennings@Montrouge.SMR.slb.com ( Patrick Jennings)</span>
<span class="cm">	and jrs@world.std.com (Rick Sladkey) for testing and bugfixes.</span>
<span class="cm">	Mark Salazar &lt;leslie@access.digex.net&gt; made the changes for cards with</span>
<span class="cm">	only 16K packet buffers.</span>

<span class="cm">	Things remaining to do:</span>
<span class="cm">	Verify that the tx and rx buffers don&#39;t have fencepost errors.</span>
<span class="cm">	Move the theory of operation and memory map documentation.</span>
<span class="cm">	The statistics need to be updated correctly.</span>
<span class="cm">*/</span>

<span class="cp">#define DRV_NAME		&quot;3c507&quot;</span>
<span class="cp">#define DRV_VERSION		&quot;1.10a&quot;</span>
<span class="cp">#define DRV_RELDATE		&quot;11/17/2001&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">DRV_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot; Donald Becker (becker@scyld.com)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">  Sources:</span>
<span class="cm">	This driver wouldn&#39;t have been written with the availability of the</span>
<span class="cm">	Crynwr driver source code.	It provided a known-working implementation</span>
<span class="cm">	that filled in the gaping holes of the Intel documentation.  Three cheers</span>
<span class="cm">	for Russ Nelson.</span>

<span class="cm">	Intel Microcommunications Databook, Vol. 1, 1990.  It provides just enough</span>
<span class="cm">	info that the casual reader might think that it documents the i82586 :-&lt;.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* use 0 for production, 1 for verification, 2..7 for debug */</span>
<span class="cp">#ifndef NET_DEBUG</span>
<span class="cp">#define NET_DEBUG 1</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">net_debug</span> <span class="o">=</span> <span class="n">NET_DEBUG</span><span class="p">;</span>
<span class="cp">#define debug net_debug</span>


<span class="cm">/*</span>
<span class="cm">  			Details of the i82586.</span>

<span class="cm">   You&#39;ll really need the databook to understand the details of this part,</span>
<span class="cm">   but the outline is that the i82586 has two separate processing units.</span>
<span class="cm">   Both are started from a list of three configuration tables, of which only</span>
<span class="cm">   the last, the System Control Block (SCB), is used after reset-time.  The SCB</span>
<span class="cm">   has the following fields:</span>
<span class="cm">		Status word</span>
<span class="cm">		Command word</span>
<span class="cm">		Tx/Command block addr.</span>
<span class="cm">		Rx block addr.</span>
<span class="cm">   The command word accepts the following controls for the Tx and Rx units:</span>
<span class="cm">  */</span>

<span class="cp">#define	 CUC_START	 0x0100</span>
<span class="cp">#define	 CUC_RESUME	 0x0200</span>
<span class="cp">#define	 CUC_SUSPEND 0x0300</span>
<span class="cp">#define	 RX_START	 0x0010</span>
<span class="cp">#define	 RX_RESUME	 0x0020</span>
<span class="cp">#define	 RX_SUSPEND	 0x0030</span>

<span class="cm">/* The Rx unit uses a list of frame descriptors and a list of data buffer</span>
<span class="cm">   descriptors.  We use full-sized (1518 byte) data buffers, so there is</span>
<span class="cm">   a one-to-one pairing of frame descriptors to buffer descriptors.</span>

<span class="cm">   The Tx (&quot;command&quot;) unit executes a list of commands that look like:</span>
<span class="cm">		Status word		Written by the 82586 when the command is done.</span>
<span class="cm">		Command word	Command in lower 3 bits, post-command action in upper 3</span>
<span class="cm">		Link word		The address of the next command.</span>
<span class="cm">		Parameters		(as needed).</span>

<span class="cm">	Some definitions related to the Command Word are:</span>
<span class="cm"> */</span>
<span class="cp">#define CMD_EOL		0x8000			</span><span class="cm">/* The last command of the list, stop. */</span><span class="cp"></span>
<span class="cp">#define CMD_SUSP	0x4000			</span><span class="cm">/* Suspend after doing cmd. */</span><span class="cp"></span>
<span class="cp">#define CMD_INTR	0x2000			</span><span class="cm">/* Interrupt after doing cmd. */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">commands</span> <span class="p">{</span>
	<span class="n">CmdNOp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CmdSASetup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CmdConfigure</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">CmdMulticastList</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CmdTx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">CmdTDR</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CmdDump</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">CmdDiagnose</span> <span class="o">=</span> <span class="mi">7</span><span class="p">};</span>

<span class="cm">/* Information that need to be kept for each board. */</span>
<span class="k">struct</span> <span class="n">net_local</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">last_restart</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">rx_head</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">rx_tail</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">tx_head</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">tx_cmd_link</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">tx_reap</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">tx_pkts_in_ring</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">  		Details of the EtherLink16 Implementation</span>
<span class="cm">  The 3c507 is a generic shared-memory i82586 implementation.</span>
<span class="cm">  The host can map 16K, 32K, 48K, or 64K of the 64K memory into</span>
<span class="cm">  0x0[CD][08]0000, or all 64K into 0xF[02468]0000.</span>
<span class="cm">  */</span>

<span class="cm">/* Offsets from the base I/O address. */</span>
<span class="cp">#define	SA_DATA		0	</span><span class="cm">/* Station address data, or 3Com signature. */</span><span class="cp"></span>
<span class="cp">#define MISC_CTRL	6	</span><span class="cm">/* Switch the SA_DATA banks, and bus config bits. */</span><span class="cp"></span>
<span class="cp">#define RESET_IRQ	10	</span><span class="cm">/* Reset the latched IRQ line. */</span><span class="cp"></span>
<span class="cp">#define SIGNAL_CA	11	</span><span class="cm">/* Frob the 82586 Channel Attention line. */</span><span class="cp"></span>
<span class="cp">#define ROM_CONFIG	13</span>
<span class="cp">#define MEM_CONFIG	14</span>
<span class="cp">#define IRQ_CONFIG	15</span>
<span class="cp">#define EL16_IO_EXTENT 16</span>

<span class="cm">/* The ID port is used at boot-time to locate the ethercard. */</span>
<span class="cp">#define ID_PORT		0x100</span>

<span class="cm">/* Offsets to registers in the mailbox (SCB). */</span>
<span class="cp">#define iSCB_STATUS	0x8</span>
<span class="cp">#define iSCB_CMD		0xA</span>
<span class="cp">#define iSCB_CBL		0xC	</span><span class="cm">/* Command BLock offset. */</span><span class="cp"></span>
<span class="cp">#define iSCB_RFA		0xE	</span><span class="cm">/* Rx Frame Area offset. */</span><span class="cp"></span>

<span class="cm">/*  Since the 3c507 maps the shared memory window so that the last byte is</span>
<span class="cm">	at 82586 address FFFF, the first byte is at 82586 address 0, 16K, 32K, or</span>
<span class="cm">	48K corresponding to window sizes of 64K, 48K, 32K and 16K respectively.</span>
<span class="cm">	We can account for this be setting the &#39;SBC Base&#39; entry in the ISCP table</span>
<span class="cm">	below for all the 16 bit offset addresses, and also adding the &#39;SCB Base&#39;</span>
<span class="cm">	value to all 24 bit physical addresses (in the SCP table and the TX and RX</span>
<span class="cm">	Buffer Descriptors).</span>
<span class="cm">					-Mark</span>
<span class="cm">	*/</span>
<span class="cp">#define SCB_BASE		((unsigned)64*1024 - (dev-&gt;mem_end - dev-&gt;mem_start))</span>

<span class="cm">/*</span>
<span class="cm">  What follows in &#39;init_words[]&#39; is the &quot;program&quot; that is downloaded to the</span>
<span class="cm">  82586 memory.	 It&#39;s mostly tables and command blocks, and starts at the</span>
<span class="cm">  reset address 0xfffff6.  This is designed to be similar to the EtherExpress,</span>
<span class="cm">  thus the unusual location of the SCB at 0x0008.</span>

<span class="cm">  Even with the additional &quot;don&#39;t care&quot; values, doing it this way takes less</span>
<span class="cm">  program space than initializing the individual tables, and I feel it&#39;s much</span>
<span class="cm">  cleaner.</span>

<span class="cm">  The databook is particularly useless for the first two structures, I had</span>
<span class="cm">  to use the Crynwr driver as an example.</span>

<span class="cm">   The memory setup is as follows:</span>
<span class="cm">   */</span>

<span class="cp">#define CONFIG_CMD	0x0018</span>
<span class="cp">#define SET_SA_CMD	0x0024</span>
<span class="cp">#define SA_OFFSET	0x002A</span>
<span class="cp">#define IDLELOOP	0x30</span>
<span class="cp">#define TDR_CMD		0x38</span>
<span class="cp">#define TDR_TIME	0x3C</span>
<span class="cp">#define DUMP_CMD	0x40</span>
<span class="cp">#define DIAG_CMD	0x48</span>
<span class="cp">#define SET_MC_CMD	0x4E</span>
<span class="cp">#define DUMP_DATA	0x56	</span><span class="cm">/* A 170 byte buffer for dump and Set-MC into. */</span><span class="cp"></span>

<span class="cp">#define TX_BUF_START	0x0100</span>
<span class="cp">#define NUM_TX_BUFS 	5</span>
<span class="cp">#define TX_BUF_SIZE 	(1518+14+20+16) </span><span class="cm">/* packet+header+TBD */</span><span class="cp"></span>

<span class="cp">#define RX_BUF_START	0x2000</span>
<span class="cp">#define RX_BUF_SIZE 	(1518+14+18)	</span><span class="cm">/* packet+header+RBD */</span><span class="cp"></span>
<span class="cp">#define RX_BUF_END		(dev-&gt;mem_end - dev-&gt;mem_start)</span>

<span class="cp">#define TX_TIMEOUT (HZ/20)</span>

<span class="cm">/*</span>
<span class="cm">  That&#39;s it: only 86 bytes to set up the beast, including every extra</span>
<span class="cm">  command available.  The 170 byte buffer at DUMP_DATA is shared between the</span>
<span class="cm">  Dump command (called only by the diagnostic program) and the SetMulticastList</span>
<span class="cm">  command.</span>

<span class="cm">  To complete the memory setup you only have to write the station address at</span>
<span class="cm">  SA_OFFSET and create the Tx &amp; Rx buffer lists.</span>

<span class="cm">  The Tx command chain and buffer list is setup as follows:</span>
<span class="cm">  A Tx command table, with the data buffer pointing to...</span>
<span class="cm">  A Tx data buffer descriptor.  The packet is in a single buffer, rather than</span>
<span class="cm">	chaining together several smaller buffers.</span>
<span class="cm">  A NoOp command, which initially points to itself,</span>
<span class="cm">  And the packet data.</span>

<span class="cm">  A transmit is done by filling in the Tx command table and data buffer,</span>
<span class="cm">  re-writing the NoOp command, and finally changing the offset of the last</span>
<span class="cm">  command to point to the current Tx command.  When the Tx command is finished,</span>
<span class="cm">  it jumps to the NoOp, when it loops until the next Tx command changes the</span>
<span class="cm">  &quot;link offset&quot; in the NoOp.  This way the 82586 never has to go through the</span>
<span class="cm">  slow restart sequence.</span>

<span class="cm">  The Rx buffer list is set up in the obvious ring structure.  We have enough</span>
<span class="cm">  memory (and low enough interrupt latency) that we can avoid the complicated</span>
<span class="cm">  Rx buffer linked lists by alway associating a full-size Rx data buffer with</span>
<span class="cm">  each Rx data frame.</span>

<span class="cm">  I current use four transmit buffers starting at TX_BUF_START (0x0100), and</span>
<span class="cm">  use the rest of memory, from RX_BUF_START to RX_BUF_END, for Rx buffers.</span>

<span class="cm">  */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">init_words</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*	System Configuration Pointer (SCP). */</span>
	<span class="mh">0x0000</span><span class="p">,</span>					<span class="cm">/* Set bus size to 16 bits. */</span>
	<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>					<span class="cm">/* pad words. */</span>
	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>			<span class="cm">/* ISCP phys addr, set in init_82586_mem(). */</span>

	<span class="cm">/*	Intermediate System Configuration Pointer (ISCP). */</span>
	<span class="mh">0x0001</span><span class="p">,</span>					<span class="cm">/* Status word that&#39;s cleared when init is done. */</span>
	<span class="mh">0x0008</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>				<span class="cm">/* SCB offset, (skip, skip) */</span>

	<span class="cm">/* System Control Block (SCB). */</span>
	<span class="mi">0</span><span class="p">,</span><span class="mh">0xf000</span><span class="o">|</span><span class="n">RX_START</span><span class="o">|</span><span class="n">CUC_START</span><span class="p">,</span>	<span class="cm">/* SCB status and cmd. */</span>
	<span class="n">CONFIG_CMD</span><span class="p">,</span>				<span class="cm">/* Command list pointer, points to Configure. */</span>
	<span class="n">RX_BUF_START</span><span class="p">,</span>				<span class="cm">/* Rx block list. */</span>
	<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>				<span class="cm">/* Error count: CRC, align, buffer, overrun. */</span>

	<span class="cm">/* 0x0018: Configure command.  Change to put MAC data with packet. */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">CmdConfigure</span><span class="p">,</span>		<span class="cm">/* Status, command.		*/</span>
	<span class="n">SET_SA_CMD</span><span class="p">,</span>				<span class="cm">/* Next command is Set Station Addr. */</span>
	<span class="mh">0x0804</span><span class="p">,</span>					<span class="cm">/* &quot;4&quot; bytes of config data, 8 byte FIFO. */</span>
	<span class="mh">0x2e40</span><span class="p">,</span>					<span class="cm">/* Magic values, including MAC data location. */</span>
	<span class="mi">0</span><span class="p">,</span>						<span class="cm">/* Unused pad word. */</span>

	<span class="cm">/* 0x0024: Setup station address command. */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">CmdSASetup</span><span class="p">,</span>
	<span class="n">SET_MC_CMD</span><span class="p">,</span>				<span class="cm">/* Next command. */</span>
	<span class="mh">0xaa00</span><span class="p">,</span><span class="mh">0xb000</span><span class="p">,</span><span class="mh">0x0bad</span><span class="p">,</span>	<span class="cm">/* Station address (to be filled in) */</span>

	<span class="cm">/* 0x0030: NOP, looping back to itself.	 Point to first Tx buffer to Tx. */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">CmdNOp</span><span class="p">,</span> <span class="n">IDLELOOP</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* pad */</span><span class="p">,</span>

	<span class="cm">/* 0x0038: A unused Time-Domain Reflectometer command. */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">CmdTDR</span><span class="p">,</span> <span class="n">IDLELOOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>

	<span class="cm">/* 0x0040: An unused Dump State command. */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">CmdDump</span><span class="p">,</span> <span class="n">IDLELOOP</span><span class="p">,</span> <span class="n">DUMP_DATA</span><span class="p">,</span>

	<span class="cm">/* 0x0048: An unused Diagnose command. */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">CmdDiagnose</span><span class="p">,</span> <span class="n">IDLELOOP</span><span class="p">,</span>

	<span class="cm">/* 0x004E: An empty set-multicast-list command. */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="n">CmdMulticastList</span><span class="p">,</span> <span class="n">IDLELOOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Index to functions, as function prototypes. */</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">el16_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">el16_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">el16_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">el16_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">el16_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">el16_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">el16_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">length</span><span class="p">,</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_82586_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mem_start</span><span class="p">;</span>


<span class="cm">/* Check for a network adaptor of this type, and return &#39;0&#39; iff one exists.</span>
<span class="cm">	If dev-&gt;base_addr == 0, probe all likely locations.</span>
<span class="cm">	If dev-&gt;base_addr == 1, always return failure.</span>
<span class="cm">	If dev-&gt;base_addr == 2, (detachable devices only) allocate space for the</span>
<span class="cm">	device and return success.</span>
<span class="cm">	*/</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">el16_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">io</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">mem_start</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span> 	<span class="cm">/* Check a single specified location. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">el16_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>		<span class="cm">/* Don&#39;t probe at all. */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">ports</span><span class="p">;</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">el16_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(((</span><span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EL16_IO_EXTENT</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">el16_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">el16_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> 	<span class="o">=</span> <span class="n">el16_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> 	<span class="o">=</span> <span class="n">el16_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">el16_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">init_ID_done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irqval</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_ID_done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ushort</span> <span class="n">lrs_state</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="cm">/* Send the ID sequence to the ID_PORT to enable the board(s). */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ID_PORT</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">lrs_state</span><span class="p">,</span> <span class="n">ID_PORT</span><span class="p">);</span>
			<span class="n">lrs_state</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lrs_state</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
				<span class="n">lrs_state</span> <span class="o">^=</span> <span class="mh">0xe7</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ID_PORT</span><span class="p">);</span>
		<span class="n">init_ID_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EL16_IO_EXTENT</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;3&#39;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;O&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: 3c507 at %#x,&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* We should make a few more checks here, like the first three octets of</span>
<span class="cm">	   the S.A. for the manufacturer&#39;s code. */</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IRQ_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="n">irqval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">el16_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;3c507: unable to get IRQ %d (irqval=%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irqval</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We&#39;ve committed to using the board, and can start filling in *dev. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %pM&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_start</span><span class="p">)</span>
		<span class="n">net_debug</span> <span class="o">=</span> <span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

<span class="cp">#ifdef MEM_BASE</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">MEM_BASE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">base</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">mem_config</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MEM_CONFIG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_config</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mh">0xf00000</span> <span class="o">+</span> <span class="p">(</span><span class="n">mem_config</span> <span class="o">&amp;</span> <span class="mh">0x08</span> <span class="o">?</span> <span class="mh">0x080000</span>
							   <span class="o">:</span> <span class="p">((</span><span class="n">mem_config</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">mem_config</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mh">0x0c0000</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="n">mem_config</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ROM_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IRQ_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, IRQ %d, %sternal xcvr, memory %#lx-%#lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">?</span> <span class="s">&quot;ex&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">RX_BUF_END</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;3c507: unable to remap memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ethtool_ops</span><span class="p">;</span>
 	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_MULTICAST</span><span class="p">;</span>	<span class="cm">/* Multicast doesn&#39;t work */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EL16_IO_EXTENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">el16_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Initialize the 82586 memory and start it. */</span>
	<span class="n">init_82586_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">el16_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">shmem</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: transmit timed out, %s?  &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">readw</span><span class="p">(</span><span class="n">shmem</span> <span class="o">+</span> <span class="n">iSCB_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span> <span class="o">?</span> <span class="s">&quot;IRQ conflict&quot;</span> <span class="o">:</span>
			<span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>
	<span class="cm">/* Try to restart the adaptor. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_restart</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Resetting board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Completely reset the adaptor. */</span>
		<span class="n">init_82586_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Issue the channel attention signal and hope it &quot;gets better&quot;. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Kicking board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0xf000</span> <span class="o">|</span> <span class="n">CUC_START</span> <span class="o">|</span> <span class="n">RX_START</span><span class="p">,</span> <span class="n">shmem</span> <span class="o">+</span> <span class="n">iSCB_CMD</span><span class="p">);</span>
		<span class="n">outb</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SIGNAL_CA</span><span class="p">);</span>	<span class="cm">/* Issue channel-attn. */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_restart</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">el16_send_packet</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="cm">/* Disable the 82586&#39;s input to the interrupt line. */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>

	<span class="n">hardware_send_packet</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Enable the 82586 interrupt input. */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x84</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* You might need to clean up and record Tx statistics here. */</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*	The typical workload of the driver:</span>
<span class="cm">	Handle the network interface interrupts. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">el16_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">ack_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">shmem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;net_interrupt(): irq %d for unknown device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">shmem</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: 3c507 interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the 82586&#39;s input to the interrupt line. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>

	<span class="cm">/* Reap the Tx packet buffers. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_ring</span><span class="p">)</span> <span class="p">{</span>
	  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">shmem</span><span class="o">+</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Tx command incomplete (%#x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="cm">/* Tx unsuccessful or some interesting status bit set. */</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0f3f</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0600</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">))</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		  <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Reaped %x, Tx status %04x.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>
	  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">+=</span> <span class="n">TX_BUF_SIZE</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">&gt;</span> <span class="n">RX_BUF_START</span> <span class="o">-</span> <span class="n">TX_BUF_SIZE</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>

	  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_ring</span><span class="o">--</span><span class="p">;</span>
	  <span class="cm">/* There is always more space in the Tx ring buffer now. */</span>
	  <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">boguscount</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Packet received. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received packet, rx_head %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">);</span>
		<span class="n">el16_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Acknowledge the interrupt sources. */</span>
	<span class="n">ack_cmd</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0700</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0200</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Command unit stopped, status %04x, restarting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="cm">/* If this ever occurs we should really re-write the idle loop, reset</span>
<span class="cm">		   the Tx list, and do a complete restart of the command unit.</span>
<span class="cm">		   For now we rely on the Tx timeout if the resume doesn&#39;t work. */</span>
		<span class="n">ack_cmd</span> <span class="o">|=</span> <span class="n">CUC_RESUME</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0070</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0040</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The Rx unit is not ready, it must be hung.  Restart the receiver by</span>
<span class="cm">		   initializing the rx buffers, and issuing an Rx start command. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Rx unit stopped, status %04x, restarting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">init_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">RX_BUF_START</span><span class="p">,</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_RFA</span><span class="p">);</span>
		<span class="n">ack_cmd</span> <span class="o">|=</span> <span class="n">RX_START</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">ack_cmd</span><span class="p">,</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_CMD</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SIGNAL_CA</span><span class="p">);</span>			<span class="cm">/* Issue channel-attn. */</span>

	<span class="cm">/* Clear the latched interrupt. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RESET_IRQ</span><span class="p">);</span>

	<span class="cm">/* Enable the 82586&#39;s interrupt input. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x84</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">el16_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">shmem</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Flush the Tx and disable Rx. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">RX_SUSPEND</span> <span class="o">|</span> <span class="n">CUC_SUSPEND</span><span class="p">,</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_CMD</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SIGNAL_CA</span><span class="p">);</span>

	<span class="cm">/* Disable the 82586&#39;s input to the interrupt line. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>

	<span class="cm">/* We always physically use the IRQ line, so we don&#39;t do free_irq(). */</span>

	<span class="cm">/* Update the statistics here. */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the Rx-block list. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">write_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">SCB_base</span> <span class="o">=</span> <span class="n">SCB_BASE</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">cur_rxbuf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_head</span> <span class="o">=</span> <span class="n">RX_BUF_START</span><span class="p">;</span>

	<span class="cm">/* Initialize each Rx frame + data buffer. */</span>
	<span class="k">do</span> <span class="p">{</span>	<span class="cm">/* While there is room for one more. */</span>

		<span class="n">write_ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">cur_rxbuf</span><span class="p">;</span>

		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="p">);</span>			<span class="cm">/* Status */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Command */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">cur_rxbuf</span> <span class="o">+</span> <span class="n">RX_BUF_SIZE</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Link */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">cur_rxbuf</span> <span class="o">+</span> <span class="mi">22</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>		<span class="cm">/* Buffer offset */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Pad for dest addr. */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Pad for source addr. */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Pad for protocol. */</span>

		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Buffer: Actual count */</span>
		<span class="n">writew</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Buffer: Next (none). */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">cur_rxbuf</span> <span class="o">+</span> <span class="mh">0x20</span> <span class="o">+</span> <span class="n">SCB_base</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span><span class="cm">/* Buffer: Address low */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* Finally, the number of bytes in the buffer. */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x8000</span> <span class="o">+</span> <span class="n">RX_BUF_SIZE</span><span class="o">-</span><span class="mh">0x20</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="n">cur_rxbuf</span><span class="p">;</span>
		<span class="n">cur_rxbuf</span> <span class="o">+=</span> <span class="n">RX_BUF_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cur_rxbuf</span> <span class="o">&lt;=</span> <span class="n">RX_BUF_END</span> <span class="o">-</span> <span class="n">RX_BUF_SIZE</span><span class="p">);</span>

	<span class="cm">/* Terminate the list by setting the EOL bit, and wrap the pointer to make</span>
<span class="cm">	   the list a ring. */</span>
	<span class="n">write_ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xC000</span><span class="p">,</span><span class="n">write_ptr</span><span class="p">);</span>				<span class="cm">/* Command, mark as last. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Link */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_82586_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">shmem</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/* Enable loopback to protect the wire while starting up,</span>
<span class="cm">	   and hold the 586 in reset during the memory initialization. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>

	<span class="cm">/* Fix the ISCP address and base. */</span>
	<span class="n">init_words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_BASE</span><span class="p">;</span>
	<span class="n">init_words</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_BASE</span><span class="p">;</span>

	<span class="cm">/* Write the words at 0xfff6 (address-aliased to 0xfffff6). */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RX_BUF_END</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">init_words</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Write the words at 0x0000. */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">init_words</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">init_words</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Fill in the station address. */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="n">SA_OFFSET</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* The Tx-block list is written as needed.  We just set up the values. */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_cmd_link</span> <span class="o">=</span> <span class="n">IDLELOOP</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>

	<span class="n">init_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Start the 586 by releasing the reset line, but leave loopback. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xA0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>

	<span class="cm">/* This was time consuming to track down: you need to give two channel</span>
<span class="cm">	   attention signals to reliably start up the i82586. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SIGNAL_CA</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">boguscnt</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_STATUS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: i82586 initialization timed out with status %04x, cmd %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readw</span><span class="p">(</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_STATUS</span><span class="p">),</span> <span class="n">readw</span><span class="p">(</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_CMD</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="cm">/* Issue channel-attn -- the 82586 won&#39;t start. */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SIGNAL_CA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable loopback and enable interrupts. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x84</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MISC_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Initialized 82586, status %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">readw</span><span class="p">(</span><span class="n">shmem</span><span class="o">+</span><span class="n">iSCB_STATUS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">length</span><span class="p">,</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">tx_block</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">write_ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">tx_block</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">padding</span><span class="p">[</span><span class="n">ETH_ZLEN</span><span class="p">];</span>

	<span class="cm">/* Set the write pointer to the Tx block, and put out the header. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="p">);</span>			<span class="cm">/* Tx status */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CMD_INTR</span><span class="o">|</span><span class="n">CmdTx</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>		<span class="cm">/* Tx command */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>		<span class="cm">/* Next command is a NoOp. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Data Buffer offset. */</span>

	<span class="cm">/* Output the data buffer descriptor. */</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">pad</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>		<span class="cm">/* Byte count parameter. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* No next data buffer. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mi">22</span><span class="o">+</span><span class="n">SCB_BASE</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Buffer follows the NoOp command. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Buffer address high bits (always zero). */</span>

	<span class="cm">/* Output the Loop-back NoOp command. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Tx status */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CmdNOp</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>			<span class="cm">/* Tx command */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span><span class="n">write_ptr</span><span class="o">+=</span><span class="mi">2</span><span class="p">);</span>		<span class="cm">/* Next is myself. */</span>

	<span class="cm">/* Output the packet at the write pointer. */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">write_ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">write_ptr</span><span class="o">+</span><span class="n">length</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>

	<span class="cm">/* Set the old command link pointing to this send packet. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tx_block</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_cmd_link</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_cmd_link</span> <span class="o">=</span> <span class="n">tx_block</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>

	<span class="cm">/* Set the next free tx region. */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">tx_block</span> <span class="o">+</span> <span class="n">TX_BUF_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">&gt;</span> <span class="n">RX_BUF_START</span> <span class="o">-</span> <span class="n">TX_BUF_SIZE</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: 3c507 @%x send length = %d, tx_block %3x, next %3x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">tx_block</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Grimly block further packets if there has been insufficient reaping. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_pkts_in_ring</span> <span class="o">&lt;</span> <span class="n">NUM_TX_BUFS</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">el16_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">shmem</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">rx_head</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">rx_tail</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">frame_status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">frame_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">shmem</span><span class="o">+</span><span class="n">rx_head</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* Command complete */</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">read_frame</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">rx_head</span><span class="p">;</span>
		<span class="n">ushort</span> <span class="n">rfd_cmd</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">read_frame</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">ushort</span> <span class="n">next_rx_frame</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">read_frame</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">ushort</span> <span class="n">data_buffer_addr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">read_frame</span><span class="o">+</span><span class="mi">6</span><span class="p">);</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data_frame</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">data_buffer_addr</span><span class="p">;</span>
		<span class="n">ushort</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">data_frame</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rfd_cmd</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">data_buffer_addr</span> <span class="o">!=</span> <span class="n">rx_head</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Rx frame at %#x corrupted, &quot;</span>
			       <span class="s">&quot;status %04x cmd %04x next %04x &quot;</span>
			       <span class="s">&quot;data-buf @%04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_head</span><span class="p">,</span> <span class="n">frame_status</span><span class="p">,</span> <span class="n">rfd_cmd</span><span class="p">,</span>
			       <span class="n">next_rx_frame</span><span class="p">,</span> <span class="n">data_buffer_addr</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Frame Rxed, but with error. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Malloc up new buffer. */</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">pkt_len</span> <span class="o">&amp;=</span> <span class="mh">0x3fff</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

			<span class="cm">/* &#39;skb-&gt;data&#39; points to the start of sk_buff data area. */</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">pkt_len</span><span class="p">),</span> <span class="n">data_frame</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Clear the status word and set End-of-List on the rx frame. */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">read_frame</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0xC000</span><span class="p">,</span><span class="n">read_frame</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* Clear the end-of-list on the prev. RFD. */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">rx_tail</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">rx_tail</span> <span class="o">=</span> <span class="n">rx_head</span><span class="p">;</span>
		<span class="n">rx_head</span> <span class="o">=</span> <span class="n">next_rx_frame</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_head</span> <span class="o">=</span> <span class="n">rx_head</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="n">rx_tail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;ISA 0x%lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netdev_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">netdev_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">netdev_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">netdev_set_msglevel</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_3c507</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;EtherLink16 I/O base address&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;(ignored)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;3c507: You should not use auto-probing with insmod!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_3c507</span> <span class="o">=</span> <span class="n">el16_probe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_3c507</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev_3c507</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_3c507</span><span class="p">;</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(((</span><span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EL16_IO_EXTENT</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
