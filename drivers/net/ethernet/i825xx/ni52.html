<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › ni52.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ni52.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net-3-driver for the NI5210 card (i82586 Ethernet chip)</span>
<span class="cm"> *</span>
<span class="cm"> * This is an extension to the Linux operating system, and is covered by the</span>
<span class="cm"> * same GNU General Public License that covers that work.</span>
<span class="cm"> *</span>
<span class="cm"> * Alphacode 0.82 (96/09/29) for Linux 2.0.0 (or later)</span>
<span class="cm"> * Copyrights (c) 1994,1995,1996 by M.Hipp (hippm@informatik.uni-tuebingen.de)</span>
<span class="cm"> *    [feel free to mail ....]</span>
<span class="cm"> *</span>
<span class="cm"> * when using as module: (no autoprobing!)</span>
<span class="cm"> *   run with e.g:</span>
<span class="cm"> *       insmod ni52.o io=0x360 irq=9 memstart=0xd0000 memend=0xd4000</span>
<span class="cm"> *</span>
<span class="cm"> * CAN YOU PLEASE REPORT ME YOUR PERFORMANCE EXPERIENCES !!.</span>
<span class="cm"> *</span>
<span class="cm"> * If you find a bug, please report me:</span>
<span class="cm"> *   The kernel panic output and any kmsg from the ni52 driver</span>
<span class="cm"> *   the ni5210-driver-version and the linux-kernel version</span>
<span class="cm"> *   how many shared memory (memsize) on the netcard,</span>
<span class="cm"> *   bootprom: yes/no, base_addr, mem_start</span>
<span class="cm"> *   maybe the ni5210-card revision and the i82586 version</span>
<span class="cm"> *</span>
<span class="cm"> * autoprobe for: base_addr: 0x300,0x280,0x360,0x320,0x340</span>
<span class="cm"> *                mem_start: 0xd0000,0xd2000,0xc8000,0xca000,0xd4000,0xd6000,</span>
<span class="cm"> *                           0xd8000,0xcc000,0xce000,0xda000,0xdc000</span>
<span class="cm"> *</span>
<span class="cm"> * sources:</span>
<span class="cm"> *   skeleton.c from Donald Becker</span>
<span class="cm"> *</span>
<span class="cm"> * I have also done a look in the following sources: (mail me if you need them)</span>
<span class="cm"> *   crynwr-packet-driver by Russ Nelson</span>
<span class="cm"> *   Garret A. Wollman&#39;s (fourth) i82586-driver for BSD</span>
<span class="cm"> *   (before getting an i82596 (yes 596 not 586) manual, the existing drivers</span>
<span class="cm"> *    helped me a lot to understand this tricky chip.)</span>
<span class="cm"> *</span>
<span class="cm"> * Known Problems:</span>
<span class="cm"> *   The internal sysbus seems to be slow. So we often lose packets because of</span>
<span class="cm"> *   overruns while receiving from a fast remote host.</span>
<span class="cm"> *   This can slow down TCP connections. Maybe the newer ni5210 cards are</span>
<span class="cm"> *   better. My experience is, that if a machine sends with more than about</span>
<span class="cm"> *   500-600K/s the fifo/sysbus overflows.</span>
<span class="cm"> *</span>
<span class="cm"> * IMPORTANT NOTE:</span>
<span class="cm"> *   On fast networks, it&#39;s a (very) good idea to have 16K shared memory. With</span>
<span class="cm"> *   8K, we can store only 4 receive frames, so it can (easily) happen that a</span>
<span class="cm"> *   remote machine &#39;overruns&#39; our system.</span>
<span class="cm"> *</span>
<span class="cm"> * Known i82586/card problems (I&#39;m sure, there are many more!):</span>
<span class="cm"> *   Running the NOP-mode, the i82586 sometimes seems to forget to report</span>
<span class="cm"> *   every xmit-interrupt until we restart the CU.</span>
<span class="cm"> *   Another MAJOR bug is, that the RU sometimes seems to ignore the EL-Bit</span>
<span class="cm"> *   in the RBD-Struct which indicates an end of the RBD queue.</span>
<span class="cm"> *   Instead, the RU fetches another (randomly selected and</span>
<span class="cm"> *   usually used) RBD and begins to fill it. (Maybe, this happens only if</span>
<span class="cm"> *   the last buffer from the previous RFD fits exact into the queue and</span>
<span class="cm"> *   the next RFD can&#39;t fetch an initial RBD. Anyone knows more? )</span>
<span class="cm"> *</span>
<span class="cm"> * results from ftp performance tests with Linux 1.2.5</span>
<span class="cm"> *   send and receive about 350-400 KByte/s (peak up to 460 kbytes/s)</span>
<span class="cm"> *   sending in NOP-mode: peak performance up to 530K/s (but better don&#39;t</span>
<span class="cm"> *   run this mode)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 29.Sept.96: virt_to_bus changes for new memory scheme</span>
<span class="cm"> * 19.Feb.96: more Mcast changes, module support (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 18.Nov.95: Mcast changes (AC).</span>
<span class="cm"> *</span>
<span class="cm"> * 23.April.95: fixed(?) receiving problems by configuring a RFD more</span>
<span class="cm"> *              than the number of RBD&#39;s. Can maybe cause other problems.</span>
<span class="cm"> * 18.April.95: Added MODULE support (MH)</span>
<span class="cm"> * 17.April.95: MC related changes in init586() and set_multicast_list().</span>
<span class="cm"> *              removed use of &#39;jiffies&#39; in init586() (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 19.Sep.94: Added Multicast support (not tested yet) (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 18.Sep.94: Workaround for &#39;EL-Bug&#39;. Removed flexible RBD-handling.</span>
<span class="cm"> *            Now, every RFD has exact one RBD. (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 14.Sep.94: added promiscuous mode, a few cleanups (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 19.Aug.94: changed request_irq() parameter (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 20.July.94: removed cleanup bugs, removed a 16K-mem-probe-bug (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 19.July.94: lotsa cleanups .. (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 17.July.94: some patches ... verified to run with 1.1.29 (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 4.July.94: patches for Linux 1.1.24  (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 26.March.94: patches for Linux 1.0 and iomem-auto-probe (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 30.Sep.93: Added nop-chain .. driver now runs with only one Xmit-Buff,</span>
<span class="cm"> *				too (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * &lt; 30.Sep.93: first versions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debuglevel</span><span class="p">;</span>	<span class="cm">/* debug-printk 0: off 1: a few 2: more */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">automatic_resume</span><span class="p">;</span> <span class="cm">/* experimental .. better should be zero */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rfdadd</span><span class="p">;</span>	<span class="cm">/* rfdadd=1 may be better for 8K MEM cards */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fifo</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>	<span class="cm">/* don&#39;t change */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>

<span class="cp">#include &quot;ni52.h&quot;</span>

<span class="cp">#define DRV_NAME &quot;ni52&quot;</span>

<span class="cp">#define DEBUG       </span><span class="cm">/* debug on */</span><span class="cp"></span>
<span class="cp">#define SYSBUSVAL 1 </span><span class="cm">/* 8 Bit */</span><span class="cp"></span>

<span class="cp">#define ni_attn586()  { outb(0, dev-&gt;base_addr + NI52_ATTENTION); }</span>
<span class="cp">#define ni_reset586() { outb(0, dev-&gt;base_addr + NI52_RESET); }</span>
<span class="cp">#define ni_disint()   { outb(0, dev-&gt;base_addr + NI52_INTDIS); }</span>
<span class="cp">#define ni_enaint()   { outb(0, dev-&gt;base_addr + NI52_INTENA); }</span>

<span class="cp">#define make32(ptr16) ((void __iomem *)(p-&gt;memtop + (short) (ptr16)))</span>
<span class="cp">#define make24(ptr32) ((char __iomem *)(ptr32)) - p-&gt;base</span>
<span class="cp">#define make16(ptr32) ((unsigned short) ((char __iomem *)(ptr32)\</span>
<span class="cp">					- p-&gt;memtop))</span>

<span class="cm">/******************* how to calculate the buffers *****************************</span>

<span class="cm">  * IMPORTANT NOTE: if you configure only one NUM_XMIT_BUFFS, the driver works</span>
<span class="cm">  * --------------- in a different (more stable?) mode. Only in this mode it&#39;s</span>
<span class="cm">  *                 possible to configure the driver with &#39;NO_NOPCOMMANDS&#39;</span>

<span class="cm">sizeof(scp)=12; sizeof(scb)=16; sizeof(iscp)=8;</span>
<span class="cm">sizeof(scp)+sizeof(iscp)+sizeof(scb) = 36 = INIT</span>
<span class="cm">sizeof(rfd) = 24; sizeof(rbd) = 12;</span>
<span class="cm">sizeof(tbd) = 8; sizeof(transmit_cmd) = 16;</span>
<span class="cm">sizeof(nop_cmd) = 8;</span>

<span class="cm">  * if you don&#39;t know the driver, better do not change these values: */</span>

<span class="cp">#define RECV_BUFF_SIZE 1524 </span><span class="cm">/* slightly oversized */</span><span class="cp"></span>
<span class="cp">#define XMIT_BUFF_SIZE 1524 </span><span class="cm">/* slightly oversized */</span><span class="cp"></span>
<span class="cp">#define NUM_XMIT_BUFFS 1    </span><span class="cm">/* config for both, 8K and 16K shmem */</span><span class="cp"></span>
<span class="cp">#define NUM_RECV_BUFFS_8  4 </span><span class="cm">/* config for 8K shared mem */</span><span class="cp"></span>
<span class="cp">#define NUM_RECV_BUFFS_16 9 </span><span class="cm">/* config for 16K shared mem */</span><span class="cp"></span>
<span class="cp">#define NO_NOPCOMMANDS      </span><span class="cm">/* only possible with NUM_XMIT_BUFFS=1 */</span><span class="cp"></span>

<span class="cm">/**************************************************************************/</span>


<span class="cp">#define NI52_TOTAL_SIZE 16</span>
<span class="cp">#define NI52_ADDR0 0x02</span>
<span class="cp">#define NI52_ADDR1 0x07</span>
<span class="cp">#define NI52_ADDR2 0x01</span>

<span class="k">static</span> <span class="kt">int</span>     <span class="n">ni52_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ni52_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">ni52_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">ni52_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ni52_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span>  <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">ni52_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">ni52_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* helper-functions */</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">init586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">check586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">alloc586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">startrecv586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>   <span class="n">__iomem</span> <span class="o">*</span><span class="n">alloc_rfa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">ni52_rcv_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">ni52_xmt_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">ni52_rnr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">priv</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapped</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">memtop</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">spinlock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rfd_last</span><span class="p">,</span> <span class="o">*</span><span class="n">rfd_top</span><span class="p">,</span> <span class="o">*</span><span class="n">rfd_first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scp_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscp_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iscp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tbd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
<span class="cp">#if (NUM_XMIT_BUFFS == 1)</span>
	<span class="k">struct</span> <span class="n">transmit_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nop_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">transmit_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nop_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">nop_point</span><span class="p">,</span> <span class="n">num_recv_buffs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">xmit_count</span><span class="p">,</span> <span class="n">xmit_last</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* wait for command with timeout: */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_scb_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16384</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		      <span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">16383</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: scb_cmd timed out: %04x,%04x .. disabling i82586!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">),</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ni_reset586</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_scb_cmd_ruc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16384</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">16383</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: scb_cmd (ruc) timed out: %04x,%04x .. disabling i82586!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span><span class="p">),</span>
				<span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rus</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ni_reset586</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_stat_compl</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nop_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32767</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">STAT_COMPL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * close device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni52_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">ni_reset586</span><span class="p">();</span> <span class="cm">/* the hard way to stop the receiver */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * open device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni52_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ni_disint</span><span class="p">();</span>
	<span class="n">alloc586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">startrecv586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ni_enaint</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ni52_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ni_reset586</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* most done by init */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_iscp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscp_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iscp</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">iscp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">make24</span><span class="p">(</span><span class="n">iscp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>

	<span class="n">ni_reset586</span><span class="p">();</span>
	<span class="n">ni_attn586</span><span class="p">();</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>	<span class="cm">/* wait a while... */</span>
	<span class="cm">/* i82586 clears &#39;busy&#39; after successful init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * Check to see if there&#39;s an 82586 out there.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mh">0x01000000</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">memtop</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SCP_DEFAULT_ADDRESS</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scb_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/* memory was writeable? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">Enodev</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SYSBUSVAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sysbus</span><span class="p">);</span>	<span class="cm">/* 1 = 8Bit-Bus, 0 = 16 Bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sysbus</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SYSBUSVAL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enodev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_iscp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Enodev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_iscp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Enodev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">Enodev:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************</span>
<span class="cm"> * set iscp at the right place, called by ni52_probe1 and open586.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">alloc586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ni_reset586</span><span class="p">();</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="n">memset_io</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span><span class="p">));</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">make24</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SYSBUSVAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sysbus</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">scb_offset</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
	<span class="n">ni_reset586</span><span class="p">();</span>
	<span class="n">ni_attn586</span><span class="p">();</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Init-Problems (alloc).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset_io</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb_struct</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* set: io,irq,memstart,memend or set it when calling insmod */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">memstart</span><span class="p">;</span>	<span class="cm">/* e.g 0xd0000 */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">memend</span><span class="p">;</span>	<span class="cm">/* e.g 0xd4000 */</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * probe the ni5210-card</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">ni52_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span><span class="p">));</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">io</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">memstart</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
		<span class="n">memend</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span>	<span class="p">{</span>	<span class="cm">/* Check a single specified location. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ni52_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Don&#39;t probe at all. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">ports</span><span class="p">;</span> <span class="o">*</span><span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="n">ni52_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span> <span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_it</span><span class="p">;</span>
<span class="cp">#ifdef FULL_IO_PROBE</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">io</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span> <span class="n">io</span> <span class="o">&lt;</span> <span class="mh">0x400</span> <span class="o">&amp;&amp;</span> <span class="n">ni52_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span> <span class="n">io</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_it</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">got_it:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">NI52_TOTAL_SIZE</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ni52_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ni52_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ni52_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">ni52_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> 	<span class="o">=</span> <span class="n">ni52_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> 	<span class="o">=</span> <span class="n">ni52_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ni52_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">memstart</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">memend</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NI52_TOTAL_SIZE</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">NI52_MAGIC1</span><span class="p">)</span> <span class="o">==</span> <span class="n">NI52_MAGICVAL1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">NI52_MAGIC2</span><span class="p">)</span> <span class="o">==</span> <span class="n">NI52_MAGICVAL2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NI52_ADDR0</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NI52_ADDR1</span> <span class="o">||</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NI52_ADDR2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: NI5210 found at %#3lx, &quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * check (or search) IO-Memory, 8K and 16K</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mh">0x2000</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid memory size %d. Allowed is 0x2000 or 0x4000 bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check586</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;?memcheck, Can&#39;t find memory at 0x%lx with size %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no auto-mem-probe */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span> <span class="cm">/* check for 16K mem */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check586</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span> <span class="cm">/* check for 8K mem */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check586</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;?memprobe, Can&#39;t find memory at 0x%lx!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">memaddrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0xc8000</span><span class="p">,</span> <span class="mh">0xca000</span><span class="p">,</span> <span class="mh">0xcc000</span><span class="p">,</span> <span class="mh">0xce000</span><span class="p">,</span> <span class="mh">0xd0000</span><span class="p">,</span> <span class="mh">0xd2000</span><span class="p">,</span>
			<span class="mh">0xd4000</span><span class="p">,</span> <span class="mh">0xd6000</span><span class="p">,</span> <span class="mh">0xd8000</span><span class="p">,</span> <span class="mh">0xda000</span><span class="p">,</span> <span class="mh">0xdc000</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">};</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memaddrs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;?memprobe, Can&#39;t find io-memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">memaddrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span> <span class="cm">/* check for 8K mem */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check586</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
				<span class="cm">/* 8K-check */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span> <span class="cm">/* check for 16K mem */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check586</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
				<span class="cm">/* 16K-check */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* set mem_end showed by &#39;ifconfig&#39; */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">alloc586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* set number of receive-buffs according to memsize */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mh">0x2000</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">=</span> <span class="n">NUM_RECV_BUFFS_8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">=</span> <span class="n">NUM_RECV_BUFFS_16</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Memaddr: 0x%lx, Memsize: %d, &quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask</span><span class="p">;</span>

		<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>
		<span class="n">ni_reset586</span><span class="p">();</span>
		<span class="n">ni_attn586</span><span class="p">();</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;?autoirq, Failed to detect IRQ line!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ %d (autodetected).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ %d (assigned and not checked!).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ni52_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">NI52_TOTAL_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * init the chip (ni52-interrupt should be disabled?!)</span>
<span class="cm"> * needs a correct &#39;allocated&#39; memory</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">configure_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfg_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iasetup_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ias_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdr_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tdr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mcsetup_cmd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mc_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_addrs</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cfg_cmd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span> <span class="cm">/* configure-command */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CMD_CONFIGURE</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>

	<span class="cm">/* number of cfg bytes */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">byte_cnt</span><span class="p">);</span>
	<span class="cm">/* fifo-limit (8=tx:32/rx:64) */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>
	<span class="cm">/* hold or discard bad recv frames (bit 7) */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">sav_bf</span><span class="p">);</span>
	<span class="cm">/* addr_len |!src_insert |pre-len |loopback */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x2e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">adr_len</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">time_low</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xf2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">time_high</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_addrs</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: switching to promisc. mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">carr_coll</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">cfg_cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span> <span class="cm">/* cmd.-unit start */</span>
	<span class="n">ni_attn586</span><span class="p">();</span>

	<span class="n">wait_for_stat_compl</span><span class="p">(</span><span class="n">cfg_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_OK</span><span class="o">|</span><span class="n">STAT_COMPL</span><span class="p">))</span> <span class="o">!=</span>
							<span class="p">(</span><span class="n">STAT_COMPL</span><span class="o">|</span><span class="n">STAT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: configure command failed: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * individual address setup</span>
<span class="cm">	 */</span>

	<span class="n">ias_cmd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CMD_IASETUP</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">iaddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">ias_cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span> <span class="cm">/* cmd.-unit start */</span>
	<span class="n">ni_attn586</span><span class="p">();</span>

	<span class="n">wait_for_stat_compl</span><span class="p">(</span><span class="n">ias_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_OK</span><span class="o">|</span><span class="n">STAT_COMPL</span><span class="p">))</span> <span class="o">!=</span>
							<span class="p">(</span><span class="n">STAT_OK</span><span class="o">|</span><span class="n">STAT_COMPL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s (ni52): individual address setup command failed: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TDR, wire check .. e.g. no resistor e.t.c</span>
<span class="cm">	 */</span>

	<span class="n">tdr_cmd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CMD_TDR</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">tdr_cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span> <span class="cm">/* cmd.-unit start */</span>
	<span class="n">ni_attn586</span><span class="p">();</span>

	<span class="n">wait_for_stat_compl</span><span class="p">(</span><span class="n">tdr_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_COMPL</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Problems while running the TDR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
		<span class="n">ni_attn586</span><span class="p">();</span> <span class="cm">/* ack the interrupts */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_LNK_OK</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_XCVR_PRB</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: TDR: Transceiver problem. Check the cable(s)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_ET_OPN</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: TDR: No correct termination %d clocks away.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_TIMEMASK</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_ET_SRT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* time == 0 -&gt; strange :-) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_TIMEMASK</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: TDR: Detected a short circuit %d clocks away.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_TIMEMASK</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: TDR: Unknown status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Multicast setup</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_addrs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mc_cmd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">CMD_MCSETUP</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">num_addrs</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">mc_cnt</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">mc_cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
		<span class="n">ni_attn586</span><span class="p">();</span>

		<span class="n">wait_for_stat_compl</span><span class="p">(</span><span class="n">mc_cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_COMPL</span><span class="o">|</span><span class="n">STAT_OK</span><span class="p">))</span>
						 <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_COMPL</span><span class="o">|</span><span class="n">STAT_OK</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t apply multicast-address-list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * alloc nop/xmit-cmds</span>
<span class="cm">	 */</span>
<span class="cp">#if (NUM_XMIT_BUFFS == 1)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">CMD_NOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nop_cmd_struct</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_XMIT_BUFFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">CMD_NOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nop_cmd_struct</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">alloc_rfa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span> <span class="cm">/* init receive-frame-area */</span>

	<span class="cm">/*</span>
<span class="cm">	 * alloc xmit-buffs / init xmit_cmds</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_XMIT_BUFFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Transmit cmd/buff 0 */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">transmit_cmd_struct</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span> <span class="cm">/* char-buffs */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">XMIT_BUFF_SIZE</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span> <span class="cm">/* TBD */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tbd_struct</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: not enough shared-mem for your configuration!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset_io</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">transmit_cmd_struct</span><span class="p">));</span>
		<span class="n">memset_io</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tbd_struct</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">]),</span>
					<span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">STAT_COMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">CMD_XMIT</span><span class="o">|</span><span class="n">CMD_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tbd_offset</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">make24</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	 <span class="cm">/*</span>
<span class="cm">		* &#39;start transmitter&#39;</span>
<span class="cm">		*/</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
	<span class="n">ni_attn586</span><span class="p">();</span>
	<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CMD_XMIT</span> <span class="o">|</span> <span class="n">CMD_SUSPEND</span> <span class="o">|</span> <span class="n">CMD_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * ack. interrupts</span>
<span class="cm">	 */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
	<span class="n">ni_attn586</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

	<span class="n">ni_enaint</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************</span>
<span class="cm"> * This is a helper routine for ni52_rnr_int() and init586().</span>
<span class="cm"> * It sets up the Receive Frame Area (RFA).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">alloc_rfa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rfd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rfd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset_io</span><span class="p">(</span><span class="n">rfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd_struct</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">+</span> <span class="n">rfdadd</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span> <span class="o">=</span> <span class="n">rfd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">+</span> <span class="n">rfdadd</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">rfd</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="o">+</span><span class="n">rfdadd</span><span class="p">)),</span>
			<span class="o">&amp;</span><span class="n">rfd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rbd_offset</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* RU suspend */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">RFD_SUSP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfd</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">rfdadd</span><span class="p">].</span><span class="n">last</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rfd</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">+</span> <span class="n">rfdadd</span><span class="p">);</span>

	<span class="n">rbd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rbd</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">;</span>

	 <span class="cm">/* clr descriptors */</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">rbd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_struct</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">rbd</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rbd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">RECV_BUFF_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">make24</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rbd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">RECV_BUFF_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_last</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rfdadd</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rfa_offset</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">rbd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="o">-&gt;</span><span class="n">rbd_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************</span>
<span class="cm"> * Interrupt Handler ...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ni52_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* wait for last command	*/</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">stat</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
		<span class="n">ni_attn586</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_FR</span><span class="p">)</span>	 <span class="cm">/* received a frame */</span>
			<span class="n">ni52_rcv_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_RNR</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* RU went &#39;not ready&#39; */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(R)&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RU_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* special case: RU_SUSPEND */</span>
				<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">writeb</span><span class="p">(</span><span class="n">RUC_RESUME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span><span class="p">);</span>
				<span class="n">ni_attn586</span><span class="p">();</span>
				<span class="n">wait_for_scb_cmd_ruc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Receiver-Unit went &#39;NOT READY&#39;: %04x/%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rus</span><span class="p">));</span>
				<span class="n">ni52_rnr_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Command with I-bit set complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_CX</span><span class="p">)</span>
			 <span class="n">ni52_xmt_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifndef NO_NOPCOMMANDS</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_CNA</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* CU went &#39;not ready&#39; */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: oops! CU has left active state. stat: %04x/%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="o">++</span><span class="p">);</span>

		<span class="cm">/* Wait for ack. (ni52_xmt_int can be faster than ack!!) */</span>
		<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">))</span> <span class="p">{</span>	 <span class="cm">/* timed out? */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Acknowledge timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ni_disint</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************</span>
<span class="cm"> * receive-interrupt</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni52_rcv_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">stat_high</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RFD_COMPL</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">rbd</span> <span class="o">=</span> <span class="n">make32</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">rbd_offset</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RFD_OK</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* frame received without error? */</span>
			<span class="n">totlen</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">&amp;</span> <span class="n">RBD_LAST</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* the first and the last buffer? */</span>
				<span class="n">totlen</span> <span class="o">&amp;=</span> <span class="n">RBD_MASK</span><span class="p">;</span> <span class="cm">/* length of this frame */</span>
				<span class="n">writew</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">totlen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">totlen</span><span class="p">);</span>
					<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">),</span> <span class="n">totlen</span><span class="p">);</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
					<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">totlen</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">rstat</span><span class="p">;</span>
				 <span class="cm">/* free all RBD&#39;s until RBD_LAST is set */</span>
				<span class="n">totlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rstat</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RBD_LAST</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">totlen</span> <span class="o">+=</span> <span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">RBD_MASK</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rstat</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Whoops .. no end mark in RBD list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
					<span class="n">rbd</span> <span class="o">=</span> <span class="n">make32</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">totlen</span> <span class="o">+=</span> <span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">RBD_MASK</span><span class="p">;</span>
				<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: received oversized frame! length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">totlen</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			 <span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* frame !(ok), only with &#39;save-bad-frames&#39; */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: oops! rfd-error-status: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">stat_high</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">RFD_SUSP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span> <span class="cm">/* maybe exchange by RFD_LAST */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">rbd_offset</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_last</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span>	<span class="cm">/* delete RFD_SUSP	*/</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_last</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span> <span class="o">=</span> <span class="n">make32</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span> <span class="cm">/* step to next RFD */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rfa_offset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">automatic_resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">RUC_RESUME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span><span class="p">);</span>
		<span class="n">ni_attn586</span><span class="p">();</span>
		<span class="n">wait_for_scb_cmd_ruc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef WAIT_4_BUSY</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1023</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: RU hasn&#39;t fetched next RFD (not busy/complete)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> * handle &#39;Receiver went not ready&#39;.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni52_rnr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>		<span class="cm">/* wait for the last cmd, WAIT_4_FULLSTAT?? */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">RUC_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span><span class="p">);</span> <span class="cm">/* usually the RU is in the &#39;no resource&#39;-state .. abort it now. */</span>
	<span class="n">ni_attn586</span><span class="p">();</span>
	<span class="n">wait_for_scb_cmd_ruc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>		<span class="cm">/* wait for accept cmd. */</span>

	<span class="n">alloc_rfa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">);</span>
	<span class="cm">/* maybe add a check here, before restarting the RU */</span>
	<span class="n">startrecv586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* restart RU */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Receive-Unit restarted. Status: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rus</span><span class="p">));</span>

<span class="p">}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> * handle xmit - interrupt</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni52_xmt_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_COMPL</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: strange .. xmit-int without a &#39;COMPLETE&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_MAXCOLLMASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_LATECOLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: late collision detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_NOCARRIER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no carrier detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_LOSTCTS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: loss of CTS detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: DMA underrun detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_MAXCOLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Max. collisions exceeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if (NUM_XMIT_BUFFS &gt; 1)</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">++</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span><span class="p">)</span> <span class="o">==</span> <span class="n">NUM_XMIT_BUFFS</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***********************************************************</span>
<span class="cm"> * (re)start the receiver</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">startrecv586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wait_for_scb_cmd_ruc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rfa_offset</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">RUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span><span class="p">);</span>
	<span class="n">ni_attn586</span><span class="p">();</span>		<span class="cm">/* start cmd. */</span>
	<span class="n">wait_for_scb_cmd_ruc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* wait for accept cmd. (no timeout!!) */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni52_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CU_ACTIVE</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* COMMAND-UNIT active? */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: strange ... timeout with CU active?!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: X0: %04x N0: %04x N1: %04x %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">,</span>
			<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">),</span>
			<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">),</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
		<span class="n">ni_attn586</span><span class="p">();</span>
		<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
		<span class="n">ni_attn586</span><span class="p">();</span>
		<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: xmitter timed out, try to restart! stat: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: command-stats: %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">),</span>
				<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: check, whether you set the right interrupt number!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">ni52_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ni52_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
<span class="p">}</span>

<span class="cm">/******************************************************</span>
<span class="cm"> * send frame</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ni52_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="kt">int</span> <span class="n">next_nop</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">XMIT_BUFF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Sorry, max. framelength is %d bytes. The length of your frame is %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">XMIT_BUFF_SIZE</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
		<span class="n">memset_io</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]</span><span class="o">+</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if (NUM_XMIT_BUFFS == 1)</span>
<span class="cp">#	ifdef NO_NOPCOMMANDS</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CU_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Hmmm .. CU is still running and we wanna send a new packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: stat: %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">),</span>
				<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">TBD_LAST</span> <span class="o">|</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
		<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CU_STATUS</span><span class="p">)</span> <span class="o">==</span> <span class="n">CU_SUSPEND</span><span class="p">)</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_RESUME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">CUC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ni_attn586</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">wait_for_scb_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* test it, because CU sometimes doesn&#39;t start immediately */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CU_ACTIVE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t start transmit-command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#	else</span>
	<span class="n">next_nop</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">TBD_LAST</span> <span class="o">|</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]),</span>
				<span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span> <span class="o">=</span> <span class="n">next_nop</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#	endif</span>
<span class="cp">#else</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">TBD_LAST</span> <span class="o">|</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">next_nop</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_nop</span> <span class="o">==</span> <span class="n">NUM_XMIT_BUFFS</span><span class="p">)</span>
		<span class="n">next_nop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="cm">/* linkpointer of xmit-command already points to next nop cmd */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]),</span>
				<span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]),</span>
				<span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">=</span> <span class="n">next_nop</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************</span>
<span class="cm"> * Someone wanna have the statistics</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">ni52_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span><span class="p">,</span> <span class="n">aln</span><span class="p">,</span> <span class="n">rsc</span><span class="p">,</span> <span class="n">ovrn</span><span class="p">;</span>

	<span class="cm">/* Get error-statistics from the ni82586 */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">crc_errs</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">crc_errs</span><span class="p">);</span>
	<span class="n">aln</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">aln_errs</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">aln_errs</span><span class="p">);</span>
	<span class="n">rsc</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rsc_errs</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rsc_errs</span><span class="p">);</span>
	<span class="n">ovrn</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">ovrn_errs</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">ovrn_errs</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">+=</span> <span class="n">ovrn</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="n">aln</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">rsc</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************</span>
<span class="cm"> * Set MC list ..</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ni_disint</span><span class="p">();</span>
	<span class="n">alloc586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">startrecv586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ni_enaint</span><span class="p">();</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_ni52</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">memstart</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">memend</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;NI5210 I/O base address,required&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;NI5210 IRQ number,required&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">memstart</span><span class="p">,</span> <span class="s">&quot;NI5210 memory base address,required&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">memend</span><span class="p">,</span> <span class="s">&quot;NI5210 memory end address,required&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&lt;=</span> <span class="mh">0x0</span> <span class="o">||</span> <span class="o">!</span><span class="n">memend</span> <span class="o">||</span> <span class="o">!</span><span class="n">memstart</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ni52: Autoprobing not allowed for modules.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ni52: Set symbols &#39;io&#39; &#39;irq&#39; &#39;memstart&#39; and &#39;memend&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_ni52</span> <span class="o">=</span> <span class="n">ni52_probe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_ni52</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev_ni52</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev_ni52</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev_ni52</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev_ni52</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">NI52_TOTAL_SIZE</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev_ni52</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
