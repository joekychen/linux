<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › sun3_82586.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sun3_82586.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Sun3 i82586 Ethernet driver</span>
<span class="cm"> *</span>
<span class="cm"> * Cloned from ni52.c for the Sun3 by Sam Creasey (sammy@sammy.net)</span>
<span class="cm"> *</span>
<span class="cm"> * Original copyright follows:</span>
<span class="cm"> * --------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * net-3-driver for the NI5210 card (i82586 Ethernet chip)</span>
<span class="cm"> *</span>
<span class="cm"> * This is an extension to the Linux operating system, and is covered by the</span>
<span class="cm"> * same Gnu Public License that covers that work.</span>
<span class="cm"> *</span>
<span class="cm"> * Alphacode 0.82 (96/09/29) for Linux 2.0.0 (or later)</span>
<span class="cm"> * Copyrights (c) 1994,1995,1996 by M.Hipp (hippm@informatik.uni-tuebingen.de)</span>
<span class="cm"> * --------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Consult ni52.c for further notes from the original driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This incarnation currently supports the OBIO version of the i82586 chip</span>
<span class="cm"> * used in certain sun3 models.  It should be fairly doable to expand this</span>
<span class="cm"> * to support VME if I should every acquire such a board.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debuglevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* debug-printk 0: off 1: a few 2: more */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">automatic_resume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* experimental .. better should be zero */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rfdadd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* rfdadd=1 may be better for 8K MEM cards */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fifo</span><span class="o">=</span><span class="mh">0x8</span><span class="p">;</span>	<span class="cm">/* don&#39;t change */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/machines.h&gt;</span>
<span class="cp">#include &lt;asm/sun3mmu.h&gt;</span>
<span class="cp">#include &lt;asm/dvma.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>

<span class="cp">#include &quot;sun3_82586.h&quot;</span>

<span class="cp">#define DRV_NAME &quot;sun3_82586&quot;</span>

<span class="cp">#define DEBUG       </span><span class="cm">/* debug on */</span><span class="cp"></span>
<span class="cp">#define SYSBUSVAL 0 </span><span class="cm">/* 16 Bit */</span><span class="cp"></span>
<span class="cp">#define SUN3_82586_TOTAL_SIZE	PAGE_SIZE</span>

<span class="cp">#define sun3_attn586()  {*(volatile unsigned char *)(dev-&gt;base_addr) |= IEOB_ATTEN; *(volatile unsigned char *)(dev-&gt;base_addr) &amp;= ~IEOB_ATTEN;}</span>
<span class="cp">#define sun3_reset586() {*(volatile unsigned char *)(dev-&gt;base_addr) = 0; udelay(100); *(volatile unsigned char *)(dev-&gt;base_addr) = IEOB_NORSET;}</span>
<span class="cp">#define sun3_disint()   {*(volatile unsigned char *)(dev-&gt;base_addr) &amp;= ~IEOB_IENAB;}</span>
<span class="cp">#define sun3_enaint()   {*(volatile unsigned char *)(dev-&gt;base_addr) |= IEOB_IENAB;}</span>
<span class="cp">#define sun3_active()   {*(volatile unsigned char *)(dev-&gt;base_addr) |= (IEOB_IENAB|IEOB_ONAIR|IEOB_NORSET);}</span>

<span class="cp">#define make32(ptr16) (p-&gt;memtop + (swab16((unsigned short) (ptr16))) )</span>
<span class="cp">#define make24(ptr32) (char *)swab32(( ((unsigned long) (ptr32)) - p-&gt;base))</span>
<span class="cp">#define make16(ptr32) (swab16((unsigned short) ((unsigned long)(ptr32) - (unsigned long) p-&gt;memtop )))</span>

<span class="cm">/******************* how to calculate the buffers *****************************</span>

<span class="cm">  * IMPORTANT NOTE: if you configure only one NUM_XMIT_BUFFS, the driver works</span>
<span class="cm">  * --------------- in a different (more stable?) mode. Only in this mode it&#39;s</span>
<span class="cm">  *                 possible to configure the driver with &#39;NO_NOPCOMMANDS&#39;</span>

<span class="cm">sizeof(scp)=12; sizeof(scb)=16; sizeof(iscp)=8;</span>
<span class="cm">sizeof(scp)+sizeof(iscp)+sizeof(scb) = 36 = INIT</span>
<span class="cm">sizeof(rfd) = 24; sizeof(rbd) = 12;</span>
<span class="cm">sizeof(tbd) = 8; sizeof(transmit_cmd) = 16;</span>
<span class="cm">sizeof(nop_cmd) = 8;</span>

<span class="cm">  * if you don&#39;t know the driver, better do not change these values: */</span>

<span class="cp">#define RECV_BUFF_SIZE 1536 </span><span class="cm">/* slightly oversized */</span><span class="cp"></span>
<span class="cp">#define XMIT_BUFF_SIZE 1536 </span><span class="cm">/* slightly oversized */</span><span class="cp"></span>
<span class="cp">#define NUM_XMIT_BUFFS 1    </span><span class="cm">/* config for 32K shmem */</span><span class="cp"></span>
<span class="cp">#define NUM_RECV_BUFFS_8 4 </span><span class="cm">/* config for 32K shared mem */</span><span class="cp"></span>
<span class="cp">#define NUM_RECV_BUFFS_16 9 </span><span class="cm">/* config for 32K shared mem */</span><span class="cp"></span>
<span class="cp">#define NUM_RECV_BUFFS_32 16 </span><span class="cm">/* config for 32K shared mem */</span><span class="cp"></span>
<span class="cp">#define NO_NOPCOMMANDS      </span><span class="cm">/* only possible with NUM_XMIT_BUFFS=1 */</span><span class="cp"></span>

<span class="cm">/**************************************************************************/</span>

<span class="cm">/* different DELAYs */</span>
<span class="cp">#define DELAY(x) mdelay(32 * x);</span>
<span class="cp">#define DELAY_16(); { udelay(16); }</span>
<span class="cp">#define DELAY_18(); { udelay(4); }</span>

<span class="cm">/* wait for command with timeout: */</span>
<span class="cp">#define WAIT_4_SCB_CMD() \</span>
<span class="cp">{ int i; \</span>
<span class="cp">  for(i=0;i&lt;16384;i++) { \</span>
<span class="cp">    if(!p-&gt;scb-&gt;cmd_cuc) break; \</span>
<span class="cp">    DELAY_18(); \</span>
<span class="cp">    if(i == 16383) { \</span>
<span class="cp">      printk(&quot;%s: scb_cmd timed out: %04x,%04x .. disabling i82586!!\n&quot;,dev-&gt;name,p-&gt;scb-&gt;cmd_cuc,p-&gt;scb-&gt;cus); \</span>
<span class="cp">       if(!p-&gt;reseted) { p-&gt;reseted = 1; sun3_reset586(); } } } }</span>

<span class="cp">#define WAIT_4_SCB_CMD_RUC() { int i; \</span>
<span class="cp">  for(i=0;i&lt;16384;i++) { \</span>
<span class="cp">    if(!p-&gt;scb-&gt;cmd_ruc) break; \</span>
<span class="cp">    DELAY_18(); \</span>
<span class="cp">    if(i == 16383) { \</span>
<span class="cp">      printk(&quot;%s: scb_cmd (ruc) timed out: %04x,%04x .. disabling i82586!!\n&quot;,dev-&gt;name,p-&gt;scb-&gt;cmd_ruc,p-&gt;scb-&gt;rus); \</span>
<span class="cp">       if(!p-&gt;reseted) { p-&gt;reseted = 1; sun3_reset586(); } } } }</span>

<span class="cp">#define WAIT_4_STAT_COMPL(addr) { int i; \</span>
<span class="cp">   for(i=0;i&lt;32767;i++) { \</span>
<span class="cp">     if(swab16((addr)-&gt;cmd_status) &amp; STAT_COMPL) break; \</span>
<span class="cp">     DELAY_16(); DELAY_16(); } }</span>

<span class="k">static</span> <span class="kt">int</span>     <span class="n">sun3_82586_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sun3_82586_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">sun3_82586_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">sun3_82586_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">sun3_82586_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span>  <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">sun3_82586_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">sun3_82586_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void    sun3_82586_dump(struct net_device *,void *);</span>
<span class="cp">#endif</span>

<span class="cm">/* helper-functions */</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">init586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">check586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">where</span><span class="p">,</span><span class="kt">unsigned</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">alloc586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">startrecv586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>   <span class="o">*</span><span class="n">alloc_rfa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">sun3_82586_rcv_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">sun3_82586_xmt_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">sun3_82586_rnr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">priv</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">memtop</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reseted</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">rfd_struct</span>	<span class="o">*</span><span class="n">rfd_last</span><span class="p">,</span><span class="o">*</span><span class="n">rfd_top</span><span class="p">,</span><span class="o">*</span><span class="n">rfd_first</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">scp_struct</span>	<span class="o">*</span><span class="n">scp</span><span class="p">;</span>	<span class="cm">/* volatile is important */</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">iscp_struct</span>	<span class="o">*</span><span class="n">iscp</span><span class="p">;</span>	<span class="cm">/* volatile is important */</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">scb_struct</span>	<span class="o">*</span><span class="n">scb</span><span class="p">;</span>	<span class="cm">/* volatile is important */</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">tbd_struct</span>	<span class="o">*</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">transmit_cmd_struct</span> <span class="o">*</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
<span class="cp">#if (NUM_XMIT_BUFFS == 1)</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">nop_cmd_struct</span> <span class="o">*</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">nop_cmd_struct</span> <span class="o">*</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="k">volatile</span> <span class="kt">int</span>		<span class="n">nop_point</span><span class="p">,</span><span class="n">num_recv_buffs</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">];</span>
	<span class="k">volatile</span> <span class="kt">int</span>		<span class="n">xmit_count</span><span class="p">,</span><span class="n">xmit_last</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * close device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sun3_82586_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">sun3_reset586</span><span class="p">();</span> <span class="cm">/* the hard way to stop the receiver */</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * open device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sun3_82586_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sun3_disint</span><span class="p">();</span>
	<span class="n">alloc586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">startrecv586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sun3_enaint</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sun3_82586_interrupt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sun3_reset586</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* most done by init */</span>
<span class="p">}</span>

<span class="cm">/**********************************************</span>
<span class="cm"> * Check to see if there&#39;s an 82586 out there.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">where</span><span class="p">,</span><span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="n">pb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pb</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">iscp_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dvma_btov</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">memtop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dvma_btov</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">where</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SCP_DEFAULT_ADDRESS</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span><span class="p">));</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* memory was writeable? */</span>
		<span class="k">if</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sysbus</span> <span class="o">=</span> <span class="n">SYSBUSVAL</span><span class="p">;</span>				<span class="cm">/* 1 = 8Bit-Bus, 0 = 16 Bit */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sysbus</span> <span class="o">!=</span> <span class="n">SYSBUSVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iscp_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dvma_btov</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">where</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">iscp_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span><span class="p">));</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">iscp</span> <span class="o">=</span> <span class="n">make24</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sun3_reset586</span><span class="p">();</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>
	<span class="n">DELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* wait a while... */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="cm">/* i82586 clears &#39;busy&#39; after successful init */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************</span>
<span class="cm"> * set iscp at the right place, called by sun3_82586_probe1 and open586.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">alloc586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sun3_reset586</span><span class="p">();</span>
	<span class="n">DELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span> <span class="o">*</span><span class="p">)</span>	<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SCP_DEFAULT_ADDRESS</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">dvma_btov</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span>  <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scb_struct</span> <span class="o">*</span><span class="p">)</span>  <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscp_struct</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scp_struct</span><span class="p">));</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">iscp</span> <span class="o">=</span> <span class="n">make24</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sysbus</span> <span class="o">=</span> <span class="n">SYSBUSVAL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">scb_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">scb_base</span> <span class="o">=</span> <span class="n">make24</span><span class="p">(</span><span class="n">dvma_btov</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">));</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sun3_reset586</span><span class="p">();</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>

	<span class="n">DELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Init-Problems (alloc).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">reseted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb_struct</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">sun3_82586_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* check that this machine has an onboard 82586 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_machtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SM_SUN3</span><span class="o">|</span><span class="n">SM_3_160</span>:
	<span class="k">case</span> <span class="n">SM_SUN3</span><span class="o">|</span><span class="n">SM_3_260</span>:
		<span class="cm">/* these machines have 82586 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">IE_OBIO</span><span class="p">,</span> <span class="n">SUN3_82586_TOTAL_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IE_IRQ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sun3_82586_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">out2:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SUN3_82586_TOTAL_SIZE</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sun3_82586_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sun3_82586_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sun3_82586_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sun3_82586_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">sun3_82586_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">sun3_82586_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sun3_82586_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SUN3_82586_TOTAL_SIZE</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* copy in the ethernet address from the prom */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SUN3 Intel 82586 found at %lx, &quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * check (or search) IO-Memory, 32K</span>
<span class="cm">	 */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dvma_malloc_align</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mh">0x2000</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="mh">0x4000</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: Illegal memory size %d. Allowed is 0x2000 or 0x4000 or 0x8000 bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">check586</span><span class="p">(</span><span class="n">dev</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;?memcheck, Can&#39;t find memory at 0x%lx with size %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">((</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">memtop</span> <span class="o">=</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dvma_btov</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dvma_btov</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">alloc586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* set number of receive-buffs according to memsize */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mh">0x2000</span><span class="p">)</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">=</span>
							<span class="n">NUM_RECV_BUFFS_8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">=</span>
							<span class="n">NUM_RECV_BUFFS_16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">=</span>
							<span class="n">NUM_RECV_BUFFS_32</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Memaddr: 0x%lx, Memsize: %d, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span><span class="n">size</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sun3_82586_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> 		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SUN3_82586_TOTAL_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">init586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">configure_cmd_struct</span>	<span class="o">*</span><span class="n">cfg_cmd</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">iasetup_cmd_struct</span> <span class="o">*</span><span class="n">ias_cmd</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">tdr_cmd_struct</span> <span class="o">*</span><span class="n">tdr_cmd</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">mcsetup_cmd_struct</span> <span class="o">*</span><span class="n">mc_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_addrs</span><span class="o">=</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb_struct</span><span class="p">));</span>

	<span class="n">cfg_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">configure_cmd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span> <span class="cm">/* configure-command */</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span>	<span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_CONFIGURE</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">);</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span>	<span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">byte_cnt</span>	<span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span> <span class="cm">/* number of cfg bytes */</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">fifo</span>		<span class="o">=</span> <span class="n">fifo</span><span class="p">;</span> <span class="cm">/* fifo-limit (8=tx:32/rx:64) */</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">sav_bf</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* hold or discard bad recv frames (bit 7) */</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">adr_len</span>	<span class="o">=</span> <span class="mh">0x2e</span><span class="p">;</span> <span class="cm">/* addr_len |!src_insert |pre-len |loopback */</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">priority</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">ifs</span>		<span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">time_low</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">time_high</span>	<span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">promisc</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iscp</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">num_addrs</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: switching to promisc. mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">carr_coll</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span>	<span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">cfg_cmd</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span>		<span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span> <span class="cm">/* cmd.-unit start */</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>

	<span class="n">WAIT_4_STAT_COMPL</span><span class="p">(</span><span class="n">cfg_cmd</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">swab16</span><span class="p">(</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_OK</span><span class="o">|</span><span class="n">STAT_COMPL</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_COMPL</span><span class="o">|</span><span class="n">STAT_OK</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: configure command failed: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">swab16</span><span class="p">(</span><span class="n">cfg_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * individual address setup</span>
<span class="cm">	 */</span>

	<span class="n">ias_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iasetup_cmd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span>	<span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_IASETUP</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">);</span>
	<span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span>	<span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">iaddr</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">ias_cmd</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span> <span class="cm">/* cmd.-unit start */</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>

	<span class="n">WAIT_4_STAT_COMPL</span><span class="p">(</span><span class="n">ias_cmd</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">swab16</span><span class="p">(</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_OK</span><span class="o">|</span><span class="n">STAT_COMPL</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_OK</span><span class="o">|</span><span class="n">STAT_COMPL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s (82586): individual address setup command failed: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">swab16</span><span class="p">(</span><span class="n">ias_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TDR, wire check .. e.g. no resistor e.t.c</span>
<span class="cm">	 */</span>

	<span class="n">tdr_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tdr_cmd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span>	<span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_TDR</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">);</span>
	<span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span>	<span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">status</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">tdr_cmd</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span> <span class="cm">/* cmd.-unit start */</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>

	<span class="n">WAIT_4_STAT_COMPL</span><span class="p">(</span><span class="n">tdr_cmd</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">swab16</span><span class="p">(</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_COMPL</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Problems while running the TDR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">DELAY_16</span><span class="p">();</span> <span class="cm">/* wait for result */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">tdr_cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span> <span class="o">&amp;</span> <span class="n">STAT_MASK</span><span class="p">;</span>
		<span class="n">sun3_attn586</span><span class="p">();</span> <span class="cm">/* ack the interrupts */</span>

		<span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_LNK_OK</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_XCVR_PRB</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TDR: Transceiver problem. Check the cable(s)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_ET_OPN</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TDR: No correct termination %d clocks away.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_TIMEMASK</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_ET_SRT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_TIMEMASK</span><span class="p">)</span> <span class="cm">/* time == 0 -&gt; strange :-) */</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TDR: Detected a short circuit %d clocks away.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">TDR_TIMEMASK</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TDR: Unknown status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Multicast setup</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">num_addrs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mc_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mcsetup_cmd_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_MCSETUP</span> <span class="o">|</span> <span class="n">CMD_LAST</span><span class="p">);</span>
		<span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_link</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">mc_cnt</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">num_addrs</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">mc_cmd</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span>
		<span class="n">sun3_attn586</span><span class="p">();</span>

		<span class="n">WAIT_4_STAT_COMPL</span><span class="p">(</span><span class="n">mc_cmd</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">swab16</span><span class="p">(</span><span class="n">mc_cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_COMPL</span><span class="o">|</span><span class="n">STAT_OK</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_COMPL</span><span class="o">|</span><span class="n">STAT_OK</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t apply multicast-address-list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * alloc nop/xmit-cmds</span>
<span class="cm">	 */</span>
<span class="cp">#if (NUM_XMIT_BUFFS == 1)</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 			<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nop_cmd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span>		<span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_NOP</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span> 	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span>	<span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nop_cmd_struct</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>			<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nop_cmd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span>		<span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_NOP</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span>	<span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nop_cmd_struct</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">alloc_rfa</span><span class="p">(</span><span class="n">dev</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span> <span class="cm">/* init receive-frame-area */</span>

	<span class="cm">/*</span>
<span class="cm">	 * alloc xmit-buffs / init xmit_cmds</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">transmit_cmd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span> <span class="cm">/*transmit cmd/buff 0*/</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">transmit_cmd_struct</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span> <span class="cm">/* char-buffs */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">XMIT_BUFF_SIZE</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tbd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span> <span class="cm">/* TBD */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tbd_struct</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: not enough shared-mem for your configuration!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">transmit_cmd_struct</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tbd_struct</span><span class="p">));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">NUM_XMIT_BUFFS</span><span class="p">]);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">STAT_COMPL</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_XMIT</span> <span class="o">|</span> <span class="n">CMD_INT</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tbd_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">make24</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	 <span class="cm">/*</span>
<span class="cm">		* &#39;start transmitter&#39;</span>
<span class="cm">		*/</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>
	<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_cmd</span>	<span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">CMD_XMIT</span> <span class="o">|</span> <span class="n">CMD_SUSPEND</span> <span class="o">|</span> <span class="n">CMD_INT</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * ack. interrupts</span>
<span class="cm">	 */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span> <span class="o">&amp;</span> <span class="n">STAT_MASK</span><span class="p">;</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>
	<span class="n">DELAY_16</span><span class="p">();</span>

	<span class="n">sun3_enaint</span><span class="p">();</span>
	<span class="n">sun3_active</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************</span>
<span class="cm"> * This is a helper routine for sun3_82586_rnr_int() and init586().</span>
<span class="cm"> * It sets up the Receive Frame Area (RFA).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_rfa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">rfd_struct</span> <span class="o">*</span><span class="n">rfd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rfd_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">rbd_struct</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">rfd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd_struct</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="o">+</span><span class="n">rfdadd</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span> <span class="o">=</span> <span class="n">rfd</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="o">+</span><span class="n">rfdadd</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">rfd</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="o">+</span><span class="n">rfdadd</span><span class="p">)</span> <span class="p">);</span>
		<span class="n">rfd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rbd_offset</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rfd</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">rfdadd</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="n">RFD_SUSP</span><span class="p">;</span>	 <span class="cm">/* RU suspend */</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rfd</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">+</span> <span class="n">rfdadd</span><span class="p">)</span> <span class="p">);</span>

	<span class="n">rbd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rbd_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rbd</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">);</span>

	 <span class="cm">/* clr descriptors */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">rbd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_struct</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">));</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">rbd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">rbd</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span><span class="p">));</span>
		<span class="n">rbd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">RECV_BUFF_SIZE</span><span class="p">);</span>
		<span class="n">rbd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">make24</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">RECV_BUFF_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_last</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_recv_buffs</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rfdadd</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rfa_offset</span>		<span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="o">-&gt;</span><span class="n">rbd_offset</span>	<span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">rbd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************</span>
<span class="cm"> * Interrupt Handler ...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sun3_82586_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;sun3_82586-interrupt: irq %d for unknown device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">);</span>

	<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span> <span class="cm">/* wait for last command	*/</span>

	<span class="k">while</span><span class="p">((</span><span class="n">stat</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span> <span class="o">&amp;</span> <span class="n">STAT_MASK</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
		<span class="n">sun3_attn586</span><span class="p">();</span>

		<span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_FR</span><span class="p">)</span>	 <span class="cm">/* received a frame */</span>
			<span class="n">sun3_82586_rcv_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_RNR</span><span class="p">)</span> <span class="cm">/* RU went &#39;not ready&#39; */</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(R)&quot;</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rus</span> <span class="o">&amp;</span> <span class="n">RU_SUSPEND</span><span class="p">)</span> <span class="cm">/* special case: RU_SUSPEND */</span>
			<span class="p">{</span>
				<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span> <span class="o">=</span> <span class="n">RUC_RESUME</span><span class="p">;</span>
				<span class="n">sun3_attn586</span><span class="p">();</span>
				<span class="n">WAIT_4_SCB_CMD_RUC</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Receiver-Unit went &#39;NOT READY&#39;: %04x/%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">stat</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rus</span><span class="p">);</span>
				<span class="n">sun3_82586_rnr_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_CX</span><span class="p">)</span>		<span class="cm">/* command with I-bit set complete */</span>
			 <span class="n">sun3_82586_xmt_int</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifndef NO_NOPCOMMANDS</span>
		<span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STAT_CNA</span><span class="p">)</span>	<span class="cm">/* CU went &#39;not ready&#39; */</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: oops! CU has left active state. stat: %04x/%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">stat</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="n">cnt</span><span class="o">++</span><span class="p">);</span>

		<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span> <span class="cm">/* wait for ack. (sun3_82586_xmt_int can be faster than ack!!) */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span><span class="p">)</span>	 <span class="cm">/* timed out? */</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Acknowledge timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">sun3_disint</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************</span>
<span class="cm"> * receive-interrupt</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sun3_82586_rcv_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span><span class="n">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_struct</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;(</span><span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">stat_high</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RFD_COMPL</span><span class="p">;)</span>
	<span class="p">{</span>
			<span class="n">rbd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rbd_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">make32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">rbd_offset</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RFD_OK</span><span class="p">)</span> <span class="cm">/* frame received without error? */</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RBD_LAST</span><span class="p">)</span> <span class="cm">/* the first and the last buffer? */</span>
				<span class="p">{</span>
					<span class="n">totlen</span> <span class="o">&amp;=</span> <span class="n">RBD_MASK</span><span class="p">;</span> <span class="cm">/* length of this frame */</span>
					<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">totlen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
						<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">totlen</span><span class="p">);</span>
						<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="n">swab32</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">),</span><span class="n">totlen</span><span class="p">);</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
						<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">rstat</span><span class="p">;</span>
						 <span class="cm">/* free all RBD&#39;s until RBD_LAST is set */</span>
					<span class="n">totlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rstat</span><span class="o">=</span><span class="n">swab16</span><span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RBD_LAST</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">totlen</span> <span class="o">+=</span> <span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">RBD_MASK</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rstat</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Whoops .. no end mark in RBD list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">rbd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rbd_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">make32</span><span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">totlen</span> <span class="o">+=</span> <span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">RBD_MASK</span><span class="p">;</span>
					<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: received oversized frame! length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">totlen</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			 <span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="cm">/* frame !(ok), only with &#39;save-bad-frames&#39; */</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: oops! rfd-error-status: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">stat_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">RFD_SUSP</span><span class="p">;</span> <span class="cm">/* maybe exchange by RFD_LAST */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">rbd_offset</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_last</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* delete RFD_SUSP	*/</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_last</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rfd_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">make32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span> <span class="cm">/* step to next RFD */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rfa_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="n">cnt</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">automatic_resume</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span> <span class="o">=</span> <span class="n">RUC_RESUME</span><span class="p">;</span>
		<span class="n">sun3_attn586</span><span class="p">();</span>
		<span class="n">WAIT_4_SCB_CMD_RUC</span><span class="p">();</span>
	<span class="p">}</span>

<span class="cp">#ifdef WAIT_4_BUSY</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1024</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_top</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">DELAY_16</span><span class="p">();</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1023</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: RU hasn&#39;t fetched next RFD (not busy/complete)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if(!at_least_one)</span>
<span class="c">	{</span>
<span class="c">		int i;</span>
<span class="c">		volatile struct rfd_struct *rfds=p-&gt;rfd_top;</span>
<span class="c">		volatile struct rbd_struct *rbds;</span>
<span class="c">		printk(&quot;%s: received a FC intr. without having a frame: %04x %d\n&quot;,dev-&gt;name,status,old_at_least);</span>
<span class="c">		for(i=0;i&lt; (p-&gt;num_recv_buffs+4);i++)</span>
<span class="c">		{</span>
<span class="c">			rbds = (struct rbd_struct *) make32(rfds-&gt;rbd_offset);</span>
<span class="c">			printk(&quot;%04x:%04x &quot;,rfds-&gt;status,rbds-&gt;status);</span>
<span class="c">			rfds = (struct rfd_struct *) make32(rfds-&gt;next);</span>
<span class="c">		}</span>
<span class="c">		printk(&quot;\nerrs: %04x %04x stat: %04x\n&quot;,(int)p-&gt;scb-&gt;rsc_errs,(int)p-&gt;scb-&gt;ovrn_errs,(int)p-&gt;scb-&gt;status);</span>
<span class="c">		printk(&quot;\nerrs: %04x %04x rus: %02x, cus: %02x\n&quot;,(int)p-&gt;scb-&gt;rsc_errs,(int)p-&gt;scb-&gt;ovrn_errs,(int)p-&gt;scb-&gt;rus,(int)p-&gt;scb-&gt;cus);</span>
<span class="c">	}</span>
<span class="c">	old_at_least = at_least_one;</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> * handle &#39;Receiver went not ready&#39;.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sun3_82586_rnr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>		<span class="cm">/* wait for the last cmd, WAIT_4_FULLSTAT?? */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span> <span class="o">=</span> <span class="n">RUC_ABORT</span><span class="p">;</span> <span class="cm">/* usually the RU is in the &#39;no resource&#39;-state .. abort it now. */</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>
	<span class="n">WAIT_4_SCB_CMD_RUC</span><span class="p">();</span>		<span class="cm">/* wait for accept cmd. */</span>

	<span class="n">alloc_rfa</span><span class="p">(</span><span class="n">dev</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">);</span>
<span class="cm">/* maybe add a check here, before restarting the RU */</span>
	<span class="n">startrecv586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* restart RU */</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Receive-Unit restarted. Status: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rus</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**********************************************************</span>
<span class="cm"> * handle xmit - interrupt</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sun3_82586_xmt_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_COMPL</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: strange .. xmit-int without a &#39;COMPLETE&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_OK</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_MAXCOLLMASK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_LATECOLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: late collision detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_NOCARRIER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: no carrier detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_LOSTCTS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: loss of CTS detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: DMA underrun detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCMD_MAXCOLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Max. collisions exceeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if (NUM_XMIT_BUFFS &gt; 1)</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">++</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span><span class="p">)</span> <span class="o">==</span> <span class="n">NUM_XMIT_BUFFS</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***********************************************************</span>
<span class="cm"> * (re)start the receiver</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">startrecv586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
	<span class="n">WAIT_4_SCB_CMD_RUC</span><span class="p">();</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rfa_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rfd_first</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_ruc</span> <span class="o">=</span> <span class="n">RUC_START</span><span class="p">;</span>
	<span class="n">sun3_attn586</span><span class="p">();</span>		<span class="cm">/* start cmd. */</span>
	<span class="n">WAIT_4_SCB_CMD_RUC</span><span class="p">();</span>	<span class="cm">/* wait for accept cmd. (no timeout!!) */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sun3_82586_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span> <span class="o">&amp;</span> <span class="n">CU_ACTIVE</span><span class="p">)</span> <span class="cm">/* COMMAND-UNIT active? */</span>
	<span class="p">{</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: strange ... timeout with CU active?!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: X0: %04x N0: %04x N1: %04x %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_ABORT</span><span class="p">;</span>
		<span class="n">sun3_attn586</span><span class="p">();</span>
		<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span><span class="p">]);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span>
		<span class="n">sun3_attn586</span><span class="p">();</span>
		<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: xmitter timed out, try to restart! stat: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: command-stats: %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">),</span><span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: check, whether you set the right interrupt number!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">sun3_82586_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">sun3_82586_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
<span class="p">}</span>

<span class="cm">/******************************************************</span>
<span class="cm"> * send frame</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sun3_82586_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>
<span class="cp">#ifndef NO_NOPCOMMANDS</span>
	<span class="kt">int</span> <span class="n">next_nop</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">XMIT_BUFF_SIZE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Sorry, max. framelength is %d bytes. The length of your frame is %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">XMIT_BUFF_SIZE</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#if(NUM_XMIT_BUFFS &gt; 1)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Queue was locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">ETH_ZLEN</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cbuffs</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

<span class="cp">#if (NUM_XMIT_BUFFS == 1)</span>
<span class="cp">#	ifdef NO_NOPCOMMANDS</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span> <span class="o">&amp;</span> <span class="n">CU_ACTIVE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Hmmm .. CU is still running and we wanna send a new packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: stat: %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span><span class="p">,</span><span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">TBD_LAST</span> <span class="o">|</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
			<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span> <span class="o">&amp;</span> <span class="n">CU_STATUS</span><span class="p">)</span> <span class="o">==</span> <span class="n">CU_SUSPEND</span><span class="p">)</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_RESUME</span><span class="p">;</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cbl_offset</span> <span class="o">=</span> <span class="n">make16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd_cuc</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sun3_attn586</span><span class="p">();</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">WAIT_4_SCB_CMD</span><span class="p">();</span>
			<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cus</span> <span class="o">&amp;</span> <span class="n">CU_ACTIVE</span><span class="p">))</span> <span class="cm">/* test it, because CU sometimes doesn&#39;t start immediately */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">15</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t start transmit-command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#	else</span>
		<span class="n">next_nop</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">TBD_LAST</span> <span class="o">|</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span>	 <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span>
			<span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span> <span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_point</span> <span class="o">=</span> <span class="n">next_nop</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#	endif</span>
<span class="cp">#else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_buffs</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">TBD_LAST</span> <span class="o">|</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">next_nop</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">NUM_XMIT_BUFFS</span> <span class="p">)</span>
			<span class="n">next_nop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* linkpointer of xmit-command already points to next nop cmd */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span> <span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">next_nop</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nop_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_link</span> <span class="o">=</span> <span class="n">make16</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_cmds</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">]));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">=</span> <span class="n">next_nop</span><span class="p">;</span>

		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_last</span><span class="p">)</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************</span>
<span class="cm"> * Someone wanna have the statistics</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">sun3_82586_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span><span class="p">,</span><span class="n">aln</span><span class="p">,</span><span class="n">rsc</span><span class="p">,</span><span class="n">ovrn</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">crc_errs</span><span class="p">);</span> <span class="cm">/* get error-statistic from the ni82586 */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">crc_errs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">aln</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">aln_errs</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">aln_errs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rsc</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rsc_errs</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">rsc_errs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ovrn</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">ovrn_errs</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">ovrn_errs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">+=</span> <span class="n">ovrn</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="n">aln</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">rsc</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************</span>
<span class="cm"> * Set MC list ..</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sun3_disint</span><span class="p">();</span>
	<span class="n">alloc586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">startrecv586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sun3_enaint</span><span class="p">();</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> * DUMP .. we expect a not running CMD unit and enough space</span>
<span class="c"> */</span>
<span class="c">void sun3_82586_dump(struct net_device *dev,void *ptr)</span>
<span class="c">{</span>
<span class="c">	struct priv *p = netdev_priv(dev);</span>
<span class="c">	struct dump_cmd_struct *dump_cmd = (struct dump_cmd_struct *) ptr;</span>
<span class="c">	int i;</span>

<span class="c">	p-&gt;scb-&gt;cmd_cuc = CUC_ABORT;</span>
<span class="c">	sun3_attn586();</span>
<span class="c">	WAIT_4_SCB_CMD();</span>
<span class="c">	WAIT_4_SCB_CMD_RUC();</span>

<span class="c">	dump_cmd-&gt;cmd_status = 0;</span>
<span class="c">	dump_cmd-&gt;cmd_cmd = CMD_DUMP | CMD_LAST;</span>
<span class="c">	dump_cmd-&gt;dump_offset = make16((dump_cmd + 1));</span>
<span class="c">	dump_cmd-&gt;cmd_link = 0xffff;</span>

<span class="c">	p-&gt;scb-&gt;cbl_offset = make16(dump_cmd);</span>
<span class="c">	p-&gt;scb-&gt;cmd_cuc = CUC_START;</span>
<span class="c">	sun3_attn586();</span>
<span class="c">	WAIT_4_STAT_COMPL(dump_cmd);</span>

<span class="c">	if( (dump_cmd-&gt;cmd_status &amp; (STAT_COMPL|STAT_OK)) != (STAT_COMPL|STAT_OK) )</span>
<span class="c">				printk(&quot;%s: Can&#39;t get dump information.\n&quot;,dev-&gt;name);</span>

<span class="c">	for(i=0;i&lt;170;i++) {</span>
<span class="c">		printk(&quot;%02x &quot;,(int) ((unsigned char *) (dump_cmd + 1))[i]);</span>
<span class="c">		if(i % 24 == 23)</span>
<span class="c">			printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="c">	printk(&quot;\n&quot;);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
