<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › lp486e.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>lp486e.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Intel Professional Workstation/panther ethernet driver */</span>
<span class="cm">/* lp486e.c: A panther 82596 ethernet driver for linux. */</span>
<span class="cm">/*</span>
<span class="cm">    History and copyrights:</span>

<span class="cm">    Driver skeleton</span>
<span class="cm">        Written 1993 by Donald Becker.</span>
<span class="cm">        Copyright 1993 United States Government as represented by the Director,</span>
<span class="cm">        National Security Agency.  This software may only be used and</span>
<span class="cm">	distributed according to the terms of the GNU General Public License</span>
<span class="cm">	as modified by SRC, incorporated herein by reference.</span>

<span class="cm">        The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>

<span class="cm">    Apricot</span>
<span class="cm">        Written 1994 by Mark Evans.</span>
<span class="cm">        This driver is for the Apricot 82596 bus-master interface</span>

<span class="cm">        Modularised 12/94 Mark Evans</span>

<span class="cm">    Professional Workstation</span>
<span class="cm">	Derived from apricot.c by Ard van Breemen</span>
<span class="cm">	&lt;ard@murphy.nl&gt;|&lt;ard@cstmel.hobby.nl&gt;|&lt;ard@cstmel.nl.eu.org&gt;</span>

<span class="cm">	Credits:</span>
<span class="cm">	Thanks to Murphy Software BV for letting me write this in their time.</span>
<span class="cm">	Well, actually, I get paid doing this...</span>
<span class="cm">	(Also: see http://www.murphy.nl for murphy, and my homepage ~ard for</span>
<span class="cm">	more information on the Professional Workstation)</span>

<span class="cm">    Present version</span>
<span class="cm">	aeb@cwi.nl</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">    There are currently two motherboards that I know of in the</span>
<span class="cm">    professional workstation. The only one that I know is the</span>
<span class="cm">    intel panther motherboard. -- ard</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">The pws is equipped with an intel 82596. This is a very intelligent controller</span>
<span class="cm">which runs its own micro-code. Communication with the hostprocessor is done</span>
<span class="cm">through linked lists of commands and buffers in the hostprocessors memory.</span>
<span class="cm">A complete description of the 82596 is available from intel. Search for</span>
<span class="cm">a file called &quot;29021806.pdf&quot;. It is a complete description of the chip itself.</span>
<span class="cm">To use it for the pws some additions are needed regarding generation of</span>
<span class="cm">the PORT and CA signal, and the interrupt glue needed for a pc.</span>
<span class="cm">I/O map:</span>
<span class="cm">PORT  SIZE ACTION MEANING</span>
<span class="cm">0xCB0    2 WRITE  Lower 16 bits for PORT command</span>
<span class="cm">0xCB2    2 WRITE  Upper 16 bits for PORT command, and issue of PORT command</span>
<span class="cm">0xCB4    1 WRITE  Generation of CA signal</span>
<span class="cm">0xCB8    1 WRITE  Clear interrupt glue</span>
<span class="cm">All other communication is through memory!</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;lp486e&quot;</span>

<span class="cm">/* debug print flags */</span>
<span class="cp">#define LOG_SRCDST    0x80000000</span>
<span class="cp">#define LOG_STATINT   0x40000000</span>
<span class="cp">#define LOG_STARTINT  0x20000000</span>

<span class="cp">#define i596_debug debug</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i596_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">medianame</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;10baseT&quot;</span><span class="p">,</span> <span class="s">&quot;AUI&quot;</span><span class="p">,</span>
	<span class="s">&quot;10baseT-FD&quot;</span><span class="p">,</span> <span class="s">&quot;AUI-FD&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define LP486E_TOTAL_SIZE 16</span>

<span class="cp">#define I596_NULL (0xffffffff)</span>

<span class="cp">#define CMD_EOL		0x8000	</span><span class="cm">/* The last command of the list, stop. */</span><span class="cp"></span>
<span class="cp">#define CMD_SUSP	0x4000	</span><span class="cm">/* Suspend after doing cmd. */</span><span class="cp"></span>
<span class="cp">#define CMD_INTR	0x2000	</span><span class="cm">/* Interrupt after doing cmd. */</span><span class="cp"></span>

<span class="cp">#define CMD_FLEX	0x0008	</span><span class="cm">/* Enable flexible memory model */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">commands</span> <span class="p">{</span>
	<span class="n">CmdNOP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CmdIASetup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CmdConfigure</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CmdMulticastList</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CmdTx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">CmdTDR</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">CmdDump</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">CmdDiagnose</span> <span class="o">=</span> <span class="mi">7</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static const char *CUcmdnames[8] = { &quot;NOP&quot;, &quot;IASetup&quot;, &quot;Configure&quot;, &quot;MulticastList&quot;,</span>
<span class="c">				     &quot;Tx&quot;, &quot;TDR&quot;, &quot;Dump&quot;, &quot;Diagnose&quot; };</span>
<span class="cp">#endif</span>

<span class="cm">/* Status word bits */</span>
<span class="cp">#define	STAT_CX		0x8000	</span><span class="cm">/* The CU finished executing a command</span>
<span class="cm">				   with the Interrupt bit set */</span><span class="cp"></span>
<span class="cp">#define	STAT_FR		0x4000	</span><span class="cm">/* The RU finished receiving a frame */</span><span class="cp"></span>
<span class="cp">#define	STAT_CNA	0x2000	</span><span class="cm">/* The CU left the active state */</span><span class="cp"></span>
<span class="cp">#define	STAT_RNR	0x1000	</span><span class="cm">/* The RU left the active state */</span><span class="cp"></span>
<span class="cp">#define STAT_ACK	(STAT_CX | STAT_FR | STAT_CNA | STAT_RNR)</span>
<span class="cp">#define	STAT_CUS	0x0700	</span><span class="cm">/* Status of CU: 0: idle, 1: suspended,</span>
<span class="cm">				   2: active, 3-7: unused */</span><span class="cp"></span>
<span class="cp">#define STAT_RUS	0x00f0	</span><span class="cm">/* Status of RU: 0: idle, 1: suspended,</span>
<span class="cm">				   2: no resources, 4: ready,</span>
<span class="cm">				   10: no resources due to no more RBDs,</span>
<span class="cm">				   12: no more RBDs, other: unused */</span><span class="cp"></span>
<span class="cp">#define	STAT_T		0x0008	</span><span class="cm">/* Bus throttle timers loaded */</span><span class="cp"></span>
<span class="cp">#define	STAT_ZERO	0x0807	</span><span class="cm">/* Always zero */</span><span class="cp"></span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static char *CUstates[8] = {</span>
<span class="c">	&quot;idle&quot;, &quot;suspended&quot;, &quot;active&quot;, 0, 0, 0, 0, 0</span>
<span class="c">};</span>
<span class="c">static char *RUstates[16] = {</span>
<span class="c">	&quot;idle&quot;, &quot;suspended&quot;, &quot;no resources&quot;, 0, &quot;ready&quot;, 0, 0, 0,</span>
<span class="c">	0, 0, &quot;no RBDs&quot;, 0, &quot;out of RBDs&quot;, 0, 0, 0</span>
<span class="c">};</span>

<span class="c">static void</span>
<span class="c">i596_out_status(int status) {</span>
<span class="c">	int bad = 0;</span>
<span class="c">	char *s;</span>

<span class="c">	printk(&quot;status %4.4x:&quot;, status);</span>
<span class="c">	if (status == 0xffff)</span>
<span class="c">		printk(&quot; strange..\n&quot;);</span>
<span class="c">	else {</span>
<span class="c">		if (status &amp; STAT_CX)</span>
<span class="c">			printk(&quot;  CU done&quot;);</span>
<span class="c">		if (status &amp; STAT_CNA)</span>
<span class="c">			printk(&quot;  CU stopped&quot;);</span>
<span class="c">		if (status &amp; STAT_FR)</span>
<span class="c">			printk(&quot;  got a frame&quot;);</span>
<span class="c">		if (status &amp; STAT_RNR)</span>
<span class="c">			printk(&quot;  RU stopped&quot;);</span>
<span class="c">		if (status &amp; STAT_T)</span>
<span class="c">			printk(&quot;  throttled&quot;);</span>
<span class="c">		if (status &amp; STAT_ZERO)</span>
<span class="c">			bad = 1;</span>
<span class="c">		s = CUstates[(status &amp; STAT_CUS) &gt;&gt; 8];</span>
<span class="c">		if (!s)</span>
<span class="c">			bad = 1;</span>
<span class="c">		else</span>
<span class="c">			printk(&quot;  CU(%s)&quot;, s);</span>
<span class="c">		s = RUstates[(status &amp; STAT_RUS) &gt;&gt; 4];</span>
<span class="c">		if (!s)</span>
<span class="c">			bad = 1;</span>
<span class="c">		else</span>
<span class="c">			printk(&quot;  RU(%s)&quot;, s);</span>
<span class="c">		if (bad)</span>
<span class="c">			printk(&quot;  bad status&quot;);</span>
<span class="c">		printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Command word bits */</span>
<span class="cp">#define ACK_CX		0x8000</span>
<span class="cp">#define ACK_FR		0x4000</span>
<span class="cp">#define ACK_CNA		0x2000</span>
<span class="cp">#define ACK_RNR		0x1000</span>

<span class="cp">#define CUC_START	0x0100</span>
<span class="cp">#define CUC_RESUME	0x0200</span>
<span class="cp">#define CUC_SUSPEND	0x0300</span>
<span class="cp">#define CUC_ABORT	0x0400</span>

<span class="cp">#define RX_START	0x0010</span>
<span class="cp">#define RX_RESUME	0x0020</span>
<span class="cp">#define RX_SUSPEND	0x0030</span>
<span class="cp">#define RX_ABORT	0x0040</span>

<span class="k">typedef</span> <span class="n">u32</span> <span class="n">phys_addr</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">phys_addr</span>
<span class="nf">va_to_pa</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">x</span> <span class="o">?</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="n">I596_NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">pa_to_va</span><span class="p">(</span><span class="n">phys_addr</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">I596_NULL</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">bus_to_virt</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* status bits for cmd */</span>
<span class="cp">#define CMD_STAT_C	0x8000	</span><span class="cm">/* CU command complete */</span><span class="cp"></span>
<span class="cp">#define CMD_STAT_B	0x4000	</span><span class="cm">/* CU command in progress */</span><span class="cp"></span>
<span class="cp">#define CMD_STAT_OK	0x2000	</span><span class="cm">/* CU command completed without errors */</span><span class="cp"></span>
<span class="cp">#define CMD_STAT_A	0x1000	</span><span class="cm">/* CU command abnormally terminated */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="p">{</span>		<span class="cm">/* 8 bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">phys_addr</span> <span class="n">pa_next</span><span class="p">;</span>	<span class="cm">/* va_to_pa(struct i596_cmd *next) */</span>
<span class="p">};</span>

<span class="cp">#define EOF		0x8000</span>
<span class="cp">#define SIZE_MASK	0x3fff</span>

<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">phys_addr</span> <span class="n">pa_next</span><span class="p">;</span>	<span class="cm">/* va_to_pa(struct i596_tbd *next) */</span>
	<span class="n">phys_addr</span> <span class="n">pa_data</span><span class="p">;</span>	<span class="cm">/* va_to_pa(char *data) */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">phys_addr</span> <span class="n">pa_tbd</span><span class="p">;</span>	<span class="cm">/* va_to_pa(struct i596_tbd *tbd) */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* status bits for rfd */</span>
<span class="cp">#define RFD_STAT_C	0x8000	</span><span class="cm">/* Frame reception complete */</span><span class="cp"></span>
<span class="cp">#define RFD_STAT_B	0x4000	</span><span class="cm">/* Frame reception in progress */</span><span class="cp"></span>
<span class="cp">#define RFD_STAT_OK	0x2000	</span><span class="cm">/* Frame received without errors */</span><span class="cp"></span>
<span class="cp">#define RFD_STATUS	0x1fff</span>
<span class="cp">#define RFD_LENGTH_ERR	0x1000</span>
<span class="cp">#define RFD_CRC_ERR	0x0800</span>
<span class="cp">#define RFD_ALIGN_ERR	0x0400</span>
<span class="cp">#define RFD_NOBUFS_ERR	0x0200</span>
<span class="cp">#define RFD_DMA_ERR	0x0100	</span><span class="cm">/* DMA overrun failure to acquire system bus */</span><span class="cp"></span>
<span class="cp">#define RFD_SHORT_FRAME_ERR	0x0080</span>
<span class="cp">#define RFD_NOEOP_ERR	0x0040</span>
<span class="cp">#define RFD_TRUNC_ERR	0x0020</span>
<span class="cp">#define RFD_MULTICAST  0x0002	</span><span class="cm">/* 0: destination had our address</span>
<span class="cm">				   1: destination was broadcast/multicast */</span><span class="cp"></span>
<span class="cp">#define RFD_COLLISION  0x0001</span>

<span class="cm">/* receive frame descriptor */</span>
<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">phys_addr</span> <span class="n">pa_next</span><span class="p">;</span>	<span class="cm">/* va_to_pa(struct i596_rfd *next) */</span>
	<span class="n">phys_addr</span> <span class="n">pa_rbd</span><span class="p">;</span>	<span class="cm">/* va_to_pa(struct i596_rbd *rbd) */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">1532</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define RBD_EL		0x8000</span>
<span class="cp">#define RBD_P		0x4000</span>
<span class="cp">#define RBD_SIZEMASK	0x3fff</span>
<span class="cp">#define RBD_EOF		0x8000</span>
<span class="cp">#define RBD_F		0x4000</span>

<span class="cm">/* receive buffer descriptor */</span>
<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">phys_addr</span> <span class="n">pa_next</span><span class="p">;</span>	<span class="cm">/* va_to_pa(struct i596_tbd *next) */</span>
	<span class="n">phys_addr</span> <span class="n">pa_data</span><span class="p">;</span>	<span class="cm">/* va_to_pa(char *data) */</span>
	<span class="n">phys_addr</span> <span class="n">pa_prev</span><span class="p">;</span>	<span class="cm">/* va_to_pa(struct i596_tbd *prev) */</span>

	<span class="cm">/* Driver private part */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define RX_RING_SIZE 64</span>
<span class="cp">#define RX_SKBSIZE (ETH_FRAME_LEN+10)</span>
<span class="cp">#define RX_RBD_SIZE 32</span>

<span class="cm">/* System Control Block - 40 bytes */</span>
<span class="k">struct</span> <span class="n">i596_scb</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>		<span class="cm">/* 0 */</span>
	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>		<span class="cm">/* 2 */</span>
	<span class="n">phys_addr</span> <span class="n">pa_cmd</span><span class="p">;</span>	<span class="cm">/* 4 - va_to_pa(struct i596_cmd *cmd) */</span>
	<span class="n">phys_addr</span> <span class="n">pa_rfd</span><span class="p">;</span>	<span class="cm">/* 8 - va_to_pa(struct i596_rfd *rfd) */</span>
	<span class="n">u32</span> <span class="n">crc_err</span><span class="p">;</span>		<span class="cm">/* 12 */</span>
	<span class="n">u32</span> <span class="n">align_err</span><span class="p">;</span>		<span class="cm">/* 16 */</span>
	<span class="n">u32</span> <span class="n">resource_err</span><span class="p">;</span>	<span class="cm">/* 20 */</span>
	<span class="n">u32</span> <span class="n">over_err</span><span class="p">;</span>		<span class="cm">/* 24 */</span>
	<span class="n">u32</span> <span class="n">rcvdt_err</span><span class="p">;</span>		<span class="cm">/* 28 */</span>
	<span class="n">u32</span> <span class="n">short_err</span><span class="p">;</span>		<span class="cm">/* 32 */</span>
	<span class="n">u16</span> <span class="n">t_on</span><span class="p">;</span>		<span class="cm">/* 36 */</span>
	<span class="n">u16</span> <span class="n">t_off</span><span class="p">;</span>		<span class="cm">/* 38 */</span>
<span class="p">};</span>

<span class="cm">/* Intermediate System Configuration Pointer - 8 bytes */</span>
<span class="k">struct</span> <span class="n">i596_iscp</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">busy</span><span class="p">;</span>		<span class="cm">/* 0 */</span>
	<span class="n">phys_addr</span> <span class="n">pa_scb</span><span class="p">;</span>	<span class="cm">/* 4 - va_to_pa(struct i596_scb *scb) */</span>
<span class="p">};</span>

<span class="cm">/* System Configuration Pointer - 12 bytes */</span>
<span class="k">struct</span> <span class="n">i596_scp</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">sysbus</span><span class="p">;</span>		<span class="cm">/* 0 */</span>
	<span class="n">u32</span> <span class="n">pad</span><span class="p">;</span>		<span class="cm">/* 4 */</span>
	<span class="n">phys_addr</span> <span class="n">pa_iscp</span><span class="p">;</span>	<span class="cm">/* 8 - va_to_pa(struct i596_iscp *iscp) */</span>
<span class="p">};</span>

<span class="cm">/* Selftest and dump results - needs 16-byte alignment */</span>
<span class="cm">/*</span>
<span class="cm"> * The size of the dump area is 304 bytes. When the dump is executed</span>
<span class="cm"> * by the Port command an extra word will be appended to the dump area.</span>
<span class="cm"> * The extra word is a copy of the Dump status word (containing the</span>
<span class="cm"> * C, B, OK bits). [I find 0xa006, with a0 for C+OK and 6 for dump]</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">i596_dump</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">dump</span><span class="p">[</span><span class="mi">153</span><span class="p">];</span>		<span class="cm">/* (304 = 130h) + 2 bytes */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i596_private</span> <span class="p">{</span>		<span class="cm">/* aligned to a 16-byte boundary */</span>
	<span class="k">struct</span> <span class="n">i596_scp</span> <span class="n">scp</span><span class="p">;</span>	<span class="cm">/* 0 - needs 16-byte alignment */</span>
	<span class="k">struct</span> <span class="n">i596_iscp</span> <span class="n">iscp</span><span class="p">;</span>	<span class="cm">/* 12 */</span>
	<span class="k">struct</span> <span class="n">i596_scb</span> <span class="n">scb</span><span class="p">;</span>	<span class="cm">/* 20 */</span>
	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>		<span class="cm">/* 60 */</span>
	<span class="k">struct</span> <span class="n">i596_dump</span> <span class="n">dump</span><span class="p">;</span>	<span class="cm">/* 64 - needs 16-byte alignment */</span>

	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">set_add</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">eth_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* directly follows set_add */</span>

	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">set_conf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i596_config</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/* directly follows set_conf */</span>

	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">tdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tdr_stat</span><span class="p">;</span>	<span class="cm">/* directly follows tdr */</span>

	<span class="kt">int</span> <span class="n">last_restart</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd_tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rx_tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd_tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_backlog</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_cmd</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">cmd_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">init_setup</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x8E</span><span class="p">,</span>	<span class="cm">/* length 14 bytes, prefetch on */</span>
	<span class="mh">0xC8</span><span class="p">,</span>	<span class="cm">/* default: fifo to 8, monitor off */</span>
	<span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/* default: don&#39;t save bad frames (apricot.c had 0x80) */</span>
	<span class="mh">0x2E</span><span class="p">,</span>	<span class="cm">/* (default is 0x26)</span>
<span class="cm">		   No source address insertion, 8 byte preamble */</span>
	<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* default priority and backoff */</span>
	<span class="mh">0x60</span><span class="p">,</span>	<span class="cm">/* default interframe spacing */</span>
	<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* default slot time LSB */</span>
	<span class="mh">0xf2</span><span class="p">,</span>	<span class="cm">/* default slot time and nr of retries */</span>
	<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* default various bits</span>
<span class="cm">		   (0: promiscuous mode, 1: broadcast disable,</span>
<span class="cm">		    2: encoding mode, 3: transmit on no CRS,</span>
<span class="cm">		    4: no CRC insertion, 5: CRC type,</span>
<span class="cm">		    6: bit stuffing, 7: padding) */</span>
	<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* default carrier sense and collision detect */</span>
	<span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/* default minimum frame length */</span>
	<span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* (default is 0xff, and that is what apricot.c has;</span>
<span class="cm">		   elp486.c has 0xfb: Enable crc append in memory.) */</span>
	<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* default: not full duplex */</span>
	<span class="mh">0x7f</span>	<span class="cm">/* (default is 0x3f) multi IA */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i596_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">i596_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">i596_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">i596_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i596_add_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">print_eth</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i596_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i596_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ct</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boguscnt</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s timed out - stat %4.4x, cmd %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">init_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>struct i596_rbd *rbd;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i596_rfd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">pa_rbd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1532</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_EOL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="n">rfd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span> <span class="o">=</span> <span class="n">va_to_pa</span><span class="p">(</span><span class="n">rfd</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	for (i = 0; i&lt;RX_RBD_SIZE; i++) {</span>
<span class="c">		rbd = kmalloc(sizeof(struct i596_rbd), GFP_KERNEL);</span>
<span class="c">		if (rbd) {</span>
<span class="c">			rbd-&gt;pad = 0;</span>
<span class="c">			rbd-&gt;count = 0;</span>
<span class="c">			rbd-&gt;skb = dev_alloc_skb(RX_SKBSIZE);</span>
<span class="c">			if (!rbd-&gt;skb) {</span>
<span class="c">				printk(&quot;dev_alloc_skb failed&quot;);</span>
<span class="c">			}</span>
<span class="c">			rbd-&gt;next = rfd-&gt;rbd;</span>
<span class="c">			if (i) {</span>
<span class="c">				rfd-&gt;rbd-&gt;prev = rbd;</span>
<span class="c">				rbd-&gt;size = RX_SKBSIZE;</span>
<span class="c">			} else {</span>
<span class="c">				rbd-&gt;size = (RX_SKBSIZE | RBD_EL);</span>
<span class="c">				lp-&gt;rbd_tail = rbd;</span>
<span class="c">			}</span>

<span class="c">			rfd-&gt;rbd = rbd;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	lp-&gt;rbd_tail-&gt;next = rfd-&gt;rbd;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">remove_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rfd</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">pa_next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rfd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rfd</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	for (lp-&gt;rbd_list) {</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define PORT_RESET              0x00    </span><span class="cm">/* reset 82596 */</span><span class="cp"></span>
<span class="cp">#define PORT_SELFTEST           0x01    </span><span class="cm">/* selftest */</span><span class="cp"></span>
<span class="cp">#define PORT_ALTSCP             0x02    </span><span class="cm">/* alternate SCB address */</span><span class="cp"></span>
<span class="cp">#define PORT_DUMP               0x03    </span><span class="cm">/* dump */</span><span class="cp"></span>

<span class="cp">#define IOADDR	0xcb0		</span><span class="cm">/* real constant */</span><span class="cp"></span>
<span class="cp">#define IRQ	10		</span><span class="cm">/* default IRQ - can be changed by ECU */</span><span class="cp"></span>

<span class="cm">/* The 82596 requires two 16-bit write cycles for a port command */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">PORT</span><span class="p">(</span><span class="n">phys_addr</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lp486e.c: PORT: address not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(((</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="n">cmd</span><span class="p">),</span> <span class="n">IOADDR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(((</span><span class="n">a</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="n">IOADDR</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">CA</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IOADDR</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">CLEAR_INT</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IOADDR</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* selftest or dump */</span>
<span class="c">static void</span>
<span class="c">i596_port_do(struct net_device *dev, int portcmd, char *cmdname) {</span>
<span class="c">	struct i596_private *lp = netdev_priv(dev);</span>
<span class="c">	u16 *outp;</span>
<span class="c">	int i, m;</span>

<span class="c">	memset((void *)&amp;(lp-&gt;dump), 0, sizeof(struct i596_dump));</span>
<span class="c">	outp = &amp;(lp-&gt;dump.dump[0]);</span>

<span class="c">	PORT(va_to_pa(outp), portcmd);</span>
<span class="c">	mdelay(30);             /* random, unmotivated */</span>

<span class="c">	printk(&quot;lp486e i82596 %s result:\n&quot;, cmdname);</span>
<span class="c">	for (m = ARRAY_SIZE(lp-&gt;dump.dump); m &amp;&amp; lp-&gt;dump.dump[m-1] == 0; m--)</span>
<span class="c">		;</span>
<span class="c">	for (i = 0; i &lt; m; i++) {</span>
<span class="c">		printk(&quot; %04x&quot;, lp-&gt;dump.dump[i]);</span>
<span class="c">		if (i%8 == 7)</span>
<span class="c">			printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="c">	printk(&quot;\n&quot;);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i596_scp_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">boguscnt</span><span class="p">;</span>

	<span class="cm">/* Setup SCP, ISCP, SCB */</span>
	<span class="cm">/*</span>
<span class="cm">	 * sysbus bits:</span>
<span class="cm">	 *  only a single byte is significant - here 0x44</span>
<span class="cm">	 *  0x80: big endian mode (details depend on stepping)</span>
<span class="cm">	 *  0x40: 1</span>
<span class="cm">	 *  0x20: interrupt pin is active low</span>
<span class="cm">	 *  0x10: lock function disabled</span>
<span class="cm">	 *  0x08: external triggering of bus throttle timers</span>
<span class="cm">	 *  0x06: 00: 82586 compat mode, 01: segmented mode, 10: linear mode</span>
<span class="cm">	 *  0x01: unused</span>
<span class="cm">	 */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">sysbus</span> <span class="o">=</span> <span class="mh">0x00440000</span><span class="p">;</span> 		<span class="cm">/* linear mode */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* must be zero */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">pa_iscp</span> <span class="o">=</span> <span class="n">va_to_pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * The CPU sets the ISCP to 1 before it gives the first CA()</span>
<span class="cm">	 */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">pa_scb</span> <span class="o">=</span> <span class="n">va_to_pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">));</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_cmd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
	<span class="cm">/* lp-&gt;scb.pa_rfd has been initialised already */</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_cmd</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the 82596.</span>
<span class="cm">	 * We need to wait 10 systemclock cycles, and</span>
<span class="cm">	 * 5 serial clock cycles.</span>
<span class="cm">	 */</span>
	<span class="n">PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PORT_RESET</span><span class="p">);</span>	<span class="cm">/* address part ignored */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Before the CA signal is asserted, the default SCP address</span>
<span class="cm">	 * (0x00fffff4) can be changed to a 16-byte aligned value</span>
<span class="cm">	 */</span>
	<span class="n">PORT</span><span class="p">(</span><span class="n">va_to_pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">),</span> <span class="n">PORT_ALTSCP</span><span class="p">);</span>	<span class="cm">/* change the scp address */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The initialization procedure begins when a</span>
<span class="cm">	 * Channel Attention signal is asserted after a reset.</span>
<span class="cm">	 */</span>

	<span class="n">CA</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ISCP busy is cleared by the 82596 after the SCB address is read.</span>
<span class="cm">	 */</span>
	<span class="n">boguscnt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No i82596 present? */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: i82596 initialization timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* I find here boguscnt==100, so no delay was required. */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_i596</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i596_scp_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">i596_config</span><span class="p">,</span> <span class="n">init_setup</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">set_conf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdConfigure</span><span class="p">;</span>
	<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">set_conf</span><span class="p">);</span>

	<span class="n">memcpy</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eth_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">set_add</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdIASetup</span><span class="p">;</span>
	<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">set_add</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdTDR</span><span class="p">;</span>
	<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i82596 init&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">RX_START</span><span class="p">;</span>
	<span class="n">CA</span><span class="p">();</span>

	<span class="n">barrier</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Receive Unit start&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Receive a single frame */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">i596_rx_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">frames</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_STAT_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* a good frame */</span>
		<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">frames</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">CMD_EOL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Received on EOL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s: i596_rx Memory squeeze, &quot;</span>
				<span class="s">&quot;dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">pkt_len</span><span class="p">),</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(&quot;Frame reception error status %04x\n&quot;,</span>
<span class="c">		       rfd-&gt;stat);</span>
<span class="cp">#endif</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_COLLISION</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_SHORT_FRAME_ERR</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_DMA_ERR</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_NOBUFS_ERR</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_ALIGN_ERR</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_CRC_ERR</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_LENGTH_ERR</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i596_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfd</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i596_rx: NULL rfd?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if 1</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RFD_STAT_C</span> <span class="o">|</span> <span class="n">RFD_STAT_B</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SF:%p-%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rfd</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RFD_STAT_C</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>		<span class="cm">/* next one not ready */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i596_rx_one</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">rfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frames</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>		<span class="cm">/* out of memory */</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_EOL</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="n">rfd</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_rfd</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">pa_next</span><span class="p">;</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">frames</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i596_cleanup_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="o">-&gt;</span><span class="n">pa_next</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span><span class="o">--</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CmdTx</span>: <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="o">*</span> <span class="n">tx_cmd_tbd</span><span class="p">;</span>
				<span class="n">tx_cmd_tbd</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">pa_tbd</span><span class="p">);</span>

				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_cmd</span><span class="p">);</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">CmdMulticastList</span>: <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>unsigned short count = *((unsigned short *) (ptr + 1));</p></td><td class="code"><div class="highlight"><pre>				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nl">default:</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i596_cleanup_cmd&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_cmd</span> <span class="o">=</span> <span class="n">va_to_pa</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i596_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i596_reset&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CUC_ABORT</span> <span class="o">|</span> <span class="n">RX_ABORT</span><span class="p">;</span>
	<span class="n">CA</span><span class="p">();</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* wait for shutdown */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i596_reset(2)&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="n">i596_cleanup_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">i596_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*dev_kfree_skb(skb, FREE_WRITE);*/</span>
	<span class="n">init_i596</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i596_add_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CMD_EOL</span> <span class="o">|</span> <span class="n">CMD_INTR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_tail</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">va_to_pa</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i596_add_cmd&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
			<span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_cmd</span> <span class="o">=</span> <span class="n">va_to_pa</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span>
		<span class="n">CA</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_tail</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span><span class="o">++</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tickssofar</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tickssofar</span> <span class="o">&lt;</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: command unit timed out, status resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">i596_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i596_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">i596_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: IRQ %d not free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">init_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_RING_SIZE</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: only able to allocate %d receive buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_i596</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Always succeed */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">i596_start_xmit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_tbd</span><span class="p">)),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i596_xmit Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="o">*</span><span class="n">tx_cmd_tbd</span><span class="p">;</span>
		<span class="n">tx_cmd_tbd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_tbd</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">tx_cmd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">pa_tbd</span> <span class="o">=</span> <span class="n">va_to_pa</span> <span class="p">(</span><span class="n">tx_cmd_tbd</span><span class="p">);</span>
		<span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>

		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">CMD_FLEX</span> <span class="o">|</span> <span class="n">CmdTx</span><span class="p">);</span>

		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">EOF</span> <span class="o">|</span> <span class="n">length</span><span class="p">);</span>

		<span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">pa_data</span> <span class="o">=</span> <span class="n">va_to_pa</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span> <span class="o">&amp;</span> <span class="n">LOG_SRCDST</span><span class="p">)</span>
			<span class="n">print_eth</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="n">i596_add_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">tx_cmd</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i596_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* Transmitter timeout, serious problems. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timed out, status resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Try to restart the adaptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_restart</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Resetting board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Shutdown and restart */</span>
		<span class="n">i596_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Issue a channel attention signal */</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Kicking board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">CUC_START</span> <span class="o">|</span> <span class="n">RX_START</span><span class="p">);</span>
		<span class="n">CA</span><span class="p">();</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_restart</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_eth</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Dest  &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">add</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Source&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">add</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;type %2.2X%2.2X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">add</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">add</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">i596_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">i596_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">i596_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">i596_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">i596_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lp486e_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">eth_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bios</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">probed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">probed</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">IOADDR</span><span class="p">,</span> <span class="n">LP486E_TOTAL_SIZE</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lp486e: IO address 0x%x in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IOADDR</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do we really have this thing?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i596_scp_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">IOADDR</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * How do we find the ethernet address? I don&#39;t know.</span>
<span class="cm">	 * One possibility is to look at the EISA configuration area</span>
<span class="cm">	 * [0xe8000-0xe9fff]. This contains the ethernet address</span>
<span class="cm">	 * but not at a fixed address - things depend on setup options.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we find no address, or the wrong address, use</span>
<span class="cm">	 *   ifconfig eth0 hw ether a1:a2:a3:a4:a5:a6</span>
<span class="cm">	 * with the value found in the BIOS setup.</span>
<span class="cm">	 */</span>
	<span class="n">bios</span> <span class="o">=</span> <span class="n">bus_to_virt</span><span class="p">(</span><span class="mh">0xe8000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x2000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xaa</span> <span class="o">&amp;&amp;</span> <span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: maybe address at BIOS 0x%x:&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mh">0xe8000</span><span class="o">+</span><span class="n">j</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: lp486e 82596 at %#3lx, IRQ %d,&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* The LP486E-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i596_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* selftest reports 0x320925ae - don&#39;t know what that means */</span>
<span class="c">	i596_port_do(dev, PORT_SELFTEST, &quot;selftest&quot;);</span>
<span class="c">	i596_port_do(dev, PORT_DUMP, &quot;dump&quot;);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_kfree:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">IOADDR</span><span class="p">,</span> <span class="n">LP486E_TOTAL_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">i596_handle_CU_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ack_cmdp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frames_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">commands_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CMD_STAT_C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="o">-&gt;</span><span class="n">pa_next</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span><span class="o">--</span><span class="p">;</span>

		<span class="n">commands_done</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cmd_val</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(&quot;finished CU %s command (%d)\n&quot;,</span>
<span class="c">		       CUcmdnames[cmd_val], cmd_val);</span>
<span class="cp">#endif</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CmdTx</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="o">*</span><span class="n">tx_cmd_tbd</span><span class="p">;</span>

			<span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">tx_cmd_tbd</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">pa_tbd</span><span class="p">);</span>

			<span class="n">frames_out</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CMD_STAT_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span><span class="p">)</span>
					<span class="n">print_eth</span><span class="p">(</span><span class="n">pa_to_va</span><span class="p">(</span><span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">pa_data</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;transmission failure:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">tx_cmd_tbd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_cmd</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">CmdMulticastList</span>:
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CmdTDR</span>:
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: link ok.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Transceiver problem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Termination problem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Short circuit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Time %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_cmd</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_tail</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;=</span> <span class="mh">0x1fff</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">pa_to_va</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pa_next</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ack_cmdp</span> <span class="o">|=</span> <span class="n">CUC_START</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">pa_cmd</span> <span class="o">=</span> <span class="n">va_to_pa</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">i596_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="n">ack_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frames_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The 82596 examines the command, performs the required action,</span>
<span class="cm">	 * and then clears the SCB command word.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The status word indicates the status of the 82596.</span>
<span class="cm">	 * It is modified only by the 82596.</span>
<span class="cm">	 *</span>
<span class="cm">	 * [So, we must not clear it. I find often status 0xffff,</span>
<span class="cm">	 *  which is not one of the values allowed by the docs.]</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (i596_debug) {</span>
<span class="c">		printk(&quot;%s: i596 interrupt, &quot;, dev-&gt;name);</span>
<span class="c">		i596_out_status(status);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Impossible, but it happens - perhaps when we get</span>
<span class="cm">	   a receive interrupt but scb.pa_rfd is I596_NULL. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: i596_interrupt: got status 0xffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ack_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_ACK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_CX</span> <span class="o">|</span> <span class="n">STAT_CNA</span><span class="p">))</span>
		<span class="n">i596_handle_CU_completion</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_FR</span> <span class="o">|</span> <span class="n">STAT_RNR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Restart the receive unit when it got inactive somehow */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_RNR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ack_cmd</span> <span class="o">|=</span> <span class="n">RX_START</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_FR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frames_in</span> <span class="o">=</span> <span class="n">i596_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frames_in</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;receive frame reported, but no frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* acknowledge the interrupt */</span>
	<span class="cm">/*</span>
<span class="cm">	if ((lp-&gt;scb.pa_cmd != I596_NULL) &amp;&amp; netif_running(dev))</span>
<span class="cm">		ack_cmd |= CUC_START;</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i596 interrupt&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ack_cmd</span><span class="p">;</span>

	<span class="n">CLEAR_INT</span><span class="p">();</span>
	<span class="n">CA</span><span class="p">();</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i596_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Shutting down ethercard, status was %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">CUC_ABORT</span> <span class="o">|</span> <span class="n">RX_ABORT</span><span class="p">);</span>
	<span class="n">CA</span><span class="p">();</span>

	<span class="n">i596_cleanup_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">i596_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i596_close&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">remove_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*	Set or clear the multicast filter for this adaptor.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s: set multicast list %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i596_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span>
			      <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: set_multicast Memory squeeze.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdMulticastList</span><span class="p">;</span>
		<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">cmd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span> <span class="o">&amp;</span> <span class="n">LOG_SRCDST</span><span class="p">)</span>
			<span class="n">print_eth</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">cmd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">set_conf</span><span class="p">.</span><span class="n">pa_next</span> <span class="o">!=</span> <span class="n">I596_NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_PROMISC</span> <span class="o">|</span> <span class="n">IFF_ALLMULTI</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">set_conf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ard van Breemen &lt;ard@cstmel.nl.eu.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel Panther onboard i82596 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_lp486e</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">full_duplex</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">options</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span> <span class="o">=</span> <span class="n">IOADDR</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>module<em>param(max</em>interrupt<em>work, int, 0);
module</em>param(reverse<em>probe, int, 0);
module</em>param(rx_copybreak, int, 0);</p></td><td class="code"><div class="highlight"><pre><span class="n">module_param</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lp486e_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i596_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lp486e_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">LP486E_TOTAL_SIZE</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_lp486e</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">lp486e_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev_lp486e</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev_lp486e</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">LP486E_TOTAL_SIZE</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev_lp486e</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">lp486e_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">lp486e_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
