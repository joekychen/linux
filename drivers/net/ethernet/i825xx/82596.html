<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › 82596.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>82596.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* 82596.c: A generic 82596 ethernet driver for linux. */</span>
<span class="cm">/*</span>
<span class="cm">   Based on Apricot.c</span>
<span class="cm">   Written 1994 by Mark Evans.</span>
<span class="cm">   This driver is for the Apricot 82596 bus-master interface</span>

<span class="cm">   Modularised 12/94 Mark Evans</span>


<span class="cm">   Modified to support the 82596 ethernet chips on 680x0 VME boards.</span>
<span class="cm">   by Richard Hirst &lt;richard@sleepie.demon.co.uk&gt;</span>
<span class="cm">   Renamed to be 82596.c</span>

<span class="cm">   980825:  Changed to receive directly in to sk_buffs which are</span>
<span class="cm">   allocated at open() time.  Eliminates copy on incoming frames</span>
<span class="cm">   (small ones are still copied).  Shared data now held in a</span>
<span class="cm">   non-cached page, so we can run on 68060 in copyback mode.</span>

<span class="cm">   TBD:</span>
<span class="cm">   * look at deferring rx frames rather than discarding (as per tulip)</span>
<span class="cm">   * handle tx ring full as per tulip</span>
<span class="cm">   * performance test to tune rx_copybreak</span>

<span class="cm">   Most of my modifications relate to the braindead big-endian</span>
<span class="cm">   implementation by Intel.  When the i596 is operating in</span>
<span class="cm">   &#39;big-endian&#39; mode, it thinks a 32 bit value of 0x12345678</span>
<span class="cm">   should be stored as 0x56781234.  This is a real pain, when</span>
<span class="cm">   you have linked lists which are shared by the 680x0 and the</span>
<span class="cm">   i596.</span>

<span class="cm">   Driver skeleton</span>
<span class="cm">   Written 1993 by Donald Becker.</span>
<span class="cm">   Copyright 1993 United States Government as represented by the Director,</span>
<span class="cm">   National Security Agency. This software may only be used and distributed</span>
<span class="cm">   according to the terms of the GNU General Public License as modified by SRC,</span>
<span class="cm">   incorporated herein by reference.</span>

<span class="cm">   The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">   Scyld Computing Corporation, 410 Severn Ave., Suite 210, Annapolis MD 21403</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="s">&quot;82596.c $Revision: 1.5 $</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#define DRV_NAME	&quot;82596&quot;</span>

<span class="cm">/* DEBUG flags</span>
<span class="cm"> */</span>

<span class="cp">#define DEB_INIT	0x0001</span>
<span class="cp">#define DEB_PROBE	0x0002</span>
<span class="cp">#define DEB_SERIOUS	0x0004</span>
<span class="cp">#define DEB_ERRORS	0x0008</span>
<span class="cp">#define DEB_MULTI	0x0010</span>
<span class="cp">#define DEB_TDR		0x0020</span>
<span class="cp">#define DEB_OPEN	0x0040</span>
<span class="cp">#define DEB_RESET	0x0080</span>
<span class="cp">#define DEB_ADDCMD	0x0100</span>
<span class="cp">#define DEB_STATUS	0x0200</span>
<span class="cp">#define DEB_STARTTX	0x0400</span>
<span class="cp">#define DEB_RXADDR	0x0800</span>
<span class="cp">#define DEB_TXADDR	0x1000</span>
<span class="cp">#define DEB_RXFRAME	0x2000</span>
<span class="cp">#define DEB_INTS	0x4000</span>
<span class="cp">#define DEB_STRUCT	0x8000</span>
<span class="cp">#define DEB_ANY		0xffff</span>


<span class="cp">#define DEB(x,y)	if (i596_debug &amp; (x)) y</span>


<span class="cp">#if defined(CONFIG_MVME16x_NET) || defined(CONFIG_MVME16x_NET_MODULE)</span>
<span class="cp">#define ENABLE_MVME16x_NET</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_BVME6000_NET) || defined(CONFIG_BVME6000_NET_MODULE)</span>
<span class="cp">#define ENABLE_BVME6000_NET</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_APRICOT) || defined(CONFIG_APRICOT_MODULE)</span>
<span class="cp">#define ENABLE_APRICOT</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
<span class="cp">#include &lt;asm/mvme16xhw.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
<span class="cp">#include &lt;asm/bvme6000hw.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Define various macros for Channel Attention, word swapping etc., dependent</span>
<span class="cm"> * on architecture.  MVME and BVME are 680x0 based, otherwise it is Intel.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef __mc68000__</span>
<span class="cp">#define WSWAPrfd(x)  ((struct i596_rfd *) (((u32)(x)&lt;&lt;16) | ((((u32)(x)))&gt;&gt;16)))</span>
<span class="cp">#define WSWAPrbd(x)  ((struct i596_rbd *) (((u32)(x)&lt;&lt;16) | ((((u32)(x)))&gt;&gt;16)))</span>
<span class="cp">#define WSWAPiscp(x) ((struct i596_iscp *)(((u32)(x)&lt;&lt;16) | ((((u32)(x)))&gt;&gt;16)))</span>
<span class="cp">#define WSWAPscb(x)  ((struct i596_scb *) (((u32)(x)&lt;&lt;16) | ((((u32)(x)))&gt;&gt;16)))</span>
<span class="cp">#define WSWAPcmd(x)  ((struct i596_cmd *) (((u32)(x)&lt;&lt;16) | ((((u32)(x)))&gt;&gt;16)))</span>
<span class="cp">#define WSWAPtbd(x)  ((struct i596_tbd *) (((u32)(x)&lt;&lt;16) | ((((u32)(x)))&gt;&gt;16)))</span>
<span class="cp">#define WSWAPchar(x) ((char *)            (((u32)(x)&lt;&lt;16) | ((((u32)(x)))&gt;&gt;16)))</span>
<span class="cp">#define ISCP_BUSY	0x00010000</span>
<span class="cp">#define MACH_IS_APRICOT	0</span>
<span class="cp">#else</span>
<span class="cp">#define WSWAPrfd(x)     ((struct i596_rfd *)((long)x))</span>
<span class="cp">#define WSWAPrbd(x)     ((struct i596_rbd *)((long)x))</span>
<span class="cp">#define WSWAPiscp(x)    ((struct i596_iscp *)((long)x))</span>
<span class="cp">#define WSWAPscb(x)     ((struct i596_scb *)((long)x))</span>
<span class="cp">#define WSWAPcmd(x)     ((struct i596_cmd *)((long)x))</span>
<span class="cp">#define WSWAPtbd(x)     ((struct i596_tbd *)((long)x))</span>
<span class="cp">#define WSWAPchar(x)    ((char *)((long)x))</span>
<span class="cp">#define ISCP_BUSY	0x0001</span>
<span class="cp">#define MACH_IS_APRICOT	1</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * The MPU_PORT command allows direct access to the 82596. With PORT access</span>
<span class="cm"> * the following commands are available (p5-18). The 32-bit port command</span>
<span class="cm"> * must be word-swapped with the most significant word written first.</span>
<span class="cm"> * This only applies to VME boards.</span>
<span class="cm"> */</span>
<span class="cp">#define PORT_RESET		0x00	</span><span class="cm">/* reset 82596 */</span><span class="cp"></span>
<span class="cp">#define PORT_SELFTEST		0x01	</span><span class="cm">/* selftest */</span><span class="cp"></span>
<span class="cp">#define PORT_ALTSCP		0x02	</span><span class="cm">/* alternate SCB address */</span><span class="cp"></span>
<span class="cp">#define PORT_ALTDUMP		0x03	</span><span class="cm">/* Alternate DUMP address */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i596_debug</span> <span class="o">=</span> <span class="p">(</span><span class="n">DEB_SERIOUS</span><span class="o">|</span><span class="n">DEB_PROBE</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Richard Hirst&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;i82596 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">i596_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">i596_debug</span><span class="p">,</span> <span class="s">&quot;i82596 debug mask&quot;</span><span class="p">);</span>


<span class="cm">/* Copy frames shorter than rx_copybreak, otherwise pass on up in</span>
<span class="cm"> * a full sized sk_buff.  Value of 100 stolen from tulip.c (!alpha).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="cp">#define PKT_BUF_SZ	1536</span>
<span class="cp">#define MAX_MC_CNT	64</span>

<span class="cp">#define I596_TOTAL_SIZE 17</span>

<span class="cp">#define I596_NULL ((void *)0xffffffff)</span>

<span class="cp">#define CMD_EOL		0x8000	</span><span class="cm">/* The last command of the list, stop. */</span><span class="cp"></span>
<span class="cp">#define CMD_SUSP	0x4000	</span><span class="cm">/* Suspend after doing cmd. */</span><span class="cp"></span>
<span class="cp">#define CMD_INTR	0x2000	</span><span class="cm">/* Interrupt after doing cmd. */</span><span class="cp"></span>

<span class="cp">#define CMD_FLEX	0x0008	</span><span class="cm">/* Enable flexible memory model */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">commands</span> <span class="p">{</span>
	<span class="n">CmdNOp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CmdSASetup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CmdConfigure</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">CmdMulticastList</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CmdTx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">CmdTDR</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CmdDump</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">CmdDiagnose</span> <span class="o">=</span> <span class="mi">7</span>
<span class="p">};</span>

<span class="cp">#define STAT_C		0x8000	</span><span class="cm">/* Set to 0 after execution */</span><span class="cp"></span>
<span class="cp">#define STAT_B		0x4000	</span><span class="cm">/* Command being executed */</span><span class="cp"></span>
<span class="cp">#define STAT_OK		0x2000	</span><span class="cm">/* Command executed ok */</span><span class="cp"></span>
<span class="cp">#define STAT_A		0x1000	</span><span class="cm">/* Command aborted */</span><span class="cp"></span>

<span class="cp">#define	 CUC_START	0x0100</span>
<span class="cp">#define	 CUC_RESUME	0x0200</span>
<span class="cp">#define	 CUC_SUSPEND    0x0300</span>
<span class="cp">#define	 CUC_ABORT	0x0400</span>
<span class="cp">#define	 RX_START	0x0010</span>
<span class="cp">#define	 RX_RESUME	0x0020</span>
<span class="cp">#define	 RX_SUSPEND	0x0030</span>
<span class="cp">#define	 RX_ABORT	0x0040</span>

<span class="cp">#define TX_TIMEOUT	(HZ/20)</span>


<span class="k">struct</span> <span class="n">i596_reg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">porthi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">portlo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ca</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define EOF		0x8000</span>
<span class="cp">#define SIZE_MASK	0x3fff</span>

<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The command structure has two &#39;next&#39; pointers; v_next is the address of</span>
<span class="cm"> * the next command as seen by the CPU, b_next is the address of the next</span>
<span class="cm"> * command as seen by the 82596.  The b_next pointer, as used by the 82596</span>
<span class="cm"> * always references the status field of the next command, rather than the</span>
<span class="cm"> * v_next field, because the 82596 is unaware of v_next.  It may seem more</span>
<span class="cm"> * logical to put v_next at the end of the structure, but we cannot do that</span>
<span class="cm"> * because the 82596 expects other fields to be there, depending on command</span>
<span class="cm"> * type.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">v_next</span><span class="p">;</span>	<span class="cm">/* Address from CPUs viewpoint */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">command</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">b_next</span><span class="p">;</span>	<span class="cm">/* Address from i596 viewpoint */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>	<span class="cm">/* So we can free it after tx */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tdr_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mc_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">mc_cnt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">mc_addrs</span><span class="p">[</span><span class="n">MAX_MC_CNT</span><span class="o">*</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sa_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">eth_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cf_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">i596_config</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">b_next</span><span class="p">;</span>	<span class="cm">/* Address from i596 viewpoint */</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">v_next</span><span class="p">;</span>	<span class="cm">/* Address from CPUs viewpoint */</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">v_prev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">zero1</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">b_next</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b_data</span><span class="p">;</span>		<span class="cm">/* Address from i596 viewpoint */</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">zero2</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">v_next</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">b_addr</span><span class="p">;</span>		<span class="cm">/* This rbd addr from i596 view */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v_data</span><span class="p">;</span>		<span class="cm">/* Address from CPUs viewpoint */</span>
<span class="p">};</span>

<span class="cp">#define TX_RING_SIZE 64</span>
<span class="cp">#define RX_RING_SIZE 16</span>

<span class="k">struct</span> <span class="n">i596_scb</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">command</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resource_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">over_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rcvdt_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">short_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">t_on</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">t_off</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i596_iscp</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i596_scp</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sysbus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_iscp</span> <span class="o">*</span><span class="n">iscp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i596_private</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">i596_scp</span> <span class="n">scp</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">i596_iscp</span> <span class="n">iscp</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">i596_scb</span> <span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sa_cmd</span> <span class="n">sa_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cf_cmd</span> <span class="n">cf_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tdr_cmd</span> <span class="n">tdr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mc_cmd</span> <span class="n">mc_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_restart</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd_tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_backlog</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="n">rfds</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="n">rbds</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="n">tx_cmds</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="n">tbds</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">next_tx_cmd</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">init_setup</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mh">0x8E</span><span class="p">,</span>			<span class="cm">/* length, prefetch on */</span>
	<span class="mh">0xC8</span><span class="p">,</span>			<span class="cm">/* fifo to 8, monitor off */</span>
<span class="cp">#ifdef CONFIG_VME</span>
	<span class="mh">0xc0</span><span class="p">,</span>			<span class="cm">/* don&#39;t save bad frames */</span>
<span class="cp">#else</span>
	<span class="mh">0x80</span><span class="p">,</span>			<span class="cm">/* don&#39;t save bad frames */</span>
<span class="cp">#endif</span>
	<span class="mh">0x2E</span><span class="p">,</span>			<span class="cm">/* No source address insertion, 8 byte preamble */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* priority and backoff defaults */</span>
	<span class="mh">0x60</span><span class="p">,</span>			<span class="cm">/* interframe spacing */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* slot time LSB */</span>
	<span class="mh">0xf2</span><span class="p">,</span>			<span class="cm">/* slot time and retries */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* promiscuous mode */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* collision detect */</span>
	<span class="mh">0x40</span><span class="p">,</span>			<span class="cm">/* minimum frame length */</span>
	<span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x7f</span> <span class="cm">/*  *multi IA */</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i596_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">i596_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">i596_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">i596_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i596_add_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i596_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">print_eth</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ticks_limit</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_cmd_backlog</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">CA</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">i596_reg</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ca</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_APRICOT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_APRICOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">MPU_PORT</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i596_reg</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">i596_reg</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">porthi</span> <span class="o">=</span> <span class="p">((</span><span class="n">c</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">portlo</span> <span class="o">=</span> <span class="p">((</span><span class="n">c</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_istat</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delcnt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delcnt</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s, status %4.4x, cmd %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delcnt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delcnt</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s, status %4.4x, cmd %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delcnt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delcnt</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">i596_display_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lp and scp at %p, .sysbus = %08lx, .iscp = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">sysbus</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">iscp</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;iscp at %p, iscp.stat = %08lx, .scb = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">stat</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">scb</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scb at %p, scb.status = %04x, .command = %04x,&quot;</span>
		<span class="s">&quot; .cmd = %p, .rfd = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">rfd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;   errors: crc %lx, align %lx, resource %lx,&quot;</span>
               <span class="s">&quot; over %lx, rcvdt %lx, short %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">crc_err</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">align_err</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">resource_err</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">over_err</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">rcvdt_err</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">short_err</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">I596_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cmd at %p, .status = %04x, .command = %04x, .b_next = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">b_next</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rfd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rfd_head = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rfd</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;   %p .stat %04x, .cmd %04x, b_next %p, rbd %p,&quot;</span>
                        <span class="s">&quot; count %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rfd</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">b_next</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">rbd</span><span class="p">,</span>
			<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">rfd</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rfd</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span><span class="p">);</span>
	<span class="n">rbd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rbd_head = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rbd</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;   %p .count %04x, b_next %p, b_data %p, size %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rbd</span><span class="p">,</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">b_next</span><span class="p">,</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">rbd</span> <span class="o">=</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rbd</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#if defined(ENABLE_MVME16x_NET) || defined(ENABLE_BVME6000_NET)</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">i596_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcc2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xfff42000</span><span class="p">;</span>

		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1d</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BVME_ETHIRQ_REG</span><span class="p">;</span>

		<span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">i596_display_data</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rbd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rbd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">init_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>

	<span class="cm">/* First build the Receive Buffer Descriptor List */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rbd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rbd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">remove_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">rbd</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">WSWAPrbd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">rbd</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">b_addr</span> <span class="o">=</span> <span class="n">WSWAPrbd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">rbd</span><span class="p">));</span>
		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">WSWAPchar</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">PKT_BUF_SZ</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
		<span class="n">cache_clear</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span><span class="p">;</span>
	<span class="n">rbd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span> <span class="o">+</span> <span class="n">rx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span><span class="p">;</span>
	<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">WSWAPrbd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span><span class="p">));</span>

	<span class="cm">/* Now build the Receive Frame Descriptor List */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rfd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rfd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">rbd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">v_prev</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">WSWAPrfd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">rfd</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_FLEX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">rfd</span> <span class="o">=</span> <span class="n">WSWAPrfd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">));</span>
	<span class="n">rfd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">;</span>
	<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">rbd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span><span class="p">;</span>
	<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">v_prev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span> <span class="o">+</span> <span class="n">rx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rfd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span> <span class="o">+</span> <span class="n">rx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">;</span>
	<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">WSWAPrfd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">));</span>
	<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_EOL</span><span class="o">|</span><span class="n">CMD_FLEX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rebuild_rx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Ensure rx frame/buffer descriptors are tidy */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rbd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_FLEX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">[</span><span class="n">rx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_EOL</span><span class="o">|</span><span class="n">CMD_FLEX</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">rfd</span> <span class="o">=</span> <span class="n">WSWAPrfd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rbd</span> <span class="o">=</span> <span class="n">WSWAPrbd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbds</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_i596_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
<span class="cp">#if !defined(ENABLE_MVME16x_NET) &amp;&amp; !defined(ENABLE_BVME6000_NET) || defined(ENABLE_APRICOT)</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">MPU_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PORT_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>		<span class="cm">/* Wait 100us - seems to help */</span>

<span class="cp">#if defined(ENABLE_MVME16x_NET) || defined(ENABLE_BVME6000_NET)</span>
<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcc2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xfff42000</span><span class="p">;</span>

		<span class="cm">/* Disable all ints for now */</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>
		<span class="cm">/* Following disables snooping.  Snooping is not required</span>
<span class="cm">		 * as we make appropriate use of non-cached pages for</span>
<span class="cm">		 * shared data, and cache_push/cache_clear.</span>
<span class="cm">		 */</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BVME_ETHIRQ_REG</span><span class="p">;</span>

		<span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* change the scp address */</span>

	<span class="n">MPU_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PORT_ALTSCP</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">));</span>

<span class="cp">#elif defined(ENABLE_APRICOT)</span>

	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">scp</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">);</span>

		<span class="cm">/* change the scp address */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">scp</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">scp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_cmd</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">sysbus</span> <span class="o">=</span> <span class="mh">0x00000054</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">sysbus</span> <span class="o">=</span> <span class="mh">0x0000004c</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_APRICOT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_APRICOT</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">sysbus</span> <span class="o">=</span> <span class="mh">0x00440000</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">.</span><span class="n">iscp</span> <span class="o">=</span> <span class="n">WSWAPiscp</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">scb</span> <span class="o">=</span> <span class="n">WSWAPscb</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">iscp</span><span class="p">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">ISCP_BUSY</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">t_on</span>  <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">25</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">t_off</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">25</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: starting i82596.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

<span class="cp">#if defined(ENABLE_APRICOT)</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">CA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_istat</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;initialization timed out&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: i82596 initialization successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* Ensure rx frame/buffer descriptors are tidy */</span>
	<span class="n">rebuild_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcc2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xfff42000</span><span class="p">;</span>

		<span class="cm">/* Enable ints, etc. now */</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>	<span class="cm">/* Edge sensitive */</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BVME_ETHIRQ_REG</span><span class="p">;</span>

		<span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>


	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: queuing CmdConfigure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">,</span> <span class="n">init_setup</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdConfigure</span><span class="p">;</span>
	<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: queuing CmdSASetup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sa_cmd</span><span class="p">.</span><span class="n">eth_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">sa_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdSASetup</span><span class="p">;</span>
	<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sa_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: queuing CmdTDR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tdr_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdTDR</span><span class="p">;</span>
	<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tdr_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;timed out waiting to issue RX_START&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Issuing RX_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">RX_START</span><span class="p">;</span>
	<span class="n">CA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;RX_START not processed&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Receive unit started OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: Failed to initialise 82596</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">MPU_PORT</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PORT_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">i596_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rfd</span> <span class="o">*</span><span class="n">rfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_rbd</span> <span class="o">*</span><span class="n">rbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_RXFRAME</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i596_rx(), rfd_head %p, rbd_head %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span><span class="p">));</span>

	<span class="n">rfd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span><span class="p">;</span>		<span class="cm">/* Ref next frame to check */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_C</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Loop while complete frames */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">rbd</span> <span class="o">==</span> <span class="n">I596_NULL</span><span class="p">)</span>
			<span class="n">rbd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">rbd</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span><span class="o">-&gt;</span><span class="n">b_addr</span><span class="p">)</span>
			<span class="n">rbd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: rbd chain broken!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* XXX Now what? */</span>
			<span class="n">rbd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_RXFRAME</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  rfd %p, rfd.rbd %p, rfd.stat %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rfd</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">rbd</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rbd</span> <span class="o">!=</span> <span class="n">I596_NULL</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* a good frame */</span>
			<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">rx_in_place</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_RXADDR</span><span class="p">,</span><span class="n">print_eth</span><span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_data</span><span class="p">,</span> <span class="s">&quot;received&quot;</span><span class="p">));</span>
			<span class="n">frames</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Check if the packet is long enough to just accept</span>
<span class="cm">			 * without copying to a properly sized skbuff.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="n">rx_copybreak</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">newskb</span><span class="p">;</span>

				<span class="cm">/* Get fresh skbuff to replace filled one. */</span>
				<span class="n">newskb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">newskb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* drop pkt */</span>
					<span class="k">goto</span> <span class="n">memory_squeeze</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Pass up the skb already on the Rx ring. */</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">rx_in_place</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">newskb</span><span class="p">;</span>
				<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_data</span> <span class="o">=</span> <span class="n">newskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">WSWAPchar</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">newskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
<span class="cp">#ifdef __mc68000__</span>
				<span class="n">cache_clear</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">newskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="nl">memory_squeeze:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* XXX tulip.c can defer packets here!! */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i596_rx Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_in_place</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* 16 byte align the data fields */</span>
					<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">pkt_len</span><span class="p">),</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">pkt_len</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
				<span class="n">cache_clear</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
						<span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="o">+=</span><span class="n">pkt_len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_ERRORS</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Error, rfd.stat = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Clear the buffer descriptor count and EOF + F flags */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rbd</span> <span class="o">!=</span> <span class="n">I596_NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rbd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rbd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rbd_head</span> <span class="o">=</span> <span class="n">rbd</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Tidy the frame descriptor, marking it as end of list */</span>

		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">rbd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_EOL</span><span class="o">|</span><span class="n">CMD_FLEX</span><span class="p">;</span>
		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Remove end-of-list from old end descriptor */</span>

		<span class="n">rfd</span><span class="o">-&gt;</span><span class="n">v_prev</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_FLEX</span><span class="p">;</span>

		<span class="cm">/* Update record of next frame descriptor to process */</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">rfd</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">b_next</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span> <span class="o">=</span> <span class="n">rfd</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
		<span class="n">rfd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_head</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_RXFRAME</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;frames %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frames</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">i596_cleanup_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">!=</span> <span class="n">I596_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span><span class="o">--</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CmdTx</span>:
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
				<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Mark as free */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;i596_cleanup_cmd timed out&quot;</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i596_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_RESET</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i596_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;i596_reset timed out&quot;</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CUC_ABORT</span> <span class="o">|</span> <span class="n">RX_ABORT</span><span class="p">;</span>
	<span class="n">CA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* wait for shutdown */</span>
	<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;i596_reset 2 timed out&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">i596_cleanup_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">i596_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_i596_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i596_add_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_ADDCMD</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i596_add_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CMD_EOL</span> <span class="o">|</span> <span class="n">CMD_INTR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">!=</span> <span class="n">I596_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_tail</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_tail</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">WSWAPcmd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;i596_add_cmd timed out&quot;</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">WSWAPcmd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CUC_START</span><span class="p">;</span>
		<span class="n">CA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_tail</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span> <span class="o">&gt;</span> <span class="n">max_cmd_backlog</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tickssofar</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_cmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tickssofar</span> <span class="o">&lt;</span> <span class="n">ticks_limit</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: command unit timed out, status resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">i596_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i596_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_OPEN</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: i596_open() irq %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">i596_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;i82596&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: IRQ %d not free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="mh">0x56</span><span class="p">,</span> <span class="n">i596_error</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;i82596_error&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_irq_dev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">init_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_irq_56</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_i596_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_queue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_queue:</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">remove_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_irq_56:</span>
<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="mh">0x56</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">err_irq_dev:</span>
<span class="cp">#endif</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i596_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* Transmitter timeout, serious problems. */</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_ERRORS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: transmit timed out, status resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Try to restart the adaptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_restart</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_ERRORS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Resetting board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="cm">/* Shutdown and restart */</span>
		<span class="n">i596_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Issue a channel attention signal */</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_ERRORS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Kicking board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CUC_START</span> <span class="o">|</span> <span class="n">RX_START</span><span class="p">;</span>
		<span class="n">CA</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_restart</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">i596_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_tbd</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_STARTTX</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: i596_start_xmit(%x,%p) called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tx_cmd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_cmds</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx_cmd</span><span class="p">;</span>
	<span class="n">tbd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tbds</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: xmit ring full, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx_cmd</span> <span class="o">==</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tbd</span> <span class="o">=</span> <span class="n">WSWAPtbd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">tbd</span><span class="p">));</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>

		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CMD_FLEX</span> <span class="o">|</span> <span class="n">CmdTx</span><span class="p">;</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">EOF</span> <span class="o">|</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">WSWAPchar</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>

<span class="cp">#ifdef __mc68000__</span>
		<span class="n">cache_push</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">length</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_TXADDR</span><span class="p">,</span><span class="n">print_eth</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;tx-queued&quot;</span><span class="p">));</span>
		<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_eth</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">add</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i596 0x%p, %pM --&gt; %pM %02X%02X, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">add</span><span class="p">,</span> <span class="n">add</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">add</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">add</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">i596_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">i596_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">i596_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">i596_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">i596_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">i82596_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">eth_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">probed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="n">probed</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mvme16x_config</span> <span class="o">&amp;</span> <span class="n">MVME16x_CONFIG_NO_ETHERNET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Ethernet probe disabled - chip not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xfffc1f2c</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* YUCK! Get addr from NOVRAM */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">MVME_I596_BASE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">MVME16x_IRQ_I596</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rtc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BVME_RTC_BASE</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msr</span> <span class="o">=</span> <span class="n">rtc</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">rtc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>	<span class="cm">/* Stored in RTC RAM at offset 1 */</span>
		<span class="n">rtc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">BVME_I596_BASE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">BVME_IRQ_I596</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_APRICOT</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>

		<span class="cm">/* this is easy the ethernet interface can only be at 0x300 */</span>
		<span class="cm">/* first check nothing is already registered here */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">I596_TOTAL_SIZE</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;82596: IO address 0x%04x in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="cm">/* checksum is a multiple of 0x100, got this wrong first time</span>
<span class="cm">		   some machines have 0x100, some 0x200. The DOS driver doesn&#39;t</span>
<span class="cm">		   even bother with the checksum.</span>
<span class="cm">		   Some other boards trip the checksum.. but then appear as</span>
<span class="cm">		   ether address 0. Trap these - AC */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">checksum</span> <span class="o">%</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">eth_addr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x00\x00\x49</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_PROBE</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: 82596 at %#3lx,&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_PROBE</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_PROBE</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot; IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_PROBE</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">));</span>

	<span class="cm">/* The 82596-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i596_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: lp at 0x%08lx (%zd bytes), &quot;</span>
			<span class="s">&quot;lp-&gt;scb at 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i596_private</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i596_private</span><span class="p">));</span>

<span class="cp">#ifdef __mc68000__</span>
	<span class="n">cache_push</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)),</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">cache_clear</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)),</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">kernel_set_cachemode</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">),</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">IOMAP_NOCACHE_SER</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">rfd</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out2:</span>
<span class="cp">#ifdef __mc68000__</span>
	<span class="cm">/* XXX This assumes default cache mode to be IOMAP_FULL_CACHING,</span>
<span class="cm">	 * XXX which may be invalid (CONFIG_060_WRITETHROUGH)</span>
<span class="cm">	 */</span>
	<span class="n">kernel_set_cachemode</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">),</span> <span class="mi">4096</span><span class="p">,</span>
			<span class="n">IOMAP_FULL_CACHING</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">free_page</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">));</span>
<span class="nl">out1:</span>
<span class="cp">#ifdef ENABLE_APRICOT</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">I596_TOTAL_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">i596_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="n">ack_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BVME_LOCAL_IRQ_STAT</span> <span class="o">&amp;</span> <span class="n">BVME_ETHERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i596_error</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i596_interrupt(): irq %d for unknown device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;i596 interrupt, timeout&quot;</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INTS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: i596 interrupt, IRQ %d, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>

	<span class="n">ack_cmd</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i596_cmd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INTS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: i596 interrupt completed command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">))</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INTS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: i596 interrupt command unit inactive %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0700</span><span class="p">));</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">!=</span> <span class="n">I596_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>

			<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_STATUS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cmd_head-&gt;status = %04x, -&gt;command = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_backlog</span><span class="o">--</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CmdTx</span>:
			    <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_TXADDR</span><span class="p">,</span><span class="n">print_eth</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;tx-done&quot;</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">))</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

				<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Mark free */</span>
				<span class="k">break</span><span class="p">;</span>
			    <span class="p">}</span>
			<span class="k">case</span> <span class="n">CmdTDR</span>:
			    <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">tdr_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_TDR</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: link ok.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Transceiver problem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Termination problem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Short circuit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

					<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_TDR</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Time %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			    <span class="p">}</span>
			<span class="k">case</span> <span class="n">CmdConfigure</span>:
			<span class="k">case</span> <span class="n">CmdMulticastList</span>:
				<span class="cm">/* Zap command so set_multicast_list() knows it is free */</span>
				<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_next</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">b_next</span> <span class="o">=</span> <span class="n">I596_NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_cmd</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">I596_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_tail</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;=</span> <span class="mh">0x1fff</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">v_next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span> <span class="o">!=</span> <span class="n">I596_NULL</span><span class="p">))</span>
			<span class="n">ack_cmd</span> <span class="o">|=</span> <span class="n">CUC_START</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">WSWAPcmd</span><span class="p">(</span><span class="n">virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cmd_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">))</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INTS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: i596 interrupt received a frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">i596_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* Only RX_START if stopped - RGH 07-07-96 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_ERRORS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: i596 interrupt receive unit inactive, status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
				<span class="n">ack_cmd</span> <span class="o">|=</span> <span class="n">RX_START</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rebuild_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;i596 interrupt, timeout&quot;</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ack_cmd</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ack the interrupt */</span>

		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcc2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xfff42000</span><span class="p">;</span>

		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2a</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BVME_ETHIRQ_REG</span><span class="p">;</span>

		<span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_APRICOT</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">CA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INTS</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i596_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_INIT</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Shutting down ethercard, status was %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;close1 timed out&quot;</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CUC_ABORT</span> <span class="o">|</span> <span class="n">RX_ABORT</span><span class="p">;</span>
	<span class="n">CA</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wait_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;close2 timed out&quot;</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_STRUCT</span><span class="p">,</span><span class="n">i596_display_data</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">i596_cleanup_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">lp</span><span class="p">);</span>

<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_MVME16x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcc2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xfff42000</span><span class="p">;</span>

		<span class="cm">/* Disable all ints */</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">pcc2</span><span class="p">[</span><span class="mh">0x2b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* Set snooping bits now! */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ENABLE_BVME6000_NET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_BVME6000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BVME_ETHIRQ_REG</span><span class="p">;</span>

		<span class="o">*</span><span class="n">ethirq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef ENABLE_MVME16x_NET</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="mh">0x56</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">remove_rx_bufs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *    Set or clear the multicast filter for this adaptor.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i596_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_MULTI</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: set multicast list, %d entries, promisc %s, allmulti %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span>  <span class="o">?</span> <span class="s">&quot;ON&quot;</span> <span class="o">:</span> <span class="s">&quot;OFF&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">?</span> <span class="s">&quot;ON&quot;</span> <span class="o">:</span> <span class="s">&quot;OFF&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_cfg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="s">&quot;config change request timed out&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">i596_config</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdConfigure</span><span class="p">;</span>
		<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cf_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">MAX_MC_CNT</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">MAX_MC_CNT</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Only %d multicast addresses supported&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mc_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wait_cfg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mc_cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="s">&quot;multicast list change request timed out&quot;</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mc_cmd</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CmdMulticastList</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mc_cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mc_addrs</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i596_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">DEB</span><span class="p">(</span><span class="n">DEB_MULTI</span><span class="p">,</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Adding address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cp</span><span class="p">));</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i596_add_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_82596</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_APRICOT</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;Apricot IRQ number&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;i82596 debug mask&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i596_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">dev_82596</span> <span class="o">=</span> <span class="n">i82596_probe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_82596</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev_82596</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev_82596</span><span class="p">);</span>
<span class="cp">#ifdef __mc68000__</span>
	<span class="cm">/* XXX This assumes default cache mode to be IOMAP_FULL_CACHING,</span>
<span class="cm">	 * XXX which may be invalid (CONFIG_060_WRITETHROUGH)</span>
<span class="cm">	 */</span>

	<span class="n">kernel_set_cachemode</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev_82596</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">),</span> <span class="mi">4096</span><span class="p">,</span>
			<span class="n">IOMAP_FULL_CACHING</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">free_page</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">dev_82596</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">));</span>
<span class="cp">#ifdef ENABLE_APRICOT</span>
	<span class="cm">/* If we don&#39;t do this, we can&#39;t re-insmod it later. */</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev_82596</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">I596_TOTAL_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev_82596</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
