<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › znet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>znet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* znet.c: An Zenith Z-Note ethernet driver for linux. */</span>

<span class="cm">/*</span>
<span class="cm">	Written by Donald Becker.</span>

<span class="cm">	The author may be reached as becker@scyld.com.</span>
<span class="cm">	This driver is based on the Linux skeleton driver.  The copyright of the</span>
<span class="cm">	skeleton driver is held by the United States Government, as represented</span>
<span class="cm">	by DIRNSA, and it is released under the GPL.</span>

<span class="cm">	Thanks to Mike Hollick for alpha testing and suggestions.</span>

<span class="cm">  References:</span>
<span class="cm">	   The Crynwr packet driver.</span>

<span class="cm">	  &quot;82593 CSMA/CD Core LAN Controller&quot; Intel datasheet, 1992</span>
<span class="cm">	  Intel Microcommunications Databook, Vol. 1, 1990.</span>
<span class="cm">    As usual with Intel, the documentation is incomplete and inaccurate.</span>
<span class="cm">	I had to read the Crynwr packet driver to figure out how to actually</span>
<span class="cm">	use the i82593, and guess at what register bits matched the loosely</span>
<span class="cm">	related i82586.</span>

<span class="cm">					Theory of Operation</span>

<span class="cm">	The i82593 used in the Zenith Z-Note series operates using two(!) slave</span>
<span class="cm">	DMA	channels, one interrupt, and one 8-bit I/O port.</span>

<span class="cm">	While there	several ways to configure &#39;593 DMA system, I chose the one</span>
<span class="cm">	that seemed commensurate with the highest system performance in the face</span>
<span class="cm">	of moderate interrupt latency: Both DMA channels are configured as</span>
<span class="cm">	recirculating ring buffers, with one channel (#0) dedicated to Rx and</span>
<span class="cm">	the other channel (#1) to Tx and configuration.  (Note that this is</span>
<span class="cm">	different than the Crynwr driver, where the Tx DMA channel is initialized</span>
<span class="cm">	before each operation.  That approach simplifies operation and Tx error</span>
<span class="cm">	recovery, but requires additional I/O in normal operation and precludes</span>
<span class="cm">	transmit buffer	chaining.)</span>

<span class="cm">	Both rings are set to 8192 bytes using {TX,RX}_RING_SIZE.  This provides</span>
<span class="cm">	a reasonable ring size for Rx, while simplifying DMA buffer allocation --</span>
<span class="cm">	DMA buffers must not cross a 128K boundary.  (In truth the size selection</span>
<span class="cm">	was influenced by my lack of &#39;593 documentation.  I thus was constrained</span>
<span class="cm">	to use the Crynwr &#39;593 initialization table, which sets the Rx ring size</span>
<span class="cm">	to 8K.)</span>

<span class="cm">	Despite my usual low opinion about Intel-designed parts, I must admit</span>
<span class="cm">	that the bulk data handling of the i82593 is a good design for</span>
<span class="cm">	an integrated system, like a laptop, where using two slave DMA channels</span>
<span class="cm">	doesn&#39;t pose a problem.  I still take issue with using only a single I/O</span>
<span class="cm">	port.  In the same controlled environment there are essentially no</span>
<span class="cm">	limitations on I/O space, and using multiple locations would eliminate</span>
<span class="cm">	the	need for multiple operations when looking at status registers,</span>
<span class="cm">	setting the Rx ring boundary, or switching to promiscuous mode.</span>

<span class="cm">	I also question Zenith&#39;s selection of the &#39;593: one of the advertised</span>
<span class="cm">	advantages of earlier Intel parts was that if you figured out the magic</span>
<span class="cm">	initialization incantation you could use the same part on many different</span>
<span class="cm">	network types.  Zenith&#39;s use of the &quot;FriendlyNet&quot; (sic) connector rather</span>
<span class="cm">	than an	on-board transceiver leads me to believe that they were planning</span>
<span class="cm">	to take advantage of this.  But, uhmmm, the &#39;593 omits all but ethernet</span>
<span class="cm">	functionality from the serial subsystem.</span>
<span class="cm"> */</span>

<span class="cm">/* 10/2002</span>

<span class="cm">   o Resurected for Linux 2.5+ by Marc Zyngier &lt;maz@wild-wind.fr.eu.org&gt; :</span>

<span class="cm">   - Removed strange DMA snooping in znet_sent_packet, which lead to</span>
<span class="cm">     TX buffer corruption on my laptop.</span>
<span class="cm">   - Use init_etherdev stuff.</span>
<span class="cm">   - Use kmalloc-ed DMA buffers.</span>
<span class="cm">   - Use as few global variables as possible.</span>
<span class="cm">   - Use proper resources management.</span>
<span class="cm">   - Use wireless/i82593.h as much as possible (structure, constants)</span>
<span class="cm">   - Compiles as module or build-in.</span>
<span class="cm">   - Now survives unplugging/replugging cable.</span>

<span class="cm">   Some code was taken from wavelan_cs.</span>

<span class="cm">   Tested on a vintage Zenith Z-Note 433Lnp+. Probably broken on</span>
<span class="cm">   anything else. Testers (and detailed bug reports) are welcome :-).</span>

<span class="cm">   o TODO :</span>

<span class="cm">   - Properly handle multicast</span>
<span class="cm">   - Understand why some traffic patterns add a 1s latency...</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &lt;linux/i82593.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="s">&quot;znet.c:v1.02 9/23/94 becker@scyld.com</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#ifndef ZNET_DEBUG</span>
<span class="cp">#define ZNET_DEBUG 1</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">znet_debug</span> <span class="o">=</span> <span class="n">ZNET_DEBUG</span><span class="p">;</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">znet_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">znet_debug</span><span class="p">,</span> <span class="s">&quot;ZNet debug level&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* The DMA modes we need aren&#39;t in &lt;dma.h&gt;. */</span>
<span class="cp">#define DMA_RX_MODE		0x14	</span><span class="cm">/* Auto init, I/O to mem, ++, demand. */</span><span class="cp"></span>
<span class="cp">#define DMA_TX_MODE		0x18	</span><span class="cm">/* Auto init, Mem to I/O, ++, demand. */</span><span class="cp"></span>
<span class="cp">#define dma_page_eq(ptr1, ptr2) ((long)(ptr1)&gt;&gt;17 == (long)(ptr2)&gt;&gt;17)</span>
<span class="cp">#define RX_BUF_SIZE 8192</span>
<span class="cp">#define TX_BUF_SIZE 8192</span>
<span class="cp">#define DMA_BUF_SIZE (RX_BUF_SIZE + 16)	</span><span class="cm">/* 8k + 16 bytes for trailers */</span><span class="cp"></span>

<span class="cp">#define TX_TIMEOUT	(HZ/10)</span>

<span class="k">struct</span> <span class="n">znet_private</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rx_dma</span><span class="p">,</span> <span class="n">tx_dma</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">sia_base</span><span class="p">,</span> <span class="n">sia_size</span><span class="p">,</span> <span class="n">io_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i82593_conf_block</span> <span class="n">i593_init</span><span class="p">;</span>
	<span class="cm">/* The starting, current, and end pointers for the packet buffers. */</span>
	<span class="n">ushort</span> <span class="o">*</span><span class="n">rx_start</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_cur</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_end</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="o">*</span><span class="n">tx_start</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_cur</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_end</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">tx_buf_len</span><span class="p">;</span>			<span class="cm">/* Tx buffer length, in words. */</span>
<span class="p">};</span>

<span class="cm">/* Only one can be built-in;-&gt; */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">znet_dev</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">netidblk</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">magic</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* The magic number (string) &quot;NETIDBLK&quot; */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">netid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="cm">/* The physical station address */</span>
	<span class="kt">char</span> <span class="n">nettype</span><span class="p">,</span> <span class="n">globalopt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">vendor</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* The machine vendor and product name. */</span>
	<span class="kt">char</span> <span class="n">product</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">irq1</span><span class="p">,</span> <span class="n">irq2</span><span class="p">;</span>		<span class="cm">/* Interrupts, only one is currently used.	*/</span>
	<span class="kt">char</span> <span class="n">dma1</span><span class="p">,</span> <span class="n">dma2</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">dma_mem_misc</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* DMA buffer locations (unused in Linux). */</span>
	<span class="kt">short</span> <span class="n">iobase1</span><span class="p">,</span> <span class="n">iosize1</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">iobase2</span><span class="p">,</span> <span class="n">iosize2</span><span class="p">;</span>		<span class="cm">/* Second iobase unused. */</span>
	<span class="kt">char</span> <span class="n">driver_options</span><span class="p">;</span>			<span class="cm">/* Misc. bits */</span>
	<span class="kt">char</span> <span class="n">pad</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">znet_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">znet_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">znet_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">znet_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">znet_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hardware_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_stop_hit</span><span class="p">(</span><span class="kt">short</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_stop_offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">znet_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Request needed resources */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">znet_request_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">znet_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ZNet&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="s">&quot;ZNet rx&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="s">&quot;ZNet tx&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_rx_dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_size</span><span class="p">,</span> <span class="s">&quot;ZNet SIA&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_tx_dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">,</span> <span class="s">&quot;ZNet I/O&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_sia</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* Happy ! */</span>

 <span class="nl">free_sia:</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_size</span><span class="p">);</span>
 <span class="nl">free_tx_dma:</span>
	<span class="n">free_dma</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
 <span class="nl">free_rx_dma:</span>
	<span class="n">free_dma</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>
 <span class="nl">free_irq:</span>
	<span class="n">free_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
 <span class="nl">failed:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">znet_release_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">release_region</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_size</span><span class="p">);</span>
	<span class="n">release_region</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">io_size</span><span class="p">);</span>
	<span class="n">free_dma</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="n">free_dma</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>
	<span class="n">free_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Keep the magical SIA stuff in a single function... */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">znet_transceiver_power</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">v</span><span class="p">;</span>

	<span class="cm">/* Turn on/off the 82501 SIA, using zenith-specific magic. */</span>
	<span class="cm">/* Select LAN control register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x84</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x84</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Turn on/off LAN power (bit 2). */</span>
<span class="p">}</span>

<span class="cm">/* Init the i82593, with current promisc/mcast configuration.</span>
<span class="cm">   Also used from hardware_init. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">znet_set_multicast_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i82593_conf_block</span> <span class="o">*</span><span class="n">cfblk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">i593_init</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cfblk</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i82593_conf_block</span><span class="p">));</span>

        <span class="cm">/* The configuration block.  What an undocumented nightmare.</span>
<span class="cm">	   The first set of values are those suggested (without explanation)</span>
<span class="cm">	   for ethernet in the Intel 82586 databook.  The rest appear to be</span>
<span class="cm">	   completely undocumented, except for cryptic notes in the Crynwr</span>
<span class="cm">	   packet driver.  This driver uses the Crynwr values verbatim. */</span>

	<span class="cm">/* maz : Rewritten to take advantage of the wanvelan includes.</span>
<span class="cm">	   At least we have names, not just blind values */</span>

	<span class="cm">/* Byte 0 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">fifo_limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* = 16 B rx and 80 B tx fifo thresholds */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">forgnesi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 0=82C501, 1=AMD7992B compatibility */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">fifo_32</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">d6mod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  	<span class="cm">/* Run in i82593 advanced mode */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">throttle_enb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Byte 1 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* Continuous w/interrupts, 128-clock DMA. */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">cntrxint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* enable continuous mode receive interrupts */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">contin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* enable continuous mode */</span>

	<span class="cm">/* Byte 2 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">acloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Disable source addr insertion by i82593 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">preamb_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 8 bytes preamble */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">loopback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Loopback off */</span>

	<span class="cm">/* Byte 3 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">lin_prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Default priorities &amp; backoff methods. */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">tbofstop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">exp_prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">bof_met</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Byte 4 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">ifrm_spc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* 96 bit times interframe spacing */</span>

	<span class="cm">/* Byte 5 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">slottim_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 512 bit times slot time (low) */</span>

	<span class="cm">/* Byte 6 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">slottim_hi</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 512 bit times slot time (high) */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">max_retr</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>	<span class="cm">/* 15 collisions retries */</span>

	<span class="cm">/* Byte 7 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">prmisc</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Promiscuous mode */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">bc_dis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Enable broadcast reception */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">crs_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t transmit without carrier sense */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">nocrc_ins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* i82593 generates CRC */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">crc_1632</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 32-bit Autodin-II CRC */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">crs_cdt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* CD not to be interpreted as CS */</span>

	<span class="cm">/* Byte 8 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">cs_filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  	<span class="cm">/* CS is recognized immediately */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">crs_src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* External carrier sense */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">cd_filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  	<span class="cm">/* CD is recognized immediately */</span>

	<span class="cm">/* Byte 9 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">min_fr_len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Minimum frame length */</span>

	<span class="cm">/* Byte A */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">lng_typ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Type/length checks OFF */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">lng_fld</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 	<span class="cm">/* Disable 802.3 length field check */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">rxcrc_xf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Don&#39;t transfer CRC to memory */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">artx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Disable automatic retransmission */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">sarec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Disable source addr trig of CD */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">tx_jabber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Disable jabber jam sequence */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">hash_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 	<span class="cm">/* Use bits 0-5 in mc address hash */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">lbpkpol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 	<span class="cm">/* Loopback pin active high */</span>

	<span class="cm">/* Byte B */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">fdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Disable full duplex operation */</span>

	<span class="cm">/* Byte C */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">dummy_6</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span> 	<span class="cm">/* all ones, Default multicast addresses &amp; backoff. */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">mult_ia</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No multiple individual addresses */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">dis_bof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Disable the backoff algorithm ?! */</span>

	<span class="cm">/* Byte D */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">dummy_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 	<span class="cm">/* set to 1 */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">tx_ifs_retrig</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Hmm... Disabled */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">mc_all</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">));</span> <span class="cm">/* multicast all mode */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">rcv_mon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Monitor mode disabled */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">frag_acpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Do not accept fragments */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">tstrttrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No start transmission threshold */</span>

	<span class="cm">/* Byte E */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">fretx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* FIFO automatic retransmission */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">runt_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* drop &quot;runt&quot; packets */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">hw_sw_pin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ?? */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">big_endn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Big Endian ? no... */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">syncrqs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Synchronous DRQ deassertion... */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">sttlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  	<span class="cm">/* 6 byte status registers */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">rx_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  	<span class="cm">/* Signal EOP on packet reception */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">tx_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  	<span class="cm">/* Signal EOP on packet transmission */</span>

	<span class="cm">/* Byte F */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">rbuf_size</span> <span class="o">=</span> <span class="n">RX_BUF_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span> <span class="cm">/* Set receive buffer size */</span>
	<span class="n">cfblk</span><span class="o">-&gt;</span><span class="n">rcvstop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 	<span class="cm">/* Enable Receive Stop Register */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cfblk</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">cfblk</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%02X &quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="o">++</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i82593_conf_block</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="p">,</span> <span class="n">cfblk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i82593_conf_block</span><span class="p">));</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i82593_conf_block</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">OP0_CONFIGURE</span> <span class="o">|</span> <span class="n">CR0_CHNL</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* XXX FIXME maz : Add multicast addresses here, so having a</span>
<span class="cm">	 * multicast address configured isn&#39;t equal to IFF_ALLMULTI */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">znet_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">znet_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">znet_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">znet_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">znet_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">znet_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The Z-Note probe is pretty easy.  The NETIDBLK exists in the safe-to-probe</span>
<span class="cm">   BIOS area.  We just scan for the signature, and pull the vital parameters</span>
<span class="cm">   out of the structure. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">znet_probe</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netidblk</span> <span class="o">*</span><span class="n">netinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* This code scans the region 0xf0000 to 0xfffff for a &quot;NETIDBLK&quot;. */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="mh">0xf0000</span><span class="p">);</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="mh">0x100000</span><span class="p">);</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span>  <span class="o">&amp;&amp;</span>  <span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;NETIDBLK&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="mh">0x100000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;No Z-Note ethernet adaptor found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">znet_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netidblk</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">iobase1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">irq1</span><span class="p">;</span>

	<span class="cm">/* The station address is in the &quot;netidblk&quot; at 0x0f0000. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">netid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: ZNET at %#3lx, %pM&quot;</span>
	       <span class="s">&quot;, using IRQ %d DMA %d and %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">dma1</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: vendor &#39;%16.16s&#39; IRQ1 %d IRQ2 %d DMA1 %d DMA2 %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">irq1</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">irq2</span><span class="p">,</span>
		       <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">dma1</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: iobase1 %#x size %d iobase2 %#x size %d net type %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">iobase1</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">iosize1</span><span class="p">,</span>
		       <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">iobase2</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">iosize2</span><span class="p">,</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">nettype</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span> <span class="o">=</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">dma1</span><span class="p">;</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span> <span class="o">=</span> <span class="n">netinfo</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_base</span> <span class="o">=</span> <span class="mh">0xe6</span><span class="p">;</span>	<span class="cm">/* Magic address for the 82501 SIA */</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">sia_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* maz: Despite the &#39;593 being advertised above as using a</span>
<span class="cm">	 * single 8bits I/O port, this driver does many 16bits</span>
<span class="cm">	 * access. So set io_size accordingly */</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">io_size</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">DMA_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">free_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">DMA_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">free_rx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_page_eq</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">RX_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">dma_page_eq</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">TX_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;tx/rx crossing DMA frontiers, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="n">RX_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_buf_len</span> <span class="o">=</span> <span class="n">TX_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">+</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_buf_len</span><span class="p">;</span>

	<span class="cm">/* The ZNET-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">znet_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_tx</span><span class="p">;</span>
	<span class="n">znet_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">free_tx:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">);</span>
 <span class="nl">free_rx:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">);</span>
 <span class="nl">free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">znet_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: znet_open() called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* These should never fail.  You can&#39;t add devices to a sealed box! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">znet_request_resources</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Not opened -- resource busy?!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">znet_transceiver_power</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* According to the Crynwr driver we should wait 50 msec. for the</span>
<span class="cm">	   LAN clock to stabilize.  My experiments indicates that the &#39;593 can</span>
<span class="cm">	   be initialized immediately.  The delay is probably needed for the</span>
<span class="cm">	   DC-to-DC converter to come up to full voltage, and for the oscillator</span>
<span class="cm">	   to be spot-on at 20Mhz before transmitting.</span>
<span class="cm">	   Until this proves to be a problem we rely on the higher layers for the</span>
<span class="cm">	   delay and save allocating a timer entry. */</span>

	<span class="cm">/* maz : Well, I&#39;m getting every time the following message</span>
<span class="cm">	 * without the delay on a 486@33. This machine is much too</span>
<span class="cm">	 * fast... :-) So maybe the Crynwr driver wasn&#39;t wrong after</span>
<span class="cm">	 * all, even if the message is completly harmless on my</span>
<span class="cm">	 * setup. */</span>
	<span class="n">mdelay</span> <span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* This follows the packet driver&#39;s lead, and checks for success. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Problem turning on the transceiver power.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hardware_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_start_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">znet_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">event</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">,</span> <span class="n">rx_offset</span><span class="p">,</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">outb</span> <span class="p">(</span><span class="n">CR0_STATUS_0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">inb</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">CR0_STATUS_1</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">tx_status</span> <span class="o">=</span> <span class="n">inw</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">CR0_STATUS_2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">rx_offset</span> <span class="o">=</span> <span class="n">inw</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">CR0_STATUS_3</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">inb</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timed out, status %02x %04x %04x %02x,&quot;</span>
	 <span class="s">&quot; resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">,</span> <span class="n">rx_offset</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">==</span> <span class="n">TX_LOST_CRS</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Tx carrier error, check transceiver cable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">OP0_RESET</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">hardware_init</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">znet_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ZNet_send_packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check that the part hasn&#39;t reset itself, probably from suspend. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CR0_STATUS_0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0010</span> <span class="o">&amp;&amp;</span>
	    <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0000</span> <span class="o">&amp;&amp;</span>
	    <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s : waking up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">hardware_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">znet_transceiver_power</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ushort</span> <span class="o">*</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ushort</span> <span class="n">rnd_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="o">+=</span><span class="n">length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">&gt;=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">)</span>
		  <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">;</span>
		<span class="o">*</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="o">++</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">+</span> <span class="n">rnd_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">semi_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">-</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Cvrt to byte cnt. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">semi_cnt</span><span class="p">);</span>
			<span class="n">rnd_len</span> <span class="o">-=</span> <span class="n">semi_cnt</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">semi_cnt</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">semi_cnt</span><span class="p">);</span>
			<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">+</span> <span class="n">rnd_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">+=</span> <span class="n">rnd_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">{</span>
			<span class="o">*</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">OP0_TRANSMIT</span> <span class="o">|</span> <span class="n">CR0_CHNL</span><span class="p">;</span>
			<span class="cm">/* Is this always safe to do? */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">OP0_TRANSMIT</span> <span class="o">|</span> <span class="n">CR0_CHNL</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">netif_start_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Transmitter queued, length %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The ZNET interrupt handler. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">znet_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boguscnt</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">CR0_STATUS_0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ushort</span> <span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ushort</span> <span class="n">result</span><span class="p">,</span> <span class="n">rx_ptr</span><span class="p">,</span> <span class="n">running</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CR0_STATUS_1</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CR0_STATUS_2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">rx_ptr</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CR0_STATUS_3</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">running</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: interrupt, status %02x, %04x %04x %02x serial %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">rx_ptr</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">boguscnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SR0_INTERRUPT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SR0_EVENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SR0_TRANSMIT_DONE</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SR0_EVENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SR0_RETRANSMIT_DONE</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SR0_EVENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SR0_TRANSMIT_NO_CRC_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tx_status</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CR0_STATUS_1</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">tx_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="cm">/* It&#39;s undocumented, but tx_status seems to match the i82586. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">TX_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">TX_NCOL_MASK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_LOST_CTS</span> <span class="o">|</span> <span class="n">TX_LOST_CRS</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">TX_UND_RUN</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">TX_HRT_BEAT</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">TX_MAX_COL</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* ...and the catch-all. */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">|</span> <span class="p">(</span><span class="n">TX_LOST_CRS</span> <span class="o">|</span> <span class="n">TX_LOST_CTS</span> <span class="o">|</span> <span class="n">TX_UND_RUN</span> <span class="o">|</span> <span class="n">TX_HRT_BEAT</span> <span class="o">|</span> <span class="n">TX_MAX_COL</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">TX_LOST_CRS</span> <span class="o">|</span> <span class="n">TX_LOST_CTS</span> <span class="o">|</span> <span class="n">TX_UND_RUN</span> <span class="o">|</span> <span class="n">TX_HRT_BEAT</span> <span class="o">|</span> <span class="n">TX_MAX_COL</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="cm">/* Transceiver may be stuck if cable</span>
<span class="cm">				 * was removed while emitting a</span>
<span class="cm">				 * packet. Flip it off, then on to</span>
<span class="cm">				 * reset it. This is very empirical,</span>
<span class="cm">				 * but it seems to work. */</span>

				<span class="n">znet_transceiver_power</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">znet_transceiver_power</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SR0_RECEPTION</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SR0_EVENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SR0_STOP_REG_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">znet_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Clear the interrupts we&#39;ve handled. */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CR0_INT_ACK</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">boguscnt</span><span class="o">--</span><span class="p">);</span>

	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">znet_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">next_frame_end_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 		<span class="cm">/* Offset of next frame start. */</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">cur_frame_end</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">cur_frame_end_offset</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">CR0_STATUS_2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">cur_frame_end_offset</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_frame_end_offset</span> <span class="o">==</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span> <span class="o">-</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Interrupted, but nothing to receive, offset %03x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cur_frame_end_offset</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use same method as the Crynwr driver: construct a forward list in</span>
<span class="cm">	   the same area of the backwards links we now have.  This allows us to</span>
<span class="cm">	   pass packets to the upper layers in the order they were received --</span>
<span class="cm">	   important for fast-path sequential operations. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="n">cur_frame_end_offset</span> <span class="o">!=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span> <span class="o">&amp;&amp;</span>
	       <span class="o">++</span><span class="n">boguscount</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hi_cnt</span><span class="p">,</span> <span class="n">lo_cnt</span><span class="p">,</span> <span class="n">hi_status</span><span class="p">,</span> <span class="n">lo_status</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_frame_end_offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Oh no, we have a special case: the frame trailer wraps around</span>
<span class="cm">			   the end of the ring buffer.  We&#39;ve saved space at the end of</span>
<span class="cm">			   the ring buffer for just this problem. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">cur_frame_end_offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">RX_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cur_frame_end</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="n">cur_frame_end_offset</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">lo_status</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur_frame_end</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hi_status</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur_frame_end</span><span class="o">++</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="p">((</span><span class="n">hi_status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lo_status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">lo_cnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur_frame_end</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hi_cnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur_frame_end</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">hi_cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lo_cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Constructing trailer at location %03x, %04x %04x %04x %04x&quot;</span>
				 <span class="s">&quot; count %#x status %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cur_frame_end_offset</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">lo_status</span><span class="p">,</span> <span class="n">hi_status</span><span class="p">,</span> <span class="n">lo_cnt</span><span class="p">,</span> <span class="n">hi_cnt</span><span class="p">,</span>
				 <span class="n">count</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">cur_frame_end</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">cur_frame_end</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_frame_end_offset</span><span class="p">;</span>
		<span class="n">cur_frame_end</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">next_frame_end_offset</span> <span class="o">=</span> <span class="n">cur_frame_end_offset</span><span class="p">;</span>
		<span class="n">cur_frame_end_offset</span> <span class="o">-=</span> <span class="p">((</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_frame_end_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		  <span class="n">cur_frame_end_offset</span> <span class="o">+=</span> <span class="n">RX_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now step  forward through the list. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ushort</span> <span class="o">*</span><span class="n">this_rfp_ptr</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="n">next_frame_end_offset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">this_rfp_ptr</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">this_rfp_ptr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Looking at trailer ending at %04x status %04x length %03x&quot;</span>
				 <span class="s">&quot; next %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">next_frame_end_offset</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">,</span>
				 <span class="n">this_rfp_ptr</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Once again we must assume that the i82586 docs apply. */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_RCV_OK</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* There was an error. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_CRC_ERR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_ALG_ERR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			if (status &amp; 0x0200) dev-&gt;stats.rx_over_errors++; /* Wrong. */</span>
<span class="c">			if (status &amp; 0x0100) dev-&gt;stats.rx_fifo_errors++;</span>
<span class="cp">#else</span>
			<span class="cm">/* maz : Wild guess... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_OVRRUN</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_SRT_FRM</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Malloc up new buffer. */</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span><span class="p">)</span>
				  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span><span class="p">[(</span><span class="n">pkt_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">semi_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">-</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">semi_cnt</span><span class="p">),</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span><span class="p">,</span> <span class="n">semi_cnt</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">pkt_len</span><span class="o">-</span><span class="n">semi_cnt</span><span class="p">),</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">,</span>
					   <span class="n">pkt_len</span> <span class="o">-</span> <span class="n">semi_cnt</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">pkt_len</span><span class="p">),</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Packet data is %08x %08x %08x %08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						   <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="p">}</span>
		  <span class="p">}</span>
		  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
		  <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span> <span class="o">=</span> <span class="n">this_rfp_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span> <span class="o">&gt;=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">)</span>
			<span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span> <span class="o">-=</span> <span class="n">RX_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">update_stop_hit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span> <span class="o">-</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">next_frame_end_offset</span> <span class="o">=</span> <span class="n">this_rfp_ptr</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_frame_end_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* Read all the frames? */</span>
			<span class="k">break</span><span class="p">;</span>			<span class="cm">/* Done for now */</span>
		<span class="n">this_rfp_ptr</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="n">next_frame_end_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscount</span><span class="p">);</span>

	<span class="cm">/* If any worth-while packets have been received, dev_rint()</span>
<span class="cm">	   has done a mark_bh(INET_BH) for us and will work on them</span>
<span class="cm">	   when we get to the bottom-half routine. */</span>
<span class="p">}</span>

<span class="cm">/* The inverse routine to znet_open(). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">znet_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">OP0_RESET</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>			<span class="cm">/* CMD0_RESET */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Shutting down ethercard.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* Turn off transceiver power. */</span>
	<span class="n">znet_transceiver_power</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">znet_release_resources</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">inb</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">dma_port</span> <span class="o">=</span> <span class="p">((</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">IO_DMA2_BASE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dma_port</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">residue</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dma_port</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">residue</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Stat:%02x Addr: %04x cnt:%3x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">stat</span><span class="p">,</span> <span class="n">addr</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">residue</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize the hardware.  We have to do this when the board is open()ed</span>
<span class="cm">   or when we come out of suspend mode. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hardware_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_cur</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">;</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">=</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">;</span>

	<span class="cm">/* Reset the chip, and start it up. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">OP0_RESET</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span> 		<span class="cm">/* reset by an interrupting task. */</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">DMA_RX_MODE</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">RX_BUF_SIZE</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">);</span>
	<span class="cm">/* Now set up the Tx channel. */</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">DMA_TX_MODE</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_buf_len</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
	  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Initializing the i82593, rx buf %p tx buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">,</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">);</span>
	<span class="cm">/* Do an empty configure command, just like the Crynwr driver.  This</span>
<span class="cm">	   resets to chip to its default values. */</span>
	<span class="o">*</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">show_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">OP0_CONFIGURE</span> <span class="o">|</span> <span class="n">CR0_CHNL</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">znet_set_multicast_list</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="o">++</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_cur</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">show_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">OP0_IA_SETUP</span> <span class="o">|</span> <span class="n">CR0_CHNL</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">show_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">update_stop_hit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;enabling Rx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">OP0_RCV_ENABLE</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">netif_start_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_stop_hit</span><span class="p">(</span><span class="kt">short</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_stop_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">OP0_SWIT_TO_PORT_1</span> <span class="o">|</span> <span class="n">CR0_CHNL</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">znet_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
	  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Updating stop hit with value %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">rx_stop_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">CR1_STOP_REG_UPDATE</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">rx_stop_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">CR1_STOP_REG_UPDATE</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">OP1_SWIT_TO_PORT_0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">znet_cleanup</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">znet_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">znet_private</span> <span class="o">*</span><span class="n">znet</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">znet_dev</span><span class="p">);</span>

		<span class="n">unregister_netdev</span> <span class="p">(</span><span class="n">znet_dev</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">znet</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">);</span>
		<span class="n">free_netdev</span> <span class="p">(</span><span class="n">znet_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span> <span class="p">(</span><span class="n">znet_probe</span><span class="p">);</span>
<span class="n">module_exit</span> <span class="p">(</span><span class="n">znet_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
