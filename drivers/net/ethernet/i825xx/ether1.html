<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › ether1.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ether1.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/acorn/net/ether1.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1996-2000 Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Acorn ether1 driver (82586 chip) for Acorn machines</span>
<span class="cm"> *</span>
<span class="cm"> * We basically keep two queues in the cards memory - one for transmit</span>
<span class="cm"> * and one for receive.  Each has a head and a tail.  The head is where</span>
<span class="cm"> * we/the chip adds packets to be transmitted/received, and the tail</span>
<span class="cm"> * is where the transmitter has got to/where the receiver will stop.</span>
<span class="cm"> * Both of these queues are circular, and since the chip is running</span>
<span class="cm"> * all the time, we have to be careful when we modify the pointers etc</span>
<span class="cm"> * so that the buffer memory contents is valid all the time.</span>
<span class="cm"> *</span>
<span class="cm"> * Change log:</span>
<span class="cm"> * 1.00	RMK			Released</span>
<span class="cm"> * 1.01	RMK	19/03/1996	Transfers the last odd byte onto/off of the card now.</span>
<span class="cm"> * 1.02	RMK	25/05/1997	Added code to restart RU if it goes not ready</span>
<span class="cm"> * 1.03	RMK	14/09/1997	Cleaned up the handling of a reset during the TX interrupt.</span>
<span class="cm"> *				Should prevent lockup.</span>
<span class="cm"> * 1.04 RMK	17/09/1997	Added more info when initialsation of chip goes wrong.</span>
<span class="cm"> *				TDR now only reports failure when chip reports non-zero</span>
<span class="cm"> *				TDR time-distance.</span>
<span class="cm"> * 1.05	RMK	31/12/1997	Removed calls to dev_tint for 2.1</span>
<span class="cm"> * 1.06	RMK	10/02/2000	Updated for 2.3.43</span>
<span class="cm"> * 1.07	RMK	13/05/2000	Updated for 2.3.99-pre8</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/ecard.h&gt;</span>

<span class="cp">#define __ETHER1_C</span>
<span class="cp">#include &quot;ether1.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">net_debug</span> <span class="o">=</span> <span class="n">NET_DEBUG</span><span class="p">;</span>

<span class="cp">#define BUFFER_SIZE	0x10000</span>
<span class="cp">#define TX_AREA_START	0x00100</span>
<span class="cp">#define TX_AREA_END	0x05000</span>
<span class="cp">#define RX_AREA_START	0x05000</span>
<span class="cp">#define RX_AREA_END	0x0fc00</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ether1_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ether1_sendpacket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ether1_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ether1_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ether1_setmulticastlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ether1_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;ether1 ethernet driver (c) 2000 Russell King v1.07</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#define BUS_16 16</span>
<span class="cp">#define BUS_8  8</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cp">#define DISABLEIRQS 1</span>
<span class="cp">#define NORMALIRQS  0</span>

<span class="cp">#define ether1_readw(dev, addr, type, offset, svflgs) ether1_inw_p (dev, addr + (int)(&amp;((type *)0)-&gt;offset), svflgs)</span>
<span class="cp">#define ether1_writew(dev, val, addr, type, offset, svflgs) ether1_outw_p (dev, val, addr + (int)(&amp;((type *)0)-&gt;offset), svflgs)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">ether1_inw_p</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">svflgs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svflgs</span><span class="p">)</span>
		<span class="n">local_irq_save</span> <span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">REG_PAGE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ETHER1_RAM</span> <span class="o">+</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svflgs</span><span class="p">)</span>
		<span class="n">local_irq_restore</span> <span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ether1_outw_p</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">svflgs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svflgs</span><span class="p">)</span>
		<span class="n">local_irq_save</span> <span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">REG_PAGE</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ETHER1_RAM</span> <span class="o">+</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svflgs</span><span class="p">)</span>
		<span class="n">local_irq_restore</span> <span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some inline assembler to allow fast transfers on to/off of the card.</span>
<span class="cm"> * Since this driver depends on some features presented by the ARM</span>
<span class="cm"> * specific architecture, and that you can&#39;t configure this driver</span>
<span class="cm"> * without specifiing ARM mode, this is not a problem.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is essentially an optimised memcpy from the card&#39;s</span>
<span class="cm"> * onboard RAM to kernel memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ether1_writebuffer</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="mi">4095</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">ETHER1_RAM</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>

		<span class="n">writeb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">REG_PAGE</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">thislen</span><span class="p">;</span>

		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
	<span class="s">&quot;subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">1:	ldr	%0, [%1], #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsl #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	orr	%0, %0, %0, lsr #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	str	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldr	%0, [%1], #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsl #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	orr	%0, %0, %0, lsr #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	str	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldr	%0, [%1], #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsl #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	orr	%0, %0, %0, lsr #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	str	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldr	%0, [%1], #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsl #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	orr	%0, %0, %0, lsr #16</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	str	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bpl	1b</span><span class="se">\n</span><span class="s">\</span>
<span class="s">2:	adds	%3, %3, #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldreqb	%0, [%1]</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	streqb	%0, [%2]&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">used</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;r&quot;</span>  <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">thislen</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">data</span><span class="p">));</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">ETHER1_RAM</span><span class="p">;</span>

		<span class="n">thislen</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thislen</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
			<span class="n">thislen</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">page</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">thislen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ether1_readbuffer</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="mi">4095</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">ETHER1_RAM</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>

		<span class="n">writeb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">REG_PAGE</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">thislen</span><span class="p">;</span>

		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
	<span class="s">&quot;subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">1:	ldr	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsr #8</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldr	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsr #8</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldr	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsr #8</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bmi	2f</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldr	%0, [%2], #4</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	mov	%0, %0, lsr #8</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	strb	%0, [%1], #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	subs	%3, %3, #2</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	bpl	1b</span><span class="se">\n</span><span class="s">\</span>
<span class="s">2:	adds	%3, %3, #1</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	ldreqb	%0, [%2]</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	streqb	%0, [%1]&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">used</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;r&quot;</span>  <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">thislen</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">data</span><span class="p">));</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">ETHER1_RAM</span><span class="p">;</span>

		<span class="n">thislen</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thislen</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
			<span class="n">thislen</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">page</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">thislen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ether1_ramtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_errors</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">memset</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">byte</span> <span class="o">^</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">ether1_readbuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">byte</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_errors</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bad</span> <span class="o">!=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bad</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: RAM failed with (%02X instead of %02X) at 0x%04X&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">byte</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="n">max_errors</span> <span class="o">--</span><span class="p">;</span>
				<span class="n">bad</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">bad_start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bad</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			    	<span class="k">if</span> <span class="p">(</span><span class="n">bad_start</span> <span class="o">==</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">printk</span> <span class="p">(</span><span class="s">&quot; - 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bad</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot; - 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ether1_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_RST</span><span class="o">|</span><span class="n">CTRL_ACK</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BUS_16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ether1_init_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">ether1_ramtest</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">ether1_ramtest</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
	    	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These are the structures that are loaded into the ether RAM card to</span>
<span class="cm"> * initialise the 82586</span>
<span class="cm"> */</span>

<span class="cm">/* at 0x0100 */</span>
<span class="cp">#define NOP_ADDR	(TX_AREA_START)</span>
<span class="cp">#define NOP_SIZE	(0x06)</span>
<span class="k">static</span> <span class="n">nop_t</span>  <span class="n">init_nop</span>  <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">CMD_NOP</span><span class="p">,</span>
	<span class="n">NOP_ADDR</span>
<span class="p">};</span>

<span class="cm">/* at 0x003a */</span>
<span class="cp">#define TDR_ADDR	(0x003a)</span>
<span class="cp">#define TDR_SIZE	(0x08)</span>
<span class="k">static</span> <span class="n">tdr_t</span>  <span class="n">init_tdr</span>	<span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">CMD_TDR</span> <span class="o">|</span> <span class="n">CMD_INTR</span><span class="p">,</span>
	<span class="n">NOP_ADDR</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/* at 0x002e */</span>
<span class="cp">#define MC_ADDR		(0x002e)</span>
<span class="cp">#define MC_SIZE		(0x0c)</span>
<span class="k">static</span> <span class="n">mc_t</span>   <span class="n">init_mc</span>   <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">CMD_SETMULTICAST</span><span class="p">,</span>
	<span class="n">TDR_ADDR</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* at 0x0022 */</span>
<span class="cp">#define SA_ADDR		(0x0022)</span>
<span class="cp">#define SA_SIZE		(0x0c)</span>
<span class="k">static</span> <span class="n">sa_t</span>   <span class="n">init_sa</span>   <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">CMD_SETADDRESS</span><span class="p">,</span>
	<span class="n">MC_ADDR</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* at 0x0010 */</span>
<span class="cp">#define CFG_ADDR	(0x0010)</span>
<span class="cp">#define CFG_SIZE	(0x12)</span>
<span class="k">static</span> <span class="n">cfg_t</span>  <span class="n">init_cfg</span>  <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">CMD_CONFIG</span><span class="p">,</span>
	<span class="n">SA_ADDR</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="n">CFG8_SRDY</span><span class="p">,</span>
	<span class="n">CFG9_PREAMB8</span> <span class="o">|</span> <span class="n">CFG9_ADDRLENBUF</span> <span class="o">|</span> <span class="n">CFG9_ADDRLEN</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">CFG13_RETRY</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">CFG13_SLOTH</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* at 0x0000 */</span>
<span class="cp">#define SCB_ADDR	(0x0000)</span>
<span class="cp">#define SCB_SIZE	(0x10)</span>
<span class="k">static</span> <span class="n">scb_t</span>  <span class="n">init_scb</span>  <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SCB_CMDACKRNR</span> <span class="o">|</span> <span class="n">SCB_CMDACKCNA</span> <span class="o">|</span> <span class="n">SCB_CMDACKFR</span> <span class="o">|</span> <span class="n">SCB_CMDACKCX</span><span class="p">,</span>
	<span class="n">CFG_ADDR</span><span class="p">,</span>
	<span class="n">RX_AREA_START</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/* at 0xffee */</span>
<span class="cp">#define ISCP_ADDR	(0xffee)</span>
<span class="cp">#define ISCP_SIZE	(0x08)</span>
<span class="k">static</span> <span class="n">iscp_t</span> <span class="n">init_iscp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="n">SCB_ADDR</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span>
<span class="p">};</span>

<span class="cm">/* at 0xfff6 */</span>
<span class="cp">#define SCP_ADDR	(0xfff6)</span>
<span class="cp">#define SCP_SIZE	(0x0a)</span>
<span class="k">static</span> <span class="n">scp_t</span>  <span class="n">init_scp</span>  <span class="o">=</span> <span class="p">{</span>
	<span class="n">SCP_SY_16BBUS</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="n">ISCP_ADDR</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="cp">#define RFD_SIZE	(0x16)</span>
<span class="k">static</span> <span class="n">rfd_t</span>  <span class="n">init_rfd</span>	<span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="cp">#define RBD_SIZE	(0x0a)</span>
<span class="k">static</span> <span class="n">rbd_t</span>  <span class="n">init_rbd</span>	<span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="cp">#define TX_SIZE		(0x08)</span>
<span class="cp">#define TBD_SIZE	(0x08)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ether1_init_for_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">next2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_RST</span><span class="o">|</span><span class="n">CTRL_ACK</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">init_sa</span><span class="p">.</span><span class="n">sa_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* load data structures into ether1 RAM */</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_scp</span><span class="p">,</span>  <span class="n">SCP_ADDR</span><span class="p">,</span>  <span class="n">SCP_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_iscp</span><span class="p">,</span> <span class="n">ISCP_ADDR</span><span class="p">,</span> <span class="n">ISCP_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_scb</span><span class="p">,</span>  <span class="n">SCB_ADDR</span><span class="p">,</span>  <span class="n">SCB_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_cfg</span><span class="p">,</span>  <span class="n">CFG_ADDR</span><span class="p">,</span>  <span class="n">CFG_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_sa</span><span class="p">,</span>   <span class="n">SA_ADDR</span><span class="p">,</span>   <span class="n">SA_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_mc</span><span class="p">,</span>   <span class="n">MC_ADDR</span><span class="p">,</span>   <span class="n">MC_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_tdr</span><span class="p">,</span>  <span class="n">TDR_ADDR</span><span class="p">,</span>  <span class="n">TDR_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_nop</span><span class="p">,</span>  <span class="n">NOP_ADDR</span><span class="p">,</span>  <span class="n">NOP_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CFG_ADDR</span><span class="p">,</span> <span class="n">cfg_t</span><span class="p">,</span> <span class="n">cfg_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMD_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: detected either RAM fault or compiler bug</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup circularly linked list of { rfd, rbd, buffer }, with</span>
<span class="cm">	 * all rfds circularly linked, rbds circularly linked.</span>
<span class="cm">	 * First rfd is linked to scp, first rbd is linked to first</span>
<span class="cm">	 * rfd.  Last rbd has a suspend command.</span>
<span class="cm">	 */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">RX_AREA_START</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">RFD_SIZE</span> <span class="o">+</span> <span class="n">RBD_SIZE</span> <span class="o">+</span> <span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">next2</span> <span class="o">=</span> <span class="n">next</span> <span class="o">+</span> <span class="n">RFD_SIZE</span> <span class="o">+</span> <span class="n">RBD_SIZE</span> <span class="o">+</span> <span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next2</span> <span class="o">&gt;=</span> <span class="n">RX_AREA_END</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">RX_AREA_START</span><span class="p">;</span>
			<span class="n">init_rfd</span><span class="p">.</span><span class="n">rfd_command</span> <span class="o">=</span> <span class="n">RFD_CMDEL</span> <span class="o">|</span> <span class="n">RFD_CMDSUSPEND</span><span class="p">;</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">init_rfd</span><span class="p">.</span><span class="n">rfd_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">RX_AREA_START</span><span class="p">)</span>
			<span class="n">init_rfd</span><span class="p">.</span><span class="n">rfd_rbdoffset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">RFD_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">init_rfd</span><span class="p">.</span><span class="n">rfd_rbdoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">init_rfd</span><span class="p">.</span><span class="n">rfd_link</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="n">init_rbd</span><span class="p">.</span><span class="n">rbd_link</span> <span class="o">=</span> <span class="n">next</span> <span class="o">+</span> <span class="n">RFD_SIZE</span><span class="p">;</span>
		<span class="n">init_rbd</span><span class="p">.</span><span class="n">rbd_bufl</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">RFD_SIZE</span> <span class="o">+</span> <span class="n">RBD_SIZE</span><span class="p">;</span>

		<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_rfd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">RFD_SIZE</span><span class="p">);</span>
		<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_rbd</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">RFD_SIZE</span><span class="p">,</span> <span class="n">RBD_SIZE</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">next2</span> <span class="o">&lt;</span> <span class="n">RX_AREA_END</span><span class="p">);</span>

	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">NOP_ADDR</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">NOP_ADDR</span> <span class="o">+</span> <span class="n">NOP_SIZE</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">=</span> <span class="n">TDR_ADDR</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_head</span> <span class="o">=</span> <span class="n">RX_AREA_START</span><span class="p">;</span>

	<span class="cm">/* release reset &amp; give 586 a prod */</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resetting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">initialising</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_RST</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_CA</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>

	<span class="cm">/* 586 should now unset iscp.busy */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ISCP_ADDR</span><span class="p">,</span> <span class="n">iscp_t</span><span class="p">,</span> <span class="n">iscp_busy</span><span class="p">,</span> <span class="n">DISABLEIRQS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: can&#39;t initialise 82586: iscp is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check status of commands that we issued */</span>
	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CFG_ADDR</span><span class="p">,</span> <span class="n">cfg_t</span><span class="p">,</span> <span class="n">cfg_status</span><span class="p">,</span> <span class="n">DISABLEIRQS</span><span class="p">))</span>
			<span class="o">&amp;</span> <span class="n">STAT_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: can&#39;t initialise 82586: config status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_cbl_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_rfa_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">));</span>
		<span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SA_ADDR</span><span class="p">,</span> <span class="n">sa_t</span><span class="p">,</span> <span class="n">sa_status</span><span class="p">,</span> <span class="n">DISABLEIRQS</span><span class="p">))</span>
			<span class="o">&amp;</span> <span class="n">STAT_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: can&#39;t initialise 82586: set address status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_cbl_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_rfa_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">));</span>
		<span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC_ADDR</span><span class="p">,</span> <span class="n">mc_t</span><span class="p">,</span> <span class="n">mc_status</span><span class="p">,</span> <span class="n">DISABLEIRQS</span><span class="p">))</span>
			<span class="o">&amp;</span> <span class="n">STAT_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: can&#39;t initialise 82586: set multicast status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_cbl_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_rfa_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">));</span>
		<span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TDR_ADDR</span><span class="p">,</span> <span class="n">tdr_t</span><span class="p">,</span> <span class="n">tdr_status</span><span class="p">,</span> <span class="n">DISABLEIRQS</span><span class="p">))</span>
			<span class="o">&amp;</span> <span class="n">STAT_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">STAT_COMPLETE</span> <span class="o">|</span> <span class="n">STAT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: can&#39;t tdr (ignored)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: SCB=[STS=%04X CMD=%04X CBL=%04X RFA=%04X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_cbl_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">),</span>
			<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_rfa_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TDR_ADDR</span><span class="p">,</span> <span class="n">tdr_t</span><span class="p">,</span> <span class="n">tdr_result</span><span class="p">,</span> <span class="n">DISABLEIRQS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TDR_XCVRPROB</span><span class="p">)</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i/f failed tdr: transceiver problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TDR_SHORT</span><span class="o">|</span><span class="n">TDR_OPEN</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TDR_TIME</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef FANCY</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i/f failed tdr: cable %s %d.%d us away</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="n">TDR_SHORT</span> <span class="o">?</span> <span class="s">&quot;short&quot;</span> <span class="o">:</span> <span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TDR_TIME</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
				<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TDR_TIME</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i/f failed tdr: cable %s %d clks away</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="n">TDR_SHORT</span> <span class="o">?</span> <span class="s">&quot;short&quot;</span> <span class="o">:</span> <span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TDR_TIME</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failures</span><span class="p">)</span>
		<span class="n">ether1_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">failures</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ether1_txalloc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">TX_AREA_END</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tail</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">TX_AREA_START</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">tail</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">&lt;</span> <span class="n">tail</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tail</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ether1_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: invalid ethernet MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ether1_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ether1&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether1_init_for_open</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ether1_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timeout, network cable problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: resetting device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ether1_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether1_init_for_open</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to restart interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ether1_sendpacket</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="n">nopaddr</span><span class="p">,</span> <span class="n">txaddr</span><span class="p">,</span> <span class="n">tbdaddr</span><span class="p">,</span> <span class="n">dataddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">tx_t</span> <span class="n">tx</span><span class="p">;</span>
	<span class="n">tbd_t</span> <span class="n">tbd</span><span class="p">;</span>
	<span class="n">nop_t</span> <span class="n">nop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: resetting device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">ether1_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ether1_init_for_open</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to restart interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * insert packet followed by a nop</span>
<span class="cm">	 */</span>
	<span class="n">txaddr</span> <span class="o">=</span> <span class="n">ether1_txalloc</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_SIZE</span><span class="p">);</span>
	<span class="n">tbdaddr</span> <span class="o">=</span> <span class="n">ether1_txalloc</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TBD_SIZE</span><span class="p">);</span>
	<span class="n">dataddr</span> <span class="o">=</span> <span class="n">ether1_txalloc</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">nopaddr</span> <span class="o">=</span> <span class="n">ether1_txalloc</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NOP_SIZE</span><span class="p">);</span>

	<span class="n">tx</span><span class="p">.</span><span class="n">tx_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx</span><span class="p">.</span><span class="n">tx_command</span> <span class="o">=</span> <span class="n">CMD_TX</span> <span class="o">|</span> <span class="n">CMD_INTR</span><span class="p">;</span>
	<span class="n">tx</span><span class="p">.</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">nopaddr</span><span class="p">;</span>
	<span class="n">tx</span><span class="p">.</span><span class="n">tx_tbdoffset</span> <span class="o">=</span> <span class="n">tbdaddr</span><span class="p">;</span>
	<span class="n">tbd</span><span class="p">.</span><span class="n">tbd_opts</span> <span class="o">=</span> <span class="n">TBD_EOL</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tbd</span><span class="p">.</span><span class="n">tbd_link</span> <span class="o">=</span> <span class="n">I82586_NULL</span><span class="p">;</span>
	<span class="n">tbd</span><span class="p">.</span><span class="n">tbd_bufl</span> <span class="o">=</span> <span class="n">dataddr</span><span class="p">;</span>
	<span class="n">tbd</span><span class="p">.</span><span class="n">tbd_bufh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nop</span><span class="p">.</span><span class="n">nop_command</span> <span class="o">=</span> <span class="n">CMD_NOP</span><span class="p">;</span>
	<span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span> <span class="o">=</span> <span class="n">nopaddr</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="p">,</span> <span class="n">txaddr</span><span class="p">,</span> <span class="n">TX_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbd</span><span class="p">,</span> <span class="n">tbdaddr</span><span class="p">,</span> <span class="n">TBD_SIZE</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dataddr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ether1_writebuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nop</span><span class="p">,</span> <span class="n">nopaddr</span><span class="p">,</span> <span class="n">NOP_SIZE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">nopaddr</span><span class="p">;</span>

	<span class="cm">/* now reset the previous nop pointer */</span>
	<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txaddr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">nop_t</span><span class="p">,</span> <span class="n">nop_link</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* handle transmit */</span>

	<span class="cm">/* check to see if we have room for a full sized ether frame */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
	<span class="n">tst</span> <span class="o">=</span> <span class="n">ether1_txalloc</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_SIZE</span> <span class="o">+</span> <span class="n">TBD_SIZE</span> <span class="o">+</span> <span class="n">NOP_SIZE</span> <span class="o">+</span> <span class="n">ETH_FRAME_LEN</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tst</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ether1_xmit_done</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nop_t</span> <span class="n">nop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">caddr</span><span class="p">,</span> <span class="n">tst</span><span class="p">;</span>

	<span class="n">caddr</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">ether1_readbuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nop</span><span class="p">,</span> <span class="n">caddr</span><span class="p">,</span> <span class="n">NOP_SIZE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_command</span> <span class="o">&amp;</span> <span class="n">CMD_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CMD_TDR</span>:
		<span class="cm">/* special case */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_cbl_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">)</span>
				<span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">I82586_NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CMDCUCSTART</span> <span class="o">|</span> <span class="n">SCB_CMDRXSTART</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span>
				    <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_CA</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">=</span> <span class="n">NOP_ADDR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_NOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span> <span class="o">==</span> <span class="n">caddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">initialising</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: strange command complete with no tx command!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span>
			        <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">initialising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caddr</span> <span class="o">==</span> <span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">caddr</span> <span class="o">=</span> <span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_TX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_COMPLETE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: strange command complete without completed command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: strange command %d complete! (offset %04X)&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">nop</span><span class="p">.</span><span class="n">nop_command</span> <span class="o">&amp;</span> <span class="n">CMD_MASK</span><span class="p">,</span> <span class="n">caddr</span><span class="p">);</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_COLLISIONS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_COLLAFTERTX</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_NOCARRIER</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_TXLOSTCTS</span><span class="p">)</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: cts lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_TXSLOWDMA</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_status</span> <span class="o">&amp;</span> <span class="n">STAT_COLLEXCESSIVE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span> <span class="o">==</span> <span class="n">caddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: tx buffer chaining error: tx command points to itself</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">caddr</span> <span class="o">=</span> <span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span><span class="p">;</span>
		<span class="n">ether1_readbuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nop</span><span class="p">,</span> <span class="n">caddr</span><span class="p">,</span> <span class="n">NOP_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_command</span> <span class="o">&amp;</span> <span class="n">CMD_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMD_NOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: tx buffer chaining error: no nop after tx command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">caddr</span> <span class="o">==</span> <span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">caddr</span> <span class="o">=</span> <span class="n">nop</span><span class="p">.</span><span class="n">nop_link</span><span class="p">;</span>
		<span class="n">ether1_readbuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nop</span><span class="p">,</span> <span class="n">caddr</span><span class="p">,</span> <span class="n">NOP_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nop</span><span class="p">.</span><span class="n">nop_command</span> <span class="o">&amp;</span> <span class="n">CMD_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CMD_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: tx buffer chaining error: no tx command after nop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">=</span> <span class="n">caddr</span><span class="p">;</span>

	<span class="n">caddr</span> <span class="o">=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
	<span class="n">tst</span> <span class="o">=</span> <span class="n">ether1_txalloc</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_SIZE</span> <span class="o">+</span> <span class="n">TBD_SIZE</span> <span class="o">+</span> <span class="n">NOP_SIZE</span> <span class="o">+</span> <span class="n">ETH_FRAME_LEN</span><span class="p">);</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">caddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tst</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ether1_recv_done</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nexttail</span><span class="p">,</span> <span class="n">rbdaddr</span><span class="p">;</span>
	<span class="n">rbd_t</span> <span class="n">rbd</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RFD_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rbdaddr</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_rbdoffset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
		<span class="n">ether1_readbuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd</span><span class="p">,</span> <span class="n">rbdaddr</span><span class="p">,</span> <span class="n">RBD_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rbd</span><span class="p">.</span><span class="n">rbd_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RBD_EOF</span> <span class="o">|</span> <span class="n">RBD_ACNTVALID</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">RBD_EOF</span> <span class="o">|</span> <span class="n">RBD_ACNTVALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">rbd</span><span class="p">.</span><span class="n">rbd_status</span> <span class="o">&amp;</span> <span class="n">RBD_ACNT</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

				<span class="n">ether1_readbuffer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">rbd</span><span class="p">.</span><span class="n">rbd_bufl</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_rx</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="n">rbd</span><span class="p">.</span><span class="n">rbd_status</span> <span class="o">&amp;</span> <span class="n">RBD_EOF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;oversized packet&quot;</span> <span class="o">:</span> <span class="s">&quot;acnt not valid&quot;</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nexttail</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_link</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
		<span class="cm">/* nexttail should be rx_head */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nexttail</span> <span class="o">!=</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: receiver buffer chaining error (%04X != %04X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nexttail</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">);</span>
		<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFD_CMDEL</span> <span class="o">|</span> <span class="n">RFD_CMDSUSPEND</span><span class="p">,</span> <span class="n">nexttail</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
		<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
		<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
		<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_rbdoffset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
	
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="n">nexttail</span><span class="p">;</span>
		<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_head</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span> <span class="n">rfd_t</span><span class="p">,</span> <span class="n">rfd_link</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ether1_interrupt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCB_STRNR</span> <span class="o">|</span> <span class="n">SCB_STCNA</span> <span class="o">|</span> <span class="n">SCB_STFR</span> <span class="o">|</span> <span class="n">SCB_STCX</span><span class="p">),</span>
			    <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_CA</span> <span class="o">|</span> <span class="n">CTRL_ACK</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCB_STCX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ether1_xmit_done</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCB_STCNA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resetting</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: CU went not ready ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resetting</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_cbl_offset</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">)</span>
					<span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">I82586_NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CMDCUCSTART</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
				<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_CA</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resetting</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCB_STFR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ether1_recv_done</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCB_STRNR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCB_STRXSUSP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: RU went not ready: RU suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ether1_writew</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CMDRXRESUME</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_command</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">);</span>
				<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_CA</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* we suspended due to lack of buffer space */</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: RU went not ready: %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">,</span> <span class="n">NORMALIRQS</span><span class="p">));</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;RU ptr = %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ether1_readw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_ADDR</span><span class="p">,</span> <span class="n">scb_t</span><span class="p">,</span> <span class="n">scb_rfa_offset</span><span class="p">,</span>
						<span class="n">NORMALIRQS</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CTRL_ACK</span><span class="p">,</span> <span class="n">REG_CONTROL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ether1_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ether1_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set or clear the multicast filter for this adaptor.</span>
<span class="cm"> * num_addrs == -1	Promiscuous mode, receive all packets.</span>
<span class="cm"> * num_addrs == 0	Normal mode, clear multicast list.</span>
<span class="cm"> * num_addrs &gt; 0	Multicast mode, receive normal and MC packets, and do</span>
<span class="cm"> *			best-effort filtering.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ether1_setmulticastlist</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ether1_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">version_printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&amp;&amp;</span> <span class="n">version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ether1_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ether1_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ether1_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ether1_sendpacket</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ether1_setmulticastlist</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ether1_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ether1_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ecard_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ether1_banner</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ecard_request_resources</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ether1_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ecardm_iomap</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ECARD_RES_IOCFAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">ether1_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">IDPROM_ADDRESS</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether1_init_2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ether1_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: ether1 in slot %d, %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
    
	<span class="n">ecard_set_drvdata</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">free:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">release:</span>
	<span class="n">ecard_release_resources</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ether1_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ecard_get_drvdata</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>

	<span class="n">ecard_set_drvdata</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>	

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ecard_release_resources</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ecard_id</span> <span class="n">ether1_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">MANU_ACORN</span><span class="p">,</span> <span class="n">PROD_ACORN_ETHER1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ecard_driver</span> <span class="n">ether1_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ether1_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ether1_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ether1_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ether1&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ether1_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ecard_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ether1_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ether1_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_remove_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ether1_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ether1_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ether1_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
