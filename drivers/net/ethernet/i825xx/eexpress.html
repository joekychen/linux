<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › eexpress.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>eexpress.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Intel EtherExpress 16 device driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Written by John Sullivan, 1995</span>
<span class="cm"> *  based on original code by Donald Becker, with changes by</span>
<span class="cm"> *  Alan Cox and Pauline Middelink.</span>
<span class="cm"> *</span>
<span class="cm"> * Support for 8-bit mode by Zoltan Szilagyi &lt;zoltans@cs.arizona.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Many modifications, and currently maintained, by</span>
<span class="cm"> *  Philip Blundell &lt;philb@gnu.org&gt;</span>
<span class="cm"> * Added the Compaq LTE  Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm"> * Added MCA support Adam Fritzler (now deleted)</span>
<span class="cm"> *</span>
<span class="cm"> * Note - this driver is experimental still - it has problems on faster</span>
<span class="cm"> * machines. Someone needs to sit down and go through it line by line with</span>
<span class="cm"> * a databook...</span>
<span class="cm"> */</span>

<span class="cm">/* The EtherExpress 16 is a fairly simple card, based on a shared-memory</span>
<span class="cm"> * design using the i82586 Ethernet coprocessor.  It bears no relationship,</span>
<span class="cm"> * as far as I know, to the similarly-named &quot;EtherExpress Pro&quot; range.</span>
<span class="cm"> *</span>
<span class="cm"> * Historically, Linux support for these cards has been very bad.  However,</span>
<span class="cm"> * things seem to be getting better slowly.</span>
<span class="cm"> */</span>

<span class="cm">/* If your card is confused about what sort of interface it has (eg it</span>
<span class="cm"> * persistently reports &quot;10baseT&quot; when none is fitted), running &#39;SOFTSET /BART&#39;</span>
<span class="cm"> * or &#39;SOFTSET /LISA&#39; from DOS seems to help.</span>
<span class="cm"> */</span>

<span class="cm">/* Here&#39;s the scoop on memory mapping.</span>
<span class="cm"> *</span>
<span class="cm"> * There are three ways to access EtherExpress card memory: either using the</span>
<span class="cm"> * shared-memory mapping, or using PIO through the dataport, or using PIO</span>
<span class="cm"> * through the &quot;shadow memory&quot; ports.</span>
<span class="cm"> *</span>
<span class="cm"> * The shadow memory system works by having the card map some of its memory</span>
<span class="cm"> * as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * (the low five bits of the SMPTR are ignored)</span>
<span class="cm"> *</span>
<span class="cm"> *  base+0x4000..400f      memory at SMPTR+0..15</span>
<span class="cm"> *  base+0x8000..800f      memory at SMPTR+16..31</span>
<span class="cm"> *  base+0xc000..c007      dubious stuff (memory at SMPTR+16..23 apparently)</span>
<span class="cm"> *  base+0xc008..c00f      memory at 0x0008..0x000f</span>
<span class="cm"> *</span>
<span class="cm"> * This last set (the one at c008) is particularly handy because the SCB</span>
<span class="cm"> * lives at 0x0008.  So that set of ports gives us easy random access to data</span>
<span class="cm"> * in the SCB without having to mess around setting up pointers and the like.</span>
<span class="cm"> * We always use this method to access the SCB (via the scb_xx() functions).</span>
<span class="cm"> *</span>
<span class="cm"> * Dataport access works by aiming the appropriate (read or write) pointer</span>
<span class="cm"> * at the first address you&#39;re interested in, and then reading or writing from</span>
<span class="cm"> * the dataport.  The pointers auto-increment after each transfer.  We use</span>
<span class="cm"> * this for data transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t use the shared-memory system because it allegedly doesn&#39;t work on</span>
<span class="cm"> * all cards, and because it&#39;s a bit more prone to go wrong (it&#39;s one more</span>
<span class="cm"> * thing to configure...).</span>
<span class="cm"> */</span>

<span class="cm">/* Known bugs:</span>
<span class="cm"> *</span>
<span class="cm"> * - The card seems to want to give us two interrupts every time something</span>
<span class="cm"> *   happens, where just one would be better.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Note by Zoltan Szilagyi 10-12-96:</span>
<span class="cm"> *</span>
<span class="cm"> * I&#39;ve succeeded in eliminating the &quot;CU wedged&quot; messages, and hence the</span>
<span class="cm"> * lockups, which were only occurring with cards running in 8-bit mode (&quot;force</span>
<span class="cm"> * 8-bit operation&quot; in Intel&#39;s SoftSet utility). This version of the driver</span>
<span class="cm"> * sets the 82586 and the ASIC to 8-bit mode at startup; it also stops the</span>
<span class="cm"> * CU before submitting a packet for transmission, and then restarts it as soon</span>
<span class="cm"> * as the process of handing the packet is complete. This is definitely an</span>
<span class="cm"> * unnecessary slowdown if the card is running in 16-bit mode; therefore one</span>
<span class="cm"> * should detect 16-bit vs 8-bit mode from the EEPROM settings and act</span>
<span class="cm"> * accordingly. In 8-bit mode with this bugfix I&#39;m getting about 150 K/s for</span>
<span class="cm"> * ftp&#39;s, which is significantly better than I get in DOS, so the overhead of</span>
<span class="cm"> * stopping and restarting the CU with each transmit is not prohibitive in</span>
<span class="cm"> * practice.</span>
<span class="cm"> *</span>
<span class="cm"> * Update by David Woodhouse 11/5/99:</span>
<span class="cm"> *</span>
<span class="cm"> * I&#39;ve seen &quot;CU wedged&quot; messages in 16-bit mode, on the Alpha architecture.</span>
<span class="cm"> * I assume that this is because 16-bit accesses are actually handled as two</span>
<span class="cm"> * 8-bit accesses.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef __alpha__</span>
<span class="cp">#define LOCKUP16 1</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef LOCKUP16</span>
<span class="cp">#define LOCKUP16 0</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#ifndef NET_DEBUG</span>
<span class="cp">#define NET_DEBUG 4</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;eexpress.h&quot;</span>

<span class="cp">#define EEXP_IO_EXTENT  16</span>

<span class="cm">/*</span>
<span class="cm"> * Private data declarations</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">net_local</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_tx</span><span class="p">;</span>       <span class="cm">/* jiffies when last transmit started */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">init_time</span><span class="p">;</span>     <span class="cm">/* jiffies when eexp_hw_init586 called */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_first</span><span class="p">;</span>     <span class="cm">/* first rx buf, same as RX_BUF_START */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_last</span><span class="p">;</span>      <span class="cm">/* last rx buf */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_ptr</span><span class="p">;</span>       <span class="cm">/* first rx buf to look at */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_head</span><span class="p">;</span>      <span class="cm">/* next free tx buf */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_reap</span><span class="p">;</span>      <span class="cm">/* first in-use tx buf */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_tail</span><span class="p">;</span>      <span class="cm">/* previous tx buf to tx_head */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_link</span><span class="p">;</span>      <span class="cm">/* last known-executing tx buf */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">last_tx_restart</span><span class="p">;</span>   <span class="cm">/* set to tx_link when we</span>
<span class="cm">					     restart the CU */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">started</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_buf_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_buf_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">num_tx_bufs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">num_rx_bufs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">width</span><span class="p">;</span>         <span class="cm">/* 0 for 16bit, 1 for 8bit */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">was_promisc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_mc_count</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* This is the code and data that is downloaded to the EtherExpress card&#39;s</span>
<span class="cm"> * memory at boot time.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">start_code</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* 0x0000 */</span>
	<span class="mh">0x0001</span><span class="p">,</span>                 <span class="cm">/* ISCP: busy - cleared after reset */</span>
	<span class="mh">0x0008</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>   <span class="cm">/* offset,address (lo,hi) of SCB */</span>

	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>          <span class="cm">/* SCB: status, commands */</span>
	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>          <span class="cm">/* links to first command block,</span>
<span class="cm">				   first receive descriptor */</span>
	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>          <span class="cm">/* CRC error, alignment error counts */</span>
	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>          <span class="cm">/* out of resources, overrun error counts */</span>

	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>          <span class="cm">/* pad */</span>
	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>

<span class="cm">/* 0x20 -- start of 82586 CU program */</span>
<span class="cp">#define CONF_LINK 0x20</span>
	<span class="mh">0x0000</span><span class="p">,</span><span class="n">Cmd_Config</span><span class="p">,</span>
	<span class="mh">0x0032</span><span class="p">,</span>                 <span class="cm">/* link to next command */</span>
	<span class="mh">0x080c</span><span class="p">,</span>                 <span class="cm">/* 12 bytes follow : fifo threshold=8 */</span>
	<span class="mh">0x2e40</span><span class="p">,</span>                 <span class="cm">/* don&#39;t rx bad frames</span>
<span class="cm">				 * SRDY/ARDY =&gt; ext. sync. : preamble len=8</span>
<span class="cm">	                         * take addresses from data buffers</span>
<span class="cm">				 * 6 bytes/address</span>
<span class="cm">				 */</span>
	<span class="mh">0x6000</span><span class="p">,</span>                 <span class="cm">/* default backoff method &amp; priority</span>
<span class="cm">				 * interframe spacing = 0x60 */</span>
	<span class="mh">0xf200</span><span class="p">,</span>                 <span class="cm">/* slot time=0x200</span>
<span class="cm">				 * max collision retry = 0xf */</span>
<span class="cp">#define CONF_PROMISC  0x2e</span>
	<span class="mh">0x0000</span><span class="p">,</span>                 <span class="cm">/* no HDLC : normal CRC : enable broadcast</span>
<span class="cm">				 * disable promiscuous/multicast modes */</span>
	<span class="mh">0x003c</span><span class="p">,</span>                 <span class="cm">/* minimum frame length = 60 octets) */</span>

	<span class="mh">0x0000</span><span class="p">,</span><span class="n">Cmd_SetAddr</span><span class="p">,</span>
	<span class="mh">0x003e</span><span class="p">,</span>                 <span class="cm">/* link to next command */</span>
<span class="cp">#define CONF_HWADDR  0x38</span>
	<span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">,</span>   <span class="cm">/* hardware address placed here */</span>

	<span class="mh">0x0000</span><span class="p">,</span><span class="n">Cmd_MCast</span><span class="p">,</span>
	<span class="mh">0x0076</span><span class="p">,</span>                 <span class="cm">/* link to next command */</span>
<span class="cp">#define CONF_NR_MULTICAST 0x44</span>
	<span class="mh">0x0000</span><span class="p">,</span>                 <span class="cm">/* number of bytes in multicast address(es) */</span>
<span class="cp">#define CONF_MULTICAST 0x46</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* some addresses */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>

<span class="cp">#define CONF_DIAG_RESULT  0x76</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="n">Cmd_Diag</span><span class="p">,</span>
	<span class="mh">0x007c</span><span class="p">,</span>                 <span class="cm">/* link to next command */</span>

	<span class="mh">0x0000</span><span class="p">,</span><span class="n">Cmd_TDR</span><span class="o">|</span><span class="n">Cmd_INT</span><span class="p">,</span>
	<span class="mh">0x0084</span><span class="p">,</span>
<span class="cp">#define CONF_TDR_RESULT  0x82</span>
	<span class="mh">0x0000</span><span class="p">,</span>

	<span class="mh">0x0000</span><span class="p">,</span><span class="n">Cmd_END</span><span class="o">|</span><span class="n">Cmd_Nop</span><span class="p">,</span> <span class="cm">/* end of configure sequence */</span>
	<span class="mh">0x0084</span>                  <span class="cm">/* dummy link */</span>
<span class="p">};</span>

<span class="cm">/* maps irq number to EtherExpress magic value */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">irqrmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Prototypes for Linux interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">eexp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eexp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">eexp_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">eexp_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Prototypes for hardware access functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_hw_rx_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_hw_tx_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eexp_hw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">eexp_hw_readeeprom</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">location</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">eexp_hw_lasttxstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_hw_txrestart</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_hw_txinit</span>    <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_hw_rxinit</span>    <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_hw_init586</span>   <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">eexp_setup_filter</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eexp_ifmap</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;AUI&quot;</span><span class="p">,</span> <span class="s">&quot;BNC&quot;</span><span class="p">,</span> <span class="s">&quot;RJ45&quot;</span><span class="p">};</span>
<span class="k">enum</span> <span class="n">eexp_iftype</span> <span class="p">{</span><span class="n">AUI</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">BNC</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">TPE</span><span class="o">=</span><span class="mi">2</span><span class="p">};</span>

<span class="cp">#define STARTED_RU      2</span>
<span class="cp">#define STARTED_CU      1</span>

<span class="cm">/*</span>
<span class="cm"> * Primitive hardware access functions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">scb_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0xc008</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">scb_rdcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0xc00a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scb_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0xc00a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scb_wrcbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0xc00c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scb_wrrfa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0xc00e</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">Config</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">Config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clear_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">Config</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">Config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="nf">SHADOW</span><span class="p">(</span><span class="kt">short</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">addr</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mh">0x3ff0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x4000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Linux interface</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * checks for presence of EtherExpress card</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_express_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x240</span><span class="p">,</span><span class="mh">0x300</span><span class="p">,</span><span class="mh">0x310</span><span class="p">,</span><span class="mh">0x270</span><span class="p">,</span><span class="mh">0x320</span><span class="p">,</span><span class="mh">0x340</span><span class="p">,</span><span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* not set */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span><span class="o">&amp;</span><span class="mh">0xfe00</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;EtherExpress&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">eexp_hw_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span><span class="o">=&amp;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span> <span class="o">*</span><span class="n">port</span> <span class="p">;</span> <span class="n">port</span><span class="o">++</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;EtherExpress&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="o">*</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_PORT</span><span class="p">);</span>
			<span class="n">sum</span> <span class="o">|=</span> <span class="p">(</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sum</span><span class="o">==</span><span class="mh">0xbaba</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">eexp_hw_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">*</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">release_region</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">express_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_express_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * open and initialize the adapter, ready for use</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eexp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#if NET_DEBUG &gt; 6</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: eexp_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">||</span> <span class="o">!</span><span class="n">irqrmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">eexp_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;EtherExpress&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EtherExpress io port %x, is busy.</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x4000</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;EtherExpress shadow&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EtherExpress io port %x, is busy.</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x4000</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;EtherExpress shadow&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EtherExpress io port %x, is busy.</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x8000</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc000</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">,</span> <span class="s">&quot;EtherExpress shadow&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EtherExpress io port %x, is busy.</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc000</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: forcing ASIC to 8-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">Config</span><span class="p">)</span><span class="o">&amp;~</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">Config</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">eexp_hw_init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#if NET_DEBUG &gt; 6</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: leaving eexp_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">err_out4:</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">);</span>
	<span class="nl">err_out3:</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x4000</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">);</span>
	<span class="nl">err_out2:</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">);</span>
	<span class="nl">err_out1:</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * close and disable the interface, leaving the 586 in reset.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eexp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">SIRQ_dis</span><span class="o">|</span><span class="n">irqrmap</span><span class="p">[</span><span class="n">irq</span><span class="p">],</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SET_IRQ</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUsuspend</span><span class="o">|</span><span class="n">SCB_RUsuspend</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">i586_RST</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEXP_IO_EXTENT</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x4000</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x8000</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0xc000</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This gets called when a higher level thinks we are broken.  Check that</span>
<span class="cm"> * nothing has become jammed in the CU.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unstick_cu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_trans_start</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="o">==</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_tx_restart</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">boguscount</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">rsst</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Retransmit timed out, status %04x, resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
				<span class="n">eexp_hw_txinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_tx_restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="p">);</span>
				<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUstart</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">SCB_complete</span><span class="p">(</span><span class="n">rsst</span><span class="o">=</span><span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">boguscount</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">boguscount</span><span class="o">=</span><span class="mi">200</span><span class="p">;</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Reset timed out status %04x, retrying...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">rsst</span><span class="p">);</span>
						<span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="p">);</span>
						<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUstart</span><span class="p">);</span>
						<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span> <span class="o">=</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">SCB_CUdead</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">txstatus</span> <span class="o">=</span> <span class="n">eexp_hw_lasttxstat</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Transmit timed out, CU not active status %04x %04x, restarting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">txstatus</span><span class="p">);</span>
					<span class="n">eexp_hw_txrestart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">txstatus</span> <span class="o">=</span> <span class="n">eexp_hw_lasttxstat</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">txstatus</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: CU wedged, status %04x %04x, resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">txstatus</span><span class="p">);</span>
						<span class="n">eexp_hw_init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
						<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_time</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span> <span class="o">=</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i82586 startup timed out, status %04x, resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">eexp_hw_init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Best would be to use synchronize_irq(); spin_lock() here</span>
<span class="cm">	 *	lets make it work first..</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">unstick_cu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: transmit timed out, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">SCB_complete</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;lost interrupt&quot;</span><span class="o">:</span>
		<span class="s">&quot;board on fire&quot;</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCB_complete</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUabort</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called to transmit a packet, or to allow us to right ourselves</span>
<span class="cm"> * if the kernel thinks we&#39;ve died.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">eexp_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">length</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if NET_DEBUG &gt; 6</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: eexp_xmit()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Best would be to use synchronize_irq(); spin_lock() here</span>
<span class="cm">	 *	lets make it work first..</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	        <span class="n">eexp_hw_tx_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle an EtherExpress interrupt</span>
<span class="cm"> * If we&#39;ve finished initializing, start the RU and CU up.</span>
<span class="cm"> * If we&#39;ve already started, reap tx buffers, handle any received packets,</span>
<span class="cm"> * check to make sure we&#39;ve not become wedged.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">eexp_start_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ack_cmd</span> <span class="o">=</span> <span class="n">SCB_ack</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&amp;</span> <span class="n">STARTED_CU</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">diag_status</span><span class="p">,</span> <span class="n">tdr_status</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">SCB_CUstat</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#if NET_DEBUG &gt; 4</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: CU went non-active (status %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">CONF_DIAG_RESULT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SM_PTR</span><span class="p">);</span>
		<span class="n">diag_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_DIAG_RESULT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag_status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: 82586 failed self-test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">diag_status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: 82586 self-test failed to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">CONF_TDR_RESULT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SM_PTR</span><span class="p">);</span>
		<span class="n">tdr_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_TDR_RESULT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tdr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TDR_SHORT</span><span class="o">|</span><span class="n">TDR_OPEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: TDR reports cable %s at %d tick%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">tdr_status</span> <span class="o">&amp;</span> <span class="n">TDR_SHORT</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;short&quot;</span><span class="o">:</span><span class="s">&quot;broken&quot;</span><span class="p">,</span> <span class="n">tdr_status</span> <span class="o">&amp;</span> <span class="n">TDR_TIME</span><span class="p">,</span> <span class="p">((</span><span class="n">tdr_status</span> <span class="o">&amp;</span> <span class="n">TDR_TIME</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tdr_status</span> <span class="o">&amp;</span> <span class="n">TDR_XCVRPROBLEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: TDR reports transceiver problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tdr_status</span> <span class="o">&amp;</span> <span class="n">TDR_LINKOK</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if NET_DEBUG &gt; 4</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TDR reports link OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TDR is ga-ga (status %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">tdr_status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">|=</span> <span class="n">STARTED_CU</span><span class="p">;</span>
		<span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="p">);</span>
		<span class="cm">/* if the RU isn&#39;t running, start it now */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&amp;</span> <span class="n">STARTED_RU</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ack_cmd</span> <span class="o">|=</span> <span class="n">SCB_RUstart</span><span class="p">;</span>
			<span class="n">scb_wrrfa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_start</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_start</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">|=</span> <span class="n">STARTED_RU</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ack_cmd</span> <span class="o">|=</span> <span class="n">SCB_CUstart</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&amp;</span> <span class="n">STARTED_RU</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">SCB_RUstat</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span><span class="o">|=</span><span class="n">STARTED_RU</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ack_cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_cmd_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">oldtime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scb_rdcmd</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">oldtime</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb_rdcmd</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: command didn&#39;t clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">eexp_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">ack_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old_read_ptr</span><span class="p">,</span> <span class="n">old_write_ptr</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">old_read_ptr</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">READ_PTR</span><span class="p">);</span>
	<span class="n">old_write_ptr</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">WRITE_PTR</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">SIRQ_dis</span><span class="o">|</span><span class="n">irqrmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">],</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SET_IRQ</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#if NET_DEBUG &gt; 4</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: interrupt (status %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">==</span> <span class="p">(</span><span class="n">STARTED_CU</span> <span class="o">|</span> <span class="n">STARTED_RU</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">eexp_cmd_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">ack_cmd</span> <span class="o">=</span> <span class="n">SCB_ack</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
			<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ack_cmd</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>

			<span class="n">eexp_cmd_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">SCB_complete</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eexp_hw_lasttxstat</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: tx interrupt but no status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">SCB_rxdframe</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
				<span class="n">eexp_hw_rx_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCB_RUdead</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: RU stopped: status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			printk(KERN_WARNING &quot;%s: cur_rfd=%04x, cur_rbd=%04x\n&quot;, dev-&gt;name, lp-&gt;cur_rfd, lp-&gt;cur_rbd);</span>
<span class="c">			outw(lp-&gt;cur_rfd, ioaddr+READ_PTR);</span>
<span class="c">			printk(KERN_WARNING &quot;%s: [%04x]\n&quot;, dev-&gt;name, inw(ioaddr+DATAPORT));</span>
<span class="c">			outw(lp-&gt;cur_rfd+6, ioaddr+READ_PTR);</span>
<span class="c">			printk(KERN_WARNING &quot;%s: rbd is %04x\n&quot;, dev-&gt;name, rbd= inw(ioaddr+DATAPORT));</span>
<span class="c">			outw(rbd, ioaddr+READ_PTR);</span>
<span class="c">			printk(KERN_WARNING &quot;%s: [%04x %04x] &quot;, dev-&gt;name, inw(ioaddr+DATAPORT), inw(ioaddr+DATAPORT));</span>
<span class="c">			outw(rbd+8, ioaddr+READ_PTR);</span>
<span class="c">			printk(&quot;[%04x]\n&quot;, inw(ioaddr+DATAPORT));</span>
<span class="cp">#endif</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if 1</span>
		        <span class="n">eexp_hw_rxinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_rfd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_rfd</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">scb_wrrfa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_start</span><span class="p">);</span>
			<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_RUstart</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="n">ack_cmd</span> <span class="o">=</span> <span class="n">eexp_start_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ack_cmd</span> <span class="o">=</span> <span class="n">SCB_ack</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ack_cmd</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">eexp_cmd_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">SIRQ_en</span><span class="o">|</span><span class="n">irqrmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">],</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SET_IRQ</span><span class="p">);</span>

<span class="cp">#if NET_DEBUG &gt; 6</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: leaving eexp_irq()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">old_read_ptr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">READ_PTR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">old_write_ptr</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">WRITE_PTR</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware access functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Set the cable type to use.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_hw_set_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oldval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x300e</span><span class="p">);</span>
	<span class="n">oldval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x82</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPE</span>:
		<span class="n">oldval</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BNC</span>:
		<span class="n">oldval</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldval</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="mh">0x300e</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check all the receive buffers, and hand any received packets</span>
<span class="cm"> * to the upper levels. Basic sanity check on each frame</span>
<span class="cm"> * descriptor, though we don&#39;t bother trying to fix broken ones.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_hw_rx_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_block</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_rx_bufs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>

<span class="cp">#if NET_DEBUG &gt; 6</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: eexp_hw_rx()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

 	<span class="k">do</span> <span class="p">{</span>
 		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rfd_cmd</span><span class="p">,</span> <span class="n">rx_next</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">;</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">rx_block</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">READ_PTR</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FD_Done</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">rfd_cmd</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
			<span class="n">rx_next</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
			<span class="n">pbuf</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

			<span class="n">outw</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">READ_PTR</span><span class="p">);</span>
			<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rfd_cmd</span><span class="o">!=</span><span class="mh">0x0000</span><span class="p">)</span>
  			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: rfd_cmd not zero:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rfd_cmd</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="o">!=</span><span class="n">rx_block</span><span class="o">+</span><span class="mh">0x16</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: rfd and rbd out of sync 0x%04x 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_block</span><span class="o">+</span><span class="mh">0x16</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">)</span><span class="o">!=</span><span class="mh">0xc000</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: EOF or F not set on received buffer (%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">);</span>
  				<span class="k">continue</span><span class="p">;</span>
  			<span class="p">}</span>
  			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FD_OK</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FD_CRC</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FD_Align</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FD_Resrc</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FD_DMA</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FD_Short</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
				<span class="n">pkt_len</span> <span class="o">&amp;=</span> <span class="mh">0x3fff</span><span class="p">;</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Memory squeeze, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">pbuf</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">READ_PTR</span><span class="p">);</span>
			        <span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">pkt_len</span><span class="p">),(</span><span class="n">pkt_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">rx_block</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">WRITE_PTR</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
			<span class="n">rx_block</span> <span class="o">=</span> <span class="n">rx_next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">FD_Done</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">boguscount</span><span class="o">--</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ptr</span> <span class="o">=</span> <span class="n">rx_block</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hand a packet to the card for transmission</span>
<span class="cm"> * If we get here, we MUST have already checked</span>
<span class="cm"> * to make sure there is room in the transmit</span>
<span class="cm"> * buffer region.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_hw_tx_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LOCKUP16</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stop the CU so that there is no chance that it</span>
<span class="cm">		   jumps off to a bogus address while we are writing the</span>
<span class="cm">		   pointer to the next transmit packet in 8-bit mode --</span>
<span class="cm">		   this eliminates the &quot;CU wedged&quot; errors in 8-bit mode.</span>
<span class="cm">		   (Zoltan Szilagyi 10-12-96) */</span>
		<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUsuspend</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
	<span class="p">}</span>

 	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WRITE_PTR</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
        <span class="n">outw</span><span class="p">(</span><span class="n">Cmd_INT</span><span class="o">|</span><span class="n">Cmd_Xmit</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="o">+</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="o">+</span><span class="mh">0x0e</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="o">+</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="mh">0x8000</span><span class="o">|</span><span class="n">len</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="o">+</span><span class="mh">0x16</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

	<span class="n">outsw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WRITE_PTR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="o">==</span><span class="n">TX_BUF_START</span><span class="o">+</span><span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tx_bufs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">TX_BUF_SIZE</span><span class="p">))</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">+=</span> <span class="n">TX_BUF_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LOCKUP16</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Restart the CU so that the packet can actually</span>
<span class="cm">		   be transmitted. (Zoltan Szilagyi 10-12-96) */</span>
		<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUresume</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">eexp_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">eexp_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> 		<span class="o">=</span> <span class="n">eexp_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">eexp_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">eexp_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">eexp_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Sanity check the suspected EtherExpress card</span>
<span class="cm"> * Read hardware address, reset card, size memory and initialize buffer</span>
<span class="cm"> * memory pointers. These are held in netdev_priv(), in case someone has more</span>
<span class="cm"> * than one card in a machine.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eexp_hw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hw_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buswidth</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">memory_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">xsum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: EtherExpress 16 at %#x &quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ASIC_RST</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">i586_RST</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>

	<span class="n">hw_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eexp_hw_readeeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">hw_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eexp_hw_readeeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">hw_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">eexp_hw_readeeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Standard Address or Compaq LTE Address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">hw_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mh">0x00aa</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">hw_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span><span class="o">==</span><span class="mh">0x0000</span><span class="p">))</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">hw_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mh">0x0080</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">hw_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span><span class="o">==</span><span class="mh">0x5F00</span><span class="p">))))</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; rejected: invalid address %04x%04x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hw_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">hw_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">hw_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate the EEPROM checksum.  Carry on anyway if it&#39;s bad,</span>
<span class="cm">	 * though.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">xsum</span> <span class="o">+=</span> <span class="n">eexp_hw_readeeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xsum</span> <span class="o">!=</span> <span class="mh">0xbaba</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (bad EEPROM xsum 0x%02x)&quot;</span><span class="p">,</span> <span class="n">xsum</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hw_addr</span><span class="p">)[</span><span class="mi">5</span><span class="o">-</span><span class="n">i</span><span class="p">];</span>

	<span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">irqmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">setupval</span> <span class="o">=</span> <span class="n">eexp_hw_readeeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Use the IRQ from EEPROM if none was given */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irqmap</span><span class="p">[</span><span class="n">setupval</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">setupval</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">?</span> <span class="n">AUI</span> <span class="o">:</span>
				<span class="n">eexp_hw_readeeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="n">TPE</span> <span class="o">:</span> <span class="n">BNC</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buswidth</span> <span class="o">=</span> <span class="o">!</span><span class="p">((</span><span class="n">setupval</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

 	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(IRQ %d, %s connector, %d-bit bus&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
 	       <span class="n">eexp_ifmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">],</span> <span class="n">buswidth</span><span class="o">?</span><span class="mi">8</span><span class="o">:</span><span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x300e</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;EtherExpress&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

 	<span class="n">eexp_hw_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x300e</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Find out how much RAM we have on the card */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WRITE_PTR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32768</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">memory_size</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">memory_size</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">memory_size</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">READ_PTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">memory_size</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WRITE_PTR</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">memory_size</span> <span class="o">|</span> <span class="mh">0x5000</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">memory_size</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">READ_PTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">memory_size</span> <span class="o">|</span> <span class="mh">0x5000</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sort out the number of buffers.  We may have 16, 32, 48 or 64k</span>
<span class="cm">	 * of RAM to play with.</span>
<span class="cm">	 */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tx_bufs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_end</span> <span class="o">=</span> <span class="mh">0x3ff6</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">memory_size</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_end</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48</span>:
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tx_bufs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_end</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_end</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, %dk RAM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memory_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;) bad memory size (%dk).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memory_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_start</span> <span class="o">=</span> <span class="n">TX_BUF_START</span> <span class="o">+</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tx_bufs</span><span class="o">*</span><span class="n">TX_BUF_SIZE</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">buswidth</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eexp_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a word from the EtherExpress on-board serial EEPROM.</span>
<span class="cm"> * The EEPROM contains 64 words of 16 bits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__init</span> <span class="nf">eexp_hw_readeeprom</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x180</span><span class="o">|</span><span class="p">(</span><span class="n">location</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">wval</span> <span class="o">=</span> <span class="n">EC_CS</span><span class="o">|</span><span class="n">i586_RST</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">EC_CS</span><span class="o">|</span><span class="n">i586_RST</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mh">0x100</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">&gt;&gt;=</span><span class="mi">1</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">&amp;</span><span class="n">i</span><span class="p">)</span>
			<span class="n">wval</span> <span class="o">|=</span> <span class="n">EC_Wr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EC_Wr</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="o">|</span><span class="n">EC_Clk</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">();</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">wval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EC_Wr</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mh">0x8000</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">&gt;&gt;=</span><span class="mi">1</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="o">|</span><span class="n">EC_Clk</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">)</span><span class="o">&amp;</span><span class="n">EC_Rd</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">|=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
		<span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">wval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EC_CS</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="o">|</span><span class="n">EC_Clk</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">wval</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reap tx buffers and return last transmit status.</span>
<span class="cm"> * if ==0 then either:</span>
<span class="cm"> *    a) we&#39;re not transmitting anything, so why are we here?</span>
<span class="cm"> *    b) we&#39;ve died.</span>
<span class="cm"> * otherwise, Stat_Busy(return) means we&#39;ve still got some packets</span>
<span class="cm"> * to transmit, Stat_Done(return) means our buffers should be empty</span>
<span class="cm"> * again</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">eexp_hw_lasttxstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_block</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="o">==</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">tx_block</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SM_PTR</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SHADOW</span><span class="p">(</span><span class="n">tx_block</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Stat_Done</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">tx_block</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_tx_restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">Stat_NoColl</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Stat_OK</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">whatsup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
  				<span class="k">if</span> <span class="p">(</span><span class="n">Stat_Abort</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Stat_TNoCar</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">whatsup</span> <span class="o">=</span> <span class="s">&quot;aborted, no carrier&quot;</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Stat_TNoCTS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">whatsup</span> <span class="o">=</span> <span class="s">&quot;aborted, lost CTS&quot;</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Stat_TNoDMA</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">whatsup</span> <span class="o">=</span> <span class="s">&quot;FIFO underran&quot;</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Stat_TXColl</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">whatsup</span> <span class="o">=</span> <span class="s">&quot;aborted, too many collisions&quot;</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">whatsup</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: transmit %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">whatsup</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_block</span> <span class="o">==</span> <span class="n">TX_BUF_START</span><span class="o">+</span><span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tx_bufs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">TX_BUF_SIZE</span><span class="p">))</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">=</span> <span class="n">tx_block</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">=</span> <span class="n">tx_block</span> <span class="o">+=</span> <span class="n">TX_BUF_SIZE</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This should never happen. It is called when some higher routine detects</span>
<span class="cm"> * that the CU has stopped, to try to restart it from the last packet we knew</span>
<span class="cm"> * we were working on, or the idle loop if we had finished for the time.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_hw_txrestart</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_tx_restart</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="p">;</span>
	<span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="p">);</span>
	<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUstart</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">boguscount</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">failcount</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">boguscount</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">failcount</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: CU start timed out, status %04x, cmd %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">scb_rdcmd</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
				        <span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span><span class="p">);</span>
					<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUstart</span><span class="p">);</span>
					<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
					<span class="n">boguscount</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Failed to restart CU, resetting board...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">eexp_hw_init586</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Writes down the list of transmit buffers into card memory.  Each</span>
<span class="cm"> * entry consists of an 82586 transmit command, followed by a jump</span>
<span class="cm"> * pointing to itself.  When we want to transmit a packet, we write</span>
<span class="cm"> * the data into the appropriate transmit buffer and then modify the</span>
<span class="cm"> * preceding jump to point at the new transmit command.  This means that</span>
<span class="cm"> * the 586 command unit is continuously active.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_hw_txinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_block</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">curtbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">curtbuf</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">curtbuf</span><span class="o">&lt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tx_bufs</span> <span class="p">;</span> <span class="n">curtbuf</span><span class="o">++</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">tx_block</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WRITE_PTR</span><span class="p">);</span>

	        <span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">Cmd_INT</span><span class="o">|</span><span class="n">Cmd_Xmit</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mh">0x0e</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">tx_block</span><span class="o">+</span><span class="mh">0x16</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

		<span class="n">tx_block</span> <span class="o">+=</span> <span class="n">TX_BUF_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reap</span> <span class="o">=</span> <span class="n">TX_BUF_START</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">=</span> <span class="n">tx_block</span> <span class="o">-</span> <span class="n">TX_BUF_SIZE</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_link</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_start</span> <span class="o">=</span> <span class="n">tx_block</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write the circular list of receive buffer descriptors to card memory.</span>
<span class="cm"> * The end of the list isn&#39;t marked, which means that the 82586 receive</span>
<span class="cm"> * unit will loop until buffers become available (this avoids it giving us</span>
<span class="cm"> * &quot;out of resources&quot; messages).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_hw_rxinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_block</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_rx_bufs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ptr</span> <span class="o">=</span> <span class="n">rx_block</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_rx_bufs</span><span class="o">++</span><span class="p">;</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">rx_block</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">WRITE_PTR</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>  <span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">rx_block</span> <span class="o">+</span> <span class="n">RX_BUF_SIZE</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>

		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">rx_block</span> <span class="o">+</span> <span class="n">RX_BUF_SIZE</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">rx_block</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">RX_BUF_SIZE</span><span class="o">-</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">=</span> <span class="n">rx_block</span><span class="p">;</span>
		<span class="n">rx_block</span> <span class="o">+=</span> <span class="n">RX_BUF_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rx_block</span> <span class="o">&lt;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_end</span><span class="o">-</span><span class="n">RX_BUF_SIZE</span><span class="p">);</span>


	<span class="cm">/* Make first Rx frame descriptor point to first Rx buffer</span>
<span class="cm">           descriptor */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">WRITE_PTR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>

	<span class="cm">/* Close Rx frame descriptor ring */</span>
  	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">WRITE_PTR</span><span class="p">);</span>
  	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_first</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>

	<span class="cm">/* Close Rx buffer descriptor ring */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">+</span> <span class="mh">0x16</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">WRITE_PTR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">DATAPORT</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Un-reset the 586, and start the configuration sequence. We don&#39;t wait for</span>
<span class="cm"> * this to finish, but allow the interrupt handler to start the CU and RU for</span>
<span class="cm"> * us.  We can&#39;t start the receive/transmission system up before we know that</span>
<span class="cm"> * the hardware is configured correctly.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_hw_init586</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#if NET_DEBUG &gt; 6</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: eexp_hw_init586()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_loopback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">SIRQ_dis</span><span class="o">|</span><span class="n">irqrmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">],</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SET_IRQ</span><span class="p">);</span>

	<span class="cm">/* Download the startup code */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_end</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SM_PTR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">?</span><span class="mh">0x0001</span><span class="o">:</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x8006</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x8008</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x800a</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x800c</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x800e</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">start_code</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SM_PTR</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">start_code</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">start_code</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
			     <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x4000</span><span class="o">+</span><span class="n">j</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">start_code</span><span class="p">);</span> <span class="n">j</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">start_code</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
			     <span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x8000</span><span class="o">+</span><span class="n">j</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Do we want promiscuous mode or multicast? */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">CONF_PROMISC</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_PROMISC</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">i</span><span class="o">|</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">),</span>
	     <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_PROMISC</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">was_promisc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	eexp_setup_filter(dev);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Write our hardware address */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">CONF_HWADDR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_HWADDR</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
	     <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_HWADDR</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span>
	     <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_HWADDR</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>

	<span class="n">eexp_hw_txinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eexp_hw_rxinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">EEPROM_Ctrl</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rboguscount</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">rfailcount</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="mh">0x4000</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">rboguscount</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i82586 reset timed out, kicking...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
				<span class="n">rboguscount</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">rfailcount</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i82586 not responding, giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

        <span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONF_LINK</span><span class="p">);</span>
	<span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf000</span><span class="o">|</span><span class="n">SCB_CUstart</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">iboguscount</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">ifailcount</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">iboguscount</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ifailcount</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: i82586 initialization timed out, status %04x, cmd %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">scb_rdcmd</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
					<span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONF_LINK</span><span class="p">);</span>
				        <span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf000</span><span class="o">|</span><span class="n">SCB_CUstart</span><span class="p">);</span>
					<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
					<span class="n">iboguscount</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Failed to initialize i82586, giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">clear_loopback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SIRQ_en</span><span class="o">|</span><span class="n">irqrmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">],</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SET_IRQ</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#if NET_DEBUG &gt; 6</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: leaving eexp_hw_init586()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eexp_setup_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: too many multicast addresses (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">CONF_NR_MULTICAST</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_NR_MULTICAST</span><span class="p">));</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">CONF_MULTICAST</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_MULTICAST</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">)));</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">CONF_MULTICAST</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_MULTICAST</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">CONF_MULTICAST</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_MULTICAST</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set or clear the multicast filter for this adaptor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">eexp_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">kick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">was_promisc</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">outw</span><span class="p">(</span><span class="n">CONF_PROMISC</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SM_PTR</span><span class="p">);</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_PROMISC</span><span class="p">));</span>
                <span class="n">outw</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">i</span><span class="o">|</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">),</span>
                     <span class="n">ioaddr</span><span class="o">+</span><span class="n">SHADOW</span><span class="p">(</span><span class="n">CONF_PROMISC</span><span class="p">));</span>
                <span class="n">lp</span><span class="o">-&gt;</span><span class="n">was_promisc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">;</span>
                <span class="n">kick</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">eexp_setup_filter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_mc_count</span> <span class="o">!=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">kick</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kick</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oj</span><span class="p">;</span>
                <span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUsuspend</span><span class="p">);</span>
                <span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
                <span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">                printk(&quot;%s: waiting for CU to go suspended\n&quot;, dev-&gt;name);</span>
<span class="cp">#endif</span>
                <span class="n">oj</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">((</span><span class="n">SCB_CUstat</span><span class="p">(</span><span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                       <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">oj</span> <span class="o">+</span> <span class="mi">2000</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCB_CUstat</span><span class="p">(</span><span class="n">scb_status</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: warning, CU didn&#39;t stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="n">lp</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STARTED_CU</span><span class="p">);</span>
                <span class="n">scb_wrcbl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONF_LINK</span><span class="p">);</span>
                <span class="n">scb_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCB_CUstart</span><span class="p">);</span>
                <span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">+</span><span class="n">SIGNAL_CA</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * MODULE stuff</span>
<span class="cm"> */</span>

<span class="cp">#ifdef MODULE</span>

<span class="cp">#define EEXP_MAX_CARDS     4    </span><span class="cm">/* max number of cards to support */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_eexp</span><span class="p">[</span><span class="n">EEXP_MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">EEXP_MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[</span><span class="n">EEXP_MAX_CARDS</span><span class="p">];</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;EtherExpress 16 I/O base address(es)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;EtherExpress 16 IRQ number(s)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cm">/* Ideally the user would give us io=, irq= for every card.  If any parameters</span>
<span class="cm"> * are specified, we verify and then use them.  If no parameters are given, we</span>
<span class="cm"> * autoprobe for one card only.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">this_dev</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">this_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">this_dev</span> <span class="o">&lt;</span> <span class="n">EEXP_MAX_CARDS</span><span class="p">;</span> <span class="n">this_dev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">this_dev</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">this_dev</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this_dev</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;eexpress.c: Module autoprobe not recommended, give io=xx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_express_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_eexp</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="n">found</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;eexpress.c: Failed to register card at 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">this_dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">this_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">this_dev</span> <span class="o">&lt;</span> <span class="n">EEXP_MAX_CARDS</span><span class="p">;</span> <span class="n">this_dev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_eexp</span><span class="p">[</span><span class="n">this_dev</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Local Variables:</span>
<span class="cm"> *  c-file-style: &quot;linux&quot;</span>
<span class="cm"> *  tab-width: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
