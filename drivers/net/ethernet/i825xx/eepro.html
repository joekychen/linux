<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › i825xx › eepro.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>eepro.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* eepro.c: Intel EtherExpress Pro/10 device driver for Linux. */</span>
<span class="cm">/*</span>
<span class="cm">	Written 1994, 1995,1996 by Bao C. Ha.</span>

<span class="cm">	Copyright (C) 1994, 1995,1996 by Bao C. Ha.</span>

<span class="cm">	This software may be used and distributed</span>
<span class="cm">	according to the terms of the GNU General Public License,</span>
<span class="cm">	incorporated herein by reference.</span>

<span class="cm">	The author may be reached at bao.ha@srs.gov</span>
<span class="cm">	or 418 Hastings Place, Martinez, GA 30907.</span>

<span class="cm">	Things remaining to do:</span>
<span class="cm">	Better record keeping of errors.</span>
<span class="cm">	Eliminate transmit interrupt to reduce overhead.</span>
<span class="cm">	Implement &quot;concurrent processing&quot;. I won&#39;t be doing it!</span>

<span class="cm">	Bugs:</span>

<span class="cm">	If you have a problem of not detecting the 82595 during a</span>
<span class="cm">	reboot (warm reset), disable the FLASH memory should fix it.</span>
<span class="cm">	This is a compatibility hardware problem.</span>

<span class="cm">	Versions:</span>
<span class="cm">	0.13b	basic ethtool support (aris, 09/13/2004)</span>
<span class="cm">	0.13a   in memory shortage, drop packets also in board</span>
<span class="cm">		(Michael Westermann &lt;mw@microdata-pos.de&gt;, 07/30/2002)</span>
<span class="cm">	0.13    irq sharing, rewrote probe function, fixed a nasty bug in</span>
<span class="cm">		hardware_send_packet and a major cleanup (aris, 11/08/2001)</span>
<span class="cm">	0.12d	fixing a problem with single card detected as eight eth devices</span>
<span class="cm">		fixing a problem with sudden drop in card performance</span>
<span class="cm">		(chris (asdn@go2.pl), 10/29/2001)</span>
<span class="cm">	0.12c	fixing some problems with old cards (aris, 01/08/2001)</span>
<span class="cm">	0.12b	misc fixes (aris, 06/26/2000)</span>
<span class="cm">	0.12a   port of version 0.12a of 2.2.x kernels to 2.3.x</span>
<span class="cm">		(aris (aris@conectiva.com.br), 05/19/2000)</span>
<span class="cm">	0.11e   some tweaks about multiple cards support (PdP, jul/aug 1999)</span>
<span class="cm">	0.11d	added __initdata, __init stuff; call spin_lock_init</span>
<span class="cm">	        in eepro_probe1. Replaced &quot;eepro&quot; by dev-&gt;name. Augmented</span>
<span class="cm">		the code protected by spin_lock in interrupt routine</span>
<span class="cm">		(PdP, 12/12/1998)</span>
<span class="cm">	0.11c   minor cleanup (PdP, RMC, 09/12/1998)</span>
<span class="cm">	0.11b   Pascal Dupuis (dupuis@lei.ucl.ac.be): works as a module</span>
<span class="cm">	        under 2.1.xx. Debug messages are flagged as KERN_DEBUG to</span>
<span class="cm">		avoid console flooding. Added locking at critical parts. Now</span>
<span class="cm">		the dawn thing is SMP safe.</span>
<span class="cm">	0.11a   Attempt to get 2.1.xx support up (RMC)</span>
<span class="cm">	0.11	Brian Candler added support for multiple cards. Tested as</span>
<span class="cm">		a module, no idea if it works when compiled into kernel.</span>

<span class="cm">	0.10e	Rick Bressler notified me that ifconfig up;ifconfig down fails</span>
<span class="cm">		because the irq is lost somewhere. Fixed that by moving</span>
<span class="cm">		request_irq and free_irq to eepro_open and eepro_close respectively.</span>
<span class="cm">	0.10d	Ugh! Now Wakeup works. Was seriously broken in my first attempt.</span>
<span class="cm">		I&#39;ll need to find a way to specify an ioport other than</span>
<span class="cm">		the default one in the PnP case. PnP definitively sucks.</span>
<span class="cm">		And, yes, this is not the only reason.</span>
<span class="cm">	0.10c	PnP Wakeup Test for 595FX. uncomment #define PnPWakeup;</span>
<span class="cm">		to use.</span>
<span class="cm">	0.10b	Should work now with (some) Pro/10+. At least for</span>
<span class="cm">		me (and my two cards) it does. _No_ guarantee for</span>
<span class="cm">		function with non-Pro/10+ cards! (don&#39;t have any)</span>
<span class="cm">		(RMC, 9/11/96)</span>

<span class="cm">	0.10	Added support for the Etherexpress Pro/10+.  The</span>
<span class="cm">		IRQ map was changed significantly from the old</span>
<span class="cm">		pro/10.  The new interrupt map was provided by</span>
<span class="cm">		Rainer M. Canavan (Canavan@Zeus.cs.bonn.edu).</span>
<span class="cm">		(BCH, 9/3/96)</span>

<span class="cm">	0.09	Fixed a race condition in the transmit algorithm,</span>
<span class="cm">		which causes crashes under heavy load with fast</span>
<span class="cm">		pentium computers.  The performance should also</span>
<span class="cm">		improve a bit.  The size of RX buffer, and hence</span>
<span class="cm">		TX buffer, can also be changed via lilo or insmod.</span>
<span class="cm">		(BCH, 7/31/96)</span>

<span class="cm">	0.08	Implement 32-bit I/O for the 82595TX and 82595FX</span>
<span class="cm">		based lan cards.  Disable full-duplex mode if TPE</span>
<span class="cm">		is not used.  (BCH, 4/8/96)</span>

<span class="cm">	0.07a	Fix a stat report which counts every packet as a</span>
<span class="cm">		heart-beat failure. (BCH, 6/3/95)</span>

<span class="cm">	0.07	Modified to support all other 82595-based lan cards.</span>
<span class="cm">		The IRQ vector of the EtherExpress Pro will be set</span>
<span class="cm">		according to the value saved in the EEPROM.  For other</span>
<span class="cm">		cards, I will do autoirq_request() to grab the next</span>
<span class="cm">		available interrupt vector. (BCH, 3/17/95)</span>

<span class="cm">	0.06a,b	Interim released.  Minor changes in the comments and</span>
<span class="cm">		print out format. (BCH, 3/9/95 and 3/14/95)</span>

<span class="cm">	0.06	First stable release that I am comfortable with. (BCH,</span>
<span class="cm">		3/2/95)</span>

<span class="cm">	0.05	Complete testing of multicast. (BCH, 2/23/95)</span>

<span class="cm">	0.04	Adding multicast support. (BCH, 2/14/95)</span>

<span class="cm">	0.03	First widely alpha release for public testing.</span>
<span class="cm">		(BCH, 2/14/95)</span>

<span class="cm">*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;eepro.c: v0.13b 09/13/2004 aris@cathedrallabs.org</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cm">/*</span>
<span class="cm">  Sources:</span>

<span class="cm">	This driver wouldn&#39;t have been written without the availability</span>
<span class="cm">	of the Crynwr&#39;s Lan595 driver source code.  It helps me to</span>
<span class="cm">	familiarize with the 82595 chipset while waiting for the Intel</span>
<span class="cm">	documentation.  I also learned how to detect the 82595 using</span>
<span class="cm">	the packet driver&#39;s technique.</span>

<span class="cm">	This driver is written by cutting and pasting the skeleton.c driver</span>
<span class="cm">	provided by Donald Becker.  I also borrowed the EEPROM routine from</span>
<span class="cm">	Donald Becker&#39;s 82586 driver.</span>

<span class="cm">	Datasheet for the Intel 82595 (including the TX and FX version). It</span>
<span class="cm">	provides just enough info that the casual reader might think that it</span>
<span class="cm">	documents the i82595.</span>

<span class="cm">	The User Manual for the 82595.  It provides a lot of the missing</span>
<span class="cm">	information.</span>

<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;eepro&quot;</span>
<span class="cp">#define DRV_VERSION &quot;0.13c&quot;</span>

<span class="cp">#define compat_dev_kfree_skb( skb, mode ) dev_kfree_skb( (skb) )</span>
<span class="cm">/* I had reports of looong delays with SLOW_DOWN defined as udelay(2) */</span>
<span class="cp">#define SLOW_DOWN inb(0x80)</span>
<span class="cm">/* udelay(2) */</span>
<span class="cp">#define compat_init_data     __initdata</span>
<span class="k">enum</span> <span class="n">iftype</span> <span class="p">{</span> <span class="n">AUI</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">BNC</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">TPE</span><span class="o">=</span><span class="mi">2</span> <span class="p">};</span>

<span class="cm">/* First, a few definitions that the brave might change. */</span>
<span class="cm">/* A zero-terminated list of I/O addresses to be probed. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eepro_portlist</span><span class="p">[]</span> <span class="n">compat_init_data</span> <span class="o">=</span>
   <span class="p">{</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x210</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2C0</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="cm">/* note: 0x300 is default, the 595FX supports ALL IO Ports</span>
<span class="cm">  from 0x000 to 0x3F0, some of which are reserved in PCs */</span>

<span class="cm">/* To try the (not-really PnP Wakeup: */</span>
<span class="cm">/*</span>
<span class="cm">#define PnPWakeup</span>
<span class="cm">*/</span>

<span class="cm">/* use 0 for production, 1 for verification, &gt;2 for debug */</span>
<span class="cp">#ifndef NET_DEBUG</span>
<span class="cp">#define NET_DEBUG 0</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">net_debug</span> <span class="o">=</span> <span class="n">NET_DEBUG</span><span class="p">;</span>

<span class="cm">/* The number of low I/O ports used by the ethercard. */</span>
<span class="cp">#define EEPRO_IO_EXTENT	16</span>

<span class="cm">/* Different 82595 chips */</span>
<span class="cp">#define	LAN595		0</span>
<span class="cp">#define	LAN595TX	1</span>
<span class="cp">#define	LAN595FX	2</span>
<span class="cp">#define	LAN595FX_10ISA	3</span>

<span class="cm">/* Information that need to be kept for each board. */</span>
<span class="k">struct</span> <span class="n">eepro_local</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">rx_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tx_start</span><span class="p">;</span> <span class="cm">/* start of the transmit chain */</span>
	<span class="kt">int</span> <span class="n">tx_last</span><span class="p">;</span>  <span class="cm">/* pointer to last packet in the transmit chain */</span>
	<span class="kt">unsigned</span> <span class="n">tx_end</span><span class="p">;</span>   <span class="cm">/* end of the transmit chain (plus 1) */</span>
	<span class="kt">int</span> <span class="n">eepro</span><span class="p">;</span>	<span class="cm">/* 1 for the EtherExpress Pro/10,</span>
<span class="cm">			   2 for the EtherExpress Pro/10+,</span>
<span class="cm">			   3 for the EtherExpress 10 (blue cards),</span>
<span class="cm">			   0 for other 82595-based lan cards. */</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>	<span class="cm">/* a flag to indicate if this is a TX or FX</span>
<span class="cm">				   version of the 82595 chip. */</span>
	<span class="kt">int</span> <span class="n">stepping</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span> <span class="cm">/* Serializing lock  */</span>

	<span class="kt">unsigned</span> <span class="n">rcv_ram</span><span class="p">;</span>	<span class="cm">/* pre-calculated space for rx */</span>
	<span class="kt">unsigned</span> <span class="n">xmt_ram</span><span class="p">;</span>	<span class="cm">/* pre-calculated space for tx */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xmt_bar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xmt_lower_limit_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xmt_upper_limit_reg</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">xmt_lower_limit</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">xmt_upper_limit</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rcv_lower_limit</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rcv_upper_limit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">eeprom_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">word</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* The station (ethernet) address prefix, used for IDing the board. */</span>
<span class="cp">#define SA_ADDR0 0x00	</span><span class="cm">/* Etherexpress Pro/10 */</span><span class="cp"></span>
<span class="cp">#define SA_ADDR1 0xaa</span>
<span class="cp">#define SA_ADDR2 0x00</span>

<span class="cp">#define GetBit(x,y) ((x &amp; (1&lt;&lt;y))&gt;&gt;y)</span>

<span class="cm">/* EEPROM Word 0: */</span>
<span class="cp">#define ee_PnP       0  </span><span class="cm">/* Plug &#39;n Play enable bit */</span><span class="cp"></span>
<span class="cp">#define ee_Word1     1  </span><span class="cm">/* Word 1? */</span><span class="cp"></span>
<span class="cp">#define ee_BusWidth  2  </span><span class="cm">/* 8/16 bit */</span><span class="cp"></span>
<span class="cp">#define ee_FlashAddr 3  </span><span class="cm">/* Flash Address */</span><span class="cp"></span>
<span class="cp">#define ee_FlashMask 0x7   </span><span class="cm">/* Mask */</span><span class="cp"></span>
<span class="cp">#define ee_AutoIO    6  </span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define ee_reserved0 7  </span><span class="cm">/* =0! */</span><span class="cp"></span>
<span class="cp">#define ee_Flash     8  </span><span class="cm">/* Flash there? */</span><span class="cp"></span>
<span class="cp">#define ee_AutoNeg   9  </span><span class="cm">/* Auto Negotiation enabled? */</span><span class="cp"></span>
<span class="cp">#define ee_IO0       10 </span><span class="cm">/* IO Address LSB */</span><span class="cp"></span>
<span class="cp">#define ee_IO0Mask   0x </span><span class="cm">/*...*/</span><span class="cp"></span>
<span class="cp">#define ee_IO1       15 </span><span class="cm">/* IO MSB */</span><span class="cp"></span>

<span class="cm">/* EEPROM Word 1: */</span>
<span class="cp">#define ee_IntSel    0   </span><span class="cm">/* Interrupt */</span><span class="cp"></span>
<span class="cp">#define ee_IntMask   0x7</span>
<span class="cp">#define ee_LI        3   </span><span class="cm">/* Link Integrity 0= enabled */</span><span class="cp"></span>
<span class="cp">#define ee_PC        4   </span><span class="cm">/* Polarity Correction 0= enabled */</span><span class="cp"></span>
<span class="cp">#define ee_TPE_AUI   5   </span><span class="cm">/* PortSelection 1=TPE */</span><span class="cp"></span>
<span class="cp">#define ee_Jabber    6   </span><span class="cm">/* Jabber prevention 0= enabled */</span><span class="cp"></span>
<span class="cp">#define ee_AutoPort  7   </span><span class="cm">/* Auto Port Selection 1= Disabled */</span><span class="cp"></span>
<span class="cp">#define ee_SMOUT     8   </span><span class="cm">/* SMout Pin Control 0= Input */</span><span class="cp"></span>
<span class="cp">#define ee_PROM      9   </span><span class="cm">/* Flash EPROM / PROM 0=Flash */</span><span class="cp"></span>
<span class="cp">#define ee_reserved1 10  </span><span class="cm">/* .. 12 =0! */</span><span class="cp"></span>
<span class="cp">#define ee_AltReady  13  </span><span class="cm">/* Alternate Ready, 0=normal */</span><span class="cp"></span>
<span class="cp">#define ee_reserved2 14  </span><span class="cm">/* =0! */</span><span class="cp"></span>
<span class="cp">#define ee_Duplex    15</span>

<span class="cm">/* Word2,3,4: */</span>
<span class="cp">#define ee_IA5       0 </span><span class="cm">/*bit start for individual Addr Byte 5 */</span><span class="cp"></span>
<span class="cp">#define ee_IA4       8 </span><span class="cm">/*bit start for individual Addr Byte 5 */</span><span class="cp"></span>
<span class="cp">#define ee_IA3       0 </span><span class="cm">/*bit start for individual Addr Byte 5 */</span><span class="cp"></span>
<span class="cp">#define ee_IA2       8 </span><span class="cm">/*bit start for individual Addr Byte 5 */</span><span class="cp"></span>
<span class="cp">#define ee_IA1       0 </span><span class="cm">/*bit start for individual Addr Byte 5 */</span><span class="cp"></span>
<span class="cp">#define ee_IA0       8 </span><span class="cm">/*bit start for individual Addr Byte 5 */</span><span class="cp"></span>

<span class="cm">/* Word 5: */</span>
<span class="cp">#define ee_BNC_TPE   0 </span><span class="cm">/* 0=TPE */</span><span class="cp"></span>
<span class="cp">#define ee_BootType  1 </span><span class="cm">/* 00=None, 01=IPX, 10=ODI, 11=NDIS */</span><span class="cp"></span>
<span class="cp">#define ee_BootTypeMask 0x3</span>
<span class="cp">#define ee_NumConn   3  </span><span class="cm">/* Number of Connections 0= One or Two */</span><span class="cp"></span>
<span class="cp">#define ee_FlashSock 4  </span><span class="cm">/* Presence of Flash Socket 0= Present */</span><span class="cp"></span>
<span class="cp">#define ee_PortTPE   5</span>
<span class="cp">#define ee_PortBNC   6</span>
<span class="cp">#define ee_PortAUI   7</span>
<span class="cp">#define ee_PowerMgt  10 </span><span class="cm">/* 0= disabled */</span><span class="cp"></span>
<span class="cp">#define ee_CP        13 </span><span class="cm">/* Concurrent Processing */</span><span class="cp"></span>
<span class="cp">#define ee_CPMask    0x7</span>

<span class="cm">/* Word 6: */</span>
<span class="cp">#define ee_Stepping  0 </span><span class="cm">/* Stepping info */</span><span class="cp"></span>
<span class="cp">#define ee_StepMask  0x0F</span>
<span class="cp">#define ee_BoardID   4 </span><span class="cm">/* Manucaturer Board ID, reserved */</span><span class="cp"></span>
<span class="cp">#define ee_BoardMask 0x0FFF</span>

<span class="cm">/* Word 7: */</span>
<span class="cp">#define ee_INT_TO_IRQ 0 </span><span class="cm">/* int to IRQ Mapping  = 0x1EB8 for Pro/10+ */</span><span class="cp"></span>
<span class="cp">#define ee_FX_INT2IRQ 0x1EB8 </span><span class="cm">/* the _only_ mapping allowed for FX chips */</span><span class="cp"></span>

<span class="cm">/*..*/</span>
<span class="cp">#define ee_SIZE 0x40 </span><span class="cm">/* total EEprom Size */</span><span class="cp"></span>
<span class="cp">#define ee_Checksum 0xBABA </span><span class="cm">/* initial and final value for adding checksum */</span><span class="cp"></span>


<span class="cm">/* Card identification via EEprom:   */</span>
<span class="cp">#define ee_addr_vendor 0x10  </span><span class="cm">/* Word offset for EISA Vendor ID */</span><span class="cp"></span>
<span class="cp">#define ee_addr_id 0x11      </span><span class="cm">/* Word offset for Card ID */</span><span class="cp"></span>
<span class="cp">#define ee_addr_SN 0x12      </span><span class="cm">/* Serial Number */</span><span class="cp"></span>
<span class="cp">#define ee_addr_CRC_8 0x14   </span><span class="cm">/* CRC over last thee Bytes */</span><span class="cp"></span>


<span class="cp">#define ee_vendor_intel0 0x25  </span><span class="cm">/* Vendor ID Intel */</span><span class="cp"></span>
<span class="cp">#define ee_vendor_intel1 0xD4</span>
<span class="cp">#define ee_id_eepro10p0 0x10   </span><span class="cm">/* ID for eepro/10+ */</span><span class="cp"></span>
<span class="cp">#define ee_id_eepro10p1 0x31</span>

<span class="cp">#define TX_TIMEOUT ((4*HZ)/10)</span>

<span class="cm">/* Index to functions, as function prototypes. */</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">eepro_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoprobe</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">eepro_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">eepro_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">eepro_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> 	<span class="n">eepro_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> 	<span class="n">eepro_transmit_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">eepro_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">eepro_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">eepro_grab_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">			Details of the i82595.</span>

<span class="cm">You will need either the datasheet or the user manual to understand what</span>
<span class="cm">is going on here.  The 82595 is very different from the 82586, 82593.</span>

<span class="cm">The receive algorithm in eepro_rx() is just an implementation of the</span>
<span class="cm">RCV ring structure that the Intel 82595 imposes at the hardware level.</span>
<span class="cm">The receive buffer is set at 24K, and the transmit buffer is 8K.  I</span>
<span class="cm">am assuming that the total buffer memory is 32K, which is true for the</span>
<span class="cm">Intel EtherExpress Pro/10.  If it is less than that on a generic card,</span>
<span class="cm">the driver will be broken.</span>

<span class="cm">The transmit algorithm in the hardware_send_packet() is similar to the</span>
<span class="cm">one in the eepro_rx().  The transmit buffer is a ring linked list.</span>
<span class="cm">I just queue the next available packet to the end of the list.  In my</span>
<span class="cm">system, the 82595 is so fast that the list seems to always contain a</span>
<span class="cm">single packet.  In other systems with faster computers and more congested</span>
<span class="cm">network traffics, the ring linked list should improve performance by</span>
<span class="cm">allowing up to 8K worth of packets to be queued.</span>

<span class="cm">The sizes of the receive and transmit buffers can now be changed via lilo</span>
<span class="cm">or insmod.  Lilo uses the appended line &quot;ether=io,irq,debug,rx-buffer,eth0&quot;</span>
<span class="cm">where rx-buffer is in KB unit.  Modules uses the parameter mem which is</span>
<span class="cm">also in KB unit, for example &quot;insmod io=io-address irq=0 mem=rx-buffer.&quot;</span>
<span class="cm">The receive buffer has to be more than 3K or less than 29K.  Otherwise,</span>
<span class="cm">it is reset to the default of 24K, and, hence, 8K for the trasnmit</span>
<span class="cm">buffer (transmit-buffer = 32K - receive-buffer).</span>

<span class="cm">*/</span>
<span class="cp">#define RAM_SIZE        0x8000</span>

<span class="cp">#define RCV_HEADER      8</span>
<span class="cp">#define RCV_DEFAULT_RAM 0x6000</span>

<span class="cp">#define XMT_HEADER      8</span>
<span class="cp">#define XMT_DEFAULT_RAM	(RAM_SIZE - RCV_DEFAULT_RAM)</span>

<span class="cp">#define XMT_START_PRO	RCV_DEFAULT_RAM</span>
<span class="cp">#define XMT_START_10	0x0000</span>
<span class="cp">#define RCV_START_PRO	0x0000</span>
<span class="cp">#define RCV_START_10	XMT_DEFAULT_RAM</span>

<span class="cp">#define	RCV_DONE	0x0008</span>
<span class="cp">#define	RX_OK		0x2000</span>
<span class="cp">#define	RX_ERROR	0x0d81</span>

<span class="cp">#define	TX_DONE_BIT	0x0080</span>
<span class="cp">#define	TX_OK		0x2000</span>
<span class="cp">#define	CHAIN_BIT	0x8000</span>
<span class="cp">#define	XMT_STATUS	0x02</span>
<span class="cp">#define	XMT_CHAIN	0x04</span>
<span class="cp">#define	XMT_COUNT	0x06</span>

<span class="cp">#define	BANK0_SELECT	0x00</span>
<span class="cp">#define	BANK1_SELECT	0x40</span>
<span class="cp">#define	BANK2_SELECT	0x80</span>

<span class="cm">/* Bank 0 registers */</span>
<span class="cp">#define	COMMAND_REG	0x00	</span><span class="cm">/* Register 0 */</span><span class="cp"></span>
<span class="cp">#define	MC_SETUP	0x03</span>
<span class="cp">#define	XMT_CMD		0x04</span>
<span class="cp">#define	DIAGNOSE_CMD	0x07</span>
<span class="cp">#define	RCV_ENABLE_CMD	0x08</span>
<span class="cp">#define	RCV_DISABLE_CMD	0x0a</span>
<span class="cp">#define	STOP_RCV_CMD	0x0b</span>
<span class="cp">#define	RESET_CMD	0x0e</span>
<span class="cp">#define	POWER_DOWN_CMD	0x18</span>
<span class="cp">#define	RESUME_XMT_CMD	0x1c</span>
<span class="cp">#define	SEL_RESET_CMD	0x1e</span>
<span class="cp">#define	STATUS_REG	0x01	</span><span class="cm">/* Register 1 */</span><span class="cp"></span>
<span class="cp">#define	RX_INT		0x02</span>
<span class="cp">#define	TX_INT		0x04</span>
<span class="cp">#define	EXEC_STATUS	0x30</span>
<span class="cp">#define	ID_REG		0x02	</span><span class="cm">/* Register 2	*/</span><span class="cp"></span>
<span class="cp">#define	R_ROBIN_BITS	0xc0	</span><span class="cm">/* round robin counter */</span><span class="cp"></span>
<span class="cp">#define	ID_REG_MASK	0x2c</span>
<span class="cp">#define	ID_REG_SIG	0x24</span>
<span class="cp">#define	AUTO_ENABLE	0x10</span>
<span class="cp">#define	INT_MASK_REG	0x03	</span><span class="cm">/* Register 3	*/</span><span class="cp"></span>
<span class="cp">#define	RX_STOP_MASK	0x01</span>
<span class="cp">#define	RX_MASK		0x02</span>
<span class="cp">#define	TX_MASK		0x04</span>
<span class="cp">#define	EXEC_MASK	0x08</span>
<span class="cp">#define	ALL_MASK	0x0f</span>
<span class="cp">#define	IO_32_BIT	0x10</span>
<span class="cp">#define	RCV_BAR		0x04	</span><span class="cm">/* The following are word (16-bit) registers */</span><span class="cp"></span>
<span class="cp">#define	RCV_STOP	0x06</span>

<span class="cp">#define	XMT_BAR_PRO	0x0a</span>
<span class="cp">#define	XMT_BAR_10	0x0b</span>

<span class="cp">#define	HOST_ADDRESS_REG	0x0c</span>
<span class="cp">#define	IO_PORT		0x0e</span>
<span class="cp">#define	IO_PORT_32_BIT	0x0c</span>

<span class="cm">/* Bank 1 registers */</span>
<span class="cp">#define	REG1	0x01</span>
<span class="cp">#define	WORD_WIDTH	0x02</span>
<span class="cp">#define	INT_ENABLE	0x80</span>
<span class="cp">#define INT_NO_REG	0x02</span>
<span class="cp">#define	RCV_LOWER_LIMIT_REG	0x08</span>
<span class="cp">#define	RCV_UPPER_LIMIT_REG	0x09</span>

<span class="cp">#define	XMT_LOWER_LIMIT_REG_PRO 0x0a</span>
<span class="cp">#define	XMT_UPPER_LIMIT_REG_PRO 0x0b</span>
<span class="cp">#define	XMT_LOWER_LIMIT_REG_10  0x0b</span>
<span class="cp">#define	XMT_UPPER_LIMIT_REG_10  0x0a</span>

<span class="cm">/* Bank 2 registers */</span>
<span class="cp">#define	XMT_Chain_Int	0x20	</span><span class="cm">/* Interrupt at the end of the transmit chain */</span><span class="cp"></span>
<span class="cp">#define	XMT_Chain_ErrStop	0x40 </span><span class="cm">/* Interrupt at the end of the chain even if there are errors */</span><span class="cp"></span>
<span class="cp">#define	RCV_Discard_BadFrame	0x80 </span><span class="cm">/* Throw bad frames away, and continue to receive others */</span><span class="cp"></span>
<span class="cp">#define	REG2		0x02</span>
<span class="cp">#define	PRMSC_Mode	0x01</span>
<span class="cp">#define	Multi_IA	0x20</span>
<span class="cp">#define	REG3		0x03</span>
<span class="cp">#define	TPE_BIT		0x04</span>
<span class="cp">#define	BNC_BIT		0x20</span>
<span class="cp">#define	REG13		0x0d</span>
<span class="cp">#define	FDX		0x00</span>
<span class="cp">#define	A_N_ENABLE	0x02</span>

<span class="cp">#define	I_ADD_REG0	0x04</span>
<span class="cp">#define	I_ADD_REG1	0x05</span>
<span class="cp">#define	I_ADD_REG2	0x06</span>
<span class="cp">#define	I_ADD_REG3	0x07</span>
<span class="cp">#define	I_ADD_REG4	0x08</span>
<span class="cp">#define	I_ADD_REG5	0x09</span>

<span class="cp">#define	EEPROM_REG_PRO 0x0a</span>
<span class="cp">#define	EEPROM_REG_10  0x0b</span>

<span class="cp">#define EESK 0x01</span>
<span class="cp">#define EECS 0x02</span>
<span class="cp">#define EEDI 0x04</span>
<span class="cp">#define EEDO 0x08</span>

<span class="cm">/* do a full reset */</span>
<span class="cp">#define eepro_reset(ioaddr) outb(RESET_CMD, ioaddr)</span>

<span class="cm">/* do a nice reset */</span>
<span class="cp">#define eepro_sel_reset(ioaddr) 	{ \</span>
<span class="cp">					outb(SEL_RESET_CMD, ioaddr); \</span>
<span class="cp">					SLOW_DOWN; \</span>
<span class="cp">					SLOW_DOWN; \</span>
<span class="cp">					}</span>

<span class="cm">/* disable all interrupts */</span>
<span class="cp">#define eepro_dis_int(ioaddr) outb(ALL_MASK, ioaddr + INT_MASK_REG)</span>

<span class="cm">/* clear all interrupts */</span>
<span class="cp">#define eepro_clear_int(ioaddr) outb(ALL_MASK, ioaddr + STATUS_REG)</span>

<span class="cm">/* enable tx/rx */</span>
<span class="cp">#define eepro_en_int(ioaddr) outb(ALL_MASK &amp; ~(RX_MASK | TX_MASK), \</span>
<span class="cp">							ioaddr + INT_MASK_REG)</span>

<span class="cm">/* enable exec event interrupt */</span>
<span class="cp">#define eepro_en_intexec(ioaddr) outb(ALL_MASK &amp; ~(EXEC_MASK), ioaddr + INT_MASK_REG)</span>

<span class="cm">/* enable rx */</span>
<span class="cp">#define eepro_en_rx(ioaddr) outb(RCV_ENABLE_CMD, ioaddr)</span>

<span class="cm">/* disable rx */</span>
<span class="cp">#define eepro_dis_rx(ioaddr) outb(RCV_DISABLE_CMD, ioaddr)</span>

<span class="cm">/* switch bank */</span>
<span class="cp">#define eepro_sw2bank0(ioaddr) outb(BANK0_SELECT, ioaddr)</span>
<span class="cp">#define eepro_sw2bank1(ioaddr) outb(BANK1_SELECT, ioaddr)</span>
<span class="cp">#define eepro_sw2bank2(ioaddr) outb(BANK2_SELECT, ioaddr)</span>

<span class="cm">/* enable interrupt line */</span>
<span class="cp">#define eepro_en_intline(ioaddr) outb(inb(ioaddr + REG1) | INT_ENABLE,\</span>
<span class="cp">				ioaddr + REG1)</span>

<span class="cm">/* disable interrupt line */</span>
<span class="cp">#define eepro_dis_intline(ioaddr) outb(inb(ioaddr + REG1) &amp; 0x7f, \</span>
<span class="cp">				ioaddr + REG1);</span>

<span class="cm">/* set diagnose flag */</span>
<span class="cp">#define eepro_diag(ioaddr) outb(DIAGNOSE_CMD, ioaddr)</span>

<span class="cm">/* ack for rx int */</span>
<span class="cp">#define eepro_ack_rx(ioaddr) outb (RX_INT, ioaddr + STATUS_REG)</span>

<span class="cm">/* ack for tx int */</span>
<span class="cp">#define eepro_ack_tx(ioaddr) outb (TX_INT, ioaddr + STATUS_REG)</span>

<span class="cm">/* a complete sel reset */</span>
<span class="cp">#define eepro_complete_selreset(ioaddr) { \</span>
<span class="cp">						dev-&gt;stats.tx_errors++;\</span>
<span class="cp">						eepro_sel_reset(ioaddr);\</span>
<span class="cp">						lp-&gt;tx_end = \</span>
<span class="cp">							lp-&gt;xmt_lower_limit;\</span>
<span class="cp">						lp-&gt;tx_start = lp-&gt;tx_end;\</span>
<span class="cp">						lp-&gt;tx_last = 0;\</span>
<span class="cp">						dev-&gt;trans_start = jiffies;\</span>
<span class="cp">						netif_wake_queue(dev);\</span>
<span class="cp">						eepro_en_rx(ioaddr);\</span>
<span class="cp">					}</span>

<span class="cm">/* Check for a network adaptor of this type, and return &#39;0&#39; if one exists.</span>
<span class="cm">   If dev-&gt;base_addr == 0, probe all likely locations.</span>
<span class="cm">   If dev-&gt;base_addr == 1, always return failure.</span>
<span class="cm">   If dev-&gt;base_addr == 2, allocate space for the device and return success</span>
<span class="cm">   (detachable devices only).</span>
<span class="cm">   */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_eepro_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base_addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef PnPWakeup</span>
	<span class="cm">/* XXXX for multiple cards should this only be run once? */</span>

	<span class="cm">/* Wakeup: */</span>
	<span class="cp">#define WakeupPort 0x279</span>
	<span class="cp">#define WakeupSeq    {0x6A, 0xB5, 0xDA, 0xED, 0xF6, 0xFB, 0x7D, 0xBE,\</span>
<span class="cp">	                      0xDF, 0x6F, 0x37, 0x1B, 0x0D, 0x86, 0xC3, 0x61,\</span>
<span class="cp">	                      0xB0, 0x58, 0x2C, 0x16, 0x8B, 0x45, 0xA2, 0xD1,\</span>
<span class="cp">	                      0xE8, 0x74, 0x3A, 0x9D, 0xCE, 0xE7, 0x73, 0x43}</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">WS</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="o">=</span><span class="n">WakeupSeq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">WakeupPort</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;eepro wakeup&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Waking UP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">WakeupPort</span><span class="p">);</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">WakeupPort</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb_p</span><span class="p">(</span><span class="n">WS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">WakeupPort</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;: %#x &quot;</span><span class="p">,</span><span class="n">WS</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="n">release_region</span><span class="p">(</span><span class="n">WakeupPort</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PnP wakeup region busy!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base_addr</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span>		<span class="cm">/* Check a single specified location. */</span>
		<span class="k">return</span> <span class="n">eepro_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Don&#39;t probe at all. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eepro_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">eepro_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eepro_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">eepro_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eepro_local</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_eepro_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">printEEPROMInfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">ee_Checksum</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ee_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Checksum: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">j</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">Word</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Word0:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Plug &#39;n Pray: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_PnP</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Buswidth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_BusWidth</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span> <span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; AutoNegotiation: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_AutoNeg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; IO Address: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Word</span><span class="o">&gt;&gt;</span><span class="n">ee_IO0</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">Word</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Word1:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; INT: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Word</span> <span class="o">&amp;</span> <span class="n">ee_IntMask</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; LI: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_LI</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PC: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_PC</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; TPE/AUI: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_TPE_AUI</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Jabber: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_Jabber</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; AutoPort: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_AutoPort</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Duplex: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_Duplex</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">Word</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Word5:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; BNC: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_BNC_TPE</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; NumConnectors: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_NumConn</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Has &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_PortTPE</span><span class="p">))</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TPE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_PortBNC</span><span class="p">))</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;BNC &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">ee_PortAUI</span><span class="p">))</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;AUI &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;port(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">Word</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Word6:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Stepping: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="n">ee_StepMask</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; BoardID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">Word</span><span class="o">&gt;&gt;</span><span class="n">ee_BoardID</span><span class="p">);</span>

	<span class="n">Word</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Word7:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; INT to IRQ:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">Word</span><span class="p">,</span><span class="n">i</span><span class="p">))</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; INT%d -&gt; IRQ %d;&quot;</span><span class="p">,</span><span class="n">j</span><span class="o">++</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* function to recalculate the limits of buffer based on rcv_ram */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">eepro_recalc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span>	<span class="n">lp</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_ram</span> <span class="o">=</span> <span class="n">RAM_SIZE</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_ram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">==</span> <span class="n">LAN595FX_10ISA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span> <span class="o">=</span> <span class="n">XMT_START_10</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_ram</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_lower_limit</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_ram</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">RAM_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_lower_limit</span> <span class="o">=</span> <span class="n">RCV_START_PRO</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_ram</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_ram</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">RAM_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* prints boot-time info */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">eepro_print_info</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span>	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>		<span class="n">ifmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;AUI&quot;</span><span class="p">,</span> <span class="s">&quot;10Base2&quot;</span><span class="p">,</span> <span class="s">&quot;10BaseT&quot;</span><span class="p">};</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">ID_REG</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; id: %#x &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; io: %#x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LAN595FX_10ISA</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Intel EtherExpress 10 ISA</span><span class="se">\n</span><span class="s"> at %#x,&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LAN595FX</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Intel EtherExpress Pro/10+ ISA</span><span class="se">\n</span><span class="s"> at %#x,&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LAN595TX</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Intel EtherExpress Pro/10 ISA at %#x,&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LAN595</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Intel 82595-based lan card at %#x,&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %pM&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;, %dK RCV buffer&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_ram</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, IRQ %d, %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ifmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="cm">/* bit 13 of EEPROM word 5 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Concurrent Processing is &quot;</span>
				<span class="s">&quot;enabled but not used!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check the station address for the manufacturer&#39;s code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">)</span>
		<span class="n">printEEPROMInfo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">eepro_ethtool_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">eepro_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
 	<span class="p">.</span><span class="n">ndo_open</span>               <span class="o">=</span> <span class="n">eepro_open</span><span class="p">,</span>
 	<span class="p">.</span><span class="n">ndo_stop</span>               <span class="o">=</span> <span class="n">eepro_close</span><span class="p">,</span>
 	<span class="p">.</span><span class="n">ndo_start_xmit</span>    	<span class="o">=</span> <span class="n">eepro_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
 	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">eepro_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This is the real probe routine.  Linux has a history of friendly device</span>
<span class="cm">   probes on the ISA bus.  A good device probe avoids doing writes, and</span>
<span class="cm">   verifies that the correct device exists and functions.  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eepro_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoprobe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">station_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">id</span><span class="p">,</span> <span class="n">counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Grab the region so we can find another board if autoIRQ fails. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEPRO_IO_EXTENT</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autoprobe</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EEPRO: io-port 0x%04x in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now, we are going to check for the signature of the</span>
<span class="cm">	   ID_REG (register 2 of bank 0) */</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ID_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">ID_REG_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ID_REG_SIG</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* We seem to have the 82595 signature, let&#39;s</span>
<span class="cm">	   play with its counter (last 2 bits of</span>
<span class="cm">	   register 2 of bank 0) to be sure. */</span>

	<span class="n">counter</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="n">R_ROBIN_BITS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ID_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">R_ROBIN_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">counter</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eepro_local</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_bar</span> <span class="o">=</span> <span class="n">XMT_BAR_PRO</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit_reg</span> <span class="o">=</span> <span class="n">XMT_LOWER_LIMIT_REG_PRO</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit_reg</span> <span class="o">=</span> <span class="n">XMT_UPPER_LIMIT_REG_PRO</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">eeprom_reg</span> <span class="o">=</span> <span class="n">EEPROM_REG_PRO</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Now, get the ethernet hardware address from</span>
<span class="cm">	   the EEPROM */</span>
	<span class="n">station_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* FIXME - find another way to know that we&#39;ve found</span>
<span class="cm">	 * an Etherexpress 10</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">station_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0000</span> <span class="o">||</span> <span class="n">station_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">=</span> <span class="n">LAN595FX_10ISA</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">eeprom_reg</span> <span class="o">=</span> <span class="n">EEPROM_REG_10</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit_reg</span> <span class="o">=</span> <span class="n">XMT_LOWER_LIMIT_REG_10</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit_reg</span> <span class="o">=</span> <span class="n">XMT_UPPER_LIMIT_REG_10</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_bar</span> <span class="o">=</span> <span class="n">XMT_BAR_10</span><span class="p">;</span>
		<span class="n">station_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* get all words at once. will be used here and for ethtool */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">station_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">station_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">ee_FX_INT2IRQ</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">station_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">SA_ADDR1</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the &#39;dev&#39; fields. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">station_addr</span><span class="p">)[</span><span class="mi">5</span><span class="o">-</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* RX buffer must be more than 3K and less than 29K */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">&lt;</span> <span class="mi">3072</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">&gt;</span> <span class="mi">29696</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_ram</span> <span class="o">=</span> <span class="n">RCV_DEFAULT_RAM</span><span class="p">;</span>

	<span class="cm">/* calculate {xmt,rcv}_{lower,upper}_limit */</span>
	<span class="n">eepro_recalc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ee_BNC_TPE</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">BNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">TPE</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 		<span class="cm">/* Mask off INT number */</span>
 		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
 		<span class="kt">unsigned</span> <span class="n">irqMask</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

 		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
 			<span class="n">irqMask</span> <span class="o">&amp;=</span> <span class="n">irqMask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

 		<span class="n">count</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">irqMask</span><span class="p">);</span>

 		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
 			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

 		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
 			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; Duh! illegal interrupt vector stored in EEPROM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
 			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
 		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
 			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
 		<span class="p">}</span>
 	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">eepro_netdev_ops</span><span class="p">;</span>
 	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">eepro_ethtool_ops</span><span class="p">;</span>

	<span class="cm">/* print boot time info */</span>
	<span class="n">eepro_print_info</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* reset 82595 */</span>
	<span class="n">eepro_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="nl">err:</span>
 	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EEPRO_IO_EXTENT</span><span class="p">);</span>
 	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Open/initialize the board.  This is called (in the current kernel)</span>
<span class="cm">   sometime after booting when the &#39;ifconfig&#39; program is run.</span>

<span class="cm">   This routine should set everything up anew at each open, even</span>
<span class="cm">   registers that &quot;should&quot; only need to be set once at boot, so that</span>
<span class="cm">   there is non-reboot way to recover if something goes wrong.</span>
<span class="cm">   */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">irqrmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">irqrmap2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="nf">eepro_grab_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">irqlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">irqp</span> <span class="o">=</span> <span class="n">irqlist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp_reg</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">eepro_sw2bank1</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 1 now */</span>

	<span class="cm">/* Enable the interrupt line. */</span>
	<span class="n">eepro_en_intline</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* be CAREFUL, BANK 0 now */</span>
	<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* clear all interrupts */</span>
	<span class="n">eepro_clear_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Let EXEC event to interrupt */</span>
	<span class="n">eepro_en_intexec</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">eepro_sw2bank1</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 1 now */</span>

		<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_NO_REG</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqrmap</span><span class="p">[</span><span class="o">*</span><span class="n">irqp</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_NO_REG</span><span class="p">);</span>

		<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Switch back to Bank 0 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span> <span class="p">(</span><span class="o">*</span><span class="n">irqp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;bogus&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask</span><span class="p">;</span>
			<span class="cm">/* Twinkle the interrupt, and check if it&#39;s seen */</span>
			<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>

			<span class="n">eepro_diag</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* RESET the 82595 */</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">irqp</span> <span class="o">==</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">))</span>  <span class="cm">/* It&#39;s a good IRQ line */</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* clear all interrupts */</span>
			<span class="n">eepro_clear_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*++</span><span class="n">irqp</span><span class="p">);</span>

	<span class="n">eepro_sw2bank1</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Switch back to Bank 1 */</span>

	<span class="cm">/* Disable the physical interrupt line. */</span>
	<span class="n">eepro_dis_intline</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Switch back to Bank 0 */</span>

	<span class="cm">/* Mask all the interrupts. */</span>
	<span class="n">eepro_dis_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* clear all interrupts */</span>
	<span class="n">eepro_clear_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eepro_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp_reg</span><span class="p">,</span> <span class="n">old8</span><span class="p">,</span> <span class="n">old9</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irqMask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering eepro_open routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">irqMask</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">==</span> <span class="n">LAN595FX_10ISA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;p-&gt;eepro = 3;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irqMask</span> <span class="o">==</span> <span class="n">ee_FX_INT2IRQ</span><span class="p">)</span> <span class="cm">/* INT to IRQ Mask */</span>
		<span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Yes, an Intel EtherExpress Pro/10+ */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;p-&gt;eepro = 2;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SA_ADDR0</span> <span class="o">&amp;&amp;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SA_ADDR1</span> <span class="o">&amp;&amp;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">SA_ADDR2</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;p-&gt;eepro = 1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>  <span class="cm">/* Yes, an Intel EtherExpress Pro/10 */</span>

	<span class="k">else</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No, it is a generic 82585 lan card */</span>

	<span class="cm">/* Get the interrupt vector for the 82595 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">eepro_grab_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to get IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="p">,</span> <span class="n">eepro_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to get IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the 82595. */</span>

	<span class="n">eepro_sw2bank2</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 2 now */</span>
	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">eeprom_reg</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stepping</span> <span class="o">=</span> <span class="n">temp_reg</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* Get the stepping number of the 595 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;The stepping of the 82595 is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stepping</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="cm">/* Check the TurnOff Enable bit */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">eeprom_reg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">I_ADD_REG0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG1</span><span class="p">);</span>    <span class="cm">/* Setup Transmit Chaining */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">temp_reg</span> <span class="o">|</span> <span class="n">XMT_Chain_Int</span> <span class="o">|</span> <span class="n">XMT_Chain_ErrStop</span> <span class="cm">/* and discard bad RCV frames */</span>
		<span class="o">|</span> <span class="n">RCV_Discard_BadFrame</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG1</span><span class="p">);</span>

	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span> <span class="cm">/* Match broadcast */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">temp_reg</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>

	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span> <span class="cm">/* clear test mode */</span>

	<span class="cm">/* Set the receiving mode */</span>
	<span class="n">eepro_sw2bank1</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 1 now */</span>

	<span class="cm">/* Set the interrupt vector */</span>
	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_NO_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">==</span> <span class="n">LAN595FX</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">==</span> <span class="n">LAN595FX_10ISA</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqrmap2</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_NO_REG</span><span class="p">);</span>
	<span class="k">else</span> <span class="n">outb</span><span class="p">((</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqrmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_NO_REG</span><span class="p">);</span>


	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_NO_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">==</span> <span class="n">LAN595FX</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">==</span> <span class="n">LAN595FX_10ISA</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqrmap2</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">INT_NO_REG</span><span class="p">);</span>
	<span class="k">else</span> <span class="n">outb</span><span class="p">((</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqrmap</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_NO_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;eepro_open: content of INT Reg is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_reg</span><span class="p">);</span>


	<span class="cm">/* Initialize the RCV and XMT upper and lower limits */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_lower_limit</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RCV_LOWER_LIMIT_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_upper_limit</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RCV_UPPER_LIMIT_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit_reg</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit_reg</span><span class="p">);</span>

	<span class="cm">/* Enable the interrupt line. */</span>
	<span class="n">eepro_en_intline</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Switch back to Bank 0 */</span>
	<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Let RX and TX events to interrupt */</span>
	<span class="n">eepro_en_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* clear all interrupts */</span>
	<span class="n">eepro_clear_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Initialize RCV */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_lower_limit</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RCV_BAR</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_lower_limit</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_upper_limit</span> <span class="o">|</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RCV_STOP</span><span class="p">);</span>

	<span class="cm">/* Initialize XMT */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_bar</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check for the i82595TX and i82595FX */</span>
	<span class="n">old8</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="o">~</span><span class="n">old8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">==</span> <span class="n">old8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i82595 detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">LAN595</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">LAN595TX</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">old8</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">old9</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irqMask</span><span class="o">==</span><span class="n">ee_FX_INT2IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IrqMask: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">irqMask</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i82595FX detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">LAN595FX</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">old9</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">!=</span> <span class="n">TPE</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Hopefully, this will fix the</span>
<span class="cm">							problem of using Pentiums and</span>
<span class="cm">							pro/10 w/ BNC. */</span>
				<span class="n">eepro_sw2bank2</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 2 now */</span>
				<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG13</span><span class="p">);</span>
				<span class="cm">/* disable the full duplex mode since it is not</span>
<span class="cm">				applicable with the 10Base2 cable. */</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">FDX</span> <span class="o">|</span> <span class="n">A_N_ENABLE</span><span class="p">),</span> <span class="n">REG13</span><span class="p">);</span>
				<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 0 now */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;temp_reg: %#x  ~old9: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">temp_reg</span><span class="p">,((</span><span class="o">~</span><span class="n">old9</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i82595TX detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">eepro_sel_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting eepro_open routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* enabling rx */</span>
	<span class="n">eepro_en_rx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eepro_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* if (net_debug &gt; 1) */</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: transmit timed out, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>
	<span class="cm">/* This is not a duplicate. One message for the console,</span>
<span class="cm">	   one for the log file  */</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: transmit timed out, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>
	<span class="n">eepro_complete_selreset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">eepro_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>  <span class="s">&quot;%s: entering eepro_send_packet routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">eepro_dis_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hardware_send_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
			<span class="cm">/* we won&#39;t wake queue here because we&#39;re out of space */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="o">+=</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* You might need to clean up and record Tx statistics here. */</span>
	<span class="cm">/* dev-&gt;stats.tx_aborted_errors++; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting eepro_send_packet routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">eepro_en_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*	The typical workload of the driver:</span>
<span class="cm">	Handle the network interface interrupts. */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">eepro_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering eepro_interrupt routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">STATUS_REG</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_INT</span><span class="o">|</span><span class="n">TX_INT</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">boguscount</span><span class="o">--</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: packet received interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">eepro_dis_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

			<span class="cm">/* Get the received packets */</span>
			<span class="n">eepro_ack_rx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">eepro_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">eepro_en_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
 				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: packet transmit interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>


			<span class="n">eepro_dis_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

			<span class="cm">/* Process the status of transmitted packets */</span>
			<span class="n">eepro_ack_tx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">eepro_transmit_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">eepro_en_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting eepro_interrupt routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eepro_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">temp_reg</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">eepro_sw2bank1</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Switch back to Bank 1 */</span>

	<span class="cm">/* Disable the physical interrupt line. */</span>
	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG1</span><span class="p">);</span>

	<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Switch back to Bank 0 */</span>

	<span class="cm">/* Flush the Tx and disable Rx. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">STOP_RCV_CMD</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Mask all the interrupts. */</span>
	<span class="n">eepro_dis_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* clear all interrupts */</span>
	<span class="n">eepro_clear_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Reset the 82595 */</span>
	<span class="n">eepro_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* release the interrupt */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Update the statistics here. What statistics? */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set or clear the multicast filter for this adaptor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="p">(</span><span class="n">IFF_ALLMULTI</span><span class="o">|</span><span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">||</span> <span class="n">mc_count</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">eepro_sw2bank2</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 2 now */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">mode</span> <span class="o">|</span> <span class="n">PRMSC_Mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span> <span class="cm">/* writing reg. 3 to complete the update */</span>
		<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Return to BANK 0 now */</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">eepro_sw2bank2</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 2 now */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span> <span class="cm">/* Turn off Multi-IA and PRMSC_Mode bits */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span> <span class="cm">/* writing reg. 3 to complete the update */</span>
		<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Return to BANK 0 now */</span>
	<span class="p">}</span>

	<span class="k">else</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="o">*</span><span class="n">eaddrs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Disable RX and TX interrupts.  Necessary to avoid</span>
<span class="cm">		   corruption of the HOST_ADDRESS_REG by interrupt</span>
<span class="cm">		   service routines. */</span>
		<span class="n">eepro_dis_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

		<span class="n">eepro_sw2bank2</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* be CAREFUL, BANK 2 now */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">mode</span> <span class="o">|</span> <span class="n">Multi_IA</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">REG3</span><span class="p">);</span> <span class="cm">/* writing reg. 3 to complete the update */</span>
		<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span> <span class="cm">/* Return to BANK 0 now */</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">MC_SETUP</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eaddrs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">eaddrs</span><span class="o">++</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">eaddrs</span><span class="o">++</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">eaddrs</span><span class="o">++</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">eaddrs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_bar</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MC_SETUP</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

		<span class="cm">/* Update the transmit queue */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">+</span> <span class="n">XMT_HEADER</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* update the next address and the chain bit in the</span>
<span class="cm">			   last packet */</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">+</span> <span class="n">XMT_CHAIN</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">+</span> <span class="n">XMT_COUNT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">status</span> <span class="o">|</span> <span class="n">CHAIN_BIT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Acknowledge that the MC setup is done */</span>
		<span class="k">do</span> <span class="p">{</span> <span class="cm">/* We should be doing this in the eepro_interrupt()! */</span>
			<span class="n">SLOW_DOWN</span><span class="p">;</span>
			<span class="n">SLOW_DOWN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">STATUS_REG</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* command ABORTed */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: multicast setup failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>	<span class="p">{</span> <span class="cm">/* MC-Done */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: set Rx mode to %d address%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mc_count</span><span class="p">,</span>
						<span class="n">mc_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;es&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">boguscount</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">);</span>

		<span class="cm">/* Re-enable RX and TX interrupts */</span>
		<span class="n">eepro_en_int</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">eepro</span> <span class="o">==</span> <span class="n">LAN595FX_10ISA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eepro_complete_selreset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">eepro_en_rx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The horrible routine to read a word from the serial EEPROM. */</span>
<span class="cm">/* IMPORTANT - the 82595 will be set to Bank 0 after the eeprom is read */</span>

<span class="cm">/* The delay between EEPROM clock transitions. */</span>
<span class="cp">#define eeprom_delay() { udelay(40); }</span>
<span class="cp">#define EE_READ_CMD (6 &lt;&lt; 6)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ee_addr</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">eeprom_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_cmd</span> <span class="o">=</span> <span class="n">location</span> <span class="o">|</span> <span class="n">EE_READ_CMD</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ctrl_val</span> <span class="o">=</span> <span class="n">EECS</span> <span class="p">;</span>

	<span class="cm">/* XXXX - black magic */</span>
		<span class="n">eepro_sw2bank1</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">STATUS_REG</span><span class="p">);</span>
	<span class="cm">/* XXXX - black magic */</span>

	<span class="n">eepro_sw2bank2</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ctrl_val</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>

	<span class="cm">/* Shift the read command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">outval</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">ctrl_val</span> <span class="o">|</span> <span class="n">EEDI</span>
			<span class="o">:</span> <span class="n">ctrl_val</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">outval</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">outval</span> <span class="o">|</span> <span class="n">EESK</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>	<span class="cm">/* EEPROM clock tick. */</span>
		<span class="n">eeprom_delay</span><span class="p">();</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">outval</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>	<span class="cm">/* Finish EEPROM a clock tick. */</span>
		<span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ctrl_val</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ctrl_val</span> <span class="o">|</span> <span class="n">EESK</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>	 <span class="n">eeprom_delay</span><span class="p">();</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ee_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EEDO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ctrl_val</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>  <span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Terminate the EEPROM access. */</span>
	<span class="n">ctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EECS</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ctrl_val</span> <span class="o">|</span> <span class="n">EESK</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
	<span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ctrl_val</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
	<span class="n">eeprom_delay</span><span class="p">();</span>
	<span class="n">eepro_sw2bank0</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">status</span><span class="p">,</span> <span class="n">tx_available</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering hardware_send_packet routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* determine how much of the transmit buffer space is available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">)</span>
		<span class="n">tx_available</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_ram</span> <span class="o">-</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">)</span>
		<span class="n">tx_available</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">tx_available</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_ram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((((</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">XMT_HEADER</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">tx_available</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No space available ??? */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">last</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">last</span> <span class="o">+</span> <span class="p">(((</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">XMT_HEADER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* the transmit buffer is wrapped around */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">last</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">XMT_HEADER</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Arrrr!!!, must keep the xmt header together,</span>
<span class="cm">				several days were lost to chase this one down. */</span>
			<span class="n">last</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span><span class="p">;</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">last</span> <span class="o">+</span> <span class="p">(((</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">XMT_HEADER</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">else</span> <span class="n">end</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_lower_limit</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_upper_limit</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">XMT_CMD</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">LAN595</span><span class="p">)</span>
			<span class="n">outsw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* LAN595TX or LAN595FX, capable of 32-bit I/O processing */</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_MASK_REG</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">IO_32_BIT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_MASK_REG</span><span class="p">);</span>
			<span class="n">outsl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT_32_BIT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IO_32_BIT</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_MASK_REG</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* A dummy read to flush the DRAM write pipeline */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmt_bar</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">XMT_CMD</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>   <span class="cm">/* I don&#39;t like to change tx_start here */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* update the next address and the chain bit in the</span>
<span class="cm">			last packet */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">+</span> <span class="n">XMT_CHAIN</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">+</span> <span class="n">XMT_COUNT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">status</span> <span class="o">|</span> <span class="n">CHAIN_BIT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>

			<span class="cm">/* Continue the transmit command */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">RESUME_XMT_CMD</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting hardware_send_packet routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">eepro_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rcv_car</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rcv_event</span><span class="p">,</span> <span class="n">rcv_status</span><span class="p">,</span> <span class="n">rcv_next_frame</span><span class="p">,</span> <span class="n">rcv_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering eepro_rx routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Set the read pointer to the start of the RCV */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">rcv_car</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>

	<span class="n">rcv_event</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rcv_event</span> <span class="o">==</span> <span class="n">RCV_DONE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">rcv_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">rcv_next_frame</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">rcv_size</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rcv_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_OK</span> <span class="o">|</span> <span class="n">RX_ERROR</span><span class="p">))</span> <span class="o">==</span> <span class="n">RX_OK</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Malloc up new buffer. */</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="o">+=</span><span class="n">rcv_size</span><span class="p">;</span>
			<span class="n">rcv_size</span> <span class="o">&amp;=</span> <span class="mh">0x3fff</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rcv_size</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rcv_car</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="n">RCV_HEADER</span> <span class="o">+</span> <span class="n">rcv_size</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">=</span> <span class="n">rcv_next_frame</span><span class="p">;</span>
				<span class="n">outw</span><span class="p">(</span><span class="n">rcv_next_frame</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">LAN595</span><span class="p">)</span>
				<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">IO_PORT</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">rcv_size</span><span class="p">),</span> <span class="p">(</span><span class="n">rcv_size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span> <span class="cm">/* LAN595TX or LAN595FX, capable of 32-bit I/O processing */</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_MASK_REG</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">IO_32_BIT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_MASK_REG</span><span class="p">);</span>
				<span class="n">insl</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">IO_PORT_32_BIT</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">rcv_size</span><span class="p">),</span>
					<span class="p">(</span><span class="n">rcv_size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IO_32_BIT</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">INT_MASK_REG</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span> <span class="cm">/* Not sure will ever reach here,</span>
<span class="cm">			I set the 595 to discard bad received frames */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rcv_status</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rcv_status</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rcv_status</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: event = %#x, status = %#x, next = %#x, size = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rcv_event</span><span class="p">,</span> <span class="n">rcv_status</span><span class="p">,</span> <span class="n">rcv_next_frame</span><span class="p">,</span> <span class="n">rcv_size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rcv_status</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="n">rcv_car</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">+</span> <span class="n">RCV_HEADER</span> <span class="o">+</span> <span class="n">rcv_size</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">=</span> <span class="n">rcv_next_frame</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">rcv_next_frame</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">rcv_event</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IO_PORT</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcv_car</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rcv_car</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rcv_upper_limit</span> <span class="o">|</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">rcv_car</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RCV_STOP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting eepro_rx routine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">eepro_transmit_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">xmt_status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">boguscount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HOST_ADDRESS_REG</span><span class="p">);</span>
		<span class="n">xmt_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">IO_PORT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xmt_status</span> <span class="o">&amp;</span> <span class="n">TX_DONE_BIT</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="n">xmt_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">IO_PORT</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_start</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">IO_PORT</span><span class="p">);</span>

		<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xmt_status</span> <span class="o">&amp;</span> <span class="n">TX_OK</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xmt_status</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: carrier error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: XMT status = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xmt_status</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: XMT status = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xmt_status</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: XMT status = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xmt_status</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xmt_status</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">xmt_status</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">xmt_status</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eepro_ethtool_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eepro_local</span>	<span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> 	<span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
				<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
				<span class="n">SUPPORTED_Autoneg</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span>	<span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
				<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
				<span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ee_PortTPE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_TP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_TP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ee_PortBNC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_BNC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_BNC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetBit</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ee_PortAUI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_AUI</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_AUI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">TPE</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ee_Duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ee_AutoNeg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eepro_ethtool_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span>
		<span class="s">&quot;ISA 0x%lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">eepro_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">eepro_ethtool_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> 	<span class="o">=</span> <span class="n">eepro_ethtool_get_drvinfo</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef MODULE</span>

<span class="cp">#define MAX_EEPRO 8</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_eepro</span><span class="p">[</span><span class="n">MAX_EEPRO</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[</span><span class="n">MAX_EEPRO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_EEPRO</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">MAX_EEPRO</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mem</span><span class="p">[</span><span class="n">MAX_EEPRO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* Size of the rx buffer in KB */</span>
  <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">MAX_EEPRO</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RCV_DEFAULT_RAM</span><span class="o">/</span><span class="mi">1024</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">autodetect</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">n_eepro</span><span class="p">;</span>
<span class="cm">/* For linux 2.1.xx */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pascal Dupuis and others&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel i82595 ISA EtherExpressPro10/10+ driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">autodetect</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;EtherExpress Pro/10 I/O base address(es)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;EtherExpress Pro/10 IRQ number(s)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="s">&quot;EtherExpress Pro/10 Rx buffer size(es) in kB (3-29)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">autodetect</span><span class="p">,</span> <span class="s">&quot;EtherExpress Pro/10 force board(s) detection (0-1)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">autodetect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;eepro_init_module: Probe is very dangerous in ISA boards!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;eepro_init_module: Please add </span><span class="se">\&quot;</span><span class="s">autodetect=1</span><span class="se">\&quot;</span><span class="s"> to force probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">autodetect</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if autodetect is set then we must force detection */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_EEPRO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;eepro_init_module: Auto-detecting boards (May God protect us...)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_EEPRO</span> <span class="o">&amp;&amp;</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eepro_local</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_eepro_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_eepro</span><span class="p">[</span><span class="n">n_eepro</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_eepro</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">n_eepro</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n_eepro</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_eepro</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">EEPRO_IO_EXTENT</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
