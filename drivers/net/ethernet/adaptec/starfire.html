<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › adaptec › starfire.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>starfire.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* starfire.c: Linux device driver for the Adaptec Starfire network adapter. */</span>
<span class="cm">/*</span>
<span class="cm">	Written 1998-2000 by Donald Becker.</span>

<span class="cm">	Current maintainer is Ion Badulescu &lt;ionut ta badula tod org&gt;. Please</span>
<span class="cm">	send all bug reports to me, and not to Donald Becker, as this code</span>
<span class="cm">	has been heavily modified from Donald&#39;s original version.</span>

<span class="cm">	This software may be used and distributed according to the terms of</span>
<span class="cm">	the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm">	Drivers based on or derived from this code fall under the GPL and must</span>
<span class="cm">	retain the authorship, copyright and license notice.  This file is not</span>
<span class="cm">	a complete program and may only be used when the entire operating</span>
<span class="cm">	system is licensed under the GPL.</span>

<span class="cm">	The information below comes from Donald Becker&#39;s original driver:</span>

<span class="cm">	The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>

<span class="cm">	Support and updates available at</span>
<span class="cm">	http://www.scyld.com/network/starfire.html</span>
<span class="cm">	[link no longer provides useful info -jgarzik]</span>

<span class="cm">*/</span>

<span class="cp">#define DRV_NAME	&quot;starfire&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;2.1&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;July  6, 2008&quot;</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;		</span><span class="cm">/* Processor type for cache alignment. */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * The current frame processor firmware fails to checksum a fragment</span>
<span class="cm"> * of length 1. If and when this is fixed, the #define below can be removed.</span>
<span class="cm"> */</span>
<span class="cp">#define HAS_BROKEN_FIRMWARE</span>

<span class="cm">/*</span>
<span class="cm"> * If using the broken firmware, data must be padded to the next 32-bit boundary.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef HAS_BROKEN_FIRMWARE</span>
<span class="cp">#define PADDING_MASK 3</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Define this if using the driver with the zero-copy patch</span>
<span class="cm"> */</span>
<span class="cp">#define ZEROCOPY</span>

<span class="cp">#if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)</span>
<span class="cp">#define VLAN_SUPPORT</span>
<span class="cp">#endif</span>

<span class="cm">/* The user-configurable values.</span>
<span class="cm">   These may be modified when a driver module is loaded.*/</span>

<span class="cm">/* Used for tuning interrupt latency vs. overhead. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">intr_latency</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">small_frames</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* 1 normal messages, 0 quiet .. 7 verbose. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_interrupt_work</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">;</span>
<span class="cm">/* Maximum number of multicast addresses to filter (vs. rx-all-multicast).</span>
<span class="cm">   The Starfire has a 512 element hash table based on the Ethernet CRC. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
<span class="cm">/* Whether to do TCP/UDP checksums in hardware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_hw_cksum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#define PKT_BUF_SZ	1536		</span><span class="cm">/* Size of each temporary Rx buffer.*/</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> * Set the copy breakpoint for the copy-only-tiny-frames scheme.</span>
<span class="cm"> * Setting to &gt; 1518 effectively disables this feature.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:</span>
<span class="cm"> * The ia64 doesn&#39;t allow for unaligned loads even of integers being</span>
<span class="cm"> * misaligned on a 2 byte boundary. Thus always force copying of</span>
<span class="cm"> * packets as the starfire doesn&#39;t allow for misaligned DMAs ;-(</span>
<span class="cm"> * 23/10/2000 - Jes</span>
<span class="cm"> *</span>
<span class="cm"> * The Alpha and the Sparc don&#39;t like unaligned loads, either. On Sparc64,</span>
<span class="cm"> * at least, having unaligned frames leads to a rather serious performance</span>
<span class="cm"> * penalty. -Ion</span>
<span class="cm"> */</span>
<span class="cp">#if defined(__ia64__) || defined(__alpha__) || defined(__sparc__)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="n">PKT_BUF_SZ</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="cm">/* = 0 */</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* PCI DMA burst size -- on sparc64 we want to force it to 64 bytes, on the others the default of 128 is fine. */</span>
<span class="cp">#ifdef __sparc__</span>
<span class="cp">#define DMA_BURST_SIZE 64</span>
<span class="cp">#else</span>
<span class="cp">#define DMA_BURST_SIZE 128</span>
<span class="cp">#endif</span>

<span class="cm">/* Operational parameters that are set at compile time. */</span>

<span class="cm">/* The &quot;native&quot; ring sizes are either 256 or 2048.</span>
<span class="cm">   However in some modes a descriptor may be marked to wrap the ring earlier.</span>
<span class="cm">*/</span>
<span class="cp">#define RX_RING_SIZE	256</span>
<span class="cp">#define TX_RING_SIZE	32</span>
<span class="cm">/* The completion queues are fixed at 1024 entries i.e. 4K or 8KB. */</span>
<span class="cp">#define DONE_Q_SIZE	1024</span>
<span class="cm">/* All queues must be aligned on a 256-byte boundary */</span>
<span class="cp">#define QUEUE_ALIGN	256</span>

<span class="cp">#if RX_RING_SIZE &gt; 256</span>
<span class="cp">#define RX_Q_ENTRIES Rx2048QEntries</span>
<span class="cp">#else</span>
<span class="cp">#define RX_Q_ENTRIES Rx256QEntries</span>
<span class="cp">#endif</span>

<span class="cm">/* Operational parameters that usually are not changed. */</span>
<span class="cm">/* Time in jiffies before concluding the transmitter is hung. */</span>
<span class="cp">#define TX_TIMEOUT	(2 * HZ)</span>

<span class="cp">#ifdef CONFIG_ARCH_DMA_ADDR_T_64BIT</span>
<span class="cm">/* 64-bit dma_addr_t */</span>
<span class="cp">#define ADDR_64BITS	</span><span class="cm">/* This chip uses 64 bit addresses. */</span><span class="cp"></span>
<span class="cp">#define netdrv_addr_t __le64</span>
<span class="cp">#define cpu_to_dma(x) cpu_to_le64(x)</span>
<span class="cp">#define dma_to_cpu(x) le64_to_cpu(x)</span>
<span class="cp">#define RX_DESC_Q_ADDR_SIZE RxDescQAddr64bit</span>
<span class="cp">#define TX_DESC_Q_ADDR_SIZE TxDescQAddr64bit</span>
<span class="cp">#define RX_COMPL_Q_ADDR_SIZE RxComplQAddr64bit</span>
<span class="cp">#define TX_COMPL_Q_ADDR_SIZE TxComplQAddr64bit</span>
<span class="cp">#define RX_DESC_ADDR_SIZE RxDescAddr64bit</span>
<span class="cp">#else  </span><span class="cm">/* 32-bit dma_addr_t */</span><span class="cp"></span>
<span class="cp">#define netdrv_addr_t __le32</span>
<span class="cp">#define cpu_to_dma(x) cpu_to_le32(x)</span>
<span class="cp">#define dma_to_cpu(x) le32_to_cpu(x)</span>
<span class="cp">#define RX_DESC_Q_ADDR_SIZE RxDescQAddr32bit</span>
<span class="cp">#define TX_DESC_Q_ADDR_SIZE TxDescQAddr32bit</span>
<span class="cp">#define RX_COMPL_Q_ADDR_SIZE RxComplQAddr32bit</span>
<span class="cp">#define TX_COMPL_Q_ADDR_SIZE TxComplQAddr32bit</span>
<span class="cp">#define RX_DESC_ADDR_SIZE RxDescAddr32bit</span>
<span class="cp">#endif</span>

<span class="cp">#define skb_first_frag_len(skb)	skb_headlen(skb)</span>
<span class="cp">#define skb_num_frags(skb) (skb_shinfo(skb)-&gt;nr_frags + 1)</span>

<span class="cm">/* Firmware names */</span>
<span class="cp">#define FIRMWARE_RX	&quot;adaptec/starfire_rx.bin&quot;</span>
<span class="cp">#define FIRMWARE_TX	&quot;adaptec/starfire_tx.bin&quot;</span>

<span class="cm">/* These identify the driver base version and may not be removed. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span>
<span class="n">KERN_INFO</span> <span class="s">&quot;starfire.c:v1.03 7/26/2000  Written by Donald Becker &lt;becker@scyld.com&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; (unofficial 2.2/2.4 kernel port, version &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;, &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Adaptec Starfire Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_RX</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_TX</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">intr_latency</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">small_frames</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_hw_cksum</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="s">&quot;Maximum events handled per interrupt&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="s">&quot;MTU (all boards)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-6)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="s">&quot;Copy breakpoint for copy-only-tiny-frames&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">intr_latency</span><span class="p">,</span> <span class="s">&quot;Maximum interrupt latency, in microseconds&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">small_frames</span><span class="p">,</span> <span class="s">&quot;Maximum size of receive frames that bypass interrupt latency (0,64,128,256,512)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_hw_cksum</span><span class="p">,</span> <span class="s">&quot;Enable/disable hardware cksum support (0/1)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">				Theory of Operation</span>

<span class="cm">I. Board Compatibility</span>

<span class="cm">This driver is for the Adaptec 6915 &quot;Starfire&quot; 64 bit PCI Ethernet adapter.</span>

<span class="cm">II. Board-specific settings</span>

<span class="cm">III. Driver operation</span>

<span class="cm">IIIa. Ring buffers</span>

<span class="cm">The Starfire hardware uses multiple fixed-size descriptor queues/rings.  The</span>
<span class="cm">ring sizes are set fixed by the hardware, but may optionally be wrapped</span>
<span class="cm">earlier by the END bit in the descriptor.</span>
<span class="cm">This driver uses that hardware queue size for the Rx ring, where a large</span>
<span class="cm">number of entries has no ill effect beyond increases the potential backlog.</span>
<span class="cm">The Tx ring is wrapped with the END bit, since a large hardware Tx queue</span>
<span class="cm">disables the queue layer priority ordering and we have no mechanism to</span>
<span class="cm">utilize the hardware two-level priority queue.  When modifying the</span>
<span class="cm">RX/TX_RING_SIZE pay close attention to page sizes and the ring-empty warning</span>
<span class="cm">levels.</span>

<span class="cm">IIIb/c. Transmit/Receive Structure</span>

<span class="cm">See the Adaptec manual for the many possible structures, and options for</span>
<span class="cm">each structure.  There are far too many to document all of them here.</span>

<span class="cm">For transmit this driver uses type 0/1 transmit descriptors (depending</span>
<span class="cm">on the 32/64 bitness of the architecture), and relies on automatic</span>
<span class="cm">minimum-length padding.  It does not use the completion queue</span>
<span class="cm">consumer index, but instead checks for non-zero status entries.</span>

<span class="cm">For receive this driver uses type 2/3 receive descriptors.  The driver</span>
<span class="cm">allocates full frame size skbuffs for the Rx ring buffers, so all frames</span>
<span class="cm">should fit in a single descriptor.  The driver does not use the completion</span>
<span class="cm">queue consumer index, but instead checks for non-zero status entries.</span>

<span class="cm">When an incoming frame is less than RX_COPYBREAK bytes long, a fresh skbuff</span>
<span class="cm">is allocated and the frame is copied to the new skbuff.  When the incoming</span>
<span class="cm">frame is larger, the skbuff is passed directly up the protocol stack.</span>
<span class="cm">Buffers consumed this way are replaced by newly allocated skbuffs in a later</span>
<span class="cm">phase of receive.</span>

<span class="cm">A notable aspect of operation is that unaligned buffers are not permitted by</span>
<span class="cm">the Starfire hardware.  Thus the IP header at offset 14 in an ethernet frame</span>
<span class="cm">isn&#39;t longword aligned, which may cause problems on some machine</span>
<span class="cm">e.g. Alphas and IA64. For these architectures, the driver is forced to copy</span>
<span class="cm">the frame into a new skbuff unconditionally. Copied frames are put into the</span>
<span class="cm">skbuff at an offset of &quot;+2&quot;, thus 16-byte aligning the IP header.</span>

<span class="cm">IIId. Synchronization</span>

<span class="cm">The driver runs as two independent, single-threaded flows of control.  One</span>
<span class="cm">is the send-packet routine, which enforces single-threaded use by the</span>
<span class="cm">dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single</span>
<span class="cm">threaded by the hardware and interrupt handling software.</span>

<span class="cm">The send packet thread has partial control over the Tx ring and the netif_queue</span>
<span class="cm">status. If the number of free Tx slots in the ring falls below a certain number</span>
<span class="cm">(currently hardcoded to 4), it signals the upper layer to stop the queue.</span>

<span class="cm">The interrupt handler has exclusive control over the Rx ring and records stats</span>
<span class="cm">from the Tx ring.  After reaping the stats, it marks the Tx queue entry as</span>
<span class="cm">empty by incrementing the dirty_tx mark. Iff the netif_queue is stopped and the</span>
<span class="cm">number of free Tx slow is above the threshold, it signals the upper layer to</span>
<span class="cm">restart the queue.</span>

<span class="cm">IV. Notes</span>

<span class="cm">IVb. References</span>

<span class="cm">The Adaptec Starfire manuals, available only from Adaptec.</span>
<span class="cm">http://www.scyld.com/expert/100mbps.html</span>
<span class="cm">http://www.scyld.com/expert/NWay.html</span>

<span class="cm">IVc. Errata</span>

<span class="cm">- StopOnPerr is broken, don&#39;t enable</span>
<span class="cm">- Hardware ethernet padding exposes random data, perform software padding</span>
<span class="cm">  instead (unverified -- works correctly for all the hardware I have)</span>

<span class="cm">*/</span>



<span class="k">enum</span> <span class="n">chip_capability_flags</span> <span class="p">{</span><span class="n">CanHaveMII</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">};</span>

<span class="k">enum</span> <span class="n">chipset</span> <span class="p">{</span>
	<span class="n">CH_6915</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">starfire_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ADAPTEC</span><span class="p">,</span> <span class="mh">0x6915</span><span class="p">),</span> <span class="n">CH_6915</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">starfire_pci_tbl</span><span class="p">);</span>

<span class="cm">/* A chip capabilities table, matching the CH_xxx entries in xxx_pci_tbl[] above. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">chip_info</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drv_flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">netdrv_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec Starfire 6915&quot;</span><span class="p">,</span> <span class="n">CanHaveMII</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/* Offsets to the device registers.</span>
<span class="cm">   Unlike software-only systems, device drivers interact with complex hardware.</span>
<span class="cm">   It&#39;s not useful to define symbolic names for every register bit in the</span>
<span class="cm">   device.  The name can only partially document the semantics and make</span>
<span class="cm">   the driver longer and more difficult to read.</span>
<span class="cm">   In general, only the important configuration values or bits changed</span>
<span class="cm">   multiple times should be defined symbolically.</span>
<span class="cm">*/</span>
<span class="k">enum</span> <span class="n">register_offsets</span> <span class="p">{</span>
	<span class="n">PCIDeviceConfig</span><span class="o">=</span><span class="mh">0x50040</span><span class="p">,</span> <span class="n">GenCtrl</span><span class="o">=</span><span class="mh">0x50070</span><span class="p">,</span> <span class="n">IntrTimerCtrl</span><span class="o">=</span><span class="mh">0x50074</span><span class="p">,</span>
	<span class="n">IntrClear</span><span class="o">=</span><span class="mh">0x50080</span><span class="p">,</span> <span class="n">IntrStatus</span><span class="o">=</span><span class="mh">0x50084</span><span class="p">,</span> <span class="n">IntrEnable</span><span class="o">=</span><span class="mh">0x50088</span><span class="p">,</span>
	<span class="n">MIICtrl</span><span class="o">=</span><span class="mh">0x52000</span><span class="p">,</span> <span class="n">TxStationAddr</span><span class="o">=</span><span class="mh">0x50120</span><span class="p">,</span> <span class="n">EEPROMCtrl</span><span class="o">=</span><span class="mh">0x51000</span><span class="p">,</span>
	<span class="n">GPIOCtrl</span><span class="o">=</span><span class="mh">0x5008C</span><span class="p">,</span> <span class="n">TxDescCtrl</span><span class="o">=</span><span class="mh">0x50090</span><span class="p">,</span>
	<span class="n">TxRingPtr</span><span class="o">=</span><span class="mh">0x50098</span><span class="p">,</span> <span class="n">HiPriTxRingPtr</span><span class="o">=</span><span class="mh">0x50094</span><span class="p">,</span> <span class="cm">/* Low and High priority. */</span>
	<span class="n">TxRingHiAddr</span><span class="o">=</span><span class="mh">0x5009C</span><span class="p">,</span>		<span class="cm">/* 64 bit address extension. */</span>
	<span class="n">TxProducerIdx</span><span class="o">=</span><span class="mh">0x500A0</span><span class="p">,</span> <span class="n">TxConsumerIdx</span><span class="o">=</span><span class="mh">0x500A4</span><span class="p">,</span>
	<span class="n">TxThreshold</span><span class="o">=</span><span class="mh">0x500B0</span><span class="p">,</span>
	<span class="n">CompletionHiAddr</span><span class="o">=</span><span class="mh">0x500B4</span><span class="p">,</span> <span class="n">TxCompletionAddr</span><span class="o">=</span><span class="mh">0x500B8</span><span class="p">,</span>
	<span class="n">RxCompletionAddr</span><span class="o">=</span><span class="mh">0x500BC</span><span class="p">,</span> <span class="n">RxCompletionQ2Addr</span><span class="o">=</span><span class="mh">0x500C0</span><span class="p">,</span>
	<span class="n">CompletionQConsumerIdx</span><span class="o">=</span><span class="mh">0x500C4</span><span class="p">,</span> <span class="n">RxDMACtrl</span><span class="o">=</span><span class="mh">0x500D0</span><span class="p">,</span>
	<span class="n">RxDescQCtrl</span><span class="o">=</span><span class="mh">0x500D4</span><span class="p">,</span> <span class="n">RxDescQHiAddr</span><span class="o">=</span><span class="mh">0x500DC</span><span class="p">,</span> <span class="n">RxDescQAddr</span><span class="o">=</span><span class="mh">0x500E0</span><span class="p">,</span>
	<span class="n">RxDescQIdx</span><span class="o">=</span><span class="mh">0x500E8</span><span class="p">,</span> <span class="n">RxDMAStatus</span><span class="o">=</span><span class="mh">0x500F0</span><span class="p">,</span> <span class="n">RxFilterMode</span><span class="o">=</span><span class="mh">0x500F4</span><span class="p">,</span>
	<span class="n">TxMode</span><span class="o">=</span><span class="mh">0x55000</span><span class="p">,</span> <span class="n">VlanType</span><span class="o">=</span><span class="mh">0x55064</span><span class="p">,</span>
	<span class="n">PerfFilterTable</span><span class="o">=</span><span class="mh">0x56000</span><span class="p">,</span> <span class="n">HashTable</span><span class="o">=</span><span class="mh">0x56100</span><span class="p">,</span>
	<span class="n">TxGfpMem</span><span class="o">=</span><span class="mh">0x58000</span><span class="p">,</span> <span class="n">RxGfpMem</span><span class="o">=</span><span class="mh">0x5a000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Bits in the interrupt status/mask registers.</span>
<span class="cm"> * Warning: setting Intr[Ab]NormalSummary in the IntrEnable register</span>
<span class="cm"> * enables all the interrupt sources that are or&#39;ed into those status bits.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">intr_status_bits</span> <span class="p">{</span>
	<span class="n">IntrLinkChange</span><span class="o">=</span><span class="mh">0xf0000000</span><span class="p">,</span> <span class="n">IntrStatsMax</span><span class="o">=</span><span class="mh">0x08000000</span><span class="p">,</span>
	<span class="n">IntrAbnormalSummary</span><span class="o">=</span><span class="mh">0x02000000</span><span class="p">,</span> <span class="n">IntrGeneralTimer</span><span class="o">=</span><span class="mh">0x01000000</span><span class="p">,</span>
	<span class="n">IntrSoftware</span><span class="o">=</span><span class="mh">0x800000</span><span class="p">,</span> <span class="n">IntrRxComplQ1Low</span><span class="o">=</span><span class="mh">0x400000</span><span class="p">,</span>
	<span class="n">IntrTxComplQLow</span><span class="o">=</span><span class="mh">0x200000</span><span class="p">,</span> <span class="n">IntrPCI</span><span class="o">=</span><span class="mh">0x100000</span><span class="p">,</span>
	<span class="n">IntrDMAErr</span><span class="o">=</span><span class="mh">0x080000</span><span class="p">,</span> <span class="n">IntrTxDataLow</span><span class="o">=</span><span class="mh">0x040000</span><span class="p">,</span>
	<span class="n">IntrRxComplQ2Low</span><span class="o">=</span><span class="mh">0x020000</span><span class="p">,</span> <span class="n">IntrRxDescQ1Low</span><span class="o">=</span><span class="mh">0x010000</span><span class="p">,</span>
	<span class="n">IntrNormalSummary</span><span class="o">=</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">IntrTxDone</span><span class="o">=</span><span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">IntrTxDMADone</span><span class="o">=</span><span class="mh">0x2000</span><span class="p">,</span> <span class="n">IntrTxEmpty</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span>
	<span class="n">IntrEarlyRxQ2</span><span class="o">=</span><span class="mh">0x0800</span><span class="p">,</span> <span class="n">IntrEarlyRxQ1</span><span class="o">=</span><span class="mh">0x0400</span><span class="p">,</span>
	<span class="n">IntrRxQ2Done</span><span class="o">=</span><span class="mh">0x0200</span><span class="p">,</span> <span class="n">IntrRxQ1Done</span><span class="o">=</span><span class="mh">0x0100</span><span class="p">,</span>
	<span class="n">IntrRxGFPDead</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">IntrRxDescQ2Low</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span>
	<span class="n">IntrNoTxCsum</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">IntrTxBadID</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span>
	<span class="n">IntrHiPriTxBadID</span><span class="o">=</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">IntrRxGfp</span><span class="o">=</span><span class="mh">0x04</span><span class="p">,</span>
	<span class="n">IntrTxGfp</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">IntrPCIPad</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span>
	<span class="cm">/* not quite bits */</span>
	<span class="n">IntrRxDone</span><span class="o">=</span><span class="n">IntrRxQ2Done</span> <span class="o">|</span> <span class="n">IntrRxQ1Done</span><span class="p">,</span>
	<span class="n">IntrRxEmpty</span><span class="o">=</span><span class="n">IntrRxDescQ1Low</span> <span class="o">|</span> <span class="n">IntrRxDescQ2Low</span><span class="p">,</span>
	<span class="n">IntrNormalMask</span><span class="o">=</span><span class="mh">0xff00</span><span class="p">,</span> <span class="n">IntrAbnormalMask</span><span class="o">=</span><span class="mh">0x3ff00fe</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the RxFilterMode register. */</span>
<span class="k">enum</span> <span class="n">rx_mode_bits</span> <span class="p">{</span>
	<span class="n">AcceptBroadcast</span><span class="o">=</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">AcceptAllMulticast</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">AcceptAll</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span>
	<span class="n">AcceptMulticast</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">PerfectFilter</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">HashFilter</span><span class="o">=</span><span class="mh">0x30</span><span class="p">,</span>
	<span class="n">PerfectFilterVlan</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">MinVLANPrio</span><span class="o">=</span><span class="mh">0xE000</span><span class="p">,</span> <span class="n">VlanMode</span><span class="o">=</span><span class="mh">0x0200</span><span class="p">,</span>
	<span class="n">WakeupOnGFP</span><span class="o">=</span><span class="mh">0x0800</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the TxMode register */</span>
<span class="k">enum</span> <span class="n">tx_mode_bits</span> <span class="p">{</span>
	<span class="n">MiiSoftReset</span><span class="o">=</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">MIILoopback</span><span class="o">=</span><span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">TxFlowEnable</span><span class="o">=</span><span class="mh">0x0800</span><span class="p">,</span> <span class="n">RxFlowEnable</span><span class="o">=</span><span class="mh">0x0400</span><span class="p">,</span>
	<span class="n">PadEnable</span><span class="o">=</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">FullDuplex</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">HugeFrame</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the TxDescCtrl register. */</span>
<span class="k">enum</span> <span class="n">tx_ctrl_bits</span> <span class="p">{</span>
	<span class="n">TxDescSpaceUnlim</span><span class="o">=</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">TxDescSpace32</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">TxDescSpace64</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span>
	<span class="n">TxDescSpace128</span><span class="o">=</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">TxDescSpace256</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span>
	<span class="n">TxDescType0</span><span class="o">=</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">TxDescType1</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">TxDescType2</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span>
	<span class="n">TxDescType3</span><span class="o">=</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">TxDescType4</span><span class="o">=</span><span class="mh">0x04</span><span class="p">,</span>
	<span class="n">TxNoDMACompletion</span><span class="o">=</span><span class="mh">0x08</span><span class="p">,</span>
	<span class="n">TxDescQAddr64bit</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">TxDescQAddr32bit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">TxHiPriFIFOThreshShift</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">TxPadLenShift</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
	<span class="n">TxDMABurstSizeShift</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the RxDescQCtrl register. */</span>
<span class="k">enum</span> <span class="n">rx_ctrl_bits</span> <span class="p">{</span>
	<span class="n">RxBufferLenShift</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">RxMinDescrThreshShift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">RxPrefetchMode</span><span class="o">=</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">RxVariableQ</span><span class="o">=</span><span class="mh">0x2000</span><span class="p">,</span>
	<span class="n">Rx2048QEntries</span><span class="o">=</span><span class="mh">0x4000</span><span class="p">,</span> <span class="n">Rx256QEntries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">RxDescAddr64bit</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">RxDescAddr32bit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">RxDescQAddr64bit</span><span class="o">=</span><span class="mh">0x0100</span><span class="p">,</span> <span class="n">RxDescQAddr32bit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">RxDescSpace4</span><span class="o">=</span><span class="mh">0x000</span><span class="p">,</span> <span class="n">RxDescSpace8</span><span class="o">=</span><span class="mh">0x100</span><span class="p">,</span>
	<span class="n">RxDescSpace16</span><span class="o">=</span><span class="mh">0x200</span><span class="p">,</span> <span class="n">RxDescSpace32</span><span class="o">=</span><span class="mh">0x300</span><span class="p">,</span>
	<span class="n">RxDescSpace64</span><span class="o">=</span><span class="mh">0x400</span><span class="p">,</span> <span class="n">RxDescSpace128</span><span class="o">=</span><span class="mh">0x500</span><span class="p">,</span>
	<span class="n">RxConsumerWrEn</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the RxDMACtrl register. */</span>
<span class="k">enum</span> <span class="n">rx_dmactrl_bits</span> <span class="p">{</span>
	<span class="n">RxReportBadFrames</span><span class="o">=</span><span class="mh">0x80000000</span><span class="p">,</span> <span class="n">RxDMAShortFrames</span><span class="o">=</span><span class="mh">0x40000000</span><span class="p">,</span>
	<span class="n">RxDMABadFrames</span><span class="o">=</span><span class="mh">0x20000000</span><span class="p">,</span> <span class="n">RxDMACrcErrorFrames</span><span class="o">=</span><span class="mh">0x10000000</span><span class="p">,</span>
	<span class="n">RxDMAControlFrame</span><span class="o">=</span><span class="mh">0x08000000</span><span class="p">,</span> <span class="n">RxDMAPauseFrame</span><span class="o">=</span><span class="mh">0x04000000</span><span class="p">,</span>
	<span class="n">RxChecksumIgnore</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">RxChecksumRejectTCPUDP</span><span class="o">=</span><span class="mh">0x02000000</span><span class="p">,</span>
	<span class="n">RxChecksumRejectTCPOnly</span><span class="o">=</span><span class="mh">0x01000000</span><span class="p">,</span>
	<span class="n">RxCompletionQ2Enable</span><span class="o">=</span><span class="mh">0x800000</span><span class="p">,</span>
	<span class="n">RxDMAQ2Disable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">RxDMAQ2FPOnly</span><span class="o">=</span><span class="mh">0x100000</span><span class="p">,</span>
	<span class="n">RxDMAQ2SmallPkt</span><span class="o">=</span><span class="mh">0x200000</span><span class="p">,</span> <span class="n">RxDMAQ2HighPrio</span><span class="o">=</span><span class="mh">0x300000</span><span class="p">,</span>
	<span class="n">RxDMAQ2NonIP</span><span class="o">=</span><span class="mh">0x400000</span><span class="p">,</span>
	<span class="n">RxUseBackupQueue</span><span class="o">=</span><span class="mh">0x080000</span><span class="p">,</span> <span class="n">RxDMACRC</span><span class="o">=</span><span class="mh">0x040000</span><span class="p">,</span>
	<span class="n">RxEarlyIntThreshShift</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">RxHighPrioThreshShift</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
	<span class="n">RxBurstSizeShift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the RxCompletionAddr register */</span>
<span class="k">enum</span> <span class="n">rx_compl_bits</span> <span class="p">{</span>
	<span class="n">RxComplQAddr64bit</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">RxComplQAddr32bit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">RxComplProducerWrEn</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span>
	<span class="n">RxComplType0</span><span class="o">=</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">RxComplType1</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span>
	<span class="n">RxComplType2</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">RxComplType3</span><span class="o">=</span><span class="mh">0x30</span><span class="p">,</span>
	<span class="n">RxComplThreshShift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the TxCompletionAddr register */</span>
<span class="k">enum</span> <span class="n">tx_compl_bits</span> <span class="p">{</span>
	<span class="n">TxComplQAddr64bit</span><span class="o">=</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">TxComplQAddr32bit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">TxComplProducerWrEn</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span>
	<span class="n">TxComplIntrStatus</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span>
	<span class="n">CommonQueueMode</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span>
	<span class="n">TxComplThreshShift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the GenCtrl register */</span>
<span class="k">enum</span> <span class="n">gen_ctrl_bits</span> <span class="p">{</span>
	<span class="n">RxEnable</span><span class="o">=</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">TxEnable</span><span class="o">=</span><span class="mh">0x0a</span><span class="p">,</span>
	<span class="n">RxGFPEnable</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">TxGFPEnable</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in the IntrTimerCtrl register */</span>
<span class="k">enum</span> <span class="n">intr_ctrl_bits</span> <span class="p">{</span>
	<span class="n">Timer10X</span><span class="o">=</span><span class="mh">0x800</span><span class="p">,</span> <span class="n">EnableIntrMasking</span><span class="o">=</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">SmallFrameBypass</span><span class="o">=</span><span class="mh">0x100</span><span class="p">,</span>
	<span class="n">SmallFrame64</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">SmallFrame128</span><span class="o">=</span><span class="mh">0x200</span><span class="p">,</span> <span class="n">SmallFrame256</span><span class="o">=</span><span class="mh">0x400</span><span class="p">,</span> <span class="n">SmallFrame512</span><span class="o">=</span><span class="mh">0x600</span><span class="p">,</span>
	<span class="n">IntrLatencyMask</span><span class="o">=</span><span class="mh">0x1f</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The Rx and Tx buffer descriptors. */</span>
<span class="k">struct</span> <span class="n">starfire_rx_desc</span> <span class="p">{</span>
	<span class="n">netdrv_addr_t</span> <span class="n">rxaddr</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">rx_desc_bits</span> <span class="p">{</span>
	<span class="n">RxDescValid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">RxDescEndRing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Completion queue entry. */</span>
<span class="k">struct</span> <span class="n">short_rx_done_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* Low 16 bits is length. */</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">basic_rx_done_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* Low 16 bits is length. */</span>
	<span class="n">__le16</span> <span class="n">vlanid</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">status2</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">csum_rx_done_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* Low 16 bits is length. */</span>
	<span class="n">__le16</span> <span class="n">csum</span><span class="p">;</span>			<span class="cm">/* Partial checksum */</span>
	<span class="n">__le16</span> <span class="n">status2</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">full_rx_done_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* Low 16 bits is length. */</span>
	<span class="n">__le16</span> <span class="n">status3</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">status2</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">vlanid</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">csum</span><span class="p">;</span>			<span class="cm">/* partial checksum */</span>
	<span class="n">__le32</span> <span class="n">timestamp</span><span class="p">;</span>
<span class="p">};</span>
<span class="cm">/* XXX: this is ugly and I&#39;m not sure it&#39;s worth the trouble -Ion */</span>
<span class="cp">#ifdef VLAN_SUPPORT</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">full_rx_done_desc</span> <span class="n">rx_done_desc</span><span class="p">;</span>
<span class="cp">#define RxComplType RxComplType3</span>
<span class="cp">#else  </span><span class="cm">/* not VLAN_SUPPORT */</span><span class="cp"></span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">csum_rx_done_desc</span> <span class="n">rx_done_desc</span><span class="p">;</span>
<span class="cp">#define RxComplType RxComplType2</span>
<span class="cp">#endif </span><span class="cm">/* not VLAN_SUPPORT */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">rx_done_bits</span> <span class="p">{</span>
	<span class="n">RxOK</span><span class="o">=</span><span class="mh">0x20000000</span><span class="p">,</span> <span class="n">RxFIFOErr</span><span class="o">=</span><span class="mh">0x10000000</span><span class="p">,</span> <span class="n">RxBufQ2</span><span class="o">=</span><span class="mh">0x08000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Type 1 Tx descriptor. */</span>
<span class="k">struct</span> <span class="n">starfire_tx_desc_1</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* Upper bits are status, lower 16 length. */</span>
	<span class="n">__le32</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Type 2 Tx descriptor. */</span>
<span class="k">struct</span> <span class="n">starfire_tx_desc_2</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* Upper bits are status, lower 16 length. */</span>
	<span class="n">__le32</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef ADDR_64BITS</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">starfire_tx_desc_2</span> <span class="n">starfire_tx_desc</span><span class="p">;</span>
<span class="cp">#define TX_DESC_TYPE TxDescType2</span>
<span class="cp">#else  </span><span class="cm">/* not ADDR_64BITS */</span><span class="cp"></span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">starfire_tx_desc_1</span> <span class="n">starfire_tx_desc</span><span class="p">;</span>
<span class="cp">#define TX_DESC_TYPE TxDescType1</span>
<span class="cp">#endif </span><span class="cm">/* not ADDR_64BITS */</span><span class="cp"></span>
<span class="cp">#define TX_DESC_SPACING TxDescSpaceUnlim</span>

<span class="k">enum</span> <span class="n">tx_desc_bits</span> <span class="p">{</span>
	<span class="n">TxDescID</span><span class="o">=</span><span class="mh">0xB0000000</span><span class="p">,</span>
	<span class="n">TxCRCEn</span><span class="o">=</span><span class="mh">0x01000000</span><span class="p">,</span> <span class="n">TxDescIntr</span><span class="o">=</span><span class="mh">0x08000000</span><span class="p">,</span>
	<span class="n">TxRingWrap</span><span class="o">=</span><span class="mh">0x04000000</span><span class="p">,</span> <span class="n">TxCalTCP</span><span class="o">=</span><span class="mh">0x02000000</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">tx_done_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* timestamp, index. */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	__le32 intrstatus;		/* interrupt status */</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">used_slots</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PHY_CNT		2</span>
<span class="k">struct</span> <span class="n">netdev_private</span> <span class="p">{</span>
	<span class="cm">/* Descriptor rings first for alignment. */</span>
	<span class="k">struct</span> <span class="n">starfire_rx_desc</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="n">starfire_tx_desc</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rx_ring_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_ring_dma</span><span class="p">;</span>
	<span class="cm">/* The addresses of rx/tx-in-place skbuffs. */</span>
	<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="n">rx_info</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="n">tx_info</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="cm">/* Pointers to completion queues (full pages). */</span>
	<span class="n">rx_done_desc</span> <span class="o">*</span><span class="n">rx_done_q</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rx_done_q_dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_done_desc</span> <span class="o">*</span><span class="n">tx_done_q</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_done_q_dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
<span class="cp">#ifdef VLAN_SUPPORT</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">active_vlans</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">VLAN_N_VID</span><span class="p">)];</span>
<span class="cp">#endif</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">queue_mem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">queue_mem_dma</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">queue_mem_size</span><span class="p">;</span>

	<span class="cm">/* Frequently used values: keep some adjacent for cache effect. */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_rx</span><span class="p">,</span> <span class="n">dirty_rx</span><span class="p">;</span>	<span class="cm">/* Producer/consumer ring indices */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_tx</span><span class="p">,</span> <span class="n">dirty_tx</span><span class="p">,</span> <span class="n">reap_tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_buf_sz</span><span class="p">;</span>		<span class="cm">/* Based on MTU+slack. */</span>
	<span class="cm">/* These values keep track of the transceiver/media in use. */</span>
	<span class="kt">int</span> <span class="n">speed100</span><span class="p">;</span>			<span class="cm">/* Set if speed == 100MBit. */</span>
	<span class="n">u32</span> <span class="n">tx_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_timer_ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_threshold</span><span class="p">;</span>
	<span class="cm">/* MII transceiver section. */</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii_if</span><span class="p">;</span>		<span class="cm">/* MII lib hooks/info */</span>
	<span class="kt">int</span> <span class="n">phy_cnt</span><span class="p">;</span>			<span class="cm">/* MII device addresses. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="n">PHY_CNT</span><span class="p">];</span>	<span class="cm">/* MII device addresses. */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span>	<span class="n">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">netdev_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">__netdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">quota</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">netdev_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">refill_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">netdev_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">netdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">netdev_media_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span><span class="p">;</span>


<span class="cp">#ifdef VLAN_SUPPORT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Adding vlanid %d to vlan filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>
	<span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: removing vlanid %d from vlan filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>
	<span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* VLAN_SUPPORT */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">netdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">netdev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">netdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef VLAN_SUPPORT</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">netdev_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>	<span class="o">=</span> <span class="n">netdev_vlan_rx_kill_vid</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">starfire_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">chip_idx</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drv_flags</span><span class="p">,</span> <span class="n">io_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boguscnt</span><span class="p">;</span>

<span class="cm">/* when built into the kernel, we only print version if device is found */</span>
<span class="cp">#ifndef MODULE</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">io_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span> <span class="o">||</span> <span class="p">((</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;no PCI MEM resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;cannot reserve PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">io_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;cannot remap %#x @ %#lx, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">io_size</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* enable MWI -- it vastly improves Rx performance on sparc64 */</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="cp">#ifdef ZEROCOPY</span>
	<span class="cm">/* Starfire can do TCP/UDP checksumming */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_hw_cksum</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* ZEROCOPY */</span><span class="cp"></span>

<span class="cp">#ifdef VLAN_SUPPORT</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* VLAN_RX_KILL_VID */</span><span class="cp"></span>
<span class="cp">#ifdef ADDR_64BITS</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* ADDR_64BITS */</span><span class="cp"></span>

	<span class="cm">/* Serial EEPROM reads are hidden by the hardware. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">EEPROMCtrl</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

<span class="cp">#if ! defined(final_version) </span><span class="cm">/* Dump the EEPROM contents during development. */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%2.2x%s&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">EEPROMCtrl</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
			       <span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">15</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Issue soft reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MiiSoftReset</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">TxMode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">TxMode</span><span class="p">);</span>

	<span class="cm">/* Reset the chip to erase previous misconfiguration. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCIDeviceConfig</span><span class="p">);</span>
	<span class="n">boguscnt</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PCIDeviceConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boguscnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: chipset reset never completed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* wait a little longer */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">drv_flags</span> <span class="o">=</span> <span class="n">netdrv_tbl</span><span class="p">[</span><span class="n">chip_idx</span><span class="p">].</span><span class="n">drv_flags</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* timer resolution is 128 * 0.8us */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">=</span> <span class="p">(((</span><span class="n">intr_latency</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IntrLatencyMask</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">Timer10X</span> <span class="o">|</span> <span class="n">EnableIntrMasking</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">small_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">|=</span> <span class="n">SmallFrameBypass</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">small_frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span> <span class="p">...</span> <span class="mi">64</span>:
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">|=</span> <span class="n">SmallFrame64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">65</span> <span class="p">...</span> <span class="mi">128</span>:
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">|=</span> <span class="n">SmallFrame128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">129</span> <span class="p">...</span> <span class="mi">256</span>:
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">|=</span> <span class="n">SmallFrame256</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">|=</span> <span class="n">SmallFrame512</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">small_frames</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Adjusting small_frames down to 512</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_ops</span><span class="p">);</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">netdev_poll</span><span class="p">,</span> <span class="n">max_interrupt_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_cleardev</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s at %p, %pM, IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdrv_tbl</span><span class="p">[</span><span class="n">chip_idx</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">CanHaveMII</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="n">phy_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mii_status</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="n">PHY_CNT</span><span class="p">;</span> <span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">boguscnt</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boguscnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PHY#%d reset never completed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mii_status</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">phy_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: MII PHY found at address %d, status &quot;</span>
					   <span class="s">&quot;%#4.4x advertising %#4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">mii_status</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span><span class="p">);</span>
				<span class="cm">/* there can be only one PHY on-board */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_cnt</span> <span class="o">=</span> <span class="n">phy_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phy_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: scatter-gather and hardware TCP cksumming %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">enable_hw_cksum</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_cleardev:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Read the MII Management Data I/O (MDIO) interfaces. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mdio_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MIICtrl</span> <span class="o">+</span> <span class="p">(</span><span class="n">phy_id</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">location</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">boguscnt</span><span class="o">=</span><span class="mi">1000</span><span class="p">;</span>
	<span class="cm">/* ??? Should we add a busy-wait here? */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mdio_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xC0000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80000000</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">boguscnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boguscnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mdio_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">MIICtrl</span> <span class="o">+</span> <span class="p">(</span><span class="n">phy_id</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">location</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">mdio_addr</span><span class="p">);</span>
	<span class="cm">/* The busy-wait will occur before a read. */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_rx</span><span class="p">,</span> <span class="o">*</span><span class="n">fw_tx</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">fw_rx_data</span><span class="p">,</span> <span class="o">*</span><span class="n">fw_tx_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">tx_size</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">tx_done_q_size</span><span class="p">,</span> <span class="n">rx_done_q_size</span><span class="p">,</span> <span class="n">tx_ring_size</span><span class="p">,</span> <span class="n">rx_ring_size</span><span class="p">;</span>

	<span class="cm">/* Do we ever need to reset the chip??? */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">intr_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Disable the Rx and Tx, and reset the chip. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GenCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PCIDeviceConfig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: netdev_open() irq %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Allocate the various queues. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_done_q_size</span> <span class="o">=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_done_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">DONE_Q_SIZE</span> <span class="o">+</span> <span class="n">QUEUE_ALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">QUEUE_ALIGN</span><span class="p">)</span> <span class="o">*</span> <span class="n">QUEUE_ALIGN</span><span class="p">;</span>
		<span class="n">rx_done_q_size</span> <span class="o">=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_done_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">DONE_Q_SIZE</span> <span class="o">+</span> <span class="n">QUEUE_ALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">QUEUE_ALIGN</span><span class="p">)</span> <span class="o">*</span> <span class="n">QUEUE_ALIGN</span><span class="p">;</span>
		<span class="n">tx_ring_size</span> <span class="o">=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">starfire_tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_RING_SIZE</span> <span class="o">+</span> <span class="n">QUEUE_ALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">QUEUE_ALIGN</span><span class="p">)</span> <span class="o">*</span> <span class="n">QUEUE_ALIGN</span><span class="p">;</span>
		<span class="n">rx_ring_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">starfire_rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_size</span> <span class="o">=</span> <span class="n">tx_done_q_size</span> <span class="o">+</span> <span class="n">rx_done_q_size</span> <span class="o">+</span> <span class="n">tx_ring_size</span> <span class="o">+</span> <span class="n">rx_ring_size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q</span>     <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q_dma</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_dma</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q</span> <span class="o">+</span> <span class="n">tx_done_q_size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q_dma</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q_dma</span> <span class="o">+</span> <span class="n">tx_done_q_size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span>       <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span> <span class="o">+</span> <span class="n">rx_done_q_size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span>   <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q_dma</span> <span class="o">+</span> <span class="n">rx_done_q_size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span>       <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">tx_ring_size</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span>   <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="n">tx_ring_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start with no carrier, it gets adjusted later */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Set the size of the Rx buffers. */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">&lt;&lt;</span> <span class="n">RxBufferLenShift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">RxMinDescrThreshShift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">RxPrefetchMode</span> <span class="o">|</span> <span class="n">RxVariableQ</span> <span class="o">|</span>
	       <span class="n">RX_Q_ENTRIES</span> <span class="o">|</span>
	       <span class="n">RX_DESC_Q_ADDR_SIZE</span> <span class="o">|</span> <span class="n">RX_DESC_ADDR_SIZE</span> <span class="o">|</span>
	       <span class="n">RxDescSpace4</span><span class="p">,</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxDescQCtrl</span><span class="p">);</span>

	<span class="cm">/* Set up the Rx DMA controller. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RxChecksumIgnore</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">RxEarlyIntThreshShift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">RxHighPrioThreshShift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">DMA_BURST_SIZE</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RxBurstSizeShift</span><span class="p">),</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxDMACtrl</span><span class="p">);</span>

	<span class="cm">/* Set Tx descriptor */</span>
	<span class="n">writel</span><span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">TxHiPriFIFOThreshShift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">TxPadLenShift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">DMA_BURST_SIZE</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TxDMABurstSizeShift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">TX_DESC_Q_ADDR_SIZE</span> <span class="o">|</span>
	       <span class="n">TX_DESC_SPACING</span> <span class="o">|</span> <span class="n">TX_DESC_TYPE</span><span class="p">,</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxDescCtrl</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxDescQHiAddr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxRingHiAddr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CompletionHiAddr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxDescQAddr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxRingPtr</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxCompletionAddr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q_dma</span> <span class="o">|</span>
	       <span class="n">RxComplType</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">RxComplThreshShift</span><span class="p">),</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxCompletionAddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Filling in the station address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Fill both the Tx SA register and the Rx perfect filter. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxStationAddr</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
	<span class="cm">/* The first entry is special because it bypasses the VLAN filter.</span>
<span class="cm">	   Don&#39;t use it. */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PerfFilterTable</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PerfFilterTable</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PerfFilterTable</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be16</span> <span class="o">*</span><span class="n">eaddrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">setup_frm</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PerfFilterTable</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">setup_frm</span><span class="p">);</span> <span class="n">setup_frm</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">setup_frm</span><span class="p">);</span> <span class="n">setup_frm</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">setup_frm</span><span class="p">);</span> <span class="n">setup_frm</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize other registers. */</span>
	<span class="cm">/* Configure the PCI bus bursts and FIFO thresholds. */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">=</span> <span class="n">TxFlowEnable</span><span class="o">|</span><span class="n">RxFlowEnable</span><span class="o">|</span><span class="n">PadEnable</span><span class="p">;</span>	<span class="cm">/* modified when link is up. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MiiSoftReset</span> <span class="o">|</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxMode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxMode</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_threshold</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_threshold</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxThreshold</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrTimerCtrl</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Setting the Rx and Tx modes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="n">check_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable GPIO interrupts on link change */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0f00ff00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GPIOCtrl</span><span class="p">);</span>

	<span class="cm">/* Set the interrupt mask */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span> <span class="o">|</span> <span class="n">IntrDMAErr</span> <span class="o">|</span>
	       <span class="n">IntrTxDMADone</span> <span class="o">|</span> <span class="n">IntrStatsMax</span> <span class="o">|</span> <span class="n">IntrLinkChange</span> <span class="o">|</span>
	       <span class="n">IntrRxGFPDead</span> <span class="o">|</span> <span class="n">IntrNoTxCsum</span> <span class="o">|</span> <span class="n">IntrTxBadID</span><span class="p">,</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
	<span class="cm">/* Enable PCI interrupts. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00800000</span> <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PCIDeviceConfig</span><span class="p">),</span>
	       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PCIDeviceConfig</span><span class="p">);</span>

<span class="cp">#ifdef VLAN_SUPPORT</span>
	<span class="cm">/* Set VLAN type to 802.1q */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">VlanType</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* VLAN_SUPPORT */</span><span class="cp"></span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_rx</span><span class="p">,</span> <span class="n">FIRMWARE_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;starfire: Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">FIRMWARE_RX</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_rx</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;starfire: bogus length %zu in </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_rx</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">FIRMWARE_RX</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_rx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_tx</span><span class="p">,</span> <span class="n">FIRMWARE_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;starfire: Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">FIRMWARE_TX</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_rx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_tx</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;starfire: bogus length %zu in </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_tx</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">FIRMWARE_TX</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_tx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fw_rx_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw_rx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">fw_tx_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw_tx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rx_size</span> <span class="o">=</span> <span class="n">fw_rx</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">tx_size</span> <span class="o">=</span> <span class="n">fw_tx</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Load Rx/Tx firmware into the frame processors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">be32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxGfpMem</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">be32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxGfpMem</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_hw_cksum</span><span class="p">)</span>
		<span class="cm">/* Enable the Rx and Tx units, and the Rx/Tx frame processors. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TxEnable</span><span class="o">|</span><span class="n">TxGFPEnable</span><span class="o">|</span><span class="n">RxEnable</span><span class="o">|</span><span class="n">RxGFPEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GenCtrl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Enable the Rx and Tx units only. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TxEnable</span><span class="o">|</span><span class="n">RxEnable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GenCtrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Done netdev_open().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="nl">out_tx:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_tx</span><span class="p">);</span>
<span class="nl">out_rx:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_rx</span><span class="p">);</span>
<span class="nl">out_init:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">netdev_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">silly_count</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">advertising</span><span class="p">);</span>
	<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">silly_count</span> <span class="o">&amp;&amp;</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">)</span>
		<span class="cm">/* do nothing */</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silly_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: MII reset failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg0</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">force_media</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg0</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span><span class="p">)</span>
			<span class="n">reg0</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">)</span>
			<span class="n">reg0</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Link forced to %sMbit %s-duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">?</span> <span class="s">&quot;100&quot;</span> <span class="o">:</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_debug</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Transmit timed out, status %#8.8x, &quot;</span>
	       <span class="s">&quot;resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">));</span>

	<span class="cm">/* Perhaps we should reinitialize the hardware here. */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop and restart the interface.</span>
<span class="cm">	 * Cheat and increase the debug level temporarily.</span>
<span class="cm">	 */</span>
	<span class="n">old_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">netdev_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="n">old_debug</span><span class="p">;</span>

	<span class="cm">/* Trigger an immediate transmit demand. */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Initialize the Rx and Tx rings, along with various &#39;dev&#39; bits. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">reap_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="mi">1500</span> <span class="o">?</span> <span class="n">PKT_BUF_SZ</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Fill in the Rx buffers.  Handle allocation failure gracefully. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="cm">/* Grrr, we cannot offset to correctly align the IP header. */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxaddr</span> <span class="o">=</span> <span class="n">cpu_to_dma</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span> <span class="o">|</span> <span class="n">RxDescValid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RxDescQIdx</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">i</span> <span class="o">-</span> <span class="n">RX_RING_SIZE</span><span class="p">);</span>

	<span class="cm">/* Clear the remainder of the Rx buffer ring. */</span>
	<span class="k">for</span> <span class="p">(</span>  <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Mark the last entry as wrapping the ring. */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">rxaddr</span> <span class="o">|=</span> <span class="n">cpu_to_dma</span><span class="p">(</span><span class="n">RxDescEndRing</span><span class="p">);</span>

	<span class="cm">/* Clear the completion rings. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DONE_Q_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * be cautious here, wrapping the queue has weird semantics</span>
<span class="cm">	 * and we may not have enough slots even when it seems we do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb_num_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(ZEROCOPY) &amp;&amp; defined(HAS_BROKEN_FIRMWARE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">PADDING_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PADDING_MASK</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* ZEROCOPY &amp;&amp; HAS_BROKEN_FIRMWARE */</span><span class="cp"></span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_num_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">wrap_ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TxDescID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TxCRCEn</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&gt;=</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="n">skb_num_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">TxRingWrap</span><span class="p">;</span>
				<span class="n">wrap_ring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reap_tx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">TxDescIntr</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">reap_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">TxCalTCP</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_compressed</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">skb_first_frag_len</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">skb_num_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb_first_frag_len</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">this_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">this_frag</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					       <span class="n">skb_frag_address</span><span class="p">(</span><span class="n">this_frag</span><span class="p">),</span>
					       <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">this_frag</span><span class="p">),</span>
					       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_dma</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Tx #%d/#%d slot %d status %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span>
			       <span class="n">entry</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrap_ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">used_slots</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="n">entry</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">used_slots</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">used_slots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">used_slots</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* scavenge the tx descriptors twice per TX_RING_SIZE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="p">(</span><span class="n">TX_RING_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">reap_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Non-x86: explicitly flush descriptor cache lines here. */</span>
	<span class="cm">/* Ensure all descriptors are written back before the transmit is</span>
<span class="cm">	   initiated. - Jes */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Update the producer index. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">starfire_tx_desc</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TxProducerIdx</span><span class="p">);</span>

	<span class="cm">/* 4 is arbitrary, but should be ok */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">TX_RING_SIZE</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* The interrupt handler does all of the Rx thread work and cleans up</span>
<span class="cm">   after the Tx thread. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boguscnt</span> <span class="o">=</span> <span class="n">max_interrupt_work</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">consumer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">intr_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrClear</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Interrupt status %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">intr_status</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">enable</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
				<span class="n">enable</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
				<span class="n">enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
				<span class="cm">/* flush PCI posting buffers */</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Paranoia check */</span>
				<span class="n">enable</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;%s: interrupt while in poll!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span><span class="p">);</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Scavenge the skbuff list based on the Tx-done queue.</span>
<span class="cm">		   There are redundant checks here that may be cleaned up</span>
<span class="cm">		   after the driver has proven to be reliable. */</span>
		<span class="n">consumer</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxConsumerIdx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Tx Consumer index is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">consumer</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done</span><span class="p">].</span><span class="n">status</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Tx completion #%d entry %d is %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0xe0000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xa0000000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0xe0000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">starfire_tx_desc</span><span class="p">);</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						 <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
						 <span class="n">skb_first_frag_len</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
						 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">used_slots</span><span class="p">;</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">used_slots</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
								 <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
								 <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
								 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="o">++</span><span class="p">;</span>
						<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DONE_Q_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CompletionQConsumerIdx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* The ring is no longer full, wake the queue. */</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Stats overflow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">IntrStatsMax</span><span class="p">)</span>
			<span class="n">get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Media change interrupt. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">IntrLinkChange</span><span class="p">)</span>
			<span class="n">netdev_media_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Abnormal error summary/uncommon events handlers. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">IntrAbnormalSummary</span><span class="p">)</span>
			<span class="n">netdev_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Too much work at interrupt, &quot;</span>
				       <span class="s">&quot;status=%#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting interrupt, status=%#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This routine is logically part of the interrupt/poll handler, but separated</span>
<span class="cm"> * for clarity and better register allocation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__netdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">quota</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">desc_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If EOP is set on the next entry, it&#39;s a new packet. Send it up. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">desc_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span><span class="p">].</span><span class="n">status</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">rx_done_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span><span class="p">[</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  netdev_rx() status of %d was %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span><span class="p">,</span> <span class="n">desc_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc_status</span> <span class="o">&amp;</span> <span class="n">RxOK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* There was an error. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  netdev_rx() Rx error was %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc_status</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc_status</span> <span class="o">&amp;</span> <span class="n">RxFIFOErr</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next_rx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">quota</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* out of rx quota */</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">quota</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>

		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">desc_status</span><span class="p">;</span>	<span class="cm">/* Implicitly Truncate */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc_status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  netdev_rx() normal Rx pkt length %d, quota %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="o">*</span><span class="n">quota</span><span class="p">);</span>
		<span class="cm">/* Check if the packet is long enough to accept without copying</span>
<span class="cm">		   to a minimally-sized skbuff. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">rx_copybreak</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 16 byte align the IP header */</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						    <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
						    <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						       <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
						       <span class="n">pkt_len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifndef final_version			</span><span class="cm">/* Remove after testing. */</span><span class="cp"></span>
		<span class="cm">/* You will want this info for the initial debug. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  Rx data %pM %pM %2.2x%2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef VLAN_SUPPORT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  netdev_rx() status2 of %d was %#4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_compressed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * This feature doesn&#39;t seem to be working, at least</span>
<span class="cm">		 * with the two firmware versions I have. If the GFP sees</span>
<span class="cm">		 * an IP fragment, it either ignores it completely, or reports</span>
<span class="cm">		 * &quot;bad checksum&quot; on it.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Maybe I missed something -- corrections are welcome.</span>
<span class="cm">		 * Until then, the printk stays. :-) -Ion</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: checksum_hw, status2 = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">));</span>
		<span class="p">}</span>
<span class="cp">#ifdef VLAN_SUPPORT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">vlid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">vlanid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  netdev_rx() vlanid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">vlid</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlid</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* VLAN_SUPPORT */</span><span class="cp"></span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="nl">next_rx:</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DONE_Q_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">quota</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* out of rx quota */</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">CompletionQConsumerIdx</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">refill_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  exiting netdev_rx(): %d, status of %d was %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">retcode</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done</span><span class="p">,</span> <span class="n">desc_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netdev_private</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quota</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrClear</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__netdev_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quota</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">intr_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span><span class="p">));</span>

	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">intr_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>
	<span class="n">intr_status</span> <span class="o">|=</span> <span class="n">IntrRxDone</span> <span class="o">|</span> <span class="n">IntrRxEmpty</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">intr_status</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  exiting netdev_poll(): %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">budget</span> <span class="o">-</span> <span class="n">quota</span><span class="p">);</span>

	<span class="cm">/* Restart Rx engine if stopped. */</span>
	<span class="k">return</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">quota</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">refill_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Refill the Rx ring buffers. */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Better luck next round. */</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">rxaddr</span> <span class="o">=</span>
				<span class="n">cpu_to_dma</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">|</span> <span class="n">RxDescValid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">rxaddr</span> <span class="o">|=</span> <span class="n">cpu_to_dma</span><span class="p">(</span><span class="n">RxDescEndRing</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">RxDescQIdx</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_media_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg0</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">reg4</span><span class="p">,</span> <span class="n">reg5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_tx_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_intr_timer_ctrl</span><span class="p">;</span>

	<span class="cm">/* reset status first */</span>
	<span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMSR</span><span class="p">);</span>

	<span class="n">reg0</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">reg1</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* link is up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg0</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* autonegotiation is enabled */</span>
			<span class="n">reg4</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
			<span class="n">reg5</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_LPA</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg4</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100FULL</span> <span class="o">&amp;&amp;</span> <span class="n">reg5</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg4</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100HALF</span> <span class="o">&amp;&amp;</span> <span class="n">reg5</span> <span class="o">&amp;</span> <span class="n">LPA_100HALF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg4</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10FULL</span> <span class="o">&amp;&amp;</span> <span class="n">reg5</span> <span class="o">&amp;</span> <span class="n">LPA_10FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* autonegotiation is disabled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg0</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg0</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Link is up, running at %sMbit %s-duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span> <span class="o">?</span> <span class="s">&quot;100&quot;</span> <span class="o">:</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>

		<span class="n">new_tx_mode</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FullDuplex</span><span class="p">;</span>	<span class="cm">/* duplex setting */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">)</span>
			<span class="n">new_tx_mode</span> <span class="o">|=</span> <span class="n">FullDuplex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">!=</span> <span class="n">new_tx_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">=</span> <span class="n">new_tx_mode</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">|</span> <span class="n">MiiSoftReset</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxMode</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TxMode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">new_intr_timer_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Timer10X</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">speed100</span><span class="p">)</span>
			<span class="n">new_intr_timer_ctrl</span> <span class="o">|=</span> <span class="n">Timer10X</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">!=</span> <span class="n">new_intr_timer_ctrl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">intr_timer_ctrl</span> <span class="o">=</span> <span class="n">new_intr_timer_ctrl</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">new_intr_timer_ctrl</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrTimerCtrl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Came close to underrunning the Tx FIFO, increase threshold. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">IntrTxDataLow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_threshold</span> <span class="o">&lt;=</span> <span class="n">PKT_BUF_SZ</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="o">++</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_threshold</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TxThreshold</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: PCI bus congestion, increasing Tx FIFO threshold to %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_threshold</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: PCI Tx underflow -- adapter is probably malfunctioning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">IntrRxGFPDead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IntrNoTxCsum</span> <span class="o">|</span> <span class="n">IntrDMAErr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IntrNormalMask</span> <span class="o">|</span> <span class="n">IntrAbnormalSummary</span> <span class="o">|</span> <span class="n">IntrLinkChange</span> <span class="o">|</span> <span class="n">IntrStatsMax</span> <span class="o">|</span> <span class="n">IntrTxDataLow</span> <span class="o">|</span> <span class="n">IntrRxGFPDead</span> <span class="o">|</span> <span class="n">IntrNoTxCsum</span> <span class="o">|</span> <span class="n">IntrPCIPad</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Something Wicked happened! %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/* This adapter architecture needs no SMP locks. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57010</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57044</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57000</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">=</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57024</span><span class="p">)</span> <span class="o">+</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57028</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57018</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57004</span><span class="p">)</span> <span class="o">+</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57008</span><span class="p">);</span>

	<span class="cm">/* The chip only need report frame silently dropped. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxDMAStatus</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxDMAStatus</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x5703C</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57040</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x57058</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x5707C</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef VLAN_SUPPORT</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">set_vlan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">VlanMode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">filter_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">HashTable</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vlan_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_count</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">filter_addr</span><span class="p">);</span>
		<span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">vlan_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_count</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">PerfectFilterVlan</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vlan_count</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filter_addr</span><span class="p">);</span>
			<span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">vlan_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* VLAN_SUPPORT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_mode</span> <span class="o">=</span> <span class="n">MinVLANPrio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef VLAN_SUPPORT</span>
	<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">set_vlan_mode</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* VLAN_SUPPORT */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Set promiscuous. */</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">AcceptAll</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too many to match, or accept all multicasts. */</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">AcceptBroadcast</span><span class="o">|</span><span class="n">AcceptAllMulticast</span><span class="o">|</span><span class="n">PerfectFilter</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use the 16 element perfect filter, skip first two entries. */</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">filter_addr</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PerfFilterTable</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">__be16</span> <span class="o">*</span><span class="n">eaddrs</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eaddrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">eaddrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">AcceptBroadcast</span><span class="o">|</span><span class="n">PerfectFilter</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Must use a multicast hash table. */</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">filter_addr</span><span class="p">;</span>
		<span class="n">__be16</span> <span class="o">*</span><span class="n">eaddrs</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))));</span>	<span class="cm">/* Multicast hash filter */</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The chip uses the upper 9 CRC bits</span>
<span class="cm">			   as index into the hash table */</span>
			<span class="kt">int</span> <span class="n">bit_nr</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">;</span>
			<span class="n">__le32</span> <span class="o">*</span><span class="n">fptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mc_filter</span><span class="p">[(</span><span class="n">bit_nr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">];</span>

			<span class="o">*</span><span class="n">fptr</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_nr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Clear the perfect filter list, skip first two entries. */</span>
		<span class="n">filter_addr</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PerfFilterTable</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">eaddrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eaddrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">filter_addr</span><span class="p">);</span> <span class="n">filter_addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">filter_addr</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HashTable</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">filter_addr</span><span class="o">+=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">filter_addr</span><span class="p">);</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">AcceptBroadcast</span><span class="o">|</span><span class="n">PerfectFilter</span><span class="o">|</span><span class="n">HashFilter</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">rx_mode</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RxFilterMode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_if_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">check_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">begin</span> <span class="o">=</span> <span class="n">check_if_running</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span> <span class="o">=</span> <span class="n">nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span> <span class="o">=</span> <span class="n">get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span> <span class="o">=</span> <span class="n">set_msglevel</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSMIIREG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">==</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="n">check_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Shutting down ethercard, Intr status %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrStatus</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Queue pointers were Tx %d / %d, Rx %d / %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">dirty_rx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupts by clearing the interrupt mask. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IntrEnable</span><span class="p">);</span>

	<span class="cm">/* Stop the chip&#39;s Tx and Rx processes. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GenCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GenCtrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;  Tx ring at %#llx:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="cm">/* TX_RING_SIZE is huge! */</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; #%d desc. %#8.8x %#llx -&gt; %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">),</span>
			       <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dma_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">),</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_done_q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  Rx ring at %#llx -&gt; %p:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="cm">/* RX_RING_SIZE */</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; #%d desc. %#llx -&gt; %#8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dma_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxaddr</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_done_q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Free all the skbuffs in the Rx queue. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxaddr</span> <span class="o">=</span> <span class="n">cpu_to_dma</span><span class="p">(</span><span class="mh">0xBADF00D0</span><span class="p">);</span> <span class="cm">/* An invalid address. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				 <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span><span class="p">,</span>
				 <span class="n">skb_first_frag_len</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">starfire_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netdev_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">starfire_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">starfire_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_size</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">queue_mem_dma</span><span class="p">);</span>


	<span class="cm">/* XXX: add wakeup code -- requires firmware for MagicPacket */</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>	<span class="cm">/* go to sleep in D3 mode */</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>			<span class="cm">/* Will also free np!! */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">starfire_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">starfire_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">starfire_remove_one</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">starfire_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">starfire_resume</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">starfire_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">starfire_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* when a module, this is printed whether or not devices are found in probe */</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: polling (NAPI) enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">netdrv_addr_t</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starfire_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">starfire_cleanup</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">starfire_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">starfire_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">starfire_cleanup</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> *  c-basic-offset: 8</span>
<span class="cm"> *  tab-width: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
