<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › davicom › dm9000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dm9000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *      Davicom DM9000 Fast Ethernet driver for Linux.</span>
<span class="cm"> * 	Copyright (C) 1997  Sten Wang</span>
<span class="cm"> *</span>
<span class="cm"> * 	This program is free software; you can redistribute it and/or</span>
<span class="cm"> * 	modify it under the terms of the GNU General Public License</span>
<span class="cm"> * 	as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * 	of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * 	This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * 	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * 	GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 1997-1998 DAVICOM Semiconductor,Inc. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Additional updates, Copyright:</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *	Sascha Hauer &lt;s.hauer@pengutronix.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/dm9000.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;dm9000.h&quot;</span>

<span class="cm">/* Board/System/Debug information/definition ---------------- */</span>

<span class="cp">#define DM9000_PHY		0x40	</span><span class="cm">/* PHY address 0x01 */</span><span class="cp"></span>

<span class="cp">#define CARDNAME	&quot;dm9000&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.31&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Transmit timeout, default 5 seconds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">watchdog</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">watchdog</span><span class="p">,</span> <span class="s">&quot;transmit timeout in milliseconds&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Debug messages level</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;dm9000 debug level (0-4)&quot;</span><span class="p">);</span>

<span class="cm">/* DM9000 register address locking.</span>
<span class="cm"> *</span>
<span class="cm"> * The DM9000 uses an address register to control where data written</span>
<span class="cm"> * to the data register goes. This means that the address register</span>
<span class="cm"> * must be preserved over interrupts or similar calls.</span>
<span class="cm"> *</span>
<span class="cm"> * During interrupt and other critical calls, a spinlock is used to</span>
<span class="cm"> * protect the system, but the calls themselves save the address</span>
<span class="cm"> * in the address register in case they are interrupting another</span>
<span class="cm"> * access to the device.</span>
<span class="cm"> *</span>
<span class="cm"> * For general accesses a lock is provided so that calls which are</span>
<span class="cm"> * allowed to sleep are serialised so that the address register does</span>
<span class="cm"> * not need to be saved. This lock also serves to serialise access</span>
<span class="cm"> * to the EEPROM and PHY access registers which are shared between</span>
<span class="cm"> * these two devices.</span>
<span class="cm"> */</span>

<span class="cm">/* The driver supports the original DM9000E, and now the two newer</span>
<span class="cm"> * devices, DM9000A and DM9000B.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">dm9000_type</span> <span class="p">{</span>
	<span class="n">TYPE_DM9000E</span><span class="p">,</span>	<span class="cm">/* original DM9000 */</span>
	<span class="n">TYPE_DM9000A</span><span class="p">,</span>
	<span class="n">TYPE_DM9000B</span>
<span class="p">};</span>

<span class="cm">/* Structure/enum declaration ------------------------------- */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">board_info</span> <span class="p">{</span>

	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">io_addr</span><span class="p">;</span>	<span class="cm">/* Register I/O base address */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">io_data</span><span class="p">;</span>	<span class="cm">/* Data I/O address */</span>
	<span class="n">u16</span>		 <span class="n">irq</span><span class="p">;</span>		<span class="cm">/* IRQ */</span>

	<span class="n">u16</span>		<span class="n">tx_pkt_cnt</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">queue_pkt_len</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">queue_start_addr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">queue_ip_summed</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">dbug_cnt</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">io_mode</span><span class="p">;</span>		<span class="cm">/* 0:word, 2:byte */</span>
	<span class="n">u8</span>		<span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">imr_all</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">in_suspend</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">wake_supported</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">dm9000_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">inblk</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">outblk</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dumpblk</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>	     <span class="cm">/* parent device */</span>

	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">addr_res</span><span class="p">;</span>   <span class="cm">/* resources found */</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">data_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">addr_req</span><span class="p">;</span>   <span class="cm">/* resources requested */</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">data_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">irq_res</span><span class="p">;</span>

	<span class="kt">int</span>		 <span class="n">irq_wake</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span>	 <span class="n">addr_lock</span><span class="p">;</span>	<span class="cm">/* phy and eeprom access lock */</span>

	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">phy_poll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">msg_enable</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">wake_state</span><span class="p">;</span>

	<span class="kt">int</span>		<span class="n">ip_summed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">board_info_t</span><span class="p">;</span>

<span class="cm">/* debug code */</span>

<span class="cp">#define dm9000_dbg(db, lev, msg...) do {		\</span>
<span class="cp">	if ((lev) &lt; debug) {				\</span>
<span class="cp">		dev_dbg(db-&gt;dev, msg);			\</span>
<span class="cp">	}						\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">board_info_t</span> <span class="o">*</span><span class="nf">to_dm9000_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DM9000 network board routine ---------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_reset</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resetting device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* RESET device */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">DM9000_NCR</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">NCR_RST</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Read a byte from I/O port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">ior</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span> <span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Write a byte to I/O port</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">iow</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span> <span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* routines for sending block to chip */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_outblk_8bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writesb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_outblk_16bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writesw</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_outblk_32bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writesl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* input block from chip to memory */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_inblk_8bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readsb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_inblk_16bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readsw</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_inblk_32bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readsl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dump block from chip to null */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_dumpblk_8bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_dumpblk_16bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_dumpblk_32bit</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dm9000_set_io</span>
<span class="cm"> *</span>
<span class="cm"> * select the specified set of io routines to use with the</span>
<span class="cm"> * device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_set_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byte_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* use the size of the data resource to work out what IO</span>
<span class="cm">	 * routines we want to use</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">byte_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">dumpblk</span> <span class="o">=</span> <span class="n">dm9000_dumpblk_8bit</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">outblk</span>  <span class="o">=</span> <span class="n">dm9000_outblk_8bit</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">inblk</span>   <span class="o">=</span> <span class="n">dm9000_inblk_8bit</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: 3 byte IO, falling back to 16bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">dumpblk</span> <span class="o">=</span> <span class="n">dm9000_dumpblk_16bit</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">outblk</span>  <span class="o">=</span> <span class="n">dm9000_outblk_16bit</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">inblk</span>   <span class="o">=</span> <span class="n">dm9000_inblk_16bit</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
	<span class="nl">default:</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">dumpblk</span> <span class="o">=</span> <span class="n">dm9000_dumpblk_32bit</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">outblk</span>  <span class="o">=</span> <span class="n">dm9000_outblk_32bit</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">inblk</span>   <span class="o">=</span> <span class="n">dm9000_inblk_32bit</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_schedule_poll</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DM9000E</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_poll</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">dm9000_read_locked</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_wait_eeprom</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* wait max 8msec */</span>

	<span class="cm">/* The DM9000 data sheets say we should be able to</span>
<span class="cm">	 * poll the ERRE bit in EPCR to wait for the EEPROM</span>
<span class="cm">	 * operation. From testing several chips, this bit</span>
<span class="cm">	 * does not seem to work.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We attempt to use the bit, but fall back to the</span>
<span class="cm">	 * timeout (which is why we do not return an error</span>
<span class="cm">	 * on expiry) to say that the EEPROM operation has</span>
<span class="cm">	 * completed.</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dm9000_read_locked</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EPCR_ERRE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Read a word data from EEPROM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_read_eeprom</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_NO_EEPROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">to</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPAR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="n">EPCR_ERPRR</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dm9000_wait_eeprom</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="cm">/* delay for at-least 150uS */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRL</span><span class="p">);</span>
	<span class="n">to</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRH</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a word data to SROM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_write_eeprom</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_NO_EEPROM</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPAR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRH</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRL</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="n">EPCR_WEP</span> <span class="o">|</span> <span class="n">EPCR_ERPRW</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dm9000_wait_eeprom</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* wait at least 150uS to clear */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ethtool ops */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">CARDNAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dm9000_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dm</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_RCSR</span><span class="p">,</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">?</span> <span class="n">RCSR_CSUM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dm9000_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_EXT_PHY</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dm9000_read_locked</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_NSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NSR_LINKST</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DM_EEPROM_MAGIC		(0x444D394B)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">128</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* EEPROM access is aligned to two bytes */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_NO_EEPROM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">DM_EEPROM_MAGIC</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dm9000_read_eeprom</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* EEPROM access is aligned to two bytes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_NO_EEPROM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">DM_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">which</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

			<span class="n">dm9000_read_eeprom</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">tmp</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
			<span class="n">dm9000_write_eeprom</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dm9000_write_eeprom</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_wolinfo</span><span class="p">));</span>

	<span class="cm">/* note, we could probably support wake-phy too */</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">wake_supported</span> <span class="o">?</span> <span class="n">WAKE_MAGIC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">wake_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm9000_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">wake_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">wcr</span> <span class="o">|=</span> <span class="n">WCR_MAGICEN</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_WCR</span><span class="p">,</span> <span class="n">wcr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">wake_state</span> <span class="o">!=</span> <span class="n">opts</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* change in wol state, update IRQ state */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">wake_state</span><span class="p">)</span>
			<span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">wake_state</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opts</span><span class="p">)</span>
			<span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dm</span><span class="o">-&gt;</span><span class="n">wake_state</span> <span class="o">=</span> <span class="n">opts</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">dm9000_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">dm9000_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">dm9000_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">dm9000_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">dm9000_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">dm9000_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">dm9000_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">dm9000_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">dm9000_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">dm9000_set_wol</span><span class="p">,</span>
 	<span class="p">.</span><span class="n">get_eeprom_len</span>		<span class="o">=</span> <span class="n">dm9000_get_eeprom_len</span><span class="p">,</span>
 	<span class="p">.</span><span class="n">get_eeprom</span>		<span class="o">=</span> <span class="n">dm9000_get_eeprom</span><span class="p">,</span>
 	<span class="p">.</span><span class="n">set_eeprom</span>		<span class="o">=</span> <span class="n">dm9000_set_eeprom</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_show_carrier</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="n">carrier</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ncr</span> <span class="o">=</span> <span class="n">dm9000_read_locked</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_NCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: link up, %dMbps, %s-duplex, no LPA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">nsr</span> <span class="o">&amp;</span> <span class="n">NSR_SPEED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">ncr</span> <span class="o">&amp;</span> <span class="n">NCR_FDX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dw</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dw</span><span class="p">,</span> <span class="n">board_info_t</span><span class="p">,</span> <span class="n">phy_poll</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_SIMPLE_PHY</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_EXT_PHY</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">nsr</span> <span class="o">=</span> <span class="n">dm9000_read_locked</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_NSR</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">old_carrier</span> <span class="o">=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">new_carrier</span><span class="p">;</span>

		<span class="n">new_carrier</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsr</span> <span class="o">&amp;</span> <span class="n">NSR_LINKST</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old_carrier</span> <span class="o">!=</span> <span class="n">new_carrier</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
				<span class="n">dm9000_show_carrier</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">new_carrier</span><span class="p">,</span> <span class="n">nsr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_carrier</span><span class="p">)</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mii_check_media</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">netif_msg_link</span><span class="p">(</span><span class="n">db</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">dm9000_schedule_poll</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dm9000_release_board</span>
<span class="cm"> *</span>
<span class="cm"> * release a board, and any mapped resources</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_release_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unmap our resources */</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">);</span>

	<span class="cm">/* release the resources */</span>

	<span class="n">release_resource</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">data_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">data_req</span><span class="p">);</span>

	<span class="n">release_resource</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">dm9000_type_to_char</span><span class="p">(</span><span class="k">enum</span> <span class="n">dm9000_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_DM9000E</span>: <span class="k">return</span> <span class="sc">&#39;e&#39;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_DM9000A</span>: <span class="k">return</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_DM9000B</span>: <span class="k">return</span> <span class="sc">&#39;b&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Set DM9000 multicast address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_hash_table_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">oft</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hash_table</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rcr</span> <span class="o">=</span> <span class="n">RCR_DIS_LONG</span> <span class="o">|</span> <span class="n">RCR_DIS_CRC</span> <span class="o">|</span> <span class="n">RCR_RXEN</span><span class="p">;</span>

	<span class="n">dm9000_dbg</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;entering %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">DM9000_PAR</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">oft</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">oft</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Clear Hash Table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* broadcast address */</span>
	<span class="n">hash_table</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">rcr</span> <span class="o">|=</span> <span class="n">RCR_PRMSC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		<span class="n">rcr</span> <span class="o">|=</span> <span class="n">RCR_ALL</span><span class="p">;</span>

	<span class="cm">/* the multicast address in Hash Table : 64 bits */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hash_val</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">hash_table</span><span class="p">[</span><span class="n">hash_val</span> <span class="o">/</span> <span class="mi">16</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hash_val</span> <span class="o">%</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Write the hash table to MAC MD table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">DM9000_MAR</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">oft</span><span class="o">++</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">oft</span><span class="o">++</span><span class="p">,</span> <span class="n">hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_RCR</span><span class="p">,</span> <span class="n">rcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_hash_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dm9000_hash_table_unlocked</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize dm9000 board</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_init_dm9000</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">imr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ncr</span><span class="p">;</span>

	<span class="n">dm9000_dbg</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;entering %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* I/O mode */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">io_mode</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_ISR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* ISR bit7:6 keeps I/O mode */</span>

	<span class="cm">/* Checksum mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
		<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_RCSR</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">?</span> <span class="n">RCSR_CSUM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_GPCR</span><span class="p">,</span> <span class="n">GPCR_GEP_CNTL</span><span class="p">);</span>	<span class="cm">/* Let GPIO0 output */</span>

	<span class="n">ncr</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_EXT_PHY</span><span class="p">)</span> <span class="o">?</span> <span class="n">NCR_EXT_PHY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if wol is needed, then always set NCR_WAKEEN otherwise we end</span>
<span class="cm">	 * up dumping the wake events if we disable this. There is already</span>
<span class="cm">	 * a wake-mask in DM9000_WCR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">wake_supported</span><span class="p">)</span>
		<span class="n">ncr</span> <span class="o">|=</span> <span class="n">NCR_WAKEEN</span><span class="p">;</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_NCR</span><span class="p">,</span> <span class="n">ncr</span><span class="p">);</span>

	<span class="cm">/* Program operating register */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_TCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	        <span class="cm">/* TX Polling clear */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_BPTR</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>	<span class="cm">/* Less 3Kb, 200us */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_FCR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Flow Control */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_SMCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>        <span class="cm">/* Special Mode */</span>
	<span class="cm">/* clear TX status */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_NSR</span><span class="p">,</span> <span class="n">NSR_WAKEST</span> <span class="o">|</span> <span class="n">NSR_TX2END</span> <span class="o">|</span> <span class="n">NSR_TX1END</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_ISR</span><span class="p">,</span> <span class="n">ISR_CLR_STATUS</span><span class="p">);</span> <span class="cm">/* Clear interrupt status */</span>

	<span class="cm">/* Set address filter table */</span>
	<span class="n">dm9000_hash_table_unlocked</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">imr</span> <span class="o">=</span> <span class="n">IMR_PAR</span> <span class="o">|</span> <span class="n">IMR_PTM</span> <span class="o">|</span> <span class="n">IMR_PRM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_DM9000E</span><span class="p">)</span>
		<span class="n">imr</span> <span class="o">|=</span> <span class="n">IMR_LNKCHNG</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">imr_all</span> <span class="o">=</span> <span class="n">imr</span><span class="p">;</span>

	<span class="cm">/* Enable TX/RX interrupt mask */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_IMR</span><span class="p">,</span> <span class="n">imr</span><span class="p">);</span>

	<span class="cm">/* Init Driver variable */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">queue_pkt_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Our watchdog timed out. Called by the networking layer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">reg_save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Save previous register address */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">reg_save</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dm9000_reset</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	<span class="n">dm9000_init_dm9000</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* We can accept TX packets again */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Restore previous register address */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg_save</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">ip_summed</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">pkt_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">dm</span> <span class="o">=</span> <span class="n">to_dm9000_board</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* The DM9000 is not smart enough to leave fragmented packets alone. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dm</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">!=</span> <span class="n">ip_summed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_NONE</span><span class="p">)</span>
			<span class="n">iow</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_TCCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">iow</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_TCCR</span><span class="p">,</span> <span class="n">TCCR_IP</span> <span class="o">|</span> <span class="n">TCCR_UDP</span> <span class="o">|</span> <span class="n">TCCR_TCP</span><span class="p">);</span>
		<span class="n">dm</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">ip_summed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set TX length to DM9000 */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_TXPLL</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_TXPLH</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Issue TX polling command */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DM9000_TCR</span><span class="p">,</span> <span class="n">TCR_TXREQ</span><span class="p">);</span>	<span class="cm">/* Cleared after TX complete */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Hardware start transmission.</span>
<span class="cm"> *  Send a packet to media from the upper layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dm9000_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dm9000_dbg</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Move data to DM9000 TX RAM */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">DM9000_MWCMD</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">outblk</span><span class="p">)(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* TX control: First packet immediately send, second packet queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm9000_send_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Second packet */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">queue_pkt_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">queue_ip_summed</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="p">;</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* free this SKB */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DM9000 interrupt handler</span>
<span class="cm"> * receive the packet to upper layer, free the transmitted packet</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tx_status</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_NSR</span><span class="p">);</span>	<span class="cm">/* Got TX status */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NSR_TX2END</span> <span class="o">|</span> <span class="n">NSR_TX1END</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* One packet sent complete */</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_done</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx done, NSR %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">);</span>

		<span class="cm">/* Queue packet check &amp; send */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dm9000_send_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">queue_ip_summed</span><span class="p">,</span>
					   <span class="n">db</span><span class="o">-&gt;</span><span class="n">queue_pkt_len</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dm9000_rxhdr</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">RxPktReady</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">RxStatus</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">RxLen</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  Received a packet and pass to upper layer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dm9000_rxhdr</span> <span class="n">rxhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rxbyte</span><span class="p">,</span> <span class="o">*</span><span class="n">rdptr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">GoodPacket</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">RxLen</span><span class="p">;</span>

	<span class="cm">/* Check packet ready or not */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_MRCMDX</span><span class="p">);</span>	<span class="cm">/* Dummy read */</span>

		<span class="cm">/* Get most updated data */</span>
		<span class="n">rxbyte</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">);</span>

		<span class="cm">/* Status check: this byte must be 0 or 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxbyte</span> <span class="o">&amp;</span> <span class="n">DM9000_PKT_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;status check fail: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxbyte</span><span class="p">);</span>
			<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_RCR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Stop Device */</span>
			<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_ISR</span><span class="p">,</span> <span class="n">IMR_PAR</span><span class="p">);</span>	<span class="cm">/* Stop INT request */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxbyte</span> <span class="o">&amp;</span> <span class="n">DM9000_PKT_RDY</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* A packet ready now  &amp; Get status/length */</span>
		<span class="n">GoodPacket</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">DM9000_MRCMD</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

		<span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">inblk</span><span class="p">)(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxhdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxhdr</span><span class="p">));</span>

		<span class="n">RxLen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxhdr</span><span class="p">.</span><span class="n">RxLen</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX: status %02x, length %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rxhdr</span><span class="p">.</span><span class="n">RxStatus</span><span class="p">,</span> <span class="n">RxLen</span><span class="p">);</span>

		<span class="cm">/* Packet Status check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RxLen</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">GoodPacket</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX: Bad Packet (runt)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RxLen</span> <span class="o">&gt;</span> <span class="n">DM9000_PKT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RST: RX Len:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RxLen</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* rxhdr.RxStatus is identical to RSR register. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxhdr</span><span class="p">.</span><span class="n">RxStatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RSR_FOE</span> <span class="o">|</span> <span class="n">RSR_CE</span> <span class="o">|</span> <span class="n">RSR_AE</span> <span class="o">|</span>
				      <span class="n">RSR_PLE</span> <span class="o">|</span> <span class="n">RSR_RWTO</span> <span class="o">|</span>
				      <span class="n">RSR_LCS</span> <span class="o">|</span> <span class="n">RSR_RF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">GoodPacket</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxhdr</span><span class="p">.</span><span class="n">RxStatus</span> <span class="o">&amp;</span> <span class="n">RSR_FOE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fifo error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxhdr</span><span class="p">.</span><span class="n">RxStatus</span> <span class="o">&amp;</span> <span class="n">RSR_CE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;crc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxhdr</span><span class="p">.</span><span class="n">RxStatus</span> <span class="o">&amp;</span> <span class="n">RSR_RF</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;length error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Move data from DM9000 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GoodPacket</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RxLen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">rdptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RxLen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

			<span class="cm">/* Read received packet from RX SRAM */</span>

			<span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">inblk</span><span class="p">)(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">,</span> <span class="n">rdptr</span><span class="p">,</span> <span class="n">RxLen</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">RxLen</span><span class="p">;</span>

			<span class="cm">/* Pass to upper layer */</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((((</span><span class="n">rxbyte</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rxbyte</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* need to dump the packet&#39;s data */</span>

			<span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dumpblk</span><span class="p">)(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">,</span> <span class="n">RxLen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rxbyte</span> <span class="o">&amp;</span> <span class="n">DM9000_PKT_RDY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dm9000_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">int_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_save</span><span class="p">;</span>

	<span class="n">dm9000_dbg</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;entering %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* A real interrupt coming */</span>

	<span class="cm">/* holders of db-&gt;lock must always block IRQs */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Save previous register address */</span>
	<span class="n">reg_save</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="cm">/* Disable all interrupts */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_IMR</span><span class="p">,</span> <span class="n">IMR_PAR</span><span class="p">);</span>

	<span class="cm">/* Got DM9000 interrupt status */</span>
	<span class="n">int_status</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_ISR</span><span class="p">);</span>	<span class="cm">/* Got ISR */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_ISR</span><span class="p">,</span> <span class="n">int_status</span><span class="p">);</span>	<span class="cm">/* Clear ISR status */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">int_status</span><span class="p">);</span>

	<span class="cm">/* Received the coming packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">ISR_PRS</span><span class="p">)</span>
		<span class="n">dm9000_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Trnasmit Interrupt check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">ISR_PTS</span><span class="p">)</span>
		<span class="n">dm9000_tx_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_DM9000E</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">ISR_LNKCHNG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fire a link-change request */</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_poll</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable interrupt mask */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_IMR</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">imr_all</span><span class="p">);</span>

	<span class="cm">/* Restore previous register address */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg_save</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dm9000_wol_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nsr</span><span class="p">,</span> <span class="n">wcr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">nsr</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_NSR</span><span class="p">);</span>
	<span class="n">wcr</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_WCR</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: NSR=0x%02x, WCR=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">nsr</span><span class="p">,</span> <span class="n">wcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsr</span> <span class="o">&amp;</span> <span class="n">NSR_WAKEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear, so we can avoid */</span>
		<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_NSR</span><span class="p">,</span> <span class="n">NSR_WAKEST</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wcr</span> <span class="o">&amp;</span> <span class="n">WCR_LINKST</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wake by link status change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wcr</span> <span class="o">&amp;</span> <span class="n">WCR_SAMPLEST</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wake by sample packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wcr</span> <span class="o">&amp;</span> <span class="n">WCR_MAGICST</span> <span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wake by magic packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WCR_LINKST</span> <span class="o">|</span> <span class="n">WCR_SAMPLEST</span> <span class="o">|</span> <span class="n">WCR_MAGICST</span><span class="p">)))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wake signalled with no reason? &quot;</span>
				<span class="s">&quot;NSR=0x%02x, WSR=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nsr</span><span class="p">,</span> <span class="n">wcr</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">nsr</span> <span class="o">&amp;</span> <span class="n">NSR_WAKEST</span><span class="p">)</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> *Used by netconsole</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dm9000_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Open the interface.</span>
<span class="cm"> *  The interface is opened whenever &quot;ifconfig&quot; actives it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dm9000_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabling %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* If there is no IRQ type specified, default to something that</span>
<span class="cm">	 * may work, and tell the user that this is a problem */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqflags</span> <span class="o">==</span> <span class="n">IRQF_TRIGGER_NONE</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WARNING: no IRQ resource flags set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">irqflags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>

	<span class="cm">/* GPIO0 on pre-activate PHY, Reg 1F is not set by reset */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_GPR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* REG_1F bit0 activate phyxcer */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* delay needs by DM9000B */</span>

	<span class="cm">/* Initialize DM9000 board */</span>
	<span class="n">dm9000_reset</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	<span class="n">dm9000_init_dm9000</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dm9000_interrupt</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* Init driver variable */</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">dbug_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mii_check_media</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">netif_msg_link</span><span class="p">(</span><span class="n">db</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">dm9000_schedule_poll</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sleep, either by using msleep() or if we are suspending, then</span>
<span class="cm"> * use mdelay() to sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm9000_msleep</span><span class="p">(</span><span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">in_suspend</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Read a word from phyxcer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dm9000_phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_reg_unused</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_save</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Save previous register address */</span>
	<span class="n">reg_save</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="cm">/* Fill the phyxcer register into REG_0C */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPAR</span><span class="p">,</span> <span class="n">DM9000_PHY</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="n">EPCR_ERPRR</span> <span class="o">|</span> <span class="n">EPCR_EPOS</span><span class="p">);</span>	<span class="cm">/* Issue phyxcer read command */</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">reg_save</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dm9000_msleep</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* Wait read complete */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reg_save</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>	<span class="cm">/* Clear phyxcer read command */</span>

	<span class="cm">/* The read data keeps on REG_0D &amp; REG_0E */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRL</span><span class="p">);</span>

	<span class="cm">/* restore the previous address */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg_save</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="n">dm9000_dbg</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;phy_read[%02x] -&gt; %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Write a word to phyxcer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">phyaddr_unused</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_save</span><span class="p">;</span>

	<span class="n">dm9000_dbg</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;phy_write[%02x] = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Save previous register address */</span>
	<span class="n">reg_save</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="cm">/* Fill the phyxcer register into REG_0C */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPAR</span><span class="p">,</span> <span class="n">DM9000_PHY</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Fill the written data into REG_0D &amp; REG_0E */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPDRH</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="n">EPCR_EPOS</span> <span class="o">|</span> <span class="n">EPCR_ERPRW</span><span class="p">);</span>	<span class="cm">/* Issue phyxcer write command */</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">reg_save</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dm9000_msleep</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* Wait write complete */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reg_save</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_EPCR</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>	<span class="cm">/* Clear phyxcer write command */</span>

	<span class="cm">/* restore the previous address */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg_save</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dm9000_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* RESET device */</span>
	<span class="n">dm9000_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>	<span class="cm">/* PHY RESET */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_GPR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* Power-Down PHY */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_IMR</span><span class="p">,</span> <span class="n">IMR_PAR</span><span class="p">);</span>	<span class="cm">/* Disable all interrupt */</span>
	<span class="n">iow</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_RCR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Disable RX */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop the interface.</span>
<span class="cm"> * The interface is stopped when it is brought.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dm9000_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifdown</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;shutting down %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_poll</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* free interrupt */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">dm9000_shutdown</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">dm9000_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">dm9000_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">dm9000_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">dm9000_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">dm9000_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">dm9000_hash_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">dm9000_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">dm9000_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">dm9000_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Search DM9000 board, allocate space and register it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">dm9000_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm9000_plat_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">board_info</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>	<span class="cm">/* Point a board information structure */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac_src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iosize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id_val</span><span class="p">;</span>

	<span class="cm">/* Init network device */</span>
	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">board_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dm9000_probe()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* setup board info structure */</span>
	<span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_lock</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">phy_poll</span><span class="p">,</span> <span class="n">dm9000_poll_work</span><span class="p">);</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">data_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_res</span>  <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">data_res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;insufficient resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_wake</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_wake</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wakeup irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">,</span> <span class="n">dm9000_wol_interrupt</span><span class="p">,</span>
				  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot get wakeup irq (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* test to see if irq is really wakeup capable */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %d cannot set wakeup (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">db</span><span class="o">-&gt;</span><span class="n">wake_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">iosize</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_res</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_req</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iosize</span><span class="p">,</span>
					  <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot claim address reg area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">addr_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to ioremap address reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iosize</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">data_res</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">data_req</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">data_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iosize</span><span class="p">,</span>
					  <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">data_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot claim data reg area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">data_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to ioremap data reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill in parameters for net-dev structure */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* ensure at least we have a default set of IO routines */</span>
	<span class="n">dm9000_set_io</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>

	<span class="cm">/* check to see if anything is being over-ridden */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check to see if the driver wants to over-ride the</span>
<span class="cm">		 * default IO width */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_8BITONLY</span><span class="p">)</span>
			<span class="n">dm9000_set_io</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_16BITONLY</span><span class="p">)</span>
			<span class="n">dm9000_set_io</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM9000_PLATF_32BITONLY</span><span class="p">)</span>
			<span class="n">dm9000_set_io</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* check to see if there are any IO routine</span>
<span class="cm">		 * over-rides */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">inblk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">inblk</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">inblk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">outblk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">outblk</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">outblk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dumpblk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">dumpblk</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dumpblk</span><span class="p">;</span>

		<span class="n">db</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DM9000_FORCE_SIMPLE_PHY_POLL</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM9000_PLATF_SIMPLE_PHY</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">dm9000_reset</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="cm">/* try multiple times, DM9000 sometimes gets the read wrong */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id_val</span>  <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_VIDL</span><span class="p">);</span>
		<span class="n">id_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_VIDH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">id_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_PIDL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">id_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_PIDH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id_val</span> <span class="o">==</span> <span class="n">DM9000_ID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read wrong id 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id_val</span> <span class="o">!=</span> <span class="n">DM9000_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wrong id: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id_val</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Identify what type of DM9000 we are working on */</span>

	<span class="n">id_val</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">DM9000_CHIPR</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dm9000 revision 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id_val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id_val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIPR_DM9000A</span>:
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_DM9000A</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIPR_DM9000B</span>:
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_DM9000B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ID %02x =&gt; defaulting to DM9000E</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id_val</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_DM9000E</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* dm9000a/b are capable of hardware checksum offload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DM9000A</span> <span class="o">||</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DM9000B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* from this point we assume that we have found a DM9000 */</span>

	<span class="cm">/* driver system function */</span>
	<span class="n">ether_setup</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dm9000_netdev_ops</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dm9000_ethtool_ops</span><span class="p">;</span>

	<span class="n">db</span><span class="o">-&gt;</span><span class="n">msg_enable</span>       <span class="o">=</span> <span class="n">NETIF_MSG_LINK</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span>  <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span>	     <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span>    <span class="o">=</span> <span class="n">dm9000_phy_read</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span>   <span class="o">=</span> <span class="n">dm9000_phy_write</span><span class="p">;</span>

	<span class="n">mac_src</span> <span class="o">=</span> <span class="s">&quot;eeprom&quot;</span><span class="p">;</span>

	<span class="cm">/* try reading the node address from the attached EEPROM */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dm9000_read_eeprom</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_src</span> <span class="o">=</span> <span class="s">&quot;platform data&quot;</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* try reading from mac */</span>
		
		<span class="n">mac_src</span> <span class="o">=</span> <span class="s">&quot;chip&quot;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ior</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">DM9000_PAR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Invalid ethernet MAC address. Please &quot;</span>
			 <span class="s">&quot;set using ifconfig</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">mac_src</span> <span class="o">=</span> <span class="s">&quot;random&quot;</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: dm9000%c at %p,%p IRQ %d MAC: %pM (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dm9000_type_to_char</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span>
		       <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">io_data</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		       <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac_src</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not found (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dm9000_release_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dm9000_drv_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

		<span class="cm">/* only shutdown if not using WoL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">wake_state</span><span class="p">)</span>
			<span class="n">dm9000_shutdown</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dm9000_drv_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">board_info_t</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* reset if we were not in wake mode to ensure if</span>
<span class="cm">			 * the device was powered off it is in a known state */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">wake_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dm9000_reset</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
				<span class="n">dm9000_init_dm9000</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">db</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">dm9000_drv_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">dm9000_drv_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">dm9000_drv_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span>
<span class="nf">dm9000_drv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dm9000_release_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">));</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>		<span class="cm">/* free device structure */</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;released and freed device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">dm9000_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;dm9000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	 <span class="o">=</span> <span class="o">&amp;</span><span class="n">dm9000_drv_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">dm9000_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">dm9000_drv_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">dm9000_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Ethernet Driver, V%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CARDNAME</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm9000_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">dm9000_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm9000_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dm9000_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dm9000_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sascha Hauer, Ben Dooks&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Davicom DM9000 network driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:dm9000&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
