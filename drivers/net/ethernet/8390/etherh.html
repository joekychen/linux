<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › 8390 › etherh.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>etherh.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/acorn/net/etherh.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2000-2002 Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * NS8390 I-cubed EtherH and ANT EtherM specific driver</span>
<span class="cm"> * Thanks to I-Cubed for information on their cards.</span>
<span class="cm"> * EtherM conversion (C) 1999 Chris Kemp and Tim Watterton</span>
<span class="cm"> * EtherM integration (C) 2000 Aleph One Ltd (Tak-Shing Chan)</span>
<span class="cm"> * EtherM integration re-engineered by Russell King.</span>
<span class="cm"> *</span>
<span class="cm"> * Changelog:</span>
<span class="cm"> *  08-12-1996	RMK	1.00	Created</span>
<span class="cm"> *		RMK	1.03	Added support for EtherLan500 cards</span>
<span class="cm"> *  23-11-1997	RMK	1.04	Added media autodetection</span>
<span class="cm"> *  16-04-1998	RMK	1.05	Improved media autodetection</span>
<span class="cm"> *  10-02-2000	RMK	1.06	Updated for 2.3.43</span>
<span class="cm"> *  13-05-2000	RMK	1.07	Updated for 2.3.99-pre8</span>
<span class="cm"> *  12-10-1999  CK/TEW		EtherM driver first release</span>
<span class="cm"> *  21-12-2000	TTC		EtherH/EtherM integration</span>
<span class="cm"> *  25-12-2000	RMK	1.08	Clean integration of EtherM into this driver.</span>
<span class="cm"> *  03-01-2002	RMK	1.09	Always enable IRQs if we&#39;re in the nic slot.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &lt;asm/ecard.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/system_info.h&gt;</span>

<span class="cp">#define EI_SHIFT(x)	(ei_local-&gt;reg_offset[x])</span>

<span class="cp">#define ei_inb(_p)	 readb((void __iomem *)_p)</span>
<span class="cp">#define ei_outb(_v,_p)	 writeb(_v,(void __iomem *)_p)</span>
<span class="cp">#define ei_inb_p(_p)	 readb((void __iomem *)_p)</span>
<span class="cp">#define ei_outb_p(_v,_p) writeb(_v,(void __iomem *)_p)</span>

<span class="cp">#define NET_DEBUG  0</span>
<span class="cp">#define DEBUG_INIT 2</span>

<span class="cp">#define DRV_NAME	&quot;etherh&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.11&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="s">&quot;EtherH/EtherM Driver (c) 2002-2004 Russell King &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#include &quot;lib8390.c&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">net_debug</span> <span class="o">=</span> <span class="n">NET_DEBUG</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">etherh_priv</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">ioc_fast</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">memc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">dma_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">id</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">ctrl_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">supported</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">etherh_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">ns8390_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">dataport_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">ctrlport_offset</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ctrl_ioc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span>		<span class="n">supported</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">tx_start_page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">stop_page</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Russell King&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;EtherH/EtherM driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define ETHERH500_DATAPORT	0x800	</span><span class="cm">/* MEMC */</span><span class="cp"></span>
<span class="cp">#define ETHERH500_NS8390	0x000	</span><span class="cm">/* MEMC */</span><span class="cp"></span>
<span class="cp">#define ETHERH500_CTRLPORT	0x800	</span><span class="cm">/* IOC  */</span><span class="cp"></span>

<span class="cp">#define ETHERH600_DATAPORT	0x040	</span><span class="cm">/* MEMC */</span><span class="cp"></span>
<span class="cp">#define ETHERH600_NS8390	0x800	</span><span class="cm">/* MEMC */</span><span class="cp"></span>
<span class="cp">#define ETHERH600_CTRLPORT	0x200	</span><span class="cm">/* MEMC */</span><span class="cp"></span>

<span class="cp">#define ETHERH_CP_IE		1</span>
<span class="cp">#define ETHERH_CP_IF		2</span>
<span class="cp">#define ETHERH_CP_HEARTBEAT	2</span>

<span class="cp">#define ETHERH_TX_START_PAGE	1</span>
<span class="cp">#define ETHERH_STOP_PAGE	127</span>

<span class="cm">/*</span>
<span class="cm"> * These came from CK/TEW</span>
<span class="cm"> */</span>
<span class="cp">#define ETHERM_DATAPORT		0x200	</span><span class="cm">/* MEMC */</span><span class="cp"></span>
<span class="cp">#define ETHERM_NS8390		0x800	</span><span class="cm">/* MEMC */</span><span class="cp"></span>
<span class="cp">#define ETHERM_CTRLPORT		0x23c	</span><span class="cm">/* MEMC */</span><span class="cp"></span>

<span class="cp">#define ETHERM_TX_START_PAGE	64</span>
<span class="cp">#define ETHERM_STOP_PAGE	127</span>

<span class="cm">/* ------------------------------------------------------------------------ */</span>

<span class="cp">#define etherh_priv(dev) \</span>
<span class="cp"> ((struct etherh_priv *)(((char *)netdev_priv(dev)) + sizeof(struct ei_device)))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">etherh_set_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">etherh_priv</span> <span class="o">*</span><span class="n">eh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">etherh_clr_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">etherh_priv</span> <span class="o">*</span><span class="n">eh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">etherh_get_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">etherh_priv</span> <span class="o">*</span><span class="n">eh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl_port</span><span class="p">);</span>
<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span> <span class="nf">etherh_irq_enable</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irqnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">etherh_priv</span> <span class="o">*</span><span class="n">eh</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">;</span>

	<span class="n">etherh_set_ctrl</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">ETHERH_CP_IE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">etherh_irq_disable</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irqnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">etherh_priv</span> <span class="o">*</span><span class="n">eh</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">;</span>

	<span class="n">etherh_clr_ctrl</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">ETHERH_CP_IE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">expansioncard_ops_t</span> <span class="n">etherh_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irqenable</span>	<span class="o">=</span> <span class="n">etherh_irq_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irqdisable</span>	<span class="o">=</span> <span class="n">etherh_irq_disable</span><span class="p">,</span>
<span class="p">};</span>




<span class="k">static</span> <span class="kt">void</span>
<span class="nf">etherh_setif</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* set the interface type */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PROD_I3_ETHERLAN600</span>:
	<span class="k">case</span> <span class="n">PROD_I3_ETHERLAN600A</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">EN0_RCNTHI</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASE2</span>:
			<span class="n">writeb</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASET</span>:
			<span class="n">writeb</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PROD_I3_ETHERLAN500</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASE2</span>:
			<span class="n">etherh_clr_ctrl</span><span class="p">(</span><span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">ETHERH_CP_IF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IF_PORT_10BASET</span>:
			<span class="n">etherh_set_ctrl</span><span class="p">(</span><span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">ETHERH_CP_IF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">etherh_getifstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PROD_I3_ETHERLAN600</span>:
	<span class="k">case</span> <span class="n">PROD_I3_ETHERLAN600A</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">EN0_RCNTHI</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASE2</span>:
			<span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASET</span>:
			<span class="n">stat</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PROD_I3_ETHERLAN500</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASE2</span>:
			<span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASET</span>:
			<span class="n">stat</span> <span class="o">=</span> <span class="n">etherh_get_stat</span><span class="p">(</span><span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ETHERH_CP_HEARTBEAT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the interface.  Note that we ignore the other</span>
<span class="cm"> * parts of ifmap, since its mostly meaningless for this driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">etherh_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IF_PORT_10BASE2</span>:
	<span class="k">case</span> <span class="n">IF_PORT_10BASET</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If the user explicitly sets the interface</span>
<span class="cm">		 * media type, turn off automedia detection.</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_AUTOMEDIA</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">etherh_setif</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the 8390 (hard reset).  Note that we can&#39;t actually do this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">etherh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">E8390_NODMA</span><span class="o">+</span><span class="n">E8390_PAGE0</span><span class="o">+</span><span class="n">E8390_STOP</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if we need to change the interface type.</span>
<span class="cm">	 * Note that we use &#39;interface_num&#39; as a flag</span>
<span class="cm">	 * to indicate that we need to change the media.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_AUTOMEDIA</span> <span class="o">&amp;&amp;</span> <span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">interface_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">interface_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">IF_PORT_10BASET</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASE2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASET</span><span class="p">;</span>

		<span class="n">etherh_setif</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a block of data out to the 8390</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">etherh_block_output</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_start</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma_base</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: DMAing conflict in etherh_block_input: &quot;</span>
			<span class="s">&quot; DMAstat %d irqlock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span><span class="p">,</span> <span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure we have a round number of bytes if we&#39;re in word mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">word16</span><span class="p">)</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">dma_base</span> <span class="o">=</span> <span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">E8390_NODMA</span> <span class="o">|</span> <span class="n">E8390_PAGE0</span> <span class="o">|</span> <span class="n">E8390_START</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">E8390_CMD</span><span class="p">);</span>

	<span class="n">writeb</span> <span class="p">(</span><span class="mh">0x42</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="mh">0x42</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">E8390_RREAD</span> <span class="o">|</span> <span class="n">E8390_START</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">E8390_CMD</span><span class="p">);</span>

	<span class="n">udelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">writeb</span> <span class="p">(</span><span class="n">ENISR_RDC</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_ISR</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">start_page</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">E8390_RWRITE</span> <span class="o">|</span> <span class="n">E8390_START</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">E8390_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">word16</span><span class="p">)</span>
		<span class="n">writesw</span> <span class="p">(</span><span class="n">dma_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writesb</span> <span class="p">(</span><span class="n">dma_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">dma_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">readb</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_ISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENISR_RDC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dma_start</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* 20ms */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout waiting for TX RDC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">etherh_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">__NS8390_init</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">writeb</span> <span class="p">(</span><span class="n">ENISR_RDC</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_ISR</span><span class="p">);</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a block of data from the 8390</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">etherh_block_input</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ring_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma_base</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: DMAing conflict in etherh_block_input: &quot;</span>
			<span class="s">&quot; DMAstat %d irqlock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span><span class="p">,</span> <span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">dma_base</span> <span class="o">=</span> <span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">E8390_NODMA</span> <span class="o">|</span> <span class="n">E8390_PAGE0</span> <span class="o">|</span> <span class="n">E8390_START</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">E8390_CMD</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">ring_offset</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">ring_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">E8390_RREAD</span> <span class="o">|</span> <span class="n">E8390_START</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">E8390_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">word16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">readsw</span> <span class="p">(</span><span class="n">dma_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span> <span class="p">(</span><span class="n">dma_base</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">readsb</span> <span class="p">(</span><span class="n">dma_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">writeb</span> <span class="p">(</span><span class="n">ENISR_RDC</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_ISR</span><span class="p">);</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a header from the 8390</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">etherh_get_header</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">e8390_pkt_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ring_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma_base</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: DMAing conflict in etherh_get_header: &quot;</span>
			<span class="s">&quot; DMAstat %d irqlock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span><span class="p">,</span> <span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">dma_base</span> <span class="o">=</span> <span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">;</span>

	<span class="n">writeb</span> <span class="p">(</span><span class="n">E8390_NODMA</span> <span class="o">|</span> <span class="n">E8390_PAGE0</span> <span class="o">|</span> <span class="n">E8390_START</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">E8390_CMD</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">),</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RCNTHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARLO</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">ring_page</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_RSARHI</span><span class="p">);</span>
	<span class="n">writeb</span> <span class="p">(</span><span class="n">E8390_RREAD</span> <span class="o">|</span> <span class="n">E8390_START</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">E8390_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">word16</span><span class="p">)</span>
		<span class="n">readsw</span> <span class="p">(</span><span class="n">dma_base</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">readsb</span> <span class="p">(</span><span class="n">dma_base</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>

	<span class="n">writeb</span> <span class="p">(</span><span class="n">ENISR_RDC</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">EN0_ISR</span><span class="p">);</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">dmaing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open/initialize the board.  This is called (in the current kernel)</span>
<span class="cm"> * sometime after booting when the &#39;ifconfig&#39; program is run.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should set everything up anew at each open, even</span>
<span class="cm"> * registers that &quot;should&quot; only need to be set once at boot, so that</span>
<span class="cm"> * there is non-reboot way to recover if something goes wrong.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">etherh_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: invalid ethernet MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">__ei_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that we aren&#39;t going to change the</span>
<span class="cm">	 * media type on the next reset - we are about to</span>
<span class="cm">	 * do automedia manually now.</span>
<span class="cm">	 */</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">interface_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are doing automedia detection, do it now.</span>
<span class="cm">	 * This is more reliable than the 8390&#39;s detection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_AUTOMEDIA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASET</span><span class="p">;</span>
		<span class="n">etherh_setif</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">etherh_getifstat</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASE2</span><span class="p">;</span>
			<span class="n">etherh_setif</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">etherh_setif</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">etherh_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__ei_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The inverse routine to etherh_open().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">etherh_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__ei_close</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialisation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">etherh_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">version_printed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_debug</span> <span class="o">&amp;&amp;</span> <span class="n">version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the ethernet address string from the on board rom.</span>
<span class="cm"> * This is an ascii string...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">etherh_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_chunk_dir</span> <span class="n">cd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ecard_readchunk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cd</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to read podule description string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">no_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cd</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="o">?</span> <span class="sc">&#39;)&#39;</span> <span class="o">:</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to parse MAC address: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">cd</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>

 <span class="nl">no_addr:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create an ethernet address from the system serial number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">etherm_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">system_serial_low</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">system_serial_high</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">system_serial_low</span> <span class="o">|</span> <span class="n">system_serial_high</span><span class="p">;</span>

	<span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa4</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="p">(</span><span class="n">serial</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">serial</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">serial</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">etherh_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">etherh_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span>	<span class="o">=</span> <span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span>	<span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="n">IF_PORT_10BASET</span> <span class="o">?</span> <span class="n">PORT_TP</span> <span class="o">:</span> <span class="n">PORT_BNC</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span>	<span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_AUTOMEDIA</span> <span class="o">?</span>
			   <span class="n">AUTONEG_ENABLE</span> <span class="o">:</span> <span class="n">AUTONEG_DISABLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">etherh_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AUTONEG_ENABLE</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_AUTOMEDIA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUTONEG_DISABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PORT_TP</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_BNC</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASE2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_AUTOMEDIA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">etherh_setif</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">etherh_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">etherh_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">etherh_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">etherh_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span>	<span class="o">=</span> <span class="n">ethtool_op_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">etherh_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">etherh_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">etherh_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_config</span>		<span class="o">=</span> <span class="n">etherh_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">__ei_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">__ei_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">__ei_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">__ei_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">__ei_poll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">etherh_regoffsets</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">etherm_regoffsets</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">etherh_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ecard_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">etherh_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ei_device</span> <span class="o">*</span><span class="n">ei_local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">etherh_priv</span> <span class="o">*</span><span class="n">eh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">etherh_banner</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ecard_request_resources</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">____alloc_ei_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">etherh_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">etherh_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">etherh_ethtool_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_AUTOMEDIA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_TP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_PORTSEL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_BNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_PORTSEL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASE2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_UNKNOWN</span><span class="p">;</span>

	<span class="n">eh</span> <span class="o">=</span> <span class="n">etherh_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">supported</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">id</span>			<span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">product</span><span class="p">;</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">memc</span>		<span class="o">=</span> <span class="n">ecardm_iomap</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ECARD_RES_MEMC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">memc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl_port</span> <span class="o">=</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">memc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ctrl_ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eh</span><span class="o">-&gt;</span><span class="n">ioc_fast</span> <span class="o">=</span> <span class="n">ecardm_iomap</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ECARD_RES_IOCFAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">ioc_fast</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl_port</span> <span class="o">=</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">ioc_fast</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">memc</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ns8390_offset</span><span class="p">;</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">=</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">memc</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dataport_offset</span><span class="p">;</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctrl_port</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ctrlport_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IRQ and control port handling - only for non-NIC slot cards.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecard_setirq</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">etherh_ops</span><span class="p">,</span> <span class="n">eh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re in the NIC slot, make sure the IRQ is enabled</span>
<span class="cm">		 */</span>
		<span class="n">etherh_set_ctrl</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">ETHERH_CP_IE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ei_local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">page_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">product</span> <span class="o">==</span> <span class="n">PROD_ANT_ETHERM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">etherm_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
		<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="n">etherm_regoffsets</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">etherh_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ec</span><span class="p">);</span>
		<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="n">etherh_regoffsets</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">name</span>          <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">word16</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">tx_start_page</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tx_start_page</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">rx_start_page</span> <span class="o">=</span> <span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">tx_start_page</span> <span class="o">+</span> <span class="n">TX_PAGES</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">stop_page</span>     <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop_page</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">reset_8390</span>    <span class="o">=</span> <span class="n">etherh_reset</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">block_input</span>   <span class="o">=</span> <span class="n">etherh_block_input</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">block_output</span>  <span class="o">=</span> <span class="n">etherh_block_output</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">get_8390_hdr</span>  <span class="o">=</span> <span class="n">etherh_get_header</span><span class="p">;</span>
	<span class="n">ei_local</span><span class="o">-&gt;</span><span class="n">interface_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">etherh_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__NS8390_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s in slot %d, %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">ecard_set_drvdata</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">free:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">release:</span>
	<span class="n">ecard_release_resources</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">etherh_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ecard_get_drvdata</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>

	<span class="n">ecard_set_drvdata</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ecard_release_resources</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">etherh_data</span> <span class="n">etherm_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ns8390_offset</span>		<span class="o">=</span> <span class="n">ETHERM_NS8390</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dataport_offset</span>	<span class="o">=</span> <span class="n">ETHERM_NS8390</span> <span class="o">+</span> <span class="n">ETHERM_DATAPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctrlport_offset</span>	<span class="o">=</span> <span class="n">ETHERM_NS8390</span> <span class="o">+</span> <span class="n">ETHERM_CTRLPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;ANT EtherM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>		<span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_start_page</span>		<span class="o">=</span> <span class="n">ETHERM_TX_START_PAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_page</span>		<span class="o">=</span> <span class="n">ETHERM_STOP_PAGE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">etherh_data</span> <span class="n">etherlan500_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ns8390_offset</span>		<span class="o">=</span> <span class="n">ETHERH500_NS8390</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dataport_offset</span>	<span class="o">=</span> <span class="n">ETHERH500_NS8390</span> <span class="o">+</span> <span class="n">ETHERH500_DATAPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctrlport_offset</span>	<span class="o">=</span> <span class="n">ETHERH500_CTRLPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctrl_ioc</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;i3 EtherH 500&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>		<span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_start_page</span>		<span class="o">=</span> <span class="n">ETHERH_TX_START_PAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_page</span>		<span class="o">=</span> <span class="n">ETHERH_STOP_PAGE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">etherh_data</span> <span class="n">etherlan600_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ns8390_offset</span>		<span class="o">=</span> <span class="n">ETHERH600_NS8390</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dataport_offset</span>	<span class="o">=</span> <span class="n">ETHERH600_NS8390</span> <span class="o">+</span> <span class="n">ETHERH600_DATAPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctrlport_offset</span>	<span class="o">=</span> <span class="n">ETHERH600_NS8390</span> <span class="o">+</span> <span class="n">ETHERH600_CTRLPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;i3 EtherH 600&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>		<span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_TP</span> <span class="o">|</span> <span class="n">SUPPORTED_BNC</span> <span class="o">|</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_start_page</span>		<span class="o">=</span> <span class="n">ETHERH_TX_START_PAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_page</span>		<span class="o">=</span> <span class="n">ETHERH_STOP_PAGE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">etherh_data</span> <span class="n">etherlan600a_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ns8390_offset</span>		<span class="o">=</span> <span class="n">ETHERH600_NS8390</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dataport_offset</span>	<span class="o">=</span> <span class="n">ETHERH600_NS8390</span> <span class="o">+</span> <span class="n">ETHERH600_DATAPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctrlport_offset</span>	<span class="o">=</span> <span class="n">ETHERH600_NS8390</span> <span class="o">+</span> <span class="n">ETHERH600_CTRLPORT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;i3 EtherH 600A&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>		<span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_TP</span> <span class="o">|</span> <span class="n">SUPPORTED_BNC</span> <span class="o">|</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_start_page</span>		<span class="o">=</span> <span class="n">ETHERH_TX_START_PAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_page</span>		<span class="o">=</span> <span class="n">ETHERH_STOP_PAGE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ecard_id</span> <span class="n">etherh_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">MANU_ANT</span><span class="p">,</span> <span class="n">PROD_ANT_ETHERM</span><span class="p">,</span>      <span class="o">&amp;</span><span class="n">etherm_data</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">MANU_I3</span><span class="p">,</span>  <span class="n">PROD_I3_ETHERLAN500</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">etherlan500_data</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MANU_I3</span><span class="p">,</span>  <span class="n">PROD_I3_ETHERLAN600</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">etherlan600_data</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MANU_I3</span><span class="p">,</span>  <span class="n">PROD_I3_ETHERLAN600A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">etherlan600a_data</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span><span class="p">,</span>   <span class="mh">0xffff</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ecard_driver</span> <span class="n">etherh_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">etherh_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">etherh_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">etherh_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">etherh_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">etherh_regoffsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">etherm_regoffsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ecard_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etherh_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">etherh_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_remove_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etherh_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">etherh_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">etherh_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
