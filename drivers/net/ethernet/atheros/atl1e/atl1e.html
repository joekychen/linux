<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › atheros › atl1e › atl1e.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>atl1e.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright(c) 2007 Atheros Corporation. All rights reserved.</span>
<span class="cm"> * Copyright(c) 2007 xiong huang &lt;xiong.huang@atheros.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from Intel e1000 driver</span>
<span class="cm"> * Copyright(c) 1999 - 2005 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> * Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _ATL1E_H_</span>
<span class="cp">#define _ATL1E_H_</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>

<span class="cp">#include &quot;atl1e_hw.h&quot;</span>

<span class="cp">#define PCI_REG_COMMAND	 0x04    </span><span class="cm">/* PCI Command Register */</span><span class="cp"></span>
<span class="cp">#define CMD_IO_SPACE	 0x0001</span>
<span class="cp">#define CMD_MEMORY_SPACE 0x0002</span>
<span class="cp">#define CMD_BUS_MASTER   0x0004</span>

<span class="cp">#define BAR_0   0</span>
<span class="cp">#define BAR_1   1</span>
<span class="cp">#define BAR_5   5</span>

<span class="cm">/* Wake Up Filter Control */</span>
<span class="cp">#define AT_WUFC_LNKC 0x00000001 </span><span class="cm">/* Link Status Change Wakeup Enable */</span><span class="cp"></span>
<span class="cp">#define AT_WUFC_MAG  0x00000002 </span><span class="cm">/* Magic Packet Wakeup Enable */</span><span class="cp"></span>
<span class="cp">#define AT_WUFC_EX   0x00000004 </span><span class="cm">/* Directed Exact Wakeup Enable */</span><span class="cp"></span>
<span class="cp">#define AT_WUFC_MC   0x00000008 </span><span class="cm">/* Multicast Wakeup Enable */</span><span class="cp"></span>
<span class="cp">#define AT_WUFC_BC   0x00000010 </span><span class="cm">/* Broadcast Wakeup Enable */</span><span class="cp"></span>

<span class="cp">#define SPEED_0		   0xffff</span>
<span class="cp">#define HALF_DUPLEX        1</span>
<span class="cp">#define FULL_DUPLEX        2</span>

<span class="cm">/* Error Codes */</span>
<span class="cp">#define AT_ERR_EEPROM      1</span>
<span class="cp">#define AT_ERR_PHY         2</span>
<span class="cp">#define AT_ERR_CONFIG      3</span>
<span class="cp">#define AT_ERR_PARAM       4</span>
<span class="cp">#define AT_ERR_MAC_TYPE    5</span>
<span class="cp">#define AT_ERR_PHY_TYPE    6</span>
<span class="cp">#define AT_ERR_PHY_SPEED   7</span>
<span class="cp">#define AT_ERR_PHY_RES     8</span>
<span class="cp">#define AT_ERR_TIMEOUT     9</span>

<span class="cp">#define MAX_JUMBO_FRAME_SIZE 0x2000</span>

<span class="cp">#define AT_VLAN_TAG_TO_TPD_TAG(_vlan, _tpd)    \</span>
<span class="cp">	_tpd = (((_vlan) &lt;&lt; (4)) | (((_vlan) &gt;&gt; 13) &amp; 7) |\</span>
<span class="cp">		 (((_vlan) &gt;&gt; 9) &amp; 8))</span>

<span class="cp">#define AT_TPD_TAG_TO_VLAN_TAG(_tpd, _vlan)    \</span>
<span class="cp">	_vlan = (((_tpd) &gt;&gt; 8) | (((_tpd) &amp; 0x77) &lt;&lt; 9) |\</span>
<span class="cp">		   (((_tdp) &amp; 0x88) &lt;&lt; 5))</span>

<span class="cp">#define AT_MAX_RECEIVE_QUEUE    4</span>
<span class="cp">#define AT_PAGE_NUM_PER_QUEUE   2</span>

<span class="cp">#define AT_DMA_HI_ADDR_MASK     0xffffffff00000000ULL</span>
<span class="cp">#define AT_DMA_LO_ADDR_MASK     0x00000000ffffffffULL</span>

<span class="cp">#define AT_TX_WATCHDOG  (5 * HZ)</span>
<span class="cp">#define AT_MAX_INT_WORK		10</span>
<span class="cp">#define AT_TWSI_EEPROM_TIMEOUT 	100</span>
<span class="cp">#define AT_HW_MAX_IDLE_DELAY 	10</span>
<span class="cp">#define AT_SUSPEND_LINK_TIMEOUT 28</span>

<span class="cp">#define AT_REGS_LEN	75</span>
<span class="cp">#define AT_EEPROM_LEN 	512</span>
<span class="cp">#define AT_ADV_MASK	(ADVERTISE_10_HALF  |\</span>
<span class="cp">			 ADVERTISE_10_FULL  |\</span>
<span class="cp">			 ADVERTISE_100_HALF |\</span>
<span class="cp">			 ADVERTISE_100_FULL |\</span>
<span class="cp">			 ADVERTISE_1000_FULL)</span>

<span class="cm">/* tpd word 2 */</span>
<span class="cp">#define TPD_BUFLEN_MASK 	0x3FFF</span>
<span class="cp">#define TPD_BUFLEN_SHIFT        0</span>
<span class="cp">#define TPD_DMAINT_MASK		0x0001</span>
<span class="cp">#define TPD_DMAINT_SHIFT        14</span>
<span class="cp">#define TPD_PKTNT_MASK          0x0001</span>
<span class="cp">#define TPD_PKTINT_SHIFT        15</span>
<span class="cp">#define TPD_VLANTAG_MASK        0xFFFF</span>
<span class="cp">#define TPD_VLAN_SHIFT          16</span>

<span class="cm">/* tpd word 3 bits 0:4 */</span>
<span class="cp">#define TPD_EOP_MASK            0x0001</span>
<span class="cp">#define TPD_EOP_SHIFT           0</span>
<span class="cp">#define TPD_IP_VERSION_MASK	0x0001</span>
<span class="cp">#define TPD_IP_VERSION_SHIFT	1	</span><span class="cm">/* 0 : IPV4, 1 : IPV6 */</span><span class="cp"></span>
<span class="cp">#define TPD_INS_VL_TAG_MASK	0x0001</span>
<span class="cp">#define TPD_INS_VL_TAG_SHIFT	2</span>
<span class="cp">#define TPD_CC_SEGMENT_EN_MASK	0x0001</span>
<span class="cp">#define TPD_CC_SEGMENT_EN_SHIFT	3</span>
<span class="cp">#define TPD_SEGMENT_EN_MASK     0x0001</span>
<span class="cp">#define TPD_SEGMENT_EN_SHIFT    4</span>

<span class="cm">/* tdp word 3 bits 5:7 if ip version is 0 */</span>
<span class="cp">#define TPD_IP_CSUM_MASK        0x0001</span>
<span class="cp">#define TPD_IP_CSUM_SHIFT       5</span>
<span class="cp">#define TPD_TCP_CSUM_MASK       0x0001</span>
<span class="cp">#define TPD_TCP_CSUM_SHIFT      6</span>
<span class="cp">#define TPD_UDP_CSUM_MASK       0x0001</span>
<span class="cp">#define TPD_UDP_CSUM_SHIFT      7</span>

<span class="cm">/* tdp word 3 bits 5:7 if ip version is 1 */</span>
<span class="cp">#define TPD_V6_IPHLLO_MASK	0x0007</span>
<span class="cp">#define TPD_V6_IPHLLO_SHIFT	7</span>

<span class="cm">/* tpd word 3 bits 8:9 bit */</span>
<span class="cp">#define TPD_VL_TAGGED_MASK      0x0001</span>
<span class="cp">#define TPD_VL_TAGGED_SHIFT     8</span>
<span class="cp">#define TPD_ETHTYPE_MASK        0x0001</span>
<span class="cp">#define TPD_ETHTYPE_SHIFT       9</span>

<span class="cm">/* tdp word 3 bits 10:13 if ip version is 0 */</span>
<span class="cp">#define TDP_V4_IPHL_MASK	0x000F</span>
<span class="cp">#define TPD_V4_IPHL_SHIFT	10</span>

<span class="cm">/* tdp word 3 bits 10:13 if ip version is 1 */</span>
<span class="cp">#define TPD_V6_IPHLHI_MASK	0x000F</span>
<span class="cp">#define TPD_V6_IPHLHI_SHIFT	10</span>

<span class="cm">/* tpd word 3 bit 14:31 if segment enabled */</span>
<span class="cp">#define TPD_TCPHDRLEN_MASK      0x000F</span>
<span class="cp">#define TPD_TCPHDRLEN_SHIFT     14</span>
<span class="cp">#define TPD_HDRFLAG_MASK        0x0001</span>
<span class="cp">#define TPD_HDRFLAG_SHIFT       18</span>
<span class="cp">#define TPD_MSS_MASK            0x1FFF</span>
<span class="cp">#define TPD_MSS_SHIFT           19</span>

<span class="cm">/* tdp word 3 bit 16:31 if custom csum enabled */</span>
<span class="cp">#define TPD_PLOADOFFSET_MASK    0x00FF</span>
<span class="cp">#define TPD_PLOADOFFSET_SHIFT   16</span>
<span class="cp">#define TPD_CCSUMOFFSET_MASK    0x00FF</span>
<span class="cp">#define TPD_CCSUMOFFSET_SHIFT   24</span>

<span class="k">struct</span> <span class="n">atl1e_tpd_desc</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">buffer_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">word2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">word3</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* how about 0x2000 */</span>
<span class="cp">#define MAX_TX_BUF_LEN      0x2000</span>
<span class="cp">#define MAX_TX_BUF_SHIFT    13</span>
<span class="cm">/*#define MAX_TX_BUF_LEN  0x3000 */</span>

<span class="cm">/* rrs word 1 bit 0:31 */</span>
<span class="cp">#define RRS_RX_CSUM_MASK	0xFFFF</span>
<span class="cp">#define RRS_RX_CSUM_SHIFT	0</span>
<span class="cp">#define RRS_PKT_SIZE_MASK	0x3FFF</span>
<span class="cp">#define RRS_PKT_SIZE_SHIFT	16</span>
<span class="cp">#define RRS_CPU_NUM_MASK	0x0003</span>
<span class="cp">#define	RRS_CPU_NUM_SHIFT	30</span>

<span class="cp">#define	RRS_IS_RSS_IPV4		0x0001</span>
<span class="cp">#define RRS_IS_RSS_IPV4_TCP	0x0002</span>
<span class="cp">#define RRS_IS_RSS_IPV6		0x0004</span>
<span class="cp">#define RRS_IS_RSS_IPV6_TCP	0x0008</span>
<span class="cp">#define RRS_IS_IPV6		0x0010</span>
<span class="cp">#define RRS_IS_IP_FRAG		0x0020</span>
<span class="cp">#define RRS_IS_IP_DF		0x0040</span>
<span class="cp">#define RRS_IS_802_3		0x0080</span>
<span class="cp">#define RRS_IS_VLAN_TAG		0x0100</span>
<span class="cp">#define RRS_IS_ERR_FRAME	0x0200</span>
<span class="cp">#define RRS_IS_IPV4		0x0400</span>
<span class="cp">#define RRS_IS_UDP		0x0800</span>
<span class="cp">#define RRS_IS_TCP		0x1000</span>
<span class="cp">#define RRS_IS_BCAST		0x2000</span>
<span class="cp">#define RRS_IS_MCAST		0x4000</span>
<span class="cp">#define RRS_IS_PAUSE		0x8000</span>

<span class="cp">#define RRS_ERR_BAD_CRC		0x0001</span>
<span class="cp">#define RRS_ERR_CODE		0x0002</span>
<span class="cp">#define RRS_ERR_DRIBBLE		0x0004</span>
<span class="cp">#define RRS_ERR_RUNT		0x0008</span>
<span class="cp">#define RRS_ERR_RX_OVERFLOW	0x0010</span>
<span class="cp">#define RRS_ERR_TRUNC		0x0020</span>
<span class="cp">#define RRS_ERR_IP_CSUM		0x0040</span>
<span class="cp">#define RRS_ERR_L4_CSUM		0x0080</span>
<span class="cp">#define RRS_ERR_LENGTH		0x0100</span>
<span class="cp">#define RRS_ERR_DES_ADDR	0x0200</span>

<span class="k">struct</span> <span class="n">atl1e_recv_ret_status</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">seq_num</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hash_lo</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">word1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pkt_flag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err_flag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hash_hi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vtag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">atl1e_dma_req_block</span> <span class="p">{</span>
	<span class="n">atl1e_dma_req_128</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">atl1e_dma_req_256</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">atl1e_dma_req_512</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">atl1e_dma_req_1024</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">atl1e_dma_req_2048</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">atl1e_dma_req_4096</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">atl1e_rrs_type</span> <span class="p">{</span>
	<span class="n">atl1e_rrs_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">atl1e_rrs_ipv4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">atl1e_rrs_ipv4_tcp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">atl1e_rrs_ipv6</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">atl1e_rrs_ipv6_tcp</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">atl1e_nic_type</span> <span class="p">{</span>
	<span class="n">athr_l1e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">athr_l2e_revA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">athr_l2e_revB</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">atl1e_hw_stats</span> <span class="p">{</span>
	<span class="cm">/* rx */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_ok</span><span class="p">;</span>	      <span class="cm">/* The number of good packet received. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_bcast</span><span class="p">;</span>       <span class="cm">/* The number of good broadcast packet received. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_mcast</span><span class="p">;</span>       <span class="cm">/* The number of good multicast packet received. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_pause</span><span class="p">;</span>       <span class="cm">/* The number of Pause packet received. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_ctrl</span><span class="p">;</span>        <span class="cm">/* The number of Control packet received other than Pause frame. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_fcs_err</span><span class="p">;</span>     <span class="cm">/* The number of packets with bad FCS. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_len_err</span><span class="p">;</span>     <span class="cm">/* The number of packets with mismatch of length field and actual size. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_byte_cnt</span><span class="p">;</span>    <span class="cm">/* The number of bytes of good packet received. FCS is NOT included. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_runt</span><span class="p">;</span>        <span class="cm">/* The number of packets received that are less than 64 byte long and with good FCS. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_frag</span><span class="p">;</span>        <span class="cm">/* The number of packets received that are less than 64 byte long and with bad FCS. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_64</span><span class="p">;</span>       <span class="cm">/* The number of good and bad packets received that are 64 byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_65_127</span><span class="p">;</span>   <span class="cm">/* The number of good and bad packets received that are between 65 and 127-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_128_255</span><span class="p">;</span>  <span class="cm">/* The number of good and bad packets received that are between 128 and 255-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_256_511</span><span class="p">;</span>  <span class="cm">/* The number of good and bad packets received that are between 256 and 511-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_512_1023</span><span class="p">;</span> <span class="cm">/* The number of good and bad packets received that are between 512 and 1023-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_1024_1518</span><span class="p">;</span>    <span class="cm">/* The number of good and bad packets received that are between 1024 and 1518-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_1519_max</span><span class="p">;</span> <span class="cm">/* The number of good and bad packets received that are between 1519-byte and MTU. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_sz_ov</span><span class="p">;</span>       <span class="cm">/* The number of good and bad packets received that are more than MTU size truncated by Selene. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_rxf_ov</span><span class="p">;</span>      <span class="cm">/* The number of frame dropped due to occurrence of RX FIFO overflow. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_rrd_ov</span><span class="p">;</span>      <span class="cm">/* The number of frame dropped due to occurrence of RRD overflow. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_align_err</span><span class="p">;</span>   <span class="cm">/* Alignment Error */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_bcast_byte_cnt</span><span class="p">;</span>  <span class="cm">/* The byte count of broadcast packet received, excluding FCS. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_mcast_byte_cnt</span><span class="p">;</span>  <span class="cm">/* The byte count of multicast packet received, excluding FCS. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_err_addr</span><span class="p">;</span>    <span class="cm">/* The number of packets dropped due to address filtering. */</span>

	<span class="cm">/* tx */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_ok</span><span class="p">;</span>      <span class="cm">/* The number of good packet transmitted. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_bcast</span><span class="p">;</span>       <span class="cm">/* The number of good broadcast packet transmitted. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_mcast</span><span class="p">;</span>       <span class="cm">/* The number of good multicast packet transmitted. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_pause</span><span class="p">;</span>       <span class="cm">/* The number of Pause packet transmitted. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_exc_defer</span><span class="p">;</span>   <span class="cm">/* The number of packets transmitted with excessive deferral. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_ctrl</span><span class="p">;</span>        <span class="cm">/* The number of packets transmitted is a control frame, excluding Pause frame. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_defer</span><span class="p">;</span>       <span class="cm">/* The number of packets transmitted that is deferred. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_byte_cnt</span><span class="p">;</span>    <span class="cm">/* The number of bytes of data transmitted. FCS is NOT included. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_sz_64</span><span class="p">;</span>       <span class="cm">/* The number of good and bad packets transmitted that are 64 byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_sz_65_127</span><span class="p">;</span>   <span class="cm">/* The number of good and bad packets transmitted that are between 65 and 127-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_sz_128_255</span><span class="p">;</span>  <span class="cm">/* The number of good and bad packets transmitted that are between 128 and 255-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_sz_256_511</span><span class="p">;</span>  <span class="cm">/* The number of good and bad packets transmitted that are between 256 and 511-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_sz_512_1023</span><span class="p">;</span> <span class="cm">/* The number of good and bad packets transmitted that are between 512 and 1023-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_sz_1024_1518</span><span class="p">;</span>    <span class="cm">/* The number of good and bad packets transmitted that are between 1024 and 1518-byte long. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_sz_1519_max</span><span class="p">;</span> <span class="cm">/* The number of good and bad packets transmitted that are between 1519-byte and MTU. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_1_col</span><span class="p">;</span>       <span class="cm">/* The number of packets subsequently transmitted successfully with a single prior collision. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_2_col</span><span class="p">;</span>       <span class="cm">/* The number of packets subsequently transmitted successfully with multiple prior collisions. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_late_col</span><span class="p">;</span>    <span class="cm">/* The number of packets transmitted with late collisions. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_abort_col</span><span class="p">;</span>   <span class="cm">/* The number of transmit packets aborted due to excessive collisions. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_underrun</span><span class="p">;</span>    <span class="cm">/* The number of transmit packets aborted due to transmit FIFO underrun, or TRD FIFO underrun */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_rd_eop</span><span class="p">;</span>      <span class="cm">/* The number of times that read beyond the EOP into the next frame area when TRD was not written timely */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_len_err</span><span class="p">;</span>     <span class="cm">/* The number of transmit packets with length field does NOT match the actual frame size. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_trunc</span><span class="p">;</span>       <span class="cm">/* The number of transmit packets truncated due to size exceeding MTU. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_bcast_byte</span><span class="p">;</span>  <span class="cm">/* The byte count of broadcast packet transmitted, excluding FCS. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_mcast_byte</span><span class="p">;</span>  <span class="cm">/* The byte count of multicast packet transmitted, excluding FCS. */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">atl1e_hw</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span>      <span class="o">*</span><span class="n">hw_addr</span><span class="p">;</span>            <span class="cm">/* inner register address */</span>
	<span class="n">resource_size_t</span> <span class="n">mem_rang</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl1e_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">atl1e_nic_type</span>  <span class="n">nic_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subsystem_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subsystem_vendor_id</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">revision_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_cmd_word</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">perm_mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">preamble_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_frame_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_jumbo_th</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_jumbo_th</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">media_type</span><span class="p">;</span>
<span class="cp">#define MEDIA_TYPE_AUTO_SENSOR  0</span>
<span class="cp">#define MEDIA_TYPE_100M_FULL    1</span>
<span class="cp">#define MEDIA_TYPE_100M_HALF    2</span>
<span class="cp">#define MEDIA_TYPE_10M_FULL     3</span>
<span class="cp">#define MEDIA_TYPE_10M_HALF     4</span>

	<span class="n">u16</span> <span class="n">autoneg_advertised</span><span class="p">;</span>
<span class="cp">#define ADVERTISE_10_HALF               0x0001</span>
<span class="cp">#define ADVERTISE_10_FULL               0x0002</span>
<span class="cp">#define ADVERTISE_100_HALF              0x0004</span>
<span class="cp">#define ADVERTISE_100_FULL              0x0008</span>
<span class="cp">#define ADVERTISE_1000_HALF             0x0010 </span><span class="cm">/* Not used, just FYI */</span><span class="cp"></span>
<span class="cp">#define ADVERTISE_1000_FULL             0x0020</span>
	<span class="n">u16</span> <span class="n">mii_autoneg_adv_reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mii_1000t_ctrl_reg</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">imt</span><span class="p">;</span>        <span class="cm">/* Interrupt Moderator timer ( 2us resolution) */</span>
	<span class="n">u16</span> <span class="n">ict</span><span class="p">;</span>        <span class="cm">/* Interrupt Clear timer (2us resolution) */</span>
	<span class="n">u32</span> <span class="n">smb_timer</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rrd_thresh</span><span class="p">;</span> <span class="cm">/* Threshold of number of RRD produced to trigger</span>
<span class="cm">			  interrupt request */</span>
	<span class="n">u16</span> <span class="n">tpd_thresh</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_count_down</span><span class="p">;</span> <span class="cm">/* 2us resolution */</span>
	<span class="n">u16</span> <span class="n">tx_count_down</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">tpd_burst</span><span class="p">;</span>   <span class="cm">/* Number of TPD to prefetch in cache-aligned burst. */</span>
	<span class="k">enum</span> <span class="n">atl1e_rrs_type</span> <span class="n">rrs_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base_cpu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">indirect_tab</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">atl1e_dma_req_block</span> <span class="n">dmar_block</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">atl1e_dma_req_block</span> <span class="n">dmaw_block</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dmaw_dly_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dmar_dly_cnt</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">phy_configured</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">re_autoneg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">emi_ca</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * wrapper around a pointer to a socket buffer,</span>
<span class="cm"> * so a DMA handle can be stored along with the buffer</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">atl1e_tx_buffer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define ATL1E_TX_PCIMAP_SINGLE		0x0001</span>
<span class="cp">#define ATL1E_TX_PCIMAP_PAGE		0x0002</span>
<span class="cp">#define ATL1E_TX_PCIMAP_TYPE_MASK	0x0003</span>
	<span class="n">u16</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ATL1E_SET_PCIMAP_TYPE(tx_buff, type) do {		\</span>
<span class="cp">	((tx_buff)-&gt;flags) &amp;= ~ATL1E_TX_PCIMAP_TYPE_MASK;	\</span>
<span class="cp">	((tx_buff)-&gt;flags) |= (type);				\</span>
<span class="cp">	} while (0)</span>

<span class="k">struct</span> <span class="n">atl1e_rx_page</span> <span class="p">{</span>
	<span class="n">dma_addr_t</span>	<span class="n">dma</span><span class="p">;</span>    <span class="cm">/* receive rage DMA address */</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">addr</span><span class="p">;</span>   <span class="cm">/* receive rage virtual address */</span>
	<span class="n">dma_addr_t</span>	<span class="n">write_offset_dma</span><span class="p">;</span>  <span class="cm">/* the DMA address which contain the</span>
<span class="cm">					      receive data offset in the page */</span>
	<span class="n">u32</span>		<span class="o">*</span><span class="n">write_offset_addr</span><span class="p">;</span> <span class="cm">/* the virtaul address which contain</span>
<span class="cm">					     the receive data offset in the page */</span>
	<span class="n">u32</span>		<span class="n">read_offset</span><span class="p">;</span>       <span class="cm">/* the offset where we have read */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">atl1e_rx_page_desc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl1e_rx_page</span>   <span class="n">rx_page</span><span class="p">[</span><span class="n">AT_PAGE_NUM_PER_QUEUE</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">rx_using</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_nxseq</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* transmit packet descriptor (tpd) ring */</span>
<span class="k">struct</span> <span class="n">atl1e_tx_ring</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl1e_tpd_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>  <span class="cm">/* descriptor ring virtual address  */</span>
	<span class="n">dma_addr_t</span>	   <span class="n">dma</span><span class="p">;</span>    <span class="cm">/* descriptor ring physical address */</span>
	<span class="n">u16</span>       	   <span class="n">count</span><span class="p">;</span>  <span class="cm">/* the count of transmit rings  */</span>
	<span class="n">rwlock_t</span>	   <span class="n">tx_lock</span><span class="p">;</span>
	<span class="n">u16</span>		   <span class="n">next_to_use</span><span class="p">;</span>
	<span class="n">atomic_t</span>	   <span class="n">next_to_clean</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl1e_tx_buffer</span> <span class="o">*</span><span class="n">tx_buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	   <span class="n">cmb_dma</span><span class="p">;</span>
	<span class="n">u32</span>		   <span class="o">*</span><span class="n">cmb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* receive packet descriptor ring */</span>
<span class="k">struct</span> <span class="n">atl1e_rx_ring</span> <span class="p">{</span>
	<span class="kt">void</span>        	<span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>  	<span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span>         	<span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span>	    	<span class="n">page_size</span><span class="p">;</span> <span class="cm">/* bytes length of rxf page */</span>
	<span class="n">u32</span>		<span class="n">real_page_size</span><span class="p">;</span> <span class="cm">/* real_page_size = page_size + jumbo + aliagn */</span>
	<span class="k">struct</span> <span class="n">atl1e_rx_page_desc</span>	<span class="n">rx_page_desc</span><span class="p">[</span><span class="n">AT_MAX_RECEIVE_QUEUE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* board specific private data structure */</span>
<span class="k">struct</span> <span class="n">atl1e_adapter</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>   <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>      <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span>  <span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span>  <span class="n">mii</span><span class="p">;</span>    <span class="cm">/* MII interface info */</span>
	<span class="k">struct</span> <span class="n">atl1e_hw</span>        <span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl1e_hw_stats</span>  <span class="n">hw_stats</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">have_msi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wol</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">link_speed</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">link_duplex</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">mdio_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">tx_lock</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">irq_sem</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">reset_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">link_chg_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">watchdog_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">phy_config_timer</span><span class="p">;</span>

	<span class="cm">/* All Descriptor memory */</span>
	<span class="n">dma_addr_t</span>  	<span class="n">ring_dma</span><span class="p">;</span>
	<span class="kt">void</span>     	<span class="o">*</span><span class="n">ring_vir_addr</span><span class="p">;</span>
	<span class="n">u32</span>             <span class="n">ring_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">atl1e_tx_ring</span> <span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl1e_rx_ring</span> <span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rx_queues</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define __AT_TESTING        0x0001</span>
<span class="cp">#define __AT_RESETTING      0x0002</span>
<span class="cp">#define __AT_DOWN           0x0003</span>

	<span class="n">u32</span> <span class="n">bd_number</span><span class="p">;</span>     <span class="cm">/* board number;*/</span>
	<span class="n">u32</span> <span class="n">pci_state</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">config_space</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define AT_WRITE_REG(a, reg, value) ( \</span>
<span class="cp">		writel((value), ((a)-&gt;hw_addr + reg)))</span>

<span class="cp">#define AT_WRITE_FLUSH(a) (\</span>
<span class="cp">		readl((a)-&gt;hw_addr))</span>

<span class="cp">#define AT_READ_REG(a, reg) ( \</span>
<span class="cp">		readl((a)-&gt;hw_addr + reg))</span>

<span class="cp">#define AT_WRITE_REGB(a, reg, value) (\</span>
<span class="cp">		writeb((value), ((a)-&gt;hw_addr + reg)))</span>

<span class="cp">#define AT_READ_REGB(a, reg) (\</span>
<span class="cp">		readb((a)-&gt;hw_addr + reg))</span>

<span class="cp">#define AT_WRITE_REGW(a, reg, value) (\</span>
<span class="cp">		writew((value), ((a)-&gt;hw_addr + reg)))</span>

<span class="cp">#define AT_READ_REGW(a, reg) (\</span>
<span class="cp">		readw((a)-&gt;hw_addr + reg))</span>

<span class="cp">#define AT_WRITE_REG_ARRAY(a, reg, offset, value) ( \</span>
<span class="cp">		writel((value), (((a)-&gt;hw_addr + reg) + ((offset) &lt;&lt; 2))))</span>

<span class="cp">#define AT_READ_REG_ARRAY(a, reg, offset) ( \</span>
<span class="cp">		readl(((a)-&gt;hw_addr + reg) + ((offset) &lt;&lt; 2)))</span>

<span class="k">extern</span> <span class="kt">char</span> <span class="n">atl1e_driver_name</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">atl1e_driver_version</span><span class="p">[];</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">atl1e_check_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl1e_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">atl1e_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl1e_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">atl1e_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl1e_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">atl1e_reinit_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl1e_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">s32</span> <span class="n">atl1e_reset_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl1e_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">atl1e_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* _ATL1_E_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
