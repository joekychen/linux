<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › atheros › atlx › atl2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>atl2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright(c) 2006 - 2007 Atheros Corporation. All rights reserved.</span>
<span class="cm"> * Copyright(c) 2007 - 2008 Chris Snook &lt;csnook@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from Intel e1000 driver</span>
<span class="cm"> * Copyright(c) 1999 - 2005 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> * Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/irqflags.h&gt;</span>
<span class="cp">#include &lt;linux/irqreturn.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &quot;atl2.h&quot;</span>

<span class="cp">#define ATL2_DRV_VERSION &quot;2.2.3&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">atl2_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;atl2&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">atl2_driver_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Atheros(R) L2 Ethernet Driver&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">atl2_copyright</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Copyright (c) 2007 Atheros Corporation.&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">atl2_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">ATL2_DRV_VERSION</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Atheros Corporation &lt;xiong.huang@atheros.com&gt;, Chris Snook &lt;csnook@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Atheros Fast Ethernet Network Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">ATL2_DRV_VERSION</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_pci_tbl - PCI Device ID Table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">atl2_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ATTANSIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ATTANSIC_L2</span><span class="p">)},</span>
	<span class="cm">/* required last entry */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">atl2_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_check_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_sw_init - Initialize general software structures (struct atl2_adapter)</span>
<span class="cm"> * @adapter: board private structure to initialize</span>
<span class="cm"> *</span>
<span class="cm"> * atl2_sw_init initializes the Adapter private data structure.</span>
<span class="cm"> * Fields are initialized based on PCI device information and</span>
<span class="cm"> * OS network device settings (MTU size).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atl2_sw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* PCI config space info */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">subsystem_vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">subsystem_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">revision_id</span>  <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci_cmd_word</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ict</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">;</span>  <span class="cm">/* ~100ms */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_0</span><span class="p">;</span>   <span class="cm">/* hardware init */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="n">FULL_DUPLEX</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy_configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">preamble_len</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ipgt</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">min_ifg</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ipgr1</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ipgr2</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">retry_buf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_retry</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">lcol</span> <span class="o">=</span> <span class="mh">0x37</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">jam_ipg</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc_rxd_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc_rxd_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_set_multi - Multicast and Promiscuous mode set</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * The set_multi entry point is called whenever the multicast address</span>
<span class="cm"> * list or the network interface flags are updated.  This routine is</span>
<span class="cm"> * responsible for configuring the hardware for proper multicast,</span>
<span class="cm"> * promiscuous mode, and all-multi behavior.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash_value</span><span class="p">;</span>

	<span class="cm">/* Check for Promiscuous and All Multicast modes */</span>
	<span class="n">rctl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">MAC_CTRL_PROMIS_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">MAC_CTRL_MC_ALL_EN</span><span class="p">;</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_CTRL_PROMIS_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_CTRL_PROMIS_EN</span> <span class="o">|</span> <span class="n">MAC_CTRL_MC_ALL_EN</span><span class="p">);</span>

	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">,</span> <span class="n">rctl</span><span class="p">);</span>

	<span class="cm">/* clear the old settings from the multicast hash table */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG_ARRAY</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* comoute mc addresses&#39; hash value ,and put it into hash table */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hash_value</span> <span class="o">=</span> <span class="n">atl2_hash_mc_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">atl2_hash_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hash_value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_ring_ptrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Read / Write Ptr Initialize: */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_read_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_read_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_write_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_next_clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_configure - Configure Transmit&amp;Receive Unit after Reset</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the Tx /Rx unit of the MAC after a reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* clear interrupt status */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* set MAC Address */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_STA_ADDR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">REG_MAC_STA_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* HI base address */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_DESC_BASE_ADDR_HI</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000ULL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

	<span class="cm">/* LO base address */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXD_BASE_ADDR_LO</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_dma</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffULL</span><span class="p">));</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXS_BASE_ADDR_LO</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_dma</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffULL</span><span class="p">));</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RXD_BASE_ADDR_LO</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_dma</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffULL</span><span class="p">));</span>

	<span class="cm">/* element count */</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXD_MEM_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXS_MEM_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RXD_BUF_NUM</span><span class="p">,</span>  <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span><span class="p">);</span>

	<span class="cm">/* config Internal SRAM */</span>
<span class="cm">/*</span>
<span class="cm">    ATL2_WRITE_REGW(hw, REG_SRAM_TXRAM_END, sram_tx_end);</span>
<span class="cm">    ATL2_WRITE_REGW(hw, REG_SRAM_TXRAM_END, sram_rx_end);</span>
<span class="cm">*/</span>

	<span class="cm">/* config IPG/IFG */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ipgt</span> <span class="o">&amp;</span> <span class="n">MAC_IPG_IFG_IPGT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">MAC_IPG_IFG_IPGT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">min_ifg</span> <span class="o">&amp;</span> <span class="n">MAC_IPG_IFG_MIFG_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">MAC_IPG_IFG_MIFG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ipgr1</span> <span class="o">&amp;</span> <span class="n">MAC_IPG_IFG_IPGR1_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">MAC_IPG_IFG_IPGR1_SHIFT</span><span class="p">)</span><span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ipgr2</span> <span class="o">&amp;</span> <span class="n">MAC_IPG_IFG_IPGR2_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">MAC_IPG_IFG_IPGR2_SHIFT</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_IPG_IFG</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* config  Half-Duplex Control */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lcol</span> <span class="o">&amp;</span> <span class="n">MAC_HALF_DUPLX_CTRL_LCOL_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_retry</span> <span class="o">&amp;</span> <span class="n">MAC_HALF_DUPLX_CTRL_RETRY_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">MAC_HALF_DUPLX_CTRL_RETRY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MAC_HALF_DUPLX_CTRL_EXC_DEF_EN</span> <span class="o">|</span>
		<span class="p">(</span><span class="mh">0xa</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_HALF_DUPLX_CTRL_ABEBT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">jam_ipg</span> <span class="o">&amp;</span> <span class="n">MAC_HALF_DUPLX_CTRL_JAMIPG_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">MAC_HALF_DUPLX_CTRL_JAMIPG_SHIFT</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_HALF_DUPLX_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* set Interrupt Moderator Timer */</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IRQ_MODU_TIMER_INIT</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">imt</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MASTER_CTRL</span><span class="p">,</span> <span class="n">MASTER_CTRL_ITIMER_EN</span><span class="p">);</span>

	<span class="cm">/* set Interrupt Clear Timer */</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_CMBDISDMA_TIMER</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ict</span><span class="p">);</span>

	<span class="cm">/* set MTU */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MTU</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
		<span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span> <span class="n">VLAN_SIZE</span> <span class="o">+</span> <span class="n">ETHERNET_FCS_SIZE</span><span class="p">);</span>

	<span class="cm">/* 1590 */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TX_CUT_THRESH</span><span class="p">,</span> <span class="mh">0x177</span><span class="p">);</span>

	<span class="cm">/* flow control */</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PAUSE_ON_TH</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc_rxd_hi</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PAUSE_OFF_TH</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc_rxd_lo</span><span class="p">);</span>

	<span class="cm">/* Init mailbox */</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MB_TXD_WR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MB_RXD_RD_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_read_ptr</span><span class="p">);</span>

	<span class="cm">/* enable DMA read/write */</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_DMAR</span><span class="p">,</span> <span class="n">DMAR_EN</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_DMAW</span><span class="p">,</span> <span class="n">DMAW_EN</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISR_PHY_LINKDOWN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* config failed */</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear all interrupt status */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">,</span> <span class="mh">0x3fffffff</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_setup_ring_resources - allocate Tx / RX descriptor resources</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success, negative on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">atl2_setup_ring_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* real ring DMA buffer */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">=</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span>	<span class="cm">/* dword align */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span>	<span class="cm">/* dword align */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span> <span class="o">*</span> <span class="mi">1536</span> <span class="o">+</span> <span class="mi">127</span><span class="p">;</span>	<span class="cm">/* 128bytes align */</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_vir_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_vir_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_vir_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_size</span><span class="p">);</span>

	<span class="cm">/* Init TXD Ring */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_dma</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_dma</span> <span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_dma</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_dma</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_dma</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_vir_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* Init TXS Ring */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_dma</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_dma</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_dma</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_dma</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_dma</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_status</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>

	<span class="cm">/* Init RXD Ring */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_dma</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_dma</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_dma</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_dma</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_dma</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * Read / Write Ptr Initialize:</span>
<span class="cm"> *      init_ring_ptrs(adapter);</span>
<span class="cm"> */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_irq_enable - Enable default interrupt generation settings</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atl2_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IMR</span><span class="p">,</span> <span class="n">IMR_NORMAL_MASK</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_FLUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_irq_disable - Mask off interrupt generation on the NIC</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atl2_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">ATL2_WRITE_FLUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
    <span class="n">synchronize_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__atl2_vlan_mode</span><span class="p">(</span><span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable VLAN tag insert/strip */</span>
		<span class="o">*</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">MAC_CTRL_RMV_VLAN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* disable VLAN tag insert/strip */</span>
		<span class="o">*</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_CTRL_RMV_VLAN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_vlan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">atl2_irq_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">);</span>
	<span class="n">__atl2_vlan_mode</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="n">atl2_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_restore_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atl2_vlan_mode</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">atl2_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since there is no support for separate rx/tx vlan accel</span>
<span class="cm">	 * enable/disable make sure tx flag is always in same state as rx.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">atl2_vlan_mode</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_intr_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rxd</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring</span><span class="o">+</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_write_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">update</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* end of tx */</span>

		<span class="cm">/* clear this flag at once */</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">pkt_size</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rx_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">pkt_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="cm">/* alloc new buffer */</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;%s: Mem squeeze, deferring packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Check that some rx space is free. If not,</span>
<span class="cm">				 * free one and mark stats-&gt;rx_dropped++.</span>
<span class="cm">				 */</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rxd</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">vtag</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">vtag</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">vtag</span><span class="o">&amp;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

				<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rx_size</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">pkt_size</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">)</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">mcast</span><span class="p">)</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">crc</span><span class="p">)</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">align</span><span class="p">)</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* advance write ptr */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_write_ptr</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* update mailbox? */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_read_ptr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_write_ptr</span><span class="p">;</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MB_RXD_RD_IDX</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_read_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_intr_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txd_read_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txs_write_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_pkt_status</span> <span class="o">*</span><span class="n">txs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_pkt_header</span> <span class="o">*</span><span class="n">txph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">txs_write_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_write_ptr</span><span class="p">);</span>
		<span class="n">txs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring</span> <span class="o">+</span> <span class="n">txs_write_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* tx stop here */</span>

		<span class="n">free_hole</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">txs</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">txs_write_ptr</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span><span class="p">)</span>
			<span class="n">txs_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_write_ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">txs_write_ptr</span><span class="p">);</span>

		<span class="n">txd_read_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_read_ptr</span><span class="p">);</span>
		<span class="n">txph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_header</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring</span><span class="p">)</span> <span class="o">+</span> <span class="n">txd_read_ptr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txph</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">!=</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tx_pkt_status</span> <span class="o">*</span><span class="n">old_txs</span> <span class="o">=</span> <span class="n">txs</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;%s: txs packet size not consistent with txd&quot;</span>
				<span class="s">&quot; txd_:0x%08x, txs_:0x%08x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">txph</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">txs</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;txd read ptr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">txd_read_ptr</span><span class="p">);</span>
			<span class="n">txs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring</span> <span class="o">+</span> <span class="n">txs_write_ptr</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;txs-behind:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">txs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txs_write_ptr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">+</span>
					<span class="n">txs_write_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">txs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring</span> <span class="o">+</span> <span class="p">(</span><span class="n">txs_write_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;txs-before:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">txs</span><span class="p">);</span>
			<span class="n">txs</span> <span class="o">=</span> <span class="n">old_txs</span><span class="p">;</span>
		<span class="p">}</span>

		 <span class="cm">/* 4for TPH */</span>
		<span class="n">txd_read_ptr</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">txph</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txd_read_ptr</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="p">)</span>
			<span class="n">txd_read_ptr</span> <span class="o">-=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="p">;</span>

		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_read_ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">txd_read_ptr</span><span class="p">);</span>

		<span class="cm">/* tx statistics: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">defer</span><span class="p">)</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">abort_col</span><span class="p">)</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">late_col</span><span class="p">)</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">underun</span><span class="p">)</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_hole</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_check_for_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>

	<span class="cm">/* notify upper layer link down ASAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Link Down */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* old link state: Up */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s NIC Link is Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">atl2_driver_name</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_0</span><span class="p">;</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_chg_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atl2_clear_phy_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_intr - Interrupt Handler</span>
<span class="cm"> * @irq: interrupt number</span>
<span class="cm"> * @data: pointer to a network interface device structure</span>
<span class="cm"> * @pt_regs: CPU registers structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">atl2_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* link event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_PHY</span><span class="p">)</span>
		<span class="n">atl2_clear_phy_int</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* clear ISR status, and Enable CMB DMA/Disable Interrupt */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">,</span> <span class="n">status</span> <span class="o">|</span> <span class="n">ISR_DIS_INT</span><span class="p">);</span>

	<span class="cm">/* check if PCIE PHY Link down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_PHY_LINKDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* reset MAC */</span>
			<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ATL2_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check if DMA read/write error? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_DMAR_TO_RST</span> <span class="o">|</span> <span class="n">ISR_DMAW_TO_RST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ATL2_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* link event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_PHY</span> <span class="o">|</span> <span class="n">ISR_MANUAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atl2_check_for_link</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* transmit event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_TX_EVENT</span><span class="p">)</span>
		<span class="n">atl2_intr_tx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* rx exception */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_RX_EVENT</span><span class="p">)</span>
		<span class="n">atl2_intr_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* re-enable Interrupt */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRQF_SHARED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">atl2_intr</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_free_ring_resources - Free Tx / RX descriptor Resources</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Free all transmit software resources</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_free_ring_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_size</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_vir_addr</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ring_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_open - Called when a network interface is made active</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value on failure</span>
<span class="cm"> *</span>
<span class="cm"> * The open entry point is called when a network interface is made</span>
<span class="cm"> * active by the system (IFF_UP).  At this point all resources needed</span>
<span class="cm"> * for transmit and receive operations are allocated, the interrupt</span>
<span class="cm"> * handler is registered with the OS, the watchdog timer is started,</span>
<span class="cm"> * and the stack is notified that the interface is ready.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* disallow open during test */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__ATL2_TESTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* allocate transmit descriptors */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atl2_setup_ring_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atl2_init_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_init_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hardware has been reset, we need to reload some things */</span>
	<span class="n">atl2_set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">init_ring_ptrs</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">atl2_restore_vlan</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atl2_configure</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atl2_request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_req_irq</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MASTER_CTRL</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MASTER_CTRL</span><span class="p">,</span>
		<span class="n">val</span> <span class="o">|</span> <span class="n">MASTER_CTRL_MANUAL_INT</span><span class="p">);</span>

	<span class="n">atl2_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init_hw:</span>
<span class="nl">err_req_irq:</span>
<span class="nl">err_config:</span>
	<span class="n">atl2_free_ring_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">atl2_reset_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* signal that we&#39;re down so the interrupt handler does not</span>
<span class="cm">	 * reschedule our watchdog timer */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* reset MAC to disable all RX/TX */</span>
	<span class="n">atl2_reset_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">atl2_irq_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_config_timer</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cfg_phy</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_close - Disables a network interface</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0, this is not allowed to fail</span>
<span class="cm"> *</span>
<span class="cm"> * The close entry point is called when an interface is de-activated</span>
<span class="cm"> * by the OS.  The hardware is still under the drivers control, but</span>
<span class="cm"> * needs to be disabled.  A global MAC reset is issued to stop the</span>
<span class="cm"> * hardware, and all transmit and receive resources are freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="n">atl2_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">atl2_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">atl2_free_ring_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TxsFreeUnit</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">txs_write_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_write_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_next_clear</span> <span class="o">&gt;=</span> <span class="n">txs_write_ptr</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">-</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_next_clear</span> <span class="o">+</span>
		<span class="n">txs_write_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">txs_write_ptr</span> <span class="o">-</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_next_clear</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TxdFreeBytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">txd_read_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_read_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span> <span class="o">&gt;=</span> <span class="n">txd_read_ptr</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span> <span class="o">-</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span> <span class="o">+</span>
		<span class="n">txd_read_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">txd_read_ptr</span> <span class="o">-</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">atl2_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tx_pkt_header</span> <span class="o">*</span><span class="n">txph</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txs_unused</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txbuf_unused</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txs_unused</span> <span class="o">=</span> <span class="n">TxsFreeUnit</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">txbuf_unused</span> <span class="o">=</span> <span class="n">TxdFreeBytes</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>  <span class="o">&gt;</span> <span class="n">txbuf_unused</span> <span class="o">||</span>
		<span class="n">txs_unused</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not enough resources */</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span><span class="p">;</span>

	<span class="n">txph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_pkt_header</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">txph</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txph</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="p">;</span>
	<span class="n">copy_len</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_len</span> <span class="o">&gt;=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">copy_len</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="n">copy_len</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="n">copy_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef NETIF_F_HW_VLAN_TX</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">vlan_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlan_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">vlan_tag</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">vlan_tag</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="n">txph</span><span class="o">-&gt;</span><span class="n">ins_vlan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">txph</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">=</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* clear txs before send */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_next_clear</span><span class="p">].</span><span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_next_clear</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_next_clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MB_TXD_WR_IDX</span><span class="p">,</span>
		<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_write_ptr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_change_mtu - Change the Maximum Transfer Unit</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> * @new_mtu: new value for maximum frame size</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ETH_DATA_LEN</span> <span class="o">+</span> <span class="n">VLAN_SIZE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* set MTU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">!=</span> <span class="n">new_mtu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MTU</span><span class="p">,</span> <span class="n">new_mtu</span> <span class="o">+</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span>
			<span class="n">VLAN_SIZE</span> <span class="o">+</span> <span class="n">ETHERNET_FCS_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_set_mac - Change the Ethernet Address of the NIC</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> * @p: pointer to an address structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">atl2_set_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_mii_ioctl -</span>
<span class="cm"> * @netdev:</span>
<span class="cm"> * @ifreq:</span>
<span class="cm"> * @cmd:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_mii_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1F</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_ioctl -</span>
<span class="cm"> * @netdev:</span>
<span class="cm"> * @ifreq:</span>
<span class="cm"> * @cmd:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:
	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="k">return</span> <span class="n">atl2_mii_ioctl</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#ifdef ETHTOOL_OPS_COMPAT</span>
	<span class="k">case</span> <span class="n">SIOCETHTOOL</span>:
		<span class="k">return</span> <span class="n">ethtool_ioctl</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_tx_timeout - Respond to a Tx Hang</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Do the reset outside of interrupt context */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_watchdog - Timer Call-back</span>
<span class="cm"> * @data: pointer to netdev cast into an unsigned long</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">drop_rxd</span><span class="p">,</span> <span class="n">drop_rxs</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">drop_rxd</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_STS_RXD_OV</span><span class="p">);</span>
		<span class="n">drop_rxs</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_STS_RXS_OV</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span> <span class="o">+=</span> <span class="n">drop_rxd</span> <span class="o">+</span> <span class="n">drop_rxs</span><span class="p">;</span>

		<span class="cm">/* Reset the timer */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span>
			  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_phy_config - Timer Call-back</span>
<span class="cm"> * @data: pointer to netdev cast into an unsigned long</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_phy_config</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mii_autoneg_adv_reg</span><span class="p">);</span>
	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">MII_CR_RESET</span> <span class="o">|</span> <span class="n">MII_CR_AUTO_NEG_EN</span> <span class="o">|</span>
		<span class="n">MII_CR_RESTART_AUTO_NEG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cfg_phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* hardware has been reset, we need to reload some things */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atl2_init_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atl2_set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">init_ring_ptrs</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">atl2_restore_vlan</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atl2_configure</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MASTER_CTRL</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MASTER_CTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
		<span class="n">MASTER_CTRL_MANUAL_INT</span><span class="p">);</span>

	<span class="n">atl2_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err_up:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_reinit_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">atl2_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">atl2_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_reset_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atl2_adapter</span><span class="p">,</span> <span class="n">reset_task</span><span class="p">);</span>

	<span class="n">atl2_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_setup_mac_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* Config MAC CTRL Register */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">MAC_CTRL_TX_EN</span> <span class="o">|</span> <span class="n">MAC_CTRL_RX_EN</span> <span class="o">|</span> <span class="n">MAC_CTRL_MACLP_CLK_PHY</span><span class="p">;</span>

	<span class="cm">/* duplex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FULL_DUPLEX</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">MAC_CTRL_DUPLX</span><span class="p">;</span>

	<span class="cm">/* flow control */</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAC_CTRL_TX_FLOW</span> <span class="o">|</span> <span class="n">MAC_CTRL_RX_FLOW</span><span class="p">);</span>

	<span class="cm">/* PAD &amp; CRC */</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAC_CTRL_ADD_CRC</span> <span class="o">|</span> <span class="n">MAC_CTRL_PAD</span><span class="p">);</span>

	<span class="cm">/* preamble length */</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">preamble_len</span> <span class="o">&amp;</span> <span class="n">MAC_CTRL_PRMLEN_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">MAC_CTRL_PRMLEN_SHIFT</span><span class="p">);</span>

	<span class="cm">/* vlan */</span>
	<span class="n">__atl2_vlan_mode</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

	<span class="cm">/* filter mode */</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="n">MAC_CTRL_BC_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">MAC_CTRL_PROMIS_EN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">MAC_CTRL_MC_ALL_EN</span><span class="p">;</span>

	<span class="cm">/* half retry buffer */</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">retry_buf</span> <span class="o">&amp;</span>
		<span class="n">MAC_CTRL_HALF_LEFT_BUF_MASK</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_CTRL_HALF_LEFT_BUF_SHIFT</span><span class="p">);</span>

	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atl2_check_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* MII_BMSR must read twise */</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy_data</span><span class="o">&amp;</span><span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* link down */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* old link state: Up */</span>
			<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
			<span class="cm">/* disable rx */</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_CTRL_RX_EN</span><span class="p">;</span>
			<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_0</span><span class="p">;</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Link Up */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_get_speed_and_duplex</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duplex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">MediaType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_100M_FULL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span>  <span class="o">!=</span> <span class="n">SPEED_100</span> <span class="o">||</span> <span class="n">duplex</span> <span class="o">!=</span> <span class="n">FULL_DUPLEX</span><span class="p">)</span>
			<span class="n">reconfig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_100M_HALF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span>  <span class="o">!=</span> <span class="n">SPEED_100</span> <span class="o">||</span> <span class="n">duplex</span> <span class="o">!=</span> <span class="n">HALF_DUPLEX</span><span class="p">)</span>
			<span class="n">reconfig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_10M_FULL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span> <span class="o">||</span> <span class="n">duplex</span> <span class="o">!=</span> <span class="n">FULL_DUPLEX</span><span class="p">)</span>
			<span class="n">reconfig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_10M_HALF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span>  <span class="o">!=</span> <span class="n">SPEED_10</span> <span class="o">||</span> <span class="n">duplex</span> <span class="o">!=</span> <span class="n">HALF_DUPLEX</span><span class="p">)</span>
			<span class="n">reconfig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* link result is our setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reconfig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">!=</span> <span class="n">speed</span> <span class="o">||</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">!=</span> <span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="n">duplex</span><span class="p">;</span>
			<span class="n">atl2_setup_mac_ctrl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s NIC Link is Up&lt;%d Mbps %s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">atl2_driver_name</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">==</span> <span class="n">FULL_DUPLEX</span> <span class="o">?</span>
					<span class="s">&quot;Full Duplex&quot;</span> <span class="o">:</span> <span class="s">&quot;Half Duplex&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Link down -&gt; Up */</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* change original link status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
		<span class="cm">/* disable rx */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_CTRL_RX_EN</span><span class="p">;</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_0</span><span class="p">;</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* auto-neg, insert timer to re-config phy</span>
<span class="cm">	 * (if interval smaller than 5 seconds, something strange) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cfg_phy</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_config_timer</span><span class="p">,</span>
				  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_link_chg_task - deal with link change event Out of interrupt context</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_link_chg_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atl2_adapter</span><span class="p">,</span> <span class="n">link_chg_task</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">atl2_check_link</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_setup_pcicmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_IO</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">))</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">))</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * some motherboards BIOS(PXE/EFI) driver may set PME</span>
<span class="cm">	 * while they transfer control to OS (Windows/Linux)</span>
<span class="cm">	 * so we should clear this bit before NIC work normally</span>
<span class="cm">	 */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">REG_PM_CTRLSTAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atl2_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">atl2_intr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">atl2_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">atl2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">atl2_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">atl2_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">atl2_set_multi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">atl2_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">atl2_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">atl2_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">atl2_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">atl2_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">atl2_tx_timeout</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">atl2_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_probe - Device Initialization Routine</span>
<span class="cm"> * @pdev: PCI device information struct</span>
<span class="cm"> * @ent: entry in atl2_pci_tbl</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> *</span>
<span class="cm"> * atl2_probe initializes an adapter identified by a pci_dev structure.</span>
<span class="cm"> * The OS initialization, configuring of the adapter private structure,</span>
<span class="cm"> * and a hardware reset occur.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atl2_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmio_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mmio_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cards_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * atl2 is a shared-high-32-bit device, so we&#39;re stuck with 32-bit DMA</span>
<span class="cm">	 * until the kernel has the proper infrastructure to support 64-bit DMA</span>
<span class="cm">	 * on these devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;atl2: No usable DMA configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mark all PCI regions associated with PCI device</span>
<span class="cm">	 * pdev as being reserved by owner atl2_driver_name */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atl2_driver_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci_reg</span><span class="p">;</span>

	<span class="cm">/* Enables bus-mastering on the device and calls</span>
<span class="cm">	 * pcibios_set_master to do the needed arch specific settings */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_alloc_etherdev</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">back</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>

	<span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mem_rang</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mmio_len</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atl2_setup_pcicmd</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atl2_netdev_ops</span><span class="p">;</span>
	<span class="n">atl2_set_ethtool_ops</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">mmio_start</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">mmio_start</span> <span class="o">+</span> <span class="n">mmio_len</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bd_number</span> <span class="o">=</span> <span class="n">cards_found</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_using_64</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* setup the private structure */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atl2_sw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">);</span>

	<span class="cm">/* Init PHY as early as possible due to power saving issue  */</span>
	<span class="n">atl2_phy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* reset the controller to</span>
<span class="cm">	 * put the device in a known good starting state */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atl2_reset_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy the MAC address out of the EEPROM */</span>
	<span class="n">atl2_read_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
<span class="cm">/* FIXME: do we still need this? */</span>
<span class="cp">#ifdef ETHTOOL_GPERMADDR</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_eeprom</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atl2_check_options</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">atl2_watchdog</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">adapter</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_config_timer</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_config_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">atl2_phy_config</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_config_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">adapter</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">,</span> <span class="n">atl2_reset_task</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_chg_task</span><span class="p">,</span> <span class="n">atl2_link_chg_task</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">);</span> <span class="cm">/* ?? */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register</span><span class="p">;</span>

	<span class="cm">/* assume we have no link for now */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_reset:</span>
<span class="nl">err_register:</span>
<span class="nl">err_sw_init:</span>
<span class="nl">err_eeprom:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">err_alloc_etherdev:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_pci_reg:</span>
<span class="nl">err_dma:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_remove - Device Removal Routine</span>
<span class="cm"> * @pdev: PCI device information struct</span>
<span class="cm"> *</span>
<span class="cm"> * atl2_remove is called by the PCI subsystem to alert the driver</span>
<span class="cm"> * that it should release a PCI device.  The could be caused by a</span>
<span class="cm"> * Hot-Plug event, or because the driver is going to be removed from</span>
<span class="cm"> * memory.</span>
<span class="cm"> */</span>
<span class="cm">/* FIXME: write the original MAC address back in case it was changed from a</span>
<span class="cm"> * BIOS-set value, as in atl1 -- CHS */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">atl2_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* flush_scheduled work may reschedule our watchdog task, so</span>
<span class="cm">	 * explicitly disable watchdog tasks from being rescheduled  */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">__ATL2_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_config_timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_chg_task</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">atl2_force_ps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wufc</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="n">atl2_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span>
		<span class="n">wufc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATLX_WUFC_LNKC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">wufc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="cm">/* get current link speed &amp; duplex */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_get_speed_and_duplex</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duplex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				<span class="s">&quot;%s: get speed&amp;duplex error while suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">atl2_driver_name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">wol_dis</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* turn on magic packet wol */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wufc</span> <span class="o">&amp;</span> <span class="n">ATLX_WUFC_MAG</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WOL_MAGIC_EN</span> <span class="o">|</span> <span class="n">WOL_MAGIC_PME_EN</span><span class="p">);</span>

		<span class="cm">/* ignore Link Chg event when Link is up */</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_WOL_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Config MAC CTRL Register */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">MAC_CTRL_RX_EN</span> <span class="o">|</span> <span class="n">MAC_CTRL_MACLP_CLK_PHY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FULL_DUPLEX</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">MAC_CTRL_DUPLX</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAC_CTRL_ADD_CRC</span> <span class="o">|</span> <span class="n">MAC_CTRL_PAD</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">preamble_len</span> <span class="o">&amp;</span>
			<span class="n">MAC_CTRL_PRMLEN_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_CTRL_PRMLEN_SHIFT</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">retry_buf</span> <span class="o">&amp;</span>
			<span class="n">MAC_CTRL_HALF_LEFT_BUF_MASK</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
			<span class="n">MAC_CTRL_HALF_LEFT_BUF_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wufc</span> <span class="o">&amp;</span> <span class="n">ATLX_WUFC_MAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* magic packet maybe Broadcast&amp;multicast&amp;Unicast */</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">MAC_CTRL_BC_EN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* pcie patch */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_PHYMISC</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCIE_PHYMISC_FORCE_RCV_DET</span><span class="p">;</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_PHYMISC</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DLL_TX_CTRL1</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCIE_DLL_TX_CTRL1_SEL_NOR_CLK</span><span class="p">;</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DLL_TX_CTRL1</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">suspend_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">&amp;</span><span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">wufc</span><span class="o">&amp;</span><span class="n">ATLX_WUFC_LNKC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* link is down, so only LINK CHG WOL event enable */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WOL_LINK_CHG_EN</span> <span class="o">|</span> <span class="n">WOL_LINK_CHG_PME_EN</span><span class="p">);</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_WOL_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* pcie patch */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_PHYMISC</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCIE_PHYMISC_FORCE_RCV_DET</span><span class="p">;</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_PHYMISC</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DLL_TX_CTRL1</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCIE_DLL_TX_CTRL1_SEL_NOR_CLK</span><span class="p">;</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DLL_TX_CTRL1</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy_configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* re-init PHY when resume */</span>

		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">suspend_exit</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">wol_dis:</span>
	<span class="cm">/* WOL disabled */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_WOL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* pcie patch */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_PHYMISC</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCIE_PHYMISC_FORCE_RCV_DET</span><span class="p">;</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_PHYMISC</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DLL_TX_CTRL1</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCIE_DLL_TX_CTRL1_SEL_NOR_CLK</span><span class="p">;</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DLL_TX_CTRL1</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="n">atl2_force_ps</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy_configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* re-init PHY when resume */</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">suspend_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">atl2_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;atl2: Cannot enable PCI device from suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_WOL_CTRL</span><span class="p">);</span> <span class="cm">/* clear WOL status */</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_WOL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">atl2_request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atl2_reset_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">atl2_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atl2_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PMSG_SUSPEND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">atl2_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">atl2_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">atl2_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">atl2_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">atl2_remove</span><span class="p">),</span>
	<span class="cm">/* Power Management Hooks */</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">atl2_suspend</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">atl2_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">atl2_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_init_module - Driver Registration Routine</span>
<span class="cm"> *</span>
<span class="cm"> * atl2_init_module is the first routine called when the driver is</span>
<span class="cm"> * loaded. All it does is register with the PCI subsystem.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">atl2_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s - version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atl2_driver_string</span><span class="p">,</span>
		<span class="n">atl2_driver_version</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atl2_copyright</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atl2_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">atl2_init_module</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_exit_module - Driver Exit Cleanup Routine</span>
<span class="cm"> *</span>
<span class="cm"> * atl2_exit_module is called just before the driver is removed</span>
<span class="cm"> * from memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">atl2_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atl2_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">atl2_exit_module</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_read_pci_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_write_pci_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
		<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
		<span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
		<span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
		<span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
		<span class="n">SUPPORTED_TP</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_TP</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">!=</span> <span class="n">SPEED_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">==</span> <span class="n">FULL_DUPLEX</span><span class="p">)</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define MY_ADV_MASK	(ADVERTISE_10_HALF | \</span>
<span class="cp">			 ADVERTISE_10_FULL | \</span>
<span class="cp">			 ADVERTISE_100_HALF| \</span>
<span class="cp">			 ADVERTISE_100_FULL)</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">MY_ADV_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MY_ADV_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MediaType</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_AUTO_SENSOR</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span>  <span class="n">MY_ADV_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">MY_ADV_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ADVERTISE_100_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MediaType</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_100M_FULL</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_100_FULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">MY_ADV_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ADVERTISE_100_HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MediaType</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_100M_HALF</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_100_HALF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">MY_ADV_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ADVERTISE_10_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MediaType</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_10M_FULL</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_10_FULL</span><span class="p">;</span>
		<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">MY_ADV_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ADVERTISE_10_HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">MediaType</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_10M_HALF</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_10_HALF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">|</span>
			<span class="n">ADVERTISED_TP</span> <span class="o">|</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset the link */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atl2_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">atl2_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">atl2_reset_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__ATL2_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">atl2_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * It&#39;s sane for this to be empty, but we might want to take advantage of this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ATL2_REGS_LEN 42</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATL2_REGS_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">regs_buff</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATL2_REGS_LEN</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">;</span>

	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_VPD_CAP</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_CONFIG</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TWSI_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DEV_MISC_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MASTER_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MANUAL_TIMER_INIT</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IRQ_MODU_TIMER_INIT</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PHY_ENABLE</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_CMBDISDMA_TIMER</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IDLE_STATUS</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MDIO_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SERDES_LOCK</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_IPG_IFG</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_STA_ADDR</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_STA_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_HALF_DUPLX_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MTU</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_WOL_CTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SRAM_TXRAM_END</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_DESC_BASE_ADDR_HI</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXD_BASE_ADDR_LO</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXD_MEM_SIZE</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXS_BASE_ADDR_LO</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TXS_MEM_SIZE</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RXD_BASE_ADDR_LO</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RXD_BUF_NUM</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_DMAR</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_TX_CUT_THRESH</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_DMAW</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PAUSE_ON_TH</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PAUSE_OFF_TH</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MB_TXD_WR_IDX</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MB_RXD_RD_IDX</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_ISR</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IMR</span><span class="p">);</span>

	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">phy_data</span><span class="p">;</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">phy_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atl2_check_eeprom_exist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">eeprom_buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_dword</span><span class="p">,</span> <span class="n">last_dword</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atl2_check_eeprom_exist</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">|</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">first_dword</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">last_dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">eeprom_buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">last_dword</span> <span class="o">-</span> <span class="n">first_dword</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eeprom_buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first_dword</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">last_dword</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atl2_read_eeprom</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">eeprom_buff</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">first_dword</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom_buff</span> <span class="o">+</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">),</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="nl">free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">eeprom_buff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">eeprom_buff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">first_dword</span><span class="p">,</span> <span class="n">last_dword</span><span class="p">,</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">|</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">max_len</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="n">first_dword</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">last_dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">eeprom_buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eeprom_buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">eeprom_buff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need read/modify/write of first changed EEPROM word */</span>
		<span class="cm">/* only the second byte of the word is being modified */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atl2_read_eeprom</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">first_dword</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">eeprom_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * need read/modify/write of last changed EEPROM word</span>
<span class="cm">		 * only the first byte of the word is being modified</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atl2_read_eeprom</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">last_dword</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="p">(</span><span class="n">eeprom_buff</span><span class="p">[</span><span class="n">last_dword</span> <span class="o">-</span> <span class="n">first_dword</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Device&#39;s eeprom is always little-endian, word addressable */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">last_dword</span> <span class="o">-</span> <span class="n">first_dword</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atl2_write_eeprom</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">((</span><span class="n">first_dword</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">eeprom_buff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span>  <span class="n">atl2_driver_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">atl2_driver_version</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;L2&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">n_stats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">testinfo_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="n">atl2_get_regs_len</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="n">atl2_get_eeprom_len</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">ATLX_WUFC_EX</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_UCAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">ATLX_WUFC_MC</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MCAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">ATLX_WUFC_BC</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_BCAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">ATLX_WUFC_MAG</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">ATLX_WUFC_LNKC</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_PHY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAKE_ARP</span> <span class="o">|</span> <span class="n">WAKE_MAGICSECURE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAKE_UCAST</span> <span class="o">|</span> <span class="n">WAKE_BCAST</span> <span class="o">|</span> <span class="n">WAKE_MCAST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* these settings will always override what we currently have */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">|=</span> <span class="n">ATLX_WUFC_MAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">|=</span> <span class="n">ATLX_WUFC_LNKC</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">atl2_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">atl2_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">atl2_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">atl2_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">atl2_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>		<span class="o">=</span> <span class="n">atl2_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>		<span class="o">=</span> <span class="n">atl2_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">atl2_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">atl2_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">atl2_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">atl2_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">atl2_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>		<span class="o">=</span> <span class="n">atl2_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>		<span class="o">=</span> <span class="n">atl2_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>		<span class="o">=</span> <span class="n">atl2_set_eeprom</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atl2_ethtool_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define LBYTESWAP(a)  ((((a) &amp; 0x00ff00ff) &lt;&lt; 8) | \</span>
<span class="cp">	(((a) &amp; 0xff00ff00) &gt;&gt; 8))</span>
<span class="cp">#define LONGSWAP(a)   ((LBYTESWAP(a) &lt;&lt; 16) | (LBYTESWAP(a) &gt;&gt; 16))</span>
<span class="cp">#define SHORTSWAP(a)  (((a) &lt;&lt; 8) | ((a) &gt;&gt; 8))</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the transmit and receive units; mask and clear all interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> * return : 0  or  idle status (if error)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_reset_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">icr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_cfg_cmd_word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Workaround for PCI problem when BIOS sets MMRBC incorrectly. */</span>
	<span class="n">atl2_read_pci_cfg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_REG_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cfg_cmd_word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pci_cfg_cmd_word</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">CMD_IO_SPACE</span><span class="o">|</span><span class="n">CMD_MEMORY_SPACE</span><span class="o">|</span><span class="n">CMD_BUS_MASTER</span><span class="p">))</span> <span class="o">!=</span>
		<span class="p">(</span><span class="n">CMD_IO_SPACE</span><span class="o">|</span><span class="n">CMD_MEMORY_SPACE</span><span class="o">|</span><span class="n">CMD_BUS_MASTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_cfg_cmd_word</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">CMD_IO_SPACE</span><span class="o">|</span><span class="n">CMD_MEMORY_SPACE</span><span class="o">|</span><span class="n">CMD_BUS_MASTER</span><span class="p">);</span>
		<span class="n">atl2_write_pci_cfg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_REG_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cfg_cmd_word</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear Interrupt mask to stop board from generating</span>
<span class="cm">	 * interrupts &amp; Clear any pending interrupt events</span>
<span class="cm">	 */</span>
	<span class="cm">/* FIXME */</span>
	<span class="cm">/* ATL2_WRITE_REG(hw, REG_IMR, 0); */</span>
	<span class="cm">/* ATL2_WRITE_REG(hw, REG_ISR, 0xffffffff); */</span>

	<span class="cm">/* Issue Soft Reset to the MAC.  This will reset the chip&#39;s</span>
<span class="cm">	 * transmit, receive, DMA.  It will not effect</span>
<span class="cm">	 * the current PCI configuration.  The global reset bit is self-</span>
<span class="cm">	 * clearing, and should clear within a microsecond.</span>
<span class="cm">	 */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MASTER_CTRL</span><span class="p">,</span> <span class="n">MASTER_CTRL_SOFT_RST</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* delay about 1ms */</span>

	<span class="cm">/* Wait at least 10ms for All module to be Idle */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icr</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_IDLE_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* delay 1 ms */</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">icr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CUSTOM_SPI_CS_SETUP        2</span>
<span class="cp">#define CUSTOM_SPI_CLK_HI          2</span>
<span class="cp">#define CUSTOM_SPI_CLK_LO          2</span>
<span class="cp">#define CUSTOM_SPI_CS_HOLD         2</span>
<span class="cp">#define CUSTOM_SPI_CS_HI           3</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atl2_spi_flash_dev</span> <span class="n">flash_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cm">/* MFR    WRSR  READ  PROGRAM WREN  WRDI  RDSR  RDID  SECTOR_ERASE CHIP_ERASE */</span>
<span class="p">{</span><span class="s">&quot;Atmel&quot;</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>  <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>   <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span>        <span class="mh">0x62</span> <span class="p">},</span>
<span class="p">{</span><span class="s">&quot;SST&quot;</span><span class="p">,</span>   <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>   <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>        <span class="mh">0x60</span> <span class="p">},</span>
<span class="p">{</span><span class="s">&quot;ST&quot;</span><span class="p">,</span>    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>   <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span>        <span class="mh">0xC7</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">atl2_spi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">SPI_FLASH_CTRL_WAIT_READY</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">CUSTOM_SPI_CS_SETUP</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_CS_SETUP_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">SPI_FLASH_CTRL_CS_SETUP_SHIFT</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">CUSTOM_SPI_CLK_HI</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_CLK_HI_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">SPI_FLASH_CTRL_CLK_HI_SHIFT</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">CUSTOM_SPI_CLK_LO</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_CLK_LO_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">SPI_FLASH_CTRL_CLK_LO_SHIFT</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">CUSTOM_SPI_CS_HOLD</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_CS_HOLD_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">SPI_FLASH_CTRL_CS_HOLD_SHIFT</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">CUSTOM_SPI_CS_HI</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_CS_HI_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">SPI_FLASH_CTRL_CS_HI_SHIFT</span> <span class="o">|</span>
		<span class="p">(</span><span class="mh">0x1</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_INS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SPI_FLASH_CTRL_INS_SHIFT</span><span class="p">;</span>

	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">|=</span> <span class="n">SPI_FLASH_CTRL_START</span><span class="p">;</span>

	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_START</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_START</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_DATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get_permanent_address</span>
<span class="cm"> * return 0 if get valid mac address,</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_permanent_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">Addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">Control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">Register</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">EthAddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">KeyValid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atl2_check_eeprom_exist</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* eeprom exists */</span>
		<span class="n">Register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">KeyValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Read out all EEPROM content */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atl2_read_eeprom</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Control</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">KeyValid</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">Register</span> <span class="o">==</span> <span class="n">REG_MAC_STA_ADDR</span><span class="p">)</span>
						<span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Control</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Register</span> <span class="o">==</span>
						<span class="p">(</span><span class="n">REG_MAC_STA_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
						<span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Control</span><span class="p">;</span>
					<span class="n">KeyValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">Control</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5A</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">KeyValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">Register</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">Control</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* assume data end while encount an invalid KEYWORD */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* read error */</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">EthAddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LONGSWAP</span><span class="p">(</span><span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">EthAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHORTSWAP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">EthAddr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">,</span> <span class="n">EthAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* see if SPI flash exists? */</span>
	<span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">KeyValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atl2_spi_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">0x1f000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Control</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">KeyValid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Register</span> <span class="o">==</span> <span class="n">REG_MAC_STA_ADDR</span><span class="p">)</span>
					<span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Control</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Register</span> <span class="o">==</span> <span class="p">(</span><span class="n">REG_MAC_STA_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
					<span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Control</span><span class="p">;</span>
				<span class="n">KeyValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">Control</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">KeyValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">Register</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">Control</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* data end */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* read error */</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">EthAddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LONGSWAP</span><span class="p">(</span><span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">EthAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHORTSWAP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">EthAddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">,</span> <span class="n">EthAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* maybe MAC-address is from BIOS */</span>
	<span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_STA_ADDR</span><span class="p">);</span>
	<span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_STA_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">EthAddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LONGSWAP</span><span class="p">(</span><span class="n">Addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">EthAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHORTSWAP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">Addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">EthAddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">,</span> <span class="n">EthAddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reads the adapter&#39;s MAC address from the EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_read_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_permanent_address</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* for test */</span>
		<span class="cm">/* FIXME: shouldn&#39;t we use random_ether_addr() here? */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x74</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5c</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">perm_mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hashes an address to determine its location in the multicast table</span>
<span class="cm"> *</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> * mc_addr - the multicast address to hash</span>
<span class="cm"> *</span>
<span class="cm"> * atl2_hash_mc_addr</span>
<span class="cm"> *  purpose</span>
<span class="cm"> *      set hash value for a multicast address</span>
<span class="cm"> *      hash calcu processing :</span>
<span class="cm"> *          1. calcu 32bit CRC for multicast address</span>
<span class="cm"> *          2. reverse crc with MSB to LSB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">atl2_hash_mc_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crc32</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crc32</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">mc_addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">crc32</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sets the bit in the multicast table corresponding to the hash value.</span>
<span class="cm"> *</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> * hash_value - Multicast address hash value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_hash_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hash_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hash_bit</span><span class="p">,</span> <span class="n">hash_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mta</span><span class="p">;</span>

	<span class="cm">/* The HASH Table  is a register array of 2 32-bit registers.</span>
<span class="cm">	 * It is treated like an array of 64 bits.  We want to set</span>
<span class="cm">	 * bit BitArray[hash_value]. So we figure out what register</span>
<span class="cm">	 * the bit is in, read it, OR in the new bit, then write</span>
<span class="cm">	 * back the new value.  The register is determined by the</span>
<span class="cm">	 * upper 7 bits of the hash value and the bit within that</span>
<span class="cm">	 * register are determined by the lower 5 bits of the value.</span>
<span class="cm">	 */</span>
	<span class="n">hash_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">hash_value</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">hash_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">hash_value</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>

	<span class="n">mta</span> <span class="o">=</span> <span class="n">ATL2_READ_REG_ARRAY</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="p">,</span> <span class="n">hash_reg</span><span class="p">);</span>

	<span class="n">mta</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hash_bit</span><span class="p">);</span>

	<span class="n">ATL2_WRITE_REG_ARRAY</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="p">,</span> <span class="n">hash_reg</span><span class="p">,</span> <span class="n">mta</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_init_pcie - init PCIE module</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_init_pcie</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">LTSSM_TEST_MODE_DEF</span><span class="p">;</span>
    <span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_LTSSM_TEST_MODE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">PCIE_DLL_TX_CTRL1_DEF</span><span class="p">;</span>
    <span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_DLL_TX_CTRL1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_init_flash_opcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">flash_table</span><span class="p">))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ATMEL */</span>

	<span class="cm">/* Init OP table */</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_PROGRAM</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdPROGRAM</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_SC_ERASE</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdSECTOR_ERASE</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_CHIP_ERASE</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdCHIP_ERASE</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_RDID</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdRDID</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_WREN</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdWREN</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_RDSR</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdRDSR</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_WRSR</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdWRSR</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REGB</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_OP_READ</span><span class="p">,</span>
		<span class="n">flash_table</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_vendor</span><span class="p">].</span><span class="n">cmdREAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************************</span>
<span class="cm">* Performs basic configuration of the adapter.</span>
<span class="cm">*</span>
<span class="cm">* hw - Struct containing variables accessed by shared code</span>
<span class="cm">* Assumes that the controller has previously been reset and is in a</span>
<span class="cm">* post-reset uninitialized state. Initializes multicast table,</span>
<span class="cm">* and  Calls routines to setup link</span>
<span class="cm">* Leaves the transmit and receive units disabled and uninitialized.</span>
<span class="cm">********************************************************************/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">atl2_init_pcie</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Zero out the Multicast HASH table */</span>
	<span class="cm">/* clear the old settings from the multicast hash table */</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_REG_ARRAY</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_RX_HASH_TABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">atl2_init_flash_opcode</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_phy_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Detects the current speed and duplex settings of the hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> * speed - Speed of the connection</span>
<span class="cm"> * duplex - Duplex setting of the connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_get_speed_and_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="cm">/* Read PHY Specific Status Register (17) */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_ATLX_PSSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="n">MII_ATLX_PSSR_SPD_DPLX_RESOLVED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ATLX_ERR_PHY_RES</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="n">MII_ATLX_PSSR_SPEED</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MII_ATLX_PSSR_100MBS</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_ATLX_PSSR_10MBS</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ATLX_ERR_PHY_SPEED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="n">MII_ATLX_PSSR_DPLX</span><span class="p">)</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">FULL_DUPLEX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">HALF_DUPLEX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reads the value from a PHY register</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> * reg_addr - address of the PHY register to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">phy_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="n">MDIO_REG_ADDR_MASK</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_REG_ADDR_SHIFT</span> <span class="o">|</span>
		<span class="n">MDIO_START</span> <span class="o">|</span>
		<span class="n">MDIO_SUP_PREAMBLE</span> <span class="o">|</span>
		<span class="n">MDIO_RW</span> <span class="o">|</span>
		<span class="n">MDIO_CLK_25_4</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_CLK_SEL_SHIFT</span><span class="p">;</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MDIO_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MDIO_WAIT_TIMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MDIO_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">|</span> <span class="n">MDIO_BUSY</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">|</span> <span class="n">MDIO_BUSY</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">phy_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ATLX_ERR_PHY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Writes a value to a PHY register</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> * reg_addr - address of the PHY register to write</span>
<span class="cm"> * data - data to write to the PHY</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">phy_data</span> <span class="o">&amp;</span> <span class="n">MDIO_DATA_MASK</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_SHIFT</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="n">MDIO_REG_ADDR_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_REG_ADDR_SHIFT</span> <span class="o">|</span>
		<span class="n">MDIO_SUP_PREAMBLE</span> <span class="o">|</span>
		<span class="n">MDIO_START</span> <span class="o">|</span>
		<span class="n">MDIO_CLK_25_4</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_CLK_SEL_SHIFT</span><span class="p">;</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MDIO_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MDIO_WAIT_TIMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MDIO_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">|</span> <span class="n">MDIO_BUSY</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">|</span> <span class="n">MDIO_BUSY</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ATLX_ERR_PHY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configures PHY autoneg and flow control advertisement settings</span>
<span class="cm"> *</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_phy_setup_autoneg_adv</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">mii_autoneg_adv_reg</span><span class="p">;</span>

	<span class="cm">/* Read the MII Auto-Neg Advertisement Register (Address 4). */</span>
	<span class="n">mii_autoneg_adv_reg</span> <span class="o">=</span> <span class="n">MII_AR_DEFAULT_CAP_MASK</span><span class="p">;</span>

	<span class="cm">/* Need to parse autoneg_advertised  and set up</span>
<span class="cm">	 * the appropriate PHY registers.  First we will parse for</span>
<span class="cm">	 * autoneg_advertised software override.  Since we can advertise</span>
<span class="cm">	 * a plethora of combinations, we need to check each bit</span>
<span class="cm">	 * individually.</span>
<span class="cm">	 */</span>

	<span class="cm">/* First we clear all the 10/100 mb speed bits in the Auto-Neg</span>
<span class="cm">	 * Advertisement Register (Address 4) and the 1000 mb speed bits in</span>
<span class="cm">	 * the  1000Base-T Control Register (Address 9). */</span>
	<span class="n">mii_autoneg_adv_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MII_AR_SPEED_MASK</span><span class="p">;</span>

	<span class="cm">/* Need to parse MediaType and setup the</span>
<span class="cm">	 * appropriate PHY registers. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">MediaType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_AUTO_SENSOR</span>:
		<span class="n">mii_autoneg_adv_reg</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">MII_AR_10T_HD_CAPS</span> <span class="o">|</span>
			<span class="n">MII_AR_10T_FD_CAPS</span>  <span class="o">|</span>
			<span class="n">MII_AR_100TX_HD_CAPS</span><span class="o">|</span>
			<span class="n">MII_AR_100TX_FD_CAPS</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span>
			<span class="n">ADVERTISE_10_HALF</span> <span class="o">|</span>
			<span class="n">ADVERTISE_10_FULL</span> <span class="o">|</span>
			<span class="n">ADVERTISE_100_HALF</span><span class="o">|</span>
			<span class="n">ADVERTISE_100_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_100M_FULL</span>:
		<span class="n">mii_autoneg_adv_reg</span> <span class="o">|=</span> <span class="n">MII_AR_100TX_FD_CAPS</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_100_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_100M_HALF</span>:
		<span class="n">mii_autoneg_adv_reg</span> <span class="o">|=</span> <span class="n">MII_AR_100TX_HD_CAPS</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_100_HALF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIA_TYPE_10M_FULL</span>:
		<span class="n">mii_autoneg_adv_reg</span> <span class="o">|=</span> <span class="n">MII_AR_10T_FD_CAPS</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_10_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mii_autoneg_adv_reg</span> <span class="o">|=</span> <span class="n">MII_AR_10T_HD_CAPS</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">=</span> <span class="n">ADVERTISE_10_HALF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* flow control fixed to enable all */</span>
	<span class="n">mii_autoneg_adv_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MII_AR_ASM_DIR</span> <span class="o">|</span> <span class="n">MII_AR_PAUSE</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mii_autoneg_adv_reg</span> <span class="o">=</span> <span class="n">mii_autoneg_adv_reg</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">mii_autoneg_adv_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Resets the PHY and make all config validate</span>
<span class="cm"> *</span>
<span class="cm"> * hw - Struct containing variables accessed by shared code</span>
<span class="cm"> *</span>
<span class="cm"> * Sets bit 15 and 12 of the MII Control regiser (for F001 bug)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_phy_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="n">phy_data</span> <span class="o">=</span> <span class="n">MII_CR_RESET</span> <span class="o">|</span> <span class="n">MII_CR_AUTO_NEG_EN</span> <span class="o">|</span> <span class="n">MII_CR_RESTART_AUTO_NEG</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* pcie serdes link may be down ! */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MDIO_CTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">|</span> <span class="n">MDIO_BUSY</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">|</span> <span class="n">MDIO_BUSY</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;atl2: PCIe link down for at least 25ms !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">atl2_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy_configured</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable PHY */</span>
	<span class="n">ATL2_WRITE_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PHY_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ATL2_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* check if the PHY is in powersaving mode */</span>
	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_val</span><span class="p">);</span>

	<span class="cm">/* 024E / 124E 0r 0274 / 1274 ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_val</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_DATA</span><span class="p">,</span> <span class="n">phy_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*Enable PHY LinkChange Interrupt */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0xC00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* setup AutoNeg parameters */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_phy_setup_autoneg_adv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* SW.Reset &amp; En-Auto-Neg to restart Auto-Neg */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">atl2_phy_commit</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy_configured</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="cm">/* 00-0B-6A-F6-00-DC</span>
<span class="cm">	 * 0:  6AF600DC   1: 000B</span>
<span class="cm">	 * low dword */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
	<span class="n">ATL2_WRITE_REG_ARRAY</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_STA_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="cm">/* hight dword */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="n">ATL2_WRITE_REG_ARRAY</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_MAC_STA_ADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check_eeprom_exist</span>
<span class="cm"> * return 0 if eeprom exist</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atl2_check_eeprom_exist</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">SPI_FLASH_CTRL_EN_VPD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SPI_FLASH_CTRL_EN_VPD</span><span class="p">;</span>
		<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_SPI_FLASH_CTRL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">ATL2_READ_REGW</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_PCIE_CAP_LIST</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x6C00</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: This doesn&#39;t look right. -- CHS */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">atl2_write_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">atl2_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>    <span class="n">Control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Offset</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* address do not align */</span>

	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_VPD_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Control</span> <span class="o">=</span> <span class="p">(</span><span class="n">Offset</span> <span class="o">&amp;</span> <span class="n">VPD_CAP_VPD_ADDR_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">VPD_CAP_VPD_ADDR_SHIFT</span><span class="p">;</span>
	<span class="n">ATL2_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_VPD_CAP</span><span class="p">,</span> <span class="n">Control</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">Control</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_VPD_CAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Control</span> <span class="o">&amp;</span> <span class="n">VPD_CAP_VPD_FLAG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Control</span> <span class="o">&amp;</span> <span class="n">VPD_CAP_VPD_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="n">ATL2_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">REG_VPD_DATA</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* timeout */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atl2_force_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_val</span><span class="p">;</span>

	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atl2_read_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_val</span><span class="p">);</span>
	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_DATA</span><span class="p">,</span> <span class="n">phy_val</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>

	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_ADDR</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_DATA</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">);</span>
	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_ADDR</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">atl2_write_phy_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MII_DBG_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This is the only thing that needs to be changed to adjust the</span>
<span class="cm"> * maximum number of ports that the driver can manage.</span>
<span class="cm"> */</span>
<span class="cp">#define ATL2_MAX_NIC 4</span>

<span class="cp">#define OPTION_UNSET    -1</span>
<span class="cp">#define OPTION_DISABLED 0</span>
<span class="cp">#define OPTION_ENABLED  1</span>

<span class="cm">/* All parameters are treated the same, as an integer array of values.</span>
<span class="cm"> * This macro just reduces the need to repeat the same declaration code</span>
<span class="cm"> * over and over (plus this helps to avoid typo bugs).</span>
<span class="cm"> */</span>
<span class="cp">#define ATL2_PARAM_INIT {[0 ... ATL2_MAX_NIC] = OPTION_UNSET}</span>
<span class="cp">#ifndef module_param_array</span>
<span class="cm">/* Module Parameters are always initialized to -1, so that the driver</span>
<span class="cm"> * can tell the difference between no user specified value or the</span>
<span class="cm"> * user asking for the default value.</span>
<span class="cm"> * The true default values are loaded in when atl2_check_options is called.</span>
<span class="cm"> *</span>
<span class="cm"> * This is a GCC extension to ANSI C.</span>
<span class="cm"> * See the item &quot;Labeled Elements in Initializers&quot; in the section</span>
<span class="cm"> * &quot;Extensions to the C Language Family&quot; of the GCC documentation.</span>
<span class="cm"> */</span>

<span class="cp">#define ATL2_PARAM(X, desc) \</span>
<span class="cp">    static const int __devinitdata X[ATL2_MAX_NIC + 1] = ATL2_PARAM_INIT; \</span>
<span class="cp">    MODULE_PARM(X, &quot;1-&quot; __MODULE_STRING(ATL2_MAX_NIC) &quot;i&quot;); \</span>
<span class="cp">    MODULE_PARM_DESC(X, desc);</span>
<span class="cp">#else</span>
<span class="cp">#define ATL2_PARAM(X, desc) \</span>
<span class="cp">    static int __devinitdata X[ATL2_MAX_NIC+1] = ATL2_PARAM_INIT; \</span>
<span class="cp">    static unsigned int num_##X; \</span>
<span class="cp">    module_param_array_named(X, X, int, &amp;num_##X, 0); \</span>
<span class="cp">    MODULE_PARM_DESC(X, desc);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Transmit Memory Size</span>
<span class="cm"> * Valid Range: 64-2048</span>
<span class="cm"> * Default Value: 128</span>
<span class="cm"> */</span>
<span class="cp">#define ATL2_MIN_TX_MEMSIZE		4	</span><span class="cm">/* 4KB */</span><span class="cp"></span>
<span class="cp">#define ATL2_MAX_TX_MEMSIZE		64	</span><span class="cm">/* 64KB */</span><span class="cp"></span>
<span class="cp">#define ATL2_DEFAULT_TX_MEMSIZE		8	</span><span class="cm">/* 8KB */</span><span class="cp"></span>
<span class="n">ATL2_PARAM</span><span class="p">(</span><span class="n">TxMemSize</span><span class="p">,</span> <span class="s">&quot;Bytes of Transmit Memory&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Receive Memory Block Count</span>
<span class="cm"> * Valid Range: 16-512</span>
<span class="cm"> * Default Value: 128</span>
<span class="cm"> */</span>
<span class="cp">#define ATL2_MIN_RXD_COUNT		16</span>
<span class="cp">#define ATL2_MAX_RXD_COUNT		512</span>
<span class="cp">#define ATL2_DEFAULT_RXD_COUNT		64</span>
<span class="n">ATL2_PARAM</span><span class="p">(</span><span class="n">RxMemBlock</span><span class="p">,</span> <span class="s">&quot;Number of receive memory block&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * User Specified MediaType Override</span>
<span class="cm"> *</span>
<span class="cm"> * Valid Range: 0-5</span>
<span class="cm"> *  - 0    - auto-negotiate at all supported speeds</span>
<span class="cm"> *  - 1    - only link at 1000Mbps Full Duplex</span>
<span class="cm"> *  - 2    - only link at 100Mbps Full Duplex</span>
<span class="cm"> *  - 3    - only link at 100Mbps Half Duplex</span>
<span class="cm"> *  - 4    - only link at 10Mbps Full Duplex</span>
<span class="cm"> *  - 5    - only link at 10Mbps Half Duplex</span>
<span class="cm"> * Default Value: 0</span>
<span class="cm"> */</span>
<span class="n">ATL2_PARAM</span><span class="p">(</span><span class="n">MediaType</span><span class="p">,</span> <span class="s">&quot;MediaType Select&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt Moderate Timer in units of 2048 ns (~2 us)</span>
<span class="cm"> * Valid Range: 10-65535</span>
<span class="cm"> * Default Value: 45000(90ms)</span>
<span class="cm"> */</span>
<span class="cp">#define INT_MOD_DEFAULT_CNT	100 </span><span class="cm">/* 200us */</span><span class="cp"></span>
<span class="cp">#define INT_MOD_MAX_CNT		65000</span>
<span class="cp">#define INT_MOD_MIN_CNT		50</span>
<span class="n">ATL2_PARAM</span><span class="p">(</span><span class="n">IntModTimer</span><span class="p">,</span> <span class="s">&quot;Interrupt Moderator Timer&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * FlashVendor</span>
<span class="cm"> * Valid Range: 0-2</span>
<span class="cm"> * 0 - Atmel</span>
<span class="cm"> * 1 - SST</span>
<span class="cm"> * 2 - ST</span>
<span class="cm"> */</span>
<span class="n">ATL2_PARAM</span><span class="p">(</span><span class="n">FlashVendor</span><span class="p">,</span> <span class="s">&quot;SPI Flash Vendor&quot;</span><span class="p">);</span>

<span class="cp">#define AUTONEG_ADV_DEFAULT	0x2F</span>
<span class="cp">#define AUTONEG_ADV_MASK	0x2F</span>
<span class="cp">#define FLOW_CONTROL_DEFAULT	FLOW_CONTROL_FULL</span>

<span class="cp">#define FLASH_VENDOR_DEFAULT	0</span>
<span class="cp">#define FLASH_VENDOR_MIN	0</span>
<span class="cp">#define FLASH_VENDOR_MAX	2</span>

<span class="k">struct</span> <span class="n">atl2_option</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span> <span class="n">enable_option</span><span class="p">,</span> <span class="n">range_option</span><span class="p">,</span> <span class="n">list_option</span> <span class="p">}</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">def</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span> <span class="cm">/* range_option info */</span>
			<span class="kt">int</span> <span class="n">min</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span> <span class="cm">/* list_option info */</span>
			<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">atl2_opt_list</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span> <span class="p">}</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">l</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">atl2_validate_option</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atl2_option</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl2_opt_list</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">value</span> <span class="o">==</span> <span class="n">OPTION_UNSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">enable_option</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OPTION_ENABLED</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OPTION_DISABLED</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">range_option</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">min</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s set to %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">list_option</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">value</span> <span class="o">==</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Invalid %s specified (%i) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">opt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">);</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atl2_check_options - Range Checking for Command Line Parameters</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine checks all command line parameters for valid user</span>
<span class="cm"> * input.  If an invalid value is given, or if no user specified</span>
<span class="cm"> * value exists, a default value is used.  The final value is stored</span>
<span class="cm"> * in a variable in the adapter structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="n">atl2_check_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">atl2_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atl2_option</span> <span class="n">opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bd_number</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span> <span class="o">&gt;=</span> <span class="n">ATL2_MAX_NIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Warning: no configuration for board #%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Using defaults for all values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifndef module_param_array</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ATL2_MAX_NIC</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Bytes of Transmit Memory */</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">range_option</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Bytes of Transmit Memory&quot;</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="s">&quot;using default of &quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">ATL2_DEFAULT_TX_MEMSIZE</span><span class="p">);</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="n">ATL2_DEFAULT_TX_MEMSIZE</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">ATL2_MIN_TX_MEMSIZE</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ATL2_MAX_TX_MEMSIZE</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_TxMemSize</span> <span class="o">&gt;</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TxMemSize</span><span class="p">[</span><span class="n">bd</span><span class="p">];</span>
		<span class="n">atl2_validate_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">opt</span><span class="p">.</span><span class="n">def</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* txs ring size: */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txd_ring_size</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">&gt;</span> <span class="mi">160</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">txs_ring_size</span> <span class="o">=</span> <span class="mi">160</span><span class="p">;</span>

	<span class="cm">/* Receive Memory Block Count */</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">range_option</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Number of receive memory block&quot;</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="s">&quot;using default of &quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">ATL2_DEFAULT_RXD_COUNT</span><span class="p">);</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="n">ATL2_DEFAULT_RXD_COUNT</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">ATL2_MIN_RXD_COUNT</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ATL2_MAX_RXD_COUNT</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_RxMemBlock</span> <span class="o">&gt;</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">RxMemBlock</span><span class="p">[</span><span class="n">bd</span><span class="p">];</span>
		<span class="n">atl2_validate_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
		<span class="cm">/* FIXME */</span>
		<span class="cm">/* ((u16)val)&amp;~1; */</span>	<span class="cm">/* even number */</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">opt</span><span class="p">.</span><span class="n">def</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* init RXD Flow control value */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc_rxd_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc_rxd_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATL2_MIN_RXD_COUNT</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span>
		<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">ATL2_MIN_RXD_COUNT</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rxd_ring_size</span> <span class="o">/</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* Interrupt Moderate Timer */</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">range_option</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Interrupt Moderate Timer&quot;</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="s">&quot;using default of &quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">INT_MOD_DEFAULT_CNT</span><span class="p">);</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="n">INT_MOD_DEFAULT_CNT</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">INT_MOD_MIN_CNT</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">INT_MOD_MAX_CNT</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_IntModTimer</span> <span class="o">&gt;</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">IntModTimer</span><span class="p">[</span><span class="n">bd</span><span class="p">];</span>
		<span class="n">atl2_validate_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">imt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">imt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">opt</span><span class="p">.</span><span class="n">def</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Flash Vendor */</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">range_option</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SPI Flash Vendor&quot;</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="s">&quot;using default of &quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">FLASH_VENDOR_DEFAULT</span><span class="p">);</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="n">FLASH_VENDOR_DEFAULT</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">FLASH_VENDOR_MIN</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">FLASH_VENDOR_MAX</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_FlashVendor</span> <span class="o">&gt;</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">FlashVendor</span><span class="p">[</span><span class="n">bd</span><span class="p">];</span>
		<span class="n">atl2_validate_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flash_vendor</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flash_vendor</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">opt</span><span class="p">.</span><span class="n">def</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* MediaType */</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">range_option</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Speed/Duplex Selection&quot;</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="s">&quot;using default of &quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">MEDIA_TYPE_AUTO_SENSOR</span><span class="p">);</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_AUTO_SENSOR</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_AUTO_SENSOR</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">arg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MEDIA_TYPE_10M_HALF</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_MediaType</span> <span class="o">&gt;</span> <span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">MediaType</span><span class="p">[</span><span class="n">bd</span><span class="p">];</span>
		<span class="n">atl2_validate_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MediaType</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#ifdef module_param_array</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">MediaType</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">opt</span><span class="p">.</span><span class="n">def</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
