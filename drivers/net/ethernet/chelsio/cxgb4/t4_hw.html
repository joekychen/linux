<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb4 › t4_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>t4_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of the Chelsio T4 Ethernet driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;cxgb4.h&quot;</span>
<span class="cp">#include &quot;t4_regs.h&quot;</span>
<span class="cp">#include &quot;t4fw_api.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_wait_op_done_val - wait until an operation is completed</span>
<span class="cm"> *	@adapter: the adapter performing the operation</span>
<span class="cm"> *	@reg: the register to check for completion</span>
<span class="cm"> *	@mask: a single-bit field within @reg that indicates completion</span>
<span class="cm"> *	@polarity: the value of the field when the operation is completed</span>
<span class="cm"> *	@attempts: number of check iterations</span>
<span class="cm"> *	@delay: delay in usecs between iterations</span>
<span class="cm"> *	@valp: where to store the value of the register at completion time</span>
<span class="cm"> *</span>
<span class="cm"> *	Wait until an operation is completed by checking a bit in a register</span>
<span class="cm"> *	up to @attempts times.  If @valp is not NULL the value of the register</span>
<span class="cm"> *	at the time it indicated completion is stored there.  Returns 0 if the</span>
<span class="cm"> *	operation completes and	-EAGAIN	otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t4_wait_op_done_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">polarity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attempts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">polarity</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">valp</span><span class="p">)</span>
				<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">attempts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">t4_wait_op_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">polarity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attempts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t4_wait_op_done_val</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">attempts</span><span class="p">,</span>
				   <span class="n">delay</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_set_reg_field - set a register field to a value</span>
<span class="cm"> *	@adapter: the adapter to program</span>
<span class="cm"> *	@addr: the register address</span>
<span class="cm"> *	@mask: specifies the portion of the register to modify</span>
<span class="cm"> *	@val: the new value for the register field</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets a register field specified by the supplied mask to the</span>
<span class="cm"> *	given value.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_set_reg_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>      <span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_read_indirect - read indirectly addressed registers</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@addr_reg: register holding the indirect address</span>
<span class="cm"> *	@data_reg: register holding the value of the indirect register</span>
<span class="cm"> *	@vals: where the read register values are stored</span>
<span class="cm"> *	@nregs: how many indirect registers to read</span>
<span class="cm"> *	@start_idx: index of first indirect register to read</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads registers that are accessed indirectly through an address/data</span>
<span class="cm"> *	register pair.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">t4_read_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr_reg</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nregs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nregs</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">addr_reg</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">);</span>
		<span class="o">*</span><span class="n">vals</span><span class="o">++</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
		<span class="n">start_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the reply to a mailbox command and store it in @rpl in big-endian order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_mbox_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">rpl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nflit</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">mbox_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">nflit</span><span class="p">;</span> <span class="n">nflit</span><span class="o">--</span><span class="p">,</span> <span class="n">mbox_addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpl</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox_addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle a FW assertion reported in a mailbox.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fw_asrt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mbox_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_debug_cmd</span> <span class="n">asrt</span><span class="p">;</span>

	<span class="n">get_mbox_rpl</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">asrt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">asrt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mbox_addr</span><span class="p">);</span>
	<span class="n">dev_alert</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
		  <span class="s">&quot;FW assertion at %.16s:%u, val0 %#x, val1 %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">asrt</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">filename_0_7</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">asrt</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">line</span><span class="p">),</span>
		  <span class="n">ntohl</span><span class="p">(</span><span class="n">asrt</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">asrt</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">assert</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
		<span class="s">&quot;mbox %d: %llx %llx %llx %llx %llx %llx %llx %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="mi">16</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="mi">24</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="mi">32</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="mi">40</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="mi">48</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="mi">56</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_wr_mbox_meat - send a command to FW through the given mailbox</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: index of the mailbox to use</span>
<span class="cm"> *	@cmd: the command to write</span>
<span class="cm"> *	@size: command length in bytes</span>
<span class="cm"> *	@rpl: where to optionally store the reply</span>
<span class="cm"> *	@sleep_ok: if true we may sleep while awaiting command completion</span>
<span class="cm"> *</span>
<span class="cm"> *	Sends the given command to FW through the selected mailbox and waits</span>
<span class="cm"> *	for the FW to execute the command.  If @rpl is not %NULL it is used to</span>
<span class="cm"> *	store the FW&#39;s reply to the command.  The command and its optional</span>
<span class="cm"> *	reply are of the same length.  FW can take up to %FW_CMD_MAX_TIMEOUT ms</span>
<span class="cm"> *	to respond.  @sleep_ok determines whether we may sleep while awaiting</span>
<span class="cm"> *	the response.  If sleeping is allowed we use progressive backoff</span>
<span class="cm"> *	otherwise we spin.</span>
<span class="cm"> *</span>
<span class="cm"> *	The return value is 0 on success or a negative errno on failure.  A</span>
<span class="cm"> *	failure can happen either because we are not able to execute the</span>
<span class="cm"> *	command or FW executes it but signals an error.  In the latter case</span>
<span class="cm"> *	the return value is the error code indicated by FW (negated).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_wr_mbox_meat</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">rpl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sleep_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span>
	<span class="p">};</span>

	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">delay_idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_reg</span> <span class="o">=</span> <span class="n">PF_REG</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">CIM_PF_MAILBOX_DATA</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctl_reg</span> <span class="o">=</span> <span class="n">PF_REG</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">CIM_PF_MAILBOX_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">MBOX_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device is off-line, as in EEH, commands will time out.</span>
<span class="cm">	 * Fail them early so we don&#39;t waste time waiting.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">!=</span> <span class="n">pci_channel_io_normal</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">MBOWNER_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">v</span> <span class="o">==</span> <span class="n">MBOX_OWNER_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">MBOWNER_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">MBOX_OWNER_DRV</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">t4_write_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">,</span> <span class="n">MBMSGVALID</span> <span class="o">|</span> <span class="n">MBOWNER</span><span class="p">(</span><span class="n">MBOX_OWNER_FW</span><span class="p">));</span>
	<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">);</span>          <span class="cm">/* flush write */</span>

	<span class="n">delay_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ms</span> <span class="o">=</span> <span class="n">delay</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FW_CMD_MAX_TIMEOUT</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ms</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms</span> <span class="o">=</span> <span class="n">delay</span><span class="p">[</span><span class="n">delay_idx</span><span class="p">];</span>  <span class="cm">/* last element may repeat */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay_idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">delay_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MBOWNER_GET</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">MBOX_OWNER_DRV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">MBMSGVALID</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">res</span> <span class="o">=</span> <span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FW_CMD_OP_GET</span><span class="p">(</span><span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="n">FW_DEBUG_CMD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fw_asrt</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">FW_CMD_RETVAL</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="p">)</span>
				<span class="n">get_mbox_rpl</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">rpl</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">FW_CMD_RETVAL_GET</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="p">))</span>
				<span class="n">dump_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
			<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">FW_CMD_RETVAL_GET</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dump_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;command %#x in mailbox %d timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_mc_read - read from MC through backdoor accesses</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@addr: address of first byte requested</span>
<span class="cm"> *	@data: 64 bytes of data containing the requested address</span>
<span class="cm"> *	@ecc: where to store the corresponding 64-bit ECC word</span>
<span class="cm"> *</span>
<span class="cm"> *	Read 64 bytes of data from MC starting at a 64-byte-aligned address</span>
<span class="cm"> *	that covers the requested address @addr.  If @parity is not %NULL it</span>
<span class="cm"> *	is assigned the 64-bit ECC word for the read data.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_mc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_BIST_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">START_BIST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_BIST_CMD_ADDR</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3fU</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_BIST_CMD_LEN</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_BIST_DATA_PATTERN</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_BIST_CMD</span><span class="p">,</span> <span class="n">BIST_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">START_BIST</span> <span class="o">|</span>
		     <span class="n">BIST_CMD_GAP</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">t4_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_BIST_CMD</span><span class="p">,</span> <span class="n">START_BIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#define MC_DATA(i) MC_BIST_STATUS_REG(MC_BIST_STATUS_RDATA, i)</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_DATA</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecc</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ecc</span> <span class="o">=</span> <span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MC_DATA</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
<span class="cp">#undef MC_DATA</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_edc_read - read from EDC through backdoor accesses</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@idx: which EDC to access</span>
<span class="cm"> *	@addr: address of first byte requested</span>
<span class="cm"> *	@data: 64 bytes of data containing the requested address</span>
<span class="cm"> *	@ecc: where to store the corresponding 64-bit ECC word</span>
<span class="cm"> *</span>
<span class="cm"> *	Read 64 bytes of data from EDC starting at a 64-byte-aligned address</span>
<span class="cm"> *	that covers the requested address @addr.  If @parity is not %NULL it</span>
<span class="cm"> *	is assigned the 64-bit ECC word for the read data.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_edc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">*=</span> <span class="n">EDC_STRIDE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_BIST_CMD</span> <span class="o">+</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">START_BIST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_BIST_CMD_ADDR</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3fU</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_BIST_CMD_LEN</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_BIST_DATA_PATTERN</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_BIST_CMD</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
		     <span class="n">BIST_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIST_CMD_GAP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">START_BIST</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">t4_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_BIST_CMD</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">START_BIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#define EDC_DATA(i) (EDC_BIST_STATUS_REG(EDC_BIST_STATUS_RDATA, i) + idx)</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_DATA</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecc</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ecc</span> <span class="o">=</span> <span class="n">t4_read_reg64</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EDC_DATA</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
<span class="cp">#undef EDC_DATA</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EEPROM_STAT_ADDR   0x7bfc</span>
<span class="cp">#define VPD_BASE           0</span>
<span class="cp">#define VPD_LEN            512</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_seeprom_wp - enable/disable EEPROM write protection</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@enable: whether to enable or disable write protection</span>
<span class="cm"> *</span>
<span class="cm"> *	Enables or disables write protection on the serial EEPROM.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_seeprom_wp</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0xc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pci_write_vpd</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">EEPROM_STAT_ADDR</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	get_vpd_params - read VPD parameters from VPD EEPROM</span>
<span class="cm"> *	@adapter: adapter to read</span>
<span class="cm"> *	@p: where to store the parameters</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads card parameters stored in VPD EEPROM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_vpd_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vpd_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ec</span><span class="p">,</span> <span class="n">sn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vpd</span><span class="p">[</span><span class="n">VPD_LEN</span><span class="p">],</span> <span class="n">csum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vpdr_len</span><span class="p">,</span> <span class="n">kw_offset</span><span class="p">,</span> <span class="n">id_len</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_vpd</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VPD_BASE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpd</span><span class="p">),</span> <span class="n">vpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PCI_VPD_LRDT_ID_STRING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;missing VPD ID string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">id_len</span> <span class="o">=</span> <span class="n">pci_vpd_lrdt_size</span><span class="p">(</span><span class="n">vpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id_len</span> <span class="o">&gt;</span> <span class="n">ID_LEN</span><span class="p">)</span>
		<span class="n">id_len</span> <span class="o">=</span> <span class="n">ID_LEN</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_vpd_find_tag</span><span class="p">(</span><span class="n">vpd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VPD_LEN</span><span class="p">,</span> <span class="n">PCI_VPD_LRDT_RO_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;missing VPD-R section</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vpdr_len</span> <span class="o">=</span> <span class="n">pci_vpd_lrdt_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kw_offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpdr_len</span> <span class="o">+</span> <span class="n">kw_offset</span> <span class="o">&gt;</span> <span class="n">VPD_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;bad VPD-R length %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vpdr_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#define FIND_VPD_KW(var, name) do { \</span>
<span class="cp">	var = pci_vpd_find_info_keyword(vpd, kw_offset, vpdr_len, name); \</span>
<span class="cp">	if (var &lt; 0) { \</span>
<span class="cp">		dev_err(adapter-&gt;pdev_dev, &quot;missing VPD keyword &quot; name &quot;\n&quot;); \</span>
<span class="cp">		return -EINVAL; \</span>
<span class="cp">	} \</span>
<span class="cp">	var += PCI_VPD_INFO_FLD_HDR_SIZE; \</span>
<span class="cp">} while (0)</span>

	<span class="n">FIND_VPD_KW</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;RV&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">vpd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			<span class="s">&quot;corrupted VPD EEPROM, actual csum %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FIND_VPD_KW</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="s">&quot;EC&quot;</span><span class="p">);</span>
	<span class="n">FIND_VPD_KW</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="s">&quot;SN&quot;</span><span class="p">);</span>
<span class="cp">#undef FIND_VPD_KW</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">vpd</span> <span class="o">+</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span><span class="p">,</span> <span class="n">id_len</span><span class="p">);</span>
	<span class="n">strim</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ec</span><span class="p">,</span> <span class="n">vpd</span> <span class="o">+</span> <span class="n">ec</span><span class="p">,</span> <span class="n">EC_LEN</span><span class="p">);</span>
	<span class="n">strim</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ec</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_vpd_info_field_size</span><span class="p">(</span><span class="n">vpd</span> <span class="o">+</span> <span class="n">sn</span> <span class="o">-</span> <span class="n">PCI_VPD_INFO_FLD_HDR_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">,</span> <span class="n">vpd</span> <span class="o">+</span> <span class="n">sn</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">SERNUM_LEN</span><span class="p">));</span>
	<span class="n">strim</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* serial flash and firmware constants */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">SF_ATTEMPTS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>             <span class="cm">/* max retries for SF operations */</span>

	<span class="cm">/* flash command opcodes */</span>
	<span class="n">SF_PROG_PAGE</span>    <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>          <span class="cm">/* program page */</span>
	<span class="n">SF_WR_DISABLE</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>          <span class="cm">/* disable writes */</span>
	<span class="n">SF_RD_STATUS</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>          <span class="cm">/* read status register */</span>
	<span class="n">SF_WR_ENABLE</span>    <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>          <span class="cm">/* enable writes */</span>
	<span class="n">SF_RD_DATA_FAST</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">,</span>        <span class="cm">/* read flash */</span>
	<span class="n">SF_RD_ID</span>        <span class="o">=</span> <span class="mh">0x9f</span><span class="p">,</span>       <span class="cm">/* read ID */</span>
	<span class="n">SF_ERASE_SECTOR</span> <span class="o">=</span> <span class="mh">0xd8</span><span class="p">,</span>       <span class="cm">/* erase sector */</span>

	<span class="n">FW_MAX_SIZE</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	sf1_read - read data from the serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@byte_cnt: number of bytes to read</span>
<span class="cm"> *	@cont: whether another operation will be chained</span>
<span class="cm"> *	@lock: whether to lock SF for PL access only</span>
<span class="cm"> *	@valp: where to store the read data</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads up to 4 bytes of data from the serial flash.  The location of</span>
<span class="cm"> *	the read needs to be specified prior to calling this by issuing the</span>
<span class="cm"> *	appropriate commands to the serial flash.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sf1_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cont</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">lock</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byte_cnt</span> <span class="o">||</span> <span class="n">byte_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="n">cont</span> <span class="o">?</span> <span class="n">SF_CONT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span> <span class="o">?</span> <span class="n">SF_LOCK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="n">lock</span> <span class="o">|</span> <span class="n">cont</span> <span class="o">|</span> <span class="n">BYTECNT</span><span class="p">(</span><span class="n">byte_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="n">BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SF_ATTEMPTS</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sf1_write - write data to the serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@byte_cnt: number of bytes to write</span>
<span class="cm"> *	@cont: whether another operation will be chained</span>
<span class="cm"> *	@lock: whether to lock SF for PL access only</span>
<span class="cm"> *	@val: value to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Writes up to 4 bytes of data to the serial flash.  The location of</span>
<span class="cm"> *	the write needs to be specified prior to calling this by issuing the</span>
<span class="cm"> *	appropriate commands to the serial flash.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sf1_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cont</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">lock</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byte_cnt</span> <span class="o">||</span> <span class="n">byte_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="n">cont</span> <span class="o">?</span> <span class="n">SF_CONT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span> <span class="o">?</span> <span class="n">SF_LOCK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="n">lock</span> <span class="o">|</span>
		     <span class="n">cont</span> <span class="o">|</span> <span class="n">BYTECNT</span><span class="p">(</span><span class="n">byte_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">OP_WR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="n">BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SF_ATTEMPTS</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	flash_wait_op - wait for a flash operation to complete</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@attempts: max number of polls of the status register</span>
<span class="cm"> *	@delay: delay between polls in ms</span>
<span class="cm"> *</span>
<span class="cm"> *	Wait for a flash operation to complete by polling the status register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flash_wait_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attempts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SF_RD_STATUS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">attempts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_read_flash - read words from serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@addr: the start address for the read</span>
<span class="cm"> *	@nwords: how many 32-bit words to read</span>
<span class="cm"> *	@data: where to store the read data</span>
<span class="cm"> *	@byte_oriented: whether to store data as bytes or as words</span>
<span class="cm"> *</span>
<span class="cm"> *	Read the specified number of 32-bit words from the serial flash.</span>
<span class="cm"> *	If @byte_oriented is set the read data is stored as a byte array</span>
<span class="cm"> *	(i.e., big-endian), otherwise as 32-bit words in the platform&#39;s</span>
<span class="cm"> *	natural endianess.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t4_read_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nwords</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byte_oriented</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">nwords</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_size</span> <span class="o">||</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">SF_RD_DATA_FAST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">nwords</span><span class="p">;</span> <span class="n">nwords</span><span class="o">--</span><span class="p">,</span> <span class="n">data</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nwords</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nwords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nwords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="cm">/* unlock SF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte_oriented</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_write_flash - write up to a page of data to the serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@addr: the start address to write</span>
<span class="cm"> *	@n: length of data to write in bytes</span>
<span class="cm"> *	@data: the data to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Writes up to a page of data (256 bytes) to the serial flash starting</span>
<span class="cm"> *	at the given address.  All the data must be written to the same page.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t4_write_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_size</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">SF_PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">SF_PROG_PAGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SF_WR_ENABLE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="n">left</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">4U</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">left</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">flash_wait_op</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="cm">/* unlock SF */</span>

	<span class="cm">/* Read the page to verify the write succeeded */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_read_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			<span class="s">&quot;failed to correctly write the flash page at %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="cm">/* unlock SF */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	get_fw_version - read the firmware version</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@vers: where to place the version</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads the FW version from flash.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t4_read_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_fw_start</span> <span class="o">+</span>
			     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_hdr</span><span class="p">,</span> <span class="n">fw_ver</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	get_tp_version - read the TP microcode version</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@vers: where to place the version</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads the TP microcode version from flash.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_tp_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t4_read_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_fw_start</span> <span class="o">+</span>
			     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_hdr</span><span class="p">,</span> <span class="n">tp_microcode_ver</span><span class="p">),</span>
			     <span class="mi">1</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_check_fw_version - check if the FW is compatible with this driver</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *	Checks if an adapter&#39;s FW is compatible with the driver.  Returns 0</span>
<span class="cm"> *	if there&#39;s exact match, a negative error if the version could not be</span>
<span class="cm"> *	read or there&#39;s a major version mismatch, and a positive value if the</span>
<span class="cm"> *	expected major version is found but there&#39;s a minor version mismatch.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_check_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">api_vers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">micro</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_fw_version</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_tp_version</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp_vers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_read_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_fw_start</span> <span class="o">+</span>
				    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_hdr</span><span class="p">,</span> <span class="n">intfver_nic</span><span class="p">),</span>
				    <span class="mi">2</span><span class="p">,</span> <span class="n">api_vers</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">major</span> <span class="o">=</span> <span class="n">FW_HDR_FW_VER_MAJOR_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">);</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">FW_HDR_FW_VER_MINOR_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">);</span>
	<span class="n">micro</span> <span class="o">=</span> <span class="n">FW_HDR_FW_VER_MICRO_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">api_vers</span><span class="p">,</span> <span class="n">api_vers</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">api_vers</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">!=</span> <span class="n">FW_VERSION_MAJOR</span><span class="p">)</span> <span class="p">{</span>            <span class="cm">/* major mismatch - fail */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			<span class="s">&quot;card FW has major version %u, driver wants %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">major</span><span class="p">,</span> <span class="n">FW_VERSION_MAJOR</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">==</span> <span class="n">FW_VERSION_MINOR</span> <span class="o">&amp;&amp;</span> <span class="n">micro</span> <span class="o">==</span> <span class="n">FW_VERSION_MICRO</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                   <span class="cm">/* perfect match */</span>

	<span class="cm">/* Minor/micro version mismatch.  Report it but often it&#39;s OK. */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_flash_erase_sectors - erase a range of flash sectors</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@start: the first sector to erase</span>
<span class="cm"> *	@end: the last sector to erase</span>
<span class="cm"> *</span>
<span class="cm"> *	Erases the sectors in the given inclusive range.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t4_flash_erase_sectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SF_WR_ENABLE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="n">SF_ERASE_SECTOR</span> <span class="o">|</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">flash_wait_op</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
				<span class="s">&quot;erase of flash sector %d failed, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">start</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="cm">/* unlock SF */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_load_fw - download firmware</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@fw_data: the firmware image to write</span>
<span class="cm"> *	@size: image size</span>
<span class="cm"> *</span>
<span class="cm"> *	Write the supplied firmware image to the card&#39;s serial flash.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">csum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">first_page</span><span class="p">[</span><span class="n">SF_PAGE_SIZE</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sf_sec_size</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_size</span> <span class="o">/</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_nsec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fw_img_start</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_fw_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fw_start_sec</span> <span class="o">=</span> <span class="n">fw_img_start</span> <span class="o">/</span> <span class="n">sf_sec_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;FW image has no data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mi">511</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			<span class="s">&quot;FW image size not multiple of 512 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len512</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			<span class="s">&quot;FW image size differs from size in FW header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">FW_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;FW image too large, max is %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FW_MAX_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			<span class="s">&quot;corrupted firmware image, checksum %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sf_sec_size</span><span class="p">);</span>        <span class="cm">/* # of sectors spanned */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_flash_erase_sectors</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">fw_start_sec</span><span class="p">,</span> <span class="n">fw_start_sec</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We write the correct version at the end so the driver can see a bad</span>
<span class="cm">	 * version if the FW write fails.  Start by writing a copy of the</span>
<span class="cm">	 * first page with a bad version.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">first_page</span><span class="p">,</span> <span class="n">fw_data</span><span class="p">,</span> <span class="n">SF_PAGE_SIZE</span><span class="p">);</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">first_page</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_write_flash</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">fw_img_start</span><span class="p">,</span> <span class="n">SF_PAGE_SIZE</span><span class="p">,</span> <span class="n">first_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">fw_img_start</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">size</span> <span class="o">-=</span> <span class="n">SF_PAGE_SIZE</span><span class="p">;</span> <span class="n">size</span><span class="p">;</span> <span class="n">size</span> <span class="o">-=</span> <span class="n">SF_PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">SF_PAGE_SIZE</span><span class="p">;</span>
		<span class="n">fw_data</span> <span class="o">+=</span> <span class="n">SF_PAGE_SIZE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_write_flash</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">SF_PAGE_SIZE</span><span class="p">,</span> <span class="n">fw_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_write_flash</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
			     <span class="n">fw_img_start</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_hdr</span><span class="p">,</span> <span class="n">fw_ver</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">),</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;firmware download failed, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ADVERT_MASK (FW_PORT_CAP_SPEED_100M | FW_PORT_CAP_SPEED_1G |\</span>
<span class="cp">		     FW_PORT_CAP_SPEED_10G | FW_PORT_CAP_ANEG)</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_link_start - apply link configuration to MAC/PHY</span>
<span class="cm"> *	@phy: the PHY to setup</span>
<span class="cm"> *	@mac: the MAC to setup</span>
<span class="cm"> *	@lc: the requested link configuration</span>
<span class="cm"> *</span>
<span class="cm"> *	Set up a port&#39;s MAC and PHY according to a desired link configuration.</span>
<span class="cm"> *	- If the PHY can auto-negotiate first decide what to advertise, then</span>
<span class="cm"> *	  enable/disable auto-negotiation as desired, and reset.</span>
<span class="cm"> *	- If the PHY does not auto-negotiate just reset it.</span>
<span class="cm"> *	- If auto-negotiation is off set the MAC to the proper speed/duplex/FC,</span>
<span class="cm"> *	  otherwise do it later based on the outcome of auto-negotiation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_link_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_port_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mdi</span> <span class="o">=</span> <span class="n">FW_PORT_MDI</span><span class="p">(</span><span class="n">FW_PORT_MDI_AUTO</span><span class="p">);</span>

	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_RX</span><span class="p">)</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">FW_PORT_CAP_FC_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_TX</span><span class="p">)</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">FW_PORT_CAP_FC_TX</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_portid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_PORT_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			       <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_PORT_CMD_PORTID</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">action_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_PORT_CMD_ACTION</span><span class="p">(</span><span class="n">FW_PORT_ACTION_L1_CFG</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_ANEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l1cfg</span><span class="p">.</span><span class="n">rcap</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">ADVERT_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">fc</span><span class="p">);</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAUSE_RX</span> <span class="o">|</span> <span class="n">PAUSE_TX</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l1cfg</span><span class="p">.</span><span class="n">rcap</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span> <span class="o">|</span> <span class="n">fc</span> <span class="o">|</span> <span class="n">mdi</span><span class="p">);</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAUSE_RX</span> <span class="o">|</span> <span class="n">PAUSE_TX</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l1cfg</span><span class="p">.</span><span class="n">rcap</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|</span> <span class="n">fc</span> <span class="o">|</span> <span class="n">mdi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_restart_aneg - restart autonegotiation</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mbox to use for the FW command</span>
<span class="cm"> *	@port: the port id</span>
<span class="cm"> *</span>
<span class="cm"> *	Restarts autonegotiation for the selected port.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_restart_aneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_port_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_portid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_PORT_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			       <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_PORT_CMD_PORTID</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">action_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_PORT_CMD_ACTION</span><span class="p">(</span><span class="n">FW_PORT_ACTION_L1_CFG</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">l1cfg</span><span class="p">.</span><span class="n">rcap</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_PORT_CAP_ANEG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">int_handler_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">intr_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>       <span class="cm">/* bits to check in interrupt status */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>         <span class="cm">/* message to print or NULL */</span>
	<span class="kt">short</span> <span class="n">stat_idx</span><span class="p">;</span>          <span class="cm">/* stat counter to increment or -1 */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fatal</span><span class="p">;</span>    <span class="cm">/* whether the condition reported is fatal */</span>
	<span class="n">int_handler_t</span> <span class="n">int_handler</span><span class="p">;</span> <span class="cm">/* platform-specific int handler */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_handle_intr_status - table driven interrupt handler</span>
<span class="cm"> *	@adapter: the adapter that generated the interrupt</span>
<span class="cm"> *	@reg: the interrupt status register to process</span>
<span class="cm"> *	@acts: table of interrupt actions</span>
<span class="cm"> *</span>
<span class="cm"> *	A table driven interrupt handler that applies a set of masks to an</span>
<span class="cm"> *	interrupt status word and performs the corresponding actions if the</span>
<span class="cm"> *	interrupts described by the mask have occurred.  The actions include</span>
<span class="cm"> *	optionally emitting a warning or alert message.  The table is terminated</span>
<span class="cm"> *	by an entry specifying mask 0.  Returns the number of fatal interrupt</span>
<span class="cm"> *	conditions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t4_handle_intr_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="o">*</span><span class="n">acts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fatal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span> <span class="o">++</span><span class="n">acts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">fatal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fatal</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_alert</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;%s (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span>
				  <span class="n">status</span> <span class="o">&amp;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">&amp;&amp;</span> <span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;%s (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span>
				 <span class="n">status</span> <span class="o">&amp;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">int_handler</span><span class="p">)</span>
			<span class="n">acts</span><span class="o">-&gt;</span><span class="n">int_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>                           <span class="cm">/* clear processed interrupts */</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fatal</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handler for the PCIE module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcie_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">sysbus_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">RNPP</span><span class="p">,</span> <span class="s">&quot;RXNP array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPCP</span><span class="p">,</span> <span class="s">&quot;RXPC array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCIP</span><span class="p">,</span> <span class="s">&quot;RXCIF array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCCP</span><span class="p">,</span> <span class="s">&quot;Rx completions control array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RFTP</span><span class="p">,</span> <span class="s">&quot;RXFT array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pcie_port_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">TPCP</span><span class="p">,</span> <span class="s">&quot;TXPC array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TNPP</span><span class="p">,</span> <span class="s">&quot;TXNP array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TFTP</span><span class="p">,</span> <span class="s">&quot;TXFT array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TCAP</span><span class="p">,</span> <span class="s">&quot;TXCA array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TCIP</span><span class="p">,</span> <span class="s">&quot;TXCIF array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCAP</span><span class="p">,</span> <span class="s">&quot;RXCA array parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">OTDD</span><span class="p">,</span> <span class="s">&quot;outbound request TLP discarded&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RDPE</span><span class="p">,</span> <span class="s">&quot;Rx data parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TDUE</span><span class="p">,</span> <span class="s">&quot;Tx uncorrectable data error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pcie_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MSIADDRLPERR</span><span class="p">,</span> <span class="s">&quot;MSI AddrL parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MSIADDRHPERR</span><span class="p">,</span> <span class="s">&quot;MSI AddrH parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MSIDATAPERR</span><span class="p">,</span> <span class="s">&quot;MSI data parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MSIXADDRLPERR</span><span class="p">,</span> <span class="s">&quot;MSI-X AddrL parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MSIXADDRHPERR</span><span class="p">,</span> <span class="s">&quot;MSI-X AddrH parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MSIXDATAPERR</span><span class="p">,</span> <span class="s">&quot;MSI-X data parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MSIXDIPERR</span><span class="p">,</span> <span class="s">&quot;MSI-X DI parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PIOCPLPERR</span><span class="p">,</span> <span class="s">&quot;PCI PIO completion FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PIOREQPERR</span><span class="p">,</span> <span class="s">&quot;PCI PIO request FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TARTAGPERR</span><span class="p">,</span> <span class="s">&quot;PCI PCI target tag FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CCNTPERR</span><span class="p">,</span> <span class="s">&quot;PCI CMD channel count parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CREQPERR</span><span class="p">,</span> <span class="s">&quot;PCI CMD channel request parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CRSPPERR</span><span class="p">,</span> <span class="s">&quot;PCI CMD channel response parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DCNTPERR</span><span class="p">,</span> <span class="s">&quot;PCI DMA channel count parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DREQPERR</span><span class="p">,</span> <span class="s">&quot;PCI DMA channel request parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DRSPPERR</span><span class="p">,</span> <span class="s">&quot;PCI DMA channel response parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HCNTPERR</span><span class="p">,</span> <span class="s">&quot;PCI HMA channel count parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HREQPERR</span><span class="p">,</span> <span class="s">&quot;PCI HMA channel request parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HRSPPERR</span><span class="p">,</span> <span class="s">&quot;PCI HMA channel response parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CFGSNPPERR</span><span class="p">,</span> <span class="s">&quot;PCI config snoop FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">FIDPERR</span><span class="p">,</span> <span class="s">&quot;PCI FID parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">INTXCLRPERR</span><span class="p">,</span> <span class="s">&quot;PCI INTx clear parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MATAGPERR</span><span class="p">,</span> <span class="s">&quot;PCI MA tag parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PIOTAGPERR</span><span class="p">,</span> <span class="s">&quot;PCI PIO tag parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RXCPLPERR</span><span class="p">,</span> <span class="s">&quot;PCI Rx completion parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RXWRPERR</span><span class="p">,</span> <span class="s">&quot;PCI Rx write parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPLPERR</span><span class="p">,</span> <span class="s">&quot;PCI replay buffer parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PCIESINT</span><span class="p">,</span> <span class="s">&quot;PCI core secondary fault&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PCIEPINT</span><span class="p">,</span> <span class="s">&quot;PCI core primary fault&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">UNXSPLCPLERR</span><span class="p">,</span> <span class="s">&quot;PCI unexpected split completion error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">fat</span><span class="p">;</span>

	<span class="n">fat</span> <span class="o">=</span> <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				    <span class="n">PCIE_CORE_UTL_SYSTEM_BUS_AGENT_STATUS</span><span class="p">,</span>
				    <span class="n">sysbus_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				    <span class="n">PCIE_CORE_UTL_PCI_EXPRESS_PORT_STATUS</span><span class="p">,</span>
				    <span class="n">pcie_port_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PCIE_INT_CAUSE</span><span class="p">,</span> <span class="n">pcie_intr_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fat</span><span class="p">)</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TP interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tp_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">tp_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x3fffffff</span><span class="p">,</span> <span class="s">&quot;TP parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">FLMTXFLSTEMPTY</span><span class="p">,</span> <span class="s">&quot;TP out of Tx pages&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">TP_INT_CAUSE</span><span class="p">,</span> <span class="n">tp_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SGE interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sge_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">sge_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ERR_CPL_EXCEED_IQE_SIZE</span><span class="p">,</span>
		  <span class="s">&quot;SGE received CPL exceeding IQE size&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_INVALID_CIDX_INC</span><span class="p">,</span>
		  <span class="s">&quot;SGE GTS CIDX increment too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_CPL_OPCODE_0</span><span class="p">,</span> <span class="s">&quot;SGE received 0-length CPL&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">F_DBFIFO_LP_INT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t4_db_full</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">F_DBFIFO_HP_INT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t4_db_full</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">F_ERR_DROPPED_DB</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t4_db_dropped</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_DATA_CPL_ON_HIGH_QID1</span> <span class="o">|</span> <span class="n">ERR_DATA_CPL_ON_HIGH_QID0</span><span class="p">,</span>
		  <span class="s">&quot;SGE IQID &gt; 1023 received CPL for FL&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_BAD_DB_PIDX3</span><span class="p">,</span> <span class="s">&quot;SGE DBP 3 pidx increment too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_BAD_DB_PIDX2</span><span class="p">,</span> <span class="s">&quot;SGE DBP 2 pidx increment too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_BAD_DB_PIDX1</span><span class="p">,</span> <span class="s">&quot;SGE DBP 1 pidx increment too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_BAD_DB_PIDX0</span><span class="p">,</span> <span class="s">&quot;SGE DBP 0 pidx increment too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_ING_CTXT_PRIO</span><span class="p">,</span>
		  <span class="s">&quot;SGE too many priority ingress contexts&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ERR_EGR_CTXT_PRIO</span><span class="p">,</span>
		  <span class="s">&quot;SGE too many priority egress contexts&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">INGRESS_SIZE_ERR</span><span class="p">,</span> <span class="s">&quot;SGE illegal ingress QID&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">EGRESS_SIZE_ERR</span><span class="p">,</span> <span class="s">&quot;SGE illegal egress QID&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SGE_INT_CAUSE1</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SGE_INT_CAUSE2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;SGE parity error (%#llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">v</span><span class="p">);</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SGE_INT_CAUSE1</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SGE_INT_CAUSE2</span><span class="p">,</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SGE_INT_CAUSE3</span><span class="p">,</span> <span class="n">sge_intr_info</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CIM interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cim_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">cim_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PREFDROPINT</span><span class="p">,</span> <span class="s">&quot;CIM control register prefetch drop&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">OBQPARERR</span><span class="p">,</span> <span class="s">&quot;CIM OBQ parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">IBQPARERR</span><span class="p">,</span> <span class="s">&quot;CIM IBQ parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MBUPPARERR</span><span class="p">,</span> <span class="s">&quot;CIM mailbox uP parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MBHOSTPARERR</span><span class="p">,</span> <span class="s">&quot;CIM mailbox host parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TIEQINPARERRINT</span><span class="p">,</span> <span class="s">&quot;CIM TIEQ outgoing parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TIEQOUTPARERRINT</span><span class="p">,</span> <span class="s">&quot;CIM TIEQ incoming parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">cim_upintr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">RSVDSPACEINT</span><span class="p">,</span> <span class="s">&quot;CIM reserved space access&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ILLTRANSINT</span><span class="p">,</span> <span class="s">&quot;CIM illegal transaction&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ILLWRINT</span><span class="p">,</span> <span class="s">&quot;CIM illegal write&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ILLRDINT</span><span class="p">,</span> <span class="s">&quot;CIM illegal read&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ILLRDBEINT</span><span class="p">,</span> <span class="s">&quot;CIM illegal read BE&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ILLWRBEINT</span><span class="p">,</span> <span class="s">&quot;CIM illegal write BE&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLRDBOOTINT</span><span class="p">,</span> <span class="s">&quot;CIM single read from boot space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLWRBOOTINT</span><span class="p">,</span> <span class="s">&quot;CIM single write to boot space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKWRBOOTINT</span><span class="p">,</span> <span class="s">&quot;CIM block write to boot space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLRDFLASHINT</span><span class="p">,</span> <span class="s">&quot;CIM single read from flash space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLWRFLASHINT</span><span class="p">,</span> <span class="s">&quot;CIM single write to flash space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKWRFLASHINT</span><span class="p">,</span> <span class="s">&quot;CIM block write to flash space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLRDEEPROMINT</span><span class="p">,</span> <span class="s">&quot;CIM single EEPROM read&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLWREEPROMINT</span><span class="p">,</span> <span class="s">&quot;CIM single EEPROM write&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKRDEEPROMINT</span><span class="p">,</span> <span class="s">&quot;CIM block EEPROM read&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKWREEPROMINT</span><span class="p">,</span> <span class="s">&quot;CIM block EEPROM write&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLRDCTLINT</span> <span class="p">,</span> <span class="s">&quot;CIM single read from CTL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLWRCTLINT</span> <span class="p">,</span> <span class="s">&quot;CIM single write to CTL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKRDCTLINT</span> <span class="p">,</span> <span class="s">&quot;CIM block read from CTL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKWRCTLINT</span> <span class="p">,</span> <span class="s">&quot;CIM block write to CTL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLRDPLINT</span> <span class="p">,</span> <span class="s">&quot;CIM single read from PL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGLWRPLINT</span> <span class="p">,</span> <span class="s">&quot;CIM single write to PL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKRDPLINT</span> <span class="p">,</span> <span class="s">&quot;CIM block read from PL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BLKWRPLINT</span> <span class="p">,</span> <span class="s">&quot;CIM block write to PL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">REQOVRLOOKUPINT</span> <span class="p">,</span> <span class="s">&quot;CIM request FIFO overwrite&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RSPOVRLOOKUPINT</span> <span class="p">,</span> <span class="s">&quot;CIM response FIFO overwrite&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TIMEOUTINT</span> <span class="p">,</span> <span class="s">&quot;CIM PIF timeout&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TIMEOUTMAINT</span> <span class="p">,</span> <span class="s">&quot;CIM PIF MA timeout&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">fat</span><span class="p">;</span>

	<span class="n">fat</span> <span class="o">=</span> <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CIM_HOST_INT_CAUSE</span><span class="p">,</span>
				    <span class="n">cim_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CIM_HOST_UPACC_INT_CAUSE</span><span class="p">,</span>
				    <span class="n">cim_upintr_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fat</span><span class="p">)</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ULP RX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ulprx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">ulprx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1800000</span><span class="p">,</span> <span class="s">&quot;ULPRX context error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7fffff</span><span class="p">,</span> <span class="s">&quot;ULPRX parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ULP_RX_INT_CAUSE</span><span class="p">,</span> <span class="n">ulprx_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ULP TX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ulptx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">ulptx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PBL_BOUND_ERR_CH3</span><span class="p">,</span> <span class="s">&quot;ULPTX channel 3 PBL out of bounds&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PBL_BOUND_ERR_CH2</span><span class="p">,</span> <span class="s">&quot;ULPTX channel 2 PBL out of bounds&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PBL_BOUND_ERR_CH1</span><span class="p">,</span> <span class="s">&quot;ULPTX channel 1 PBL out of bounds&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PBL_BOUND_ERR_CH0</span><span class="p">,</span> <span class="s">&quot;ULPTX channel 0 PBL out of bounds&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		  <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xfffffff</span><span class="p">,</span> <span class="s">&quot;ULPTX parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ULP_TX_INT_CAUSE</span><span class="p">,</span> <span class="n">ulptx_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PM TX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmtx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pmtx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PCMD_LEN_OVFL0</span><span class="p">,</span> <span class="s">&quot;PMTX channel 0 pcmd too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PCMD_LEN_OVFL1</span><span class="p">,</span> <span class="s">&quot;PMTX channel 1 pcmd too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PCMD_LEN_OVFL2</span><span class="p">,</span> <span class="s">&quot;PMTX channel 2 pcmd too large&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZERO_C_CMD_ERROR</span><span class="p">,</span> <span class="s">&quot;PMTX 0-length pcmd&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PMTX_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;PMTX framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">OESPI_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMTX oespi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DB_OPTIONS_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMTX db_options parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICSPI_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMTX icspi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">C_PCMD_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMTX c_pcmd parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PM_TX_INT_CAUSE</span><span class="p">,</span> <span class="n">pmtx_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PM RX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmrx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pmrx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ZERO_E_CMD_ERROR</span><span class="p">,</span> <span class="s">&quot;PMRX 0-length pcmd&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PMRX_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;PMRX framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">OCSPI_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMRX ocspi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DB_OPTIONS_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMRX db_options parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">IESPI_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMRX iespi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">E_PCMD_PAR_ERROR</span><span class="p">,</span> <span class="s">&quot;PMRX e_pcmd parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PM_RX_INT_CAUSE</span><span class="p">,</span> <span class="n">pmrx_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL switch interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cplsw_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">cplsw_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">CIM_OP_MAP_PERR</span><span class="p">,</span> <span class="s">&quot;CPLSW CIM op_map parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CIM_OVFL_ERROR</span><span class="p">,</span> <span class="s">&quot;CPLSW CIM overflow&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TP_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;CPLSW TP framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SGE_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;CPLSW SGE framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CIM_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;CPLSW CIM framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZERO_SWITCH_ERROR</span><span class="p">,</span> <span class="s">&quot;CPLSW no-switch error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CPL_INTR_CAUSE</span><span class="p">,</span> <span class="n">cplsw_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LE interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">le_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">le_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">LIPMISS</span><span class="p">,</span> <span class="s">&quot;LE LIP miss&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">LIP0</span><span class="p">,</span> <span class="s">&quot;LE 0 LIP error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PARITYERR</span><span class="p">,</span> <span class="s">&quot;LE parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">UNKNOWNCMD</span><span class="p">,</span> <span class="s">&quot;LE unknown command&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">REQQPARERR</span><span class="p">,</span> <span class="s">&quot;LE request queue parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">LE_DB_INT_CAUSE</span><span class="p">,</span> <span class="n">le_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPS interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mps_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_rx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="s">&quot;MPS Rx parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_tx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">TPFIFO</span><span class="p">,</span> <span class="s">&quot;MPS Tx TP FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NCSIFIFO</span><span class="p">,</span> <span class="s">&quot;MPS Tx NC-SI FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TXDATAFIFO</span><span class="p">,</span> <span class="s">&quot;MPS Tx data FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TXDESCFIFO</span><span class="p">,</span> <span class="s">&quot;MPS Tx desc FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BUBBLE</span><span class="p">,</span> <span class="s">&quot;MPS Tx underflow&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SECNTERR</span><span class="p">,</span> <span class="s">&quot;MPS Tx SOP/EOP error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">FRMERR</span><span class="p">,</span> <span class="s">&quot;MPS Tx framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_trc_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">FILTMEM</span><span class="p">,</span> <span class="s">&quot;MPS TRC filter parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PKTFIFO</span><span class="p">,</span> <span class="s">&quot;MPS TRC packet FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MISCPERR</span><span class="p">,</span> <span class="s">&quot;MPS TRC misc parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_stat_sram_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1fffff</span><span class="p">,</span> <span class="s">&quot;MPS statistics SRAM parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_stat_tx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0xfffff</span><span class="p">,</span> <span class="s">&quot;MPS statistics Tx FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_stat_rx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="s">&quot;MPS statistics Rx FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_cls_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MATCHSRAM</span><span class="p">,</span> <span class="s">&quot;MPS match SRAM parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MATCHTCAM</span><span class="p">,</span> <span class="s">&quot;MPS match TCAM parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HASHSRAM</span><span class="p">,</span> <span class="s">&quot;MPS hash SRAM parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">fat</span><span class="p">;</span>

	<span class="n">fat</span> <span class="o">=</span> <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_RX_PERR_INT_CAUSE</span><span class="p">,</span>
				    <span class="n">mps_rx_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_TX_INT_CAUSE</span><span class="p">,</span>
				    <span class="n">mps_tx_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_TRC_INT_CAUSE</span><span class="p">,</span>
				    <span class="n">mps_trc_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_STAT_PERR_INT_CAUSE_SRAM</span><span class="p">,</span>
				    <span class="n">mps_stat_sram_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_STAT_PERR_INT_CAUSE_TX_FIFO</span><span class="p">,</span>
				    <span class="n">mps_stat_tx_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_STAT_PERR_INT_CAUSE_RX_FIFO</span><span class="p">,</span>
				    <span class="n">mps_stat_rx_intr_info</span><span class="p">)</span> <span class="o">+</span>
	      <span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_CLS_INT_CAUSE</span><span class="p">,</span>
				    <span class="n">mps_cls_intr_info</span><span class="p">);</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_INT_CAUSE</span><span class="p">,</span> <span class="n">CLSINT</span> <span class="o">|</span> <span class="n">TRCINT</span> <span class="o">|</span>
		     <span class="n">RXINT</span> <span class="o">|</span> <span class="n">TXINT</span> <span class="o">|</span> <span class="n">STATINT</span><span class="p">);</span>
	<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MPS_INT_CAUSE</span><span class="p">);</span>                    <span class="cm">/* flush */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fat</span><span class="p">)</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MEM_INT_MASK (PERR_INT_CAUSE | ECC_CE_INT_CAUSE | ECC_UE_INT_CAUSE)</span>

<span class="cm">/*</span>
<span class="cm"> * EDC/MC interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mem_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;EDC0&quot;</span><span class="p">,</span> <span class="s">&quot;EDC1&quot;</span><span class="p">,</span> <span class="s">&quot;MC&quot;</span> <span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">cnt_addr</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">MEM_EDC1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">EDC_REG</span><span class="p">(</span><span class="n">EDC_INT_CAUSE</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">cnt_addr</span> <span class="o">=</span> <span class="n">EDC_REG</span><span class="p">(</span><span class="n">EDC_ECC_STATUS</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">MC_INT_CAUSE</span><span class="p">;</span>
		<span class="n">cnt_addr</span> <span class="o">=</span> <span class="n">MC_ECC_STATUS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MEM_INT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">PERR_INT_CAUSE</span><span class="p">)</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;%s FIFO parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">name</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ECC_CE_INT_CAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">ECC_CECNT_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cnt_addr</span><span class="p">));</span>

		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cnt_addr</span><span class="p">,</span> <span class="n">ECC_CECNT_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
				 <span class="s">&quot;%u %s correctable ECC data error%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cnt</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ECC_UE_INT_CAUSE</span><span class="p">)</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			  <span class="s">&quot;%s uncorrectable ECC data error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PERR_INT_CAUSE</span> <span class="o">|</span> <span class="n">ECC_UE_INT_CAUSE</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MA interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ma_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MA_INT_CAUSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MEM_PERR_INT_CAUSE</span><span class="p">)</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			  <span class="s">&quot;MA parity error, parity status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MA_PARITY_ERROR_STATUS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MEM_WRAP_INT_CAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MA_INT_WRAP_STATUS</span><span class="p">);</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;MA address wrap-around error by &quot;</span>
			  <span class="s">&quot;client %u to address %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">MEM_WRAP_CLIENT_NUM_GET</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
			  <span class="n">MEM_WRAP_ADDRESS_GET</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MA_INT_CAUSE</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SMB interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smb_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">smb_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MSTTXFIFOPARINT</span><span class="p">,</span> <span class="s">&quot;SMB master Tx FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MSTRXFIFOPARINT</span><span class="p">,</span> <span class="s">&quot;SMB master Rx FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SLVFIFOPARINT</span><span class="p">,</span> <span class="s">&quot;SMB slave FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">SMB_INT_CAUSE</span><span class="p">,</span> <span class="n">smb_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NC-SI interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ncsi_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">ncsi_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">CIM_DM_PRTY_ERR</span><span class="p">,</span> <span class="s">&quot;NC-SI CIM parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MPS_DM_PRTY_ERR</span><span class="p">,</span> <span class="s">&quot;NC-SI MPS parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TXFIFO_PRTY_ERR</span><span class="p">,</span> <span class="s">&quot;NC-SI Tx FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RXFIFO_PRTY_ERR</span><span class="p">,</span> <span class="s">&quot;NC-SI Rx FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">NCSI_INT_CAUSE</span><span class="p">,</span> <span class="n">ncsi_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XGMAC interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xgmac_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PORT_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">XGMAC_PORT_INT_CAUSE</span><span class="p">));</span>

	<span class="n">v</span> <span class="o">&amp;=</span> <span class="n">TXFIFO_PRTY_ERR</span> <span class="o">|</span> <span class="n">RXFIFO_PRTY_ERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">TXFIFO_PRTY_ERR</span><span class="p">)</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;XGMAC %d Tx FIFO parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">RXFIFO_PRTY_ERR</span><span class="p">)</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;XGMAC %d Rx FIFO parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">port</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PORT_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">XGMAC_PORT_INT_CAUSE</span><span class="p">),</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PL interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pl_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">FATALPERR</span><span class="p">,</span> <span class="s">&quot;T4 fatal parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PERRVFID</span><span class="p">,</span> <span class="s">&quot;PL VFID_MAP parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_handle_intr_status</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PL_PL_INT_CAUSE</span><span class="p">,</span> <span class="n">pl_intr_info</span><span class="p">))</span>
		<span class="n">t4_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PF_INTR_MASK (PFSW)</span>
<span class="cp">#define GLBL_INTR_MASK (CIM | MPS | PL | PCIE | MC | EDC0 | \</span>
<span class="cp">		EDC1 | LE | TP | MA | PM_TX | PM_RX | ULP_RX | \</span>
<span class="cp">		CPL_SWITCH | SGE | ULP_TX)</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_slow_intr_handler - control path interrupt handler</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *	T4 interrupt handler for non-data global interrupt events, e.g., errors.</span>
<span class="cm"> *	The designation &#39;slow&#39; is because it involves register reads, while</span>
<span class="cm"> *	data interrupts typically don&#39;t involve any MMIOs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_slow_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_INT_CAUSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">GLBL_INTR_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">CIM</span><span class="p">)</span>
		<span class="n">cim_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">MPS</span><span class="p">)</span>
		<span class="n">mps_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">NCSI</span><span class="p">)</span>
		<span class="n">ncsi_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">PL</span><span class="p">)</span>
		<span class="n">pl_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">SMB</span><span class="p">)</span>
		<span class="n">smb_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">XGMAC0</span><span class="p">)</span>
		<span class="n">xgmac_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">XGMAC1</span><span class="p">)</span>
		<span class="n">xgmac_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">XGMAC_KR0</span><span class="p">)</span>
		<span class="n">xgmac_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">XGMAC_KR1</span><span class="p">)</span>
		<span class="n">xgmac_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">PCIE</span><span class="p">)</span>
		<span class="n">pcie_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">MC</span><span class="p">)</span>
		<span class="n">mem_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MEM_MC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">EDC0</span><span class="p">)</span>
		<span class="n">mem_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MEM_EDC0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">EDC1</span><span class="p">)</span>
		<span class="n">mem_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MEM_EDC1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">LE</span><span class="p">)</span>
		<span class="n">le_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">TP</span><span class="p">)</span>
		<span class="n">tp_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">MA</span><span class="p">)</span>
		<span class="n">ma_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">PM_TX</span><span class="p">)</span>
		<span class="n">pmtx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">PM_RX</span><span class="p">)</span>
		<span class="n">pmrx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">ULP_RX</span><span class="p">)</span>
		<span class="n">ulprx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">CPL_SWITCH</span><span class="p">)</span>
		<span class="n">cplsw_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">SGE</span><span class="p">)</span>
		<span class="n">sge_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">ULP_TX</span><span class="p">)</span>
		<span class="n">ulptx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Clear the interrupts just processed for which we are the master. */</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_INT_CAUSE</span><span class="p">,</span> <span class="n">cause</span> <span class="o">&amp;</span> <span class="n">GLBL_INTR_MASK</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_INT_CAUSE</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_intr_enable - enable interrupts</span>
<span class="cm"> *	@adapter: the adapter whose interrupts should be enabled</span>
<span class="cm"> *</span>
<span class="cm"> *	Enable PF-specific interrupts for the calling function and the top-level</span>
<span class="cm"> *	interrupt concentrator for global interrupts.  Interrupts are already</span>
<span class="cm"> *	enabled at each module,	here we just enable the roots of the interrupt</span>
<span class="cm"> *	hierarchies.</span>
<span class="cm"> *</span>
<span class="cm"> *	Note: this function should be called only when the driver manages</span>
<span class="cm"> *	non PF-specific interrupts from the various HW modules.  Only one PCI</span>
<span class="cm"> *	function at a time should be doing this.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pf</span> <span class="o">=</span> <span class="n">SOURCEPF_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_WHOAMI</span><span class="p">));</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SGE_INT_ENABLE3</span><span class="p">,</span> <span class="n">ERR_CPL_EXCEED_IQE_SIZE</span> <span class="o">|</span>
		     <span class="n">ERR_INVALID_CIDX_INC</span> <span class="o">|</span> <span class="n">ERR_CPL_OPCODE_0</span> <span class="o">|</span>
		     <span class="n">ERR_DROPPED_DB</span> <span class="o">|</span> <span class="n">ERR_DATA_CPL_ON_HIGH_QID1</span> <span class="o">|</span>
		     <span class="n">ERR_DATA_CPL_ON_HIGH_QID0</span> <span class="o">|</span> <span class="n">ERR_BAD_DB_PIDX3</span> <span class="o">|</span>
		     <span class="n">ERR_BAD_DB_PIDX2</span> <span class="o">|</span> <span class="n">ERR_BAD_DB_PIDX1</span> <span class="o">|</span>
		     <span class="n">ERR_BAD_DB_PIDX0</span> <span class="o">|</span> <span class="n">ERR_ING_CTXT_PRIO</span> <span class="o">|</span>
		     <span class="n">ERR_EGR_CTXT_PRIO</span> <span class="o">|</span> <span class="n">INGRESS_SIZE_ERR</span> <span class="o">|</span>
		     <span class="n">F_DBFIFO_HP_INT</span> <span class="o">|</span> <span class="n">F_DBFIFO_LP_INT</span> <span class="o">|</span>
		     <span class="n">EGRESS_SIZE_ERR</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">PL_PF_INT_ENABLE</span><span class="p">),</span> <span class="n">PF_INTR_MASK</span><span class="p">);</span>
	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_INT_MAP0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_intr_disable - disable interrupts</span>
<span class="cm"> *	@adapter: the adapter whose interrupts should be disabled</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable interrupts.  We only disable the top-level interrupt</span>
<span class="cm"> *	concentrators.  The caller must be a PCI function managing global</span>
<span class="cm"> *	interrupts.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pf</span> <span class="o">=</span> <span class="n">SOURCEPF_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_WHOAMI</span><span class="p">));</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">PL_PF_INT_ENABLE</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_INT_MAP0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hash_mac_addr - return the hash value of a MAC address</span>
<span class="cm"> *	@addr: the 48-bit Ethernet MAC address</span>
<span class="cm"> *</span>
<span class="cm"> *	Hashes a MAC address according to the hash function used by HW inexact</span>
<span class="cm"> *	(hash) address matching.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hash_mac_addr</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">a</span> <span class="o">^=</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">a</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_config_rss_range - configure a portion of the RSS mapping table</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@mbox: mbox to use for the FW command</span>
<span class="cm"> *	@viid: virtual interface whose RSS subtable is to be written</span>
<span class="cm"> *	@start: start entry in the table to write</span>
<span class="cm"> *	@n: how many table entries to write</span>
<span class="cm"> *	@rspq: values for the response queue lookup table</span>
<span class="cm"> *	@nrspq: number of values in @rspq</span>
<span class="cm"> *</span>
<span class="cm"> *	Programs the selected part of the VI&#39;s RSS mapping table with the</span>
<span class="cm"> *	provided values.  If @nrspq &lt; @n the supplied values are used repeatedly</span>
<span class="cm"> *	until the full table range is populated.</span>
<span class="cm"> *</span>
<span class="cm"> *	The caller must ensure the values in @rspq are in the range allowed for</span>
<span class="cm"> *	@viid.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_config_rss_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viid</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rspq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nrspq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">rspq</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rsp_end</span> <span class="o">=</span> <span class="n">rspq</span> <span class="o">+</span> <span class="n">nrspq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_rss_ind_tbl_cmd</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_RSS_IND_TBL_CMD</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span> <span class="n">FW_CMD_WRITE</span> <span class="o">|</span>
			       <span class="n">FW_RSS_IND_TBL_CMD_VIID</span><span class="p">(</span><span class="n">viid</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* each fw_rss_ind_tbl_cmd takes up to 32 entries */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nq</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">__be32</span> <span class="o">*</span><span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">iq0_to_iq2</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">niqid</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">nq</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">startidx</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>

		<span class="n">start</span> <span class="o">+=</span> <span class="n">nq</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">nq</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">nq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">;</span>

			<span class="n">v</span> <span class="o">=</span> <span class="n">FW_RSS_IND_TBL_CMD_IQ0</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rsp</span> <span class="o">&gt;=</span> <span class="n">rsp_end</span><span class="p">)</span>
				<span class="n">rsp</span> <span class="o">=</span> <span class="n">rspq</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">FW_RSS_IND_TBL_CMD_IQ1</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rsp</span> <span class="o">&gt;=</span> <span class="n">rsp_end</span><span class="p">)</span>
				<span class="n">rsp</span> <span class="o">=</span> <span class="n">rspq</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">FW_RSS_IND_TBL_CMD_IQ2</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rsp</span> <span class="o">&gt;=</span> <span class="n">rsp_end</span><span class="p">)</span>
				<span class="n">rsp</span> <span class="o">=</span> <span class="n">rspq</span><span class="p">;</span>

			<span class="o">*</span><span class="n">qp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">nq</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_config_glbl_rss - configure the global RSS mode</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@mbox: mbox to use for the FW command</span>
<span class="cm"> *	@mode: global RSS mode</span>
<span class="cm"> *	@flags: mode-specific flags</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets the global RSS mode.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_config_glbl_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_rss_glb_config_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_write</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_RSS_GLB_CONFIG_CMD</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span> <span class="n">FW_CMD_WRITE</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FW_RSS_GLB_CONFIG_CMD_MODE_MANUAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">manual</span><span class="p">.</span><span class="n">mode_pkd</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_RSS_GLB_CONFIG_CMD_MODE</span><span class="p">(</span><span class="n">mode</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FW_RSS_GLB_CONFIG_CMD_MODE_BASICVIRTUAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">basicvirtual</span><span class="p">.</span><span class="n">mode_pkd</span> <span class="o">=</span>
			<span class="n">htonl</span><span class="p">(</span><span class="n">FW_RSS_GLB_CONFIG_CMD_MODE</span><span class="p">(</span><span class="n">mode</span><span class="p">));</span>
		<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">basicvirtual</span><span class="p">.</span><span class="n">synmapen_to_hashtoeplitz</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_tp_get_tcp_stats - read TP&#39;s TCP MIB counters</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@v4: holds the TCP/IP counter values</span>
<span class="cm"> *	@v6: holds the TCP/IPv6 counter values</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the values of TP&#39;s TCP/IP and TCP/IPv6 MIB counters.</span>
<span class="cm"> *	Either @v4 or @v6 may be %NULL to skip the corresponding stats.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_tp_get_tcp_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tp_tcp_stats</span> <span class="o">*</span><span class="n">v4</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">tp_tcp_stats</span> <span class="o">*</span><span class="n">v6</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">[</span><span class="n">TP_MIB_TCP_RXT_SEG_LO</span> <span class="o">-</span> <span class="n">TP_MIB_TCP_OUT_RST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

<span class="cp">#define STAT_IDX(x) ((TP_MIB_TCP_##x) - TP_MIB_TCP_OUT_RST)</span>
<span class="cp">#define STAT(x)     val[STAT_IDX(x)]</span>
<span class="cp">#define STAT64(x)   (((u64)STAT(x##_HI) &lt;&lt; 32) | STAT(x##_LO))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t4_read_indirect</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_MIB_INDEX</span><span class="p">,</span> <span class="n">TP_MIB_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
				 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">TP_MIB_TCP_OUT_RST</span><span class="p">);</span>
		<span class="n">v4</span><span class="o">-&gt;</span><span class="n">tcpOutRsts</span> <span class="o">=</span> <span class="n">STAT</span><span class="p">(</span><span class="n">OUT_RST</span><span class="p">);</span>
		<span class="n">v4</span><span class="o">-&gt;</span><span class="n">tcpInSegs</span>  <span class="o">=</span> <span class="n">STAT64</span><span class="p">(</span><span class="n">IN_SEG</span><span class="p">);</span>
		<span class="n">v4</span><span class="o">-&gt;</span><span class="n">tcpOutSegs</span> <span class="o">=</span> <span class="n">STAT64</span><span class="p">(</span><span class="n">OUT_SEG</span><span class="p">);</span>
		<span class="n">v4</span><span class="o">-&gt;</span><span class="n">tcpRetransSegs</span> <span class="o">=</span> <span class="n">STAT64</span><span class="p">(</span><span class="n">RXT_SEG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t4_read_indirect</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_MIB_INDEX</span><span class="p">,</span> <span class="n">TP_MIB_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
				 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">TP_MIB_TCP_V6OUT_RST</span><span class="p">);</span>
		<span class="n">v6</span><span class="o">-&gt;</span><span class="n">tcpOutRsts</span> <span class="o">=</span> <span class="n">STAT</span><span class="p">(</span><span class="n">OUT_RST</span><span class="p">);</span>
		<span class="n">v6</span><span class="o">-&gt;</span><span class="n">tcpInSegs</span>  <span class="o">=</span> <span class="n">STAT64</span><span class="p">(</span><span class="n">IN_SEG</span><span class="p">);</span>
		<span class="n">v6</span><span class="o">-&gt;</span><span class="n">tcpOutSegs</span> <span class="o">=</span> <span class="n">STAT64</span><span class="p">(</span><span class="n">OUT_SEG</span><span class="p">);</span>
		<span class="n">v6</span><span class="o">-&gt;</span><span class="n">tcpRetransSegs</span> <span class="o">=</span> <span class="n">STAT64</span><span class="p">(</span><span class="n">RXT_SEG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef STAT64</span>
<span class="cp">#undef STAT</span>
<span class="cp">#undef STAT_IDX</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_read_mtu_tbl - returns the values in the HW path MTU table</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mtus: where to store the MTU values</span>
<span class="cm"> *	@mtu_log: where to store the MTU base-2 log (may be %NULL)</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads the HW path MTU table.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_read_mtu_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">mtus</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mtu_log</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NMTUS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_MTU_TABLE</span><span class="p">,</span>
			     <span class="n">MTUINDEX</span><span class="p">(</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">MTUVALUE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_MTU_TABLE</span><span class="p">);</span>
		<span class="n">mtus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MTUVALUE_GET</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtu_log</span><span class="p">)</span>
			<span class="n">mtu_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MTUWIDTH_GET</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	init_cong_ctrl - initialize congestion control parameters</span>
<span class="cm"> *	@a: the alpha values for congestion control</span>
<span class="cm"> *	@b: the beta values for congestion control</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize the congestion control parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">init_cong_ctrl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mi">45</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The minimum additive increment value for the congestion control table */</span>
<span class="cp">#define CC_MIN_INCR 2U</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_load_mtus - write the MTU and congestion control HW tables</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mtus: the values for the MTU table</span>
<span class="cm"> *	@alpha: the values for the congestion control alpha parameter</span>
<span class="cm"> *	@beta: the values for the congestion control beta parameter</span>
<span class="cm"> *</span>
<span class="cm"> *	Write the HW MTU table with the supplied MTUs and the high-speed</span>
<span class="cm"> *	congestion control table with the supplied alpha, beta, and MTUs.</span>
<span class="cm"> *	We write the two tables together because the additive increments</span>
<span class="cm"> *	depend on the MTUs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_load_mtus</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">mtus</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">beta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">avg_pkts</span><span class="p">[</span><span class="n">NCCTRL_WIN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">448</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span>
		<span class="mi">896</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1792</span><span class="p">,</span> <span class="mi">2560</span><span class="p">,</span> <span class="mi">3584</span><span class="p">,</span> <span class="mi">5120</span><span class="p">,</span> <span class="mi">7168</span><span class="p">,</span> <span class="mi">10240</span><span class="p">,</span> <span class="mi">14336</span><span class="p">,</span> <span class="mi">20480</span><span class="p">,</span>
		<span class="mi">28672</span><span class="p">,</span> <span class="mi">40960</span><span class="p">,</span> <span class="mi">57344</span><span class="p">,</span> <span class="mi">81920</span><span class="p">,</span> <span class="mi">114688</span><span class="p">,</span> <span class="mi">163840</span><span class="p">,</span> <span class="mi">229376</span>
	<span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NMTUS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">mtus</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">log2</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">mtu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mtu</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)))</span>     <span class="cm">/* round */</span>
			<span class="n">log2</span><span class="o">--</span><span class="p">;</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_MTU_TABLE</span><span class="p">,</span> <span class="n">MTUINDEX</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">MTUWIDTH</span><span class="p">(</span><span class="n">log2</span><span class="p">)</span> <span class="o">|</span> <span class="n">MTUVALUE</span><span class="p">(</span><span class="n">mtu</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">NCCTRL_WIN</span><span class="p">;</span> <span class="o">++</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">;</span>

			<span class="n">inc</span> <span class="o">=</span> <span class="n">max</span><span class="p">(((</span><span class="n">mtu</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">/</span> <span class="n">avg_pkts</span><span class="p">[</span><span class="n">w</span><span class="p">],</span>
				  <span class="n">CC_MIN_INCR</span><span class="p">);</span>

			<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_CCTRL_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">inc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	get_mps_bg_map - return the buffer groups associated with a port</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@idx: the port index</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a bitmap indicating which MPS buffer groups are associated</span>
<span class="cm"> *	with the given port.  Bit i is set if buffer group i is used by the</span>
<span class="cm"> *	port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_mps_bg_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">n</span> <span class="o">=</span> <span class="n">NUMPORTS_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MPS_CMN_CTL</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mh">0xf</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_get_port_stats - collect port statistics</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@idx: the port index</span>
<span class="cm"> *	@p: the stats structure to fill</span>
<span class="cm"> *</span>
<span class="cm"> *	Collect statistics related to the given port from HW.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_get_port_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">port_stats</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bgmap</span> <span class="o">=</span> <span class="n">get_mps_bg_map</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

<span class="cp">#define GET_STAT(name) \</span>
<span class="cp">	t4_read_reg64(adap, PORT_REG(idx, MPS_PORT_STAT_##name##_L))</span>
<span class="cp">#define GET_STAT_COM(name) t4_read_reg64(adap, MPS_STAT_##name##_L)</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_octets</span>           <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_BYTES</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames</span>           <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_FRAMES</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_bcast_frames</span>     <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_BCAST</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_mcast_frames</span>     <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_MCAST</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ucast_frames</span>     <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_UCAST</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_error_frames</span>     <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_ERROR</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames_64</span>        <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_64B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames_65_127</span>    <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_65B_127B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames_128_255</span>   <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_128B_255B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames_256_511</span>   <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_256B_511B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames_512_1023</span>  <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_512B_1023B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames_1024_1518</span> <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_1024B_1518B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_frames_1519_max</span>  <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_1519B_MAX</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_drop</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_DROP</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_pause</span>            <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PAUSE</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp0</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP0</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp1</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP1</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp2</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP2</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp3</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP3</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp4</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP4</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp5</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP5</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp6</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP6</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_ppp7</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">TX_PORT_PPP7</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_octets</span>           <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_BYTES</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames</span>           <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_FRAMES</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_bcast_frames</span>     <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_BCAST</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_mcast_frames</span>     <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_MCAST</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ucast_frames</span>     <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_UCAST</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_too_long</span>         <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_MTU_ERROR</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_jabber</span>           <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_MTU_CRC_ERROR</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_fcs_err</span>          <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_CRC_ERROR</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_len_err</span>          <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_LEN_ERROR</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_symbol_err</span>       <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_SYM_ERROR</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_runt</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_LESS_64B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames_64</span>        <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_64B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames_65_127</span>    <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_65B_127B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames_128_255</span>   <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_128B_255B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames_256_511</span>   <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_256B_511B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames_512_1023</span>  <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_512B_1023B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames_1024_1518</span> <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_1024B_1518B</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_frames_1519_max</span>  <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_1519B_MAX</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_pause</span>            <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PAUSE</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp0</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP0</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp1</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP1</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp2</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP2</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp3</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP3</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp4</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP4</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp5</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP5</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp6</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP6</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ppp7</span>             <span class="o">=</span> <span class="n">GET_STAT</span><span class="p">(</span><span class="n">RX_PORT_PPP7</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ovflow0</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_0_MAC_DROP_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ovflow1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_1_MAC_DROP_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ovflow2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_2_MAC_DROP_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_ovflow3</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_3_MAC_DROP_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_trunc0</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_0_MAC_TRUNC_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_trunc1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_1_MAC_TRUNC_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_trunc2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_2_MAC_TRUNC_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_trunc3</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgmap</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">GET_STAT_COM</span><span class="p">(</span><span class="n">RX_BG_3_MAC_TRUNC_FRAME</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#undef GET_STAT</span>
<span class="cp">#undef GET_STAT_COM</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_wol_magic_enable - enable/disable magic packet WoL</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@port: the physical port index</span>
<span class="cm"> *	@addr: MAC address expected in magic packets, %NULL to disable</span>
<span class="cm"> *</span>
<span class="cm"> *	Enables/disables magic packet wake-on-LAN for the selected port.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t4_wol_magic_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PORT_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">XGMAC_PORT_MAGIC_MACID_LO</span><span class="p">),</span>
			     <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PORT_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">XGMAC_PORT_MAGIC_MACID_HI</span><span class="p">),</span>
			     <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PORT_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">XGMAC_PORT_CFG2</span><span class="p">),</span> <span class="n">MAGICEN</span><span class="p">,</span>
			 <span class="n">addr</span> <span class="o">?</span> <span class="n">MAGICEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_wol_pat_enable - enable/disable pattern-based WoL</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@port: the physical port index</span>
<span class="cm"> *	@map: bitmap of which HW pattern filters to set</span>
<span class="cm"> *	@mask0: byte mask for bytes 0-63 of a packet</span>
<span class="cm"> *	@mask1: byte mask for bytes 64-127 of a packet</span>
<span class="cm"> *	@crc: Ethernet CRC for selected bytes</span>
<span class="cm"> *	@enable: enable/disable switch</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets the pattern filters indicated in @map to mask out the bytes</span>
<span class="cm"> *	specified in @mask0/@mask1 in received packets and compare the CRC of</span>
<span class="cm"> *	the resulting packet against @crc.  If @enable is %true pattern-based</span>
<span class="cm"> *	WoL is enabled, otherwise disabled.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_wol_pat_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">map</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="n">mask0</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PORT_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">XGMAC_PORT_CFG2</span><span class="p">),</span>
				 <span class="n">PATEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#define EPIO_REG(name) PORT_REG(port, XGMAC_PORT_EPIO_##name)</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">DATA1</span><span class="p">),</span> <span class="n">mask0</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">DATA2</span><span class="p">),</span> <span class="n">mask1</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">DATA3</span><span class="p">),</span> <span class="n">mask1</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NWOL_PAT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">map</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">map</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* write byte masks */</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">DATA0</span><span class="p">),</span> <span class="n">mask0</span><span class="p">);</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">OP</span><span class="p">),</span> <span class="n">ADDRESS</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">EPIOWR</span><span class="p">);</span>
		<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">OP</span><span class="p">));</span>                <span class="cm">/* flush */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">OP</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUSY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

		<span class="cm">/* write CRC */</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">DATA0</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">OP</span><span class="p">),</span> <span class="n">ADDRESS</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">EPIOWR</span><span class="p">);</span>
		<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">OP</span><span class="p">));</span>                <span class="cm">/* flush */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">EPIO_REG</span><span class="p">(</span><span class="n">OP</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUSY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#undef EPIO_REG</span>

	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PORT_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">XGMAC_PORT_CFG2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PATEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define INIT_CMD(var, cmd, rd_wr) do { \</span>
<span class="cp">	(var).op_to_write = htonl(FW_CMD_OP(FW_##cmd##_CMD) | \</span>
<span class="cp">				  FW_CMD_REQUEST | FW_CMD_##rd_wr); \</span>
<span class="cp">	(var).retval_len16 = htonl(FW_LEN16(var)); \</span>
<span class="cp">} while (0)</span>

<span class="kt">int</span> <span class="nf">t4_fwaddrspace_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ldst_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_addrspace</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_FW_CMD_OP</span><span class="p">(</span><span class="n">FW_LDST_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">F_FW_CMD_WRITE</span> <span class="o">|</span>
			    <span class="n">V_FW_LDST_CMD_ADDRSPACE</span><span class="p">(</span><span class="n">FW_LDST_ADDRSPC_FIRMWARE</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">cycles_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">addrval</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">addrval</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *     t4_mem_win_read_len - read memory through PCIE memory window</span>
<span class="cm"> *     @adap: the adapter</span>
<span class="cm"> *     @addr: address of first byte requested aligned on 32b.</span>
<span class="cm"> *     @data: len bytes to hold the data read</span>
<span class="cm"> *     @len: amount of data to read from window.  Must be &lt;=</span>
<span class="cm"> *            MEMWIN0_APERATURE after adjusting for 16B alignment</span>
<span class="cm"> *            requirements of the the memory window.</span>
<span class="cm"> *</span>
<span class="cm"> *     Read len bytes of data from MC starting at @addr.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_mem_win_read_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Align on a 16B boundary.</span>
<span class="cm">	 */</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MEMWIN0_APERTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_MEM_ACCESS_OFFSET</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">);</span>
	<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_MEM_ACCESS_OFFSET</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="p">(</span><span class="n">MEMWIN0_BASE</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_mdio_rd - read a PHY register through MDIO</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@phy_addr: the PHY address</span>
<span class="cm"> *	@mmd: the PHY MMD to access (0 for clause 22 PHYs)</span>
<span class="cm"> *	@reg: the register to read</span>
<span class="cm"> *	@valp: where to store the value</span>
<span class="cm"> *</span>
<span class="cm"> *	Issues a FW command through the given mailbox to read a PHY register.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_mdio_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_ldst_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_addrspace</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_LDST_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
		<span class="n">FW_CMD_READ</span> <span class="o">|</span> <span class="n">FW_LDST_CMD_ADDRSPACE</span><span class="p">(</span><span class="n">FW_LDST_ADDRSPC_MDIO</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">cycles_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">paddr_mmd</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FW_LDST_CMD_PADDR</span><span class="p">(</span><span class="n">phy_addr</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">FW_LDST_CMD_MMD</span><span class="p">(</span><span class="n">mmd</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">raddr</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">rval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_mdio_wr - write a PHY register through MDIO</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@phy_addr: the PHY address</span>
<span class="cm"> *	@mmd: the PHY MMD to access (0 for clause 22 PHYs)</span>
<span class="cm"> *	@reg: the register to write</span>
<span class="cm"> *	@valp: value to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Issues a FW command through the given mailbox to write a PHY register.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_mdio_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ldst_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_addrspace</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_LDST_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
		<span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="n">FW_LDST_CMD_ADDRSPACE</span><span class="p">(</span><span class="n">FW_LDST_ADDRSPC_MDIO</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">cycles_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">paddr_mmd</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FW_LDST_CMD_PADDR</span><span class="p">(</span><span class="n">phy_addr</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">FW_LDST_CMD_MMD</span><span class="p">(</span><span class="n">mmd</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">raddr</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">rval</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_fw_hello - establish communication with FW</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@evt_mbox: mailbox to receive async FW events</span>
<span class="cm"> *	@master: specifies the caller&#39;s willingness to be the device master</span>
<span class="cm"> *	@state: returns the current device state</span>
<span class="cm"> *</span>
<span class="cm"> *	Issues a command to establish communication with FW.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_fw_hello</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">evt_mbox</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">dev_master</span> <span class="n">master</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_hello_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">INIT_CMD</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">HELLO</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">err_to_mbasyncnot</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span>
		<span class="n">FW_HELLO_CMD_MASTERDIS</span><span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="n">MASTER_CANT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_HELLO_CMD_MASTERFORCE</span><span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="n">MASTER_MUST</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_HELLO_CMD_MBMASTER</span><span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="n">MASTER_MUST</span> <span class="o">?</span> <span class="n">mbox</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FW_HELLO_CMD_MBASYNCNOT</span><span class="p">(</span><span class="n">evt_mbox</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">err_to_mbasyncnot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_HELLO_CMD_INIT</span><span class="p">)</span>
			<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_INIT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_HELLO_CMD_ERR</span><span class="p">)</span>
			<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_ERR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_UNINIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_fw_bye - end communication with FW</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *</span>
<span class="cm"> *	Issues a command to terminate communication with FW.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_fw_bye</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_bye_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">INIT_CMD</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">BYE</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_init_cmd - ask FW to initialize the device</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *</span>
<span class="cm"> *	Issues a command to FW to partially initialize the device.  This</span>
<span class="cm"> *	performs initialization that generally doesn&#39;t depend on user input.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_initialize_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">INIT_CMD</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">INITIALIZE</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_fw_reset - issue a reset to FW</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@reset: specifies the type of reset to perform</span>
<span class="cm"> *</span>
<span class="cm"> *	Issues a reset command of the specified type to FW.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_fw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_reset_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">INIT_CMD</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">reset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_query_params - query FW or device parameters</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@pf: the PF</span>
<span class="cm"> *	@vf: the VF</span>
<span class="cm"> *	@nparams: the number of parameters</span>
<span class="cm"> *	@params: the parameter names</span>
<span class="cm"> *	@val: the parameter values</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads the value of FW or device parameters.  Up to 7 parameters can be</span>
<span class="cm"> *	queried at once.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_query_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nparams</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		    <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_params_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mnem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nparams</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_PARAMS_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_READ</span> <span class="o">|</span> <span class="n">FW_PARAMS_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_PARAMS_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nparams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="o">++</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nparams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="o">*</span><span class="n">val</span><span class="o">++</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_set_params - sets FW or device parameters</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@pf: the PF</span>
<span class="cm"> *	@vf: the VF</span>
<span class="cm"> *	@nparams: the number of parameters</span>
<span class="cm"> *	@params: the parameter names</span>
<span class="cm"> *	@val: the parameter values</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets the value of FW or device parameters.  Up to 7 parameters can be</span>
<span class="cm"> *	specified at once.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nparams</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		  <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_params_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mnem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nparams</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_PARAMS_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="n">FW_PARAMS_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_PARAMS_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nparams</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="o">++</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_cfg_pfvf - configure PF/VF resource limits</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@pf: the PF being configured</span>
<span class="cm"> *	@vf: the VF being configured</span>
<span class="cm"> *	@txq: the max number of egress queues</span>
<span class="cm"> *	@txq_eth_ctrl: the max number of egress Ethernet or control queues</span>
<span class="cm"> *	@rxqi: the max number of interrupt-capable ingress queues</span>
<span class="cm"> *	@rxq: the max number of interruptless ingress queues</span>
<span class="cm"> *	@tc: the PCI traffic class</span>
<span class="cm"> *	@vi: the max number of virtual interfaces</span>
<span class="cm"> *	@cmask: the channel access rights mask for the PF/VF</span>
<span class="cm"> *	@pmask: the port access rights mask for the PF/VF</span>
<span class="cm"> *	@nexact: the maximum number of exact MPS filters</span>
<span class="cm"> *	@rcaps: read capabilities</span>
<span class="cm"> *	@wxcaps: write/execute capabilities</span>
<span class="cm"> *</span>
<span class="cm"> *	Configures resource limits and capabilities for a physical or virtual</span>
<span class="cm"> *	function.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_cfg_pfvf</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txq_eth_ctrl</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxqi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tc</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pmask</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nexact</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rcaps</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wxcaps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_pfvf_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_PFVF_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="n">FW_PFVF_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_PFVF_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">niqflint_niq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_PFVF_CMD_NIQFLINT</span><span class="p">(</span><span class="n">rxqi</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">FW_PFVF_CMD_NIQ</span><span class="p">(</span><span class="n">rxq</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">type_to_neq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_PFVF_CMD_CMASK</span><span class="p">(</span><span class="n">cmask</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">FW_PFVF_CMD_PMASK</span><span class="p">(</span><span class="n">pmask</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">FW_PFVF_CMD_NEQ</span><span class="p">(</span><span class="n">txq</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">tc_to_nexactf</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_PFVF_CMD_TC</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_PFVF_CMD_NVI</span><span class="p">(</span><span class="n">vi</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">FW_PFVF_CMD_NEXACTF</span><span class="p">(</span><span class="n">nexact</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">r_caps_to_nethctrl</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_PFVF_CMD_R_CAPS</span><span class="p">(</span><span class="n">rcaps</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">FW_PFVF_CMD_WX_CAPS</span><span class="p">(</span><span class="n">wxcaps</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">FW_PFVF_CMD_NETHCTRL</span><span class="p">(</span><span class="n">txq_eth_ctrl</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_alloc_vi - allocate a virtual interface</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@port: physical port associated with the VI</span>
<span class="cm"> *	@pf: the PF owning the VI</span>
<span class="cm"> *	@vf: the VF owning the VI</span>
<span class="cm"> *	@nmac: number of MAC addresses needed (1 to 5)</span>
<span class="cm"> *	@mac: the MAC addresses of the VI</span>
<span class="cm"> *	@rss_size: size of RSS table slice associated with this VI</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocates a virtual interface for the given physical port.  If @mac is</span>
<span class="cm"> *	not %NULL it contains the MAC addresses of the VI as assigned by FW.</span>
<span class="cm"> *	@mac should be large enough to hold @nmac Ethernet addresses, they are</span>
<span class="cm"> *	stored consecutively so the space needed is @nmac * 6 bytes.</span>
<span class="cm"> *	Returns a negative error number or the non-negative VI id.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_alloc_vi</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nmac</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rss_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_vi_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_VI_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="n">FW_CMD_EXEC</span> <span class="o">|</span>
			    <span class="n">FW_VI_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_VI_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">alloc_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_VI_CMD_ALLOC</span> <span class="o">|</span> <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">portid_pkd</span> <span class="o">=</span> <span class="n">FW_VI_CMD_PORTID</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">nmac</span> <span class="o">=</span> <span class="n">nmac</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">mac</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nmac</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">nmac3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">nmac3</span><span class="p">));</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span> <span class="o">+</span> <span class="mi">18</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">nmac2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">nmac2</span><span class="p">));</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">nmac1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">nmac1</span><span class="p">));</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">c</span><span class="p">.</span><span class="n">nmac0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">nmac0</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rss_size</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rss_size</span> <span class="o">=</span> <span class="n">FW_VI_CMD_RSSSIZE_GET</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rsssize_pkd</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">FW_VI_CMD_VIID_GET</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">type_viid</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_set_rxmode - set Rx properties of a virtual interface</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@viid: the VI id</span>
<span class="cm"> *	@mtu: the new MTU or -1</span>
<span class="cm"> *	@promisc: 1 to enable promiscuous mode, 0 to disable it, -1 no change</span>
<span class="cm"> *	@all_multi: 1 to enable all-multi mode, 0 to disable it, -1 no change</span>
<span class="cm"> *	@bcast: 1 to enable broadcast Rx, 0 to disable it, -1 no change</span>
<span class="cm"> *	@vlanex: 1 to enable HW VLAN extraction, 0 to disable it, -1 no change</span>
<span class="cm"> *	@sleep_ok: if true we may sleep while awaiting command completion</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets Rx properties of a virtual interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_set_rxmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viid</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">mtu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">promisc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">all_multi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcast</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vlanex</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">sleep_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_vi_rxmode_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="cm">/* convert to FW values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">FW_RXMODE_MTU_NO_CHG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">promisc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">promisc</span> <span class="o">=</span> <span class="n">FW_VI_RXMODE_CMD_PROMISCEN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">all_multi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">all_multi</span> <span class="o">=</span> <span class="n">FW_VI_RXMODE_CMD_ALLMULTIEN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcast</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bcast</span> <span class="o">=</span> <span class="n">FW_VI_RXMODE_CMD_BROADCASTEN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlanex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vlanex</span> <span class="o">=</span> <span class="n">FW_VI_RXMODE_CMD_VLANEXEN_MASK</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_VI_RXMODE_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			     <span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="n">FW_VI_RXMODE_CMD_VIID</span><span class="p">(</span><span class="n">viid</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">mtu_to_vlanexen</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_VI_RXMODE_CMD_MTU</span><span class="p">(</span><span class="n">mtu</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">FW_VI_RXMODE_CMD_PROMISCEN</span><span class="p">(</span><span class="n">promisc</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">FW_VI_RXMODE_CMD_ALLMULTIEN</span><span class="p">(</span><span class="n">all_multi</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">FW_VI_RXMODE_CMD_BROADCASTEN</span><span class="p">(</span><span class="n">bcast</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">FW_VI_RXMODE_CMD_VLANEXEN</span><span class="p">(</span><span class="n">vlanex</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox_meat</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sleep_ok</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_alloc_mac_filt - allocates exact-match filters for MAC addresses</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@viid: the VI id</span>
<span class="cm"> *	@free: if true any existing filters for this VI id are first removed</span>
<span class="cm"> *	@naddr: the number of MAC addresses to allocate filters for (up to 7)</span>
<span class="cm"> *	@addr: the MAC address(es)</span>
<span class="cm"> *	@idx: where to store the index of each allocated filter</span>
<span class="cm"> *	@hash: pointer to hash address filter bitmap</span>
<span class="cm"> *	@sleep_ok: call is allowed to sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocates an exact-match filter for each of the supplied addresses and</span>
<span class="cm"> *	sets it to the corresponding address.  If @idx is not %NULL it should</span>
<span class="cm"> *	have at least @naddr entries, each of which will be set to the index of</span>
<span class="cm"> *	the filter allocated for the corresponding MAC address.  If a filter</span>
<span class="cm"> *	could not be allocated for an address its index is set to 0xffff.</span>
<span class="cm"> *	If @hash is not %NULL addresses that fail to allocate an exact filter</span>
<span class="cm"> *	are hashed and update the hash filter bitmap pointed at by @hash.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a negative error number or the number of filters allocated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_alloc_mac_filt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">free</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">naddr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="n">u8</span> <span class="o">**</span><span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">hash</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sleep_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_vi_mac_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_vi_mac_exact</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">naddr</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_VI_MAC_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			     <span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="p">(</span><span class="n">free</span> <span class="o">?</span> <span class="n">FW_CMD_EXEC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">FW_VI_MAC_CMD_VIID</span><span class="p">(</span><span class="n">viid</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">freemacs_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_VI_MAC_CMD_FREEMACS</span><span class="p">(</span><span class="n">free</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">FW_CMD_LEN16</span><span class="p">((</span><span class="n">naddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">exact</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">naddr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">valid_to_idx</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FW_VI_MAC_CMD_VALID</span> <span class="o">|</span>
				      <span class="n">FW_VI_MAC_CMD_IDX</span><span class="p">(</span><span class="n">FW_VI_MAC_ADD_MAC</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox_meat</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">sleep_ok</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">exact</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">naddr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="n">FW_VI_MAC_CMD_IDX_GET</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">valid_to_idx</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span>
			<span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">NEXACT_MAC</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">NEXACT_MAC</span><span class="p">)</span>
			<span class="n">ret</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hash</span><span class="p">)</span>
			<span class="o">*</span><span class="n">hash</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">hash_mac_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_change_mac - modifies the exact-match filter for a MAC address</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@viid: the VI id</span>
<span class="cm"> *	@idx: index of existing filter for old value of MAC address, or -1</span>
<span class="cm"> *	@addr: the new MAC address value</span>
<span class="cm"> *	@persist: whether a new MAC allocation should be persistent</span>
<span class="cm"> *	@add_smt: if true also add the address to the HW SMT</span>
<span class="cm"> *</span>
<span class="cm"> *	Modifies an exact-match filter and sets it to the new MAC address.</span>
<span class="cm"> *	Note that in general it is not possible to modify the value of a given</span>
<span class="cm"> *	filter so the generic way to modify an address filter is to free the one</span>
<span class="cm"> *	being used by the old address value and allocate a new filter for the</span>
<span class="cm"> *	new address value.  @idx can be -1 if the address is a new addition.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a negative error number or the index of the filter with the new</span>
<span class="cm"> *	MAC value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_change_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viid</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">persist</span><span class="p">,</span> <span class="n">bool</span> <span class="n">add_smt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_vi_mac_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_vi_mac_exact</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">exact</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>                             <span class="cm">/* new allocation */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">persist</span> <span class="o">?</span> <span class="n">FW_VI_MAC_ADD_PERSIST_MAC</span> <span class="o">:</span> <span class="n">FW_VI_MAC_ADD_MAC</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">add_smt</span> <span class="o">?</span> <span class="n">FW_VI_MAC_SMT_AND_MPSTCAM</span> <span class="o">:</span> <span class="n">FW_VI_MAC_MPS_TCAM_ENTRY</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_VI_MAC_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			     <span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="n">FW_VI_MAC_CMD_VIID</span><span class="p">(</span><span class="n">viid</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">freemacs_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_LEN16</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">valid_to_idx</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FW_VI_MAC_CMD_VALID</span> <span class="o">|</span>
				<span class="n">FW_VI_MAC_CMD_SMAC_RESULT</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">FW_VI_MAC_CMD_IDX</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FW_VI_MAC_CMD_IDX_GET</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">valid_to_idx</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">NEXACT_MAC</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_set_addr_hash - program the MAC inexact-match hash filter</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@viid: the VI id</span>
<span class="cm"> *	@ucast: whether the hash filter should also match unicast addresses</span>
<span class="cm"> *	@vec: the value to be written to the hash filter</span>
<span class="cm"> *	@sleep_ok: call is allowed to sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets the 64-bit inexact-match hash filter for a virtual interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_set_addr_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viid</span><span class="p">,</span>
		     <span class="n">bool</span> <span class="n">ucast</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vec</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sleep_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_vi_mac_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_VI_MAC_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			     <span class="n">FW_CMD_WRITE</span> <span class="o">|</span> <span class="n">FW_VI_ENABLE_CMD_VIID</span><span class="p">(</span><span class="n">viid</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">freemacs_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_VI_MAC_CMD_HASHVECEN</span> <span class="o">|</span>
				    <span class="n">FW_VI_MAC_CMD_HASHUNIEN</span><span class="p">(</span><span class="n">ucast</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">FW_CMD_LEN16</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hash</span><span class="p">.</span><span class="n">hashvec</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox_meat</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sleep_ok</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_enable_vi - enable/disable a virtual interface</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@viid: the VI id</span>
<span class="cm"> *	@rx_en: 1=enable Rx, 0=disable Rx</span>
<span class="cm"> *	@tx_en: 1=enable Tx, 0=disable Tx</span>
<span class="cm"> *</span>
<span class="cm"> *	Enables/disables a virtual interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_enable_vi</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viid</span><span class="p">,</span>
		 <span class="n">bool</span> <span class="n">rx_en</span><span class="p">,</span> <span class="n">bool</span> <span class="n">tx_en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_vi_enable_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_VI_ENABLE_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			     <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_VI_ENABLE_CMD_VIID</span><span class="p">(</span><span class="n">viid</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ien_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_VI_ENABLE_CMD_IEN</span><span class="p">(</span><span class="n">rx_en</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">FW_VI_ENABLE_CMD_EEN</span><span class="p">(</span><span class="n">tx_en</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_identify_port - identify a VI&#39;s port by blinking its LED</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@viid: the VI id</span>
<span class="cm"> *	@nblinks: how many times to blink LED at 2.5 Hz</span>
<span class="cm"> *</span>
<span class="cm"> *	Identifies a VI&#39;s port by blinking its LED.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_identify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viid</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nblinks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_vi_enable_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_VI_ENABLE_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			     <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_VI_ENABLE_CMD_VIID</span><span class="p">(</span><span class="n">viid</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ien_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_VI_ENABLE_CMD_LED</span> <span class="o">|</span> <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">blinkdur</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">nblinks</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_iq_free - free an ingress queue and its FLs</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@pf: the PF owning the queues</span>
<span class="cm"> *	@vf: the VF owning the queues</span>
<span class="cm"> *	@iqtype: the ingress queue type</span>
<span class="cm"> *	@iqid: ingress queue id</span>
<span class="cm"> *	@fl0id: FL0 queue id or 0xffff if no attached FL0</span>
<span class="cm"> *	@fl1id: FL1 queue id or 0xffff if no attached FL1</span>
<span class="cm"> *</span>
<span class="cm"> *	Frees an ingress queue and its associated FLs, if any.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_iq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iqtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iqid</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fl0id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fl1id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_iq_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_IQ_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_IQ_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_IQ_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">alloc_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_IQ_CMD_FREE</span> <span class="o">|</span> <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">type_to_iqandstindex</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_IQ_CMD_TYPE</span><span class="p">(</span><span class="n">iqtype</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">iqid</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">iqid</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">fl0id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">fl0id</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">fl1id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">fl1id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_eth_eq_free - free an Ethernet egress queue</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@pf: the PF owning the queue</span>
<span class="cm"> *	@vf: the VF owning the queue</span>
<span class="cm"> *	@eqid: egress queue id</span>
<span class="cm"> *</span>
<span class="cm"> *	Frees an Ethernet egress queue.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_eth_eq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_eq_eth_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_EQ_ETH_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_EQ_ETH_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_EQ_ETH_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">alloc_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_EQ_ETH_CMD_FREE</span> <span class="o">|</span> <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">eqid_pkd</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_EQ_ETH_CMD_EQID</span><span class="p">(</span><span class="n">eqid</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_ctrl_eq_free - free a control egress queue</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@pf: the PF owning the queue</span>
<span class="cm"> *	@vf: the VF owning the queue</span>
<span class="cm"> *	@eqid: egress queue id</span>
<span class="cm"> *</span>
<span class="cm"> *	Frees a control egress queue.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_ctrl_eq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_eq_ctrl_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_EQ_CTRL_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_EQ_CTRL_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_EQ_CTRL_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">alloc_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_EQ_CTRL_CMD_FREE</span> <span class="o">|</span> <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">cmpliqid_eqid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_EQ_CTRL_CMD_EQID</span><span class="p">(</span><span class="n">eqid</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_ofld_eq_free - free an offload egress queue</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mbox: mailbox to use for the FW command</span>
<span class="cm"> *	@pf: the PF owning the queue</span>
<span class="cm"> *	@vf: the VF owning the queue</span>
<span class="cm"> *	@eqid: egress queue id</span>
<span class="cm"> *</span>
<span class="cm"> *	Frees a control egress queue.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_ofld_eq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_eq_ofld_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">op_to_vfn</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_EQ_OFLD_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span>
			    <span class="n">FW_CMD_EXEC</span> <span class="o">|</span> <span class="n">FW_EQ_OFLD_CMD_PFN</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_EQ_OFLD_CMD_VFN</span><span class="p">(</span><span class="n">vf</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">alloc_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_EQ_OFLD_CMD_FREE</span> <span class="o">|</span> <span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="p">.</span><span class="n">eqid_pkd</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_EQ_OFLD_CMD_EQID</span><span class="p">(</span><span class="n">eqid</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_handle_fw_rpl - process a FW reply message</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@rpl: start of the FW message</span>
<span class="cm"> *</span>
<span class="cm"> *	Processes a FW message, such as link state change messages.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t4_handle_fw_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">rpl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rpl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">FW_PORT_CMD</span><span class="p">)</span> <span class="p">{</span>    <span class="cm">/* link/module state change message */</span>
		<span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fw_port_cmd</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rpl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">FW_PORT_CMD_PORTID_GET</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">op_to_portid</span><span class="p">));</span>
		<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">chan_map</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">lstatus_to_modtype</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">link_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CMD_LSTATUS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">FW_PORT_CMD_MODTYPE_GET</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CMD_RXPAUSE</span><span class="p">)</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">PAUSE_RX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CMD_TXPAUSE</span><span class="p">)</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">PAUSE_TX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CMD_LSPEED</span><span class="p">(</span><span class="n">FW_PORT_CAP_SPEED_100M</span><span class="p">))</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CMD_LSPEED</span><span class="p">(</span><span class="n">FW_PORT_CAP_SPEED_1G</span><span class="p">))</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CMD_LSPEED</span><span class="p">(</span><span class="n">FW_PORT_CAP_SPEED_10G</span><span class="p">))</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span> <span class="o">!=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">!=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">||</span>
		    <span class="n">fc</span> <span class="o">!=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">)</span> <span class="p">{</span>                    <span class="cm">/* something changed */</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="n">link_ok</span><span class="p">;</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
			<span class="n">t4_os_link_changed</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">link_ok</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mod</span> <span class="o">!=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mod_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mod_type</span> <span class="o">=</span> <span class="n">mod</span><span class="p">;</span>
			<span class="n">t4_os_portmod_changed</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">get_pci_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pci_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pcie_cap</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKSTA</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_LNKSTA_CLS</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_LNKSTA_NLW</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	init_link_config - initialize a link&#39;s SW state</span>
<span class="cm"> *	@lc: structure holding the link state</span>
<span class="cm"> *	@caps: link capabilities</span>
<span class="cm"> *</span>
<span class="cm"> *	Initializes the SW state maintained for each link, including the link&#39;s</span>
<span class="cm"> *	capabilities and default speed/flow-control/autonegotiation settings.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">init_link_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">caps</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">PAUSE_RX</span> <span class="o">|</span> <span class="n">PAUSE_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_ANEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">ADVERT_MASK</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">|=</span> <span class="n">PAUSE_AUTONEG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t4_wait_dev_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PL_WHOAMI</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PL_WHOAMI</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_flash_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SF_RD_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_read</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">SF_OP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                    <span class="cm">/* unlock SF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span>             <span class="cm">/* not a Numonix flash */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>                           <span class="cm">/* log2 of size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&gt;=</span> <span class="mh">0x14</span> <span class="o">&amp;&amp;</span> <span class="n">info</span> <span class="o">&lt;</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_nsec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_nsec</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sf_fw_start</span> <span class="o">=</span>
		<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">CIM_BOOT_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BOOTADDR_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t4_prep_adapter - prepare SW and HW for operation</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@reset: if true perform a HW reset</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize adapter SW state for the various HW modules, set initial</span>
<span class="cm"> *	values for some adapter tunables, take PHYs out of reset, and</span>
<span class="cm"> *	initialize the MDIO interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">t4_prep_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wait_dev_ready</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">get_pci_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">PL_REV</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_flash_params</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;error %d identifying flash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_vpd_params</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cong_ctrl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">a_wnd</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">b_wnd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Default port for debugging in case we can&#39;t reach FW.</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">portvec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">t4_port_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_port_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_rss_vi_config_cmd</span> <span class="n">rvc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rvc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rvc</span><span class="p">));</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rss_size</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">portvec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>

		<span class="n">c</span><span class="p">.</span><span class="n">op_to_portid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_PORT_CMD</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span> <span class="n">FW_CMD_READ</span> <span class="o">|</span>
				       <span class="n">FW_PORT_CMD_PORTID</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
		<span class="n">c</span><span class="p">.</span><span class="n">action_to_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span>
			<span class="n">FW_PORT_CMD_ACTION</span><span class="p">(</span><span class="n">FW_PORT_ACTION_GET_PORT_INFO</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">FW_LEN16</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_alloc_vi</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">viid</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rss_size</span> <span class="o">=</span> <span class="n">rss_size</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">lstatus_to_modtype</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">mdio_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CMD_MDIOCAP</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">FW_PORT_CMD_MDIOADDR_GET</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FW_PORT_CMD_PTYPE_GET</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">mod_type</span> <span class="o">=</span> <span class="n">FW_PORT_MOD_TYPE_NA</span><span class="p">;</span>

		<span class="n">rvc</span><span class="p">.</span><span class="n">op_to_viid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_RSS_VI_CONFIG_CMD</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span> <span class="n">FW_CMD_READ</span> <span class="o">|</span>
				       <span class="n">FW_RSS_VI_CONFIG_CMD_VIID</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">));</span>
		<span class="n">rvc</span><span class="p">.</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="n">rvc</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rvc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rvc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rvc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rss_mode</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rvc</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">basicvirtual</span><span class="p">.</span><span class="n">defaultq_to_udpen</span><span class="p">);</span>

		<span class="n">init_link_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">pcap</span><span class="p">));</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
