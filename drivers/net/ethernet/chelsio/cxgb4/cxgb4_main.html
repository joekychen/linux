<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb4 › cxgb4_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>cxgb4_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of the Chelsio T4 Ethernet driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/mdio.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;net/neighbour.h&gt;</span>
<span class="cp">#include &lt;net/netevent.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;cxgb4.h&quot;</span>
<span class="cp">#include &quot;t4_regs.h&quot;</span>
<span class="cp">#include &quot;t4_msg.h&quot;</span>
<span class="cp">#include &quot;t4fw_api.h&quot;</span>
<span class="cp">#include &quot;l2t.h&quot;</span>

<span class="cp">#define DRV_VERSION &quot;1.3.0-ko&quot;</span>
<span class="cp">#define DRV_DESC &quot;Chelsio T4 Network Driver&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Max interrupt hold-off timer value in us.  Queues fall back to this value</span>
<span class="cm"> * under extreme memory pressure so it&#39;s largish to give the system time to</span>
<span class="cm"> * recover.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_SGE_TIMERVAL 200U</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
<span class="cm">/*</span>
<span class="cm"> * Virtual Function provisioning constants.  We need two extra Ingress Queues</span>
<span class="cm"> * with Interrupt capability to serve as the VF&#39;s Firmware Event Queue and</span>
<span class="cm"> * Forwarded Interrupt Queue (when using MSI mode) -- neither will have Free</span>
<span class="cm"> * Lists associated with them).  For each Ethernet/Control Egress Queue and</span>
<span class="cm"> * for each Free List, we need an Egress Context.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VFRES_NPORTS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>		<span class="cm">/* # of &quot;ports&quot; per VF */</span>
	<span class="n">VFRES_NQSETS</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>		<span class="cm">/* # of &quot;Queue Sets&quot; per VF */</span>

	<span class="n">VFRES_NVI</span> <span class="o">=</span> <span class="n">VFRES_NPORTS</span><span class="p">,</span>	<span class="cm">/* # of Virtual Interfaces */</span>
	<span class="n">VFRES_NETHCTRL</span> <span class="o">=</span> <span class="n">VFRES_NQSETS</span><span class="p">,</span>	<span class="cm">/* # of EQs used for ETH or CTRL Qs */</span>
	<span class="n">VFRES_NIQFLINT</span> <span class="o">=</span> <span class="n">VFRES_NQSETS</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="cm">/* # of ingress Qs/w Free List(s)/intr */</span>
	<span class="n">VFRES_NIQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* # of non-fl/int ingress queues */</span>
	<span class="n">VFRES_NEQ</span> <span class="o">=</span> <span class="n">VFRES_NQSETS</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>	<span class="cm">/* # of egress queues */</span>
	<span class="n">VFRES_TC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* PCI-E traffic class */</span>
	<span class="n">VFRES_NEXACTF</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>		<span class="cm">/* # of exact MPS filters */</span>

	<span class="n">VFRES_R_CAPS</span> <span class="o">=</span> <span class="n">FW_CMD_CAP_DMAQ</span><span class="o">|</span><span class="n">FW_CMD_CAP_VF</span><span class="o">|</span><span class="n">FW_CMD_CAP_PORT</span><span class="p">,</span>
	<span class="n">VFRES_WX_CAPS</span> <span class="o">=</span> <span class="n">FW_CMD_CAP_DMAQ</span><span class="o">|</span><span class="n">FW_CMD_CAP_VF</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Provide a Port Access Rights Mask for the specified PF/VF.  This is very</span>
<span class="cm"> * static and likely not to be useful in the long run.  We really need to</span>
<span class="cm"> * implement some form of persistent configuration which the firmware</span>
<span class="cm"> * controls.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pfvfres_pmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">portn</span><span class="p">,</span> <span class="n">portvec</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give PF&#39;s access to all of the ports.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FW_PFVF_CMD_PMASK_MASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For VFs, we&#39;ll assign them access to the ports based purely on the</span>
<span class="cm">	 * PF.  We assign active ports in order, wrapping around if there are</span>
<span class="cm">	 * fewer active ports than PFs: e.g. active port[pf % nports].</span>
<span class="cm">	 * Unfortunately the adapter&#39;s port_info structs haven&#39;t been</span>
<span class="cm">	 * initialized yet so we have to compute this.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">portn</span> <span class="o">=</span> <span class="n">pf</span> <span class="o">%</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
	<span class="n">portvec</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">portvec</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Isolate the lowest set bit in the port vector.  If we&#39;re at</span>
<span class="cm">		 * the port number that we want, return that as the pmask.</span>
<span class="cm">		 * otherwise mask that bit out of the port vector and</span>
<span class="cm">		 * decrement our port number ...</span>
<span class="cm">		 */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pmask</span> <span class="o">=</span> <span class="n">portvec</span> <span class="o">^</span> <span class="p">(</span><span class="n">portvec</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">portvec</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">portn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pmask</span><span class="p">;</span>
		<span class="n">portn</span><span class="o">--</span><span class="p">;</span>
		<span class="n">portvec</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">pmask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*NOTREACHED*/</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MAX_TXQ_ENTRIES</span>      <span class="o">=</span> <span class="mi">16384</span><span class="p">,</span>
	<span class="n">MAX_CTRL_TXQ_ENTRIES</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="n">MAX_RSPQ_ENTRIES</span>     <span class="o">=</span> <span class="mi">16384</span><span class="p">,</span>
	<span class="n">MAX_RX_BUFFERS</span>       <span class="o">=</span> <span class="mi">16384</span><span class="p">,</span>
	<span class="n">MIN_TXQ_ENTRIES</span>      <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="n">MIN_CTRL_TXQ_ENTRIES</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="n">MIN_RSPQ_ENTRIES</span>     <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="n">MIN_FL_ENTRIES</span>       <span class="o">=</span> <span class="mi">16</span>
<span class="p">};</span>

<span class="cp">#define DFLT_MSG_ENABLE (NETIF_MSG_DRV | NETIF_MSG_PROBE | NETIF_MSG_LINK | \</span>
<span class="cp">			 NETIF_MSG_TIMER | NETIF_MSG_IFDOWN | NETIF_MSG_IFUP |\</span>
<span class="cp">			 NETIF_MSG_RX_ERR | NETIF_MSG_TX_ERR)</span>

<span class="cp">#define CH_DEVICE(devid, data) { PCI_VDEVICE(CHELSIO, devid), (data) }</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">cxgb4_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0xa000</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="cm">/* PE10K */</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4001</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4002</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4003</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4004</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4005</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4006</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4007</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4008</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4009</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x400a</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4401</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4402</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4403</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4404</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4405</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4406</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4407</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4408</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x4409</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x440a</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x440d</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">CH_DEVICE</span><span class="p">(</span><span class="mh">0x440e</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define FW_FNAME &quot;cxgb4/t4fw.bin&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Chelsio Communications&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cxgb4_pci_tbl</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FNAME</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dflt_msg_enable</span> <span class="o">=</span> <span class="n">DFLT_MSG_ENABLE</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dflt_msg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dflt_msg_enable</span><span class="p">,</span> <span class="s">&quot;Chelsio T4 default message enable bitmap&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The driver uses the best interrupt scheme available on a platform in the</span>
<span class="cm"> * order MSI-X, MSI, legacy INTx interrupts.  This parameter determines which</span>
<span class="cm"> * of these schemes the driver may consider as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * msi = 2: choose from among all three options</span>
<span class="cm"> * msi = 1: only consider MSI and INTx interrupts</span>
<span class="cm"> * msi = 0: force INTx interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msi</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="s">&quot;whether to use INTx (0), MSI (1) or MSI-X (2)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Queue interrupt hold-off timer values.  Queues default to the first of these</span>
<span class="cm"> * upon creation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr_holdoff</span><span class="p">[</span><span class="n">SGE_NTIMERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">intr_holdoff</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">intr_holdoff</span><span class="p">,</span> <span class="s">&quot;values for queue interrupt hold-off timers &quot;</span>
		 <span class="s">&quot;0..4 in microseconds&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr_cnt</span><span class="p">[</span><span class="n">SGE_NCOUNTERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">intr_cnt</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">intr_cnt</span><span class="p">,</span>
		 <span class="s">&quot;thresholds 1..3 for queue interrupt packet counters&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">vf_acls</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vf_acls</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vf_acls</span><span class="p">,</span> <span class="s">&quot;if set enable virtualization L2 ACL enforcement&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_vf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">num_vf</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_vf</span><span class="p">,</span> <span class="s">&quot;number of VFs for each of PFs 0-3&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">cxgb4_debugfs_root</span><span class="p">;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">adapter_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">uld_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cxgb4_uld_info</span> <span class="n">ulds</span><span class="p">[</span><span class="n">CXGB4_ULD_MAX</span><span class="p">];</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uld_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;RDMA&quot;</span><span class="p">,</span> <span class="s">&quot;iSCSI&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="s">&quot;Rx&quot;</span><span class="p">,</span> <span class="s">&quot;Tx&quot;</span><span class="p">,</span> <span class="s">&quot;Tx/Rx&quot;</span> <span class="p">};</span>

		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;10Mbps&quot;</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10000</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;10Gbps&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;1000Mbps&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;100Mbps&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link up, %s, full-duplex, %s PAUSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
			    <span class="n">fc</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">fc</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t4_os_link_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_id</span><span class="p">];</span>

	<span class="cm">/* Skip changes from disabled ports. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">link_stat</span> <span class="o">!=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_stat</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">link_report</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t4_os_portmod_changed</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mod_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;LR&quot;</span><span class="p">,</span> <span class="s">&quot;SR&quot;</span><span class="p">,</span> <span class="s">&quot;ER&quot;</span><span class="p">,</span> <span class="s">&quot;passive DA&quot;</span><span class="p">,</span> <span class="s">&quot;active DA&quot;</span><span class="p">,</span> <span class="s">&quot;LRM&quot;</span>
	<span class="p">};</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mod_type</span> <span class="o">==</span> <span class="n">FW_PORT_MOD_TYPE_NONE</span><span class="p">)</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;port module unplugged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mod_type</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mod_str</span><span class="p">))</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s module inserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mod_str</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mod_type</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the exact and hash address filters to handle a port&#39;s multicast</span>
<span class="cm"> * and secondary unicast MAC addresses.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_addr_filters</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sleep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mhash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">uhash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">free</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">filt_idx</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">naddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uc_cnt</span> <span class="o">=</span> <span class="n">netdev_uc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mc_cnt</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">;</span>

	<span class="cm">/* first do the secondary unicast addresses */</span>
	<span class="n">netdev_for_each_uc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">naddr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">uc_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">naddr</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_alloc_mac_filt</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span>
					<span class="n">naddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">filt_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uhash</span><span class="p">,</span> <span class="n">sleep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">free</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">naddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* next set up the multicast addresses */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">naddr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">mc_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">naddr</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_alloc_mac_filt</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span>
					<span class="n">naddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">filt_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mhash</span><span class="p">,</span> <span class="n">sleep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">free</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">naddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">t4_set_addr_hash</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="n">uhash</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">uhash</span> <span class="o">|</span> <span class="n">mhash</span><span class="p">,</span> <span class="n">sleep</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">dbfifo_int_thresh</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* 10 == 640 entry threshold */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dbfifo_int_thresh</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbfifo_int_thresh</span><span class="p">,</span> <span class="s">&quot;doorbell fifo interrupt threshold&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">dbfifo_drain_delay</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* usecs to sleep while draining the dbfifo */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dbfifo_drain_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbfifo_drain_delay</span><span class="p">,</span>
		 <span class="s">&quot;usecs to sleep while draining the dbfifo&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set Rx properties of a port, such as promiscruity, address filters, and MTU.</span>
<span class="cm"> * If @mtu is -1 it is left unchanged.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rxmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sleep_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_addr_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sleep_ok</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_set_rxmode</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="n">mtu</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				    <span class="n">sleep_ok</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">workq</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> *	link_start - enable a port</span>
<span class="cm"> *	@dev: the port to enable</span>
<span class="cm"> *</span>
<span class="cm"> *	Performs the MAC and PHY actions needed to enable a port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">link_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We do not set address filters and promiscuity here, the stack does</span>
<span class="cm">	 * that step explicitly.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_set_rxmode</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			    <span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_change_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span>
				    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">xact_addr_filt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				    <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">xact_addr_filt</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_link_start</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_enable_vi</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Response queue handler for the FW event queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fwevtq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">pkt_gl</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rss_header</span> <span class="o">*</span><span class="p">)</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>

	<span class="n">rsp</span><span class="o">++</span><span class="p">;</span>                                          <span class="cm">/* skip RSS header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">CPL_SGE_EGR_UPDATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">cpl_sge_egr_update</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rsp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qid</span> <span class="o">=</span> <span class="n">EGR_QID</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">opcode_qid</span><span class="p">));</span>
		<span class="k">struct</span> <span class="n">sge_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>

		<span class="n">txq</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">egr_map</span><span class="p">[</span><span class="n">qid</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">egr_start</span><span class="p">];</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">restarts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">txq</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ofldtxq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sge_eth_txq</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>

			<span class="n">eq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sge_eth_txq</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
			<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sge_ofld_txq</span> <span class="o">*</span><span class="n">oq</span><span class="p">;</span>

			<span class="n">oq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sge_ofld_txq</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oq</span><span class="o">-&gt;</span><span class="n">qresume_tsk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">CPL_FW6_MSG</span> <span class="o">||</span> <span class="n">opcode</span> <span class="o">==</span> <span class="n">CPL_FW4_MSG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">cpl_fw6_msg</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rsp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">t4_handle_fw_rpl</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">CPL_L2T_WRITE_RPL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">cpl_l2t_write_rpl</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rsp</span><span class="p">;</span>

		<span class="n">do_l2t_write_rpl</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			<span class="s">&quot;unexpected CPL %#x on FW event queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	uldrx_handler - response queue handler for ULD queues</span>
<span class="cm"> *	@q: the response queue that received the packet</span>
<span class="cm"> *	@rsp: the response queue descriptor holding the offload message</span>
<span class="cm"> *	@gl: the gather list of packet fragments</span>
<span class="cm"> *</span>
<span class="cm"> *	Deliver an ingress offload packet to a ULD.  All processing is done by</span>
<span class="cm"> *	the ULD, we just maintain statistics.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uldrx_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">pkt_gl</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sge_ofld_rxq</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sge_ofld_rxq</span><span class="p">,</span> <span class="n">rspq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulds</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">uld</span><span class="p">].</span><span class="n">rx_handler</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">uld</span><span class="p">],</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">gl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">nomem</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">imm</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gl</span> <span class="o">==</span> <span class="n">CXGB4_MSG_AN</span><span class="p">)</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">an</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USING_MSIX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USING_MSI</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handler for non-data events used with MSI-X.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">t4_nondata_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">PL_PF_INT_CAUSE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">PFSW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">swintr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">PL_PF_INT_CAUSE</span><span class="p">),</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t4_slow_intr_handler</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Name the MSI-X interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">name_msix_vecs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">msi_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* non-data interrupts */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* FW events */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;%s-FWeventq&quot;</span><span class="p">,</span>
		 <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Ethernet queues */</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">msi_idx</span><span class="o">++</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;%s-Rx%d&quot;</span><span class="p">,</span>
				 <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* offload queues */</span>
	<span class="n">for_each_ofldrxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi_idx</span><span class="o">++</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;%s-ofld%d&quot;</span><span class="p">,</span>
			 <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">for_each_rdmarxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi_idx</span><span class="o">++</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;%s-rdma%d&quot;</span><span class="p">,</span>
			 <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_msix_queue_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ethqidx</span><span class="p">,</span> <span class="n">ofldqidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rdmaqidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msi</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="n">t4_sge_intr_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">for_each_ethrxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ethqidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="n">t4_sge_intr_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">ethqidx</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
		<span class="n">msi</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">for_each_ofldrxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ofldqidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="n">t4_sge_intr_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldrxq</span><span class="p">[</span><span class="n">ofldqidx</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
		<span class="n">msi</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">for_each_rdmarxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rdmaqidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="n">t4_sge_intr_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmarxq</span><span class="p">[</span><span class="n">rdmaqidx</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
		<span class="n">msi</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">rdmaqidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="o">--</span><span class="n">msi</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmarxq</span><span class="p">[</span><span class="n">rdmaqidx</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">ofldqidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="o">--</span><span class="n">msi</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldrxq</span><span class="p">[</span><span class="n">ofldqidx</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">ethqidx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="o">--</span><span class="n">msi</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">ethqidx</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_msix_queue_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">msi</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">);</span>
	<span class="n">for_each_ethrxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="o">++</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
	<span class="n">for_each_ofldrxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="o">++</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldrxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
	<span class="n">for_each_rdmarxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">msi</span><span class="o">++</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmarxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	write_rss - write the RSS table for a given port</span>
<span class="cm"> *	@pi: the port</span>
<span class="cm"> *	@queues: array of queue indices for RSS</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets up the portion of the HW RSS table for the port&#39;s VI to distribute</span>
<span class="cm"> *	packets to the Rx queues in @queues.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_rss</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">queues</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">rss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sge_eth_rxq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">];</span>

	<span class="n">rss</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rss</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* map the queue indices to queue ids */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">queues</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="o">*</span><span class="n">queues</span><span class="p">].</span><span class="n">rspq</span><span class="p">.</span><span class="n">abs_id</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t4_config_rss_range</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rss</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	setup_rss - configure RSS</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets up RSS for each port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">write_rss</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the channel of the ingress queue with the given qid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rxq_to_chan</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qid</span> <span class="o">-=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ingr_start</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">netdev2pinfo</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ingr_map</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait until all NAPI handlers are descheduled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">quiesce_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ingr_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ingr_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
			<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable NAPI scheduling and interrupt generation for all Rx queues.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ingr_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ingr_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
			<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="cm">/* 0-increment GTS to start the timer and enable interrupts */</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">SGE_PF_GTS</span><span class="p">),</span>
			     <span class="n">SEINTARM</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">intr_params</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">INGRESSQID</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">cntxt_id</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	setup_sge_queues - configure SGE Tx/Rx/response queues</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *	Determines how many sets of SGE queues to use and initializes them.</span>
<span class="cm"> *	We support multiple queue sets per port if we have MSI-X, otherwise</span>
<span class="cm"> *	just one queue set per port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_sge_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">msi_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>

	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">starving_fl</span><span class="p">,</span> <span class="n">MAX_EGRQ</span><span class="p">);</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txq_maperr</span><span class="p">,</span> <span class="n">MAX_EGRQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX</span><span class="p">)</span>
		<span class="n">msi_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>         <span class="cm">/* vector 0 is for non-queue interrupts */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_rxq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">intrq</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">msi_idx</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">intrq</span><span class="p">.</span><span class="n">abs_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_rxq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			       <span class="n">msi_idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fwevtq_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">freeout:</span>	<span class="n">t4_free_sge_resources</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sge_eth_rxq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sge_eth_txq</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">q</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msi_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">msi_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_rxq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					       <span class="n">msi_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">,</span>
					       <span class="n">t4_ethrx_handler</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">freeout</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_eth_txq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					<span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">.</span><span class="n">cntxt_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">freeout</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldqsets</span> <span class="o">/</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span> <span class="cm">/* ofld queues per channel */</span>
	<span class="n">for_each_ofldrxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sge_ofld_rxq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldrxq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msi_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msi_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_rxq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">msi_idx</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">,</span> <span class="n">uldrx_handler</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">freeout</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ofld_rxq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">.</span><span class="n">abs_id</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_ofld_txq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldtxq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dev</span><span class="p">,</span>
					    <span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">.</span><span class="n">cntxt_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">freeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_rdmarxq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sge_ofld_rxq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmarxq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msi_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msi_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_rxq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="n">msi_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">,</span> <span class="n">uldrx_handler</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">freeout</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">rdma_rxq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">.</span><span class="n">abs_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note that -&gt;rdmarxq[i].rspq.cntxt_id below is 0 if we don&#39;t</span>
<span class="cm">		 * have RDMA queues, and that&#39;s the right value.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_sge_alloc_ctrl_txq</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ctrlq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					    <span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">.</span><span class="n">cntxt_id</span><span class="p">,</span>
					    <span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmarxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspq</span><span class="p">.</span><span class="n">cntxt_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">freeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MPS_TRC_RSS_CONTROL</span><span class="p">,</span>
		     <span class="n">RSSCONTROL</span><span class="p">(</span><span class="n">netdev2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">QUEUENUMBER</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rspq</span><span class="p">.</span><span class="n">abs_id</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns 0 if new FW was successfully loaded, a positive errno if a load was</span>
<span class="cm"> * started but failed, and a negative errno if flash load couldn&#39;t start.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">upgrade_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vers</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">FW_FNAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to load firmware image &quot;</span> <span class="n">FW_FNAME</span>
			<span class="s">&quot;, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">vers</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FW_HDR_FW_VER_MAJOR_GET</span><span class="p">(</span><span class="n">vers</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FW_VERSION_MAJOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>              <span class="cm">/* wrong major version, won&#39;t do */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the flash FW is unusable or we found something newer, load it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FW_HDR_FW_VER_MAJOR_GET</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FW_VERSION_MAJOR</span> <span class="o">||</span>
	    <span class="n">vers</span> <span class="o">&gt;</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">t4_load_fw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware upgraded to version %pI4 from &quot;</span>
				 <span class="n">FW_FNAME</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a chunk of memory using kmalloc or, if that fails, vmalloc.</span>
<span class="cm"> * The allocated memory is cleared.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">t4_alloc_mem</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free memory allocated through alloc_mem().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">t4_free_mem</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_vmalloc_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_offload</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">offload</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Implementation of ethtool operations.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">stats_strings</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;TxOctetsOK         &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFramesOK         &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxBroadcastFrames  &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxMulticastFrames  &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxUnicastFrames    &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxErrorFrames      &quot;</span><span class="p">,</span>

	<span class="s">&quot;TxFrames64         &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFrames65To127    &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFrames128To255   &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFrames256To511   &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFrames512To1023  &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFrames1024To1518 &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFrames1519ToMax  &quot;</span><span class="p">,</span>

	<span class="s">&quot;TxFramesDropped    &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPauseFrames      &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP0Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP1Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP2Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP3Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP4Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP5Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP6Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPPP7Frames       &quot;</span><span class="p">,</span>

	<span class="s">&quot;RxOctetsOK         &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFramesOK         &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBroadcastFrames  &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxMulticastFrames  &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxUnicastFrames    &quot;</span><span class="p">,</span>

	<span class="s">&quot;RxFramesTooLong    &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxJabberErrors     &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFCSErrors        &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxLengthErrors     &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxSymbolErrors     &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxRuntFrames       &quot;</span><span class="p">,</span>

	<span class="s">&quot;RxFrames64         &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFrames65To127    &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFrames128To255   &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFrames256To511   &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFrames512To1023  &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFrames1024To1518 &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFrames1519ToMax  &quot;</span><span class="p">,</span>

	<span class="s">&quot;RxPauseFrames      &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP0Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP1Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP2Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP3Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP4Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP5Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP6Frames       &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPPP7Frames       &quot;</span><span class="p">,</span>

	<span class="s">&quot;RxBG0FramesDropped &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBG1FramesDropped &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBG2FramesDropped &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBG3FramesDropped &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBG0FramesTrunc   &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBG1FramesTrunc   &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBG2FramesTrunc   &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBG3FramesTrunc   &quot;</span><span class="p">,</span>

	<span class="s">&quot;TSO                &quot;</span><span class="p">,</span>
	<span class="s">&quot;TxCsumOffload      &quot;</span><span class="p">,</span>
	<span class="s">&quot;RxCsumGood         &quot;</span><span class="p">,</span>
	<span class="s">&quot;VLANextractions    &quot;</span><span class="p">,</span>
	<span class="s">&quot;VLANinsertions     &quot;</span><span class="p">,</span>
	<span class="s">&quot;GROpackets         &quot;</span><span class="p">,</span>
	<span class="s">&quot;GROmerged          &quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats_strings</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define T4_REGMAP_SIZE (160 * 1024)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">T4_REGMAP_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">EEPROMSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
			<span class="s">&quot;%u.%u.%u.%u, TP %u.%u.%u.%u&quot;</span><span class="p">,</span>
			<span class="n">FW_HDR_FW_VER_MAJOR_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_MINOR_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_MICRO_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_BUILD_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_MAJOR_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_MINOR_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_MICRO_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp_vers</span><span class="p">),</span>
			<span class="n">FW_HDR_FW_VER_BUILD_GET</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp_vers</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">stats_strings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats_strings</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * port stats maintained per queue of the port.  They should be in the same</span>
<span class="cm"> * order as in stats_strings above.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">queue_port_stats</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">tso</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_csum</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_csum</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vlan_ex</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vlan_ins</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">gro_pkts</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">gro_merged</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">collect_sge_port_stats</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue_port_stats</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sge_eth_txq</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sge_eth_rxq</span> <span class="o">*</span><span class="n">rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rx</span><span class="o">++</span><span class="p">,</span> <span class="n">tx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">tso</span> <span class="o">+=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">tso</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_csum</span> <span class="o">+=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_cso</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_csum</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_cso</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">vlan_ex</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vlan_ex</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">vlan_ins</span> <span class="o">+=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">vlan_ins</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">gro_pkts</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lro_pkts</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">gro_merged</span> <span class="o">+=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lro_merged</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">t4_get_port_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">port_stats</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">port_stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="n">collect_sge_port_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">queue_port_stats</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a version number to identify the type of adapter.  The scheme is:</span>
<span class="cm"> * - bits 0..9: chip version</span>
<span class="cm"> * - bits 10..15: chip revision</span>
<span class="cm"> * - bits 16..23: register dump version</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mk_adap_vers</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reg_block_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">start</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_ranges</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x1008</span><span class="p">,</span> <span class="mh">0x1108</span><span class="p">,</span>
		<span class="mh">0x1180</span><span class="p">,</span> <span class="mh">0x11b4</span><span class="p">,</span>
		<span class="mh">0x11fc</span><span class="p">,</span> <span class="mh">0x123c</span><span class="p">,</span>
		<span class="mh">0x1300</span><span class="p">,</span> <span class="mh">0x173c</span><span class="p">,</span>
		<span class="mh">0x1800</span><span class="p">,</span> <span class="mh">0x18fc</span><span class="p">,</span>
		<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x30d8</span><span class="p">,</span>
		<span class="mh">0x30e0</span><span class="p">,</span> <span class="mh">0x5924</span><span class="p">,</span>
		<span class="mh">0x5960</span><span class="p">,</span> <span class="mh">0x59d4</span><span class="p">,</span>
		<span class="mh">0x5a00</span><span class="p">,</span> <span class="mh">0x5af8</span><span class="p">,</span>
		<span class="mh">0x6000</span><span class="p">,</span> <span class="mh">0x6098</span><span class="p">,</span>
		<span class="mh">0x6100</span><span class="p">,</span> <span class="mh">0x6150</span><span class="p">,</span>
		<span class="mh">0x6200</span><span class="p">,</span> <span class="mh">0x6208</span><span class="p">,</span>
		<span class="mh">0x6240</span><span class="p">,</span> <span class="mh">0x6248</span><span class="p">,</span>
		<span class="mh">0x6280</span><span class="p">,</span> <span class="mh">0x6338</span><span class="p">,</span>
		<span class="mh">0x6370</span><span class="p">,</span> <span class="mh">0x638c</span><span class="p">,</span>
		<span class="mh">0x6400</span><span class="p">,</span> <span class="mh">0x643c</span><span class="p">,</span>
		<span class="mh">0x6500</span><span class="p">,</span> <span class="mh">0x6524</span><span class="p">,</span>
		<span class="mh">0x6a00</span><span class="p">,</span> <span class="mh">0x6a38</span><span class="p">,</span>
		<span class="mh">0x6a60</span><span class="p">,</span> <span class="mh">0x6a78</span><span class="p">,</span>
		<span class="mh">0x6b00</span><span class="p">,</span> <span class="mh">0x6b84</span><span class="p">,</span>
		<span class="mh">0x6bf0</span><span class="p">,</span> <span class="mh">0x6c84</span><span class="p">,</span>
		<span class="mh">0x6cf0</span><span class="p">,</span> <span class="mh">0x6d84</span><span class="p">,</span>
		<span class="mh">0x6df0</span><span class="p">,</span> <span class="mh">0x6e84</span><span class="p">,</span>
		<span class="mh">0x6ef0</span><span class="p">,</span> <span class="mh">0x6f84</span><span class="p">,</span>
		<span class="mh">0x6ff0</span><span class="p">,</span> <span class="mh">0x7084</span><span class="p">,</span>
		<span class="mh">0x70f0</span><span class="p">,</span> <span class="mh">0x7184</span><span class="p">,</span>
		<span class="mh">0x71f0</span><span class="p">,</span> <span class="mh">0x7284</span><span class="p">,</span>
		<span class="mh">0x72f0</span><span class="p">,</span> <span class="mh">0x7384</span><span class="p">,</span>
		<span class="mh">0x73f0</span><span class="p">,</span> <span class="mh">0x7450</span><span class="p">,</span>
		<span class="mh">0x7500</span><span class="p">,</span> <span class="mh">0x7530</span><span class="p">,</span>
		<span class="mh">0x7600</span><span class="p">,</span> <span class="mh">0x761c</span><span class="p">,</span>
		<span class="mh">0x7680</span><span class="p">,</span> <span class="mh">0x76cc</span><span class="p">,</span>
		<span class="mh">0x7700</span><span class="p">,</span> <span class="mh">0x7798</span><span class="p">,</span>
		<span class="mh">0x77c0</span><span class="p">,</span> <span class="mh">0x77fc</span><span class="p">,</span>
		<span class="mh">0x7900</span><span class="p">,</span> <span class="mh">0x79fc</span><span class="p">,</span>
		<span class="mh">0x7b00</span><span class="p">,</span> <span class="mh">0x7c38</span><span class="p">,</span>
		<span class="mh">0x7d00</span><span class="p">,</span> <span class="mh">0x7efc</span><span class="p">,</span>
		<span class="mh">0x8dc0</span><span class="p">,</span> <span class="mh">0x8e1c</span><span class="p">,</span>
		<span class="mh">0x8e30</span><span class="p">,</span> <span class="mh">0x8e78</span><span class="p">,</span>
		<span class="mh">0x8ea0</span><span class="p">,</span> <span class="mh">0x8f6c</span><span class="p">,</span>
		<span class="mh">0x8fc0</span><span class="p">,</span> <span class="mh">0x9074</span><span class="p">,</span>
		<span class="mh">0x90fc</span><span class="p">,</span> <span class="mh">0x90fc</span><span class="p">,</span>
		<span class="mh">0x9400</span><span class="p">,</span> <span class="mh">0x9458</span><span class="p">,</span>
		<span class="mh">0x9600</span><span class="p">,</span> <span class="mh">0x96bc</span><span class="p">,</span>
		<span class="mh">0x9800</span><span class="p">,</span> <span class="mh">0x9808</span><span class="p">,</span>
		<span class="mh">0x9820</span><span class="p">,</span> <span class="mh">0x983c</span><span class="p">,</span>
		<span class="mh">0x9850</span><span class="p">,</span> <span class="mh">0x9864</span><span class="p">,</span>
		<span class="mh">0x9c00</span><span class="p">,</span> <span class="mh">0x9c6c</span><span class="p">,</span>
		<span class="mh">0x9c80</span><span class="p">,</span> <span class="mh">0x9cec</span><span class="p">,</span>
		<span class="mh">0x9d00</span><span class="p">,</span> <span class="mh">0x9d6c</span><span class="p">,</span>
		<span class="mh">0x9d80</span><span class="p">,</span> <span class="mh">0x9dec</span><span class="p">,</span>
		<span class="mh">0x9e00</span><span class="p">,</span> <span class="mh">0x9e6c</span><span class="p">,</span>
		<span class="mh">0x9e80</span><span class="p">,</span> <span class="mh">0x9eec</span><span class="p">,</span>
		<span class="mh">0x9f00</span><span class="p">,</span> <span class="mh">0x9f6c</span><span class="p">,</span>
		<span class="mh">0x9f80</span><span class="p">,</span> <span class="mh">0x9fec</span><span class="p">,</span>
		<span class="mh">0xd004</span><span class="p">,</span> <span class="mh">0xd03c</span><span class="p">,</span>
		<span class="mh">0xdfc0</span><span class="p">,</span> <span class="mh">0xdfe0</span><span class="p">,</span>
		<span class="mh">0xe000</span><span class="p">,</span> <span class="mh">0xea7c</span><span class="p">,</span>
		<span class="mh">0xf000</span><span class="p">,</span> <span class="mh">0x11190</span><span class="p">,</span>
		<span class="mh">0x19040</span><span class="p">,</span> <span class="mh">0x1906c</span><span class="p">,</span>
		<span class="mh">0x19078</span><span class="p">,</span> <span class="mh">0x19080</span><span class="p">,</span>
		<span class="mh">0x1908c</span><span class="p">,</span> <span class="mh">0x19124</span><span class="p">,</span>
		<span class="mh">0x19150</span><span class="p">,</span> <span class="mh">0x191b0</span><span class="p">,</span>
		<span class="mh">0x191d0</span><span class="p">,</span> <span class="mh">0x191e8</span><span class="p">,</span>
		<span class="mh">0x19238</span><span class="p">,</span> <span class="mh">0x1924c</span><span class="p">,</span>
		<span class="mh">0x193f8</span><span class="p">,</span> <span class="mh">0x19474</span><span class="p">,</span>
		<span class="mh">0x19490</span><span class="p">,</span> <span class="mh">0x194f8</span><span class="p">,</span>
		<span class="mh">0x19800</span><span class="p">,</span> <span class="mh">0x19f30</span><span class="p">,</span>
		<span class="mh">0x1a000</span><span class="p">,</span> <span class="mh">0x1a06c</span><span class="p">,</span>
		<span class="mh">0x1a0b0</span><span class="p">,</span> <span class="mh">0x1a120</span><span class="p">,</span>
		<span class="mh">0x1a128</span><span class="p">,</span> <span class="mh">0x1a138</span><span class="p">,</span>
		<span class="mh">0x1a190</span><span class="p">,</span> <span class="mh">0x1a1c4</span><span class="p">,</span>
		<span class="mh">0x1a1fc</span><span class="p">,</span> <span class="mh">0x1a1fc</span><span class="p">,</span>
		<span class="mh">0x1e040</span><span class="p">,</span> <span class="mh">0x1e04c</span><span class="p">,</span>
		<span class="mh">0x1e284</span><span class="p">,</span> <span class="mh">0x1e28c</span><span class="p">,</span>
		<span class="mh">0x1e2c0</span><span class="p">,</span> <span class="mh">0x1e2c0</span><span class="p">,</span>
		<span class="mh">0x1e2e0</span><span class="p">,</span> <span class="mh">0x1e2e0</span><span class="p">,</span>
		<span class="mh">0x1e300</span><span class="p">,</span> <span class="mh">0x1e384</span><span class="p">,</span>
		<span class="mh">0x1e3c0</span><span class="p">,</span> <span class="mh">0x1e3c8</span><span class="p">,</span>
		<span class="mh">0x1e440</span><span class="p">,</span> <span class="mh">0x1e44c</span><span class="p">,</span>
		<span class="mh">0x1e684</span><span class="p">,</span> <span class="mh">0x1e68c</span><span class="p">,</span>
		<span class="mh">0x1e6c0</span><span class="p">,</span> <span class="mh">0x1e6c0</span><span class="p">,</span>
		<span class="mh">0x1e6e0</span><span class="p">,</span> <span class="mh">0x1e6e0</span><span class="p">,</span>
		<span class="mh">0x1e700</span><span class="p">,</span> <span class="mh">0x1e784</span><span class="p">,</span>
		<span class="mh">0x1e7c0</span><span class="p">,</span> <span class="mh">0x1e7c8</span><span class="p">,</span>
		<span class="mh">0x1e840</span><span class="p">,</span> <span class="mh">0x1e84c</span><span class="p">,</span>
		<span class="mh">0x1ea84</span><span class="p">,</span> <span class="mh">0x1ea8c</span><span class="p">,</span>
		<span class="mh">0x1eac0</span><span class="p">,</span> <span class="mh">0x1eac0</span><span class="p">,</span>
		<span class="mh">0x1eae0</span><span class="p">,</span> <span class="mh">0x1eae0</span><span class="p">,</span>
		<span class="mh">0x1eb00</span><span class="p">,</span> <span class="mh">0x1eb84</span><span class="p">,</span>
		<span class="mh">0x1ebc0</span><span class="p">,</span> <span class="mh">0x1ebc8</span><span class="p">,</span>
		<span class="mh">0x1ec40</span><span class="p">,</span> <span class="mh">0x1ec4c</span><span class="p">,</span>
		<span class="mh">0x1ee84</span><span class="p">,</span> <span class="mh">0x1ee8c</span><span class="p">,</span>
		<span class="mh">0x1eec0</span><span class="p">,</span> <span class="mh">0x1eec0</span><span class="p">,</span>
		<span class="mh">0x1eee0</span><span class="p">,</span> <span class="mh">0x1eee0</span><span class="p">,</span>
		<span class="mh">0x1ef00</span><span class="p">,</span> <span class="mh">0x1ef84</span><span class="p">,</span>
		<span class="mh">0x1efc0</span><span class="p">,</span> <span class="mh">0x1efc8</span><span class="p">,</span>
		<span class="mh">0x1f040</span><span class="p">,</span> <span class="mh">0x1f04c</span><span class="p">,</span>
		<span class="mh">0x1f284</span><span class="p">,</span> <span class="mh">0x1f28c</span><span class="p">,</span>
		<span class="mh">0x1f2c0</span><span class="p">,</span> <span class="mh">0x1f2c0</span><span class="p">,</span>
		<span class="mh">0x1f2e0</span><span class="p">,</span> <span class="mh">0x1f2e0</span><span class="p">,</span>
		<span class="mh">0x1f300</span><span class="p">,</span> <span class="mh">0x1f384</span><span class="p">,</span>
		<span class="mh">0x1f3c0</span><span class="p">,</span> <span class="mh">0x1f3c8</span><span class="p">,</span>
		<span class="mh">0x1f440</span><span class="p">,</span> <span class="mh">0x1f44c</span><span class="p">,</span>
		<span class="mh">0x1f684</span><span class="p">,</span> <span class="mh">0x1f68c</span><span class="p">,</span>
		<span class="mh">0x1f6c0</span><span class="p">,</span> <span class="mh">0x1f6c0</span><span class="p">,</span>
		<span class="mh">0x1f6e0</span><span class="p">,</span> <span class="mh">0x1f6e0</span><span class="p">,</span>
		<span class="mh">0x1f700</span><span class="p">,</span> <span class="mh">0x1f784</span><span class="p">,</span>
		<span class="mh">0x1f7c0</span><span class="p">,</span> <span class="mh">0x1f7c8</span><span class="p">,</span>
		<span class="mh">0x1f840</span><span class="p">,</span> <span class="mh">0x1f84c</span><span class="p">,</span>
		<span class="mh">0x1fa84</span><span class="p">,</span> <span class="mh">0x1fa8c</span><span class="p">,</span>
		<span class="mh">0x1fac0</span><span class="p">,</span> <span class="mh">0x1fac0</span><span class="p">,</span>
		<span class="mh">0x1fae0</span><span class="p">,</span> <span class="mh">0x1fae0</span><span class="p">,</span>
		<span class="mh">0x1fb00</span><span class="p">,</span> <span class="mh">0x1fb84</span><span class="p">,</span>
		<span class="mh">0x1fbc0</span><span class="p">,</span> <span class="mh">0x1fbc8</span><span class="p">,</span>
		<span class="mh">0x1fc40</span><span class="p">,</span> <span class="mh">0x1fc4c</span><span class="p">,</span>
		<span class="mh">0x1fe84</span><span class="p">,</span> <span class="mh">0x1fe8c</span><span class="p">,</span>
		<span class="mh">0x1fec0</span><span class="p">,</span> <span class="mh">0x1fec0</span><span class="p">,</span>
		<span class="mh">0x1fee0</span><span class="p">,</span> <span class="mh">0x1fee0</span><span class="p">,</span>
		<span class="mh">0x1ff00</span><span class="p">,</span> <span class="mh">0x1ff84</span><span class="p">,</span>
		<span class="mh">0x1ffc0</span><span class="p">,</span> <span class="mh">0x1ffc8</span><span class="p">,</span>
		<span class="mh">0x20000</span><span class="p">,</span> <span class="mh">0x2002c</span><span class="p">,</span>
		<span class="mh">0x20100</span><span class="p">,</span> <span class="mh">0x2013c</span><span class="p">,</span>
		<span class="mh">0x20190</span><span class="p">,</span> <span class="mh">0x201c8</span><span class="p">,</span>
		<span class="mh">0x20200</span><span class="p">,</span> <span class="mh">0x20318</span><span class="p">,</span>
		<span class="mh">0x20400</span><span class="p">,</span> <span class="mh">0x20528</span><span class="p">,</span>
		<span class="mh">0x20540</span><span class="p">,</span> <span class="mh">0x20614</span><span class="p">,</span>
		<span class="mh">0x21000</span><span class="p">,</span> <span class="mh">0x21040</span><span class="p">,</span>
		<span class="mh">0x2104c</span><span class="p">,</span> <span class="mh">0x21060</span><span class="p">,</span>
		<span class="mh">0x210c0</span><span class="p">,</span> <span class="mh">0x210ec</span><span class="p">,</span>
		<span class="mh">0x21200</span><span class="p">,</span> <span class="mh">0x21268</span><span class="p">,</span>
		<span class="mh">0x21270</span><span class="p">,</span> <span class="mh">0x21284</span><span class="p">,</span>
		<span class="mh">0x212fc</span><span class="p">,</span> <span class="mh">0x21388</span><span class="p">,</span>
		<span class="mh">0x21400</span><span class="p">,</span> <span class="mh">0x21404</span><span class="p">,</span>
		<span class="mh">0x21500</span><span class="p">,</span> <span class="mh">0x21518</span><span class="p">,</span>
		<span class="mh">0x2152c</span><span class="p">,</span> <span class="mh">0x2153c</span><span class="p">,</span>
		<span class="mh">0x21550</span><span class="p">,</span> <span class="mh">0x21554</span><span class="p">,</span>
		<span class="mh">0x21600</span><span class="p">,</span> <span class="mh">0x21600</span><span class="p">,</span>
		<span class="mh">0x21608</span><span class="p">,</span> <span class="mh">0x21628</span><span class="p">,</span>
		<span class="mh">0x21630</span><span class="p">,</span> <span class="mh">0x2163c</span><span class="p">,</span>
		<span class="mh">0x21700</span><span class="p">,</span> <span class="mh">0x2171c</span><span class="p">,</span>
		<span class="mh">0x21780</span><span class="p">,</span> <span class="mh">0x2178c</span><span class="p">,</span>
		<span class="mh">0x21800</span><span class="p">,</span> <span class="mh">0x21c38</span><span class="p">,</span>
		<span class="mh">0x21c80</span><span class="p">,</span> <span class="mh">0x21d7c</span><span class="p">,</span>
		<span class="mh">0x21e00</span><span class="p">,</span> <span class="mh">0x21e04</span><span class="p">,</span>
		<span class="mh">0x22000</span><span class="p">,</span> <span class="mh">0x2202c</span><span class="p">,</span>
		<span class="mh">0x22100</span><span class="p">,</span> <span class="mh">0x2213c</span><span class="p">,</span>
		<span class="mh">0x22190</span><span class="p">,</span> <span class="mh">0x221c8</span><span class="p">,</span>
		<span class="mh">0x22200</span><span class="p">,</span> <span class="mh">0x22318</span><span class="p">,</span>
		<span class="mh">0x22400</span><span class="p">,</span> <span class="mh">0x22528</span><span class="p">,</span>
		<span class="mh">0x22540</span><span class="p">,</span> <span class="mh">0x22614</span><span class="p">,</span>
		<span class="mh">0x23000</span><span class="p">,</span> <span class="mh">0x23040</span><span class="p">,</span>
		<span class="mh">0x2304c</span><span class="p">,</span> <span class="mh">0x23060</span><span class="p">,</span>
		<span class="mh">0x230c0</span><span class="p">,</span> <span class="mh">0x230ec</span><span class="p">,</span>
		<span class="mh">0x23200</span><span class="p">,</span> <span class="mh">0x23268</span><span class="p">,</span>
		<span class="mh">0x23270</span><span class="p">,</span> <span class="mh">0x23284</span><span class="p">,</span>
		<span class="mh">0x232fc</span><span class="p">,</span> <span class="mh">0x23388</span><span class="p">,</span>
		<span class="mh">0x23400</span><span class="p">,</span> <span class="mh">0x23404</span><span class="p">,</span>
		<span class="mh">0x23500</span><span class="p">,</span> <span class="mh">0x23518</span><span class="p">,</span>
		<span class="mh">0x2352c</span><span class="p">,</span> <span class="mh">0x2353c</span><span class="p">,</span>
		<span class="mh">0x23550</span><span class="p">,</span> <span class="mh">0x23554</span><span class="p">,</span>
		<span class="mh">0x23600</span><span class="p">,</span> <span class="mh">0x23600</span><span class="p">,</span>
		<span class="mh">0x23608</span><span class="p">,</span> <span class="mh">0x23628</span><span class="p">,</span>
		<span class="mh">0x23630</span><span class="p">,</span> <span class="mh">0x2363c</span><span class="p">,</span>
		<span class="mh">0x23700</span><span class="p">,</span> <span class="mh">0x2371c</span><span class="p">,</span>
		<span class="mh">0x23780</span><span class="p">,</span> <span class="mh">0x2378c</span><span class="p">,</span>
		<span class="mh">0x23800</span><span class="p">,</span> <span class="mh">0x23c38</span><span class="p">,</span>
		<span class="mh">0x23c80</span><span class="p">,</span> <span class="mh">0x23d7c</span><span class="p">,</span>
		<span class="mh">0x23e00</span><span class="p">,</span> <span class="mh">0x23e04</span><span class="p">,</span>
		<span class="mh">0x24000</span><span class="p">,</span> <span class="mh">0x2402c</span><span class="p">,</span>
		<span class="mh">0x24100</span><span class="p">,</span> <span class="mh">0x2413c</span><span class="p">,</span>
		<span class="mh">0x24190</span><span class="p">,</span> <span class="mh">0x241c8</span><span class="p">,</span>
		<span class="mh">0x24200</span><span class="p">,</span> <span class="mh">0x24318</span><span class="p">,</span>
		<span class="mh">0x24400</span><span class="p">,</span> <span class="mh">0x24528</span><span class="p">,</span>
		<span class="mh">0x24540</span><span class="p">,</span> <span class="mh">0x24614</span><span class="p">,</span>
		<span class="mh">0x25000</span><span class="p">,</span> <span class="mh">0x25040</span><span class="p">,</span>
		<span class="mh">0x2504c</span><span class="p">,</span> <span class="mh">0x25060</span><span class="p">,</span>
		<span class="mh">0x250c0</span><span class="p">,</span> <span class="mh">0x250ec</span><span class="p">,</span>
		<span class="mh">0x25200</span><span class="p">,</span> <span class="mh">0x25268</span><span class="p">,</span>
		<span class="mh">0x25270</span><span class="p">,</span> <span class="mh">0x25284</span><span class="p">,</span>
		<span class="mh">0x252fc</span><span class="p">,</span> <span class="mh">0x25388</span><span class="p">,</span>
		<span class="mh">0x25400</span><span class="p">,</span> <span class="mh">0x25404</span><span class="p">,</span>
		<span class="mh">0x25500</span><span class="p">,</span> <span class="mh">0x25518</span><span class="p">,</span>
		<span class="mh">0x2552c</span><span class="p">,</span> <span class="mh">0x2553c</span><span class="p">,</span>
		<span class="mh">0x25550</span><span class="p">,</span> <span class="mh">0x25554</span><span class="p">,</span>
		<span class="mh">0x25600</span><span class="p">,</span> <span class="mh">0x25600</span><span class="p">,</span>
		<span class="mh">0x25608</span><span class="p">,</span> <span class="mh">0x25628</span><span class="p">,</span>
		<span class="mh">0x25630</span><span class="p">,</span> <span class="mh">0x2563c</span><span class="p">,</span>
		<span class="mh">0x25700</span><span class="p">,</span> <span class="mh">0x2571c</span><span class="p">,</span>
		<span class="mh">0x25780</span><span class="p">,</span> <span class="mh">0x2578c</span><span class="p">,</span>
		<span class="mh">0x25800</span><span class="p">,</span> <span class="mh">0x25c38</span><span class="p">,</span>
		<span class="mh">0x25c80</span><span class="p">,</span> <span class="mh">0x25d7c</span><span class="p">,</span>
		<span class="mh">0x25e00</span><span class="p">,</span> <span class="mh">0x25e04</span><span class="p">,</span>
		<span class="mh">0x26000</span><span class="p">,</span> <span class="mh">0x2602c</span><span class="p">,</span>
		<span class="mh">0x26100</span><span class="p">,</span> <span class="mh">0x2613c</span><span class="p">,</span>
		<span class="mh">0x26190</span><span class="p">,</span> <span class="mh">0x261c8</span><span class="p">,</span>
		<span class="mh">0x26200</span><span class="p">,</span> <span class="mh">0x26318</span><span class="p">,</span>
		<span class="mh">0x26400</span><span class="p">,</span> <span class="mh">0x26528</span><span class="p">,</span>
		<span class="mh">0x26540</span><span class="p">,</span> <span class="mh">0x26614</span><span class="p">,</span>
		<span class="mh">0x27000</span><span class="p">,</span> <span class="mh">0x27040</span><span class="p">,</span>
		<span class="mh">0x2704c</span><span class="p">,</span> <span class="mh">0x27060</span><span class="p">,</span>
		<span class="mh">0x270c0</span><span class="p">,</span> <span class="mh">0x270ec</span><span class="p">,</span>
		<span class="mh">0x27200</span><span class="p">,</span> <span class="mh">0x27268</span><span class="p">,</span>
		<span class="mh">0x27270</span><span class="p">,</span> <span class="mh">0x27284</span><span class="p">,</span>
		<span class="mh">0x272fc</span><span class="p">,</span> <span class="mh">0x27388</span><span class="p">,</span>
		<span class="mh">0x27400</span><span class="p">,</span> <span class="mh">0x27404</span><span class="p">,</span>
		<span class="mh">0x27500</span><span class="p">,</span> <span class="mh">0x27518</span><span class="p">,</span>
		<span class="mh">0x2752c</span><span class="p">,</span> <span class="mh">0x2753c</span><span class="p">,</span>
		<span class="mh">0x27550</span><span class="p">,</span> <span class="mh">0x27554</span><span class="p">,</span>
		<span class="mh">0x27600</span><span class="p">,</span> <span class="mh">0x27600</span><span class="p">,</span>
		<span class="mh">0x27608</span><span class="p">,</span> <span class="mh">0x27628</span><span class="p">,</span>
		<span class="mh">0x27630</span><span class="p">,</span> <span class="mh">0x2763c</span><span class="p">,</span>
		<span class="mh">0x27700</span><span class="p">,</span> <span class="mh">0x2771c</span><span class="p">,</span>
		<span class="mh">0x27780</span><span class="p">,</span> <span class="mh">0x2778c</span><span class="p">,</span>
		<span class="mh">0x27800</span><span class="p">,</span> <span class="mh">0x27c38</span><span class="p">,</span>
		<span class="mh">0x27c80</span><span class="p">,</span> <span class="mh">0x27d7c</span><span class="p">,</span>
		<span class="mh">0x27e00</span><span class="p">,</span> <span class="mh">0x27e04</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">mk_adap_vers</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T4_REGMAP_SIZE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">reg_ranges</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">reg_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">reg_ranges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">restart_autoneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">t4_restart_aneg</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">identify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ETHTOOL_ID_ACTIVE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ETHTOOL_ID_INACTIVE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">t4_identify_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">netdev2pinfo</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">from_fw_linkcaps</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BT_SGMII</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BT_XFI</span> <span class="o">||</span>
	    <span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BT_XAUI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_TP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_100M</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_1G</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_10G</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_KX4</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_KX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_Backplane</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_1G</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseKX_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_10G</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_10000baseKX4_Full</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_KR</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_Backplane</span> <span class="o">|</span> <span class="n">SUPPORTED_10000baseKR_Full</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BP_AP</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_Backplane</span> <span class="o">|</span> <span class="n">SUPPORTED_10000baseR_FEC</span> <span class="o">|</span>
		     <span class="n">SUPPORTED_10000baseKR_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_1000baseKX_Full</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BP4_AP</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_Backplane</span> <span class="o">|</span> <span class="n">SUPPORTED_10000baseR_FEC</span> <span class="o">|</span>
		     <span class="n">SUPPORTED_10000baseKR_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_1000baseKX_Full</span> <span class="o">|</span>
		     <span class="n">SUPPORTED_10000baseKX4_Full</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_FIBER_XFI</span> <span class="o">||</span>
		 <span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_FIBER_XAUI</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_SFP</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_ANEG</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">to_fw_linkcaps</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">FW_PORT_CAP_SPEED_100M</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">FW_PORT_CAP_SPEED_1G</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">FW_PORT_CAP_SPEED_10G</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BT_SGMII</span> <span class="o">||</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BT_XFI</span> <span class="o">||</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BT_XAUI</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_FIBER_XFI</span> <span class="o">||</span>
		 <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_FIBER_XAUI</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_SFP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mod_type</span> <span class="o">==</span> <span class="n">FW_PORT_MOD_TYPE_TWINAX_PASSIVE</span> <span class="o">||</span>
		    <span class="n">p</span><span class="o">-&gt;</span><span class="n">mod_type</span> <span class="o">==</span> <span class="n">FW_PORT_MOD_TYPE_TWINAX_ACTIVE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_DA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_OTHER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mdio_addr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mdio_addr</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mdio_support</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FW_PORT_TYPE_BT_SGMII</span> <span class="o">?</span>
			<span class="n">MDIO_SUPPORTS_C22</span> <span class="o">:</span> <span class="n">MDIO_SUPPORTS_C45</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* not really, but no better option */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mdio_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">from_fw_linkcaps</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">supported</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">from_fw_linkcaps</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">,</span>
					    <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">advertising</span><span class="p">);</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
			      <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">speed_to_caps</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FW_PORT_CAP_SPEED_100M</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FW_PORT_CAP_SPEED_1G</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FW_PORT_CAP_SPEED_10G</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>     <span class="cm">/* only full-duplex supported */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_ANEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * PHY offers a single speed.  See if that&#39;s what&#39;s</span>
<span class="cm">		 * being requested.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">speed_to_caps</span><span class="p">(</span><span class="n">speed</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">speed_to_caps</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">cap</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">to_fw_linkcaps</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">cap</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">cap</span> <span class="o">|</span> <span class="n">FW_PORT_CAP_ANEG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">t4_link_start</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span>
				     <span class="n">lc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_AUTONEG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_RX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_TX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_ANEG</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">=</span> <span class="n">PAUSE_AUTONEG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">|=</span> <span class="n">PAUSE_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">|=</span> <span class="n">PAUSE_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">t4_link_start</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span>
				     <span class="n">lc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_sge_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_BUFFERS</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_mini_max_pending</span> <span class="o">=</span> <span class="n">MAX_RSPQ_ENTRIES</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_max_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">MAX_TXQ_ENTRIES</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">].</span><span class="n">fl</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">].</span><span class="n">rspq</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_sge_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">MAX_RX_BUFFERS</span> <span class="o">||</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">MAX_TXQ_ENTRIES</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">&gt;</span> <span class="n">MAX_RSPQ_ENTRIES</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">&lt;</span> <span class="n">MIN_RSPQ_ENTRIES</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&lt;</span> <span class="n">MIN_FL_ENTRIES</span> <span class="o">||</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;</span> <span class="n">MIN_TXQ_ENTRIES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">fl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">rspq</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">closest_timer</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min_delta</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">timer_val</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">timer_val</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="n">min_delta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">min_delta</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span>
			<span class="n">match</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">match</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">closest_thres</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">thres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min_delta</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">counter_val</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">thres</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">counter_val</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="n">min_delta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">min_delta</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span>
			<span class="n">match</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">match</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a queue&#39;s interrupt hold-off time in us.  0 means no timer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qtimer_val</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">intr_params</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SGE_NTIMERS</span> <span class="o">?</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">timer_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	set_rxq_intr_params - set a queue&#39;s interrupt holdoff parameters</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@q: the Rx queue</span>
<span class="cm"> *	@us: the hold-off time in us, or 0 to disable timer</span>
<span class="cm"> *	@cnt: the hold-off packet count, or 0 to disable counter</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets an Rx queue&#39;s interrupt hold-off time and packet count.  At least</span>
<span class="cm"> *	one of the two needs to be enabled for the queue to generate interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rxq_intr_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">us</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">us</span> <span class="o">|</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">new_idx</span><span class="p">;</span>

		<span class="n">new_idx</span> <span class="o">=</span> <span class="n">closest_thres</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">pktcnt_idx</span> <span class="o">!=</span> <span class="n">new_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the queue has already been created, update it */</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">FW_PARAMS_MNEM</span><span class="p">(</span><span class="n">FW_PARAMS_MNEM_DMAQ</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_PARAMS_PARAM_X</span><span class="p">(</span><span class="n">FW_PARAMS_PARAM_DMAQ_IQ_INTCNTTHRESH</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">FW_PARAMS_PARAM_YZ</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">cntxt_id</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t4_set_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">new_idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">pktcnt_idx</span> <span class="o">=</span> <span class="n">new_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">us</span> <span class="o">=</span> <span class="n">us</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="n">closest_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">intr_params</span> <span class="o">=</span> <span class="n">QINTR_TIMER_IDX</span><span class="p">(</span><span class="n">us</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">QINTR_CNT_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_rxq_intr_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">].</span><span class="n">rspq</span><span class="p">,</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">].</span><span class="n">rspq</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">qtimer_val</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">intr_params</span> <span class="o">&amp;</span> <span class="n">QINTR_CNT_EN</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">counter_val</span><span class="p">[</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">pktcnt_idx</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	eeprom_ptov - translate a physical EEPROM address to virtual</span>
<span class="cm"> *	@phys_addr: the physical EEPROM address</span>
<span class="cm"> *	@fn: the PCI function number</span>
<span class="cm"> *	@sz: size of function-specific area</span>
<span class="cm"> *</span>
<span class="cm"> *	Translate a physical EEPROM address to virtual.  The first 1K is</span>
<span class="cm"> *	accessed through virtual addresses starting at 31K, the rest is</span>
<span class="cm"> *	accessed through virtual addresses starting at 0.</span>
<span class="cm"> *</span>
<span class="cm"> *	The mapping is as follows:</span>
<span class="cm"> *	[0..1K) -&gt; [31K..32K)</span>
<span class="cm"> *	[1K..1K+A) -&gt; [31K-A..31K)</span>
<span class="cm"> *	[1K+A..ES) -&gt; [0..ES-A-1K)</span>
<span class="cm"> *</span>
<span class="cm"> *	where A = @fn * @sz, and ES = EEPROM size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_ptov</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fn</span> <span class="o">*=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys_addr</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phys_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">31</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys_addr</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">31744</span> <span class="o">-</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">phys_addr</span> <span class="o">-</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys_addr</span> <span class="o">&lt;</span> <span class="n">EEPROMSIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phys_addr</span> <span class="o">-</span> <span class="mi">1024</span> <span class="o">-</span> <span class="n">fn</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The next two routines implement eeprom read/write from physical addresses.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_rd_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vaddr</span> <span class="o">=</span> <span class="n">eeprom_ptov</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">EEPROMPFSIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vaddr</span> <span class="o">=</span> <span class="n">pci_read_vpd</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vaddr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">vaddr</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_wr_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vaddr</span> <span class="o">=</span> <span class="n">eeprom_ptov</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">EEPROMPFSIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vaddr</span> <span class="o">=</span> <span class="n">pci_write_vpd</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vaddr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">vaddr</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EEPROM_MAGIC 0x38E2F10C</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">EEPROMSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">EEPROM_MAGIC</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span> <span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">eeprom_rd_phys</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aligned_offset</span><span class="p">,</span> <span class="n">aligned_len</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">EEPROM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aligned_offset</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">aligned_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">*</span> <span class="n">EEPROMPFSIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aligned_offset</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">||</span>
		    <span class="n">aligned_offset</span> <span class="o">+</span> <span class="n">aligned_len</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">+</span> <span class="n">EEPROMPFSIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aligned_offset</span> <span class="o">!=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">||</span> <span class="n">aligned_len</span> <span class="o">!=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * RMW possibly needed for first or last words.</span>
<span class="cm">		 */</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">aligned_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">eeprom_rd_phys</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">aligned_offset</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">aligned_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">eeprom_rd_phys</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					     <span class="n">aligned_offset</span> <span class="o">+</span> <span class="n">aligned_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">aligned_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t4_seeprom_wp</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span> <span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">aligned_len</span><span class="p">;</span> <span class="n">aligned_len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">eeprom_wr_phys</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">aligned_offset</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
		<span class="n">aligned_offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_seeprom_wp</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">data</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_flash</span> <span class="o">*</span><span class="n">ef</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ef</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ef</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">ef</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_load_fw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;loaded firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ef</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WOL_SUPPORTED (WAKE_BCAST | WAKE_MAGIC)</span>
<span class="cp">#define BCAST_CRC 0xa0ccc1a6</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_BCAST</span> <span class="o">|</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WOL_SUPPORTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">t4_wol_magic_enable</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_BCAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_wol_pat_enable</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">,</span>
					<span class="o">~</span><span class="mi">0ULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t4_wol_pat_enable</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="o">~</span><span class="mi">6ULL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">,</span> <span class="n">BCAST_CRC</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">t4_wol_pat_enable</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t4_set_rxmode</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			    <span class="o">!!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_rss_table_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_rss_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
		<span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rss_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">write_rss</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_rxnfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="o">*</span><span class="n">rules</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXFH</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_mode</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TCP_V4_FLOW</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP4FOURTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span> <span class="o">|</span>
					     <span class="n">RXH_L4_B_0_1</span> <span class="o">|</span> <span class="n">RXH_L4_B_2_3</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP4TWOTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UDP_V4_FLOW</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP4FOURTUPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_UDPEN</span><span class="p">))</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span> <span class="o">|</span>
					     <span class="n">RXH_L4_B_0_1</span> <span class="o">|</span> <span class="n">RXH_L4_B_2_3</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP4TWOTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCTP_V4_FLOW</span>:
		<span class="k">case</span> <span class="n">AH_ESP_V4_FLOW</span>:
		<span class="k">case</span> <span class="n">IPV4_FLOW</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP4TWOTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCP_V6_FLOW</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP6FOURTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span> <span class="o">|</span>
					     <span class="n">RXH_L4_B_0_1</span> <span class="o">|</span> <span class="n">RXH_L4_B_2_3</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP6TWOTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UDP_V6_FLOW</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP6FOURTUPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_UDPEN</span><span class="p">))</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span> <span class="o">|</span>
					     <span class="n">RXH_L4_B_0_1</span> <span class="o">|</span> <span class="n">RXH_L4_B_2_3</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP6TWOTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCTP_V6_FLOW</span>:
		<span class="k">case</span> <span class="n">AH_ESP_V6_FLOW</span>:
		<span class="k">case</span> <span class="n">IPV6_FLOW</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">FW_RSS_VI_CONFIG_CMD_IP6TWOTUPEN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">RXH_IP_SRC</span> <span class="o">|</span> <span class="n">RXH_IP_DST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXRINGS</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">cxgb_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>      <span class="o">=</span> <span class="n">get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>      <span class="o">=</span> <span class="n">set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>       <span class="o">=</span> <span class="n">get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>      <span class="o">=</span> <span class="n">get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>      <span class="o">=</span> <span class="n">set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>     <span class="o">=</span> <span class="n">get_sge_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>     <span class="o">=</span> <span class="n">set_sge_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span>      <span class="o">=</span> <span class="n">get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span>      <span class="o">=</span> <span class="n">set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>    <span class="o">=</span> <span class="n">get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>        <span class="o">=</span> <span class="n">get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>        <span class="o">=</span> <span class="n">set_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span>    <span class="o">=</span> <span class="n">get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span>    <span class="o">=</span> <span class="n">set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>          <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>       <span class="o">=</span> <span class="n">get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span>       <span class="o">=</span> <span class="n">identify_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>        <span class="o">=</span> <span class="n">restart_autoneg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>    <span class="o">=</span> <span class="n">get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>      <span class="o">=</span> <span class="n">get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>          <span class="o">=</span> <span class="n">get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>           <span class="o">=</span> <span class="n">get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>           <span class="o">=</span> <span class="n">set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxnfc</span>         <span class="o">=</span> <span class="n">get_rxnfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxfh_indir_size</span> <span class="o">=</span> <span class="n">get_rss_table_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxfh_indir</span>    <span class="o">=</span> <span class="n">get_rss_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rxfh_indir</span>    <span class="o">=</span> <span class="n">set_rss_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flash_device</span>      <span class="o">=</span> <span class="n">set_flash</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * debugfs support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mem_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">avail</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">-</span> <span class="n">mem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">avail</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ofst</span><span class="p">;</span>
		<span class="n">__be32</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="n">MEM_MC</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_mc_read</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_edc_read</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ofst</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">ofst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">+</span> <span class="n">ofst</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mem_debugfs_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">mem_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">add_debugfs_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size_mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>

	<span class="n">de</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adap</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_debugfs_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de</span> <span class="o">&amp;&amp;</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="n">de</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="n">size_mb</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">setup_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MA_TARGET_MEM_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">EDRAM0_ENABLE</span><span class="p">)</span>
		<span class="n">add_debugfs_mem</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;edc0&quot;</span><span class="p">,</span> <span class="n">MEM_EDC0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">EDRAM1_ENABLE</span><span class="p">)</span>
		<span class="n">add_debugfs_mem</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;edc1&quot;</span><span class="p">,</span> <span class="n">MEM_EDC1</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">EXT_MEM_ENABLE</span><span class="p">)</span>
		<span class="n">add_debugfs_mem</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;mc&quot;</span><span class="p">,</span> <span class="n">MEM_MC</span><span class="p">,</span>
			<span class="n">EXT_MEM_SIZE_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MA_EXT_MEMORY_BAR</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;l2t&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">adap</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">t4_l2t_fops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * upper-layer driver support</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate an active-open TID and set it to the supplied value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cxgb4_alloc_atid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">atid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">afree</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">aopen_entry</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">afree</span><span class="p">;</span>

		<span class="n">atid</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">afree</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">atids_in_use</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">atid</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_alloc_atid</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Release an active-open TID.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cxgb4_free_atid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">aopen_entry</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span><span class="p">[</span><span class="n">atid</span><span class="p">];</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_lock</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">afree</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">afree</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">atids_in_use</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_free_atid</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a server TID and set it to the supplied value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cxgb4_alloc_stid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stid</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">PF_INET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stid</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_bmap</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nstids</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stid</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nstids</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">stid</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_bmap</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stid</span> <span class="o">=</span> <span class="n">bitmap_find_free_region</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_bmap</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nstids</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">stid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_tab</span><span class="p">[</span><span class="n">stid</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">stid</span> <span class="o">+=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_base</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">stids_in_use</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">stid</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_alloc_stid</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Release a server TID.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cxgb4_free_stid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stid</span> <span class="o">-=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_base</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">PF_INET</span><span class="p">)</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">stid</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_bmap</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bitmap_release_region</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_bmap</span><span class="p">,</span> <span class="n">stid</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_tab</span><span class="p">[</span><span class="n">stid</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">stids_in_use</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_free_stid</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Populate a TID_RELEASE WR.  Caller must properly size the skb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mk_tid_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_tid_release</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tid_release</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_TID_RELEASE</span><span class="p">,</span> <span class="n">tid</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queue a TID release request and if necessary schedule a work queue to</span>
<span class="cm"> * process it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb4_queue_tid_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tid_tab</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">tids</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_head</span><span class="p">;</span>
	<span class="cm">/* Low 2 bits encode the Tx channel number */</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_head</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">p</span> <span class="o">|</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_task_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_task_busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process the list of pending TID release requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_tid_release_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>

	<span class="n">adap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">tid_release_task</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_head</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="n">chan</span><span class="p">;</span>

		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_head</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_lock</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tid_release</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">)))</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">mk_tid_release</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">tid_tab</span><span class="p">);</span>
		<span class="n">t4_ofld_send</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_task_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tid_release_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release a TID and inform HW.  If we are unable to allocate the release</span>
<span class="cm"> * message we defer to a work queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cxgb4_remove_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">tids</span><span class="p">);</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tid_tab</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tid_release</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">tid_tab</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mk_tid_release</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">t4_ofld_send</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cxgb4_queue_tid_release</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tids_in_use</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_remove_tid</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate and initialize the TID tables.  Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tid_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">natids</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">natids</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ntids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tid_tab</span><span class="p">)</span> <span class="o">+</span> <span class="n">natids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">t</span><span class="o">-&gt;</span><span class="n">nstids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_tab</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">nstids</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tid_tab</span> <span class="o">=</span> <span class="n">t4_alloc_mem</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tid_tab</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">aopen_entry</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tid_tab</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ntids</span><span class="p">];</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_tab</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_entry</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span><span class="p">[</span><span class="n">natids</span><span class="p">];</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_bmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_tab</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">nstids</span><span class="p">];</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_lock</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">stids_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">afree</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">atids_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tids_in_use</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Setup the free list for atid_tab and clear the stid bitmap. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">natids</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">natids</span><span class="p">)</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span><span class="p">[</span><span class="n">natids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span><span class="p">[</span><span class="n">natids</span><span class="p">];</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">afree</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">atid_tab</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">stid_bmap</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nstids</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb4_create_server - create an IP server</span>
<span class="cm"> *	@dev: the device</span>
<span class="cm"> *	@stid: the server TID</span>
<span class="cm"> *	@sip: local IP address to bind server to</span>
<span class="cm"> *	@sport: the server&#39;s TCP port</span>
<span class="cm"> *	@queue: queue to direct messages from this server to</span>
<span class="cm"> *</span>
<span class="cm"> *	Create an IP server for the given port and address.</span>
<span class="cm"> *	Returns &lt;0 on error and one of the %NET_XMIT_* values on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cxgb4_create_server</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stid</span><span class="p">,</span>
			<span class="n">__be32</span> <span class="n">sip</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">sport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_pass_open_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">adap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_pass_open_req</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_PASS_OPEN_REQ</span><span class="p">,</span> <span class="n">stid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">sport</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">sip</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">rxq_to_chan</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">TX_CHAN</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt1</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">CONN_POLICY_ASK</span> <span class="o">|</span>
				<span class="n">SYN_RSS_ENABLE</span> <span class="o">|</span> <span class="n">SYN_RSS_QUEUE</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t4_mgmt_tx</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_create_server</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb4_best_mtu - find the entry in the MTU table closest to an MTU</span>
<span class="cm"> *	@mtus: the HW MTU table</span>
<span class="cm"> *	@mtu: the target MTU</span>
<span class="cm"> *	@idx: index of selected entry in the MTU table</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the index and the value in the HW MTU table that is closest to</span>
<span class="cm"> *	but does not exceed @mtu, unless @mtu is smaller than any value in the</span>
<span class="cm"> *	table, in which case that smallest available value is selected.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cxgb4_best_mtu</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">mtus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtu</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NMTUS</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">mtus</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mtu</span><span class="p">)</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span>
		<span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtus</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_best_mtu</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb4_port_chan - get the HW channel of a port</span>
<span class="cm"> *	@dev: the net device for the port</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the HW Tx channel of the given port.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cxgb4_port_chan</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev2pinfo</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_port_chan</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cxgb4_dbfifo_count</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lpfifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SGE_DBFIFO_STATUS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lpfifo</span> <span class="o">?</span> <span class="n">G_LP_COUNT</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">:</span> <span class="n">G_HP_COUNT</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_dbfifo_count</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb4_port_viid - get the VI id of a port</span>
<span class="cm"> *	@dev: the net device for the port</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the VI id of the given port.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cxgb4_port_viid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev2pinfo</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_port_viid</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb4_port_idx - get the index of a port</span>
<span class="cm"> *	@dev: the net device for the port</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the index of the given port.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cxgb4_port_idx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev2pinfo</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_port_idx</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgb4_get_tcp_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tp_tcp_stats</span> <span class="o">*</span><span class="n">v4</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">tp_tcp_stats</span> <span class="o">*</span><span class="n">v6</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
	<span class="n">t4_tp_get_tcp_stats</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v6</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_get_tcp_stats</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgb4_iscsi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag_mask</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pgsz_order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ULP_RX_ISCSI_TAGMASK</span><span class="p">,</span> <span class="n">tag_mask</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ULP_RX_ISCSI_PSZ</span><span class="p">,</span> <span class="n">HPZ0</span><span class="p">(</span><span class="n">pgsz_order</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
		     <span class="n">HPZ1</span><span class="p">(</span><span class="n">pgsz_order</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">|</span> <span class="n">HPZ2</span><span class="p">(</span><span class="n">pgsz_order</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">|</span>
		     <span class="n">HPZ3</span><span class="p">(</span><span class="n">pgsz_order</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_iscsi_init</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgb4_flush_eq_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_fwaddrspace_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">,</span>
				   <span class="mh">0xe1000000</span> <span class="o">+</span> <span class="n">A_SGE_CTXT_CMD</span><span class="p">,</span> <span class="mh">0x20000000</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_flush_eq_cache</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_eq_indices</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pidx</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">cidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SGE_DBQ_CTXT_BADDR</span><span class="p">)</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">qid</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">indices</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_mem_win_read_len</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">indices</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">indices</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxgb4_sync_txq_pidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pidx</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">netdev2adap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">hw_pidx</span><span class="p">,</span> <span class="n">hw_cidx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_eq_indices</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_pidx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_cidx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">!=</span> <span class="n">hw_pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">delta</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">&gt;=</span> <span class="n">hw_pidx</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">pidx</span> <span class="o">-</span> <span class="n">hw_pidx</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">hw_pidx</span> <span class="o">+</span> <span class="n">pidx</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">A_SGE_PF_KDOORBELL</span><span class="p">),</span>
			     <span class="n">V_QID</span><span class="p">(</span><span class="n">qid</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PIDX</span><span class="p">(</span><span class="n">delta</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_sync_txq_pidx</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cxgb4_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_neigh_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">neigh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span>
		<span class="n">netdev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cxgb4_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">t4_l2t_update</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span> <span class="n">neigh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netevent_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETEVENT_NEIGH_UPDATE</span>:
		<span class="n">check_neigh_update</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETEVENT_REDIRECT</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">netevent_registered</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">cxgb4_netevent_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">netevent_cb</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_db_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">usecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">usecs</span><span class="p">));</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SGE_DBFIFO_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">G_LP_COUNT</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">G_HP_COUNT</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_txq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">sge_txq</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_lock</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">db_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_txq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">sge_txq</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_lock</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">db_disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_dbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_ethrxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">disable_txq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
	<span class="n">for_each_ofldrxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">disable_txq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ofldtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">disable_txq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ctrlq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_dbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_ethrxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">enable_txq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
	<span class="n">for_each_ofldrxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">enable_txq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ofldtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">enable_txq_db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ctrlq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_txq_pidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sge_txq</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">hw_pidx</span><span class="p">,</span> <span class="n">hw_cidx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_eq_indices</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">cntxt_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_pidx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_cidx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_pidx</span> <span class="o">!=</span> <span class="n">hw_pidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">delta</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_pidx</span> <span class="o">&gt;=</span> <span class="n">hw_pidx</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">db_pidx</span> <span class="o">-</span> <span class="n">hw_pidx</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hw_pidx</span> <span class="o">+</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">db_pidx</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">A_SGE_PF_KDOORBELL</span><span class="p">),</span>
				<span class="n">V_QID</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">cntxt_id</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PIDX</span><span class="p">(</span><span class="n">delta</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">db_disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">db_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">CH_WARN</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;DB drop recovery failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">recover_all_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_ethrxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">sync_txq_pidx</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
	<span class="n">for_each_ofldrxq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">sync_txq_pidx</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ofldtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">sync_txq_pidx</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ctrlq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_rdma_uld</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxgb4_control</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">CXGB4_ULD_RDMA</span><span class="p">])</span>
		<span class="n">ulds</span><span class="p">[</span><span class="n">CXGB4_ULD_RDMA</span><span class="p">].</span><span class="n">control</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">CXGB4_ULD_RDMA</span><span class="p">],</span>
				<span class="n">cmd</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_db_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>

	<span class="n">adap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">db_full_task</span><span class="p">);</span>

	<span class="n">notify_rdma_uld</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">CXGB4_CONTROL_DB_FULL</span><span class="p">);</span>
	<span class="n">drain_db_fifo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">dbfifo_drain_delay</span><span class="p">);</span>
	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SGE_INT_ENABLE3</span><span class="p">,</span>
			<span class="n">F_DBFIFO_HP_INT</span> <span class="o">|</span> <span class="n">F_DBFIFO_LP_INT</span><span class="p">,</span>
			<span class="n">F_DBFIFO_HP_INT</span> <span class="o">|</span> <span class="n">F_DBFIFO_LP_INT</span><span class="p">);</span>
	<span class="n">notify_rdma_uld</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">CXGB4_CONTROL_DB_EMPTY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_db_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>

	<span class="n">adap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">db_drop_task</span><span class="p">);</span>

	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SGE_DOORBELL_CONTROL</span><span class="p">,</span> <span class="n">F_DROPPED_DB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">disable_dbs</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">notify_rdma_uld</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">CXGB4_CONTROL_DB_DROP</span><span class="p">);</span>
	<span class="n">drain_db_fifo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">recover_all_queues</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">enable_dbs</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t4_db_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SGE_INT_ENABLE3</span><span class="p">,</span>
			<span class="n">F_DBFIFO_HP_INT</span> <span class="o">|</span> <span class="n">F_DBFIFO_LP_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">db_full_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t4_db_dropped</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">db_drop_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uld_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="n">lli</span><span class="p">;</span>

	<span class="n">lli</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">tids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">ports</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">vr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">mtus</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mtus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uld</span> <span class="o">==</span> <span class="n">CXGB4_ULD_RDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli</span><span class="p">.</span><span class="n">rxq_ids</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">rdma_rxq</span><span class="p">;</span>
		<span class="n">lli</span><span class="p">.</span><span class="n">nrxq</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">rdmaqs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uld</span> <span class="o">==</span> <span class="n">CXGB4_ULD_ISCSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli</span><span class="p">.</span><span class="n">rxq_ids</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ofld_rxq</span><span class="p">;</span>
		<span class="n">lli</span><span class="p">.</span><span class="n">nrxq</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ofldqsets</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">ntxq</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ofldqsets</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">nports</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">wr_cred</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ofldq_wr_cred</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">iscsi_iolen</span> <span class="o">=</span> <span class="n">MAXRXDATA_GET</span><span class="p">(</span><span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_PARA_REG2</span><span class="p">));</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">udb_density</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">QUEUESPERPAGEPF0_GET</span><span class="p">(</span>
			<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">SGE_EGRESS_QUEUES_PER_PAGE_PF</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">ucq_density</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">QUEUESPERPAGEPF0_GET</span><span class="p">(</span>
			<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">SGE_INGRESS_QUEUES_PER_PAGE_PF</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">gts_reg</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">SGE_PF_GTS</span><span class="p">);</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">db_reg</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MYPF_REG</span><span class="p">(</span><span class="n">SGE_PF_KDOORBELL</span><span class="p">);</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">fw_vers</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fw_vers</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">.</span><span class="n">dbfifo_int_thresh</span> <span class="o">=</span> <span class="n">dbfifo_int_thresh</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">ulds</span><span class="p">[</span><span class="n">uld</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lli</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			 <span class="s">&quot;could not attach to the %s driver, error %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">uld_str</span><span class="p">[</span><span class="n">uld</span><span class="p">],</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">uld</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netevent_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">register_netevent_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb4_netevent_nb</span><span class="p">);</span>
		<span class="n">netevent_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">)</span>
		<span class="n">ulds</span><span class="p">[</span><span class="n">uld</span><span class="p">].</span><span class="n">state_change</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CXGB4_STATE_UP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">attach_ulds</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CXGB4_ULD_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ulds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">add</span><span class="p">)</span>
			<span class="n">uld_attach</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">detach_ulds</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CXGB4_ULD_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ulds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state_change</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					     <span class="n">CXGB4_STATE_DETACH</span><span class="p">);</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netevent_registered</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unregister_netevent_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb4_netevent_nb</span><span class="p">);</span>
		<span class="n">netevent_registered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_ulds</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxgb4_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CXGB4_ULD_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ulds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state_change</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb4_register_uld - register an upper-layer driver</span>
<span class="cm"> *	@type: the ULD type</span>
<span class="cm"> *	@p: the ULD methods</span>
<span class="cm"> *</span>
<span class="cm"> *	Registers an upper-layer driver with this driver and notifies the ULD</span>
<span class="cm"> *	about any presently available devices that support its type.  Returns</span>
<span class="cm"> *	%-EBUSY if a ULD of the same type is already registered.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cxgb4_register_uld</span><span class="p">(</span><span class="k">enum</span> <span class="n">cxgb4_uld</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cxgb4_uld_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">CXGB4_ULD_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ulds</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">add</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ulds</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span>
		<span class="n">uld_attach</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="nl">out:</span>	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_register_uld</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb4_unregister_uld - unregister an upper-layer driver</span>
<span class="cm"> *	@type: the ULD type</span>
<span class="cm"> *</span>
<span class="cm"> *	Unregisters an existing upper-layer driver.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cxgb4_unregister_uld</span><span class="p">(</span><span class="k">enum</span> <span class="n">cxgb4_uld</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">CXGB4_ULD_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">uld_handle</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ulds</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">add</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uld_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cxgb4_unregister_uld</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	cxgb_up - enable the adapter</span>
<span class="cm"> *	@adap: adapter being enabled</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when the first port is enabled, this function performs the</span>
<span class="cm"> *	actions necessary to make an adapter operational, such as completing</span>
<span class="cm"> *	the initialization of HW modules, and enabling interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> *	Must be called with the rtnl lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">setup_sge_queues</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">setup_rss</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">freeq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_msix_vecs</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="n">t4_nondata_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">irq_err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">request_msix_queue_irqs</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="n">adap</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">irq_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">t4_intr_handler</span><span class="p">(</span><span class="n">adap</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">irq_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">enable_rx</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">t4_sge_start</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">t4_intr_enable</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FULL_INIT_DONE</span><span class="p">;</span>
	<span class="n">notify_ulds</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">CXGB4_STATE_UP</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
 <span class="nl">irq_err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
 <span class="nl">freeq:</span>
	<span class="n">t4_free_sge_resources</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t4_intr_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tid_release_task</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db_full_task</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db_drop_task</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tid_release_task_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tid_release_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_msix_queue_irqs</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vec</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="n">quiesce_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">t4_sge_stop</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">t4_free_sge_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FULL_INIT_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * net_device operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cxgb_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">link_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t4_enable_vi</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="nf">cxgb_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
	<span class="n">t4_get_port_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_bytes</span>   <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">tx_octets</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">tx_frames</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_bytes</span>   <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_octets</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_frames</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">multicast</span>  <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_mcast_frames</span><span class="p">;</span>

	<span class="cm">/* detailed rx_errors */</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_jabber</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_too_long</span> <span class="o">+</span>
			       <span class="n">stats</span><span class="p">.</span><span class="n">rx_runt</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span>    <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_fcs_err</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span>  <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_symbol_err</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span>   <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_ovflow0</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_ovflow1</span> <span class="o">+</span>
			       <span class="n">stats</span><span class="p">.</span><span class="n">rx_ovflow2</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_ovflow3</span> <span class="o">+</span>
			       <span class="n">stats</span><span class="p">.</span><span class="n">rx_trunc0</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_trunc1</span> <span class="o">+</span>
			       <span class="n">stats</span><span class="p">.</span><span class="n">rx_trunc2</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_trunc3</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* detailed tx_errors */</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_heartbeat_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_window_errors</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">tx_error_frames</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_symbol_err</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_fcs_err</span> <span class="o">+</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_len_err</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prtad</span><span class="p">,</span> <span class="n">devad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mdio_addr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mdio_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:
	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mdio_phy_id_is_c45</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prtad</span> <span class="o">=</span> <span class="n">mdio_phy_id_prtad</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
			<span class="n">devad</span> <span class="o">=</span> <span class="n">mdio_phy_id_devad</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prtad</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>
			<span class="n">devad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">mbox</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCGMIIREG</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_mdio_rd</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">prtad</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span>
					 <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_mdio_wr</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">prtad</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span>
					 <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb_set_rxmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unfortunately we can&#39;t return errors to the stack */</span>
	<span class="n">set_rxmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">81</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">MAX_MTU</span><span class="p">)</span>         <span class="cm">/* accommodate SACK */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_set_rxmode</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_change_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">viid</span><span class="p">,</span>
			    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">xact_addr_filt</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">xact_addr_filt</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sge_eth_rxq</span> <span class="o">*</span><span class="n">rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">rx</span><span class="o">++</span><span class="p">)</span>
			<span class="n">t4_sge_intr_msix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">t4_intr_handler</span><span class="p">(</span><span class="n">adap</span><span class="p">)(</span><span class="mi">0</span><span class="p">,</span> <span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">cxgb4_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>             <span class="o">=</span> <span class="n">cxgb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>             <span class="o">=</span> <span class="n">cxgb_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>       <span class="o">=</span> <span class="n">t4_eth_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>      <span class="o">=</span> <span class="n">cxgb_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>      <span class="o">=</span> <span class="n">cxgb_set_rxmode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>  <span class="o">=</span> <span class="n">cxgb_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>     <span class="o">=</span> <span class="n">cxgb_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>    <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>         <span class="o">=</span> <span class="n">cxgb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>       <span class="o">=</span> <span class="n">cxgb_change_mtu</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>  <span class="o">=</span> <span class="n">cxgb_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">t4_fatal_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t4_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">SGE_CONTROL</span><span class="p">,</span> <span class="n">GLOBALENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t4_intr_disable</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">dev_alert</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;encountered fatal error, adapter stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_memwin</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bar0</span><span class="p">;</span>

	<span class="n">bar0</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* truncation intentional */</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PCIE_MEM_ACCESS_REG</span><span class="p">(</span><span class="n">PCIE_MEM_ACCESS_BASE_WIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		     <span class="p">(</span><span class="n">bar0</span> <span class="o">+</span> <span class="n">MEMWIN0_BASE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">WINDOW</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">MEMWIN0_APERTURE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PCIE_MEM_ACCESS_REG</span><span class="p">(</span><span class="n">PCIE_MEM_ACCESS_BASE_WIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		     <span class="p">(</span><span class="n">bar0</span> <span class="o">+</span> <span class="n">MEMWIN1_BASE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">WINDOW</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">MEMWIN1_APERTURE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PCIE_MEM_ACCESS_REG</span><span class="p">(</span><span class="n">PCIE_MEM_ACCESS_BASE_WIN</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
		     <span class="p">(</span><span class="n">bar0</span> <span class="o">+</span> <span class="n">MEMWIN2_BASE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">WINDOW</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">MEMWIN2_APERTURE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">ocq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">sz_kb</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">OCQ_WIN_OFFSET</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">);</span>
		<span class="n">sz_kb</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">ocq</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
			     <span class="n">PCIE_MEM_ACCESS_REG</span><span class="p">(</span><span class="n">PCIE_MEM_ACCESS_BASE_WIN</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
			     <span class="n">start</span> <span class="o">|</span> <span class="n">BIR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">WINDOW</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">sz_kb</span><span class="p">)));</span>
		<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
			     <span class="n">PCIE_MEM_ACCESS_REG</span><span class="p">(</span><span class="n">PCIE_MEM_ACCESS_OFFSET</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
			     <span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">ocq</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
		<span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
			    <span class="n">PCIE_MEM_ACCESS_REG</span><span class="p">(</span><span class="n">PCIE_MEM_ACCESS_OFFSET</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adap_init1</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_caps_config_cmd</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* get device capabilities */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">));</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">op_to_write</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_CAPS_CONFIG_CMD</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span> <span class="n">FW_CMD_READ</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">retval_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_LEN16</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* select capabilities we&#39;ll be using */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">niccaps</span> <span class="o">&amp;</span> <span class="n">htons</span><span class="p">(</span><span class="n">FW_CAPS_CONFIG_NIC_VM</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vf_acls</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">niccaps</span> <span class="o">^=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FW_CAPS_CONFIG_NIC_VM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">niccaps</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FW_CAPS_CONFIG_NIC_VM</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vf_acls</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;virtualization ACLs not supported&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">op_to_write</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_CMD_OP</span><span class="p">(</span><span class="n">FW_CAPS_CONFIG_CMD</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">FW_CMD_REQUEST</span> <span class="o">|</span> <span class="n">FW_CMD_WRITE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_wr_mbox</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_config_glbl_rss</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span>
				 <span class="n">FW_RSS_GLB_CONFIG_CMD_MODE_BASICVIRTUAL</span><span class="p">,</span>
				 <span class="n">FW_RSS_GLB_CONFIG_CMD_TNLMAPEN</span> <span class="o">|</span>
				 <span class="n">FW_RSS_GLB_CONFIG_CMD_TNLALLLKP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_cfg_pfvf</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_EGRQ</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">MAX_INGQ</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">FW_CMD_CAP_PF</span><span class="p">,</span> <span class="n">FW_CMD_CAP_PF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">t4_sge_init</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>

	<span class="cm">/* tweak some settings */</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_SHIFT_CNT</span><span class="p">,</span> <span class="mh">0x64f8849</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ULP_RX_TDDP_PSZ</span><span class="p">,</span> <span class="n">HPZ0</span><span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_PIO_ADDR</span><span class="p">,</span> <span class="n">TP_INGRESS_CONFIG</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_PIO_DATA</span><span class="p">);</span>
	<span class="n">t4_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_PIO_DATA</span><span class="p">,</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CSUM_HAS_PSEUDO_HDR</span><span class="p">);</span>

	<span class="cm">/* get basic stuff going */</span>
	<span class="k">return</span> <span class="n">t4_early_init</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Max # of ATIDs.  The absolute HW max is 16K but we keep it lower.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_ATIDS 8192U</span>

<span class="cm">/*</span>
<span class="cm"> * Phase 0 of initialization: contact FW, obtain config, perform basic init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adap_init0</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">port_vec</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dev_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">params</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">fw_caps_config_cmd</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_check_fw_version</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">upgrade_fw</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>             <span class="cm">/* recache FW version */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_check_fw_version</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* contact FW, request master */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_fw_hello</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">MASTER_MUST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;could not connect to FW, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_fw_reset</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">PIORSTMODE</span> <span class="o">|</span> <span class="n">PIORST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">SGE_NTIMERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">v</span><span class="o">++</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">timer_val</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">intr_holdoff</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">MAX_SGE_TIMERVAL</span><span class="p">);</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">timer_val</span><span class="p">[</span><span class="n">SGE_NTIMERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_SGE_TIMERVAL</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">counter_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">SGE_NCOUNTERS</span><span class="p">;</span> <span class="n">v</span><span class="o">++</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">counter_val</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">intr_cnt</span><span class="p">[</span><span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
					       <span class="n">THRESHOLD_3_MASK</span><span class="p">);</span>
<span class="cp">#define FW_PARAM_DEV(param) \</span>
<span class="cp">	(FW_PARAMS_MNEM(FW_PARAMS_MNEM_DEV) | \</span>
<span class="cp">	 FW_PARAMS_PARAM_X(FW_PARAMS_PARAM_DEV_##param))</span>

	<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_DEV</span><span class="p">(</span><span class="n">CCLK</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_query_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">cclk</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">adap_init1</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>

<span class="cp">#define FW_PARAM_PFVF(param) \</span>
<span class="cp">	(FW_PARAMS_MNEM(FW_PARAMS_MNEM_PFVF) | \</span>
<span class="cp">	 FW_PARAMS_PARAM_X(FW_PARAMS_PARAM_PFVF_##param) | \</span>
<span class="cp">	 FW_PARAMS_PARAM_Y(adap-&gt;fn))</span>

	<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_DEV</span><span class="p">(</span><span class="n">PORTVEC</span><span class="p">);</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">L2T_START</span><span class="p">);</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">L2T_END</span><span class="p">);</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">FILTER_START</span><span class="p">);</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">FILTER_END</span><span class="p">);</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">IQFLINT_START</span><span class="p">);</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">EQ_START</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_query_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>
	<span class="n">port_vec</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">ftid_base</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">nftids</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ingr_start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">egr_start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">ofldcaps</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* query offload-related parameters */</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_DEV</span><span class="p">(</span><span class="n">NTID</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">SERVER_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">SERVER_END</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">TDDP_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">TDDP_END</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_DEV</span><span class="p">(</span><span class="n">FLOWC_BUFFIFO_SZ</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_query_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
				      <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">ntids</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">natids</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">ntids</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MAX_ATIDS</span><span class="p">);</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">stid_base</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">nstids</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">ddp</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">ddp</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ofldq_wr_cred</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">offload</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rdmacaps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">STAG_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">STAG_END</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">RQ_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">RQ_END</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">PBL_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">PBL_END</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_query_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
				      <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">stag</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">rq</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">pbl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">SQRQ_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">SQRQ_END</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">CQ_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">CQ_END</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">OCQ_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">OCQ_END</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_query_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
				      <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">qp</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">qp</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">ocq</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">ocq</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">iscsicaps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">ISCSI_START</span><span class="p">);</span>
		<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FW_PARAM_PFVF</span><span class="p">(</span><span class="n">ISCSI_END</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_query_params</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
				      <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bye</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">iscsi</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">vres</span><span class="p">.</span><span class="n">iscsi</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#undef FW_PARAM_PFVF</span>
<span class="cp">#undef FW_PARAM_DEV</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">=</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">port_vec</span><span class="p">);</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">portvec</span> <span class="o">=</span> <span class="n">port_vec</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FW_OK</span><span class="p">;</span>

	<span class="cm">/* These are finalized by FW initialization, load their values now */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">t4_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TP_TIMER_RESOLUTION</span><span class="p">);</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp</span><span class="p">.</span><span class="n">tre</span> <span class="o">=</span> <span class="n">TIMERRESOLUTION_GET</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="n">t4_read_mtu_tbl</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mtus</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">t4_load_mtus</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mtus</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">a_wnd</span><span class="p">,</span>
		     <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">b_wnd</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_IOV</span>
	<span class="cm">/*</span>
<span class="cm">	 * Provision resource limits for Virtual Functions.  We currently</span>
<span class="cm">	 * grant them all the same static resource limits except for the Port</span>
<span class="cm">	 * Access Rights Mask which we&#39;re assigning based on the PF.  All of</span>
<span class="cm">	 * the static provisioning stuff for both the PF and VF really needs</span>
<span class="cm">	 * to be managed in a persistent manner for each device which the</span>
<span class="cm">	 * firmware controls.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pf</span><span class="p">,</span> <span class="n">vf</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">pf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pf</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">num_vf</span><span class="p">);</span> <span class="n">pf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num_vf</span><span class="p">[</span><span class="n">pf</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* VF numbering starts at 1! */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">vf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">vf</span> <span class="o">&lt;=</span> <span class="n">num_vf</span><span class="p">[</span><span class="n">pf</span><span class="p">];</span> <span class="n">vf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_cfg_pfvf</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span>
						  <span class="n">VFRES_NEQ</span><span class="p">,</span> <span class="n">VFRES_NETHCTRL</span><span class="p">,</span>
						  <span class="n">VFRES_NIQFLINT</span><span class="p">,</span> <span class="n">VFRES_NIQ</span><span class="p">,</span>
						  <span class="n">VFRES_TC</span><span class="p">,</span> <span class="n">VFRES_NVI</span><span class="p">,</span>
						  <span class="n">FW_PFVF_CMD_CMASK_MASK</span><span class="p">,</span>
						  <span class="n">pfvfres_pmask</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">vf</span><span class="p">),</span>
						  <span class="n">VFRES_NEXACTF</span><span class="p">,</span>
						  <span class="n">VFRES_R_CAPS</span><span class="p">,</span> <span class="n">VFRES_WX_CAPS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span> <span class="s">&quot;failed to &quot;</span>
						 <span class="s">&quot;provision pf/vf=%d/%d; &quot;</span>
						 <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">setup_memwin</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a command timed out or failed with EIO FW does not operate within</span>
<span class="cm">	 * its spec or something catastrophic happened to HW/FW, stop issuing</span>
<span class="cm">	 * commands.</span>
<span class="cm">	 */</span>
<span class="nl">bye:</span>	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="n">t4_fw_bye</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* EEH callbacks */</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">eeh_err_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_OK</span><span class="p">;</span>
	<span class="n">notify_ulds</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">CXGB4_STATE_START_RECOVERY</span><span class="p">);</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">)</span>
		<span class="n">cxgb_down</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out:</span>	<span class="k">return</span> <span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span> <span class="o">?</span>
		<span class="n">PCI_ERS_RESULT_DISCONNECT</span> <span class="o">:</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">eeh_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_caps_config_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot reenable PCI device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t4_wait_dev_ready</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t4_fw_hello</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">MASTER_MUST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FW_OK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap_init1</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">t4_alloc_vi</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">viid</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xact_addr_filt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t4_load_mtus</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mtus</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">a_wnd</span><span class="p">,</span>
		     <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">b_wnd</span><span class="p">);</span>
	<span class="n">setup_memwin</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgb_up</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eeh_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">link_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">cxgb_set_rxmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">cxgb4_eeh</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">eeh_err_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span>     <span class="o">=</span> <span class="n">eeh_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>         <span class="o">=</span> <span class="n">eeh_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_10g_port</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_10G</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">init_rspq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sge_rspq</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u8</span> <span class="n">timer_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pkt_cnt_idx</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iqe_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">intr_params</span> <span class="o">=</span> <span class="n">QINTR_TIMER_IDX</span><span class="p">(</span><span class="n">timer_idx</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">pkt_cnt_idx</span> <span class="o">&lt;</span> <span class="n">SGE_NCOUNTERS</span> <span class="o">?</span> <span class="n">QINTR_CNT_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">pktcnt_idx</span> <span class="o">=</span> <span class="n">pkt_cnt_idx</span> <span class="o">&lt;</span> <span class="n">SGE_NCOUNTERS</span> <span class="o">?</span> <span class="n">pkt_cnt_idx</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">iqe_len</span> <span class="o">=</span> <span class="n">iqe_size</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform default configuration of DMA queues depending on the number and type</span>
<span class="cm"> * of ports we found and the number of available CPUs.  Most settings can be</span>
<span class="cm"> * modified by the admin prior to actual use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">cfg_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">q10g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n10g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">n10g</span> <span class="o">+=</span> <span class="n">is_10g_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We default to 1 queue per non-10G port and up to # of cores queues</span>
<span class="cm">	 * per 10G port.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n10g</span><span class="p">)</span>
		<span class="n">q10g</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_ETH_QSETS</span> <span class="o">-</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">-</span> <span class="n">n10g</span><span class="p">))</span> <span class="o">/</span> <span class="n">n10g</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q10g</span> <span class="o">&gt;</span> <span class="n">num_online_cpus</span><span class="p">())</span>
		<span class="n">q10g</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span> <span class="o">=</span> <span class="n">qidx</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span> <span class="o">=</span> <span class="n">is_10g_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">)</span> <span class="o">?</span> <span class="n">q10g</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qidx</span> <span class="o">+=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">ethqsets</span> <span class="o">=</span> <span class="n">qidx</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">max_ethqsets</span> <span class="o">=</span> <span class="n">qidx</span><span class="p">;</span>   <span class="cm">/* MSI-X may lower it later */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For offload we use 1 queue/channel if all ports are up to 1G,</span>
<span class="cm">		 * otherwise we divide all available queues amongst the channels</span>
<span class="cm">		 * capped by the number of available cores.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n10g</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldrxq</span><span class="p">),</span>
				  <span class="n">num_online_cpus</span><span class="p">());</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldqsets</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldqsets</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
		<span class="cm">/* For RDMA one Rx queue per channel suffices */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmaqs</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sge_eth_rxq</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethrxq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">init_rspq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ethtxq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ethtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ctrlq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ctrlq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldtxq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldtxq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldrxq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sge_ofld_rxq</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldrxq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">init_rspq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">.</span><span class="n">uld</span> <span class="o">=</span> <span class="n">CXGB4_ULD_ISCSI</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmarxq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sge_ofld_rxq</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmarxq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">init_rspq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">511</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rspq</span><span class="p">.</span><span class="n">uld</span> <span class="o">=</span> <span class="n">CXGB4_ULD_RDMA</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_rspq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fw_evtq</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">init_rspq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">intrq</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">MAX_INGQ</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reduce the number of Ethernet queues across all ports to at most n.</span>
<span class="cm"> * n provides at least one queue per port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">reduce_ethqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethqsets</span><span class="p">)</span>
		<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="o">--</span><span class="p">;</span>
				<span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethqsets</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">.</span><span class="n">ethqsets</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_qset</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* 2 MSI-X vectors needed for the FW queue and non-data interrupts */</span>
<span class="cp">#define EXTRA_VECS 2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ofld_need</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">need</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nchan</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">entries</span><span class="p">[</span><span class="n">MAX_INGQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">want</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">max_ethqsets</span> <span class="o">+</span> <span class="n">EXTRA_VECS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">want</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rdmaqs</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldqsets</span><span class="p">;</span>
		<span class="cm">/* need nchan for each possible ULD */</span>
		<span class="n">ofld_need</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nchan</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">need</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">+</span> <span class="n">EXTRA_VECS</span> <span class="o">+</span> <span class="n">ofld_need</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">want</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">need</span><span class="p">)</span>
		<span class="n">want</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Distribute available vectors to the various queue groups.</span>
<span class="cm">		 * Every group gets its minimum requirement and NIC gets top</span>
<span class="cm">		 * priority for leftovers.</span>
<span class="cm">		 */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">want</span> <span class="o">-</span> <span class="n">EXTRA_VECS</span> <span class="o">-</span> <span class="n">ofld_need</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">max_ethqsets</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">max_ethqsets</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ethqsets</span><span class="p">)</span>
				<span class="n">reduce_ethqs</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">want</span> <span class="o">-</span> <span class="n">EXTRA_VECS</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">max_ethqsets</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">-=</span> <span class="n">ofld_need</span> <span class="o">-</span> <span class="n">nchan</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">ofldqsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">nchan</span><span class="p">)</span> <span class="o">*</span> <span class="n">nchan</span><span class="p">;</span>  <span class="cm">/* round down */</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">want</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vec</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev_dev</span><span class="p">,</span>
			 <span class="s">&quot;only %d MSI-X vectors left, not using MSI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef EXTRA_VECS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ethtool_rxfh_indir_default</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">print_port_info</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;R XFI&quot;</span><span class="p">,</span> <span class="s">&quot;R XAUI&quot;</span><span class="p">,</span> <span class="s">&quot;T SGMII&quot;</span><span class="p">,</span> <span class="s">&quot;T XFI&quot;</span><span class="p">,</span> <span class="s">&quot;T XAUI&quot;</span><span class="p">,</span> <span class="s">&quot;KX4&quot;</span><span class="p">,</span> <span class="s">&quot;CX4&quot;</span><span class="p">,</span>
		<span class="s">&quot;KX&quot;</span><span class="p">,</span> <span class="s">&quot;KR&quot;</span><span class="p">,</span> <span class="s">&quot;R SFP+&quot;</span><span class="p">,</span> <span class="s">&quot;KR/KX&quot;</span><span class="p">,</span> <span class="s">&quot;KR/KX/KX4&quot;</span>
	<span class="p">};</span>

	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bufp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spd</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">PCI_EXP_LNKSTA_CLS_2_5GB</span><span class="p">)</span>
		<span class="n">spd</span> <span class="o">=</span> <span class="s">&quot; 2.5 GT/s&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">PCI_EXP_LNKSTA_CLS_5_0GB</span><span class="p">)</span>
		<span class="n">spd</span> <span class="o">=</span> <span class="s">&quot; 5 GT/s&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_100M</span><span class="p">)</span>
		<span class="n">bufp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="s">&quot;100/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_1G</span><span class="p">)</span>
		<span class="n">bufp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="s">&quot;1000/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_cfg</span><span class="p">.</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">FW_PORT_CAP_SPEED_10G</span><span class="p">)</span>
		<span class="n">bufp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="s">&quot;10G/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bufp</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">)</span>
		<span class="o">--</span><span class="n">bufp</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="s">&quot;BASE-%s&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">]);</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chelsio %s rev %d %s %sNIC PCIe x%d%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
		    <span class="n">is_offload</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;R&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">spd</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; MSI-X&quot;</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; MSI&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;S/N: %s, E/C: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">ec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">enable_pcie_relaxed_ordering</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">PCI_EXP_DEVCTL_RELAX_EN</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free the following resources:</span>
<span class="cm"> * - memory used for tables</span>
<span class="cm"> * - MSI/MSI-X</span>
<span class="cm"> * - net devices</span>
<span class="cm"> * - resources FW is holding for us</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_some_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">t4_free_mem</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="n">t4_free_mem</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">.</span><span class="n">tid_tab</span><span class="p">);</span>
	<span class="n">disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FW_OK</span><span class="p">)</span>
		<span class="n">t4_fw_bye</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define TSO_FLAGS (NETIF_F_TSO | NETIF_F_TSO6 | NETIF_F_TSO_ECN)</span>
<span class="cp">#define VLAN_FEAT (NETIF_F_SG | NETIF_F_IP_CSUM | TSO_FLAGS | \</span>
<span class="cp">		   NETIF_F_IPV6_CSUM | NETIF_F_HIGHDMA)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">func</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">highdma</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s - version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESC</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Just info, some other driver may have claimed the device. */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot obtain PCI resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We control everything through one PF */</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">!=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>        <span class="cm">/* to restore SR-IOV later */</span>
		<span class="k">goto</span> <span class="n">sriov</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">highdma</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to obtain 64-bit DMA for &quot;</span>
				<span class="s">&quot;coherent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no usable DMA configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">enable_pcie_relaxed_ordering</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adapter</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot map device registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_adapter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">dflt_msg_enable</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">chan_map</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">chan_map</span><span class="p">));</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tid_release_lock</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tid_release_task</span><span class="p">,</span> <span class="n">process_tid_release_list</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db_full_task</span><span class="p">,</span> <span class="n">process_db_full</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">db_drop_task</span><span class="p">,</span> <span class="n">process_db_drop</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t4_prep_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unmap_bar</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adap_init0</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unmap_bar</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

		<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">port_info</span><span class="p">),</span>
					   <span class="n">MAX_ETH_QSETS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">xact_addr_filt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">TSO_FLAGS</span> <span class="o">|</span>
			<span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span>
			<span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXHASH</span> <span class="o">|</span>
			<span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">highdma</span><span class="p">)</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">VLAN_FEAT</span><span class="p">;</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_UNICAST_FLT</span><span class="p">;</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cxgb4_netdev_ops</span><span class="p">;</span>
		<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cxgb_ethtool_ops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t4_port_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure queues and allocate tables now, they can be needed as</span>
<span class="cm">	 * soon as the first register_netdev completes.</span>
<span class="cm">	 */</span>
	<span class="n">cfg_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">t4_init_l2t</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We tolerate a lack of L2T, giving up some functionality */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate L2T, continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">offload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tid_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate TID table, &quot;</span>
			 <span class="s">&quot;continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">offload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* See what interrupts we&#39;ll be using */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msi</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">enable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">USING_MSIX</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">USING_MSI</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">init_rss</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The card is now ready to go.  If any errors occur during device</span>
<span class="cm">	 * registration we do not fail the whole card but rather proceed only</span>
<span class="cm">	 * with the ports we manage to register successfully.  However we must</span>
<span class="cm">	 * register at least one net device.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">);</span>
		<span class="n">netif_set_real_num_rx_queues</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nqsets</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">chan_map</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">print_port_info</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not register any net devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;only %d net devices registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgb4_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">debugfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span>
							   <span class="n">cxgb4_debugfs_root</span><span class="p">);</span>
		<span class="n">setup_debugfs</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PCIe EEH recovery on powerpc platforms needs fundamental reset */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">needs_freset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">attach_ulds</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">sriov:</span>
<span class="cp">#ifdef CONFIG_PCI_IOV</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">num_vf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num_vf</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_sriov</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">num_vf</span><span class="p">[</span><span class="n">func</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;instantiated %u virtual functions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">num_vf</span><span class="p">[</span><span class="n">func</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_dev:</span>
	<span class="n">free_some_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
 <span class="nl">out_unmap_bar:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
 <span class="nl">out_free_adapter:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
 <span class="nl">out_disable_device:</span>
	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
 <span class="nl">out_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_sriov</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">detach_ulds</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">==</span> <span class="n">NETREG_REGISTERED</span><span class="p">)</span>
				<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">)</span>
			<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">)</span>
			<span class="n">cxgb_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">free_some_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cxgb4_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cxgb4_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cxgb4_eeh</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cxgb4_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">workq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;cxgb4&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">workq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Debugfs support is optional, just warn if this fails */</span>
	<span class="n">cxgb4_debugfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgb4_debugfs_root</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;could not create debugfs entry, continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb4_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">cxgb4_debugfs_root</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cxgb4_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb4_driver</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">cxgb4_debugfs_root</span><span class="p">);</span>  <span class="cm">/* NULL ok */</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">workq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">workq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cxgb4_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cxgb4_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
