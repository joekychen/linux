<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb3 › xgmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>xgmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2008 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;regs.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * # of exact address filters.  The first one is used for the station address,</span>
<span class="cm"> * the rest are available for multicast addresses.</span>
<span class="cm"> */</span>
<span class="cp">#define EXACT_ADDR_FILTERS 8</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">macidx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">/</span> <span class="p">(</span><span class="n">XGMAC0_1_BASE_ADDR</span> <span class="o">-</span> <span class="n">XGMAC0_0_BASE_ADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xaui_serdes_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">F_PWRDN0</span> <span class="o">|</span> <span class="n">F_PWRDN1</span><span class="p">,</span> <span class="n">F_RESETPLL01</span><span class="p">,</span> <span class="n">F_RESET0</span> <span class="o">|</span> <span class="n">F_RESET1</span><span class="p">,</span>
		<span class="n">F_PWRDN2</span> <span class="o">|</span> <span class="n">F_PWRDN3</span><span class="p">,</span> <span class="n">F_RESETPLL23</span><span class="p">,</span> <span class="n">F_RESET2</span> <span class="o">|</span> <span class="n">F_RESET3</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">A_XGM_SERDES_CTRL0</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">xauicfg</span><span class="p">[</span><span class="n">macidx</span><span class="p">(</span><span class="n">mac</span><span class="p">)]</span> <span class="o">|</span>
		     <span class="n">F_RESET3</span> <span class="o">|</span> <span class="n">F_RESET2</span> <span class="o">|</span> <span class="n">F_RESET1</span> <span class="o">|</span> <span class="n">F_RESET0</span> <span class="o">|</span>
		     <span class="n">F_PWRDN3</span> <span class="o">|</span> <span class="n">F_PWRDN2</span> <span class="o">|</span> <span class="n">F_PWRDN1</span> <span class="o">|</span> <span class="n">F_PWRDN0</span> <span class="o">|</span>
		     <span class="n">F_RESETPLL23</span> <span class="o">|</span> <span class="n">F_RESETPLL01</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clear</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">clear</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3b_pcs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			 <span class="n">F_PCS_RESET_</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">F_PCS_RESET_</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_mac_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">addr_val_pair</span> <span class="n">mac_reset_avp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">A_XGM_TX_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_CFG</span><span class="p">,</span> <span class="n">F_DISPAUSEFRAMES</span> <span class="o">|</span> <span class="n">F_EN1536BFRAMES</span> <span class="o">|</span>
		 <span class="n">F_RMFCS</span> <span class="o">|</span> <span class="n">F_ENJUMBO</span> <span class="o">|</span> <span class="n">F_ENHASHMCAST</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_HASH_LOW</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_HASH_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_RX_EXACT_MATCH_LOW_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_XGM_STAT_CTRL</span><span class="p">,</span> <span class="n">F_CLRSTATS</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">F_MAC_RESET_</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="n">t3_write_regs</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mac_reset_avp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mac_reset_avp</span><span class="p">),</span> <span class="n">oft</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RXFIFO_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span>
			 <span class="n">F_RXSTRFRWRD</span> <span class="o">|</span> <span class="n">F_DISERRFRAMES</span><span class="p">,</span>
			 <span class="n">uses_xaui</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">F_RXSTRFRWRD</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TXFIFO_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_UNDERUNFIX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uses_xaui</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_SERDES_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">F_RXENABLE</span> <span class="o">|</span> <span class="n">F_TXENABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_SERDES_STATUS1</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span>
					    <span class="n">F_CMULOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
				       <span class="s">&quot;MAC %d XAUI SERDES CMU lock failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">macidx</span><span class="p">(</span><span class="n">mac</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_SERDES_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">F_SERDESRESET_</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">xaui_serdes_reset</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_MAX_PKT_SIZE</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span>
			 <span class="n">V_RXMAXFRAMERSIZE</span><span class="p">(</span><span class="n">M_RXMAXFRAMERSIZE</span><span class="p">),</span>
			 <span class="n">V_RXMAXFRAMERSIZE</span><span class="p">(</span><span class="n">MAX_FRAME_SIZE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_RXENFRAMER</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">F_MAC_RESET_</span> <span class="o">|</span> <span class="n">F_XGMAC_STOP_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_10G</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_PCS_RESET_</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uses_xaui</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_PCS_RESET_</span> <span class="o">|</span> <span class="n">F_XG2G_RESET_</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_RGMII_RESET_</span> <span class="o">|</span> <span class="n">F_XG2G_RESET_</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">F_PCS_RESET_</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">t3b_pcs_reset</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3b2_mac_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">store</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">macidx</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macidx</span><span class="p">(</span><span class="n">mac</span><span class="p">))</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="n">F_PORT0ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="n">F_PORT1ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Stop NIC traffic to reduce the number of TXTOGGLES */</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="n">F_ENFORCEPKT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Ensure TX drains */</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">F_TXPAUSEEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">F_MAC_RESET_</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">);</span>    <span class="cm">/* flush */</span>

	<span class="cm">/* Store A_TP_TX_DROP_CFG_CH0 */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_CFG_CH0</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">store</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_CFG_CH0</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Change DROP_CFG to 0xc0000011 */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_CFG_CH0</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_DATA</span><span class="p">,</span> <span class="mh">0xc0000011</span><span class="p">);</span>

	<span class="cm">/* Check for xgm Rx fifo empty */</span>
	<span class="cm">/* Increased loop count to 1000 from 5 cover 1G and 100Mbps case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_MAX_PKT_SIZE_ERR_CNT</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span>
			    <span class="mh">0x80000000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;MAC %d Rx fifo drain failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">macidx</span><span class="p">(</span><span class="n">mac</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">);</span>    <span class="cm">/* flush */</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">F_MAC_RESET_</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_10G</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_PCS_RESET_</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uses_xaui</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_PCS_RESET_</span> <span class="o">|</span> <span class="n">F_XG2G_RESET_</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_RGMII_RESET_</span> <span class="o">|</span> <span class="n">F_XG2G_RESET_</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">);</span>  <span class="cm">/* flush */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">F_PCS_RESET_</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">t3b_pcs_reset</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span>
		     <span class="n">F_DISPAUSEFRAMES</span> <span class="o">|</span> <span class="n">F_EN1536BFRAMES</span> <span class="o">|</span>
		     <span class="n">F_RMFCS</span> <span class="o">|</span> <span class="n">F_ENJUMBO</span> <span class="o">|</span> <span class="n">F_ENHASHMCAST</span><span class="p">);</span>

	<span class="cm">/* Restore the DROP_CFG */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_CFG_CH0</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_DATA</span><span class="p">,</span> <span class="n">store</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idx</span><span class="p">)</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_PORT0ACTIVE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_PORT1ACTIVE</span><span class="p">);</span>

	<span class="cm">/* re-enable nic traffic */</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="n">F_ENFORCEPKT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*  Set: re-enable NIC traffic */</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="n">F_ENFORCEPKT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the exact match register &#39;idx&#39; to recognize the given Ethernet address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_addr_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_EXACT_MATCH_LOW_1</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_EXACT_MATCH_HIGH_1</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set one of the station&#39;s unicast MAC addresses. */</span>
<span class="kt">int</span> <span class="nf">t3_mac_set_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">nucast</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">set_addr_filter</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Specify the number of exact address filters that should be reserved for</span>
<span class="cm"> * unicast addresses.  Caller should reload the unicast and multicast addresses</span>
<span class="cm"> * after calling this.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_mac_set_num_ucast</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">EXACT_ADDR_FILTERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">nucast</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_mac_disable_exact_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_XGM_RX_EXACT_MATCH_LOW_1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EXACT_ADDR_FILTERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_EXACT_MATCH_LOW_1</span><span class="p">);</span>	<span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_mac_enable_exact_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_XGM_RX_EXACT_MATCH_HIGH_1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EXACT_ADDR_FILTERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_EXACT_MATCH_LOW_1</span><span class="p">);</span>	<span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="cm">/* Calculate the RX hash filter index of an Ethernet address */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hash_hw_addr</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">octet</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">octet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">octet</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">octet</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="n">octet</span><span class="p">],</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">c</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">++</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hash</span> <span class="o">^=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_mac_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">hash_lo</span><span class="p">,</span> <span class="n">hash_hi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">F_COPYALLFRAMES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_COPYALLFRAMES</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		<span class="n">hash_lo</span> <span class="o">=</span> <span class="n">hash_hi</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">exact_addr_idx</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">nucast</span><span class="p">;</span>

		<span class="n">hash_lo</span> <span class="o">=</span> <span class="n">hash_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exact_addr_idx</span> <span class="o">&lt;</span> <span class="n">EXACT_ADDR_FILTERS</span><span class="p">)</span>
				<span class="n">set_addr_filter</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">exact_addr_idx</span><span class="o">++</span><span class="p">,</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash_hw_addr</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
					<span class="n">hash_lo</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hash</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">hash_hi</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hash</span> <span class="o">-</span> <span class="mi">32</span><span class="p">));</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_LOW</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">hash_lo</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_HIGH</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">hash_hi</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_fifo_hwm</span><span class="p">(</span><span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hwm</span><span class="p">;</span>

	<span class="n">hwm</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">MAC_RXFIFO_SIZE</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">mtu</span><span class="p">,</span> <span class="p">(</span><span class="n">MAC_RXFIFO_SIZE</span> <span class="o">*</span> <span class="mi">38</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">hwm</span><span class="p">,</span> <span class="n">MAC_RXFIFO_SIZE</span> <span class="o">-</span> <span class="mi">8192</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_mac_set_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hwm</span><span class="p">,</span> <span class="n">lwm</span><span class="p">,</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ipg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thres</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * MAX_FRAME_SIZE inludes header + FCS, mtu doesn&#39;t.  The HW max</span>
<span class="cm">	 * packet size register includes header, but not FCS.</span>
<span class="cm">	 */</span>
	<span class="n">mtu</span> <span class="o">+=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">MAX_FRAME_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_MAX_PKT_SIZE</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">T3_REV_B2</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_RXEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t3_mac_disable_exact_filters</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				 <span class="n">F_ENHASHMCAST</span> <span class="o">|</span> <span class="n">F_COPYALLFRAMES</span><span class="p">,</span> <span class="n">F_DISBCAST</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_B2</span> <span class="o">?</span>
			<span class="n">A_XGM_RX_MAX_PKT_SIZE_ERR_CNT</span> <span class="o">:</span> <span class="n">A_XGM_RXFIFO_CFG</span><span class="p">;</span>

		<span class="cm">/* drain RX FIFO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				    <span class="n">F_RXFIFO_EMPTY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
			<span class="n">t3_mac_enable_exact_filters</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_MAX_PKT_SIZE</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				 <span class="n">V_RXMAXPKTSIZE</span><span class="p">(</span><span class="n">M_RXMAXPKTSIZE</span><span class="p">),</span>
				 <span class="n">V_RXMAXPKTSIZE</span><span class="p">(</span><span class="n">mtu</span><span class="p">));</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="n">t3_mac_enable_exact_filters</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_MAX_PKT_SIZE</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				 <span class="n">V_RXMAXPKTSIZE</span><span class="p">(</span><span class="n">M_RXMAXPKTSIZE</span><span class="p">),</span>
				 <span class="n">V_RXMAXPKTSIZE</span><span class="p">(</span><span class="n">mtu</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adjust the PAUSE frame watermarks.  We always set the LWM, and the</span>
<span class="cm">	 * HWM only if flow-control is enabled.</span>
<span class="cm">	 */</span>
	<span class="n">hwm</span> <span class="o">=</span> <span class="n">rx_fifo_hwm</span><span class="p">(</span><span class="n">mtu</span><span class="p">);</span>
	<span class="n">lwm</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mtu</span><span class="p">,</span> <span class="n">MAC_RXFIFO_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RXFIFO_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_RXFIFOPAUSELWM</span><span class="p">(</span><span class="n">M_RXFIFOPAUSELWM</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">|=</span> <span class="n">V_RXFIFOPAUSELWM</span><span class="p">(</span><span class="n">lwm</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">G_RXFIFOPAUSEHWM</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">V_RXFIFOPAUSEHWM</span><span class="p">(</span><span class="n">M_RXFIFOPAUSEHWM</span><span class="p">))</span> <span class="o">|</span>
		    <span class="n">V_RXFIFOPAUSEHWM</span><span class="p">(</span><span class="n">hwm</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RXFIFO_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="cm">/* Adjust the TX FIFO threshold based on the MTU */</span>
	<span class="n">thres</span> <span class="o">=</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">cclk</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">15625</span><span class="p">;</span>
	<span class="n">thres</span> <span class="o">=</span> <span class="p">(</span><span class="n">thres</span> <span class="o">*</span> <span class="n">mtu</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_10G</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="n">thres</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">thres</span> <span class="o">=</span> <span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">thres</span> <span class="o">?</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">-</span> <span class="n">thres</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">thres</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">thres</span><span class="p">,</span> <span class="mi">8U</span><span class="p">);</span>	<span class="cm">/* need at least 8 */</span>
	<span class="n">ipg</span> <span class="o">=</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_C</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TXFIFO_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			 <span class="n">V_TXFIFOTHRESH</span><span class="p">(</span><span class="n">M_TXFIFOTHRESH</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_TXIPG</span><span class="p">(</span><span class="n">M_TXIPG</span><span class="p">),</span>
			 <span class="n">V_TXFIFOTHRESH</span><span class="p">(</span><span class="n">thres</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_TXIPG</span><span class="p">(</span><span class="n">ipg</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_C</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_PAUSE_TIMER</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">hwm</span> <span class="o">-</span> <span class="n">lwm</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_PAUSE_QUANTA</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
		     <span class="n">MAC_RXFIFO_SIZE</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_mac_set_speed_duplex_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">V_PORTSPEED</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">V_PORTSPEED</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">V_PORTSPEED</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">V_PORTSPEED</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_PORT_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span>
				 <span class="n">V_PORTSPEED</span><span class="p">(</span><span class="n">M_PORTSPEED</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RXFIFO_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_RXFIFOPAUSEHWM</span><span class="p">(</span><span class="n">M_RXFIFOPAUSEHWM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rx_max_pkt_size</span> <span class="o">=</span>
		    <span class="n">G_RXMAXPKTSIZE</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
					       <span class="n">A_XGM_RX_MAX_PKT_SIZE</span> <span class="o">+</span> <span class="n">oft</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">V_RXFIFOPAUSEHWM</span><span class="p">(</span><span class="n">rx_fifo_hwm</span><span class="p">(</span><span class="n">rx_max_pkt_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RXFIFO_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CFG</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">F_TXPAUSEEN</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_RX</span><span class="p">)</span> <span class="o">?</span> <span class="n">F_TXPAUSEEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_mac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">macidx</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oft</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_stats</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_CFG_CH0</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_DATA</span><span class="p">,</span>
			     <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_C</span> <span class="o">?</span>
			     <span class="mh">0xc4ffff01</span> <span class="o">:</span> <span class="mh">0xc0ede401</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_MODE</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_DATA</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">,</span>
				 <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_C</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>

		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">F_TXEN</span><span class="p">);</span>

		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_CNT_CH0</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_mcnt</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_frames</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_tcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_TXDROPCNTCH0RCVD</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
							<span class="n">A_TP_PIO_DATA</span><span class="p">)));</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_xcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_TXSPI4SOPCNT</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
						<span class="n">A_XGM_TX_SPI4_SOP_EOP_CNT</span> <span class="o">+</span>
						<span class="n">oft</span><span class="p">)));</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_mcnt</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_frames</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_xcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_TXSPI4SOPCNT</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
						<span class="n">A_XGM_RX_SPI4_SOP_EOP_CNT</span> <span class="o">+</span>
						<span class="n">oft</span><span class="p">)));</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_ocnt</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_fifo_ovfl</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">txen</span> <span class="o">=</span> <span class="n">F_TXEN</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">toggle_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">)</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CTRL</span> <span class="o">+</span> <span class="n">oft</span><span class="p">,</span> <span class="n">F_RXEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_mac_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">txen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">F_MAC_RESET_</span><span class="p">;</span>

		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				 <span class="n">F_PCS_RESET_</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_RX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_10G</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">F_PCS_RESET_</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uses_xaui</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">F_PCS_RESET_</span> <span class="o">|</span> <span class="n">F_XG2G_RESET_</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">F_RGMII_RESET_</span> <span class="o">|</span> <span class="n">F_XG2G_RESET_</span><span class="p">;</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RESET_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3b2_mac_watchdog_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_stats</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_tcnt</span><span class="p">,</span> <span class="n">tx_xcnt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tx_mcnt</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_frames</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_xcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* By default tx_xcnt is making progress */</span>
	<span class="n">tx_tcnt</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_tcnt</span><span class="p">;</span>	<span class="cm">/* If tx_mcnt is progressing ignore tx_tcnt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_mcnt</span> <span class="o">==</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_mcnt</span> <span class="o">&amp;&amp;</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_xcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_TXSPI4SOPCNT</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
						<span class="n">A_XGM_TX_SPI4_SOP_EOP_CNT</span> <span class="o">+</span>
					       	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_xcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span>
				     <span class="n">A_TP_TX_DROP_CNT_CH0</span> <span class="o">+</span> <span class="n">macidx</span><span class="p">(</span><span class="n">mac</span><span class="p">));</span>
			<span class="n">tx_tcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_TXDROPCNTCH0RCVD</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
						      <span class="n">A_TP_PIO_DATA</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">toggle_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tx_tcnt</span> <span class="o">!=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_tcnt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_xcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">toggle_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">toggle_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_tcnt</span> <span class="o">=</span> <span class="n">tx_tcnt</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_xcnt</span> <span class="o">=</span> <span class="n">tx_xcnt</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_mcnt</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_frames</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>  <span class="cm">/* flush */</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">txen</span><span class="p">);</span>
		<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_TX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>  <span class="cm">/* flush */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">toggle_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3b2_mac_reset</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">toggle_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called periodically to accumulate the current values of the</span>
<span class="cm"> * RMON counters into the port statistics.  Since the packet counters are only</span>
<span class="cm"> * 32 bits they can overflow in ~286 secs at 10G, so the function should be</span>
<span class="cm"> * called more frequently than that.  The byte counters are 45-bit wide, they</span>
<span class="cm"> * would overflow in ~7.8 hours.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">mac_stats</span> <span class="o">*</span><span class="nf">t3_mac_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define RMON_READ(mac, addr) t3_read_reg(mac-&gt;adapter, addr + mac-&gt;offset)</span>
<span class="cp">#define RMON_UPDATE(mac, name, reg) \</span>
<span class="cp">	(mac)-&gt;stats.name += (u64)RMON_READ(mac, A_XGM_STAT_##reg)</span>
<span class="cp">#define RMON_UPDATE64(mac, name, reg_lo, reg_hi) \</span>
<span class="cp">	(mac)-&gt;stats.name += RMON_READ(mac, A_XGM_STAT_##reg_lo) + \</span>
<span class="cp">			     ((u64)RMON_READ(mac, A_XGM_STAT_##reg_hi) &lt;&lt; 32)</span>

	<span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>

	<span class="n">RMON_UPDATE64</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_octets</span><span class="p">,</span> <span class="n">RX_BYTES_LOW</span><span class="p">,</span> <span class="n">RX_BYTES_HIGH</span><span class="p">);</span>
	<span class="n">RMON_UPDATE64</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames</span><span class="p">,</span> <span class="n">RX_FRAMES_LOW</span><span class="p">,</span> <span class="n">RX_FRAMES_HIGH</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_mcast_frames</span><span class="p">,</span> <span class="n">RX_MCAST_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_bcast_frames</span><span class="p">,</span> <span class="n">RX_BCAST_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_fcs_errs</span><span class="p">,</span> <span class="n">RX_CRC_ERR_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_pause</span><span class="p">,</span> <span class="n">RX_PAUSE_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_jabber</span><span class="p">,</span> <span class="n">RX_JABBER_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_short</span><span class="p">,</span> <span class="n">RX_SHORT_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_symbol_errs</span><span class="p">,</span> <span class="n">RX_SYM_CODE_ERR_FRAMES</span><span class="p">);</span>

	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_too_long</span><span class="p">,</span> <span class="n">RX_OVERSIZE_FRAMES</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">RMON_READ</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">A_XGM_RX_MAX_PKT_SIZE_ERR_CNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_B2</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">&amp;=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_too_long</span> <span class="o">+=</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames_64</span><span class="p">,</span> <span class="n">RX_64B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames_65_127</span><span class="p">,</span> <span class="n">RX_65_127B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames_128_255</span><span class="p">,</span> <span class="n">RX_128_255B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames_256_511</span><span class="p">,</span> <span class="n">RX_256_511B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames_512_1023</span><span class="p">,</span> <span class="n">RX_512_1023B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames_1024_1518</span><span class="p">,</span> <span class="n">RX_1024_1518B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_frames_1519_max</span><span class="p">,</span> <span class="n">RX_1519_MAXB_FRAMES</span><span class="p">);</span>

	<span class="n">RMON_UPDATE64</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_octets</span><span class="p">,</span> <span class="n">TX_BYTE_LOW</span><span class="p">,</span> <span class="n">TX_BYTE_HIGH</span><span class="p">);</span>
	<span class="n">RMON_UPDATE64</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames</span><span class="p">,</span> <span class="n">TX_FRAME_LOW</span><span class="p">,</span> <span class="n">TX_FRAME_HIGH</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_mcast_frames</span><span class="p">,</span> <span class="n">TX_MCAST</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_bcast_frames</span><span class="p">,</span> <span class="n">TX_BCAST</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_pause</span><span class="p">,</span> <span class="n">TX_PAUSE</span><span class="p">);</span>
	<span class="cm">/* This counts error frames in general (bad FCS, underrun, etc). */</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_underrun</span><span class="p">,</span> <span class="n">TX_ERR_FRAMES</span><span class="p">);</span>

	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames_64</span><span class="p">,</span> <span class="n">TX_64B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames_65_127</span><span class="p">,</span> <span class="n">TX_65_127B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames_128_255</span><span class="p">,</span> <span class="n">TX_128_255B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames_256_511</span><span class="p">,</span> <span class="n">TX_256_511B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames_512_1023</span><span class="p">,</span> <span class="n">TX_512_1023B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames_1024_1518</span><span class="p">,</span> <span class="n">TX_1024_1518B_FRAMES</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">tx_frames_1519_max</span><span class="p">,</span> <span class="n">TX_1519_MAXB_FRAMES</span><span class="p">);</span>

	<span class="cm">/* The next stat isn&#39;t clear-on-read. */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_MIB_INDEX</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">?</span> <span class="mi">51</span> <span class="o">:</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_MIB_RDATA</span><span class="p">);</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_cong_drops</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_cong_drops</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">lo</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
