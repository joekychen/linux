<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb3 › adapter.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>adapter.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2003-2008 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cm">/* This file should not be included directly.  Include common.h instead. */</span>

<span class="cp">#ifndef __T3_ADAPTER_H__</span>
<span class="cp">#define __T3_ADAPTER_H__</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/cache.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &quot;t3cdev.h&quot;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="k">struct</span> <span class="n">adapter</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">sge_qset</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">port_info</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">mac_idx_types</span> <span class="p">{</span>
	<span class="n">LAN_MAC_IDX</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SAN_MAC_IDX</span><span class="p">,</span>

	<span class="n">MAX_MAC_IDX</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_config</span> <span class="p">{</span>
	<span class="n">__u8</span>	<span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__u32</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">send</span><span class="p">)(</span><span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">recv</span><span class="p">)(</span><span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">port_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge_qset</span> <span class="o">*</span><span class="n">qs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nqsets</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">first_qset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cphy</span> <span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_config</span> <span class="n">link_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="n">netstats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">activity</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">iscsi_ipv4addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_config</span> <span class="n">iscsic</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">link_fault</span><span class="p">;</span> <span class="cm">/* link fault was detected */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>				<span class="cm">/* adapter flags */</span>
	<span class="n">FULL_INIT_DONE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">USING_MSI</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">USING_MSIX</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">QUEUES_BOUND</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">TP_PARITY_INIT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">NAPI_INIT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fl_pg_chunk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p_cnt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rx_desc</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rx_sw_desc</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sge_fl</span> <span class="p">{</span>                     <span class="cm">/* SGE per free-buffer list state */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">;</span>      <span class="cm">/* size of each Rx buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span><span class="p">;</span>       <span class="cm">/* # of available Rx buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pend_cred</span><span class="p">;</span>     <span class="cm">/* new buffers since last FL DB ring */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>          <span class="cm">/* capacity of free list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidx</span><span class="p">;</span>          <span class="cm">/* consumer index */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pidx</span><span class="p">;</span>          <span class="cm">/* producer index */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gen</span><span class="p">;</span>           <span class="cm">/* free list generation */</span>
	<span class="k">struct</span> <span class="n">fl_pg_chunk</span> <span class="n">pg_chunk</span><span class="p">;</span><span class="cm">/* page chunk cache */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">use_pages</span><span class="p">;</span>     <span class="cm">/* whether FL uses pages or sk_buffs */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>	    <span class="cm">/* order of page allocations */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_size</span><span class="p">;</span>    <span class="cm">/* size of allocated buffer */</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>       <span class="cm">/* address of HW Rx descriptor ring */</span>
	<span class="k">struct</span> <span class="n">rx_sw_desc</span> <span class="o">*</span><span class="n">sdesc</span><span class="p">;</span>   <span class="cm">/* address of SW Rx descriptor ring */</span>
	<span class="n">dma_addr_t</span>   <span class="n">phys_addr</span><span class="p">;</span>     <span class="cm">/* physical address of HW ring start */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cntxt_id</span><span class="p">;</span>      <span class="cm">/* SGE context id for the free list */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">empty</span><span class="p">;</span>        <span class="cm">/* # of times queue ran out of buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alloc_failed</span><span class="p">;</span> <span class="cm">/* # of times buffer allocation failed */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Bundle size for grouping offload RX packets for delivery to the stack.</span>
<span class="cm"> * Don&#39;t make this too big as we do prefetch on each packet in a bundle.</span>
<span class="cm"> */</span>
<span class="cp"># define RX_BUNDLE_SIZE 8</span>

<span class="k">struct</span> <span class="n">rsp_desc</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sge_rspq</span> <span class="p">{</span>		<span class="cm">/* state for an SGE response queue */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span><span class="p">;</span>	<span class="cm">/* # of pending response credits */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>	<span class="cm">/* capacity of response queue */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidx</span><span class="p">;</span>	<span class="cm">/* consumer index */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gen</span><span class="p">;</span>	<span class="cm">/* current generation bit */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">polling</span><span class="p">;</span>	<span class="cm">/* is the queue serviced through NAPI? */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">holdoff_tmr</span><span class="p">;</span>	<span class="cm">/* interrupt holdoff timer in 100ns */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_holdoff</span><span class="p">;</span>	<span class="cm">/* holdoff time for next interrupt */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_recycle_buf</span><span class="p">;</span> <span class="cm">/* whether recycling occurred</span>
<span class="cm">					within current sop-eop */</span>
	<span class="k">struct</span> <span class="n">rsp_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>	<span class="cm">/* address of HW response ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">;</span>	<span class="cm">/* physical address of the ring */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cntxt_id</span><span class="p">;</span>	<span class="cm">/* SGE context id for the response q */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>	<span class="cm">/* guards response processing */</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">rx_queue</span><span class="p">;</span> <span class="cm">/* offload packet receive queue */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pg_skb</span><span class="p">;</span> <span class="cm">/* used to build frag list in napi handler */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offload_pkts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offload_bundles</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eth_pkts</span><span class="p">;</span>	<span class="cm">/* # of ethernet packets */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pure_rsps</span><span class="p">;</span>	<span class="cm">/* # of pure (non-data) responses */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imm_data</span><span class="p">;</span>	<span class="cm">/* responses with immediate data */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_drops</span><span class="p">;</span>	<span class="cm">/* # of packets dropped due to no mem */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">async_notif</span><span class="p">;</span> <span class="cm">/* # of asynchronous notification events */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">empty</span><span class="p">;</span>	<span class="cm">/* # of times queue ran out of credits */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nomem</span><span class="p">;</span>	<span class="cm">/* # of responses deferred due to no mem */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unhandled_irqs</span><span class="p">;</span>	<span class="cm">/* # of spurious intrs */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">starved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">restarted</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tx_desc</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">tx_sw_desc</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sge_txq</span> <span class="p">{</span>		<span class="cm">/* state for an SGE Tx queue */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>	<span class="cm">/* HW DMA fetch status */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_use</span><span class="p">;</span>	<span class="cm">/* # of in-use Tx descriptors */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>	<span class="cm">/* # of descriptors */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">processed</span><span class="p">;</span>	<span class="cm">/* total # of descs HW has processed */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cleaned</span><span class="p">;</span>	<span class="cm">/* total # of descs SW has reclaimed */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stop_thres</span><span class="p">;</span>	<span class="cm">/* SW TX queue suspend threshold */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidx</span><span class="p">;</span>	<span class="cm">/* consumer index */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pidx</span><span class="p">;</span>	<span class="cm">/* producer index */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gen</span><span class="p">;</span>	<span class="cm">/* current value of generation bit */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unacked</span><span class="p">;</span>	<span class="cm">/* Tx descriptors used since last COMPL */</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>	<span class="cm">/* address of HW Tx descriptor ring */</span>
	<span class="k">struct</span> <span class="n">tx_sw_desc</span> <span class="o">*</span><span class="n">sdesc</span><span class="p">;</span>	<span class="cm">/* address of SW Tx descriptor ring */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>	<span class="cm">/* guards enqueueing of new packets */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">token</span><span class="p">;</span>	<span class="cm">/* WR token */</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">;</span>	<span class="cm">/* physical address of the ring */</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">sendq</span><span class="p">;</span>	<span class="cm">/* List of backpressured offload packets */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">qresume_tsk</span><span class="p">;</span>	<span class="cm">/* restarts the queue */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cntxt_id</span><span class="p">;</span>	<span class="cm">/* SGE context id for the Tx q */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stops</span><span class="p">;</span>	<span class="cm">/* # of times q has been stopped */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">restarts</span><span class="p">;</span>	<span class="cm">/* # of queue restarts */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>				<span class="cm">/* per port SGE statistics */</span>
	<span class="n">SGE_PSTAT_TSO</span><span class="p">,</span>		<span class="cm">/* # of TSO requests */</span>
	<span class="n">SGE_PSTAT_RX_CSUM_GOOD</span><span class="p">,</span>	<span class="cm">/* # of successful RX csum offloads */</span>
	<span class="n">SGE_PSTAT_TX_CSUM</span><span class="p">,</span>	<span class="cm">/* # of TX checksum offloads */</span>
	<span class="n">SGE_PSTAT_VLANEX</span><span class="p">,</span>	<span class="cm">/* # of VLAN tag extractions */</span>
	<span class="n">SGE_PSTAT_VLANINS</span><span class="p">,</span>	<span class="cm">/* # of VLAN tag insertions */</span>

	<span class="n">SGE_PSTAT_MAX</span>		<span class="cm">/* must be last */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">napi_gro_fraginfo</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sge_qset</span> <span class="p">{</span>		<span class="cm">/* an SGE queue set */</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge_rspq</span> <span class="n">rspq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge_fl</span> <span class="n">fl</span><span class="p">[</span><span class="n">SGE_RXQ_PER_SET</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sge_txq</span> <span class="n">txq</span><span class="p">[</span><span class="n">SGE_TXQ_PER_SET</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">nomem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">lro_va</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">tx_q</span><span class="p">;</span>	<span class="cm">/* associated netdev TX queue */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txq_stopped</span><span class="p">;</span>	<span class="cm">/* which Tx queues are stopped */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">tx_reclaim_timer</span><span class="p">;</span>	<span class="cm">/* reclaims TX buffers */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">rx_reclaim_timer</span><span class="p">;</span>	<span class="cm">/* reclaims RX buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port_stats</span><span class="p">[</span><span class="n">SGE_PSTAT_MAX</span><span class="p">];</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sge</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sge_qset</span> <span class="n">qs</span><span class="p">[</span><span class="n">SGE_QSETS</span><span class="p">];</span>
	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>	<span class="cm">/* guards non-atomic SGE registers (eg context) */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">adapter</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="n">tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">adapter_list</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">registered_device_map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">open_device_map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msg_enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmio_len</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">adapter_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slow_intr_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_stats</span><span class="p">[</span><span class="n">IRQ_NUM_STATS</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">msix_nvectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vec</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">desc</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">msix_info</span><span class="p">[</span><span class="n">SGE_QSETS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* T3 modules */</span>
	<span class="k">struct</span> <span class="n">sge</span> <span class="n">sge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mc7</span> <span class="n">pmrx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mc7</span> <span class="n">pmtx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mc7</span> <span class="n">cm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mc5</span> <span class="n">mc5</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">port</span><span class="p">[</span><span class="n">MAX_NPORTS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">check_task_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">adap_check_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">ext_intr_handler_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">fatal_error_handler_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">link_fault_handler_task</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">db_full_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">db_empty_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">db_drop_task</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_root</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mdio_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">stats_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">work_lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nofail_skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">t3_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg_addr</span><span class="p">);</span>

	<span class="n">CH_DBG</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MMIO</span><span class="p">,</span> <span class="s">&quot;read register 0x%x value 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t3_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CH_DBG</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MMIO</span><span class="p">,</span> <span class="s">&quot;setting register 0x%x to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="nf">adap2pinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">phy2portid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">port0</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">port0</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define OFFLOAD_DEVMAP_BIT 15</span>

<span class="cp">#define tdev2adap(d) container_of(d, struct adapter, tdev)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">offload_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">OFFLOAD_DEVMAP_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">t3_offload_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">t3_os_ext_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_os_link_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link_status</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_os_phymod_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_os_link_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_os_link_fault_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">t3_sge_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_sge_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_start_sge_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_stop_sge_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_free_sge_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_sge_err_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="n">irq_handler_t</span> <span class="n">t3_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polling</span><span class="p">);</span>
<span class="n">netdev_tx_t</span> <span class="n">t3_eth_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">t3_mgmt_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">t3_update_qset_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">sge_qset</span> <span class="o">*</span><span class="n">qs</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qset_params</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">t3_sge_alloc_qset</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nports</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">irq_vec_idx</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qset_params</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">ntxq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">netdevq</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">cxgb3_wq</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">t3_get_edc_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">edc_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>

<span class="cp">#endif				</span><span class="cm">/* __T3_ADAPTER_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
