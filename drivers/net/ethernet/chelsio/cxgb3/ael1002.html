<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb3 › ael1002.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ael1002.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2008 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;regs.h&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">AEL100X_TX_CONFIG1</span> <span class="o">=</span> <span class="mh">0xc002</span><span class="p">,</span>
	<span class="n">AEL1002_PWR_DOWN_HI</span> <span class="o">=</span> <span class="mh">0xc011</span><span class="p">,</span>
	<span class="n">AEL1002_PWR_DOWN_LO</span> <span class="o">=</span> <span class="mh">0xc012</span><span class="p">,</span>
	<span class="n">AEL1002_XFI_EQL</span> <span class="o">=</span> <span class="mh">0xc015</span><span class="p">,</span>
	<span class="n">AEL1002_LB_EN</span> <span class="o">=</span> <span class="mh">0xc017</span><span class="p">,</span>
	<span class="n">AEL_OPT_SETTINGS</span> <span class="o">=</span> <span class="mh">0xc017</span><span class="p">,</span>
	<span class="n">AEL_I2C_CTRL</span> <span class="o">=</span> <span class="mh">0xc30a</span><span class="p">,</span>
	<span class="n">AEL_I2C_DATA</span> <span class="o">=</span> <span class="mh">0xc30b</span><span class="p">,</span>
	<span class="n">AEL_I2C_STAT</span> <span class="o">=</span> <span class="mh">0xc30c</span><span class="p">,</span>
	<span class="n">AEL2005_GPIO_CTRL</span> <span class="o">=</span> <span class="mh">0xc214</span><span class="p">,</span>
	<span class="n">AEL2005_GPIO_STAT</span> <span class="o">=</span> <span class="mh">0xc215</span><span class="p">,</span>

	<span class="n">AEL2020_GPIO_INTR</span>   <span class="o">=</span> <span class="mh">0xc103</span><span class="p">,</span>	<span class="cm">/* Latch High (LH) */</span>
	<span class="n">AEL2020_GPIO_CTRL</span>   <span class="o">=</span> <span class="mh">0xc108</span><span class="p">,</span>	<span class="cm">/* Store Clear (SC) */</span>
	<span class="n">AEL2020_GPIO_STAT</span>   <span class="o">=</span> <span class="mh">0xc10c</span><span class="p">,</span>	<span class="cm">/* Read Only (RO) */</span>
	<span class="n">AEL2020_GPIO_CFG</span>    <span class="o">=</span> <span class="mh">0xc110</span><span class="p">,</span>	<span class="cm">/* Read Write (RW) */</span>

	<span class="n">AEL2020_GPIO_SDA</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* IN: i2c serial data */</span>
	<span class="n">AEL2020_GPIO_MODDET</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* IN: Module Detect */</span>
	<span class="n">AEL2020_GPIO_0</span>      <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/* IN: unassigned */</span>
	<span class="n">AEL2020_GPIO_1</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* OUT: unassigned */</span>
	<span class="n">AEL2020_GPIO_LSTAT</span>  <span class="o">=</span> <span class="n">AEL2020_GPIO_1</span><span class="p">,</span> <span class="cm">/* wired to link status LED */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">edc_none</span><span class="p">,</span> <span class="n">edc_sr</span><span class="p">,</span> <span class="n">edc_twinax</span> <span class="p">};</span>

<span class="cm">/* PHY module I2C device address */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MODULE_DEV_ADDR</span>	<span class="o">=</span> <span class="mh">0xa0</span><span class="p">,</span>
	<span class="n">SFF_DEV_ADDR</span>	<span class="o">=</span> <span class="mh">0xa2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* PHY transceiver type */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">phy_transtype_unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">phy_transtype_sfp</span>     <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">phy_transtype_xfp</span>     <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define AEL2005_MODDET_IRQ 4</span>

<span class="k">struct</span> <span class="n">reg_val</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mmd_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clear_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">set_bits</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_phy_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="o">*</span><span class="n">rv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rv</span><span class="o">-&gt;</span><span class="n">mmd_addr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">;</span> <span class="n">rv</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="o">-&gt;</span><span class="n">clear_bits</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">rv</span><span class="o">-&gt;</span><span class="n">mmd_addr</span><span class="p">,</span> <span class="n">rv</span><span class="o">-&gt;</span><span class="n">reg_addr</span><span class="p">,</span>
					    <span class="n">rv</span><span class="o">-&gt;</span><span class="n">set_bits</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_change_bits</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">rv</span><span class="o">-&gt;</span><span class="n">mmd_addr</span><span class="p">,</span>
						  <span class="n">rv</span><span class="o">-&gt;</span><span class="n">reg_addr</span><span class="p">,</span> <span class="n">rv</span><span class="o">-&gt;</span><span class="n">clear_bits</span><span class="p">,</span>
						  <span class="n">rv</span><span class="o">-&gt;</span><span class="n">set_bits</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ael100x_txon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tx_on_gpio</span> <span class="o">=</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">F_GPIO7_OUT_VAL</span> <span class="o">:</span> <span class="n">F_GPIO2_OUT_VAL</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_T3DBG_GPIO_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_on_gpio</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read an 8-bit word from a device attached to the PHY&#39;s i2c bus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael_i2c_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">word_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL_I2C_CTRL</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">dev_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">word_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL_I2C_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL_I2C_DATA</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CH_WARN</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;PHY %u i2c read of dev.addr %#x.%#x timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">word_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael1002_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_PMA_TXDIS</span><span class="p">,</span> <span class="o">!!</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mdio_set_flag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">,</span>
				    <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_CTRL1</span><span class="p">,</span>
				    <span class="n">MDIO_CTRL1_LPOWER</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael1002_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ael1002_power_down</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL100X_TX_CONFIG1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL1002_PWR_DOWN_HI</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL1002_PWR_DOWN_LO</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL1002_XFI_EQL</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_change_bits</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL1002_LB_EN</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael1002_intr_noop</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get link status for a 10GBASE-R device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_link_status_r</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_ok</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">stat1</span><span class="p">,</span> <span class="n">stat2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				       <span class="n">MDIO_PMA_RXDET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PCS</span><span class="p">,</span>
					   <span class="n">MDIO_PCS_10GBRT_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PHYXS</span><span class="p">,</span>
					   <span class="n">MDIO_PHYXS_LNSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="o">*</span><span class="n">link_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">stat1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stat2</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span><span class="p">)</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cphy_ops</span> <span class="n">ael1002_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ael1002_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_enable</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_disable</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_clear</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_status</span> <span class="o">=</span> <span class="n">get_link_status_r</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_down</span> <span class="o">=</span> <span class="n">ael1002_power_down</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmds</span> <span class="o">=</span> <span class="n">MDIO_DEVS_PMAPMD</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PCS</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PHYXS</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">t3_ael1002_phy_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">mdio_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cphy_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ael1002_ops</span><span class="p">,</span> <span class="n">mdio_ops</span><span class="p">,</span>
		  <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">,</span>
		   <span class="s">&quot;10GBASE-R&quot;</span><span class="p">);</span>
	<span class="n">ael100x_txon</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael1006_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t3_phy_reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cphy_ops</span> <span class="n">ael1006_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ael1006_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_enable</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_disable</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_clear</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_clear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_status</span> <span class="o">=</span> <span class="n">get_link_status_r</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_down</span> <span class="o">=</span> <span class="n">ael1002_power_down</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmds</span> <span class="o">=</span> <span class="n">MDIO_DEVS_PMAPMD</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PCS</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PHYXS</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">t3_ael1006_phy_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">mdio_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cphy_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ael1006_ops</span><span class="p">,</span> <span class="n">mdio_ops</span><span class="p">,</span>
		  <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">,</span>
		   <span class="s">&quot;10GBASE-SR&quot;</span><span class="p">);</span>
	<span class="n">ael100x_txon</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Decode our module type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2xxx_get_module_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay_ms</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">delay_ms</span><span class="p">);</span>

	<span class="cm">/* see SFF-8472 for below */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">ael_i2c_rd</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MODULE_DEV_ADDR</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_modtype_sr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_modtype_lr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_modtype_lrm</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">ael_i2c_rd</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MODULE_DEV_ADDR</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">ael_i2c_rd</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MODULE_DEV_ADDR</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">ael_i2c_rd</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MODULE_DEV_ADDR</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="n">phy_modtype_twinax_long</span> <span class="o">:</span> <span class="n">phy_modtype_twinax</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">unknown:</span>
	<span class="k">return</span> <span class="n">phy_modtype_unknown</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Code to support the Aeluros/NetLogic 2005 10Gb PHY.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_setup_sr_edc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc003</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x181</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc010</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x448a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc04a</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x5200</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="n">edc_sr</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_get_edc_fw</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">EDC_OPT_AEL2005</span><span class="p">,</span>
				    <span class="n">EDC_OPT_AEL2005_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">EDC_OPT_AEL2005_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_cache</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_cache</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">edc_sr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_setup_twinax_edc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">modtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc04a</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x5a00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">preemphasis</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc014</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xfe16</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc015</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xa000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">modtype</span> <span class="o">==</span> <span class="n">phy_modtype_twinax_long</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">preemphasis</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="n">edc_twinax</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_get_edc_fw</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">EDC_TWX_AEL2005</span><span class="p">,</span>
				    <span class="n">EDC_TWX_AEL2005_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">EDC_TWX_AEL2005_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_cache</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_cache</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">edc_twinax</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_get_module_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2005_GPIO_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>			<span class="cm">/* module absent */</span>
		<span class="k">return</span> <span class="n">phy_modtype_none</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ael2xxx_get_module_type</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">delay_ms</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2005_GPIO_CTRL</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">t3_phy_lasi_intr_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2005_GPIO_CTRL</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">t3_phy_lasi_intr_disable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_intr_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2005_GPIO_CTRL</span><span class="p">,</span> <span class="mh">0xd00</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">t3_phy_lasi_intr_clear</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">regs0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc017</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc013</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xf341</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc210</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x8000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc210</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x8100</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc210</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x8000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc210</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">regs1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xca00</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0080</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xca12</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lasi_ctrl</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">lasi_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_phy_reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">edc_none</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">regs0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ael2005_get_module_type</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">modtype</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">phy_modtype_twinax</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="n">phy_modtype_twinax_long</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ael2005_setup_twinax_edc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ael2005_setup_sr_edc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">regs1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* reset wipes out interrupts, reenable them if they were on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lasi_ctrl</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ael2005_intr_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2005_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">edc_needed</span><span class="p">,</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2005_GPIO_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">AEL2005_MODDET_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2005_GPIO_CTRL</span><span class="p">,</span>
				    <span class="mh">0xd00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* modules have max 300 ms init time after hot plug */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ael2005_get_module_type</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">modtype</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">phy_modtype_none</span><span class="p">)</span>
			<span class="n">edc_needed</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>       <span class="cm">/* on unplug retain EDC */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">phy_modtype_twinax</span> <span class="o">||</span>
			 <span class="n">ret</span> <span class="o">==</span> <span class="n">phy_modtype_twinax_long</span><span class="p">)</span>
			<span class="n">edc_needed</span> <span class="o">=</span> <span class="n">edc_twinax</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">edc_needed</span> <span class="o">=</span> <span class="n">edc_sr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">edc_needed</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ael2005_reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">cphy_cause_module_change</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="n">cphy_cause_module_change</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_handler</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">cause</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">cphy_cause_link_change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cphy_ops</span> <span class="n">ael2005_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset</span>           <span class="o">=</span> <span class="n">ael2005_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_enable</span>     <span class="o">=</span> <span class="n">ael2005_intr_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_disable</span>    <span class="o">=</span> <span class="n">ael2005_intr_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_clear</span>      <span class="o">=</span> <span class="n">ael2005_intr_clear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>    <span class="o">=</span> <span class="n">ael2005_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_status</span> <span class="o">=</span> <span class="n">get_link_status_r</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_down</span>      <span class="o">=</span> <span class="n">ael1002_power_down</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmds</span>            <span class="o">=</span> <span class="n">MDIO_DEVS_PMAPMD</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PCS</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PHYXS</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">t3_ael2005_phy_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">mdio_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cphy_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ael2005_ops</span><span class="p">,</span> <span class="n">mdio_ops</span><span class="p">,</span>
		  <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
		  <span class="n">SUPPORTED_IRQ</span><span class="p">,</span> <span class="s">&quot;10GBASE-R&quot;</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t3_mdio_change_bits</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL_OPT_SETTINGS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup EDC and other parameters for operation with an optical module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_setup_sr_edc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* set CDR offset to 10 */</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xcc01</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x488a</span> <span class="p">},</span>

		<span class="cm">/* adjust 10G RX bias current */</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xcb1b</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0200</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xcb1c</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x00f0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xcc06</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x00e0</span> <span class="p">},</span>

		<span class="cm">/* end */</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">edc_sr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup EDC and other parameters for operation with an TWINAX module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_setup_twinax_edc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">modtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set uC to 40MHz */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">uCclock40MHz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xff28</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x4001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xff2a</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="cm">/* activate uC clock */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">uCclockActivate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xd000</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x5200</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="cm">/* set PC to start of SRAM and activate uC */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">uCactivate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xd080</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0100</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xd092</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set uC clock and activate it */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">uCclock40MHz</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">uCclockActivate</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="n">edc_twinax</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_get_edc_fw</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">EDC_TWX_AEL2020</span><span class="p">,</span>
				    <span class="n">EDC_TWX_AEL2020_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">EDC_TWX_AEL2020_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_cache</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_cache</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="cm">/* activate uC */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">uCactivate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">edc_twinax</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return Module Type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_get_module_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AEL2020_GPIO_MODDET</span><span class="o">*</span><span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* module absent */</span>
		<span class="k">return</span> <span class="n">phy_modtype_none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ael2xxx_get_module_type</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">delay_ms</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable PHY interrupts.  We enable &quot;Module Detection&quot; interrupts (on any</span>
<span class="cm"> * state transition) and then generic Link Alarm Status Interrupt (LASI).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* output Module&#39;s Loss Of Signal (LOS) to LED */</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_CFG</span><span class="o">+</span><span class="n">AEL2020_GPIO_LSTAT</span><span class="p">,</span>
			<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_CTRL</span><span class="p">,</span>
			<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x8</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AEL2020_GPIO_LSTAT</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">},</span>

		 <span class="cm">/* enable module detect status change interrupts */</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_CTRL</span><span class="p">,</span>
			<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AEL2020_GPIO_MODDET</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">},</span>

		<span class="cm">/* end */</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">link_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set up &quot;link status&quot; LED and enable module change interrupts */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_link_status_r</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_ok</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span>
		<span class="n">t3_link_changed</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">phy2portid</span><span class="p">(</span><span class="n">phy</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable PHY interrupts.  The mirror of the above ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* reset &quot;link status&quot; LED to &quot;off&quot; */</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_CTRL</span><span class="p">,</span>
			<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xb</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AEL2020_GPIO_LSTAT</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">},</span>

		<span class="cm">/* disable module detect status change interrupts */</span>
		<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_CTRL</span><span class="p">,</span>
			<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">AEL2020_GPIO_MODDET</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">},</span>

		<span class="cm">/* end */</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* turn off &quot;link status&quot; LED and disable module change interrupts */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">t3_phy_lasi_intr_disable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear PHY interrupt state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_intr_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The GPIO Interrupt register on the AEL2020 is a &quot;Latching High&quot;</span>
<span class="cm">	 * (LH) register which is cleared to the current state when it&#39;s read.</span>
<span class="cm">	 * Thus, we simply read the register and discard the result.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">t3_phy_lasi_intr_clear</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_val</span> <span class="n">ael2020_reset_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Erratum #2: CDRLOL asserted, causing PMA link down status */</span>
	<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xc003</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x3101</span> <span class="p">},</span>

	<span class="cm">/* force XAUI to send LF when RX_LOS is asserted */</span>
	<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xcd40</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>

	<span class="cm">/* allow writes to transceiver module EEPROM on i2c bus */</span>
	<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xff02</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0023</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xff03</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mh">0xff04</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

	<span class="cm">/* end */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * Reset the PHY and put it into a canonical operating state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lasi_ctrl</span><span class="p">;</span>

	<span class="cm">/* grab current interrupt state */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">lasi_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_phy_reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="mi">125</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* basic initialization for all module types */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">edc_none</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">ael2020_reset_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* determine module type and perform appropriate initialization */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ael2020_get_module_type</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">modtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">phy_modtype_twinax</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="n">phy_modtype_twinax_long</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ael2020_setup_twinax_edc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ael2020_setup_sr_edc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* reset wipes out interrupts, reenable them if they were on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lasi_ctrl</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ael2005_intr_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle a PHY interrupt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ael2020_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">edc_needed</span><span class="p">,</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">AEL2020_GPIO_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">AEL2020_GPIO_MODDET</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* modules have max 300 ms init time after hot plug */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ael2020_get_module_type</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">modtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">phy_modtype_none</span><span class="p">)</span>
			<span class="n">edc_needed</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>       <span class="cm">/* on unplug retain EDC */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">phy_modtype_twinax</span> <span class="o">||</span>
			 <span class="n">ret</span> <span class="o">==</span> <span class="n">phy_modtype_twinax_long</span><span class="p">)</span>
			<span class="n">edc_needed</span> <span class="o">=</span> <span class="n">edc_twinax</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">edc_needed</span> <span class="o">=</span> <span class="n">edc_sr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">edc_needed</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ael2020_reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">cphy_cause_module_change</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="n">cphy_cause_module_change</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_handler</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">cause</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">cphy_cause_link_change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cphy_ops</span> <span class="n">ael2020_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset</span>           <span class="o">=</span> <span class="n">ael2020_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_enable</span>     <span class="o">=</span> <span class="n">ael2020_intr_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_disable</span>    <span class="o">=</span> <span class="n">ael2020_intr_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_clear</span>      <span class="o">=</span> <span class="n">ael2020_intr_clear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>    <span class="o">=</span> <span class="n">ael2020_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_status</span> <span class="o">=</span> <span class="n">get_link_status_r</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_down</span>      <span class="o">=</span> <span class="n">ael1002_power_down</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmds</span>		 <span class="o">=</span> <span class="n">MDIO_DEVS_PMAPMD</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PCS</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PHYXS</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">t3_ael2020_phy_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">mdio_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cphy_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ael2020_ops</span><span class="p">,</span> <span class="n">mdio_ops</span><span class="p">,</span>
		  <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
		  <span class="n">SUPPORTED_IRQ</span><span class="p">,</span> <span class="s">&quot;10GBASE-R&quot;</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">set_phy_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">ael2020_reset_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get link status for a 10GBASE-X device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_link_status_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_ok</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">stat1</span><span class="p">,</span> <span class="n">stat2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
				       <span class="n">MDIO_PMA_RXDET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PCS</span><span class="p">,</span>
					   <span class="n">MDIO_PCS_10GBX_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PHYXS</span><span class="p">,</span>
					   <span class="n">MDIO_PHYXS_LNSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="o">*</span><span class="n">link_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stat1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stat2</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span><span class="p">)</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cphy_ops</span> <span class="n">qt2045_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ael1006_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_enable</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_disable</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_clear</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_clear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span> <span class="o">=</span> <span class="n">t3_phy_lasi_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_status</span> <span class="o">=</span> <span class="n">get_link_status_x</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_down</span> <span class="o">=</span> <span class="n">ael1002_power_down</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmds</span> <span class="o">=</span> <span class="n">MDIO_DEVS_PMAPMD</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PCS</span> <span class="o">|</span> <span class="n">MDIO_DEVS_PHYXS</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">t3_qt2045_phy_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">mdio_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">cphy_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qt2045_ops</span><span class="p">,</span> <span class="n">mdio_ops</span><span class="p">,</span>
		  <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span> <span class="o">|</span> <span class="n">SUPPORTED_TP</span><span class="p">,</span>
		  <span class="s">&quot;10GBASE-CX4&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some cards where the PHY is supposed to be at address 0 actually</span>
<span class="cm">	 * have it at 1.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stat</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xaui_direct_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xaui_direct_get_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_ok</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">prtad</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				     <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_SERDES_STAT0</span><span class="p">,</span> <span class="n">prtad</span><span class="p">))</span> <span class="o">|</span>
		    <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				    <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_SERDES_STAT1</span><span class="p">,</span> <span class="n">prtad</span><span class="p">))</span> <span class="o">|</span>
		    <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_SERDES_STAT2</span><span class="p">,</span> <span class="n">prtad</span><span class="p">))</span> <span class="o">|</span>
		    <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_SERDES_STAT3</span><span class="p">,</span> <span class="n">prtad</span><span class="p">));</span>
		<span class="o">*</span><span class="n">link_ok</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">F_LOWSIG0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span><span class="p">)</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xaui_direct_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cphy_ops</span> <span class="n">xaui_direct_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">xaui_direct_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_enable</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_disable</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_clear</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span> <span class="o">=</span> <span class="n">ael1002_intr_noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_status</span> <span class="o">=</span> <span class="n">xaui_direct_get_link_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_down</span> <span class="o">=</span> <span class="n">xaui_direct_power_down</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">t3_xaui_direct_phy_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">mdio_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cphy_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xaui_direct_ops</span><span class="p">,</span> <span class="n">mdio_ops</span><span class="p">,</span>
		  <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span> <span class="o">|</span> <span class="n">SUPPORTED_TP</span><span class="p">,</span>
		  <span class="s">&quot;10GBASE-CX4&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
