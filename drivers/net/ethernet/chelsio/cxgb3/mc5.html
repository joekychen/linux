<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb3 › mc5.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>mc5.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2003-2008 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;regs.h&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">IDT75P52100</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">IDT75N43102</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">};</span>

<span class="cm">/* DBGI command mode */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DBGI_MODE_MBUS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DBGI_MODE_IDT52100</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">};</span>

<span class="cm">/* IDT 75P52100 commands */</span>
<span class="cp">#define IDT_CMD_READ   0</span>
<span class="cp">#define IDT_CMD_WRITE  1</span>
<span class="cp">#define IDT_CMD_SEARCH 2</span>
<span class="cp">#define IDT_CMD_LEARN  3</span>

<span class="cm">/* IDT LAR register address and value for 144-bit mode (low 32 bits) */</span>
<span class="cp">#define IDT_LAR_ADR0   	0x180006</span>
<span class="cp">#define IDT_LAR_MODE144	0xffff0000</span>

<span class="cm">/* IDT SCR and SSR addresses (low 32 bits) */</span>
<span class="cp">#define IDT_SCR_ADR0  0x180000</span>
<span class="cp">#define IDT_SSR0_ADR0 0x180002</span>
<span class="cp">#define IDT_SSR1_ADR0 0x180004</span>

<span class="cm">/* IDT GMR base address (low 32 bits) */</span>
<span class="cp">#define IDT_GMR_BASE_ADR0 0x180020</span>

<span class="cm">/* IDT data and mask array base addresses (low 32 bits) */</span>
<span class="cp">#define IDT_DATARY_BASE_ADR0 0</span>
<span class="cp">#define IDT_MSKARY_BASE_ADR0 0x80000</span>

<span class="cm">/* IDT 75N43102 commands */</span>
<span class="cp">#define IDT4_CMD_SEARCH144 3</span>
<span class="cp">#define IDT4_CMD_WRITE     4</span>
<span class="cp">#define IDT4_CMD_READ      5</span>

<span class="cm">/* IDT 75N43102 SCR address (low 32 bits) */</span>
<span class="cp">#define IDT4_SCR_ADR0  0x3</span>

<span class="cm">/* IDT 75N43102 GMR base addresses (low 32 bits) */</span>
<span class="cp">#define IDT4_GMR_BASE0 0x10</span>
<span class="cp">#define IDT4_GMR_BASE1 0x20</span>
<span class="cp">#define IDT4_GMR_BASE2 0x30</span>

<span class="cm">/* IDT 75N43102 data and mask array base addresses (low 32 bits) */</span>
<span class="cp">#define IDT4_DATARY_BASE_ADR0 0x1000000</span>
<span class="cp">#define IDT4_MSKARY_BASE_ADR0 0x2000000</span>

<span class="cp">#define MAX_WRITE_ATTEMPTS 5</span>

<span class="cp">#define MAX_ROUTES 2048</span>

<span class="cm">/*</span>
<span class="cm"> * Issue a command to the TCAM and wait for its completion.  The address and</span>
<span class="cm"> * any data required by the command must have been setup by the caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mc5_cmd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_RSP_STATUS</span><span class="p">,</span>
			       <span class="n">F_DBGIRSPVALID</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MAX_WRITE_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dbgi_wr_addr3</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v2</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">v3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_ADDR0</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_ADDR1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_ADDR2</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dbgi_wr_data3</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v2</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">v3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_DATA0</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_DATA1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_DATA2</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dbgi_rd_rsp3</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">v1</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">v2</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">v3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">v1</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_RSP_DATA0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">v2</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_RSP_DATA1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">v3</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_RSP_DATA2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write data to the TCAM register at address (0, 0, addr_lo) using the TCAM</span>
<span class="cm"> * command cmd.  The data to be written must have been set up by the caller.</span>
<span class="cm"> * Returns -1 on failure, 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mc5_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_ADDR0</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc5_cmd_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;MC5 timeout writing to TCAM address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">addr_lo</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_mask_data_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask_array_base</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">data_array_base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">write_cmd</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">addr_shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need the size of the TCAM data and mask arrays in terms of</span>
<span class="cm">	 * 72-bit entries.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size72</span> <span class="o">=</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">tcam_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">server_base</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_SERVER_INDEX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MC5_MODE_144_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size72</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 1 144-bit entry is 2 72-bit entries */</span>
		<span class="n">server_base</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the data array */</span>
	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size72</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_array_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">addr_shift</span><span class="p">),</span>
			      <span class="n">write_cmd</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Initialize the mask array. */</span>
	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size72</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">server_base</span><span class="p">)</span>	<span class="cm">/* entering server or routing region */</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_DATA0</span><span class="p">,</span>
				     <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MC5_MODE_144_BIT</span> <span class="o">?</span>
				     <span class="mh">0xfffffff9</span> <span class="o">:</span> <span class="mh">0xfffffffd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mask_array_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">addr_shift</span><span class="p">),</span>
			      <span class="n">write_cmd</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_idt52100</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_RSP_LATENCY</span><span class="p">,</span>
		     <span class="n">V_RDLAT</span><span class="p">(</span><span class="mh">0x15</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_LRNLAT</span><span class="p">(</span><span class="mh">0x15</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_SRCHLAT</span><span class="p">(</span><span class="mh">0x15</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_PART_ID_INDEX</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use GMRs 14-15 for ELOOKUP, GMRs 12-13 for SYN lookups, and</span>
<span class="cm">	 * GMRs 8-9 for ACK- and AOPEN searches.</span>
<span class="cm">	 */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_POPEN_DATA_WR_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_POPEN_MASK_WR_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_AOPEN_SRCH_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_SEARCH</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_AOPEN_LRN_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_LEARN</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_SYN_SRCH_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_SEARCH</span> <span class="o">|</span> <span class="mh">0x6000</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_SYN_LRN_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_LEARN</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ACK_SRCH_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_SEARCH</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ACK_LRN_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_LEARN</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ILOOKUP_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_SEARCH</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ELOOKUP_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_SEARCH</span> <span class="o">|</span> <span class="mh">0x7000</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DATA_WRITE_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DATA_READ_CMD</span><span class="p">,</span> <span class="n">IDT_CMD_READ</span><span class="p">);</span>

	<span class="cm">/* Set DBGI command mode for IDT TCAM. */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_CONFIG</span><span class="p">,</span> <span class="n">DBGI_MODE_IDT52100</span><span class="p">);</span>

	<span class="cm">/* Set up LAR */</span>
	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT_LAR_MODE144</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT_LAR_ADR0</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set up SSRs */</span>
	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT_SSR0_ADR0</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT_SSR1_ADR0</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set up GMRs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xfffffff9</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xfffffff9</span><span class="p">,</span> <span class="mh">0xffff8007</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT_GMR_BASE_ADR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up SCR */</span>
	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT_SCR_ADR0</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">init_mask_data_array</span><span class="p">(</span><span class="n">mc5</span><span class="p">,</span> <span class="n">IDT_MSKARY_BASE_ADR0</span><span class="p">,</span>
				    <span class="n">IDT_DATARY_BASE_ADR0</span><span class="p">,</span> <span class="n">IDT_CMD_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_idt43102</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_RSP_LATENCY</span><span class="p">,</span>
		     <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">V_RDLAT</span><span class="p">(</span><span class="mh">0xd</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_SRCHLAT</span><span class="p">(</span><span class="mh">0x11</span><span class="p">)</span> <span class="o">:</span>
		     <span class="n">V_RDLAT</span><span class="p">(</span><span class="mh">0xd</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_SRCHLAT</span><span class="p">(</span><span class="mh">0x12</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use GMRs 24-25 for ELOOKUP, GMRs 20-21 for SYN lookups, and no mask</span>
<span class="cm">	 * for ACK- and AOPEN searches.</span>
<span class="cm">	 */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_POPEN_DATA_WR_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_POPEN_MASK_WR_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_AOPEN_SRCH_CMD</span><span class="p">,</span>
		     <span class="n">IDT4_CMD_SEARCH144</span> <span class="o">|</span> <span class="mh">0x3800</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_SYN_SRCH_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_SEARCH144</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ACK_SRCH_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_SEARCH144</span> <span class="o">|</span> <span class="mh">0x3800</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ILOOKUP_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_SEARCH144</span> <span class="o">|</span> <span class="mh">0x3800</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ELOOKUP_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_SEARCH144</span> <span class="o">|</span> <span class="mh">0x800</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DATA_WRITE_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DATA_READ_CMD</span><span class="p">,</span> <span class="n">IDT4_CMD_READ</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_PART_ID_INDEX</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Set DBGI command mode for IDT TCAM. */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_CONFIG</span><span class="p">,</span> <span class="n">DBGI_MODE_IDT52100</span><span class="p">);</span>

	<span class="cm">/* Set up GMRs */</span>
	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT4_GMR_BASE0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT4_GMR_BASE2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xfffffff9</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT4_GMR_BASE1</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT4_GMR_BASE1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT4_GMR_BASE1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xfffffff9</span><span class="p">,</span> <span class="mh">0xffff8007</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT4_GMR_BASE1</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set up SCR */</span>
	<span class="n">dbgi_wr_data3</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mh">0xf0000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc5_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">IDT4_SCR_ADR0</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">init_mask_data_array</span><span class="p">(</span><span class="n">mc5</span><span class="p">,</span> <span class="n">IDT4_MSKARY_BASE_ADR0</span><span class="p">,</span>
				    <span class="n">IDT4_DATARY_BASE_ADR0</span><span class="p">,</span> <span class="n">IDT4_CMD_WRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put MC5 in DBGI mode. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mc5_dbgi_mode_enable</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_CONFIG</span><span class="p">,</span>
		     <span class="n">V_TMMODE</span><span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MC5_MODE_72_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_DBGIEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Put MC5 in M-Bus mode. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mc5_dbgi_mode_disable</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_CONFIG</span><span class="p">,</span>
		     <span class="n">V_TMMODE</span><span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MC5_MODE_72_BIT</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_COMPEN</span><span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MC5_MODE_72_BIT</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_PRTYEN</span><span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">parity_enabled</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_MBUSEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialization that requires the OS and protocol layers to already</span>
<span class="cm"> * be initialized goes here.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_mc5_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nservers</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nfilters</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nroutes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcam_size</span> <span class="o">=</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">tcam_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcam_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nroutes</span> <span class="o">&gt;</span> <span class="n">MAX_ROUTES</span> <span class="o">||</span> <span class="n">nroutes</span> <span class="o">+</span> <span class="n">nservers</span> <span class="o">+</span> <span class="n">nfilters</span> <span class="o">&gt;</span> <span class="n">tcam_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Reset the TCAM */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">F_TMMODE</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">V_TMMODE</span><span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MC5_MODE_72_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_TMRST</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_CONFIG</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_CONFIG</span><span class="p">,</span> <span class="n">F_TMRDY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;TCAM reset timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_ROUTING_TABLE_INDEX</span><span class="p">,</span> <span class="n">tcam_size</span> <span class="o">-</span> <span class="n">nroutes</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_FILTER_TABLE</span><span class="p">,</span>
		     <span class="n">tcam_size</span> <span class="o">-</span> <span class="n">nroutes</span> <span class="o">-</span> <span class="n">nfilters</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_SERVER_INDEX</span><span class="p">,</span>
		     <span class="n">tcam_size</span> <span class="o">-</span> <span class="n">nroutes</span> <span class="o">-</span> <span class="n">nfilters</span> <span class="o">-</span> <span class="n">nservers</span><span class="p">);</span>

	<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">parity_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* All the TCAM addresses we access have only the low 32 bits non 0 */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_ADDR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_DBGI_REQ_ADDR2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mc5_dbgi_mode_enable</span><span class="p">(</span><span class="n">mc5</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mc5</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IDT75P52100</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">init_idt52100</span><span class="p">(</span><span class="n">mc5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IDT75N43102</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">init_idt43102</span><span class="p">(</span><span class="n">mc5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;Unsupported TCAM type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mc5_dbgi_mode_disable</span><span class="p">(</span><span class="n">mc5</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define MC5_INT_FATAL (F_PARITYERR | F_REQQPARERR | F_DISPQPARERR)</span>

<span class="cm">/*</span>
<span class="cm"> * MC5 interrupt handler</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_mc5_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_INT_CAUSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_PARITYERR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mc5</span><span class="o">-&gt;</span><span class="n">parity_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;MC5 parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">parity_err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_REQQPARERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;MC5 request queue parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">reqq_parity_err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_DISPQPARERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;MC5 dispatch queue parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dispq_parity_err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_ACTRGNFULL</span><span class="p">)</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">active_rgn_full</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_NFASRCHFAIL</span><span class="p">)</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">nfa_srch_err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_UNKNOWNCMD</span><span class="p">)</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">unknown_cmd</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_DELACTEMPTY</span><span class="p">)</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">del_act_empty</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">MC5_INT_FATAL</span><span class="p">)</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MC5_DB_INT_CAUSE</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_mc5_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mc5</span> <span class="o">*</span><span class="n">mc5</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define K * 1024</span>

	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcam_part_size</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* in K 72-bit entries */</span>
		<span class="mi">64</span> <span class="n">K</span><span class="p">,</span> <span class="mi">128</span> <span class="n">K</span><span class="p">,</span> <span class="mi">256</span> <span class="n">K</span><span class="p">,</span> <span class="mi">32</span> <span class="n">K</span>
	<span class="p">};</span>

<span class="cp">#undef K</span>

	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_CONFIG</span><span class="p">);</span>

	<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">part_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">G_TMTYPE</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">F_TMTYPEHI</span><span class="p">)</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">part_type</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">tcam_size</span> <span class="o">=</span> <span class="n">tcam_part_size</span><span class="p">[</span><span class="n">G_TMPARTSIZE</span><span class="p">(</span><span class="n">cfg</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MC5_MODE_144_BIT</span><span class="p">)</span>
		<span class="n">mc5</span><span class="o">-&gt;</span><span class="n">tcam_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
