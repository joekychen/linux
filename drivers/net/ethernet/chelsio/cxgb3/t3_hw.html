<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb3 › t3_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>t3_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2003-2008 Chelsio, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;regs.h&quot;</span>
<span class="cp">#include &quot;sge_defs.h&quot;</span>
<span class="cp">#include &quot;firmware_exports.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">t3_port_intr_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_wait_op_done_val - wait until an operation is completed</span>
<span class="cm"> *	@adapter: the adapter performing the operation</span>
<span class="cm"> *	@reg: the register to check for completion</span>
<span class="cm"> *	@mask: a single-bit field within @reg that indicates completion</span>
<span class="cm"> *	@polarity: the value of the field when the operation is completed</span>
<span class="cm"> *	@attempts: number of check iterations</span>
<span class="cm"> *	@delay: delay in usecs between iterations</span>
<span class="cm"> *	@valp: where to store the value of the register at completion time</span>
<span class="cm"> *</span>
<span class="cm"> *	Wait until an operation is completed by checking a bit in a register</span>
<span class="cm"> *	up to @attempts times.  If @valp is not NULL the value of the register</span>
<span class="cm"> *	at the time it indicated completion is stored there.  Returns 0 if the</span>
<span class="cm"> *	operation completes and -EAGAIN otherwise.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">t3_wait_op_done_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">polarity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attempts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">polarity</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">valp</span><span class="p">)</span>
				<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">attempts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_write_regs - write a bunch of registers</span>
<span class="cm"> *	@adapter: the adapter to program</span>
<span class="cm"> *	@p: an array of register address/register value pairs</span>
<span class="cm"> *	@n: the number of address/value pairs</span>
<span class="cm"> *	@offset: register address offset</span>
<span class="cm"> *</span>
<span class="cm"> *	Takes an array of register address/register value pairs and writes each</span>
<span class="cm"> *	value to the corresponding register.  Register addresses are adjusted</span>
<span class="cm"> *	by the supplied offset.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">addr_val_pair</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">reg_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_set_reg_field - set a register field to a value</span>
<span class="cm"> *	@adapter: the adapter to program</span>
<span class="cm"> *	@addr: the register address</span>
<span class="cm"> *	@mask: specifies the portion of the register to modify</span>
<span class="cm"> *	@val: the new value for the register field</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets a register field specified by the supplied mask to the</span>
<span class="cm"> *	given value.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_set_reg_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>	<span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_read_indirect - read indirectly addressed registers</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@addr_reg: register holding the indirect address</span>
<span class="cm"> *	@data_reg: register holding the value of the indirect register</span>
<span class="cm"> *	@vals: where the read register values are stored</span>
<span class="cm"> *	@start_idx: index of first indirect register to read</span>
<span class="cm"> *	@nregs: how many indirect registers to read</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads registers that are accessed indirectly through an address/data</span>
<span class="cm"> *	register pair.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">t3_read_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr_reg</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nregs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nregs</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">addr_reg</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">);</span>
		<span class="o">*</span><span class="n">vals</span><span class="o">++</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
		<span class="n">start_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_mc7_bd_read - read from MC7 through backdoor accesses</span>
<span class="cm"> *	@mc7: identifies MC7 to read from</span>
<span class="cm"> *	@start: index of first 64-bit word to read</span>
<span class="cm"> *	@n: number of 64-bit words to read</span>
<span class="cm"> *	@buf: where to store the read result</span>
<span class="cm"> *</span>
<span class="cm"> *	Read n 64-bit words from MC7 starting at word start, using backdoor</span>
<span class="cm"> *	accesses.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_mc7_bd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc7</span> <span class="o">*</span><span class="n">mc7</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span>
		   <span class="n">u64</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">step</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span> <span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size64</span> <span class="o">=</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* # of 64-bit words */</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">size64</span> <span class="o">||</span> <span class="n">start</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">size64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">attempts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BD_ADDR</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BD_OP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BD_OP</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">F_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">attempts</span><span class="o">--</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
						  <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BD_OP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">F_BUSY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BD_DATA1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mc7</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val64</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
						    <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span>
						    <span class="n">A_MC7_BD_DATA0</span><span class="p">);</span>
				<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mc7</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">[</span><span class="n">mc7</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">];</span>
				<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="n">mc7</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">start</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">val64</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize MI1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mi1_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">adapter_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clkdiv</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">cclk</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">mdc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">F_PREEN</span> <span class="o">|</span> <span class="n">V_CLKDIV</span><span class="p">(</span><span class="n">clkdiv</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MI1_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MDIO_ATTEMPTS 20</span>

<span class="cm">/*</span>
<span class="cm"> * MI1 read/write operations for clause 22 PHYs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_mi1_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mmd_addr</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">V_REGADDR</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PHYADDR</span><span class="p">(</span><span class="n">phy_addr</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_CFG</span><span class="p">,</span> <span class="n">V_ST</span><span class="p">(</span><span class="n">M_ST</span><span class="p">),</span> <span class="n">V_ST</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">V_MDI_OP</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">F_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MDIO_ATTEMPTS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_DATA</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_mi1_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mmd_addr</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">V_REGADDR</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PHYADDR</span><span class="p">(</span><span class="n">phy_addr</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_CFG</span><span class="p">,</span> <span class="n">V_ST</span><span class="p">(</span><span class="n">M_ST</span><span class="p">),</span> <span class="n">V_ST</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">V_MDI_OP</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">F_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MDIO_ATTEMPTS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="n">mi1_mdio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">t3_mi1_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">t3_mi1_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_support</span> <span class="o">=</span> <span class="n">MDIO_SUPPORTS_C22</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Performs the address cycle for clause 45 PHYs.</span>
<span class="cm"> * Must be called with the MDIO_LOCK held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mi1_wr_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mmd_addr</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">V_REGADDR</span><span class="p">(</span><span class="n">mmd_addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PHYADDR</span><span class="p">(</span><span class="n">phy_addr</span><span class="p">);</span>

	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_CFG</span><span class="p">,</span> <span class="n">V_ST</span><span class="p">(</span><span class="n">M_ST</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_DATA</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">V_MDI_OP</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">F_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">MDIO_ATTEMPTS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MI1 read/write operations for indirect-addressed PHYs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mi1_ext_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mmd_addr</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mi1_wr_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">mmd_addr</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">V_MDI_OP</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">F_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">MDIO_ATTEMPTS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_DATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mi1_ext_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mmd_addr</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mi1_wr_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">mmd_addr</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">V_MDI_OP</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MI1_OP</span><span class="p">,</span> <span class="n">F_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">MDIO_ATTEMPTS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="n">mi1_mdio_ext_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">mi1_ext_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">mi1_ext_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_support</span> <span class="o">=</span> <span class="n">MDIO_SUPPORTS_C45</span> <span class="o">|</span> <span class="n">MDIO_EMULATE_C22</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_mdio_change_bits - modify the value of a PHY register</span>
<span class="cm"> *	@phy: the PHY to operate on</span>
<span class="cm"> *	@mmd: the device address</span>
<span class="cm"> *	@reg: the register address</span>
<span class="cm"> *	@clear: what part of the register value to mask off</span>
<span class="cm"> *	@set: what part of the register value to set</span>
<span class="cm"> *</span>
<span class="cm"> *	Changes the value of a PHY register by applying a mask to its current</span>
<span class="cm"> *	value and ORing the result with a new value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_mdio_change_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">mmd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clear</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">mmd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">set</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_phy_reset - reset a PHY block</span>
<span class="cm"> *	@phy: the PHY to operate on</span>
<span class="cm"> *	@mmd: the device address of the PHY block to reset</span>
<span class="cm"> *	@wait: how long to wait for the reset to complete in 1ms increments</span>
<span class="cm"> *</span>
<span class="cm"> *	Resets a PHY block and optionally waits for the reset to complete.</span>
<span class="cm"> *	@mmd should be 0 for 10/100/1000 PHYs and the device address to reset</span>
<span class="cm"> *	for 10G PHYs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_change_bits</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">mmd</span><span class="p">,</span> <span class="n">MDIO_CTRL1</span><span class="p">,</span> <span class="n">MDIO_CTRL1_LPOWER</span><span class="p">,</span>
				  <span class="n">MDIO_CTRL1_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="o">!</span><span class="n">wait</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">mmd</span><span class="p">,</span> <span class="n">MDIO_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="n">MDIO_CTRL1_RESET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ctl</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_phy_advertise - set the PHY advertisement registers for autoneg</span>
<span class="cm"> *	@phy: the PHY to operate on</span>
<span class="cm"> *	@advert: bitmap of capabilities the PHY should advertise</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets a 10/100/1000 PHY&#39;s advertisement registers to advertise the</span>
<span class="cm"> *	requested capabilities.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_phy_advertise</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">advert</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_1000HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000HALF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_Pause</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_CAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_phy_advertise_fiber - set fiber PHY advertisement register</span>
<span class="cm"> *	@phy: the PHY to operate on</span>
<span class="cm"> *	@advert: bitmap of capabilities the PHY should advertise</span>
<span class="cm"> *</span>
<span class="cm"> *	Sets a fiber PHY&#39;s advertisement register to advertise the</span>
<span class="cm"> *	requested capabilities.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_phy_advertise_fiber</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">advert</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XHALF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XFULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_Pause</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_set_phy_speed_duplex - force PHY speed and duplex</span>
<span class="cm"> *	@phy: the PHY to operate on</span>
<span class="cm"> *	@speed: requested PHY speed</span>
<span class="cm"> *	@duplex: requested PHY duplex</span>
<span class="cm"> *</span>
<span class="cm"> *	Force a 10/100/1000 PHY&#39;s speed and duplex.  This also disables</span>
<span class="cm"> *	auto-negotiation except for GigE, where auto-negotiation is mandatory.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_set_phy_speed_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_SPEED100</span> <span class="o">|</span> <span class="n">BMCR_SPEED1000</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="n">ctl</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">ctl</span> <span class="o">|=</span> <span class="n">BMCR_SPEED1000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_FULLDPLX</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">ctl</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED1000</span><span class="p">)</span> <span class="cm">/* auto-negotiation required for GigE */</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_phy_lasi_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span>
			     <span class="n">MDIO_PMA_LASI_LSALARM</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_phy_lasi_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t3_mdio_write</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_phy_lasi_intr_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_phy_lasi_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t3_mdio_read</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_LASI_LSALARM</span><span class="p">)</span> <span class="o">?</span> <span class="n">cphy_cause_link_change</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">adapter_info</span> <span class="n">t3_adap_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="n">F_GPIO2_OEN</span> <span class="o">|</span> <span class="n">F_GPIO4_OEN</span> <span class="o">|</span>
	 <span class="n">F_GPIO2_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO4_OUT_VAL</span><span class="p">,</span> <span class="p">{</span> <span class="n">S_GPIO3</span><span class="p">,</span> <span class="n">S_GPIO5</span> <span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">mi1_mdio_ops</span><span class="p">,</span> <span class="s">&quot;Chelsio PE9000&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="n">F_GPIO2_OEN</span> <span class="o">|</span> <span class="n">F_GPIO4_OEN</span> <span class="o">|</span>
	 <span class="n">F_GPIO2_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO4_OUT_VAL</span><span class="p">,</span> <span class="p">{</span> <span class="n">S_GPIO3</span><span class="p">,</span> <span class="n">S_GPIO5</span> <span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">mi1_mdio_ops</span><span class="p">,</span> <span class="s">&quot;Chelsio T302&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="n">F_GPIO1_OEN</span> <span class="o">|</span> <span class="n">F_GPIO6_OEN</span> <span class="o">|</span> <span class="n">F_GPIO7_OEN</span> <span class="o">|</span> <span class="n">F_GPIO10_OEN</span> <span class="o">|</span>
	 <span class="n">F_GPIO11_OEN</span> <span class="o">|</span> <span class="n">F_GPIO1_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO6_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO10_OUT_VAL</span><span class="p">,</span>
	 <span class="p">{</span> <span class="mi">0</span> <span class="p">},</span> <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">mi1_mdio_ext_ops</span><span class="p">,</span> <span class="s">&quot;Chelsio T310&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="n">F_GPIO1_OEN</span> <span class="o">|</span> <span class="n">F_GPIO2_OEN</span> <span class="o">|</span> <span class="n">F_GPIO4_OEN</span> <span class="o">|</span> <span class="n">F_GPIO5_OEN</span> <span class="o">|</span> <span class="n">F_GPIO6_OEN</span> <span class="o">|</span>
	 <span class="n">F_GPIO7_OEN</span> <span class="o">|</span> <span class="n">F_GPIO10_OEN</span> <span class="o">|</span> <span class="n">F_GPIO11_OEN</span> <span class="o">|</span> <span class="n">F_GPIO1_OUT_VAL</span> <span class="o">|</span>
	 <span class="n">F_GPIO5_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO6_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO10_OUT_VAL</span><span class="p">,</span>
	 <span class="p">{</span> <span class="n">S_GPIO9</span><span class="p">,</span> <span class="n">S_GPIO3</span> <span class="p">},</span> <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">mi1_mdio_ext_ops</span><span class="p">,</span> <span class="s">&quot;Chelsio T320&quot;</span><span class="p">},</span>
	<span class="p">{},</span>
	<span class="p">{},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="n">F_GPIO1_OEN</span> <span class="o">|</span> <span class="n">F_GPIO2_OEN</span> <span class="o">|</span> <span class="n">F_GPIO4_OEN</span> <span class="o">|</span> <span class="n">F_GPIO6_OEN</span> <span class="o">|</span> <span class="n">F_GPIO7_OEN</span> <span class="o">|</span>
	 <span class="n">F_GPIO10_OEN</span> <span class="o">|</span> <span class="n">F_GPIO1_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO6_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO10_OUT_VAL</span><span class="p">,</span>
	 <span class="p">{</span> <span class="n">S_GPIO9</span> <span class="p">},</span> <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">mi1_mdio_ext_ops</span><span class="p">,</span> <span class="s">&quot;Chelsio T310&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="n">F_GPIO1_OEN</span> <span class="o">|</span> <span class="n">F_GPIO6_OEN</span> <span class="o">|</span> <span class="n">F_GPIO7_OEN</span> <span class="o">|</span>
	 <span class="n">F_GPIO1_OUT_VAL</span> <span class="o">|</span> <span class="n">F_GPIO6_OUT_VAL</span><span class="p">,</span>
	 <span class="p">{</span> <span class="n">S_GPIO9</span> <span class="p">},</span> <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_AUI</span><span class="p">,</span>
	 <span class="o">&amp;</span><span class="n">mi1_mdio_ext_ops</span><span class="p">,</span> <span class="s">&quot;Chelsio N320E-G2&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Return the adapter_info structure with a given index.  Out-of-range indices</span>
<span class="cm"> * return NULL.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">adapter_info</span> <span class="o">*</span><span class="nf">t3_get_adapter_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">t3_adap_info</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">t3_adap_info</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">port_type_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">phy_prep</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">port_type_info</span> <span class="n">port_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_ael1002_phy_prep</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_vsc8211_phy_prep</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_xaui_direct_phy_prep</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_ael2005_phy_prep</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_qt2045_phy_prep</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_ael1006_phy_prep</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_aq100x_phy_prep</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">t3_ael2020_phy_prep</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define VPD_ENTRY(name, len) \</span>
<span class="cp">	u8 name##_kword[2]; u8 name##_len; u8 name##_data[len]</span>

<span class="cm">/*</span>
<span class="cm"> * Partial EEPROM Vital Product Data structure.  Includes only the ID and</span>
<span class="cm"> * VPD-R sections.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">t3_vpd</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">id_tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id_len</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">vpdr_tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vpdr_len</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* part number */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* EC level */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">SERNUM_LEN</span><span class="p">);</span> <span class="cm">/* serial number */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>	<span class="cm">/* MAC address base */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">cclk</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* core clock */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">mclk</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* mem clock */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">uclk</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* uP clk */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">mdc</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* MDIO clk */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* mem timing */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">xaui0cfg</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* XAUI0 config */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">xaui1cfg</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* XAUI1 config */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">port0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* PHY0 complex */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* PHY1 complex */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">port2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* PHY2 complex */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">port3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* PHY3 complex */</span>
	<span class="n">VPD_ENTRY</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* csum */</span>
	<span class="n">u32</span> <span class="n">pad</span><span class="p">;</span>		<span class="cm">/* for multiple-of-4 sizing and alignment */</span>
<span class="p">};</span>

<span class="cp">#define EEPROM_MAX_POLL   40</span>
<span class="cp">#define EEPROM_STAT_ADDR  0x4000</span>
<span class="cp">#define VPD_BASE          0xc00</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_seeprom_read - read a VPD EEPROM location</span>
<span class="cm"> *	@adapter: adapter to read</span>
<span class="cm"> *	@addr: EEPROM address</span>
<span class="cm"> *	@data: where to store the read data</span>
<span class="cm"> *</span>
<span class="cm"> *	Read a 32-bit word from a location in VPD EEPROM using the card&#39;s PCI</span>
<span class="cm"> *	VPD ROM capability.  A zero is written to the flag bit when the</span>
<span class="cm"> *	address is written to the control register.  The hardware device will</span>
<span class="cm"> *	set the flag to 1 when 4 bytes have been read into the data register.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_seeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attempts</span> <span class="o">=</span> <span class="n">EEPROM_MAX_POLL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">vpd_cap_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">EEPROMSIZE</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">EEPROM_STAT_ADDR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_VPD_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_VPD_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">attempts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;reading EEPROM address 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_VPD_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_seeprom_write - write a VPD EEPROM location</span>
<span class="cm"> *	@adapter: adapter to write</span>
<span class="cm"> *	@addr: EEPROM address</span>
<span class="cm"> *	@data: value to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Write a 32-bit word to a location in VPD EEPROM using the card&#39;s PCI</span>
<span class="cm"> *	VPD ROM capability.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_seeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attempts</span> <span class="o">=</span> <span class="n">EEPROM_MAX_POLL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">vpd_cap_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">EEPROMSIZE</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">EEPROM_STAT_ADDR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_VPD_DATA</span><span class="p">,</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span><span class="n">base</span> <span class="o">+</span> <span class="n">PCI_VPD_ADDR</span><span class="p">,</span>
			      <span class="n">addr</span> <span class="o">|</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_VPD_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">attempts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;write to EEPROM address 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_seeprom_wp - enable/disable EEPROM write protection</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@enable: 1 to enable write protection, 0 to disable it</span>
<span class="cm"> *</span>
<span class="cm"> *	Enables or disables write protection on the serial EEPROM.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_seeprom_wp</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t3_seeprom_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">EEPROM_STAT_ADDR</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0xc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	get_vpd_params - read VPD parameters from VPD EEPROM</span>
<span class="cm"> *	@adapter: adapter to read</span>
<span class="cm"> *	@p: where to store the parameters</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads card parameters stored in VPD EEPROM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_vpd_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vpd_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3_vpd</span> <span class="n">vpd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Card information is normally at VPD_BASE but some early cards had</span>
<span class="cm">	 * it at 0.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_seeprom_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">VPD_BASE</span><span class="p">,</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">vpd</span><span class="p">.</span><span class="n">id_tag</span> <span class="o">==</span> <span class="mh">0x82</span> <span class="o">?</span> <span class="n">VPD_BASE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpd</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_seeprom_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vpd</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">cclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">cclk_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">mclk_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">uclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">uclk_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mdc</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">mdc_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mem_timing</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">mt_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">,</span> <span class="n">vpd</span><span class="p">.</span><span class="n">sn_data</span><span class="p">,</span> <span class="n">SERNUM_LEN</span><span class="p">);</span>

	<span class="cm">/* Old eeproms didn&#39;t have port information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vpd</span><span class="p">.</span><span class="n">port0_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">port0_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">port1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xauicfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">xaui0cfg_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xauicfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">xaui1cfg_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">eth_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">na_data</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span>
				 <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">vpd</span><span class="p">.</span><span class="n">na_data</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* serial flash and firmware constants */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">SF_ATTEMPTS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* max retries for SF1 operations */</span>
	<span class="n">SF_SEC_SIZE</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>	<span class="cm">/* serial flash sector size */</span>
	<span class="n">SF_SIZE</span> <span class="o">=</span> <span class="n">SF_SEC_SIZE</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/* serial flash size */</span>

	<span class="cm">/* flash command opcodes */</span>
	<span class="n">SF_PROG_PAGE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* program page */</span>
	<span class="n">SF_WR_DISABLE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* disable writes */</span>
	<span class="n">SF_RD_STATUS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* read status register */</span>
	<span class="n">SF_WR_ENABLE</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/* enable writes */</span>
	<span class="n">SF_RD_DATA_FAST</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">,</span>	<span class="cm">/* read flash */</span>
	<span class="n">SF_ERASE_SECTOR</span> <span class="o">=</span> <span class="mh">0xd8</span><span class="p">,</span>	<span class="cm">/* erase sector */</span>

	<span class="n">FW_FLASH_BOOT_ADDR</span> <span class="o">=</span> <span class="mh">0x70000</span><span class="p">,</span>	<span class="cm">/* start address of FW in flash */</span>
	<span class="n">FW_VERS_ADDR</span> <span class="o">=</span> <span class="mh">0x7fffc</span><span class="p">,</span>    <span class="cm">/* flash address holding FW version */</span>
	<span class="n">FW_MIN_SIZE</span> <span class="o">=</span> <span class="mi">8</span>            <span class="cm">/* at least version and csum */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	sf1_read - read data from the serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@byte_cnt: number of bytes to read</span>
<span class="cm"> *	@cont: whether another operation will be chained</span>
<span class="cm"> *	@valp: where to store the read data</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads up to 4 bytes of data from the serial flash.  The location of</span>
<span class="cm"> *	the read needs to be specified prior to calling this by issuing the</span>
<span class="cm"> *	appropriate commands to the serial flash.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sf1_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cont</span><span class="p">,</span>
		    <span class="n">u32</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byte_cnt</span> <span class="o">||</span> <span class="n">byte_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_OP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_OP</span><span class="p">,</span> <span class="n">V_CONT</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_BYTECNT</span><span class="p">(</span><span class="n">byte_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_OP</span><span class="p">,</span> <span class="n">F_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SF_ATTEMPTS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sf1_write - write data to the serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@byte_cnt: number of bytes to write</span>
<span class="cm"> *	@cont: whether another operation will be chained</span>
<span class="cm"> *	@val: value to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Writes up to 4 bytes of data to the serial flash.  The location of</span>
<span class="cm"> *	the write needs to be specified prior to calling this by issuing the</span>
<span class="cm"> *	appropriate commands to the serial flash.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sf1_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cont</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byte_cnt</span> <span class="o">||</span> <span class="n">byte_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_OP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_OP</span><span class="p">,</span>
		     <span class="n">V_CONT</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_BYTECNT</span><span class="p">(</span><span class="n">byte_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_OP</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SF_OP</span><span class="p">,</span> <span class="n">F_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SF_ATTEMPTS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	flash_wait_op - wait for a flash operation to complete</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@attempts: max number of polls of the status register</span>
<span class="cm"> *	@delay: delay between polls in ms</span>
<span class="cm"> *</span>
<span class="cm"> *	Wait for a flash operation to complete by polling the status register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flash_wait_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attempts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SF_RD_STATUS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">attempts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_read_flash - read words from serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@addr: the start address for the read</span>
<span class="cm"> *	@nwords: how many 32-bit words to read</span>
<span class="cm"> *	@data: where to store the read data</span>
<span class="cm"> *	@byte_oriented: whether to store data as bytes or as words</span>
<span class="cm"> *</span>
<span class="cm"> *	Read the specified number of 32-bit words from the serial flash.</span>
<span class="cm"> *	If @byte_oriented is set the read data is stored as a byte array</span>
<span class="cm"> *	(i.e., big-endian), otherwise as 32-bit words in the platform&#39;s</span>
<span class="cm"> *	natural endianess.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_read_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nwords</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byte_oriented</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">nwords</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SF_SIZE</span> <span class="o">||</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">SF_RD_DATA_FAST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">nwords</span><span class="p">;</span> <span class="n">nwords</span><span class="o">--</span><span class="p">,</span> <span class="n">data</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nwords</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte_oriented</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_write_flash - write up to a page of data to the serial flash</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@addr: the start address to write</span>
<span class="cm"> *	@n: length of data to write</span>
<span class="cm"> *	@data: the data to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Writes up to a page of data (256 bytes) to the serial flash starting</span>
<span class="cm"> *	at the given address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_write_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">SF_SIZE</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">SF_PROG_PAGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SF_WR_ENABLE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="n">left</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">4U</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">left</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">flash_wait_op</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read the page to verify the write succeeded */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_read_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_get_tp_version - read the tp sram version</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@vers: where to place the version</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads the protocol sram version from sram.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_get_tp_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Get version loaded in SRAM */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD0</span><span class="p">,</span>
			      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">vers</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_check_tpsram_version - read the tp sram version</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads the protocol sram version from flash.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_check_tpsram_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vers</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_A</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_get_tp_version</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">major</span> <span class="o">=</span> <span class="n">G_TP_VERSION_MAJOR</span><span class="p">(</span><span class="n">vers</span><span class="p">);</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">G_TP_VERSION_MINOR</span><span class="p">(</span><span class="n">vers</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">==</span> <span class="n">TP_VERSION_MAJOR</span> <span class="o">&amp;&amp;</span> <span class="n">minor</span> <span class="o">==</span> <span class="n">TP_VERSION_MINOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;found wrong TP version (%u.%u), &quot;</span>
		       <span class="s">&quot;driver compiled for version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
		       <span class="n">TP_VERSION_MAJOR</span><span class="p">,</span> <span class="n">TP_VERSION_MINOR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_check_tpsram - check if provided protocol SRAM</span>
<span class="cm"> *			  is compatible with this driver</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@tp_sram: the firmware image to write</span>
<span class="cm"> *	@size: image size</span>
<span class="cm"> *</span>
<span class="cm"> *	Checks if an adapter&#39;s tp sram is compatible with the driver.</span>
<span class="cm"> *	Returns 0 if the versions are compatible, a negative error otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_check_tpsram</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tp_sram</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">csum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">tp_sram</span><span class="p">;</span>

	<span class="cm">/* Verify checksum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;corrupted protocol SRAM image, checksum %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">csum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">fw_version_type</span> <span class="p">{</span>
	<span class="n">FW_VERSION_N3</span><span class="p">,</span>
	<span class="n">FW_VERSION_T3</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_get_fw_version - read the firmware version</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@vers: where to place the version</span>
<span class="cm"> *</span>
<span class="cm"> *	Reads the FW version from flash.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_get_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">t3_read_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">FW_VERS_ADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_check_fw_version - check if the FW is compatible with this driver</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *</span>
<span class="cm"> *	Checks if an adapter&#39;s FW is compatible with the driver.  Returns 0</span>
<span class="cm"> *	if the versions are compatible, a negative error otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_check_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vers</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_get_fw_version</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">G_FW_VERSION_TYPE</span><span class="p">(</span><span class="n">vers</span><span class="p">);</span>
	<span class="n">major</span> <span class="o">=</span> <span class="n">G_FW_VERSION_MAJOR</span><span class="p">(</span><span class="n">vers</span><span class="p">);</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">G_FW_VERSION_MINOR</span><span class="p">(</span><span class="n">vers</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_VERSION_T3</span> <span class="o">&amp;&amp;</span> <span class="n">major</span> <span class="o">==</span> <span class="n">FW_VERSION_MAJOR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">minor</span> <span class="o">==</span> <span class="n">FW_VERSION_MINOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">!=</span> <span class="n">FW_VERSION_MAJOR</span> <span class="o">||</span> <span class="n">minor</span> <span class="o">&lt;</span> <span class="n">FW_VERSION_MINOR</span><span class="p">)</span>
		<span class="n">CH_WARN</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;found old FW minor version(%u.%u), &quot;</span>
		        <span class="s">&quot;driver compiled for version %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
			<span class="n">FW_VERSION_MAJOR</span><span class="p">,</span> <span class="n">FW_VERSION_MINOR</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">CH_WARN</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;found newer FW version(%u.%u), &quot;</span>
		        <span class="s">&quot;driver compiled for version %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
			<span class="n">FW_VERSION_MAJOR</span><span class="p">,</span> <span class="n">FW_VERSION_MINOR</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_flash_erase_sectors - erase a range of flash sectors</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@start: the first sector to erase</span>
<span class="cm"> *	@end: the last sector to erase</span>
<span class="cm"> *</span>
<span class="cm"> *	Erases the sectors in the given range.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_flash_erase_sectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SF_WR_ENABLE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sf1_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">SF_ERASE_SECTOR</span> <span class="o">|</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">flash_wait_op</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	t3_load_fw - download firmware</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@fw_data: the firmware image to write</span>
<span class="cm"> *	@size: image size</span>
<span class="cm"> *</span>
<span class="cm"> *	Write the supplied firmware image to the card&#39;s serial flash.</span>
<span class="cm"> *	The FW image has the following sections: @size - 8 bytes of code and</span>
<span class="cm"> *	data, followed by 4 bytes of FW version, followed by the 32-bit</span>
<span class="cm"> *	1&#39;s complement checksum of the whole image.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">csum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">fw_sector</span> <span class="o">=</span> <span class="n">FW_FLASH_BOOT_ADDR</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">FW_MIN_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">FW_VERS_ADDR</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">FW_FLASH_BOOT_ADDR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;corrupted firmware image, checksum %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">csum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_flash_erase_sectors</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fw_sector</span><span class="p">,</span> <span class="n">fw_sector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* trim off version and checksum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">FW_FLASH_BOOT_ADDR</span><span class="p">;</span> <span class="n">size</span><span class="p">;)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">256U</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_write_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">fw_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">chunk_size</span><span class="p">;</span>
		<span class="n">fw_data</span> <span class="o">+=</span> <span class="n">chunk_size</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">chunk_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_write_flash</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">FW_VERS_ADDR</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fw_data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;firmware download failed, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CIM_CTL_BASE 0x2000</span>

<span class="cm">/**</span>
<span class="cm"> *      t3_cim_ctl_blk_read - read a block from CIM control region</span>
<span class="cm"> *</span>
<span class="cm"> *      @adap: the adapter</span>
<span class="cm"> *      @addr: the start address within the CIM control region</span>
<span class="cm"> *      @n: number of words to read</span>
<span class="cm"> *      @valp: where to store the result</span>
<span class="cm"> *</span>
<span class="cm"> *      Reads a block of 4-byte words from the CIM control region.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_cim_ctl_blk_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_HOST_ACC_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_HOSTBUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">--</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_HOST_ACC_CTRL</span><span class="p">,</span> <span class="n">CIM_CTL_BASE</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_HOST_ACC_CTRL</span><span class="p">,</span> <span class="n">F_HOSTBUSY</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="o">*</span><span class="n">valp</span><span class="o">++</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_HOST_ACC_DATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t3_gate_rx_traffic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_cfg</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="o">*</span><span class="n">rx_hash_high</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_hash_low</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* stop Rx unicast traffic */</span>
	<span class="n">t3_mac_disable_exact_filters</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>

	<span class="cm">/* stop broadcast, multicast, promiscuous mode traffic */</span>
	<span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span><span class="p">,</span>
			 <span class="n">F_ENHASHMCAST</span> <span class="o">|</span> <span class="n">F_DISBCAST</span> <span class="o">|</span> <span class="n">F_COPYALLFRAMES</span><span class="p">,</span>
			 <span class="n">F_DISBCAST</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rx_hash_high</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_HIGH</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rx_hash_low</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_LOW</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_LOW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Leave time to drain max RX fifo */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t3_open_rx_traffic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_cfg</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">rx_hash_high</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_hash_low</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_mac_enable_exact_filters</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_CFG</span><span class="p">,</span>
			 <span class="n">F_ENHASHMCAST</span> <span class="o">|</span> <span class="n">F_DISBCAST</span> <span class="o">|</span> <span class="n">F_COPYALLFRAMES</span><span class="p">,</span>
			 <span class="n">rx_cfg</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_HIGH</span><span class="p">,</span> <span class="n">rx_hash_high</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_HASH_LOW</span><span class="p">,</span> <span class="n">rx_hash_low</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_link_changed - handle interface link changes</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@port_id: the port index that changed link state</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when a port&#39;s link settings change to propagate the new values</span>
<span class="cm"> *	to the associated PHY and MAC.  After performing the common tasks it</span>
<span class="cm"> *	invokes an OS-specific handler.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_link_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">link_ok</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_link_status</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_ok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duplex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">&amp;&amp;</span> <span class="n">link_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rx_cfg</span><span class="p">,</span> <span class="n">rx_hash_high</span><span class="p">,</span> <span class="n">rx_hash_low</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">t3_xgm_intr_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
		<span class="n">t3_gate_rx_traffic</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_hash_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_hash_low</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">t3_mac_enable</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_INT_STATUS</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">F_LINKFAULTCHANGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_faults</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_fault</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t3_open_rx_traffic</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">,</span> <span class="n">rx_hash_high</span><span class="p">,</span> <span class="n">rx_hash_low</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_AUTONEG</span><span class="p">)</span>
		<span class="n">fc</span> <span class="o">&amp;=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAUSE_RX</span> <span class="o">|</span> <span class="n">PAUSE_TX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span> <span class="o">==</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">==</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&amp;&amp;</span>
	    <span class="n">duplex</span> <span class="o">==</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">&amp;&amp;</span> <span class="n">fc</span> <span class="o">==</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>                            <span class="cm">/* nothing changed */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span> <span class="o">!=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">&amp;&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span>
			<span class="n">t3b_pcs_reset</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XAUI_ACT_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			     <span class="n">link_ok</span> <span class="o">?</span> <span class="n">F_TXACTENABLE</span> <span class="o">|</span> <span class="n">F_RXEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="n">link_ok</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">SPEED_INVALID</span> <span class="o">:</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">duplex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">DUPLEX_INVALID</span> <span class="o">:</span> <span class="n">duplex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set MAC speed, duplex, and flow control to match PHY. */</span>
		<span class="n">t3_mac_set_speed_duplex_fc</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t3_os_link_changed</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">link_ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_fault</span><span class="p">,</span>
			   <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_link_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_ok</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">link_fault</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_cfg</span><span class="p">,</span> <span class="n">rx_hash_high</span><span class="p">,</span> <span class="n">rx_hash_low</span><span class="p">;</span>

	<span class="n">t3_gate_rx_traffic</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_hash_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_hash_low</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XAUI_ACT_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RX_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_mac_enable</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">);</span>

	<span class="n">t3_open_rx_traffic</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">rx_cfg</span><span class="p">,</span> <span class="n">rx_hash_high</span><span class="p">,</span> <span class="n">rx_hash_low</span><span class="p">);</span>

	<span class="n">link_fault</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				 <span class="n">A_XGM_INT_STATUS</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">link_fault</span> <span class="o">&amp;=</span> <span class="n">F_LINKFAULTCHANGE</span><span class="p">;</span>

	<span class="n">link_ok</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span><span class="p">;</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">duplex</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_link_status</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_ok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duplex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_fault</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>

		<span class="n">t3_os_link_fault</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Account link faults only when the phy reports a link up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_faults</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_ok</span><span class="p">)</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XAUI_ACT_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				     <span class="n">F_TXACTENABLE</span> <span class="o">|</span> <span class="n">F_RXEN</span><span class="p">);</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">link_fault</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">link_ok</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">SPEED_INVALID</span> <span class="o">:</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">duplex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">DUPLEX_INVALID</span> <span class="o">:</span> <span class="n">duplex</span><span class="p">;</span>
		<span class="n">t3_os_link_fault</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">link_ok</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_link_start - apply link configuration to MAC/PHY</span>
<span class="cm"> *	@phy: the PHY to setup</span>
<span class="cm"> *	@mac: the MAC to setup</span>
<span class="cm"> *	@lc: the requested link configuration</span>
<span class="cm"> *</span>
<span class="cm"> *	Set up a port&#39;s MAC and PHY according to a desired link configuration.</span>
<span class="cm"> *	- If the PHY can auto-negotiate first decide what to advertise, then</span>
<span class="cm"> *	  enable/disable auto-negotiation as desired, and reset.</span>
<span class="cm"> *	- If the PHY does not auto-negotiate just reset it.</span>
<span class="cm"> *	- If auto-negotiation is off set the MAC to the proper speed/duplex/FC,</span>
<span class="cm"> *	  otherwise do it later based on the outcome of auto-negotiation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_link_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAUSE_RX</span> <span class="o">|</span> <span class="n">PAUSE_TX</span><span class="p">);</span>

	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISED_Asym_Pause</span> <span class="o">|</span> <span class="n">ADVERTISED_Pause</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_RX</span><span class="p">)</span>
				<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Pause</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span><span class="p">;</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_duplex</span><span class="p">;</span>
			<span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">fc</span><span class="p">;</span>
			<span class="n">t3_mac_set_speed_duplex_fc</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span>
						   <span class="n">fc</span><span class="p">);</span>
			<span class="cm">/* Also disables autoneg */</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_speed_duplex</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">autoneg_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t3_mac_set_speed_duplex_fc</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">fc</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_set_vlan_accel - control HW VLAN extraction</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@ports: bitmap of adapter ports to operate on</span>
<span class="cm"> *	@on: enable (1) or disable (0) HW VLAN extraction</span>
<span class="cm"> *</span>
<span class="cm"> *	Enables or disables HW extraction of VLAN tags for the given port.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_set_vlan_accel</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ports</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_OUT_CONFIG</span><span class="p">,</span>
			 <span class="n">ports</span> <span class="o">&lt;&lt;</span> <span class="n">S_VLANEXTRACTIONENABLE</span><span class="p">,</span>
			 <span class="n">on</span> <span class="o">?</span> <span class="p">(</span><span class="n">ports</span> <span class="o">&lt;&lt;</span> <span class="n">S_VLANEXTRACTIONENABLE</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">intr_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>	<span class="cm">/* bits to check in interrupt status */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>	<span class="cm">/* message to print or NULL */</span>
	<span class="kt">short</span> <span class="n">stat_idx</span><span class="p">;</span>		<span class="cm">/* stat counter to increment or -1 */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fatal</span><span class="p">;</span>	<span class="cm">/* whether the condition reported is fatal */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_handle_intr_status - table driven interrupt handler</span>
<span class="cm"> *	@adapter: the adapter that generated the interrupt</span>
<span class="cm"> *	@reg: the interrupt status register to process</span>
<span class="cm"> *	@mask: a mask to apply to the interrupt status</span>
<span class="cm"> *	@acts: table of interrupt actions</span>
<span class="cm"> *	@stats: statistics counters tracking interrupt occurrences</span>
<span class="cm"> *</span>
<span class="cm"> *	A table driven interrupt handler that applies a set of masks to an</span>
<span class="cm"> *	interrupt status word and performs the corresponding actions if the</span>
<span class="cm"> *	interrupts described by the mask have occurred.  The actions include</span>
<span class="cm"> *	optionally printing a warning or alert message, and optionally</span>
<span class="cm"> *	incrementing a stat counter.  The table is terminated by an entry</span>
<span class="cm"> *	specifying mask 0.  Returns the number of fatal interrupt conditions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_handle_intr_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="o">*</span><span class="n">acts</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fatal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span> <span class="o">++</span><span class="n">acts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">fatal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fatal</span><span class="o">++</span><span class="p">;</span>
			<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">acts</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">)</span>
			<span class="n">CH_WARN</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acts</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">acts</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">stat_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">stats</span><span class="p">[</span><span class="n">acts</span><span class="o">-&gt;</span><span class="n">stat_idx</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>		<span class="cm">/* clear processed interrupts */</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fatal</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SGE_INTR_MASK (F_RSPQDISABLED | \</span>
<span class="cp">		       F_UC_REQ_FRAMINGERROR | F_R_REQ_FRAMINGERROR | \</span>
<span class="cp">		       F_CPPARITYERROR | F_OCPARITYERROR | F_RCPARITYERROR | \</span>
<span class="cp">		       F_IRPARITYERROR | V_ITPARITYERROR(M_ITPARITYERROR) | \</span>
<span class="cp">		       V_FLPARITYERROR(M_FLPARITYERROR) | F_LODRBPARITYERROR | \</span>
<span class="cp">		       F_HIDRBPARITYERROR | F_LORCQPARITYERROR | \</span>
<span class="cp">		       F_HIRCQPARITYERROR | F_LOPRIORITYDBFULL | \</span>
<span class="cp">		       F_HIPRIORITYDBFULL | F_LOPRIORITYDBEMPTY | \</span>
<span class="cp">		       F_HIPRIORITYDBEMPTY | F_HIPIODRBDROPERR | \</span>
<span class="cp">		       F_LOPIODRBDROPERR)</span>
<span class="cp">#define MC5_INTR_MASK (F_PARITYERR | F_ACTRGNFULL | F_UNKNOWNCMD | \</span>
<span class="cp">		       F_REQQPARERR | F_DISPQPARERR | F_DELACTEMPTY | \</span>
<span class="cp">		       F_NFASRCHFAIL)</span>
<span class="cp">#define MC7_INTR_MASK (F_AE | F_UE | F_CE | V_PE(M_PE))</span>
<span class="cp">#define XGM_INTR_MASK (V_TXFIFO_PRTY_ERR(M_TXFIFO_PRTY_ERR) | \</span>
<span class="cp">		       V_RXFIFO_PRTY_ERR(M_RXFIFO_PRTY_ERR) | \</span>
<span class="cp">		       F_TXFIFO_UNDERRUN)</span>
<span class="cp">#define PCIX_INTR_MASK (F_MSTDETPARERR | F_SIGTARABT | F_RCVTARABT | \</span>
<span class="cp">			F_RCVMSTABT | F_SIGSYSERR | F_DETPARERR | \</span>
<span class="cp">			F_SPLCMPDIS | F_UNXSPLCMP | F_RCVSPLCMPERR | \</span>
<span class="cp">			F_DETCORECCERR | F_DETUNCECCERR | F_PIOPARERR | \</span>
<span class="cp">			V_WFPARERR(M_WFPARERR) | V_RFPARERR(M_RFPARERR) | \</span>
<span class="cp">			V_CFPARERR(M_CFPARERR) </span><span class="cm">/* | V_MSIXPARERR(M_MSIXPARERR) */</span><span class="cp">)</span>
<span class="cp">#define PCIE_INTR_MASK (F_UNXSPLCPLERRR | F_UNXSPLCPLERRC | F_PCIE_PIOPARERR |\</span>
<span class="cp">			F_PCIE_WFPARERR | F_PCIE_RFPARERR | F_PCIE_CFPARERR | \</span>
<span class="cp">			</span><span class="cm">/* V_PCIE_MSIXPARERR(M_PCIE_MSIXPARERR) | */</span><span class="cp"> \</span>
<span class="cp">			F_RETRYBUFPARERR | F_RETRYLUTPARERR | F_RXPARERR | \</span>
<span class="cp">			F_TXPARERR | V_BISTERR(M_BISTERR))</span>
<span class="cp">#define ULPRX_INTR_MASK (F_PARERRDATA | F_PARERRPCMD | F_ARBPF1PERR | \</span>
<span class="cp">			 F_ARBPF0PERR | F_ARBFPERR | F_PCMDMUXPERR | \</span>
<span class="cp">			 F_DATASELFRAMEERR1 | F_DATASELFRAMEERR0)</span>
<span class="cp">#define ULPTX_INTR_MASK 0xfc</span>
<span class="cp">#define CPLSW_INTR_MASK (F_CIM_OP_MAP_PERR | F_TP_FRAMING_ERROR | \</span>
<span class="cp">			 F_SGE_FRAMING_ERROR | F_CIM_FRAMING_ERROR | \</span>
<span class="cp">			 F_ZERO_SWITCH_ERROR)</span>
<span class="cp">#define CIM_INTR_MASK (F_BLKWRPLINT | F_BLKRDPLINT | F_BLKWRCTLINT | \</span>
<span class="cp">		       F_BLKRDCTLINT | F_BLKWRFLASHINT | F_BLKRDFLASHINT | \</span>
<span class="cp">		       F_SGLWRFLASHINT | F_WRBLKFLASHINT | F_BLKWRBOOTINT | \</span>
<span class="cp">	 	       F_FLASHRANGEINT | F_SDRAMRANGEINT | F_RSVDSPACEINT | \</span>
<span class="cp">		       F_DRAMPARERR | F_ICACHEPARERR | F_DCACHEPARERR | \</span>
<span class="cp">		       F_OBQSGEPARERR | F_OBQULPHIPARERR | F_OBQULPLOPARERR | \</span>
<span class="cp">		       F_IBQSGELOPARERR | F_IBQSGEHIPARERR | F_IBQULPPARERR | \</span>
<span class="cp">		       F_IBQTPPARERR | F_ITAGPARERR | F_DTAGPARERR)</span>
<span class="cp">#define PMTX_INTR_MASK (F_ZERO_C_CMD_ERROR | ICSPI_FRM_ERR | OESPI_FRM_ERR | \</span>
<span class="cp">			V_ICSPI_PAR_ERROR(M_ICSPI_PAR_ERROR) | \</span>
<span class="cp">			V_OESPI_PAR_ERROR(M_OESPI_PAR_ERROR))</span>
<span class="cp">#define PMRX_INTR_MASK (F_ZERO_E_CMD_ERROR | IESPI_FRM_ERR | OCSPI_FRM_ERR | \</span>
<span class="cp">			V_IESPI_PAR_ERROR(M_IESPI_PAR_ERROR) | \</span>
<span class="cp">			V_OCSPI_PAR_ERROR(M_OCSPI_PAR_ERROR))</span>
<span class="cp">#define MPS_INTR_MASK (V_TX0TPPARERRENB(M_TX0TPPARERRENB) | \</span>
<span class="cp">		       V_TX1TPPARERRENB(M_TX1TPPARERRENB) | \</span>
<span class="cp">		       V_RXTPPARERRENB(M_RXTPPARERRENB) | \</span>
<span class="cp">		       V_MCAPARERRENB(M_MCAPARERRENB))</span>
<span class="cp">#define XGM_EXTRA_INTR_MASK (F_LINKFAULTCHANGE)</span>
<span class="cp">#define PL_INTR_MASK (F_T3DBG | F_XGMAC0_0 | F_XGMAC0_1 | F_MC5A | F_PM1_TX | \</span>
<span class="cp">		      F_PM1_RX | F_ULP2_TX | F_ULP2_RX | F_TP1 | F_CIM | \</span>
<span class="cp">		      F_MC7_CM | F_MC7_PMTX | F_MC7_PMRX | F_SGE3 | F_PCIM0 | \</span>
<span class="cp">		      F_MPS0 | F_CPL_SWITCH)</span>
<span class="cm">/*</span>
<span class="cm"> * Interrupt handler for the PCIX1 module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pcix1_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_MSTDETPARERR</span><span class="p">,</span> <span class="s">&quot;PCI master detected parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_SIGTARABT</span><span class="p">,</span> <span class="s">&quot;PCI signaled target abort&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_RCVTARABT</span><span class="p">,</span> <span class="s">&quot;PCI received target abort&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_RCVMSTABT</span><span class="p">,</span> <span class="s">&quot;PCI received master abort&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_SIGSYSERR</span><span class="p">,</span> <span class="s">&quot;PCI signaled system error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DETPARERR</span><span class="p">,</span> <span class="s">&quot;PCI detected parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_SPLCMPDIS</span><span class="p">,</span> <span class="s">&quot;PCI split completion discarded&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_UNXSPLCMP</span><span class="p">,</span> <span class="s">&quot;PCI unexpected split completion error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_RCVSPLCMPERR</span><span class="p">,</span> <span class="s">&quot;PCI received split completion error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DETCORECCERR</span><span class="p">,</span> <span class="s">&quot;PCI correctable ECC error&quot;</span><span class="p">,</span>
		 <span class="n">STAT_PCI_CORR_ECC</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DETUNCECCERR</span><span class="p">,</span> <span class="s">&quot;PCI uncorrectable ECC error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PIOPARERR</span><span class="p">,</span> <span class="s">&quot;PCI PIO FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_WFPARERR</span><span class="p">(</span><span class="n">M_WFPARERR</span><span class="p">),</span> <span class="s">&quot;PCI write FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_RFPARERR</span><span class="p">(</span><span class="n">M_RFPARERR</span><span class="p">),</span> <span class="s">&quot;PCI read FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_CFPARERR</span><span class="p">(</span><span class="n">M_CFPARERR</span><span class="p">),</span> <span class="s">&quot;PCI command FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_MSIXPARERR</span><span class="p">(</span><span class="n">M_MSIXPARERR</span><span class="p">),</span> <span class="s">&quot;PCI MSI-X table/PBA parity &quot;</span>
		 <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIX_INT_CAUSE</span><span class="p">,</span> <span class="n">PCIX_INTR_MASK</span><span class="p">,</span>
				  <span class="n">pcix1_intr_info</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handler for the PCIE module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcie_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pcie_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_PEXERR</span><span class="p">,</span> <span class="s">&quot;PCI PEX error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_UNXSPLCPLERRR</span><span class="p">,</span>
		 <span class="s">&quot;PCI unexpected split completion DMA read error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_UNXSPLCPLERRC</span><span class="p">,</span>
		 <span class="s">&quot;PCI unexpected split completion DMA command error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PCIE_PIOPARERR</span><span class="p">,</span> <span class="s">&quot;PCI PIO FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PCIE_WFPARERR</span><span class="p">,</span> <span class="s">&quot;PCI write FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PCIE_RFPARERR</span><span class="p">,</span> <span class="s">&quot;PCI read FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PCIE_CFPARERR</span><span class="p">,</span> <span class="s">&quot;PCI command FIFO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_PCIE_MSIXPARERR</span><span class="p">(</span><span class="n">M_PCIE_MSIXPARERR</span><span class="p">),</span>
		 <span class="s">&quot;PCI MSI-X table/PBA parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_RETRYBUFPARERR</span><span class="p">,</span> <span class="s">&quot;PCI retry buffer parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_RETRYLUTPARERR</span><span class="p">,</span> <span class="s">&quot;PCI retry LUT parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_RXPARERR</span><span class="p">,</span> <span class="s">&quot;PCI Rx parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_TXPARERR</span><span class="p">,</span> <span class="s">&quot;PCI Tx parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_BISTERR</span><span class="p">(</span><span class="n">M_BISTERR</span><span class="p">),</span> <span class="s">&quot;PCI BIST error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIE_INT_CAUSE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_PEXERR</span><span class="p">)</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;PEX error code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIE_PEX_ERR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIE_INT_CAUSE</span><span class="p">,</span> <span class="n">PCIE_INTR_MASK</span><span class="p">,</span>
				  <span class="n">pcie_intr_info</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TP interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tp_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">tp_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0xffffff</span><span class="p">,</span> <span class="s">&quot;TP parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x1000000</span><span class="p">,</span> <span class="s">&quot;TP out of Rx pages&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2000000</span><span class="p">,</span> <span class="s">&quot;TP out of Tx pages&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">tp_intr_info_t3c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x1fffffff</span><span class="p">,</span> <span class="s">&quot;TP parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_FLMRXFLSTEMPTY</span><span class="p">,</span> <span class="s">&quot;TP out of Rx pages&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_FLMTXFLSTEMPTY</span><span class="p">,</span> <span class="s">&quot;TP out of Tx pages&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_INT_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="n">T3_REV_C</span> <span class="o">?</span>
				  <span class="n">tp_intr_info</span> <span class="o">:</span> <span class="n">tp_intr_info_t3c</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CIM interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cim_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">cim_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_RSVDSPACEINT</span><span class="p">,</span> <span class="s">&quot;CIM reserved space write&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_SDRAMRANGEINT</span><span class="p">,</span> <span class="s">&quot;CIM SDRAM address out of range&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_FLASHRANGEINT</span><span class="p">,</span> <span class="s">&quot;CIM flash address out of range&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_BLKWRBOOTINT</span><span class="p">,</span> <span class="s">&quot;CIM block write to boot space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_WRBLKFLASHINT</span><span class="p">,</span> <span class="s">&quot;CIM write to cached flash space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_SGLWRFLASHINT</span><span class="p">,</span> <span class="s">&quot;CIM single write to flash space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_BLKRDFLASHINT</span><span class="p">,</span> <span class="s">&quot;CIM block read from flash space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_BLKWRFLASHINT</span><span class="p">,</span> <span class="s">&quot;CIM block write to flash space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_BLKRDCTLINT</span><span class="p">,</span> <span class="s">&quot;CIM block read from CTL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_BLKWRCTLINT</span><span class="p">,</span> <span class="s">&quot;CIM block write to CTL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_BLKRDPLINT</span><span class="p">,</span> <span class="s">&quot;CIM block read from PL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_BLKWRPLINT</span><span class="p">,</span> <span class="s">&quot;CIM block write to PL space&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DRAMPARERR</span><span class="p">,</span> <span class="s">&quot;CIM DRAM parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_ICACHEPARERR</span><span class="p">,</span> <span class="s">&quot;CIM icache parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DCACHEPARERR</span><span class="p">,</span> <span class="s">&quot;CIM dcache parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_OBQSGEPARERR</span><span class="p">,</span> <span class="s">&quot;CIM OBQ SGE parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_OBQULPHIPARERR</span><span class="p">,</span> <span class="s">&quot;CIM OBQ ULPHI parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_OBQULPLOPARERR</span><span class="p">,</span> <span class="s">&quot;CIM OBQ ULPLO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_IBQSGELOPARERR</span><span class="p">,</span> <span class="s">&quot;CIM IBQ SGELO parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_IBQSGEHIPARERR</span><span class="p">,</span> <span class="s">&quot;CIM IBQ SGEHI parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_IBQULPPARERR</span><span class="p">,</span> <span class="s">&quot;CIM IBQ ULP parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_IBQTPPARERR</span><span class="p">,</span> <span class="s">&quot;CIM IBQ TP parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_ITAGPARERR</span><span class="p">,</span> <span class="s">&quot;CIM itag parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DTAGPARERR</span><span class="p">,</span> <span class="s">&quot;CIM dtag parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CIM_HOST_INT_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">cim_intr_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ULP RX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ulprx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">ulprx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_PARERRDATA</span><span class="p">,</span> <span class="s">&quot;ULP RX data parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PARERRPCMD</span><span class="p">,</span> <span class="s">&quot;ULP RX command parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_ARBPF1PERR</span><span class="p">,</span> <span class="s">&quot;ULP RX ArbPF1 parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_ARBPF0PERR</span><span class="p">,</span> <span class="s">&quot;ULP RX ArbPF0 parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_ARBFPERR</span><span class="p">,</span> <span class="s">&quot;ULP RX ArbF parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PCMDMUXPERR</span><span class="p">,</span> <span class="s">&quot;ULP RX PCMDMUX parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DATASELFRAMEERR1</span><span class="p">,</span> <span class="s">&quot;ULP RX frame error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_DATASELFRAMEERR0</span><span class="p">,</span> <span class="s">&quot;ULP RX frame error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ULPRX_INT_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">ulprx_intr_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ULP TX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ulptx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">ulptx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_PBL_BOUND_ERR_CH0</span><span class="p">,</span> <span class="s">&quot;ULP TX channel 0 PBL out of bounds&quot;</span><span class="p">,</span>
		 <span class="n">STAT_ULP_CH0_PBL_OOB</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_PBL_BOUND_ERR_CH1</span><span class="p">,</span> <span class="s">&quot;ULP TX channel 1 PBL out of bounds&quot;</span><span class="p">,</span>
		 <span class="n">STAT_ULP_CH1_PBL_OOB</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0xfc</span><span class="p">,</span> <span class="s">&quot;ULP TX parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ULPTX_INT_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">ulptx_intr_info</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_stats</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ICSPI_FRM_ERR (F_ICSPI0_FIFO2X_RX_FRAMING_ERROR | \</span>
<span class="cp">	F_ICSPI1_FIFO2X_RX_FRAMING_ERROR | F_ICSPI0_RX_FRAMING_ERROR | \</span>
<span class="cp">	F_ICSPI1_RX_FRAMING_ERROR | F_ICSPI0_TX_FRAMING_ERROR | \</span>
<span class="cp">	F_ICSPI1_TX_FRAMING_ERROR)</span>
<span class="cp">#define OESPI_FRM_ERR (F_OESPI0_RX_FRAMING_ERROR | \</span>
<span class="cp">	F_OESPI1_RX_FRAMING_ERROR | F_OESPI0_TX_FRAMING_ERROR | \</span>
<span class="cp">	F_OESPI1_TX_FRAMING_ERROR | F_OESPI0_OFIFO2X_TX_FRAMING_ERROR | \</span>
<span class="cp">	F_OESPI1_OFIFO2X_TX_FRAMING_ERROR)</span>

<span class="cm">/*</span>
<span class="cm"> * PM TX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmtx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pmtx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_ZERO_C_CMD_ERROR</span><span class="p">,</span> <span class="s">&quot;PMTX 0-length pcmd&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">ICSPI_FRM_ERR</span><span class="p">,</span> <span class="s">&quot;PMTX ispi framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">OESPI_FRM_ERR</span><span class="p">,</span> <span class="s">&quot;PMTX ospi framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_ICSPI_PAR_ERROR</span><span class="p">(</span><span class="n">M_ICSPI_PAR_ERROR</span><span class="p">),</span>
		 <span class="s">&quot;PMTX ispi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_OESPI_PAR_ERROR</span><span class="p">(</span><span class="n">M_OESPI_PAR_ERROR</span><span class="p">),</span>
		 <span class="s">&quot;PMTX ospi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PM1_TX_INT_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">pmtx_intr_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IESPI_FRM_ERR (F_IESPI0_FIFO2X_RX_FRAMING_ERROR | \</span>
<span class="cp">	F_IESPI1_FIFO2X_RX_FRAMING_ERROR | F_IESPI0_RX_FRAMING_ERROR | \</span>
<span class="cp">	F_IESPI1_RX_FRAMING_ERROR | F_IESPI0_TX_FRAMING_ERROR | \</span>
<span class="cp">	F_IESPI1_TX_FRAMING_ERROR)</span>
<span class="cp">#define OCSPI_FRM_ERR (F_OCSPI0_RX_FRAMING_ERROR | \</span>
<span class="cp">	F_OCSPI1_RX_FRAMING_ERROR | F_OCSPI0_TX_FRAMING_ERROR | \</span>
<span class="cp">	F_OCSPI1_TX_FRAMING_ERROR | F_OCSPI0_OFIFO2X_TX_FRAMING_ERROR | \</span>
<span class="cp">	F_OCSPI1_OFIFO2X_TX_FRAMING_ERROR)</span>

<span class="cm">/*</span>
<span class="cm"> * PM RX interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmrx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">pmrx_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_ZERO_E_CMD_ERROR</span><span class="p">,</span> <span class="s">&quot;PMRX 0-length pcmd&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">IESPI_FRM_ERR</span><span class="p">,</span> <span class="s">&quot;PMRX ispi framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">OCSPI_FRM_ERR</span><span class="p">,</span> <span class="s">&quot;PMRX ospi framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_IESPI_PAR_ERROR</span><span class="p">(</span><span class="n">M_IESPI_PAR_ERROR</span><span class="p">),</span>
		 <span class="s">&quot;PMRX ispi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">V_OCSPI_PAR_ERROR</span><span class="p">(</span><span class="n">M_OCSPI_PAR_ERROR</span><span class="p">),</span>
		 <span class="s">&quot;PMRX ospi parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PM1_RX_INT_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">pmrx_intr_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL switch interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cplsw_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">cplsw_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">F_CIM_OP_MAP_PERR</span><span class="p">,</span> <span class="s">&quot;CPL switch CIM parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_CIM_OVFL_ERROR</span><span class="p">,</span> <span class="s">&quot;CPL switch CIM overflow&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_TP_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;CPL switch TP framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_SGE_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;CPL switch SGE framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_CIM_FRAMING_ERROR</span><span class="p">,</span> <span class="s">&quot;CPL switch CIM framing error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="n">F_ZERO_SWITCH_ERROR</span><span class="p">,</span> <span class="s">&quot;CPL switch no-switch error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CPL_INTR_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">cplsw_intr_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPS interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mps_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intr_info</span> <span class="n">mps_intr_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x1ff</span><span class="p">,</span> <span class="s">&quot;MPS parity error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_handle_intr_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MPS_INT_CAUSE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
				  <span class="n">mps_intr_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MC7_INTR_FATAL (F_UE | V_PE(M_PE) | F_AE)</span>

<span class="cm">/*</span>
<span class="cm"> * MC7 interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mc7_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc7</span> <span class="o">*</span><span class="n">mc7</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_INT_CAUSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_CE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">corr_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CH_WARN</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s MC7 correctable error at addr 0x%x, &quot;</span>
			<span class="s">&quot;data 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CE_ADDR</span><span class="p">),</span>
			<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CE_DATA0</span><span class="p">),</span>
			<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CE_DATA1</span><span class="p">),</span>
			<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CE_DATA2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_UE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">uncorr_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s MC7 uncorrectable error at addr 0x%x, &quot;</span>
			 <span class="s">&quot;data 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_UE_ADDR</span><span class="p">),</span>
			 <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_UE_DATA0</span><span class="p">),</span>
			 <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_UE_DATA1</span><span class="p">),</span>
			 <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_UE_DATA2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">G_PE</span><span class="p">(</span><span class="n">cause</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">parity_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s MC7 parity error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">G_PE</span><span class="p">(</span><span class="n">cause</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_AE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					   <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_ERR_ADDR</span><span class="p">);</span>
		<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">addr_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s MC7 address error: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">MC7_INTR_FATAL</span><span class="p">)</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_INT_CAUSE</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define XGM_INTR_FATAL (V_TXFIFO_PRTY_ERR(M_TXFIFO_PRTY_ERR) | \</span>
<span class="cp">			V_RXFIFO_PRTY_ERR(M_RXFIFO_PRTY_ERR))</span>
<span class="cm">/*</span>
<span class="cm"> * XGMAC interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mac_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We mask out interrupt causes for which we&#39;re not taking interrupts.</span>
<span class="cm">	 * This allows us to use polling logic to monitor some of the other</span>
<span class="cm">	 * conditions when taking interrupts would impose too much load on the</span>
<span class="cm">	 * system.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_INT_CAUSE</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="o">~</span><span class="n">F_RXFIFO_OVERFLOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">V_TXFIFO_PRTY_ERR</span><span class="p">(</span><span class="n">M_TXFIFO_PRTY_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_parity_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;port%d: MAC TX FIFO parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">V_RXFIFO_PRTY_ERR</span><span class="p">(</span><span class="n">M_RXFIFO_PRTY_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_parity_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;port%d: MAC RX FIFO parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_TXFIFO_UNDERRUN</span><span class="p">)</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_urun</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_RXFIFO_OVERFLOW</span><span class="p">)</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_ovfl</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">V_SERDES_LOS</span><span class="p">(</span><span class="n">M_SERDES_LOS</span><span class="p">))</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">serdes_signal_loss</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_XAUIPCSCTCERR</span><span class="p">)</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xaui_pcs_ctc_err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_XAUIPCSALIGNCHANGE</span><span class="p">)</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xaui_pcs_align_change</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_XGM_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
				 <span class="n">A_XGM_INT_ENABLE</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				 <span class="n">F_XGM_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_faults</span><span class="o">++</span><span class="p">;</span>

		<span class="n">t3_os_link_fault_handler</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">XGM_INTR_FATAL</span><span class="p">)</span>
		<span class="n">t3_fatal_err</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_XGM_INT_CAUSE</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cause</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handler for PHY events.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_phy_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_T3DBG_INT_CAUSE</span><span class="p">);</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_IRQ</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">adapter_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gpio_intr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">phy_cause</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phy_cause</span> <span class="o">&amp;</span> <span class="n">cphy_cause_link_change</span><span class="p">)</span>
				<span class="n">t3_link_changed</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_cause</span> <span class="o">&amp;</span> <span class="n">cphy_cause_fifo_error</span><span class="p">)</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_cause</span> <span class="o">&amp;</span> <span class="n">cphy_cause_module_change</span><span class="p">)</span>
				<span class="n">t3_os_phymod_changed</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_T3DBG_INT_CAUSE</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * T3 slow path (non-data) interrupt handler.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_slow_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_CAUSE0</span><span class="p">);</span>

	<span class="n">cause</span> <span class="o">&amp;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cause</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_PCIM0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_pcie</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">pcie_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pci_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_SGE3</span><span class="p">)</span>
		<span class="n">t3_sge_err_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_MC7_PMRX</span><span class="p">)</span>
		<span class="n">mc7_intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmrx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_MC7_PMTX</span><span class="p">)</span>
		<span class="n">mc7_intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_MC7_CM</span><span class="p">)</span>
		<span class="n">mc7_intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_CIM</span><span class="p">)</span>
		<span class="n">cim_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_TP1</span><span class="p">)</span>
		<span class="n">tp_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_ULP2_RX</span><span class="p">)</span>
		<span class="n">ulprx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_ULP2_TX</span><span class="p">)</span>
		<span class="n">ulptx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_PM1_RX</span><span class="p">)</span>
		<span class="n">pmrx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_PM1_TX</span><span class="p">)</span>
		<span class="n">pmtx_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_CPL_SWITCH</span><span class="p">)</span>
		<span class="n">cplsw_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_MPS0</span><span class="p">)</span>
		<span class="n">mps_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_MC5A</span><span class="p">)</span>
		<span class="n">t3_mc5_intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_XGMAC0_0</span><span class="p">)</span>
		<span class="n">mac_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_XGMAC0_1</span><span class="p">)</span>
		<span class="n">mac_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="n">F_T3DBG</span><span class="p">)</span>
		<span class="n">t3_os_ext_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Clear the interrupts just processed. */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_CAUSE0</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_CAUSE0</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_gpio_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">gpi_intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_IRQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">adapter_info</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gpio_intr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">gpi_intr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">adapter_info</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gpio_intr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">gpi_intr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_intr_enable - enable interrupts</span>
<span class="cm"> *	@adapter: the adapter whose interrupts should be enabled</span>
<span class="cm"> *</span>
<span class="cm"> *	Enable interrupts by setting the interrupt enable registers of the</span>
<span class="cm"> *	various HW modules and then enabling the top-level interrupt</span>
<span class="cm"> *	concentrator.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">addr_val_pair</span> <span class="n">intr_en_avp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">A_SG_INT_ENABLE</span><span class="p">,</span> <span class="n">SGE_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_MC7_INT_ENABLE</span><span class="p">,</span> <span class="n">MC7_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_MC7_INT_ENABLE</span> <span class="o">-</span> <span class="n">MC7_PMRX_BASE_ADDR</span> <span class="o">+</span> <span class="n">MC7_PMTX_BASE_ADDR</span><span class="p">,</span>
		 <span class="n">MC7_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_MC7_INT_ENABLE</span> <span class="o">-</span> <span class="n">MC7_PMRX_BASE_ADDR</span> <span class="o">+</span> <span class="n">MC7_CM_BASE_ADDR</span><span class="p">,</span>
		 <span class="n">MC7_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_MC5_DB_INT_ENABLE</span><span class="p">,</span> <span class="n">MC5_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_ULPRX_INT_ENABLE</span><span class="p">,</span> <span class="n">ULPRX_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_PM1_TX_INT_ENABLE</span><span class="p">,</span> <span class="n">PMTX_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_PM1_RX_INT_ENABLE</span><span class="p">,</span> <span class="n">PMRX_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_CIM_HOST_INT_ENABLE</span><span class="p">,</span> <span class="n">CIM_INTR_MASK</span><span class="p">},</span>
		<span class="p">{</span><span class="n">A_MPS_INT_ENABLE</span><span class="p">,</span> <span class="n">MPS_INTR_MASK</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span> <span class="o">=</span> <span class="n">PL_INTR_MASK</span><span class="p">;</span>

	<span class="n">t3_write_regs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">intr_en_avp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intr_en_avp</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_INT_ENABLE</span><span class="p">,</span>
		     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">T3_REV_C</span> <span class="o">?</span> <span class="mh">0x2bfffff</span> <span class="o">:</span> <span class="mh">0x3bfffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CPL_INTR_ENABLE</span><span class="p">,</span>
			     <span class="n">CPLSW_INTR_MASK</span> <span class="o">|</span> <span class="n">F_CIM_OVFL_ERROR</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ULPTX_INT_ENABLE</span><span class="p">,</span>
			     <span class="n">ULPTX_INTR_MASK</span> <span class="o">|</span> <span class="n">F_PBL_BOUND_ERR_CH0</span> <span class="o">|</span>
			     <span class="n">F_PBL_BOUND_ERR_CH1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CPL_INTR_ENABLE</span><span class="p">,</span> <span class="n">CPLSW_INTR_MASK</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ULPTX_INT_ENABLE</span><span class="p">,</span> <span class="n">ULPTX_INTR_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_T3DBG_INT_ENABLE</span><span class="p">,</span> <span class="n">calc_gpio_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pcie</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIE_INT_ENABLE</span><span class="p">,</span> <span class="n">PCIE_INTR_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIX_INT_ENABLE</span><span class="p">,</span> <span class="n">PCIX_INTR_MASK</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_ENABLE0</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_ENABLE0</span><span class="p">);</span>	<span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_intr_disable - disable a card&#39;s interrupts</span>
<span class="cm"> *	@adapter: the adapter whose interrupts should be disabled</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable interrupts.  We only disable the top-level interrupt</span>
<span class="cm"> *	concentrator and the SGE data interrupts.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_ENABLE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_ENABLE0</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_intr_clear - clear all interrupts</span>
<span class="cm"> *	@adapter: the adapter whose interrupts should be cleared</span>
<span class="cm"> *</span>
<span class="cm"> *	Clears all interrupts.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_intr_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cause_reg_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">A_SG_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_SG_RSPQ_FL_STATUS</span><span class="p">,</span>
		<span class="n">A_PCIX_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_MC7_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_MC7_INT_CAUSE</span> <span class="o">-</span> <span class="n">MC7_PMRX_BASE_ADDR</span> <span class="o">+</span> <span class="n">MC7_PMTX_BASE_ADDR</span><span class="p">,</span>
		<span class="n">A_MC7_INT_CAUSE</span> <span class="o">-</span> <span class="n">MC7_PMRX_BASE_ADDR</span> <span class="o">+</span> <span class="n">MC7_CM_BASE_ADDR</span><span class="p">,</span>
		<span class="n">A_CIM_HOST_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_TP_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_MC5_DB_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_ULPRX_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_ULPTX_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_CPL_INTR_CAUSE</span><span class="p">,</span>
		<span class="n">A_PM1_TX_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_PM1_RX_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_MPS_INT_CAUSE</span><span class="p">,</span>
		<span class="n">A_T3DBG_INT_CAUSE</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Clear PHY and MAC interrupts for each port. */</span>
	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
	    <span class="n">t3_port_intr_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cause_reg_addr</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cause_reg_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pcie</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIE_PEX_ERR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_CAUSE0</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_INT_CAUSE0</span><span class="p">);</span>	<span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_xgm_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XGM_INT_ENABLE</span> <span class="o">+</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
		     <span class="n">XGM_EXTRA_INTR_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_xgm_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XGM_INT_DISABLE</span> <span class="o">+</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
		     <span class="mh">0x7ff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_port_intr_enable - enable port-specific interrupts</span>
<span class="cm"> *	@adapter: associated adapter</span>
<span class="cm"> *	@idx: index of port whose interrupts should be enabled</span>
<span class="cm"> *</span>
<span class="cm"> *	Enable port-specific (i.e., MAC and PHY) interrupts for the given</span>
<span class="cm"> *	adapter port.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_port_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_INT_ENABLE</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">XGM_INTR_MASK</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_INT_ENABLE</span><span class="p">,</span> <span class="n">idx</span><span class="p">));</span> <span class="cm">/* flush */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_port_intr_disable - disable port-specific interrupts</span>
<span class="cm"> *	@adapter: associated adapter</span>
<span class="cm"> *	@idx: index of port whose interrupts should be disabled</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable port-specific (i.e., MAC and PHY) interrupts for the given</span>
<span class="cm"> *	adapter port.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_port_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_INT_ENABLE</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_INT_ENABLE</span><span class="p">,</span> <span class="n">idx</span><span class="p">));</span> <span class="cm">/* flush */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">intr_disable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_port_intr_clear - clear port-specific interrupts</span>
<span class="cm"> *	@adapter: associated adapter</span>
<span class="cm"> *	@idx: index of port whose interrupts to clear</span>
<span class="cm"> *</span>
<span class="cm"> *	Clear port-specific (i.e., MAC and PHY) interrupts for the given</span>
<span class="cm"> *	adapter port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">t3_port_intr_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cphy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_INT_CAUSE</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_INT_CAUSE</span><span class="p">,</span> <span class="n">idx</span><span class="p">));</span> <span class="cm">/* flush */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">intr_clear</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SG_CONTEXT_CMD_ATTEMPTS 100</span>

<span class="cm">/**</span>
<span class="cm"> * 	t3_sge_write_context - write an SGE context</span>
<span class="cm"> * 	@adapter: the adapter</span>
<span class="cm"> * 	@id: the context id</span>
<span class="cm"> * 	@type: the context type</span>
<span class="cm"> *</span>
<span class="cm"> * 	Program an SGE context with the values already loaded in the</span>
<span class="cm"> * 	CONTEXT_DATA? registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_sge_write_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">F_RESPONSEQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Can&#39;t write the Response Queue Context bits for</span>
<span class="cm">		 * Interrupt Armed or the Reserve bits after the chip</span>
<span class="cm">		 * has been initialized out of reset.  Writing to these</span>
<span class="cm">		 * bits can confuse the hardware.</span>
<span class="cm">		 */</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK0</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK1</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK2</span><span class="p">,</span> <span class="mh">0x17ffffff</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK3</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK0</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK1</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK2</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK3</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
		     <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">type</span> <span class="o">|</span> <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	clear_sge_ctxt - completely clear an SGE context</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@id: the context id</span>
<span class="cm"> *	@type: the context type</span>
<span class="cm"> *</span>
<span class="cm"> *	Completely clear an SGE context.  Used predominantly at post-reset</span>
<span class="cm"> *	initialization.  Note in particular that we don&#39;t skip writing to any</span>
<span class="cm"> *	&quot;sensitive bits&quot; in the contexts the way that t3_sge_write_context()</span>
<span class="cm"> *	does ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_sge_ctxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK0</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK1</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK2</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK3</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
		     <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">type</span> <span class="o">|</span> <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_init_ecntxt - initialize an SGE egress context</span>
<span class="cm"> *	@adapter: the adapter to configure</span>
<span class="cm"> *	@id: the context id</span>
<span class="cm"> *	@gts_enable: whether to enable GTS for the context</span>
<span class="cm"> *	@type: the egress context type</span>
<span class="cm"> *	@respq: associated response queue</span>
<span class="cm"> *	@base_addr: base address of queue</span>
<span class="cm"> *	@size: number of queue entries</span>
<span class="cm"> *	@token: uP token</span>
<span class="cm"> *	@gen: initial generation value for the context</span>
<span class="cm"> *	@cidx: consumer pointer</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize an SGE egress context and make it ready for use.  If the</span>
<span class="cm"> *	platform allows concurrent context operations, the caller is</span>
<span class="cm"> *	responsible for appropriate locking.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_init_ecntxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gts_enable</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">sge_context_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">respq</span><span class="p">,</span> <span class="n">u64</span> <span class="n">base_addr</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gen</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">SGE_CNTXT_OFLD</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FW_WR_NUM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span>	<span class="cm">/* must be 4K aligned */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="n">V_EC_INDEX</span><span class="p">(</span><span class="n">cidx</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_EC_CREDITS</span><span class="p">(</span><span class="n">credits</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_EC_GTS</span><span class="p">(</span><span class="n">gts_enable</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA1</span><span class="p">,</span> <span class="n">V_EC_SIZE</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_EC_BASE_LO</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA2</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA3</span><span class="p">,</span>
		     <span class="n">V_EC_BASE_HI</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_EC_RESPQ</span><span class="p">(</span><span class="n">respq</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_EC_TYPE</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_EC_GEN</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_EC_UP_TOKEN</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">F_EC_VALID</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t3_sge_write_context</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">F_EGRESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_init_flcntxt - initialize an SGE free-buffer list context</span>
<span class="cm"> *	@adapter: the adapter to configure</span>
<span class="cm"> *	@id: the context id</span>
<span class="cm"> *	@gts_enable: whether to enable GTS for the context</span>
<span class="cm"> *	@base_addr: base address of queue</span>
<span class="cm"> *	@size: number of queue entries</span>
<span class="cm"> *	@bsize: size of each buffer for this queue</span>
<span class="cm"> *	@cong_thres: threshold to signal congestion to upstream producers</span>
<span class="cm"> *	@gen: initial generation value for the context</span>
<span class="cm"> *	@cidx: consumer pointer</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize an SGE free list context and make it ready for use.  The</span>
<span class="cm"> *	caller is responsible for ensuring only one context operation occurs</span>
<span class="cm"> *	at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_init_flcntxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">gts_enable</span><span class="p">,</span> <span class="n">u64</span> <span class="n">base_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cong_thres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gen</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span>	<span class="cm">/* must be 4K aligned */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA1</span><span class="p">,</span>
		     <span class="n">V_FL_BASE_HI</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">base_addr</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_FL_INDEX_LO</span><span class="p">(</span><span class="n">cidx</span> <span class="o">&amp;</span> <span class="n">M_FL_INDEX_LO</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA2</span><span class="p">,</span> <span class="n">V_FL_SIZE</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_FL_GEN</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_FL_INDEX_HI</span><span class="p">(</span><span class="n">cidx</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_FL_ENTRY_SIZE_LO</span><span class="p">(</span><span class="n">bsize</span> <span class="o">&amp;</span> <span class="n">M_FL_ENTRY_SIZE_LO</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA3</span><span class="p">,</span>
		     <span class="n">V_FL_ENTRY_SIZE_HI</span><span class="p">(</span><span class="n">bsize</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">S_FL_ENTRY_SIZE_LO</span><span class="p">))</span> <span class="o">|</span>
		     <span class="n">V_FL_CONG_THRES</span><span class="p">(</span><span class="n">cong_thres</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_FL_GTS</span><span class="p">(</span><span class="n">gts_enable</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_sge_write_context</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">F_FREELIST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_init_rspcntxt - initialize an SGE response queue context</span>
<span class="cm"> *	@adapter: the adapter to configure</span>
<span class="cm"> *	@id: the context id</span>
<span class="cm"> *	@irq_vec_idx: MSI-X interrupt vector index, 0 if no MSI-X, -1 if no IRQ</span>
<span class="cm"> *	@base_addr: base address of queue</span>
<span class="cm"> *	@size: number of queue entries</span>
<span class="cm"> *	@fl_thres: threshold for selecting the normal or jumbo free list</span>
<span class="cm"> *	@gen: initial generation value for the context</span>
<span class="cm"> *	@cidx: consumer pointer</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize an SGE response queue context and make it ready for use.</span>
<span class="cm"> *	The caller is responsible for ensuring only one context operation</span>
<span class="cm"> *	occurs at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_init_rspcntxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">irq_vec_idx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">base_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fl_thres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span>	<span class="cm">/* must be 4K aligned */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="n">V_CQ_SIZE</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_CQ_INDEX</span><span class="p">(</span><span class="n">cidx</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA1</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_vec_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">intr</span> <span class="o">=</span> <span class="n">V_RQ_MSI_VEC</span><span class="p">(</span><span class="n">irq_vec_idx</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_RQ_INTR_EN</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA2</span><span class="p">,</span>
		     <span class="n">V_CQ_BASE_HI</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">base_addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">intr</span> <span class="o">|</span> <span class="n">V_RQ_GEN</span><span class="p">(</span><span class="n">gen</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA3</span><span class="p">,</span> <span class="n">fl_thres</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t3_sge_write_context</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">F_RESPONSEQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_init_cqcntxt - initialize an SGE completion queue context</span>
<span class="cm"> *	@adapter: the adapter to configure</span>
<span class="cm"> *	@id: the context id</span>
<span class="cm"> *	@base_addr: base address of queue</span>
<span class="cm"> *	@size: number of queue entries</span>
<span class="cm"> *	@rspq: response queue for async notifications</span>
<span class="cm"> *	@ovfl_mode: CQ overflow mode</span>
<span class="cm"> *	@credits: completion queue credits</span>
<span class="cm"> *	@credit_thres: the credit threshold</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize an SGE completion queue context and make it ready for use.</span>
<span class="cm"> *	The caller is responsible for ensuring only one context operation</span>
<span class="cm"> *	occurs at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_init_cqcntxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">u64</span> <span class="n">base_addr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rspq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ovfl_mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credit_thres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span>	<span class="cm">/* must be 4K aligned */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="n">V_CQ_SIZE</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA1</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
	<span class="n">base_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA2</span><span class="p">,</span>
		     <span class="n">V_CQ_BASE_HI</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">base_addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_CQ_RSPQ</span><span class="p">(</span><span class="n">rspq</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_CQ_GEN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_CQ_OVERFLOW_MODE</span><span class="p">(</span><span class="n">ovfl_mode</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_CQ_ERR</span><span class="p">(</span><span class="n">ovfl_mode</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA3</span><span class="p">,</span> <span class="n">V_CQ_CREDITS</span><span class="p">(</span><span class="n">credits</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_CQ_CREDIT_THRES</span><span class="p">(</span><span class="n">credit_thres</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_sge_write_context</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">F_CQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_enable_ecntxt - enable/disable an SGE egress context</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@id: the egress context id</span>
<span class="cm"> *	@enable: enable (1) or disable (0) the context</span>
<span class="cm"> *</span>
<span class="cm"> *	Enable or disable an SGE egress context.  The caller is responsible for</span>
<span class="cm"> *	ensuring only one context operation occurs at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_enable_ecntxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK3</span><span class="p">,</span> <span class="n">F_EC_VALID</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA3</span><span class="p">,</span> <span class="n">V_EC_VALID</span><span class="p">(</span><span class="n">enable</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
		     <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_EGRESS</span> <span class="o">|</span> <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_disable_fl - disable an SGE free-buffer list</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@id: the free list context id</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable an SGE free-buffer list.  The caller is responsible for</span>
<span class="cm"> *	ensuring only one context operation occurs at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_disable_fl</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK2</span><span class="p">,</span> <span class="n">V_FL_SIZE</span><span class="p">(</span><span class="n">M_FL_SIZE</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
		     <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_FREELIST</span> <span class="o">|</span> <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_disable_rspcntxt - disable an SGE response queue</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@id: the response queue context id</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable an SGE response queue.  The caller is responsible for</span>
<span class="cm"> *	ensuring only one context operation occurs at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_disable_rspcntxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK0</span><span class="p">,</span> <span class="n">V_CQ_SIZE</span><span class="p">(</span><span class="n">M_CQ_SIZE</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
		     <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_RESPONSEQ</span> <span class="o">|</span> <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_disable_cqcntxt - disable an SGE completion queue</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@id: the completion queue context id</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable an SGE completion queue.  The caller is responsible for</span>
<span class="cm"> *	ensuring only one context operation occurs at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_disable_cqcntxt</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK0</span><span class="p">,</span> <span class="n">V_CQ_SIZE</span><span class="p">(</span><span class="n">M_CQ_SIZE</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_MASK3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
		     <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_CQ</span> <span class="o">|</span> <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_sge_cqcntxt_op - perform an operation on a completion queue context</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@id: the context id</span>
<span class="cm"> *	@op: the operation to perform</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform the selected operation on an SGE completion queue context.</span>
<span class="cm"> *	The caller is responsible for ensuring only one context operation</span>
<span class="cm"> *	occurs at a time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_sge_cqcntxt_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">,</span> <span class="n">credits</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_CQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t3_wait_op_done_val</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">op</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">G_CQ_INDEX</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
			     <span class="n">V_CONTEXT_CMD_OPCODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_CQ</span> <span class="o">|</span> <span class="n">V_CONTEXT</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">,</span>
				    <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">SG_CONTEXT_CMD_ATTEMPTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">G_CQ_INDEX</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_DATA0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_config_rss - configure Rx packet steering</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@rss_config: RSS settings (written to TP_RSS_CONFIG)</span>
<span class="cm"> *	@cpus: values for the CPU lookup table (0xff terminated)</span>
<span class="cm"> *	@rspq: values for the response queue lookup table (0xffff terminated)</span>
<span class="cm"> *</span>
<span class="cm"> *	Programs the receive packet steering logic.  @cpus and @rspq provide</span>
<span class="cm"> *	the values for the CPU and response queue lookup tables.  If they</span>
<span class="cm"> *	provide fewer values than the size of the tables the supplied values</span>
<span class="cm"> *	are used repeatedly until the tables are fully populated.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_config_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rss_config</span><span class="p">,</span>
		   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">cpus</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rspq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">cpu_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpus</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RSS_TABLE_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cpus</span><span class="p">[</span><span class="n">cpu_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">j</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cpus</span><span class="p">[</span><span class="n">cpu_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
					<span class="n">cpu_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_RSS_LKP_TABLE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rspq</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RSS_TABLE_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_RSS_MAP_TABLE</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">rspq</span><span class="p">[</span><span class="n">q_idx</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rspq</span><span class="p">[</span><span class="n">q_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
				<span class="n">q_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_RSS_CONFIG</span><span class="p">,</span> <span class="n">rss_config</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_tp_set_offload_mode - put TP in NIC/offload mode</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@enable: 1 to select offload mode, 0 for regular NIC</span>
<span class="cm"> *</span>
<span class="cm"> *	Switches TP to NIC/offload mode.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_tp_set_offload_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_IN_CONFIG</span><span class="p">,</span> <span class="n">F_NICMODE</span><span class="p">,</span>
				 <span class="n">V_NICMODE</span><span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pm_num_pages - calculate the number of pages of the payload memory</span>
<span class="cm"> *	@mem_size: the size of the payload memory</span>
<span class="cm"> *	@pg_size: the size of each payload memory page</span>
<span class="cm"> *</span>
<span class="cm"> *	Calculate the number of pages, each of the given size, that fit in a</span>
<span class="cm"> *	memory of the specified size, respecting the HW requirement that the</span>
<span class="cm"> *	number of pages must be a multiple of 24.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pm_num_pages</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem_size</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pg_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">mem_size</span> <span class="o">/</span> <span class="n">pg_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define mem_region(adap, start, size, reg) \</span>
<span class="cp">	t3_write_reg((adap), A_ ## reg, (start)); \</span>
<span class="cp">	start += size</span>

<span class="cm">/**</span>
<span class="cm"> *	partition_mem - partition memory and configure TP memory settings</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@p: the TP parameters</span>
<span class="cm"> *</span>
<span class="cm"> *	Partitions context and payload memory and configures TP&#39;s memory</span>
<span class="cm"> *	registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">partition_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tp_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">pstructs</span><span class="p">,</span> <span class="n">tids</span> <span class="o">=</span> <span class="n">t3_mc5_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">mc5</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timers_shift</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tids</span> <span class="o">&lt;=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">timers_shift</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tids</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timers</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">timers_shift</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tids</span> <span class="o">&lt;=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">timers_shift</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PMM_SIZE</span><span class="p">,</span>
		     <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_tx_size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PMM_TX_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PMM_TX_PAGE_SIZE</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_pg_size</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PMM_TX_MAX_PAGE</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_num_pgs</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG3</span><span class="p">,</span> <span class="n">V_TXDATAACKIDX</span><span class="p">(</span><span class="n">M_TXDATAACKIDX</span><span class="p">),</span>
			 <span class="n">V_TXDATAACKIDX</span><span class="p">(</span><span class="n">fls</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_pg_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">12</span><span class="p">));</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PMM_RX_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PMM_RX_PAGE_SIZE</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_pg_size</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PMM_RX_MAX_PAGE</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_num_pgs</span><span class="p">);</span>

	<span class="n">pstructs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_num_pgs</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_num_pgs</span><span class="p">;</span>
	<span class="cm">/* Add a bit of headroom and make multiple of 24 */</span>
	<span class="n">pstructs</span> <span class="o">+=</span> <span class="mi">48</span><span class="p">;</span>
	<span class="n">pstructs</span> <span class="o">-=</span> <span class="n">pstructs</span> <span class="o">%</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_CMM_MM_MAX_PSTRUCT</span><span class="p">,</span> <span class="n">pstructs</span><span class="p">);</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">tids</span> <span class="o">*</span> <span class="n">TCB_SIZE</span><span class="p">;</span>
	<span class="n">mem_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="n">SG_EGR_CNTX_BADDR</span><span class="p">);</span>
	<span class="n">mem_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="n">SG_CQ_CONTEXT_BADDR</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_CMM_TIMER_BASE</span><span class="p">,</span> <span class="n">V_CMTIMERMAXNUM</span><span class="p">(</span><span class="n">timers</span><span class="p">)</span> <span class="o">|</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">+=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ntimer_qs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">timers_shift</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">mem_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">pstructs</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="n">TP_CMM_MM_BASE</span><span class="p">);</span>
	<span class="n">mem_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="p">(</span><span class="n">pstructs</span> <span class="o">/</span> <span class="mi">24</span><span class="p">),</span> <span class="n">TP_CMM_MM_PS_FLST_BASE</span><span class="p">);</span>
	<span class="n">mem_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_num_pgs</span> <span class="o">/</span> <span class="mi">24</span><span class="p">),</span> <span class="n">TP_CMM_MM_RX_FLST_BASE</span><span class="p">);</span>
	<span class="n">mem_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_num_pgs</span> <span class="o">/</span> <span class="mi">24</span><span class="p">),</span> <span class="n">TP_CMM_MM_TX_FLST_BASE</span><span class="p">);</span>

	<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_SDRAM_BASE_ADDR</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_SDRAM_ADDR_SIZE</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cm_size</span> <span class="o">-</span> <span class="n">m</span><span class="p">);</span>

	<span class="n">tids</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cm_size</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3072</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">t3_mc5_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">mc5</span><span class="p">)</span> <span class="o">-</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nservers</span> <span class="o">-</span>
	    <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nfilters</span> <span class="o">-</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nroutes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tids</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nservers</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">tids</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tp_wr_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PIO_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tp_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tp_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_GLOBAL_CONFIG</span><span class="p">,</span> <span class="n">F_TXPACINGENABLE</span> <span class="o">|</span> <span class="n">F_PATHMTU</span> <span class="o">|</span>
		     <span class="n">F_IPCHECKSUMOFFLOAD</span> <span class="o">|</span> <span class="n">F_UDPCHECKSUMOFFLOAD</span> <span class="o">|</span>
		     <span class="n">F_TCPCHECKSUMOFFLOAD</span> <span class="o">|</span> <span class="n">V_IPTTL</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TCP_OPTIONS</span><span class="p">,</span> <span class="n">V_MTUDEFAULT</span><span class="p">(</span><span class="mi">576</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">F_MTUENABLE</span> <span class="o">|</span> <span class="n">V_WINDOWSCALEMODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_TIMESTAMPSMODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_SACKMODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_SACKRX</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_DACK_CONFIG</span><span class="p">,</span> <span class="n">V_AUTOSTATE3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_AUTOSTATE2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_AUTOSTATE1</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_BYTETHRESHOLD</span><span class="p">(</span><span class="mi">26880</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_MSSTHRESHOLD</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">F_AUTOCAREFUL</span> <span class="o">|</span> <span class="n">F_AUTOENABLE</span> <span class="o">|</span> <span class="n">V_DACK_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_IN_CONFIG</span><span class="p">,</span> <span class="n">F_RXFBARBPRIO</span> <span class="o">|</span> <span class="n">F_TXFBARBPRIO</span><span class="p">,</span>
			 <span class="n">F_IPV6ENABLE</span> <span class="o">|</span> <span class="n">F_NICMODE</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TX_RESOURCE_LIMIT</span><span class="p">,</span> <span class="mh">0x18141814</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG4</span><span class="p">,</span> <span class="mh">0x5050105</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">F_ENABLEESND</span> <span class="o">:</span>
			 <span class="n">F_T3A_ENABLEESND</span><span class="p">);</span>

	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PC_CONFIG</span><span class="p">,</span>
			 <span class="n">F_ENABLEEPCMDAFULL</span><span class="p">,</span>
			 <span class="n">F_ENABLEOCSPIFULL</span> <span class="o">|</span><span class="n">F_TXDEFERENABLE</span> <span class="o">|</span> <span class="n">F_HEARBEATDACK</span> <span class="o">|</span>
			 <span class="n">F_TXCONGESTIONMODE</span> <span class="o">|</span> <span class="n">F_RXCONGESTIONMODE</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PC_CONFIG2</span><span class="p">,</span> <span class="n">F_CHDRAFULL</span><span class="p">,</span>
			 <span class="n">F_ENABLEIPV6RSS</span> <span class="o">|</span> <span class="n">F_ENABLENONOFDTNLSYN</span> <span class="o">|</span>
			 <span class="n">F_ENABLEARPMISS</span> <span class="o">|</span> <span class="n">F_DISBLEDAPARBIT0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PROXY_FLOW_CNTL</span><span class="p">,</span> <span class="mi">1080</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PROXY_FLOW_CNTL</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EGRESS_CONFIG</span><span class="p">,</span> <span class="n">F_REWRITEFORCETOSIZE</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG3</span><span class="p">,</span> <span class="n">F_TXPACEAUTO</span><span class="p">,</span>
				 <span class="n">F_TXPACEAUTO</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PC_CONFIG</span><span class="p">,</span> <span class="n">F_LOCKTID</span><span class="p">,</span> <span class="n">F_LOCKTID</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_TXPACEAUTOSTRICT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_TXPACEFIXED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_C</span><span class="p">)</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PC_CONFIG</span><span class="p">,</span>
				 <span class="n">V_TABLELATENCYDELTA</span><span class="p">(</span><span class="n">M_TABLELATENCYDELTA</span><span class="p">),</span>
				 <span class="n">V_TABLELATENCYDELTA</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TX_MOD_QUEUE_WEIGHT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TX_MOD_QUEUE_WEIGHT0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_MOD_CHANNEL_WEIGHT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_MOD_RATE_LIMIT</span><span class="p">,</span> <span class="mh">0xf2200000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Desired TP timer resolution in usec */</span>
<span class="cp">#define TP_TMR_RES 50</span>

<span class="cm">/* TCP timer values in ms */</span>
<span class="cp">#define TP_DACK_TIMER 50</span>
<span class="cp">#define TP_RTO_MIN    250</span>

<span class="cm">/**</span>
<span class="cm"> *	tp_set_timers - set TP timing parameters</span>
<span class="cm"> *	@adap: the adapter to set</span>
<span class="cm"> *	@core_clk: the core clock frequency in Hz</span>
<span class="cm"> *</span>
<span class="cm"> *	Set TP&#39;s timing parameters, such as the various timer resolutions and</span>
<span class="cm"> *	the TCP timer values.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tp_set_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">core_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tre</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">core_clk</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">TP_TMR_RES</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dack_re</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">core_clk</span> <span class="o">/</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 200us */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tstamp_re</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">core_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>	<span class="cm">/* 1ms, at least */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tps</span> <span class="o">=</span> <span class="n">core_clk</span> <span class="o">&gt;&gt;</span> <span class="n">tre</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TIMER_RESOLUTION</span><span class="p">,</span> <span class="n">V_TIMERRESOLUTION</span><span class="p">(</span><span class="n">tre</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_DELAYEDACKRESOLUTION</span><span class="p">(</span><span class="n">dack_re</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_TIMESTAMPRESOLUTION</span><span class="p">(</span><span class="n">tstamp_re</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_DACK_TIMER</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">core_clk</span> <span class="o">&gt;&gt;</span> <span class="n">dack_re</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">TP_DACK_TIMER</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TCP_BACKOFF_REG0</span><span class="p">,</span> <span class="mh">0x3020100</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TCP_BACKOFF_REG1</span><span class="p">,</span> <span class="mh">0x7060504</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TCP_BACKOFF_REG2</span><span class="p">,</span> <span class="mh">0xb0a0908</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TCP_BACKOFF_REG3</span><span class="p">,</span> <span class="mh">0xf0e0d0c</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_SHIFT_CNT</span><span class="p">,</span> <span class="n">V_SYNSHIFTMAX</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_RXTSHIFTMAXR1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_RXTSHIFTMAXR2</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_PERSHIFTBACKOFFMAX</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PERSHIFTMAX</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_KEEPALIVEMAX</span><span class="p">(</span><span class="mi">9</span><span class="p">));</span>

<span class="cp">#define SECONDS * tps</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_MSL</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span> <span class="n">SECONDS</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_RXT_MIN</span><span class="p">,</span> <span class="n">tps</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">TP_RTO_MIN</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_RXT_MAX</span><span class="p">,</span> <span class="mi">64</span> <span class="n">SECONDS</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PERS_MIN</span><span class="p">,</span> <span class="mi">5</span> <span class="n">SECONDS</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PERS_MAX</span><span class="p">,</span> <span class="mi">64</span> <span class="n">SECONDS</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_KEEP_IDLE</span><span class="p">,</span> <span class="mi">7200</span> <span class="n">SECONDS</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_KEEP_INTVL</span><span class="p">,</span> <span class="mi">75</span> <span class="n">SECONDS</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_INIT_SRTT</span><span class="p">,</span> <span class="mi">3</span> <span class="n">SECONDS</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_FINWAIT2_TIMER</span><span class="p">,</span> <span class="mi">600</span> <span class="n">SECONDS</span><span class="p">);</span>

<span class="cp">#undef SECONDS</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_tp_set_coalescing_size - set receive coalescing size</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@size: the receive coalescing size</span>
<span class="cm"> *	@psh: whether a set PSH bit should deliver coalesced data</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the receive coalescing size and PSH bit handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t3_tp_set_coalescing_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">psh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_RX_COALESCING_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG3</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">F_RXCOALESCEENABLE</span> <span class="o">|</span> <span class="n">F_RXCOALESCEPSHEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_RXCOALESCEENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psh</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">F_RXCOALESCEPSHEN</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">MAX_RX_COALESCING_LEN</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG2</span><span class="p">,</span> <span class="n">V_RXCOALESCESIZE</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">V_MAXRXDATA</span><span class="p">(</span><span class="n">MAX_RX_COALESCING_LEN</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG3</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_tp_set_max_rxsize - set the max receive size</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@size: the max receive size</span>
<span class="cm"> *</span>
<span class="cm"> *	Set TP&#39;s max receive size.  This is the limit that applies when</span>
<span class="cm"> *	receive coalescing is disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">t3_tp_set_max_rxsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PARA_REG7</span><span class="p">,</span>
		     <span class="n">V_PMMAXXFERLEN0</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PMMAXXFERLEN1</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_mtus</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtus</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * See draft-mathis-plpmtud-00.txt for the values.  The min is 88 so</span>
<span class="cm">	 * it can accommodate max size TCP/IP headers when SACK and timestamps</span>
<span class="cm">	 * are enabled and still have at least 8 bytes of payload.</span>
<span class="cm">	 */</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1280</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1492</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2002</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4352</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9000</span><span class="p">;</span>
	<span class="n">mtus</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initial congestion control parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_cong_ctrl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mi">45</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The minimum additive increment value for the congestion control table */</span>
<span class="cp">#define CC_MIN_INCR 2U</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_load_mtus - write the MTU and congestion control HW tables</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@mtus: the unrestricted values for the MTU table</span>
<span class="cm"> *	@alphs: the values for the congestion control alpha parameter</span>
<span class="cm"> *	@beta: the values for the congestion control beta parameter</span>
<span class="cm"> *	@mtu_cap: the maximum permitted effective MTU</span>
<span class="cm"> *</span>
<span class="cm"> *	Write the MTU table with the supplied MTUs capping each at &amp;mtu_cap.</span>
<span class="cm"> *	Update the high-speed congestion control table with the supplied alpha,</span>
<span class="cm"> * 	beta, and MTUs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_load_mtus</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtus</span><span class="p">[</span><span class="n">NMTUS</span><span class="p">],</span>
		  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">alpha</span><span class="p">[</span><span class="n">NCCTRL_WIN</span><span class="p">],</span>
		  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">beta</span><span class="p">[</span><span class="n">NCCTRL_WIN</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtu_cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">avg_pkts</span><span class="p">[</span><span class="n">NCCTRL_WIN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">448</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span>
		<span class="mi">896</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1792</span><span class="p">,</span> <span class="mi">2560</span><span class="p">,</span> <span class="mi">3584</span><span class="p">,</span> <span class="mi">5120</span><span class="p">,</span> <span class="mi">7168</span><span class="p">,</span> <span class="mi">10240</span><span class="p">,</span> <span class="mi">14336</span><span class="p">,</span> <span class="mi">20480</span><span class="p">,</span>
		<span class="mi">28672</span><span class="p">,</span> <span class="mi">40960</span><span class="p">,</span> <span class="mi">57344</span><span class="p">,</span> <span class="mi">81920</span><span class="p">,</span> <span class="mi">114688</span><span class="p">,</span> <span class="mi">163840</span><span class="p">,</span> <span class="mi">229376</span>
	<span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NMTUS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">mtus</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mtu_cap</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">log2</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">mtu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mtu</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)))</span>	<span class="cm">/* round */</span>
			<span class="n">log2</span><span class="o">--</span><span class="p">;</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_MTU_TABLE</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">log2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mtu</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">NCCTRL_WIN</span><span class="p">;</span> <span class="o">++</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">;</span>

			<span class="n">inc</span> <span class="o">=</span> <span class="n">max</span><span class="p">(((</span><span class="n">mtu</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">/</span> <span class="n">avg_pkts</span><span class="p">[</span><span class="n">w</span><span class="p">],</span>
				  <span class="n">CC_MIN_INCR</span><span class="p">);</span>

			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_CCTRL_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">inc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_tp_get_mib_stats - read TP&#39;s MIB counters</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@tps: holds the returned counter values</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the values of TP&#39;s MIB counters.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t3_tp_get_mib_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tp_mib_stats</span> <span class="o">*</span><span class="n">tps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_read_indirect</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_MIB_INDEX</span><span class="p">,</span> <span class="n">A_TP_MIB_RDATA</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">tps</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tps</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ulp_region(adap, name, start, len) \</span>
<span class="cp">	t3_write_reg((adap), A_ULPRX_ ## name ## _LLIMIT, (start)); \</span>
<span class="cp">	t3_write_reg((adap), A_ULPRX_ ## name ## _ULIMIT, \</span>
<span class="cp">		     (start) + (len) - 1); \</span>
<span class="cp">	start += len</span>

<span class="cp">#define ulptx_region(adap, name, start, len) \</span>
<span class="cp">	t3_write_reg((adap), A_ULPTX_ ## name ## _LLIMIT, (start)); \</span>
<span class="cp">	t3_write_reg((adap), A_ULPTX_ ## name ## _ULIMIT, \</span>
<span class="cp">		     (start) + (len) - 1)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ulp_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tp_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span><span class="p">;</span>

	<span class="n">ulp_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">ISCSI</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ulp_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TDDP</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ulptx_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">TPT</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ulp_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">STAG</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ulp_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">RQ</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ulptx_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PBL</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ulp_region</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">PBL</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_ULPRX_TDDP_TAGMASK</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_set_proto_sram - set the contents of the protocol sram</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@data: the protocol image</span>
<span class="cm"> *</span>
<span class="cm"> *	Write the contents of the protocol SRAM.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_set_proto_sram</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROTO_SRAM_LINES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD5</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">));</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD4</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">));</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD3</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">));</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD2</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">));</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD1</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">));</span>

		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD0</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_EMBED_OP_FIELD0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_config_trace_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_params</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">filter_index</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">invert</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mask</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sport</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sip</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sip</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dport</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dip</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

	<span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sport_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sip_mask</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">sip_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dport_mask</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dip_mask</span><span class="p">;</span>
	<span class="n">mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">proto_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">vlan_mask</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">intf_mask</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">filter_index</span> <span class="o">?</span> <span class="n">A_TP_RX_TRC_KEY0</span> <span class="o">:</span> <span class="n">A_TP_TX_TRC_KEY0</span><span class="p">;</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">tp_wr_indirect</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_TP_PIO_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	t3_config_sched - configure a HW traffic scheduler</span>
<span class="cm"> *	@adap: the adapter</span>
<span class="cm"> *	@kbps: target rate in Kbps</span>
<span class="cm"> *	@sched: the scheduler index</span>
<span class="cm"> *</span>
<span class="cm"> *	Configure a HW scheduler for the target rate</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_config_sched</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">kbps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sched</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">tps</span><span class="p">,</span> <span class="n">cpt</span><span class="p">,</span> <span class="n">bpt</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">mindelta</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clk</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">cclk</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">selected_cpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selected_bpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kbps</span> <span class="o">*=</span> <span class="mi">125</span><span class="p">;</span>	<span class="cm">/* -&gt; bytes */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cpt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cpt</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">cpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tps</span> <span class="o">=</span> <span class="n">clk</span> <span class="o">/</span> <span class="n">cpt</span><span class="p">;</span>
			<span class="n">bpt</span> <span class="o">=</span> <span class="p">(</span><span class="n">kbps</span> <span class="o">+</span> <span class="n">tps</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tps</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bpt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bpt</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">bpt</span> <span class="o">*</span> <span class="n">tps</span><span class="p">;</span>
				<span class="n">delta</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">kbps</span> <span class="o">?</span> <span class="n">v</span> <span class="o">-</span> <span class="n">kbps</span> <span class="o">:</span> <span class="n">kbps</span> <span class="o">-</span> <span class="n">v</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="n">mindelta</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mindelta</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span>
					<span class="n">selected_cpt</span> <span class="o">=</span> <span class="n">cpt</span><span class="p">;</span>
					<span class="n">selected_bpt</span> <span class="o">=</span> <span class="n">bpt</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">selected_cpt</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">selected_cpt</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TM_PIO_ADDR</span><span class="p">,</span>
		     <span class="n">A_TP_TX_MOD_Q1_Q0_RATE_LIMIT</span> <span class="o">-</span> <span class="n">sched</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TM_PIO_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sched</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">selected_cpt</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">selected_bpt</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="n">selected_cpt</span> <span class="o">|</span> <span class="p">(</span><span class="n">selected_bpt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TM_PIO_DATA</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tp_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tp_config</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">t3_set_vlan_accel</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp_set_timers</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">cclk</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_RESET</span><span class="p">,</span> <span class="n">F_FLSTINITENABLE</span><span class="p">);</span>
		<span class="n">busy</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_RESET</span><span class="p">,</span> <span class="n">F_FLSTINITENABLE</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">busy</span><span class="p">)</span>
			<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="s">&quot;TP initialization timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">busy</span><span class="p">)</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_RESET</span><span class="p">,</span> <span class="n">F_TPRESET</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">busy</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform the bits of HW initialization that are dependent on the Tx</span>
<span class="cm"> * channels being used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">chan_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_map</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>                                 <span class="cm">/* one channel */</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_ULPRX_CTL</span><span class="p">,</span> <span class="n">F_ROUND_ROBIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_ULPTX_CONFIG</span><span class="p">,</span> <span class="n">F_CFG_RR_ARB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="n">F_TPRXPORTEN</span> <span class="o">|</span> <span class="n">F_ENFORCEPKT</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">chan_map</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">F_TPTXPORT0EN</span> <span class="o">|</span> <span class="n">F_PORT0ACTIVE</span> <span class="o">:</span>
					      <span class="n">F_TPTXPORT1EN</span> <span class="o">|</span> <span class="n">F_PORT1ACTIVE</span><span class="p">));</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PM1_TX_CFG</span><span class="p">,</span>
			     <span class="n">chan_map</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mh">0xffffffff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                             <span class="cm">/* two channels */</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_ULPRX_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_ROUND_ROBIN</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_ULPTX_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_CFG_RR_ARB</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_ULPTX_DMA_WEIGHT</span><span class="p">,</span>
			     <span class="n">V_D1_WEIGHT</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_D0_WEIGHT</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_MPS_CFG</span><span class="p">,</span> <span class="n">F_TPTXPORT0EN</span> <span class="o">|</span> <span class="n">F_TPTXPORT1EN</span> <span class="o">|</span>
			     <span class="n">F_TPRXPORTEN</span> <span class="o">|</span> <span class="n">F_PORT0ACTIVE</span> <span class="o">|</span> <span class="n">F_PORT1ACTIVE</span> <span class="o">|</span>
			     <span class="n">F_ENFORCEPKT</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PM1_TX_CFG</span><span class="p">,</span> <span class="mh">0x80008000</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_PC_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_TXTOSQUEUEMAPMODE</span><span class="p">);</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TX_MOD_QUEUE_REQ_MAP</span><span class="p">,</span>
			     <span class="n">V_TX_MOD_QUEUE_REQ_MAP</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_TP_TX_MOD_QUE_TABLE</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1010</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calibrate_xgm</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XAUI_IMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XAUI_IMP</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XAUI_IMP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F_XGM_CALFAULT</span> <span class="o">|</span> <span class="n">F_CALBUSY</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_XAUI_IMP</span><span class="p">,</span>
					     <span class="n">V_XAUIIMP</span><span class="p">(</span><span class="n">G_CALIMP</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;MAC calibration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span>
			     <span class="n">V_RGMIIIMPPD</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_RGMIIIMPPU</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span> <span class="n">F_XGM_IMPSETUPDATE</span><span class="p">,</span>
				 <span class="n">F_XGM_IMPSETUPDATE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calibrate_xgm_t3b</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span> <span class="n">F_CALRESET</span> <span class="o">|</span>
			     <span class="n">F_CALUPDATE</span> <span class="o">|</span> <span class="n">V_RGMIIIMPPD</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_RGMIIIMPPU</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span> <span class="n">F_CALRESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">F_XGM_IMPSETUPDATE</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span> <span class="n">F_XGM_IMPSETUPDATE</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span> <span class="n">F_CALUPDATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_RGMII_IMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_CALUPDATE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">mc7_timing_params</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ActToPreDly</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ActToRdWrDly</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">PreCyc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RefCyc</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BkCyc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WrToRdDly</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RdToWrDly</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Write a value to a register and check that the write completed.  These</span>
<span class="cm"> * writes normally complete in a cycle or two, so one read should suffice.</span>
<span class="cm"> * The very first read exists to flush the posted write to the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wrreg_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_BUSY</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;write to MC7 register 0x%x timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mc7_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mc7</span> <span class="o">*</span><span class="n">mc7</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mc7_clock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mem_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mc7_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x632</span><span class="p">,</span> <span class="mh">0x642</span><span class="p">,</span> <span class="mh">0x652</span><span class="p">,</span> <span class="mh">0x432</span><span class="p">,</span> <span class="mh">0x442</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mc7_timing_params</span> <span class="n">mc7_timings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="mi">15</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">15</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">attempts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mc7_timing_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc7_timings</span><span class="p">[</span><span class="n">mem_type</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc7</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CFG</span><span class="p">);</span>
	<span class="n">slow</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">F_SLOW</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">G_WIDTH</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">density</span> <span class="o">=</span> <span class="n">G_DEN</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CFG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">F_IFEN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CFG</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CAL</span><span class="p">,</span> <span class="n">F_SGL_CAL_EN</span><span class="p">);</span>
		<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CAL</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CAL</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">F_BUSY</span> <span class="o">|</span> <span class="n">F_SGL_CAL_EN</span> <span class="o">|</span> <span class="n">F_CAL_FAULT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s MC7 calibration timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_PARM</span><span class="p">,</span>
		     <span class="n">V_ACTTOPREDLY</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ActToPreDly</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_ACTTORDWRDLY</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ActToRdWrDly</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_PRECYC</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">PreCyc</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_REFCYC</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">RefCyc</span><span class="p">[</span><span class="n">density</span><span class="p">])</span> <span class="o">|</span> <span class="n">V_BKCYC</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">BkCyc</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">V_WRTORDDLY</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">WrToRdDly</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_RDTOWRDLY</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">RdToWrDly</span><span class="p">));</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CFG</span><span class="p">,</span>
		     <span class="n">val</span> <span class="o">|</span> <span class="n">F_CLKEN</span> <span class="o">|</span> <span class="n">F_TERM150</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CFG</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slow</span><span class="p">)</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_DLL</span><span class="p">,</span> <span class="n">F_DLLENB</span><span class="p">,</span>
				 <span class="n">F_DLLENB</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">slow</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_PRE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_EXT_MODE2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_EXT_MODE3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_EXT_MODE1</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_MODE</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_DLL</span><span class="p">,</span> <span class="n">F_DLLRST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_PRE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_REF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_REF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_MODE</span><span class="p">,</span>
		       <span class="n">mc7_mode</span><span class="p">[</span><span class="n">mem_type</span><span class="p">])</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_EXT_MODE1</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x380</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wrreg_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_EXT_MODE1</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>

	<span class="cm">/* clock value is in KHz */</span>
	<span class="n">mc7_clock</span> <span class="o">=</span> <span class="n">mc7_clock</span> <span class="o">*</span> <span class="mi">7812</span> <span class="o">+</span> <span class="n">mc7_clock</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* ns */</span>
	<span class="n">mc7_clock</span> <span class="o">/=</span> <span class="mi">1000000</span><span class="p">;</span>	<span class="cm">/* KHz-&gt;MHz, ns-&gt;us */</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_REF</span><span class="p">,</span>
		     <span class="n">F_PERREFEN</span> <span class="o">|</span> <span class="n">V_PREREFDIV</span><span class="p">(</span><span class="n">mc7_clock</span><span class="p">));</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_REF</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_ECC</span><span class="p">,</span> <span class="n">F_ECCGENEN</span> <span class="o">|</span> <span class="n">F_ECCCHKEN</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BIST_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BIST_ADDR_BEG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BIST_ADDR_END</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">mc7</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BIST_OP</span><span class="p">,</span> <span class="n">V_OP</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BIST_OP</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="n">attempts</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_BIST_OP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">F_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">attempts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">F_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;%s MC7 BIST timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable normal memory accesses. */</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_RDY</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">config_pcie</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ack_lat</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">237</span><span class="p">,</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">559</span><span class="p">,</span> <span class="mi">1071</span><span class="p">,</span> <span class="mi">2095</span><span class="p">,</span> <span class="mi">4143</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">128</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">289</span><span class="p">,</span> <span class="mi">545</span><span class="p">,</span> <span class="mi">1057</span><span class="p">,</span> <span class="mi">2081</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">73</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">282</span><span class="p">,</span> <span class="mi">538</span><span class="p">,</span> <span class="mi">1050</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">67</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">278</span><span class="p">,</span> <span class="mi">534</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rpl_tmr</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">711</span><span class="p">,</span> <span class="mi">1248</span><span class="p">,</span> <span class="mi">1677</span><span class="p">,</span> <span class="mi">3213</span><span class="p">,</span> <span class="mi">6285</span><span class="p">,</span> <span class="mi">12429</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">384</span><span class="p">,</span> <span class="mi">651</span><span class="p">,</span> <span class="mi">867</span><span class="p">,</span> <span class="mi">1635</span><span class="p">,</span> <span class="mi">3171</span><span class="p">,</span> <span class="mi">6243</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">219</span><span class="p">,</span> <span class="mi">354</span><span class="p">,</span> <span class="mi">462</span><span class="p">,</span> <span class="mi">846</span><span class="p">,</span> <span class="mi">1614</span><span class="p">,</span> <span class="mi">3150</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">201</span><span class="p">,</span> <span class="mi">321</span><span class="p">,</span> <span class="mi">258</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">834</span><span class="p">,</span> <span class="mi">1602</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">log2_width</span><span class="p">,</span> <span class="n">pldsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fst_trn_rx</span><span class="p">,</span> <span class="n">fst_trn_tx</span><span class="p">,</span> <span class="n">acklat</span><span class="p">,</span> <span class="n">rpllmt</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			     <span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">pldsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="mh">0x37</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span>
				      <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_READRQ</span> <span class="o">&amp;</span>
				      <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">);</span>
		<span class="n">pldsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">fst_trn_tx</span> <span class="o">=</span> <span class="n">G_NUMFSTTRNSEQ</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_PEX_CTRL0</span><span class="p">));</span>
	<span class="n">fst_trn_rx</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">fst_trn_tx</span> <span class="o">:</span>
	    <span class="n">G_NUMFSTTRNSEQRX</span><span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_MODE</span><span class="p">));</span>
	<span class="n">log2_width</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">acklat</span> <span class="o">=</span> <span class="n">ack_lat</span><span class="p">[</span><span class="n">log2_width</span><span class="p">][</span><span class="n">pldsize</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>		<span class="cm">/* check LOsEnable */</span>
		<span class="n">acklat</span> <span class="o">+=</span> <span class="n">fst_trn_tx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rpllmt</span> <span class="o">=</span> <span class="n">rpl_tmr</span><span class="p">[</span><span class="n">log2_width</span><span class="p">][</span><span class="n">pldsize</span><span class="p">]</span> <span class="o">+</span> <span class="n">fst_trn_rx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_PEX_CTRL1</span><span class="p">,</span>
				 <span class="n">V_T3A_ACKLAT</span><span class="p">(</span><span class="n">M_T3A_ACKLAT</span><span class="p">),</span>
				 <span class="n">V_T3A_ACKLAT</span><span class="p">(</span><span class="n">acklat</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_PEX_CTRL1</span><span class="p">,</span> <span class="n">V_ACKLAT</span><span class="p">(</span><span class="n">M_ACKLAT</span><span class="p">),</span>
				 <span class="n">V_ACKLAT</span><span class="p">(</span><span class="n">acklat</span><span class="p">));</span>

	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_PEX_CTRL0</span><span class="p">,</span> <span class="n">V_REPLAYLMT</span><span class="p">(</span><span class="n">M_REPLAYLMT</span><span class="p">),</span>
			 <span class="n">V_REPLAYLMT</span><span class="p">(</span><span class="n">rpllmt</span><span class="p">));</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_PEX_ERR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_PCIE_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">F_ENABLELINKDWNDRST</span> <span class="o">|</span> <span class="n">F_ENABLELINKDOWNRST</span> <span class="o">|</span>
			 <span class="n">F_PCIE_DMASTOPEN</span> <span class="o">|</span> <span class="n">F_PCIE_CLIDECEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize and configure T3 HW modules.  This performs the</span>
<span class="cm"> * initialization steps that need to be done once after a card is reset.</span>
<span class="cm"> * MAC and PHY initialization is handled separarely whenever a port is enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * fw_params are passed to FW and their value is platform dependent.  Only the</span>
<span class="cm"> * top 8 bits are available for use, the rest must be 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="n">attempts</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vpd_params</span> <span class="o">*</span><span class="n">vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">calibrate_xgm_t3b</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">calibrate_xgm</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">partition_mem</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mc7_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmrx</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">mem_timing</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mc7_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmtx</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">mem_timing</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mc7_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cm</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">mem_timing</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">t3_mc5_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc5</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nservers</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nfilters</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nroutes</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clear_sge_ctxt</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">F_CQ</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">t3_tp_set_coalescing_size</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				  <span class="n">min</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">max_pkt_size</span><span class="p">,</span>
				      <span class="n">MAX_RX_COALESCING_LEN</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">t3_tp_set_max_rxsize</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			     <span class="n">min</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">max_pkt_size</span><span class="p">,</span> <span class="mi">16384U</span><span class="p">));</span>
	<span class="n">ulp_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pcie</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">config_pcie</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIX_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">F_DMASTOPEN</span> <span class="o">|</span> <span class="n">F_CLIDECEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="n">T3_REV_C</span><span class="p">)</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ULPTX_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">F_CFG_CQE_SOP_MASK</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PM1_RX_CFG</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PM1_RX_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PM1_TX_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chan_init_hw</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">chan_map</span><span class="p">);</span>
	<span class="n">t3_sge_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">);</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_RST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F_FATALPERREN</span><span class="p">);</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_T3DBG_GPIO_ACT_LOW</span><span class="p">,</span> <span class="n">calc_gpio_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">));</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CIM_HOST_ACC_DATA</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">uclk</span> <span class="o">|</span> <span class="n">fw_params</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CIM_BOOT_CFG</span><span class="p">,</span>
		     <span class="n">V_BOOTADDR</span><span class="p">(</span><span class="n">FW_FLASH_BOOT_ADDR</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CIM_BOOT_CFG</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="n">attempts</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>			<span class="cm">/* wait for uP to initialize */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_CIM_HOST_ACC_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">attempts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attempts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CH_ERR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;uP initialization timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	get_pci_mode - determine a card&#39;s PCI mode</span>
<span class="cm"> *	@adapter: the adapter</span>
<span class="cm"> *	@p: where to store the PCI settings</span>
<span class="cm"> *</span>
<span class="cm"> *	Determines a card&#39;s PCI mode and associated parameters, such as speed</span>
<span class="cm"> *	and width.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_pci_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">speed_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">133</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">pci_mode</span><span class="p">,</span> <span class="n">pcie_cap</span><span class="p">;</span>

	<span class="n">pcie_cap</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="n">PCI_VARIANT_PCIE</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKSTA</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_mode</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PCIX_MODE</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed_map</span><span class="p">[</span><span class="n">G_PCLKRANGE</span><span class="p">(</span><span class="n">pci_mode</span><span class="p">)];</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_mode</span> <span class="o">&amp;</span> <span class="n">F_64BIT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">pci_mode</span> <span class="o">=</span> <span class="n">G_PCIXINITPAT</span><span class="p">(</span><span class="n">pci_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="n">PCI_VARIANT_PCI</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_mode</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="n">PCI_VARIANT_PCIX_MODE1_PARITY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_mode</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="n">PCI_VARIANT_PCIX_MODE1_ECC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="n">PCI_VARIANT_PCIX_266_MODE2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	init_link_config - initialize a link&#39;s SW state</span>
<span class="cm"> *	@lc: structure holding the link state</span>
<span class="cm"> *	@ai: information about the current card</span>
<span class="cm"> *</span>
<span class="cm"> *	Initializes the SW state maintained for each link, including the link&#39;s</span>
<span class="cm"> *	capabilities and default speed/duplex/flow-control/autonegotiation</span>
<span class="cm"> *	settings.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_link_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">caps</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_duplex</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">PAUSE_RX</span> <span class="o">|</span> <span class="n">PAUSE_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">|=</span> <span class="n">PAUSE_AUTONEG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mc7_calc_size - calculate MC7 memory size</span>
<span class="cm"> *	@cfg: the MC7 configuration</span>
<span class="cm"> *</span>
<span class="cm"> *	Calculates the size of an MC7 memory in bytes from the value of its</span>
<span class="cm"> *	configuration register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mc7_calc_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">G_WIDTH</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">banks</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">F_BKS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">org</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">F_ORG</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">density</span> <span class="o">=</span> <span class="n">G_DEN</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MBs</span> <span class="o">=</span> <span class="p">((</span><span class="mi">256</span> <span class="o">&lt;&lt;</span> <span class="n">density</span><span class="p">)</span> <span class="o">*</span> <span class="n">banks</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">org</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">MBs</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mc7_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mc7</span> <span class="o">*</span><span class="n">mc7</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base_addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">base_addr</span> <span class="o">-</span> <span class="n">MC7_PMRX_BASE_ADDR</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mc7</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">A_MC7_CFG</span><span class="p">);</span>
	<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">G_DEN</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="n">M_DEN</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mc7_calc_size</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="n">mc7</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">G_WIDTH</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">devid</span><span class="p">;</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">xauicfg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">XGMAC0_1_BASE_ADDR</span> <span class="o">-</span> <span class="n">XGMAC0_0_BASE_ADDR</span><span class="p">)</span> <span class="o">*</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">nucast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_SERDES_CTRL</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			     <span class="n">is_10G</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2901c04</span> <span class="o">:</span> <span class="mh">0x2301c04</span><span class="p">);</span>
		<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_PORT_CFG</span> <span class="o">+</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				 <span class="n">F_ENRGMII</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">early_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">adapter_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">V_PORTSPEED</span><span class="p">(</span><span class="n">is_10G</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">mi1_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ai</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_I2C_CFG</span><span class="p">,</span>	<span class="cm">/* set for 80KHz */</span>
		     <span class="n">V_I2C_CLKDIV</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">cclk</span> <span class="o">/</span> <span class="mi">80</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_T3DBG_GPIO_EN</span><span class="p">,</span>
		     <span class="n">ai</span><span class="o">-&gt;</span><span class="n">gpio_out</span> <span class="o">|</span> <span class="n">F_GPIO0_OEN</span> <span class="o">|</span> <span class="n">F_GPIO0_OUT_VAL</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_MC5_DB_SERVER_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_SG_OCO_BASE</span><span class="p">,</span> <span class="n">V_BASE1</span><span class="p">(</span><span class="mh">0xfff</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">uses_xaui</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">F_ENRGMII</span><span class="p">;</span>

	<span class="cm">/* Enable MAC clocks so we can access the registers */</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_PORT_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_PORT_CFG</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">F_CLKDIVRESET_</span><span class="p">;</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_PORT_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_PORT_CFG</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">XGM_REG</span><span class="p">(</span><span class="n">A_XGM_PORT_CFG</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_XGM_PORT_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the adapter.</span>
<span class="cm"> * Older PCIe cards lose their config space during reset, PCI-X</span>
<span class="cm"> * ones don&#39;t.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">save_and_restore_pcie</span> <span class="o">=</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="n">T3_REV_B2</span> <span class="o">&amp;&amp;</span> <span class="n">is_pcie</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">devid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">save_and_restore_pcie</span><span class="p">)</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_RST</span><span class="p">,</span> <span class="n">F_CRSTWRM</span> <span class="o">|</span> <span class="n">F_CRSTWRMMODE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Delay. Give Some time to device to reset fully.</span>
<span class="cm">	 * XXX The delay time should be modified.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="mh">0x1425</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">!=</span> <span class="mh">0x1425</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">save_and_restore_pcie</span><span class="p">)</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_parity</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_SG_CONTEXT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_CONTEXT_CMD_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">clear_sge_ctxt</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">F_EGRESS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">;</span> <span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">clear_sge_ctxt</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">F_EGRESS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SGE_QSETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">clear_sge_ctxt</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">F_RESPONSEQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_IBQ_DBG_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">M_IBQDBGADDR</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t3_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_IBQ_DBG_CFG</span><span class="p">,</span> <span class="n">F_IBQDBGEN</span> <span class="o">|</span>
				     <span class="n">F_IBQDBGWR</span> <span class="o">|</span> <span class="n">V_IBQDBGQID</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">V_IBQDBGADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">t3_wait_op_done</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">A_CIM_IBQ_DBG_CFG</span><span class="p">,</span>
					      <span class="n">F_IBQDBGBUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize adapter SW state for the various HW modules, set initial values</span>
<span class="cm"> * for some adapter tunables, take PHYs out of reset, and initialize the MDIO</span>
<span class="cm"> * interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">t3_prep_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">adapter_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">get_pci_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">ai</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">nports0</span> <span class="o">+</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">nports1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">chan_map</span> <span class="o">=</span> <span class="p">(</span><span class="o">!!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">nports0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">!!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">nports1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">t3_read_reg</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_PL_REV</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We used to only run the &quot;adapter check task&quot; once a second if</span>
<span class="cm">	 * we had PHYs which didn&#39;t support interrupts (we would check</span>
<span class="cm">	 * their link status once a second).  Now we check other conditions</span>
<span class="cm">	 * in that routine which could potentially impose a very high</span>
<span class="cm">	 * interrupt load on the system.  As such, we now always scan the</span>
<span class="cm">	 * adapter state once a second ...</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">linkpoll_period</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stats_update_period</span> <span class="o">=</span> <span class="n">is_10G</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">MAC_STATS_ACCUM_SECS</span> <span class="o">:</span> <span class="p">(</span><span class="n">MAC_STATS_ACCUM_SECS</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">vpd_cap_addr</span> <span class="o">=</span>
	    <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_VPD</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_vpd_params</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">&amp;&amp;</span> <span class="n">t3_reset_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">t3_sge_prep</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">mclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tp_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tp</span><span class="p">;</span>

		<span class="n">mc7_prep</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmrx</span><span class="p">,</span> <span class="n">MC7_PMRX_BASE_ADDR</span><span class="p">,</span> <span class="s">&quot;PMRX&quot;</span><span class="p">);</span>
		<span class="n">mc7_prep</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmtx</span><span class="p">,</span> <span class="n">MC7_PMTX_BASE_ADDR</span><span class="p">,</span> <span class="s">&quot;PMTX&quot;</span><span class="p">);</span>
		<span class="n">mc7_prep</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cm</span><span class="p">,</span> <span class="n">MC7_CM_BASE_ADDR</span><span class="p">,</span> <span class="s">&quot;CM&quot;</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">chan_map</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pmrx_size</span> <span class="o">=</span> <span class="n">t3_mc7_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmrx</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pmtx_size</span> <span class="o">=</span> <span class="n">t3_mc7_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmtx</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">cm_size</span> <span class="o">=</span> <span class="n">t3_mc7_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cm</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pmrx_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* only 1 Rx channel */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_tx_size</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pmtx_size</span> <span class="o">/</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nchan</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_pg_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_pg_size</span> <span class="o">=</span> <span class="n">is_10G</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">:</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_num_pgs</span> <span class="o">=</span> <span class="n">pm_num_pages</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_rx_size</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_pg_size</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_num_pgs</span> <span class="o">=</span> <span class="n">pm_num_pages</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chan_tx_size</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tx_pg_size</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ntimer_qs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cm_size</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">offload</span> <span class="o">=</span> <span class="n">t3_mc7_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmrx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				  <span class="n">t3_mc7_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pmtx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				  <span class="n">t3_mc7_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_offload</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nservers</span> <span class="o">=</span> <span class="n">DEFAULT_NSERVERS</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nfilters</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span>
		    <span class="n">DEFAULT_NFILTERS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc5</span><span class="p">.</span><span class="n">nroutes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">t3_mc5_prep</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc5</span><span class="p">,</span> <span class="n">MC5_MODE_144_BIT</span><span class="p">);</span>

		<span class="n">init_mtus</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mtus</span><span class="p">);</span>
		<span class="n">init_cong_ctrl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">a_wnd</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">b_wnd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">early_hw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ai</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_parity</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">hw_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">port_type_info</span> <span class="o">*</span><span class="n">pti</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="o">++</span><span class="n">j</span><span class="p">])</span>
			<span class="p">;</span>

		<span class="n">pti</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_types</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pti</span><span class="o">-&gt;</span><span class="n">phy_prep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CH_ALERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;Invalid port type index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pti</span><span class="o">-&gt;</span><span class="n">phy_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">phy_base_addr</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
				    <span class="n">ai</span><span class="o">-&gt;</span><span class="n">mdio_ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">mac_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The VPD EEPROM stores the base Ethernet address for the</span>
<span class="cm">		 * card.  A port&#39;s address is derived from the base by adding</span>
<span class="cm">		 * the port&#39;s index to the base&#39;s low octet.</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">eth_base</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">hw_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">eth_base</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">hw_addr</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">hw_addr</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">init_link_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">caps</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">power_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the PHY doesn&#39;t support interrupts for link status</span>
<span class="cm">		 * changes, schedule a scan of the adapter links at least</span>
<span class="cm">		 * once a second.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_IRQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">linkpoll_period</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">linkpoll_period</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t3_led_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t3_set_reg_field</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_T3DBG_GPIO_EN</span><span class="p">,</span> <span class="n">F_GPIO0_OUT_VAL</span><span class="p">,</span>
			 <span class="n">F_GPIO0_OUT_VAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">t3_replay_prep_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">adapter_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">early_hw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ai</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_parity</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">port_type_info</span> <span class="o">*</span><span class="n">pti</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">adap2pinfo</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="o">++</span><span class="n">j</span><span class="p">])</span>
			<span class="p">;</span>

		<span class="n">pti</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_types</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">port_type</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pti</span><span class="o">-&gt;</span><span class="n">phy_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">power_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
