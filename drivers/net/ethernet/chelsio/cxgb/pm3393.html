<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb › pm3393.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>pm3393.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * File: pm3393.c                                                            *</span>
<span class="cm"> * $Revision: 1.16 $                                                         *</span>
<span class="cm"> * $Date: 2005/05/14 00:59:32 $                                              *</span>
<span class="cm"> * Description:                                                              *</span>
<span class="cm"> *  PMC/SIERRA (pm3393) MAC-PHY functionality.                               *</span>
<span class="cm"> *  part of the Chelsio 10Gb Ethernet Driver.                                *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify      *</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as       *</span>
<span class="cm"> * published by the Free Software Foundation.                                *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along   *</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,   *</span>
<span class="cm"> * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.                 *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR IMPLIED    *</span>
<span class="cm"> * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF      *</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.                     *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * http://www.chelsio.com                                                    *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Copyright (c) 2003 - 2005 Chelsio Communications, Inc.                    *</span>
<span class="cm"> * All rights reserved.                                                      *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Maintainers: maintainers@chelsio.com                                      *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Authors: Dimitrios Michailidis   &lt;dm@chelsio.com&gt;                         *</span>
<span class="cm"> *          Tina Yang               &lt;tainay@chelsio.com&gt;                     *</span>
<span class="cm"> *          Felix Marti             &lt;felix@chelsio.com&gt;                      *</span>
<span class="cm"> *          Scott Bardone           &lt;sbardone@chelsio.com&gt;                   *</span>
<span class="cm"> *          Kurt Ottaway            &lt;kottaway@chelsio.com&gt;                   *</span>
<span class="cm"> *          Frank DiMambro          &lt;frank@chelsio.com&gt;                      *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * History:                                                                  *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;regs.h&quot;</span>
<span class="cp">#include &quot;gmac.h&quot;</span>
<span class="cp">#include &quot;elmer0.h&quot;</span>
<span class="cp">#include &quot;suni1x10gexp_regs.h&quot;</span>

<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define OFFSET(REG_ADDR)    ((REG_ADDR) &lt;&lt; 2)</span>

<span class="cm">/* Max frame size PM3393 can handle. Includes Ethernet header and CRC. */</span>
<span class="cp">#define MAX_FRAME_SIZE  9600</span>

<span class="cp">#define IPG 12</span>
<span class="cp">#define TXXG_CONF1_VAL ((IPG &lt;&lt; SUNI1x10GEXP_BITOFF_TXXG_IPGT) | \</span>
<span class="cp">	SUNI1x10GEXP_BITMSK_TXXG_32BIT_ALIGN | SUNI1x10GEXP_BITMSK_TXXG_CRCEN | \</span>
<span class="cp">	SUNI1x10GEXP_BITMSK_TXXG_PADEN)</span>
<span class="cp">#define RXXG_CONF1_VAL (SUNI1x10GEXP_BITMSK_RXXG_PUREP | 0x14 | \</span>
<span class="cp">	SUNI1x10GEXP_BITMSK_RXXG_FLCHK | SUNI1x10GEXP_BITMSK_RXXG_CRC_STRIP)</span>

<span class="cm">/* Update statistics every 15 minutes */</span>
<span class="cp">#define STATS_TICK_SECS (15 * 60)</span>

<span class="k">enum</span> <span class="p">{</span>                     <span class="cm">/* RMON registers */</span>
	<span class="n">RxOctetsReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_1_LOW</span><span class="p">,</span>
	<span class="n">RxUnicastFramesReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_4_LOW</span><span class="p">,</span>
	<span class="n">RxMulticastFramesReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_5_LOW</span><span class="p">,</span>
	<span class="n">RxBroadcastFramesReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_6_LOW</span><span class="p">,</span>
	<span class="n">RxPAUSEMACCtrlFramesReceived</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_8_LOW</span><span class="p">,</span>
	<span class="n">RxFrameCheckSequenceErrors</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_10_LOW</span><span class="p">,</span>
	<span class="n">RxFramesLostDueToInternalMACErrors</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_11_LOW</span><span class="p">,</span>
	<span class="n">RxSymbolErrors</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_12_LOW</span><span class="p">,</span>
	<span class="n">RxInRangeLengthErrors</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_13_LOW</span><span class="p">,</span>
	<span class="n">RxFramesTooLongErrors</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_15_LOW</span><span class="p">,</span>
	<span class="n">RxJabbers</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_16_LOW</span><span class="p">,</span>
	<span class="n">RxFragments</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_17_LOW</span><span class="p">,</span>
	<span class="n">RxUndersizedFrames</span> <span class="o">=</span>  <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_18_LOW</span><span class="p">,</span>
	<span class="n">RxJumboFramesReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_25_LOW</span><span class="p">,</span>
	<span class="n">RxJumboOctetsReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_26_LOW</span><span class="p">,</span>

	<span class="n">TxOctetsTransmittedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_33_LOW</span><span class="p">,</span>
	<span class="n">TxFramesLostDueToInternalMACTransmissionError</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_35_LOW</span><span class="p">,</span>
	<span class="n">TxTransmitSystemError</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_36_LOW</span><span class="p">,</span>
	<span class="n">TxUnicastFramesTransmittedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_38_LOW</span><span class="p">,</span>
	<span class="n">TxMulticastFramesTransmittedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_40_LOW</span><span class="p">,</span>
	<span class="n">TxBroadcastFramesTransmittedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_42_LOW</span><span class="p">,</span>
	<span class="n">TxPAUSEMACCtrlFramesTransmitted</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_43_LOW</span><span class="p">,</span>
	<span class="n">TxJumboFramesReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_51_LOW</span><span class="p">,</span>
	<span class="n">TxJumboOctetsReceivedOK</span> <span class="o">=</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_52_LOW</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">_cmac_instance</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmread</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">data32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t1_tpi_read</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">data32</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">data32</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Port reset. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable interrupts for the PM3393</span>
<span class="cm"> *</span>
<span class="cm"> *	1. Enable PM3393 BLOCK interrupts.</span>
<span class="cm"> *	2. Enable PM3393 Master Interrupt bit(INTE)</span>
<span class="cm"> *	3. Enable ELMER&#39;s PM3393 bit.</span>
<span class="cm"> *	4. Enable Terminator external interrupt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pl_intr</span><span class="p">;</span>

	<span class="cm">/* PM3393 - Enabling all hardware block interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XRF_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXOAM_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t interrupt on statistics overflow, we are polling */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4ODP_INTERRUPT_MASK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XTEF_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXOAM_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_CONFIG_3</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_MASK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_CONFIG_3</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4IDU_INTERRUPT_MASK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_ENABLE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* PM3393 - Global interrupt enable</span>
<span class="cm">	 */</span>
	<span class="cm">/* TBD XXX Disable for now until we figure out why error interrupts keep asserting. */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_GLOBAL_INTERRUPT_ENABLE</span><span class="p">,</span>
		<span class="mi">0</span> <span class="cm">/*SUNI1x10GEXP_BITMSK_TOP_INTE */</span> <span class="p">);</span>

	<span class="cm">/* TERMINATOR - PL_INTERUPTS_EXT */</span>
	<span class="n">pl_intr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">A_PL_ENABLE</span><span class="p">);</span>
	<span class="n">pl_intr</span> <span class="o">|=</span> <span class="n">F_PL_INTR_EXT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pl_intr</span><span class="p">,</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">A_PL_ENABLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_interrupt_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">elmer</span><span class="p">;</span>

	<span class="cm">/* PM3393 - Enabling HW interrupt blocks. */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XRF_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXOAM_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4ODP_INTERRUPT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XTEF_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXOAM_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_CONFIG_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_CONFIG_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4IDU_INTERRUPT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* PM3393 - Global interrupt enable */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_GLOBAL_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* ELMER - External chip interrupts. */</span>
	<span class="n">t1_tpi_read</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_INT_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elmer</span><span class="p">);</span>
	<span class="n">elmer</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ELMER0_GP_BIT1</span><span class="p">;</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_INT_ENABLE</span><span class="p">,</span> <span class="n">elmer</span><span class="p">);</span>

	<span class="cm">/* TERMINATOR - PL_INTERUPTS_EXT */</span>
	<span class="cm">/* DO NOT DISABLE TERMINATOR&#39;s EXTERNAL INTERRUPTS. ANOTHER CHIP</span>
<span class="cm">	 * COULD WANT THEM ENABLED. We disable PM3393 at the ELMER level.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_interrupt_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">elmer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pl_intr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>

	<span class="cm">/* PM3393 - Clearing HW interrupt blocks. Note, this assumes</span>
<span class="cm">	 *          bit WCIMODE=0 for a clear-on-read.</span>
<span class="cm">	 */</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XRF_INTERRUPT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXOAM_INTERRUPT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4ODP_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_XTEF_INTERRUPT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXOAM_INTERRUPT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4IDU_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_INDICATION</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>

	<span class="cm">/* PM3393 - Global interrupt status</span>
<span class="cm">	 */</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MASTER_INTERRUPT_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>

	<span class="cm">/* ELMER - External chip interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">t1_tpi_read</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_INT_CAUSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elmer</span><span class="p">);</span>
	<span class="n">elmer</span> <span class="o">|=</span> <span class="n">ELMER0_GP_BIT1</span><span class="p">;</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_INT_CAUSE</span><span class="p">,</span> <span class="n">elmer</span><span class="p">);</span>

	<span class="cm">/* TERMINATOR - PL_INTERUPTS_EXT</span>
<span class="cm">	 */</span>
	<span class="n">pl_intr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">A_PL_CAUSE</span><span class="p">);</span>
	<span class="n">pl_intr</span> <span class="o">|=</span> <span class="n">F_PL_INTR_EXT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pl_intr</span><span class="p">,</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">A_PL_CAUSE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_interrupt_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">master_intr_status</span><span class="p">;</span>

	<span class="cm">/* Read the master interrupt status register. */</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MASTER_INTERRUPT_STATUS</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">master_intr_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PM3393 intr cause 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_intr_status</span><span class="p">);</span>

	<span class="cm">/* TBD XXX Lets just clear everything for now */</span>
	<span class="n">pm3393_interrupt_clear</span><span class="p">(</span><span class="n">cmac</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">)</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_CONFIG_1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">RXXG_CONF1_VAL</span> <span class="o">|</span> <span class="n">SUNI1x10GEXP_BITMSK_RXXG_RXEN</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">TXXG_CONF1_VAL</span> <span class="o">|</span> <span class="n">SUNI1x10GEXP_BITMSK_TXXG_TXEN0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_RX</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">SUNI1x10GEXP_BITMSK_TXXG_FCRX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_TX</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">SUNI1x10GEXP_BITMSK_TXXG_FCTX</span><span class="p">;</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_CONFIG_1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">|=</span> <span class="n">which</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_enable_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Clear port statistics */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_CONTROL</span><span class="p">,</span>
		<span class="n">SUNI1x10GEXP_BITMSK_MSTAT_CLEAR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac_statistics</span><span class="p">));</span>

	<span class="n">pm3393_enable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX This should be done by the PHY and preferably not at all.</span>
<span class="cm">	 * The PHY doesn&#39;t give us link status indication on its own so have</span>
<span class="cm">	 * the link management code query it instead.</span>
<span class="cm">	 */</span>
	<span class="n">t1_link_changed</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">)</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_CONFIG_1</span><span class="p">,</span> <span class="n">RXXG_CONF1_VAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">)</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_CONFIG_1</span><span class="p">,</span> <span class="n">TXXG_CONF1_VAL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The disable is graceful. Give the PM3393 time.  Can&#39;t wait very</span>
<span class="cm">	 * long here, we may be holding locks.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">which</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_loopback_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_loopback_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_set_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">;</span>

	<span class="cm">/* MAX_FRAME_SIZE includes header + FCS, mtu doesn&#39;t */</span>
	<span class="n">mtu</span> <span class="o">+=</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">MAX_FRAME_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Disable Rx/Tx MAC before configuring it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pm3393_disable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_RX</span> <span class="o">|</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">);</span>

	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MAX_FRAME_LENGTH</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_MAX_FRAME_SIZE</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pm3393_enable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">t1_rx_mode</span> <span class="o">*</span><span class="n">rm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_mode</span><span class="p">;</span>

	<span class="cm">/* Disable MAC RX before reconfiguring it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pm3393_disable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">);</span>

	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_mode</span><span class="p">);</span>
	<span class="n">rx_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SUNI1x10GEXP_BITMSK_RXXG_PMODE</span> <span class="o">|</span>
		     <span class="n">SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">rx_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t1_rx_mode_promisc</span><span class="p">(</span><span class="n">rm</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Promiscuous mode. */</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">SUNI1x10GEXP_BITMSK_RXXG_PMODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t1_rx_mode_allmulti</span><span class="p">(</span><span class="n">rm</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Accept all multicast. */</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_LOW</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDLOW</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDHIGH</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_HIGH</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t1_rx_mode_mc_cnt</span><span class="p">(</span><span class="n">rm</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Accept one or more multicast(s). */</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">t1_get_netdev</span><span class="p">(</span><span class="n">rm</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* bit[23:28] */</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">mc_filter</span><span class="p">[</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_LOW</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDLOW</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDHIGH</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_HIGH</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">rx_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pm3393_enable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_get_speed_duplex_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="o">*</span><span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span><span class="p">)</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="p">)</span>
		<span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_set_speed_duplex_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PAUSE_TX</span> <span class="o">|</span> <span class="n">PAUSE_RX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">!=</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">fc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">)</span>
			<span class="n">pm3393_enable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RMON_UPDATE(mac, name, stat_name) \</span>
<span class="cp">{ \</span>
<span class="cp">	t1_tpi_read((mac)-&gt;adapter, OFFSET(name), &amp;val0);     \</span>
<span class="cp">	t1_tpi_read((mac)-&gt;adapter, OFFSET((name)+1), &amp;val1); \</span>
<span class="cp">	t1_tpi_read((mac)-&gt;adapter, OFFSET((name)+2), &amp;val2); \</span>
<span class="cp">	(mac)-&gt;stats.stat_name = (u64)(val0 &amp; 0xffff) | \</span>
<span class="cp">				 ((u64)(val1 &amp; 0xffff) &lt;&lt; 16) | \</span>
<span class="cp">				 ((u64)(val2 &amp; 0xff) &lt;&lt; 32) | \</span>
<span class="cp">				 ((mac)-&gt;stats.stat_name &amp; \</span>
<span class="cp">					0xffffff0000000000ULL); \</span>
<span class="cp">	if (ro &amp; \</span>
<span class="cp">	    (1ULL &lt;&lt; ((name - SUNI1x10GEXP_REG_MSTAT_COUNTER_0_LOW) &gt;&gt; 2))) \</span>
<span class="cp">		(mac)-&gt;stats.stat_name += 1ULL &lt;&lt; 40; \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cmac_statistics</span> <span class="o">*</span><span class="nf">pm3393_update_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
							      <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span>	<span class="n">ro</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">val0</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">;</span>

	<span class="cm">/* Snap the counters */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_CONTROL</span><span class="p">,</span>
		<span class="n">SUNI1x10GEXP_BITMSK_MSTAT_SNAP</span><span class="p">);</span>

	<span class="cm">/* Counter rollover, clear on read */</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val0</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val3</span><span class="p">);</span>
	<span class="n">ro</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">val0</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">val3</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>

	<span class="cm">/* Rx stats */</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxOctetsReceivedOK</span><span class="p">,</span> <span class="n">RxOctetsOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxUnicastFramesReceivedOK</span><span class="p">,</span> <span class="n">RxUnicastFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxMulticastFramesReceivedOK</span><span class="p">,</span> <span class="n">RxMulticastFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxBroadcastFramesReceivedOK</span><span class="p">,</span> <span class="n">RxBroadcastFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxPAUSEMACCtrlFramesReceived</span><span class="p">,</span> <span class="n">RxPauseFrames</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxFrameCheckSequenceErrors</span><span class="p">,</span> <span class="n">RxFCSErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxFramesLostDueToInternalMACErrors</span><span class="p">,</span>
				<span class="n">RxInternalMACRcvError</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxSymbolErrors</span><span class="p">,</span> <span class="n">RxSymbolErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxInRangeLengthErrors</span><span class="p">,</span> <span class="n">RxInRangeLengthErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxFramesTooLongErrors</span> <span class="p">,</span> <span class="n">RxFrameTooLongErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxJabbers</span><span class="p">,</span> <span class="n">RxJabberErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxFragments</span><span class="p">,</span> <span class="n">RxRuntErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxUndersizedFrames</span><span class="p">,</span> <span class="n">RxRuntErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxJumboFramesReceivedOK</span><span class="p">,</span> <span class="n">RxJumboFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">RxJumboOctetsReceivedOK</span><span class="p">,</span> <span class="n">RxJumboOctetsOK</span><span class="p">);</span>

	<span class="cm">/* Tx stats */</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxOctetsTransmittedOK</span><span class="p">,</span> <span class="n">TxOctetsOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxFramesLostDueToInternalMACTransmissionError</span><span class="p">,</span>
				<span class="n">TxInternalMACXmitError</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxTransmitSystemError</span><span class="p">,</span> <span class="n">TxFCSErrors</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxUnicastFramesTransmittedOK</span><span class="p">,</span> <span class="n">TxUnicastFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxMulticastFramesTransmittedOK</span><span class="p">,</span> <span class="n">TxMulticastFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxBroadcastFramesTransmittedOK</span><span class="p">,</span> <span class="n">TxBroadcastFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxPAUSEMACCtrlFramesTransmitted</span><span class="p">,</span> <span class="n">TxPauseFrames</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxJumboFramesReceivedOK</span><span class="p">,</span> <span class="n">TxJumboFramesOK</span><span class="p">);</span>
	<span class="n">RMON_UPDATE</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">TxJumboOctetsReceivedOK</span><span class="p">,</span> <span class="n">TxJumboOctetsOK</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_macaddress_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_macaddress_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ma</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * MAC addr: 00:07:43:00:13:09</span>
<span class="cm">	 *</span>
<span class="cm">	 * ma[5] = 0x09</span>
<span class="cm">	 * ma[4] = 0x13</span>
<span class="cm">	 * ma[3] = 0x00</span>
<span class="cm">	 * ma[2] = 0x43</span>
<span class="cm">	 * ma[1] = 0x07</span>
<span class="cm">	 * ma[0] = 0x00</span>
<span class="cm">	 *</span>
<span class="cm">	 * The PM3393 requires byte swapping and reverse order entry</span>
<span class="cm">	 * when programming MAC addresses:</span>
<span class="cm">	 *</span>
<span class="cm">	 * low_bits[15:0]    = ma[1]:ma[0]</span>
<span class="cm">	 * mid_bits[31:16]   = ma[3]:ma[2]</span>
<span class="cm">	 * high_bits[47:32]  = ma[5]:ma[4]</span>
<span class="cm">	 */</span>

	<span class="cm">/* Store local copy */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">lo</span>  <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">ma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mid</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">ma</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">hi</span>  <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">ma</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ma</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Disable Rx/Tx MAC before configuring it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pm3393_disable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_RX</span> <span class="o">|</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">);</span>

	<span class="cm">/* Set RXXG Station Address */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_SA_15_0</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_SA_31_16</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_SA_47_32</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>

	<span class="cm">/* Set TXXG Station Address */</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_SA_15_0</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_SA_31_16</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_TXXG_SA_47_32</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>

	<span class="cm">/* Setup Exact Match Filter 1 with our MAC address</span>
<span class="cm">	 *</span>
<span class="cm">	 * Must disable exact match filter before configuring it.</span>
<span class="cm">	 */</span>
	<span class="n">pmread</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xff0f</span><span class="p">;</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_LOW</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_MID</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_HIGH</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x0090</span><span class="p">;</span>
	<span class="n">pmwrite</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pm3393_enable</span><span class="p">(</span><span class="n">cmac</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3393_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cmac_ops</span> <span class="n">pm3393_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span>                 <span class="o">=</span> <span class="n">pm3393_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>                   <span class="o">=</span> <span class="n">pm3393_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_enable</span>        <span class="o">=</span> <span class="n">pm3393_interrupt_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_disable</span>       <span class="o">=</span> <span class="n">pm3393_interrupt_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_clear</span>         <span class="o">=</span> <span class="n">pm3393_interrupt_clear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_handler</span>       <span class="o">=</span> <span class="n">pm3393_interrupt_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>                  <span class="o">=</span> <span class="n">pm3393_enable_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>                 <span class="o">=</span> <span class="n">pm3393_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">loopback_enable</span>         <span class="o">=</span> <span class="n">pm3393_loopback_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">loopback_disable</span>        <span class="o">=</span> <span class="n">pm3393_loopback_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mtu</span>                 <span class="o">=</span> <span class="n">pm3393_set_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rx_mode</span>             <span class="o">=</span> <span class="n">pm3393_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_speed_duplex_fc</span>     <span class="o">=</span> <span class="n">pm3393_get_speed_duplex_fc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed_duplex_fc</span>     <span class="o">=</span> <span class="n">pm3393_set_speed_duplex_fc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statistics_update</span>       <span class="o">=</span> <span class="n">pm3393_update_statistics</span><span class="p">,</span>
	<span class="p">.</span><span class="n">macaddress_get</span>          <span class="o">=</span> <span class="n">pm3393_macaddress_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">macaddress_set</span>          <span class="o">=</span> <span class="n">pm3393_macaddress_set</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="nf">pm3393_mac_create</span><span class="p">(</span><span class="n">adapter_t</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">cmac</span><span class="p">;</span>

	<span class="n">cmac</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmac</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmac_instance</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmac</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmac</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm3393_ops</span><span class="p">;</span>
	<span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmac_instance</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmac</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cmac</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">cmac</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">PAUSE_TX</span> <span class="o">|</span> <span class="n">PAUSE_RX</span><span class="p">;</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span> <span class="mh">0x00008000</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2308</span><span class="p">),</span> <span class="mh">0x00009800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2305</span><span class="p">),</span> <span class="mh">0x00001001</span><span class="p">);</span>   <span class="cm">/* PL4IO Enable */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2320</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2321</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2322</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2323</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2324</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2325</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2326</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2327</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2328</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2329</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x232a</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x232b</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x232c</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x232d</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x232e</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x232f</span><span class="p">),</span> <span class="mh">0x00008800</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x230d</span><span class="p">),</span> <span class="mh">0x00009c00</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2304</span><span class="p">),</span> <span class="mh">0x00000202</span><span class="p">);</span>	<span class="cm">/* PL4IO Calendar Repetitions */</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3200</span><span class="p">),</span> <span class="mh">0x00008080</span><span class="p">);</span>	<span class="cm">/* EFLX Enable */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3210</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* EFLX Channel Deprovision */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3203</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* EFLX Low Limit */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3204</span><span class="p">),</span> <span class="mh">0x00000040</span><span class="p">);</span>	<span class="cm">/* EFLX High Limit */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3205</span><span class="p">),</span> <span class="mh">0x000002cc</span><span class="p">);</span>	<span class="cm">/* EFLX Almost Full */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3206</span><span class="p">),</span> <span class="mh">0x00000199</span><span class="p">);</span>	<span class="cm">/* EFLX Almost Empty */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3207</span><span class="p">),</span> <span class="mh">0x00000240</span><span class="p">);</span>	<span class="cm">/* EFLX Cut Through Threshold */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3202</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* EFLX Indirect Register Update */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3210</span><span class="p">),</span> <span class="mh">0x00000001</span><span class="p">);</span>	<span class="cm">/* EFLX Channel Provision */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3208</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* EFLX Undocumented */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x320a</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* EFLX Undocumented */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x320c</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* EFLX enable overflow interrupt The other bit are undocumented */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x320e</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* EFLX Undocumented */</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2200</span><span class="p">),</span> <span class="mh">0x0000c000</span><span class="p">);</span>	<span class="cm">/* IFLX Configuration - enable */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2201</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* IFLX Channel Deprovision */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x220e</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* IFLX Low Limit */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x220f</span><span class="p">),</span> <span class="mh">0x00000100</span><span class="p">);</span>	<span class="cm">/* IFLX High Limit */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2210</span><span class="p">),</span> <span class="mh">0x00000c00</span><span class="p">);</span>	<span class="cm">/* IFLX Almost Full Limit */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2211</span><span class="p">),</span> <span class="mh">0x00000599</span><span class="p">);</span>	<span class="cm">/* IFLX Almost Empty Limit */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x220d</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* IFLX Indirect Register Update */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2201</span><span class="p">),</span> <span class="mh">0x00000001</span><span class="p">);</span>	<span class="cm">/* IFLX Channel Provision */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2203</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* IFLX Undocumented */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2205</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* IFLX Undocumented */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2209</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* IFLX Enable overflow interrupt.  The other bit are undocumented */</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2241</span><span class="p">),</span> <span class="mh">0xfffffffe</span><span class="p">);</span>	<span class="cm">/* PL4MOS Undocumented */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2242</span><span class="p">),</span> <span class="mh">0x0000ffff</span><span class="p">);</span>	<span class="cm">/* PL4MOS Undocumented */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2243</span><span class="p">),</span> <span class="mh">0x00000008</span><span class="p">);</span>	<span class="cm">/* PL4MOS Starving Burst Size */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2244</span><span class="p">),</span> <span class="mh">0x00000008</span><span class="p">);</span>	<span class="cm">/* PL4MOS Hungry Burst Size */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2245</span><span class="p">),</span> <span class="mh">0x00000008</span><span class="p">);</span>	<span class="cm">/* PL4MOS Transfer Size */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2240</span><span class="p">),</span> <span class="mh">0x00000005</span><span class="p">);</span>	<span class="cm">/* PL4MOS Disable */</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2280</span><span class="p">),</span> <span class="mh">0x00002103</span><span class="p">);</span>	<span class="cm">/* PL4ODP Training Repeat and SOP rule */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2284</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* PL4ODP MAX_T setting */</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3280</span><span class="p">),</span> <span class="mh">0x00000087</span><span class="p">);</span>	<span class="cm">/* PL4IDU Enable data forward, port state machine. Set ALLOW_NON_ZERO_OLB */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3282</span><span class="p">),</span> <span class="mh">0x0000001f</span><span class="p">);</span>	<span class="cm">/* PL4IDU Enable Dip4 check error interrupts */</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x3040</span><span class="p">),</span> <span class="mh">0x0c32</span><span class="p">);</span>	<span class="cm">/* # TXXG Config */</span>
	<span class="cm">/* For T1 use timer based Mac flow control. */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x304d</span><span class="p">),</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2040</span><span class="p">),</span> <span class="mh">0x059c</span><span class="p">);</span>	<span class="cm">/* # RXXG Config */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2049</span><span class="p">),</span> <span class="mh">0x0001</span><span class="p">);</span>	<span class="cm">/* # RXXG Cut Through */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x2070</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>	<span class="cm">/* # Disable promiscuous mode */</span>

	<span class="cm">/* Setup Exact Match Filter 0 to allow broadcast packets.</span>
<span class="cm">	 */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x206e</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>	<span class="cm">/* # Disable Match Enable bit */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x204a</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>	<span class="cm">/* # low addr */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x204b</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>	<span class="cm">/* # mid addr */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x204c</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>	<span class="cm">/* # high addr */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x206e</span><span class="p">),</span> <span class="mh">0x0009</span><span class="p">);</span>	<span class="cm">/* # Enable Match Enable bit */</span>

	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x0003</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>	<span class="cm">/* # NO SOP/ PAD_EN setup */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x0100</span><span class="p">),</span> <span class="mh">0x0ff0</span><span class="p">);</span>	<span class="cm">/* # RXEQB disabled */</span>
	<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="mh">0x0101</span><span class="p">),</span> <span class="mh">0x0f0f</span><span class="p">);</span>	<span class="cm">/* # No Preemphasis */</span>

	<span class="k">return</span> <span class="n">cmac</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3393_mac_reset</span><span class="p">(</span><span class="n">adapter_t</span> <span class="o">*</span> <span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">is_pl4_reset_finished</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">is_pl4_outof_lock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">is_xaui_mabc_pll_locked</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">successful_reset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* The following steps are required to properly reset</span>
<span class="cm">	 * the PM3393. This information is provided in the</span>
<span class="cm">	 * PM3393 datasheet (Issue 2: November 2002)</span>
<span class="cm">	 * section 13.1 -- Device Reset.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The PM3393 has three types of components that are</span>
<span class="cm">	 * individually reset:</span>
<span class="cm">	 *</span>
<span class="cm">	 * DRESETB      - Digital circuitry</span>
<span class="cm">	 * PL4_ARESETB  - PL4 analog circuitry</span>
<span class="cm">	 * XAUI_ARESETB - XAUI bus analog circuitry</span>
<span class="cm">	 *</span>
<span class="cm">	 * Steps to reset PM3393 using RSTB pin:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1. Assert RSTB pin low ( write 0 )</span>
<span class="cm">	 * 2. Wait at least 1ms to initiate a complete initialization of device.</span>
<span class="cm">	 * 3. Wait until all external clocks and REFSEL are stable.</span>
<span class="cm">	 * 4. Wait minimum of 1ms. (after external clocks and REFEL are stable)</span>
<span class="cm">	 * 5. De-assert RSTB ( write 1 )</span>
<span class="cm">	 * 6. Wait until internal timers to expires after ~14ms.</span>
<span class="cm">	 *    - Allows analog clock synthesizer(PL4CSU) to stabilize to</span>
<span class="cm">	 *      selected reference frequency before allowing the digital</span>
<span class="cm">	 *      portion of the device to operate.</span>
<span class="cm">	 * 7. Wait at least 200us for XAUI interface to stabilize.</span>
<span class="cm">	 * 8. Verify the PM3393 came out of reset successfully.</span>
<span class="cm">	 *    Set successful reset flag if everything worked else try again</span>
<span class="cm">	 *    a few more times.</span>
<span class="cm">	 */</span>

	<span class="n">successful_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">successful_reset</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1 */</span>
		<span class="n">t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* 2 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* 3 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* 4 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span> <span class="cm">/*1 extra ms for safety */</span> <span class="p">);</span>

		<span class="cm">/* 5 */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* 6 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">15</span> <span class="cm">/*1 extra ms for safety */</span> <span class="p">);</span>

		<span class="cm">/* 7 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* 8 */</span>

		<span class="cm">/* Has PL4 analog block come out of reset correctly? */</span>
		<span class="n">t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">SUNI1x10GEXP_REG_DEVICE_STATUS</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">is_pl4_reset_finished</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SUNI1x10GEXP_BITMSK_TOP_EXPIRED</span><span class="p">);</span>

		<span class="cm">/* TBD XXX SUNI1x10GEXP_BITMSK_TOP_PL4_IS_DOOL gets locked later in the init sequence</span>
<span class="cm">		 *         figure out why? */</span>

		<span class="cm">/* Have all PL4 block clocks locked? */</span>
		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUNI1x10GEXP_BITMSK_TOP_PL4_ID_DOOL</span>
		     <span class="cm">/*| SUNI1x10GEXP_BITMSK_TOP_PL4_IS_DOOL */</span>  <span class="o">|</span>
		     <span class="n">SUNI1x10GEXP_BITMSK_TOP_PL4_ID_ROOL</span> <span class="o">|</span>
		     <span class="n">SUNI1x10GEXP_BITMSK_TOP_PL4_IS_ROOL</span> <span class="o">|</span>
		     <span class="n">SUNI1x10GEXP_BITMSK_TOP_PL4_OUT_ROOL</span><span class="p">);</span>
		<span class="n">is_pl4_outof_lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>

		<span class="cm">/* ??? If this fails, might be able to software reset the XAUI part</span>
<span class="cm">		 *     and try to recover... thus saving us from doing another HW reset */</span>
		<span class="cm">/* Has the XAUI MABC PLL circuitry stablized? */</span>
		<span class="n">is_xaui_mabc_pll_locked</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SUNI1x10GEXP_BITMSK_TOP_SXRA_EXPIRED</span><span class="p">);</span>

		<span class="n">successful_reset</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_pl4_reset_finished</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_pl4_outof_lock</span>
				    <span class="o">&amp;&amp;</span> <span class="n">is_xaui_mabc_pll_locked</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;PM3393 HW reset %d: pl4_reset 0x%x, val 0x%x, &quot;</span>
				<span class="s">&quot;is_pl4_outof_lock 0x%x, xaui_locked 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">is_pl4_reset_finished</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
				<span class="n">is_pl4_outof_lock</span><span class="p">,</span> <span class="n">is_xaui_mabc_pll_locked</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">successful_reset</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">gmac</span> <span class="n">t1_pm3393_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">stats_update_period</span> <span class="o">=</span> <span class="n">STATS_TICK_SECS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span>              <span class="o">=</span> <span class="n">pm3393_mac_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>               <span class="o">=</span> <span class="n">pm3393_mac_reset</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
