<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › chelsio › cxgb › cxgb2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>cxgb2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * File: cxgb2.c                                                             *</span>
<span class="cm"> * $Revision: 1.25 $                                                         *</span>
<span class="cm"> * $Date: 2005/06/22 00:43:25 $                                              *</span>
<span class="cm"> * Description:                                                              *</span>
<span class="cm"> *  Chelsio 10Gb Ethernet Driver.                                            *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify      *</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as       *</span>
<span class="cm"> * published by the Free Software Foundation.                                *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along   *</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,   *</span>
<span class="cm"> * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.                 *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR IMPLIED    *</span>
<span class="cm"> * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF      *</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.                     *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * http://www.chelsio.com                                                    *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Copyright (c) 2003 - 2005 Chelsio Communications, Inc.                    *</span>
<span class="cm"> * All rights reserved.                                                      *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Maintainers: maintainers@chelsio.com                                      *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Authors: Dimitrios Michailidis   &lt;dm@chelsio.com&gt;                         *</span>
<span class="cm"> *          Tina Yang               &lt;tainay@chelsio.com&gt;                     *</span>
<span class="cm"> *          Felix Marti             &lt;felix@chelsio.com&gt;                      *</span>
<span class="cm"> *          Scott Bardone           &lt;sbardone@chelsio.com&gt;                   *</span>
<span class="cm"> *          Kurt Ottaway            &lt;kottaway@chelsio.com&gt;                   *</span>
<span class="cm"> *          Frank DiMambro          &lt;frank@chelsio.com&gt;                      *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * History:                                                                  *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;cpl5_cmd.h&quot;</span>
<span class="cp">#include &quot;regs.h&quot;</span>
<span class="cp">#include &quot;gmac.h&quot;</span>
<span class="cp">#include &quot;cphy.h&quot;</span>
<span class="cp">#include &quot;sge.h&quot;</span>
<span class="cp">#include &quot;tp.h&quot;</span>
<span class="cp">#include &quot;espi.h&quot;</span>
<span class="cp">#include &quot;elmer0.h&quot;</span>

<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">schedule_mac_stats_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">stats_update_task</span><span class="p">,</span> <span class="n">secs</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cancel_mac_stats_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">stats_update_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_CMDQ_ENTRIES	16384</span>
<span class="cp">#define MAX_CMDQ1_ENTRIES	1024</span>
<span class="cp">#define MAX_RX_BUFFERS		16384</span>
<span class="cp">#define MAX_RX_JUMBO_BUFFERS	16384</span>
<span class="cp">#define MAX_TX_BUFFERS_HIGH	16384U</span>
<span class="cp">#define MAX_TX_BUFFERS_LOW	1536U</span>
<span class="cp">#define MAX_TX_BUFFERS		1460U</span>
<span class="cp">#define MIN_FL_ENTRIES		32</span>

<span class="cp">#define DFLT_MSG_ENABLE (NETIF_MSG_DRV | NETIF_MSG_PROBE | NETIF_MSG_LINK | \</span>
<span class="cp">			 NETIF_MSG_TIMER | NETIF_MSG_IFDOWN | NETIF_MSG_IFUP |\</span>
<span class="cp">			 NETIF_MSG_RX_ERR | NETIF_MSG_TX_ERR)</span>

<span class="cm">/*</span>
<span class="cm"> * The EEPROM is actually bigger but only the first few bytes are used so we</span>
<span class="cm"> * only report those.</span>
<span class="cm"> */</span>
<span class="cp">#define EEPROM_SIZE 32</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Chelsio Communications&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dflt_msg_enable</span> <span class="o">=</span> <span class="n">DFLT_MSG_ENABLE</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dflt_msg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dflt_msg_enable</span><span class="p">,</span> <span class="s">&quot;Chelsio T1 default message enable bitmap&quot;</span><span class="p">);</span>

<span class="cp">#define HCLOCK 0x0</span>
<span class="cp">#define LCLOCK 0x1</span>

<span class="cm">/* T1 cards powersave mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">t1_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">t1powersave</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* HW default is powersave mode. */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">t1powersave</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">t1powersave</span><span class="p">,</span> <span class="s">&quot;Enable/Disable T1 powersaving mode&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_msi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_msi</span><span class="p">,</span> <span class="s">&quot;Disable Message Signaled Interrupt (MSI)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">pci_speed</span><span class="p">[][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;33&quot;</span><span class="p">,</span> <span class="s">&quot;66&quot;</span><span class="p">,</span> <span class="s">&quot;100&quot;</span><span class="p">,</span> <span class="s">&quot;133&quot;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Setup MAC to receive the types of packets we want.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">t1_set_rxmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t1_rx_mode</span> <span class="n">rm</span><span class="p">;</span>

	<span class="n">rm</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rx_mode</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;10Mbps&quot;</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SPEED_10000</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;10Gbps&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPEED_1000</span>:  <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;1000Mbps&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPEED_100</span>:   <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;100Mbps&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: link up, %s, %s-duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t1_link_negotiated</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link_stat</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_stat</span> <span class="o">!=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_stat</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">link_report</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

		<span class="cm">/* multi-ports: inform toe */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sched_speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SPEED_1000</span>:
				<span class="n">sched_speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPEED_100</span>:
				<span class="n">sched_speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPEED_10</span>:
				<span class="n">sched_speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t1_sched_update_parms</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sched_speed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">macaddress_set</span><span class="p">)</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">macaddress_set</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">t1_set_rxmode</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">t1_link_start</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_RX</span> <span class="o">|</span> <span class="n">MAC_DIRECTION_TX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_hw_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_TSO</span><span class="p">)</span>
		<span class="n">t1_tp_set_ip_checksum_offload</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* for TSO only */</span>
	<span class="n">t1_tp_set_tcp_checksum_offload</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Things to do upon first use of a card.</span>
<span class="cm"> * This must run with the rtnl lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">t1_init_hw_modules</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="n">enable_hw_csum</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FULL_INIT_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t1_interrupts_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">has_msi</span> <span class="o">=</span> <span class="o">!</span><span class="n">disable_msi</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">t1_interrupt</span><span class="p">,</span>
			  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">has_msi</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">has_msi</span><span class="p">)</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t1_sge_start</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">);</span>
	<span class="n">t1_interrupts_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release resources when all the ports have been stopped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t1_sge_stop</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">);</span>
	<span class="n">t1_interrupts_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">has_msi</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">other_ports</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span> <span class="o">&amp;</span> <span class="n">PORT_MASK</span><span class="p">;</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">cxgb_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span><span class="p">);</span>
	<span class="n">link_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">]);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">other_ports</span> <span class="o">&amp;&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stats_update_period</span><span class="p">)</span>
		<span class="n">schedule_mac_stats_update</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stats_update_period</span><span class="p">);</span>

	<span class="n">t1_vlan_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">MAC_DIRECTION_TX</span> <span class="o">|</span> <span class="n">MAC_DIRECTION_RX</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stats_update_period</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span> <span class="o">&amp;</span> <span class="n">PORT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Stop statistics accumulation. */</span>
		<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">);</span>   <span class="cm">/* sync with update task */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">);</span>
		<span class="n">cancel_mac_stats_update</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span><span class="p">)</span>
		<span class="n">cxgb_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">t1_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">netstats</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cmac_statistics</span> <span class="o">*</span><span class="n">pstats</span><span class="p">;</span>

	<span class="cm">/* Do a full update of the MAC stats */</span>
	<span class="n">pstats</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">statistics_update</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span>
						<span class="n">MAC_STATS_UPDATE_FULL</span><span class="p">);</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxUnicastFramesOK</span> <span class="o">+</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxMulticastFramesOK</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxBroadcastFramesOK</span><span class="p">;</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxUnicastFramesOK</span> <span class="o">+</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMulticastFramesOK</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxBroadcastFramesOK</span><span class="p">;</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxOctetsOK</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxOctetsOK</span><span class="p">;</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxLateCollisions</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxLengthErrors</span> <span class="o">+</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxUnderrun</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxFramesAbortedDueToXSCollisions</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxDataErrors</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxJabberErrors</span> <span class="o">+</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxFCSErrors</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxAlignErrors</span> <span class="o">+</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxSequenceErrors</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxFrameTooLongErrors</span> <span class="o">+</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxSymbolErrors</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxRuntErrors</span><span class="p">;</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">multicast</span>  <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMulticastFramesOK</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxTotalCollisions</span><span class="p">;</span>

	<span class="cm">/* detailed rx_errors */</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxFrameTooLongErrors</span> <span class="o">+</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxJabberErrors</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span>    <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxFCSErrors</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span>  <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxAlignErrors</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* detailed tx_errors */</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span>   <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxFramesAbortedDueToXSCollisions</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span>      <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxUnderrun</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_heartbeat_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_window_errors</span>    <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">TxLateCollisions</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">stats_strings</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;TxOctetsOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxOctetsBad&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxUnicastFramesOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxMulticastFramesOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxBroadcastFramesOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPauseFrames&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFramesWithDeferredXmissions&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxLateCollisions&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxTotalCollisions&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFramesAbortedDueToXSCollisions&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxUnderrun&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxLengthErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxInternalMACXmitError&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFramesWithExcessiveDeferral&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxFCSErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxJumboFramesOk&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxJumboOctetsOk&quot;</span><span class="p">,</span>
	
	<span class="s">&quot;RxOctetsOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxOctetsBad&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxUnicastFramesOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxMulticastFramesOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBroadcastFramesOK&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPauseFrames&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFCSErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxAlignErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxSymbolErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxDataErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxSequenceErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxRuntErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxJabberErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxInternalMACRcvError&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxInRangeLengthErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxOutOfRangeLengthField&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFrameTooLongErrors&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxJumboFramesOk&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxJumboOctetsOk&quot;</span><span class="p">,</span>

	<span class="cm">/* Port stats */</span>
	<span class="s">&quot;RxCsumGood&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxCsumOffload&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxTso&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxVlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxVlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxNeedHeadroom&quot;</span><span class="p">,</span> 
	
	<span class="cm">/* Interrupt stats */</span>
	<span class="s">&quot;rx drops&quot;</span><span class="p">,</span>
	<span class="s">&quot;pure_rsps&quot;</span><span class="p">,</span>
	<span class="s">&quot;unhandled irqs&quot;</span><span class="p">,</span>
	<span class="s">&quot;respQ_empty&quot;</span><span class="p">,</span>
	<span class="s">&quot;respQ_overflow&quot;</span><span class="p">,</span>
	<span class="s">&quot;freelistQ_empty&quot;</span><span class="p">,</span>
	<span class="s">&quot;pkt_too_big&quot;</span><span class="p">,</span>
	<span class="s">&quot;pkt_mismatch&quot;</span><span class="p">,</span>
	<span class="s">&quot;cmdQ_full0&quot;</span><span class="p">,</span>
	<span class="s">&quot;cmdQ_full1&quot;</span><span class="p">,</span>

	<span class="s">&quot;espi_DIP2ParityErr&quot;</span><span class="p">,</span>
	<span class="s">&quot;espi_DIP4Err&quot;</span><span class="p">,</span>
	<span class="s">&quot;espi_RxDrops&quot;</span><span class="p">,</span>
	<span class="s">&quot;espi_TxDrops&quot;</span><span class="p">,</span>
	<span class="s">&quot;espi_RxOvfl&quot;</span><span class="p">,</span>
	<span class="s">&quot;espi_ParityErr&quot;</span>
<span class="p">};</span>

<span class="cp">#define T2_REGMAP_SIZE (3 * 1024)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">T2_REGMAP_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats_strings</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">stats_strings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats_strings</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cmac_statistics</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sge_intr_counts</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sge_port_stats</span> <span class="n">ss</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">statistics_update</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">MAC_STATS_UPDATE_FULL</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">t1_sge_get_intr_counts</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">);</span>
	<span class="n">t1_sge_get_port_stats</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">);</span>

	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxOctetsOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxOctetsBad</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxUnicastFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxMulticastFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxBroadcastFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxPauseFrames</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxFramesWithDeferredXmissions</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxLateCollisions</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxTotalCollisions</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxFramesAbortedDueToXSCollisions</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxUnderrun</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxLengthErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxInternalMACXmitError</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxFramesWithExcessiveDeferral</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxFCSErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxJumboFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">TxJumboOctetsOK</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxOctetsOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxOctetsBad</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxUnicastFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxMulticastFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxBroadcastFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxPauseFrames</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxFCSErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxAlignErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxSymbolErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxDataErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxSequenceErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxRuntErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxJabberErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxInternalMACRcvError</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxInRangeLengthErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxOutOfRangeLengthField</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxFrameTooLongErrors</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxJumboFramesOK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">RxJumboOctetsOK</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">rx_cso_good</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">tx_cso</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">tx_tso</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">vlan_xtract</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">vlan_insert</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">tx_need_hdrroom</span><span class="p">;</span>
	
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_drops</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pure_rsps</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">unhandled_irqs</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">respQ_empty</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">respQ_overflow</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">freelistQ_empty</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pkt_too_big</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pkt_mismatch</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">cmdQ_full</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">cmdQ_full</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">espi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">espi_intr_counts</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

		<span class="n">e</span> <span class="o">=</span> <span class="n">t1_espi_get_intr_counts</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">espi</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DIP2_parity_err</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DIP4_err</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_drops</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_drops</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_ovflw</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">parity_err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">reg_block_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">start</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Version scheme: bits 0..9: chip version, bits 10..15: chip revision</span>
<span class="cm">	 */</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T2_REGMAP_SIZE</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">A_SG_RESPACCUTIMER</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_MC3_CFG</span><span class="p">,</span> <span class="n">A_MC4_INT_CAUSE</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_TPI_ADDR</span><span class="p">,</span> <span class="n">A_TPI_PAR</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_TP_IN_CONFIG</span><span class="p">,</span> <span class="n">A_TP_TX_DROP_COUNT</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_RAT_ROUTE_CONTROL</span><span class="p">,</span> <span class="n">A_RAT_INTR_CAUSE</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_CSPI_RX_AE_WM</span><span class="p">,</span> <span class="n">A_CSPI_INTR_ENABLE</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_ESPI_SCH_TOKEN0</span><span class="p">,</span> <span class="n">A_ESPI_GOSTAT</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_ULP_ULIMIT</span><span class="p">,</span> <span class="n">A_ULP_PIO_CTRL</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_PL_ENABLE</span><span class="p">,</span> <span class="n">A_PL_CAUSE</span><span class="p">);</span>
	<span class="n">reg_block_dump</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">A_MC5_CONFIG</span><span class="p">,</span> <span class="n">A_MC5_MASK_WRITE_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">];</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">supported</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_TP</span><span class="p">)</span> <span class="o">?</span> <span class="n">PORT_TP</span> <span class="o">:</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">speed_duplex_to_caps</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">SUPPORTED_10baseT_Full</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">SUPPORTED_100baseT_Half</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">SUPPORTED_1000baseT_Half</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_10000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cap</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ADVERTISED_MASK (ADVERTISED_10baseT_Half | ADVERTISED_10baseT_Full | \</span>
<span class="cp">		      ADVERTISED_100baseT_Half | ADVERTISED_100baseT_Full | \</span>
<span class="cp">		      ADVERTISED_1000baseT_Half | ADVERTISED_1000baseT_Full | \</span>
<span class="cp">		      ADVERTISED_10000baseT_Full)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>             <span class="cm">/* can&#39;t change speed/duplex */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">speed_duplex_to_caps</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">cap</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_duplex</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="n">ADVERTISED_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">t1_link_start</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">lc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">];</span>

	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_AUTONEG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_RX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">PAUSE_TX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">link_config</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">=</span> <span class="n">PAUSE_AUTONEG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">|=</span> <span class="n">PAUSE_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">|=</span> <span class="n">PAUSE_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">t1_link_start</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">lc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">requested_fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAUSE_RX</span> <span class="o">|</span> <span class="n">PAUSE_TX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_speed_duplex_fc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
							 <span class="n">lc</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_sge_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jumbo_fl</span> <span class="o">=</span> <span class="n">t1_is_T1B</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_BUFFERS</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_JUMBO_BUFFERS</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">MAX_CMDQ_ENTRIES</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">freelQ_size</span><span class="p">[</span><span class="o">!</span><span class="n">jumbo_fl</span><span class="p">];</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">freelQ_size</span><span class="p">[</span><span class="n">jumbo_fl</span><span class="p">];</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">cmdQ_size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_sge_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jumbo_fl</span> <span class="o">=</span> <span class="n">t1_is_T1B</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">MAX_RX_BUFFERS</span> <span class="o">||</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">&gt;</span> <span class="n">MAX_RX_JUMBO_BUFFERS</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">MAX_CMDQ_ENTRIES</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&lt;</span> <span class="n">MIN_FL_ENTRIES</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">&lt;</span> <span class="n">MIN_FL_ENTRIES</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">freelQ_size</span><span class="p">[</span><span class="o">!</span><span class="n">jumbo_fl</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">freelQ_size</span><span class="p">[</span><span class="n">jumbo_fl</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">cmdQ_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">cmdQ_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">MAX_CMDQ1_ENTRIES</span> <span class="o">?</span>
		<span class="n">MAX_CMDQ1_ENTRIES</span> <span class="o">:</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">coalesce_enable</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">sample_interval_usecs</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rate_sample_interval</span><span class="p">;</span>
	<span class="n">t1_sge_set_coalesce_params</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">rx_coalesce_usecs</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rate_sample_interval</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">sample_interval_usecs</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">sge</span><span class="p">.</span><span class="n">coalesce_enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">t1_is_asic</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">?</span> <span class="n">EEPROM_SIZE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EEPROM_MAGIC(ap) \</span>
<span class="cp">	(PCI_VENDOR_ID_CHELSIO | ((ap)-&gt;params.chip_version &lt;&lt; 16))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">EEPROM_SIZE</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">EEPROM_MAGIC</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">t1_seeprom_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">t1_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>      <span class="o">=</span> <span class="n">get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>      <span class="o">=</span> <span class="n">set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>       <span class="o">=</span> <span class="n">get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>      <span class="o">=</span> <span class="n">get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>      <span class="o">=</span> <span class="n">set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>     <span class="o">=</span> <span class="n">get_sge_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>     <span class="o">=</span> <span class="n">set_sge_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span>      <span class="o">=</span> <span class="n">get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span>      <span class="o">=</span> <span class="n">set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>    <span class="o">=</span> <span class="n">get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>        <span class="o">=</span> <span class="n">get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span>    <span class="o">=</span> <span class="n">get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span>    <span class="o">=</span> <span class="n">set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>          <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>       <span class="o">=</span> <span class="n">get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>	   <span class="o">=</span> <span class="n">get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>      <span class="o">=</span> <span class="n">get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>          <span class="o">=</span> <span class="n">get_regs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t1_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mdio_if_info</span> <span class="o">*</span><span class="n">mdio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mdio_mii_ioctl</span><span class="p">(</span><span class="n">mdio</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t1_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mtu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mtu</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t1_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">].</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">macaddress_set</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">macaddress_set</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">t1_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since there is no support for separate rx/tx vlan accel</span>
<span class="cm">	 * enable/disable make sure tx flag is always in same state as rx.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t1_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">t1_vlan_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">t1_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">t1_interrupt</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Periodic accumulation of MAC statistics.  This is used only if the MAC</span>
<span class="cm"> * does not have any other way to prevent stats counter overflow.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_stats_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">stats_update_task</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">statistics_update</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span>
						       <span class="n">MAC_STATS_UPDATE_FAST</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Schedule the next statistics update if any port is active. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">open_device_map</span> <span class="o">&amp;</span> <span class="n">PORT_MASK</span><span class="p">)</span>
		<span class="n">schedule_mac_stats_update</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stats_update_period</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Processes elmer0 external interrupts in process context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext_intr_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">ext_intr_handler_task</span><span class="p">);</span>

	<span class="n">t1_elmer0_ext_intr_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Now reenable external interrupts */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">async_lock</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span> <span class="o">|=</span> <span class="n">F_PL_INTR_EXT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">F_PL_INTR_EXT</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">A_PL_CAUSE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span> <span class="o">|</span> <span class="n">F_PL_INTR_SGE_DATA</span><span class="p">,</span>
		   <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">A_PL_ENABLE</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">async_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt-context handler for elmer0 external interrupts.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">t1_elmer0_ext_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Schedule a task to handle external interrupts as we require</span>
<span class="cm">	 * a process context.  We disable EXT interrupts in the interim</span>
<span class="cm">	 * and let the task reenable them when it&#39;s done.</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_PL_INTR_EXT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slow_intr_mask</span> <span class="o">|</span> <span class="n">F_PL_INTR_SGE_DATA</span><span class="p">,</span>
		   <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">A_PL_ENABLE</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ext_intr_handler_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">t1_fatal_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FULL_INIT_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t1_sge_stop</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">);</span>
		<span class="n">t1_interrupts_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;%s: encountered fatal error, operation suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">cxgb_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">cxgb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">cxgb_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">t1_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">t1_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">t1_set_rxmode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">t1_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">t1_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">t1_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">t1_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">t1_set_features</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">t1_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">version_printed</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">board_info</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">version_printed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s - version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESCRIPTION</span><span class="p">,</span>
		       <span class="n">DRV_VERSION</span><span class="p">);</span>
		<span class="o">++</span><span class="n">version_printed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot find PCI device memory base address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to obtain 64-bit DMA for &quot;</span>
			       <span class="s">&quot;consistent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_disable_pdev</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no usable DMA configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot obtain PCI resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bi</span> <span class="o">=</span> <span class="n">t1_get_board_info</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">port_number</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

		<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="n">adapter</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adapter</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>  <span class="cm">/* so we don&#39;t leak it */</span>

			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot map device registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">t1_get_board_rev</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	  <span class="cm">/* Can&#39;t handle this chip rev */</span>
				<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">dflt_msg_enable</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">mmio_len</span><span class="p">;</span>

			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tpi_lock</span><span class="p">);</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">);</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">async_lock</span><span class="p">);</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_lock</span><span class="p">);</span>

			<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ext_intr_handler_task</span><span class="p">,</span>
				  <span class="n">ext_intr_task</span><span class="p">);</span>
			<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_update_task</span><span class="p">,</span>
					  <span class="n">mac_stats_task</span><span class="p">);</span>

			<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">mmio_start</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">mmio_start</span> <span class="o">+</span> <span class="n">mmio_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
			<span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
			<span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_LLTX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_using_dac</span><span class="p">)</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tso_capable</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span>
				<span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>

			<span class="cm">/* T204: disable TSO */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is_T2</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="o">||</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">port_number</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO</span><span class="p">;</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cxgb_netdev_ops</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_TSO</span><span class="p">)</span> <span class="o">?</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tx_pkt_lso</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_tx_pkt</span><span class="p">);</span>

		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">t1_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

		<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1_ethtool_ops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t1_init_sw_modules</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The card is now ready to go.  If any errors occur during device</span>
<span class="cm">	 * registration we do not fail the whole card but rather proceed only</span>
<span class="cm">	 * with the ports we manage to register successfully.  However we must</span>
<span class="cm">	 * register at least one net device.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">port_number</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: cannot register net device %s, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Change the name we use for messages to the name of</span>
<span class="cm">			 * the first successfully registered interface.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">registered_device_map</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

			<span class="n">__set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">registered_device_map</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">registered_device_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: could not register any net devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_release_adapter_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s (rev %d), %s %dMHz/%d-bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">bi</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">chip_revision</span><span class="p">,</span>
	       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">is_pcix</span> <span class="o">?</span> <span class="s">&quot;PCIX&quot;</span> <span class="o">:</span> <span class="s">&quot;PCI&quot;</span><span class="p">,</span>
	       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the T1B ASIC and memory clocks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t1powersave</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">t1powersave</span> <span class="o">=</span> <span class="n">LCLOCK</span><span class="p">;</span>	<span class="cm">/* HW default is powersave mode. */</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">t1powersave</span> <span class="o">=</span> <span class="n">HCLOCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t1_is_T1B</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">t1_clock</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">t1powersave</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_release_adapter_res:</span>
	<span class="n">t1_free_sw_modules</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">out_free_dev:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">port_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span>
				<span class="n">free_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bit_bang</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">S_CLOCK</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
		<span class="n">S_DATA</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">bitdata</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">S_DATA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_DATA</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

		<span class="cm">/* Set SCLOCK low */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_CLOCK</span><span class="p">;</span>
		<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

		<span class="cm">/* Write SCLOCK high */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">S_CLOCK</span><span class="p">;</span>
		<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t1_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">M_CORE_VAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">M_MEM_VAL</span><span class="p">;</span>

	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">M_CORE_BITS</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="n">T_CORE_VAL</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">T_CORE_BITS</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">N_CORE_VAL</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">N_CORE_BITS</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">M_MEM_BITS</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="n">T_MEM_VAL</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">T_MEM_BITS</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">N_MEM_VAL</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">N_MEM_BITS</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">NP_LOAD</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">,</span>
		<span class="n">S_LOAD_MEM</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">S_LOAD_CORE</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
		<span class="n">S_CLOCK</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t1_is_T1B</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	<span class="cm">/* Can&#39;t re-clock this chip. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* show current mode. */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">t1powersave</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>	<span class="cm">/* ASIC already running in mode. */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">HCLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">M_CORE_VAL</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
		<span class="n">M_MEM_VAL</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">t1powersave</span> <span class="o">=</span> <span class="n">HCLOCK</span><span class="p">;</span>	<span class="cm">/* overclock */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">M_CORE_VAL</span> <span class="o">=</span> <span class="mh">0xe</span><span class="p">;</span>
		<span class="n">M_MEM_VAL</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">t1powersave</span> <span class="o">=</span> <span class="n">LCLOCK</span><span class="p">;</span>	<span class="cm">/* underclock */</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t interrupt this serial stream! */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tpi_lock</span><span class="p">);</span>

	<span class="cm">/* Initialize for ASIC core */</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">NP_LOAD</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_LOAD_CORE</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_CLOCK</span><span class="p">;</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Serial program the ASIC clock synthesizer */</span>
	<span class="n">bit_bang</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">T_CORE_VAL</span><span class="p">,</span> <span class="n">T_CORE_BITS</span><span class="p">);</span>
	<span class="n">bit_bang</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">N_CORE_VAL</span><span class="p">,</span> <span class="n">N_CORE_BITS</span><span class="p">);</span>
	<span class="n">bit_bang</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">M_CORE_VAL</span><span class="p">,</span> <span class="n">M_CORE_BITS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Finish ASIC core */</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">S_LOAD_CORE</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_LOAD_CORE</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Initialize for memory */</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">NP_LOAD</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_LOAD_MEM</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_CLOCK</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Serial program the memory clock synthesizer */</span>
	<span class="n">bit_bang</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">T_MEM_VAL</span><span class="p">,</span> <span class="n">T_MEM_BITS</span><span class="p">);</span>
	<span class="n">bit_bang</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">N_MEM_VAL</span><span class="p">,</span> <span class="n">N_MEM_BITS</span><span class="p">);</span>
	<span class="n">bit_bang</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">M_MEM_VAL</span><span class="p">,</span> <span class="n">M_MEM_BITS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Finish memory */</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">S_LOAD_MEM</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_LOAD_MEM</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__t1_tpi_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">A_ELMER0_GPO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tpi_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t1_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">A_PCICFG_PM_CSR</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">A_PCICFG_PM_CSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">registered_device_map</span><span class="p">))</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">t1_free_sw_modules</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">t1_sw_reset</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">t1_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">t1_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">t1_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">t1_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">t1_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
