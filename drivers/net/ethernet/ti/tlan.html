<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › ti › tlan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tlan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  Linux ThunderLAN Driver</span>
<span class="cm"> *</span>
<span class="cm"> *  tlan.c</span>
<span class="cm"> *  by James Banks</span>
<span class="cm"> *</span>
<span class="cm"> *  (C) 1997-1998 Caldera, Inc.</span>
<span class="cm"> *  (C) 1998 James Banks</span>
<span class="cm"> *  (C) 1999-2001 Torben Mathiasen</span>
<span class="cm"> *  (C) 2002 Samuel Chessman</span>
<span class="cm"> *</span>
<span class="cm"> *  This software may be used and distributed according to the terms</span>
<span class="cm"> *  of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> ** Useful (if not required) reading:</span>
<span class="cm"> *</span>
<span class="cm"> *		Texas Instruments, ThunderLAN Programmer&#39;s Guide,</span>
<span class="cm"> *			TI Literature Number SPWU013A</span>
<span class="cm"> *			available in PDF format from www.ti.com</span>
<span class="cm"> *		Level One, LXT901 and LXT970 Data Sheets</span>
<span class="cm"> *			available in PDF format from www.level1.com</span>
<span class="cm"> *		National Semiconductor, DP83840A Data Sheet</span>
<span class="cm"> *			available in PDF format from www.national.com</span>
<span class="cm"> *		Microchip Technology, 24C01A/02A/04A Data Sheet</span>
<span class="cm"> *			available in PDF format from www.microchip.com</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/eisa.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>

<span class="cp">#include &quot;tlan.h&quot;</span>


<span class="cm">/* For removing EISA devices */</span>
<span class="k">static</span>	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">tlan_eisa_devices</span><span class="p">;</span>

<span class="k">static</span>	<span class="kt">int</span>		<span class="n">tlan_devices_installed</span><span class="p">;</span>

<span class="cm">/* Set speed, duplex and aui settings */</span>
<span class="k">static</span>  <span class="kt">int</span> <span class="n">aui</span><span class="p">[</span><span class="n">MAX_TLAN_BOARDS</span><span class="p">];</span>
<span class="k">static</span>  <span class="kt">int</span> <span class="n">duplex</span><span class="p">[</span><span class="n">MAX_TLAN_BOARDS</span><span class="p">];</span>
<span class="k">static</span>  <span class="kt">int</span> <span class="n">speed</span><span class="p">[</span><span class="n">MAX_TLAN_BOARDS</span><span class="p">];</span>
<span class="k">static</span>  <span class="kt">int</span> <span class="n">boards_found</span><span class="p">;</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">aui</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aui</span><span class="p">,</span> <span class="s">&quot;ThunderLAN use AUI port(s) (0-1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">duplex</span><span class="p">,</span>
		 <span class="s">&quot;ThunderLAN duplex setting(s) (0-default, 1-half, 2-full)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="s">&quot;ThunderLAN port speed setting(s) (0,10,100)&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Maintainer: Samuel Chessman &lt;chessman@tux.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for TI ThunderLAN based ethernet PCI adapters&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cm">/* Define this to enable Link beat monitoring */</span>
<span class="cp">#undef MONITOR</span>

<span class="cm">/* Turn on debugging. See Documentation/networking/tlan.txt for details */</span>
<span class="k">static</span>  <span class="kt">int</span>		<span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;ThunderLAN debug mask&quot;</span><span class="p">);</span>

<span class="k">static</span>	<span class="k">const</span> <span class="kt">char</span> <span class="n">tlan_signature</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;TLAN&quot;</span><span class="p">;</span>
<span class="k">static</span>  <span class="k">const</span> <span class="kt">char</span> <span class="n">tlan_banner</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ThunderLAN driver v1.17</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span>  <span class="kt">int</span> <span class="n">tlan_have_pci</span><span class="p">;</span>
<span class="k">static</span>  <span class="kt">int</span> <span class="n">tlan_have_eisa</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">media</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;10BaseT-HD&quot;</span><span class="p">,</span> <span class="s">&quot;10BaseT-FD&quot;</span><span class="p">,</span> <span class="s">&quot;100baseTx-HD&quot;</span><span class="p">,</span>
	<span class="s">&quot;100BaseTx-FD&quot;</span><span class="p">,</span> <span class="s">&quot;100BaseT4&quot;</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">board</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">device_label</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">addr_ofs</span><span class="p">;</span>
<span class="p">}</span> <span class="n">board_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Netelligent 10 T PCI UTP&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Netelligent 10/100 TX PCI UTP&quot;</span><span class="p">,</span>
	  <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Integrated NetFlex-3/P&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_NONE</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq NetFlex-3/P&quot;</span><span class="p">,</span>
	  <span class="n">TLAN_ADAPTER_UNMANAGED_PHY</span> <span class="o">|</span> <span class="n">TLAN_ADAPTER_BIT_RATE_PHY</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq NetFlex-3/P&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_NONE</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Netelligent Integrated 10/100 TX UTP&quot;</span><span class="p">,</span>
	  <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Netelligent Dual 10/100 TX PCI UTP&quot;</span><span class="p">,</span>
	  <span class="n">TLAN_ADAPTER_NONE</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Netelligent 10/100 TX Embedded UTP&quot;</span><span class="p">,</span>
	  <span class="n">TLAN_ADAPTER_NONE</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Olicom OC-2183/2185&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_USE_INTERN_10</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Olicom OC-2325&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_UNMANAGED_PHY</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Olicom OC-2326&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_USE_INTERN_10</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Netelligent 10/100 TX UTP&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq Netelligent 10 T/2 PCI UTP/coax&quot;</span><span class="p">,</span> <span class="n">TLAN_ADAPTER_NONE</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq NetFlex-3/E&quot;</span><span class="p">,</span>
	  <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span> <span class="o">|</span>	<span class="cm">/* EISA card */</span>
	  <span class="n">TLAN_ADAPTER_UNMANAGED_PHY</span> <span class="o">|</span> <span class="n">TLAN_ADAPTER_BIT_RATE_PHY</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq NetFlex-3/E&quot;</span><span class="p">,</span>
	  <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span> <span class="cm">/* EISA card */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">tlan_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_NETEL10</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_NETEL100</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_NETFLEX3I</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_THUNDER</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_NETFLEX3B</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_NETEL100PI</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_NETEL100D</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_NETEL100I</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OLICOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OLICOM_OC2183</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OLICOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OLICOM_OC2325</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OLICOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OLICOM_OC2326</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETELLIGENT_10_100_WS_5100</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETELLIGENT_10_T2</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tlan_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_eisa_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_eisa_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">tlan_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tlan_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">tlan_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">tlan_handle_interrupt</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tlan_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span>	<span class="n">net_device_stats</span> <span class="o">*</span><span class="n">tlan_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tlan_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">tlan_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_tx_timeout_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tlan_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span>	<span class="n">tlan_handle_tx_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">tlan_handle_stat_overflow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">tlan_handle_rx_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">tlan_handle_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">tlan_handle_tx_eoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">tlan_handle_status_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">tlan_handle_rx_eoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_reset_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_free_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_print_dio</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_print_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_read_and_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_finish_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">areg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_phy_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_phy_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_phy_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_phy_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_phy_start_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_phy_finish_auto_neg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef MONITOR</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">tlan_phy_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">  static int	tlan_phy_nop(struct net_device *);</span>
<span class="cm">  static int	tlan_phy_internal_check(struct net_device *);</span>
<span class="cm">  static int	tlan_phy_internal_service(struct net_device *);</span>
<span class="cm">  static int	tlan_phy_dp83840a_check(struct net_device *);</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span>	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_ee_send_start</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tlan_ee_send_byte</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tlan_ee_receive_byte</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tlan_ee_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">);</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">tlan_store_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">tag</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">tag</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">tlan_get_skb</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tlan_list</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">tag</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tag</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="p">(</span><span class="o">*</span><span class="n">tlan_int_vector</span><span class="p">[</span><span class="n">TLAN_INT_NUMBER_OF_INTS</span><span class="p">])(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="n">tlan_handle_tx_eof</span><span class="p">,</span>
	<span class="n">tlan_handle_stat_overflow</span><span class="p">,</span>
	<span class="n">tlan_handle_rx_eof</span><span class="p">,</span>
	<span class="n">tlan_handle_dummy</span><span class="p">,</span>
	<span class="n">tlan_handle_tx_eoc</span><span class="p">,</span>
	<span class="n">tlan_handle_status_check</span><span class="p">,</span>
	<span class="n">tlan_handle_rx_eoc</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">tlan_set_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_type</span> <span class="o">!=</span> <span class="n">TLAN_TIMER_ACTIVITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tlan_timer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_set_at</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ticks</span><span class="p">);</span>

<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm">******************************************************************************</span>

<span class="cm">ThunderLAN driver primary functions</span>

<span class="cm">these functions are more or less common to all linux network drivers.</span>

<span class="cm">******************************************************************************</span>
<span class="cm">*****************************************************************************/</span>





<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_remove_one</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		None</span>
<span class="cm"> *</span>
<span class="cm"> *	Goes through the TLanDevices list and frees the device</span>
<span class="cm"> *	structs and memory associated with each device (lists</span>
<span class="cm"> *	and buffers).  It also ureserves the IO port regions</span>
<span class="cm"> *	associated with this device.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">tlan_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage_dma</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tlan_reset_lists</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* NOTE: It might not be necessary to read the stats before a</span>
<span class="cm">	   reset if you don&#39;t care what the values are.</span>
<span class="cm">	*/</span>
	<span class="n">tlan_read_and_clear_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_IGNORE</span><span class="p">);</span>
	<span class="n">tlan_reset_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tlan_read_and_clear_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_RECORD</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">TLAN_HC_AD_RST</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>
	<span class="cm">/* Reset and power down phy */</span>
	<span class="n">tlan_reset_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">tlan_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">tlan_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define tlan_suspend   NULL</span>
<span class="cp">#define tlan_resume    NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tlan_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;tlan&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tlan_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tlan_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tlan_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">tlan_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">tlan_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tlan_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">tlan_banner</span><span class="p">);</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_PROBE</span><span class="p">,</span> <span class="s">&quot;Starting PCI Probe....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Use new style PCI probing. Now the kernel will</span>
<span class="cm">	   do most of this for us */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlan_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not register pci driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_pci_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_PROBE</span><span class="p">,</span> <span class="s">&quot;Starting EISA Probe....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tlan_eisa_probe</span><span class="p">();</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d device%s installed, PCI: %d  EISA: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tlan_devices_installed</span><span class="p">,</span> <span class="n">tlan_devices_installed</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;s&quot;</span><span class="p">,</span>
		<span class="n">tlan_have_pci</span><span class="p">,</span> <span class="n">tlan_have_eisa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlan_devices_installed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span>  <span class="n">err_out_pci_unreg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_pci_unreg:</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlan_driver</span><span class="p">);</span>
<span class="nl">err_out_pci_free:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tlan_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tlan_probe1</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">***************************************************************</span>
<span class="cm">*	tlan_probe1</span>
<span class="cm">*</span>
<span class="cm">*	Returns:</span>
<span class="cm">*		0 on success, error code on error</span>
<span class="cm">*	Parms:</span>
<span class="cm">*		none</span>
<span class="cm">*</span>
<span class="cm">*	The name is lower case to fit in with all the rest of</span>
<span class="cm">*	the netcard_probe names.  This function looks for</span>
<span class="cm">*	another TLan based adapter, setting it up with the</span>
<span class="cm">*	allocated device struct if one is found.</span>
<span class="cm">*	tlan_probe has been ported to the new net API and</span>
<span class="cm">*	now allocates its own device structure. This function</span>
<span class="cm">*	is also used by modules.</span>
<span class="cm">*</span>
<span class="cm">**************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tlan_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>  <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span>		   <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span>		   <span class="n">reg</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tlan_signature</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not reserve IO regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif  </span><span class="cm">/*  CONFIG_PCI  */</span><span class="cp"></span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_regions</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Is this a PCI device? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>		   <span class="n">pci_io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">board_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No suitable PCI mapping available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span>
					 <span class="s">&quot;IO mapping is available at %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">pci_io_base</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_io_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No IO mappings available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">pci_io_base</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_rev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
		<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>     <span class="cm">/* EISA card */</span>
		<span class="cm">/* This is a hack. We need to know which board structure</span>
<span class="cm">		 * is suited for this adapter */</span>
		<span class="n">device_id</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EISA_ID2</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_eisa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="mh">0x20F1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">board_info</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span> <span class="cm">/* NetFlex-3/E */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_rev</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>		<span class="cm">/* TLAN 2.3 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">board_info</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_rev</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>		<span class="cm">/* TLAN 1.0 */</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Kernel parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">aui</span>    <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span>
			<span class="o">:</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span>  <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span>
			<span class="o">:</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">TLAN_SPEED_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">TLAN_SPEED_100</span><span class="p">;</span>

		<span class="n">debug</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">aui</span>    <span class="o">=</span> <span class="n">aui</span><span class="p">[</span><span class="n">boards_found</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span>  <span class="o">=</span> <span class="n">speed</span><span class="p">[</span><span class="n">boards_found</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">duplex</span><span class="p">[</span><span class="n">boards_found</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This will be used when we get an adapter error from</span>
<span class="cm">	 * within our irq handler */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_tqueue</span><span class="p">,</span> <span class="n">tlan_tx_timeout_work</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tlan_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not set up device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not register device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_uninit</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">tlan_devices_installed</span><span class="o">++</span><span class="p">;</span>
	<span class="n">boards_found</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* pdev is NULL if this is an EISA device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">tlan_have_pci</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="n">tlan_eisa_devices</span><span class="p">;</span>
		<span class="n">tlan_eisa_devices</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">tlan_have_eisa</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq=%2d, io=%04x, %s, Rev. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">device_label</span><span class="p">,</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_rev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_uninit:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage_dma</span><span class="p">);</span>
<span class="nl">err_out_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_regions:</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">err_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_eisa_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tlan_have_eisa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">tlan_eisa_devices</span><span class="p">;</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage_dma</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tlan_eisa_devices</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tlan_have_eisa</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tlan_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlan_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlan_have_eisa</span><span class="p">)</span>
		<span class="n">tlan_eisa_cleanup</span><span class="p">();</span>

<span class="p">}</span>


<span class="cm">/* Module loading/unloading */</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">tlan_probe</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tlan_exit</span><span class="p">);</span>



<span class="cm">/**************************************************************</span>
<span class="cm"> *	tlan_eisa_probe</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns: 0 on success, 1 otherwise</span>
<span class="cm"> *</span>
<span class="cm"> *	Parms:	 None</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *	This functions probes for EISA devices and calls</span>
<span class="cm"> *	TLan_probe1 when one is found.</span>
<span class="cm"> *</span>
<span class="cm"> *************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="n">__init</span> <span class="nf">tlan_eisa_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span>	<span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">irq</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">device_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EISA_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_PROBE</span><span class="p">,</span> <span class="s">&quot;No EISA bus present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Loop through all slots of the EISA bus */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x9000</span><span class="p">;</span> <span class="n">ioaddr</span> <span class="o">+=</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_PROBE</span><span class="p">,</span> <span class="s">&quot;EISA_ID 0x%4x: 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xc80</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EISA_ID</span><span class="p">));</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_PROBE</span><span class="p">,</span> <span class="s">&quot;EISA_ID 0x%4x: 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xc82</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EISA_ID2</span><span class="p">));</span>


		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_PROBE</span><span class="p">,</span>
			 <span class="s">&quot;Probing for EISA adapter at IO: 0x%4x : &quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">tlan_signature</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EISA_ID</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x110E</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">device_id</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EISA_ID2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">!=</span>  <span class="mh">0x20F1</span> <span class="o">&amp;&amp;</span> <span class="n">device_id</span> <span class="o">!=</span> <span class="mh">0x40F1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check if adapter is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EISA_CR</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Found one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


		<span class="cm">/* Get irq from board */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xcc0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>:
			<span class="n">irq</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>:
			<span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>:
			<span class="n">irq</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>:
			<span class="n">irq</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="cm">/* Setup the newly found eisa adapter */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tlan_probe1</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span>
				 <span class="mi">12</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>

<span class="nl">out:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;None found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>

<span class="nl">out2:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Card found but it is not enabled, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="p">}</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">tlan_handle_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">tlan_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">tlan_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">tlan_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">tlan_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">tlan_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">tlan_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">tlan_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">tlan_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	 <span class="o">=</span> <span class="n">tlan_poll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>



<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_init</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		0 on success, error code otherwise.</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	The structure of the device to be</span>
<span class="cm"> *			init&#39;ed.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function completes the initialization of the</span>
<span class="cm"> *	device structure and driver.  It reserves the IO</span>
<span class="cm"> *	addresses, allocates memory for the lists and bounce</span>
<span class="cm"> *	buffers, retrieves the MAC address from the eeprom</span>
<span class="cm"> *	and assignes the device&#39;s methods.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">dma_size</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dma_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">TLAN_NUM_RX_LISTS</span> <span class="o">+</span> <span class="n">TLAN_NUM_TX_LISTS</span><span class="p">)</span>
		<span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						 <span class="n">dma_size</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage_dma</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">=</span> <span class="n">dma_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not allocate lists and buffers for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_storage_dma</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">TLAN_NUM_RX_LISTS</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list_dma</span> <span class="o">=</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">TLAN_NUM_RX_LISTS</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">tlan_ee_read_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">addr_ofs</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Error reading MAC from eeprom: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Device methods */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tlan_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_open</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		0 on success, error code otherwise.</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	Structure of device to be opened.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine puts the driver and TLAN adapter in a</span>
<span class="cm"> *	state where it is ready to send and receive packets.</span>
<span class="cm"> *	It allocates the IRQ, resets and brings the adapter</span>
<span class="cm"> *	out of reset, and allows interrupts.  It also delays</span>
<span class="cm"> *	the startup for autonegotiation or sends a Rx GO</span>
<span class="cm"> *	command to the adapter, as appropriate.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_rev</span> <span class="o">=</span> <span class="n">tlan_dio_read8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_DEF_REVISION</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tlan_handle_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot open because IRQ %d is already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">tlan_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s: Opened.  TLAN Chip Rev: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_rev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>



<span class="cm">/**************************************************************</span>
<span class="cm"> *	tlan_ioctl</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		0 on success, error code otherwise</span>
<span class="cm"> *	Params:</span>
<span class="cm"> *		dev	structure of device to receive ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> *		rq	ifreq structure to hold userspace data.</span>
<span class="cm"> *</span>
<span class="cm"> *		cmd	ioctl command.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">phy</span>   <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_online</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:		<span class="cm">/* get address of MII PHY in use. */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:		<span class="cm">/* read MII PHY register. */</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span>
				  <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:		<span class="cm">/* write MII PHY register. */</span>
		<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span>
				   <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_tx_timeout</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns: nothing</span>
<span class="cm"> *</span>
<span class="cm"> *	Params:</span>
<span class="cm"> *		dev	structure of device which timed out</span>
<span class="cm"> *			during transmit.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s: Transmit timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Ok so we timed out, lets see what we can do about it...*/</span>
	<span class="n">tlan_free_lists</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tlan_reset_lists</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tlan_read_and_clear_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_IGNORE</span><span class="p">);</span>
	<span class="n">tlan_reset_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>


<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_tx_timeout_work</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns: nothing</span>
<span class="cm"> *</span>
<span class="cm"> *	Params:</span>
<span class="cm"> *		work	work item of device which timed out</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_tx_timeout_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tlan_priv</span><span class="p">,</span> <span class="n">tlan_tqueue</span><span class="p">);</span>

	<span class="n">tlan_tx_timeout</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_start_tx</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		0 on success, non-zero on failure.</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		skb	A pointer to the sk_buff containing the</span>
<span class="cm"> *			frame to be sent.</span>
<span class="cm"> *		dev	The device to send the data on.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function adds a frame to the Tx list to be sent</span>
<span class="cm"> *	ASAP.  First it	verifies that the adapter is ready and</span>
<span class="cm"> *	there is room in the queue.  Then it sets up the next</span>
<span class="cm"> *	available list, copies the frame to the	corresponding</span>
<span class="cm"> *	buffer.  If the adapter Tx channel is idle, it gives</span>
<span class="cm"> *	the adapter a Tx Go command on the list, otherwise it</span>
<span class="cm"> *	sets the forward address of the previous list to point</span>
<span class="cm"> *	to this one.  Then it frees the sk_buff.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">tlan_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dma_addr_t</span>	<span class="n">tail_list_phys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_list</span>	<span class="o">*</span><span class="n">tail_list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">txlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;TRANSMIT:  %s PHY is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TLAN_MIN_FRAME_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="n">txlen</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">TLAN_MIN_FRAME_SIZE</span><span class="p">);</span>

	<span class="n">tail_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">;</span>
	<span class="n">tail_list_phys</span> <span class="o">=</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">!=</span> <span class="n">TLAN_CSTAT_UNUSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span>
			 <span class="s">&quot;TRANSMIT:  %s is busy (Head=%d Tail=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_busy_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">forward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">txlen</span><span class="p">,</span>
						      <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">tlan_store_skb</span><span class="p">(</span><span class="n">tail_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">txlen</span><span class="p">;</span>
	<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">TLAN_LAST_BUFFER</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">txlen</span><span class="p">;</span>
	<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">=</span> <span class="n">TLAN_CSTAT_READY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span>
			 <span class="s">&quot;TRANSMIT:  Starting TX on buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">tail_list_phys</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_CH_PARM</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">TLAN_HC_GO</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span>
			 <span class="s">&quot;TRANSMIT:  Adding buffer %d to TX channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="p">(</span><span class="n">TLAN_NUM_TX_LISTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">forward</span>
				<span class="o">=</span> <span class="n">tail_list_phys</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">forward</span>
				<span class="o">=</span> <span class="n">tail_list_phys</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">CIRC_INC</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">,</span> <span class="n">TLAN_NUM_TX_LISTS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_handle_interrupt</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		irq	The line on which the interrupt</span>
<span class="cm"> *			occurred.</span>
<span class="cm"> *		dev_id	A pointer to the device assigned to</span>
<span class="cm"> *			this irq line.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function handles an interrupt generated by its</span>
<span class="cm"> *	assigned TLAN adapter.  The function deactivates</span>
<span class="cm"> *	interrupts on its adapter, records the type of</span>
<span class="cm"> *	interrupt, executes the appropriate subhandler, and</span>
<span class="cm"> *	acknowdges the interrupt to the adapter (thus</span>
<span class="cm"> *	re-enabling adapter interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tlan_handle_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">host_int</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">type</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">host_int</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_INT</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">host_int</span> <span class="o">&amp;</span> <span class="n">TLAN_HI_IT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">ack</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">host_cmd</span><span class="p">;</span>

		<span class="n">outw</span><span class="p">(</span><span class="n">host_int</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_INT</span><span class="p">);</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">tlan_int_vector</span><span class="p">[</span><span class="n">type</span><span class="p">](</span><span class="n">dev</span><span class="p">,</span> <span class="n">host_int</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host_cmd</span> <span class="o">=</span> <span class="n">TLAN_HC_ACK</span> <span class="o">|</span> <span class="n">ack</span> <span class="o">|</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_close</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		An error code.</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	The device structure of the device to</span>
<span class="cm"> *			close.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function shuts down the adapter.  It records any</span>
<span class="cm"> *	stats, puts the adapter into reset state, deactivates</span>
<span class="cm"> *	its time as needed, and	frees the irq it is using.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">neg_be_verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tlan_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">tlan_free_lists</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;Device %s closed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_get_stats</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		A pointer to the device&#39;s statistics structure.</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	The device structure to return the</span>
<span class="cm"> *			stats for.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function updates the devices statistics by reading</span>
<span class="cm"> *	the TLAN chip&#39;s onboard registers.  Then it returns the</span>
<span class="cm"> *	address of the statistics structure.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">tlan_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Should only read stats if open ? */</span>
	<span class="n">tlan_read_and_clear_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_RECORD</span><span class="p">);</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_RX</span><span class="p">,</span> <span class="s">&quot;RECEIVE:  %s EOC count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_eoc_count</span><span class="p">);</span>
	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;TRANSMIT:  %s Busy count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_busy_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">TLAN_DEBUG_GNRL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_print_dio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="n">tlan_phy_print</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">TLAN_DEBUG_LIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TLAN_NUM_RX_LISTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tlan_print_list</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;RX&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TLAN_NUM_TX_LISTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tlan_print_list</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;TX&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_set_multicast_list</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	The device structure to set the</span>
<span class="cm"> *			multicast list for.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function sets the TLAN adaptor to various receive</span>
<span class="cm"> *	modes.  If the IFF_PROMISC flag is set, promiscuous</span>
<span class="cm"> *	mode is acitviated.  Otherwise,	promiscuous mode is</span>
<span class="cm"> *	turned off.  If the IFF_ALLMULTI flag is set, then</span>
<span class="cm"> *	the hash table is set to receive all group addresses.</span>
<span class="cm"> *	Otherwise, the first three multicast addresses are</span>
<span class="cm"> *	stored in AREG_1-3, and the rest are selected via the</span>
<span class="cm"> *	hash table, as necessary.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">hash1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">hash2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tlan_dio_read8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_CMD</span><span class="p">);</span>
		<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
				<span class="n">TLAN_NET_CMD</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">TLAN_NET_CMD_CAF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tlan_dio_read8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_CMD</span><span class="p">);</span>
		<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
				<span class="n">TLAN_NET_CMD</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TLAN_NET_CMD_CAF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">tlan_set_mac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">tlan_dio_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_HASH_1</span><span class="p">,</span>
					 <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">tlan_dio_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_HASH_2</span><span class="p">,</span>
					 <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tlan_set_mac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">offset</span> <span class="o">=</span>
						<span class="n">tlan_hash_func</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
						<span class="n">hash1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">hash2</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">32</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">tlan_set_mac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">tlan_dio_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_HASH_1</span><span class="p">,</span> <span class="n">hash1</span><span class="p">);</span>
			<span class="n">tlan_dio_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_HASH_2</span><span class="p">,</span> <span class="n">hash2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>



<span class="cm">/*****************************************************************************</span>
<span class="cm">******************************************************************************</span>

<span class="cm">ThunderLAN driver interrupt vectors and table</span>

<span class="cm">please see chap. 4, &quot;Interrupt Handling&quot; of the &quot;ThunderLAN</span>
<span class="cm">Programmer&#39;s Guide&quot; for more informations on handling interrupts</span>
<span class="cm">generated by TLAN based adapters.</span>

<span class="cm">******************************************************************************</span>
<span class="cm">*****************************************************************************/</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_handle_tx_eof</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		1</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		Device assigned the IRQ that was</span>
<span class="cm"> *				raised.</span>
<span class="cm"> *		host_int	The contents of the HOST_INT</span>
<span class="cm"> *				port.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function handles Tx EOF interrupts which are raised</span>
<span class="cm"> *	by the adapter when it has completed sending the</span>
<span class="cm"> *	contents of a buffer.  If detemines which list/buffer</span>
<span class="cm"> *	was completed and resets it.  If the buffer was the last</span>
<span class="cm"> *	in the channel (EOC), then the function checks to see if</span>
<span class="cm"> *	another buffer is ready to send, and if so, sends a Tx</span>
<span class="cm"> *	Go command.  Finally, the driver activates/continues the</span>
<span class="cm"> *	activity LED.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tlan_handle_tx_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">eoc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_list</span>	<span class="o">*</span><span class="n">head_list</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">head_list_phys</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tmp_c_stat</span><span class="p">;</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span>
		 <span class="s">&quot;TRANSMIT:  Handling TX EOF (Head=%d Tail=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">);</span>
	<span class="n">head_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">tmp_c_stat</span> <span class="o">=</span> <span class="n">head_list</span><span class="o">-&gt;</span><span class="n">c_stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TLAN_CSTAT_FRM_CMP</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tlan_get_skb</span><span class="p">(</span><span class="n">head_list</span><span class="p">);</span>

		<span class="n">ack</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">head_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">,</span>
				 <span class="n">max</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">TLAN_MIN_FRAME_SIZE</span><span class="p">),</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">head_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_c_stat</span> <span class="o">&amp;</span> <span class="n">TLAN_CSTAT_EOC</span><span class="p">)</span>
			<span class="n">eoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">head_list</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">;</span>

		<span class="n">head_list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">=</span> <span class="n">TLAN_CSTAT_UNUSED</span><span class="p">;</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">CIRC_INC</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">,</span> <span class="n">TLAN_NUM_TX_LISTS</span><span class="p">);</span>
		<span class="n">head_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ack</span><span class="p">)</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;Received interrupt for uncompleted TX frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span>
			 <span class="s">&quot;TRANSMIT:  handling TX EOC (Head=%d Tail=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">);</span>
		<span class="n">head_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
		<span class="n">head_list_phys</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list_dma</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">head_list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">&amp;</span> <span class="n">TLAN_CSTAT_READY</span><span class="p">)</span>
		    <span class="o">==</span> <span class="n">TLAN_CSTAT_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">head_list_phys</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_CH_PARM</span><span class="p">);</span>
			<span class="n">ack</span> <span class="o">|=</span> <span class="n">TLAN_HC_GO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
				<span class="n">TLAN_LED_REG</span><span class="p">,</span> <span class="n">TLAN_LED_LINK</span> <span class="o">|</span> <span class="n">TLAN_LED_ACT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tlan_timer</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TLAN_TIMER_ACT_DELAY</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_set_at</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_type</span> <span class="o">=</span> <span class="n">TLAN_TIMER_ACTIVITY</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_type</span> <span class="o">==</span> <span class="n">TLAN_TIMER_ACTIVITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_set_at</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ack</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	TLan_HandleStatOverflow</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		1</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		Device assigned the IRQ that was</span>
<span class="cm"> *				raised.</span>
<span class="cm"> *		host_int	The contents of the HOST_INT</span>
<span class="cm"> *				port.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function handles the Statistics Overflow interrupt</span>
<span class="cm"> *	which means that one or more of the TLAN statistics</span>
<span class="cm"> *	registers has reached 1/2 capacity and needs to be read.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tlan_handle_stat_overflow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tlan_read_and_clear_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_RECORD</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	TLan_HandleRxEOF</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		1</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		Device assigned the IRQ that was</span>
<span class="cm"> *				raised.</span>
<span class="cm"> *		host_int	The contents of the HOST_INT</span>
<span class="cm"> *				port.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function handles the Rx EOF interrupt which</span>
<span class="cm"> *	indicates a frame has been received by the adapter from</span>
<span class="cm"> *	the net and the frame has been transferred to memory.</span>
<span class="cm"> *	The function determines the bounce buffer the frame has</span>
<span class="cm"> *	been loaded into, creates a new sk_buff big enough to</span>
<span class="cm"> *	hold the frame, and sends it to protocol stack.  It</span>
<span class="cm"> *	then resets the used buffer and appends it to the end</span>
<span class="cm"> *	of the list.  If the frame was the last in the Rx</span>
<span class="cm"> *	channel (EOC), the function restarts the receive channel</span>
<span class="cm"> *	by sending an Rx Go command to the adapter.  Then it</span>
<span class="cm"> *	activates/continues the activity LED.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tlan_handle_rx_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span>		<span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">eoc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_list</span>	<span class="o">*</span><span class="n">head_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_list</span>	<span class="o">*</span><span class="n">tail_list</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tmp_c_stat</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">head_list_phys</span><span class="p">;</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_RX</span><span class="p">,</span> <span class="s">&quot;RECEIVE:  handling RX EOF (Head=%d Tail=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">);</span>
	<span class="n">head_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>
	<span class="n">head_list_phys</span> <span class="o">=</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">tmp_c_stat</span> <span class="o">=</span> <span class="n">head_list</span><span class="o">-&gt;</span><span class="n">c_stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TLAN_CSTAT_FRM_CMP</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">frame_dma</span> <span class="o">=</span> <span class="n">head_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">frame_size</span> <span class="o">=</span> <span class="n">head_list</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>

		<span class="n">ack</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_c_stat</span> <span class="o">&amp;</span> <span class="n">TLAN_CSTAT_EOC</span><span class="p">)</span>
			<span class="n">eoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">TLAN_MAX_FRAME_SIZE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop_and_reuse</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">tlan_get_skb</span><span class="p">(</span><span class="n">head_list</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">frame_dma</span><span class="p">,</span>
				 <span class="n">TLAN_MAX_FRAME_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">frame_size</span><span class="p">;</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">head_list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span>
			<span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">TLAN_MAX_FRAME_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">tlan_store_skb</span><span class="p">(</span><span class="n">head_list</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">);</span>
<span class="nl">drop_and_reuse:</span>
		<span class="n">head_list</span><span class="o">-&gt;</span><span class="n">forward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head_list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tail_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">;</span>
		<span class="n">tail_list</span><span class="o">-&gt;</span><span class="n">forward</span> <span class="o">=</span> <span class="n">head_list_phys</span><span class="p">;</span>

		<span class="n">CIRC_INC</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span> <span class="n">TLAN_NUM_RX_LISTS</span><span class="p">);</span>
		<span class="n">CIRC_INC</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">,</span> <span class="n">TLAN_NUM_RX_LISTS</span><span class="p">);</span>
		<span class="n">head_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>
		<span class="n">head_list_phys</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ack</span><span class="p">)</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;Received interrupt for uncompleted RX frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_RX</span><span class="p">,</span>
			 <span class="s">&quot;RECEIVE:  handling RX EOC (Head=%d Tail=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">);</span>
		<span class="n">head_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>
		<span class="n">head_list_phys</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">head_list_phys</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_CH_PARM</span><span class="p">);</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">TLAN_HC_GO</span> <span class="o">|</span> <span class="n">TLAN_HC_RT</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_eoc_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_ACTIVITY_LED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
				<span class="n">TLAN_LED_REG</span><span class="p">,</span> <span class="n">TLAN_LED_LINK</span> <span class="o">|</span> <span class="n">TLAN_LED_ACT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tlan_timer</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TLAN_TIMER_ACT_DELAY</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_set_at</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_type</span> <span class="o">=</span> <span class="n">TLAN_TIMER_ACTIVITY</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_type</span> <span class="o">==</span> <span class="n">TLAN_TIMER_ACTIVITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_set_at</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ack</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_handle_dummy</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		1</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		Device assigned the IRQ that was</span>
<span class="cm"> *				raised.</span>
<span class="cm"> *		host_int	The contents of the HOST_INT</span>
<span class="cm"> *				port.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function handles the Dummy interrupt, which is</span>
<span class="cm"> *	raised whenever a test interrupt is generated by setting</span>
<span class="cm"> *	the Req_Int bit of HOST_CMD to 1.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tlan_handle_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Test interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_handle_tx_eoc</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		1</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		Device assigned the IRQ that was</span>
<span class="cm"> *				raised.</span>
<span class="cm"> *		host_int	The contents of the HOST_INT</span>
<span class="cm"> *				port.</span>
<span class="cm"> *</span>
<span class="cm"> *	This driver is structured to determine EOC occurrences by</span>
<span class="cm"> *	reading the CSTAT member of the list structure.  Tx EOC</span>
<span class="cm"> *	interrupts are disabled via the DIO INTDIS register.</span>
<span class="cm"> *	However, TLAN chips before revision 3.0 didn&#39;t have this</span>
<span class="cm"> *	functionality, so process EOC events if this is the</span>
<span class="cm"> *	case.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tlan_handle_tx_eoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tlan_list</span>		<span class="o">*</span><span class="n">head_list</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">head_list_phys</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">host_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_rev</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_TX</span><span class="p">,</span>
			 <span class="s">&quot;TRANSMIT:  handling TX EOC (Head=%d Tail=%d) -- IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span><span class="p">);</span>
		<span class="n">head_list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
		<span class="n">head_list_phys</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list_dma</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">head_list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">&amp;</span> <span class="n">TLAN_CSTAT_READY</span><span class="p">)</span>
		    <span class="o">==</span> <span class="n">TLAN_CSTAT_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">head_list_phys</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_CH_PARM</span><span class="p">);</span>
			<span class="n">ack</span> <span class="o">|=</span> <span class="n">TLAN_HC_GO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ack</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_handle_status_check</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		0 if Adapter check, 1 if Network Status check.</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		Device assigned the IRQ that was</span>
<span class="cm"> *				raised.</span>
<span class="cm"> *		host_int	The contents of the HOST_INT</span>
<span class="cm"> *				port.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function handles Adapter Check/Network Status</span>
<span class="cm"> *	interrupts generated by the adapter.  It checks the</span>
<span class="cm"> *	vector in the HOST_INT register to determine if it is</span>
<span class="cm"> *	an Adapter Check interrupt.  If so, it resets the</span>
<span class="cm"> *	adapter.  Otherwise it clears the status registers</span>
<span class="cm"> *	and services the PHY.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tlan_handle_status_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span>		<span class="n">ack</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">error</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">net_sts</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tlphy_ctl</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tlphy_sts</span><span class="p">;</span>

	<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_int</span> <span class="o">&amp;</span> <span class="n">TLAN_HI_IV_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_CH_PARM</span><span class="p">);</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adaptor Error = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="n">tlan_read_and_clear_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_RECORD</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">TLAN_HC_AD_RST</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>

		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_tqueue</span><span class="p">);</span>

		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s: Status Check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>

		<span class="n">net_sts</span> <span class="o">=</span> <span class="n">tlan_dio_read8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_STS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_sts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_STS</span><span class="p">,</span> <span class="n">net_sts</span><span class="p">);</span>
			<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s:    Net_Sts = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">net_sts</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">net_sts</span> <span class="o">&amp;</span> <span class="n">TLAN_NET_STS_MIRQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlphy_sts</span><span class="p">);</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlphy_ctl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tlphy_sts</span> <span class="o">&amp;</span> <span class="n">TLAN_TS_POLOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">tlphy_ctl</span> <span class="o">&amp;</span> <span class="n">TLAN_TC_SWAPOL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tlphy_ctl</span> <span class="o">|=</span> <span class="n">TLAN_TC_SWAPOL</span><span class="p">;</span>
				<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_CTL</span><span class="p">,</span>
						   <span class="n">tlphy_ctl</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tlphy_sts</span> <span class="o">&amp;</span> <span class="n">TLAN_TS_POLOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">tlphy_ctl</span> <span class="o">&amp;</span> <span class="n">TLAN_TC_SWAPOL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tlphy_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TLAN_TC_SWAPOL</span><span class="p">;</span>
				<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_CTL</span><span class="p">,</span>
						   <span class="n">tlphy_ctl</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">tlan_phy_print</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ack</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_handle_rx_eoc</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		1</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		Device assigned the IRQ that was</span>
<span class="cm"> *				raised.</span>
<span class="cm"> *		host_int	The contents of the HOST_INT</span>
<span class="cm"> *				port.</span>
<span class="cm"> *</span>
<span class="cm"> *	This driver is structured to determine EOC occurrences by</span>
<span class="cm"> *	reading the CSTAT member of the list structure.  Rx EOC</span>
<span class="cm"> *	interrupts are disabled via the DIO INTDIS register.</span>
<span class="cm"> *	However, TLAN chips before revision 3.0 didn&#39;t have this</span>
<span class="cm"> *	CSTAT member or a INTDIS register, so if this chip is</span>
<span class="cm"> *	pre-3.0, process EOC interrupts normally.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tlan_handle_rx_eoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dma_addr_t</span>	<span class="n">head_list_phys</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_rev</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_RX</span><span class="p">,</span>
			 <span class="s">&quot;RECEIVE:  Handling RX EOC (head=%d tail=%d) -- IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tail</span><span class="p">);</span>
		<span class="n">head_list_phys</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">head_list_phys</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_CH_PARM</span><span class="p">);</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">TLAN_HC_GO</span> <span class="o">|</span> <span class="n">TLAN_HC_RT</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_eoc_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ack</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/*****************************************************************************</span>
<span class="cm">******************************************************************************</span>

<span class="cm">ThunderLAN driver timer function</span>

<span class="cm">******************************************************************************</span>
<span class="cm">*****************************************************************************/</span>


<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_timer</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		data	A value given to add timer when</span>
<span class="cm"> *			add_timer was called.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function handles timed functionality for the</span>
<span class="cm"> *	TLAN driver.  The two current timer uses are for</span>
<span class="cm"> *	delaying for autonegotionation and driving the ACT LED.</span>
<span class="cm"> *	-	Autonegotiation requires being allowed about</span>
<span class="cm"> *		2 1/2 seconds before attempting to transmit a</span>
<span class="cm"> *		packet.  It would be a very bad thing to hang</span>
<span class="cm"> *		the kernel this long, so the driver doesn&#39;t</span>
<span class="cm"> *		allow transmission &#39;til after this time, for</span>
<span class="cm"> *		certain PHYs.  It would be much nicer if all</span>
<span class="cm"> *		PHYs were interrupt-capable like the internal</span>
<span class="cm"> *		PHY.</span>
<span class="cm"> *	-	The ACT LED, which shows adapter activity, is</span>
<span class="cm"> *		driven by the driver, and so must be left on</span>
<span class="cm"> *		for a short period to power up the LED so it</span>
<span class="cm"> *		can be seen.  This delay can be changed by</span>
<span class="cm"> *		changing the TLAN_TIMER_ACT_DELAY in tlan.h,</span>
<span class="cm"> *		if desired.  100 ms  produces a slightly</span>
<span class="cm"> *		sluggish response.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span>		<span class="n">elapsed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef MONITOR</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_LINK_BEAT</span>:
		<span class="n">tlan_phy_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_PHY_PDOWN</span>:
		<span class="n">tlan_phy_power_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_PHY_PUP</span>:
		<span class="n">tlan_phy_power_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_PHY_RESET</span>:
		<span class="n">tlan_phy_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_PHY_START_LINK</span>:
		<span class="n">tlan_phy_start_link</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_PHY_FINISH_AN</span>:
		<span class="n">tlan_phy_finish_auto_neg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_FINISH_RESET</span>:
		<span class="n">tlan_finish_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TLAN_TIMER_ACTIVITY</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">elapsed</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_set_at</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">TLAN_TIMER_ACT_DELAY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
						<span class="n">TLAN_LED_REG</span><span class="p">,</span> <span class="n">TLAN_LED_LINK</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tlan_timer</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer_set_at</span>
					<span class="o">+</span> <span class="n">TLAN_TIMER_ACT_DELAY</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/*****************************************************************************</span>
<span class="cm">******************************************************************************</span>

<span class="cm">ThunderLAN driver adapter related routines</span>

<span class="cm">******************************************************************************</span>
<span class="cm">*****************************************************************************/</span>


<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_reset_lists</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	The device structure with the list</span>
<span class="cm"> *			stuctures to be reset.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine sets the variables associated with managing</span>
<span class="cm"> *	the TLAN lists to their initial values.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_reset_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_list</span>	<span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">list_phys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TLAN_NUM_TX_LISTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">=</span> <span class="n">TLAN_CSTAT_UNUSED</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tail</span> <span class="o">=</span> <span class="n">TLAN_NUM_RX_LISTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TLAN_NUM_RX_LISTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">list_phys</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">c_stat</span> <span class="o">=</span> <span class="n">TLAN_CSTAT_READY</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">=</span> <span class="n">TLAN_MAX_FRAME_SIZE</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">TLAN_MAX_FRAME_SIZE</span> <span class="o">|</span> <span class="n">TLAN_LAST_BUFFER</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_MAX_FRAME_SIZE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of memory for received data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							 <span class="n">TLAN_MAX_FRAME_SIZE</span><span class="p">,</span>
							 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">tlan_store_skb</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">forward</span> <span class="o">=</span> <span class="n">list_phys</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* in case ran out of memory early, clear bits */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">TLAN_NUM_RX_LISTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_store_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">forward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_free_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_list</span>	<span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TLAN_NUM_TX_LISTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">tlan_get_skb</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">,</span>
				<span class="n">max</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">TLAN_MIN_FRAME_SIZE</span><span class="p">),</span>
				<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TLAN_NUM_RX_LISTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">tlan_get_skb</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					 <span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">,</span>
					 <span class="n">TLAN_MAX_FRAME_SIZE</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_print_dio</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		io_base		Base IO port of the device of</span>
<span class="cm"> *				which to print DIO registers.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function prints out all the internal (DIO)</span>
<span class="cm"> *	registers of a TLAN chip.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_print_dio</span><span class="p">(</span><span class="n">u16</span> <span class="n">io_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data0</span><span class="p">,</span> <span class="n">data1</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Contents of internal registers for io base 0x%04hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">io_base</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Off.  +0        +4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x4C</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data0</span> <span class="o">=</span> <span class="n">tlan_dio_read32</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">data1</span> <span class="o">=</span> <span class="n">tlan_dio_read32</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;0x%02x  0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">data1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	TLan_PrintList</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		list	A pointer to the struct tlan_list structure to</span>
<span class="cm"> *			be printed.</span>
<span class="cm"> *		type	A string to designate type of list,</span>
<span class="cm"> *			&quot;Rx&quot; or &quot;Tx&quot;.</span>
<span class="cm"> *		num	The index of the list.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function prints out the contents of the list</span>
<span class="cm"> *	pointed to by the list parameter.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_print_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlan_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s List %d at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;   Forward    = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">list</span><span class="o">-&gt;</span><span class="n">forward</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;   CSTAT      = 0x%04hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">c_stat</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;   Frame Size = 0x%04hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">);</span>
	<span class="cm">/* for (i = 0; i &lt; 10; i++) { */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;   Buffer[%d].count, addr = 0x%08x, 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_read_and_clear_stats</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	Pointer to device structure of adapter</span>
<span class="cm"> *			to which to read stats.</span>
<span class="cm"> *		record	Flag indicating whether to add</span>
<span class="cm"> *</span>
<span class="cm"> *	This functions reads all the internal status registers</span>
<span class="cm"> *	of the TLAN chip, which clears them as a side effect.</span>
<span class="cm"> *	It then either adds the values to the device&#39;s status</span>
<span class="cm"> *	struct, or discards them, depending on whether record</span>
<span class="cm"> *	is TLAN_RECORD (!=0)  or TLAN_IGNORE (==0).</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_read_and_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">tx_good</span><span class="p">,</span> <span class="n">tx_under</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">rx_good</span><span class="p">,</span> <span class="n">rx_over</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">def_tx</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">multi_col</span><span class="p">,</span> <span class="n">single_col</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">excess_col</span><span class="p">,</span> <span class="n">late_col</span><span class="p">,</span> <span class="n">loss</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_GOOD_TX_FRMS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">tx_good</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span><span class="p">);</span>
	<span class="n">tx_good</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tx_good</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">tx_under</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_GOOD_RX_FRMS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">rx_good</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span><span class="p">);</span>
	<span class="n">rx_good</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rx_good</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">rx_over</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_DEFERRED_TX</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">def_tx</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span><span class="p">);</span>
	<span class="n">def_tx</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">crc</span>     <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">code</span>    <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_MULTICOL_FRMS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">multi_col</span>   <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span><span class="p">);</span>
	<span class="n">multi_col</span>  <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">single_col</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">single_col</span> <span class="o">+=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_EXCESSCOL_FRMS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">excess_col</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span><span class="p">);</span>
	<span class="n">late_col</span>   <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">loss</span>       <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">rx_good</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span>  <span class="o">+=</span> <span class="n">rx_over</span> <span class="o">+</span> <span class="n">crc</span> <span class="o">+</span> <span class="n">code</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">tx_good</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span>  <span class="o">+=</span> <span class="n">tx_under</span> <span class="o">+</span> <span class="n">loss</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">multi_col</span>
			<span class="o">+</span> <span class="n">single_col</span> <span class="o">+</span> <span class="n">excess_col</span> <span class="o">+</span> <span class="n">late_col</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span>    <span class="o">+=</span> <span class="n">rx_over</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span>     <span class="o">+=</span> <span class="n">crc</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span>   <span class="o">+=</span> <span class="n">code</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="n">tx_under</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	TLan_Reset</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		0</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	Pointer to device structure of adapter</span>
<span class="cm"> *			to be reset.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function resets the adapter and it&#39;s physical</span>
<span class="cm"> *	device.  See Chap. 3, pp. 9-10 of the &quot;ThunderLAN</span>
<span class="cm"> *	Programmer&#39;s Guide&quot; for details.  The routine tries to</span>
<span class="cm"> *	implement what is detailed there, though adjustments</span>
<span class="cm"> *	have been made.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tlan_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">data8</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*  1.	Assert reset bit. */</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">TLAN_HC_AD_RST</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

<span class="cm">/*  2.	Turn off interrupts. (Probably isn&#39;t necessary) */</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">TLAN_HC_INT_OFF</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>

<span class="cm">/*  3.	Clear AREGs and HASHs. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TLAN_AREG_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TLAN_HASH_2</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">tlan_dio_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*  4.	Setup NetConfig register. */</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">TLAN_NET_CFG_1FRAG</span> <span class="o">|</span> <span class="n">TLAN_NET_CFG_1CHAN</span> <span class="o">|</span> <span class="n">TLAN_NET_CFG_PHY_EN</span><span class="p">;</span>
	<span class="n">tlan_dio_write16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_CONFIG</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>

<span class="cm">/*  5.	Load Ld_Tmr and Ld_Thr in HOST_CMD. */</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">TLAN_HC_LD_TMR</span> <span class="o">|</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">TLAN_HC_LD_THR</span> <span class="o">|</span> <span class="mh">0x9</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>

<span class="cm">/*  6.	Unreset the MII by setting NMRST (in NetSio) to 1. */</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_NMRST</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

<span class="cm">/*  7.	Setup the remaining registers. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_rev</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data8</span> <span class="o">=</span> <span class="n">TLAN_ID_TX_EOC</span> <span class="o">|</span> <span class="n">TLAN_ID_RX_EOC</span><span class="p">;</span>
		<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_INT_DIS</span><span class="p">,</span> <span class="n">data8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tlan_phy_detect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">TLAN_NET_CFG_1FRAG</span> <span class="o">|</span> <span class="n">TLAN_NET_CFG_1CHAN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_BIT_RATE_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">TLAN_NET_CFG_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aui</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_ACOMMIT</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">TLAN_DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_ACOMMIT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_ACOMMIT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">TLAN_NET_CFG_PHY_EN</span><span class="p">;</span>
	<span class="n">tlan_dio_write16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_CONFIG</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_UNMANAGED_PHY</span><span class="p">)</span>
		<span class="n">tlan_finish_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tlan_phy_power_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tlan_finish_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>		<span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">phy</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">sio</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">partner</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tlphy_ctl</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tlphy_par</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tlphy_id1</span><span class="p">,</span> <span class="n">tlphy_id2</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">TLAN_NET_CMD_NRESET</span> <span class="o">|</span> <span class="n">TLAN_NET_CMD_NWRAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">TLAN_NET_CMD_DUPLEX</span><span class="p">;</span>
	<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_CMD</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">TLAN_NET_MASK_MASK4</span> <span class="o">|</span> <span class="n">TLAN_NET_MASK_MASK5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">TLAN_NET_MASK_MASK7</span><span class="p">;</span>
	<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_MASK</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">tlan_dio_write16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_MAX_RX</span><span class="p">,</span> <span class="p">((</span><span class="mi">1536</span><span class="p">)</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">&amp;~</span><span class="mi">7</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_ID_HI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlphy_id1</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_ID_LO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlphy_id2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_UNMANAGED_PHY</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aui</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MII_GS_LINK</span><span class="p">;</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link forced</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MII_GS_LINK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="cm">/* We only support link info on Nat.Sem. PHY&#39;s */</span>
		    <span class="p">(</span><span class="n">tlphy_id1</span> <span class="o">==</span> <span class="n">NAT_SEM_ID1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tlphy_id2</span> <span class="o">==</span> <span class="n">NAT_SEM_ID2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_AN_LPA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">partner</span><span class="p">);</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_PAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlphy_par</span><span class="p">);</span>

			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;Link active with %s %uMbps %s-Duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">tlphy_par</span> <span class="o">&amp;</span> <span class="n">TLAN_PHY_AN_EN_STAT</span><span class="p">)</span>
				    <span class="o">?</span> <span class="s">&quot;forced&quot;</span> <span class="o">:</span> <span class="s">&quot;Autonegotiation enabled,&quot;</span><span class="p">,</span>
				    <span class="n">tlphy_par</span> <span class="o">&amp;</span> <span class="n">TLAN_PHY_SPEED_100</span>
				    <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
				    <span class="n">tlphy_par</span> <span class="o">&amp;</span> <span class="n">TLAN_PHY_DUPLEX_FULL</span>
				    <span class="o">?</span> <span class="s">&quot;Full&quot;</span> <span class="o">:</span> <span class="s">&quot;Half&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tlphy_par</span> <span class="o">&amp;</span> <span class="n">TLAN_PHY_AN_EN_STAT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Partner capability:&quot;</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">partner</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
						<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">media</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">]);</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_LED_REG</span><span class="p">,</span>
					<span class="n">TLAN_LED_LINK</span><span class="p">);</span>
<span class="cp">#ifdef MONITOR</span>
			<span class="cm">/* We have link beat..for now anyway */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*Enabling link beat monitoring */</span>
			<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">),</span> <span class="n">TLAN_TIMER_LINK_BEAT</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MII_GS_LINK</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_LED_REG</span><span class="p">,</span>
					<span class="n">TLAN_LED_LINK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlphy_ctl</span><span class="p">);</span>
		<span class="n">tlphy_ctl</span> <span class="o">|=</span> <span class="n">TLAN_TC_INTEN</span><span class="p">;</span>
		<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_CTL</span><span class="p">,</span> <span class="n">tlphy_ctl</span><span class="p">);</span>
		<span class="n">sio</span> <span class="o">=</span> <span class="n">tlan_dio_read8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_SIO</span><span class="p">);</span>
		<span class="n">sio</span> <span class="o">|=</span> <span class="n">TLAN_NET_SIO_MINTEN</span><span class="p">;</span>
		<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MII_GS_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_set_mac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">TLAN_HC_INT_ON</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">debug</span> <span class="o">!=</span> <span class="n">TLAN_DEBUG_PROBE</span><span class="p">)</span>
			<span class="n">outb</span><span class="p">((</span><span class="n">TLAN_HC_REQ_INT</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list_dma</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_CH_PARM</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">TLAN_HC_GO</span> <span class="o">|</span> <span class="n">TLAN_HC_RT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_HOST_CMD</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link inactive, will retry in 10 secs...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">),</span> <span class="n">TLAN_TIMER_FINISH_RESET</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tlan_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_set_mac</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	Pointer to device structure of adapter</span>
<span class="cm"> *			on which to change the AREG.</span>
<span class="cm"> *		areg	The AREG to set the address in (0 - 3).</span>
<span class="cm"> *		mac	A pointer to an array of chars.  Each</span>
<span class="cm"> *			element stores one byte of the address.</span>
<span class="cm"> *			IE, it isn&#39;t in ascii.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function transfers a MAC address to one of the</span>
<span class="cm"> *	TLAN AREGs (address registers).  The TLAN chip locks</span>
<span class="cm"> *	the register on writing to offset 0 and unlocks the</span>
<span class="cm"> *	register after writing to offset 5.  If NULL is passed</span>
<span class="cm"> *	in mac, then the AREG is filled with 0&#39;s.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">areg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">areg</span> <span class="o">*=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
					<span class="n">TLAN_AREG_0</span> <span class="o">+</span> <span class="n">areg</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tlan_dio_write8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
					<span class="n">TLAN_AREG_0</span> <span class="o">+</span> <span class="n">areg</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/*****************************************************************************</span>
<span class="cm">******************************************************************************</span>

<span class="cm">ThunderLAN driver PHY layer routines</span>

<span class="cm">******************************************************************************</span>
<span class="cm">*****************************************************************************/</span>



<span class="cm">/*********************************************************************</span>
<span class="cm"> *	tlan_phy_print</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	A pointer to the device structure of the</span>
<span class="cm"> *			TLAN device having the PHYs to be detailed.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function prints the registers a PHY (aka transceiver).</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_phy_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">phy</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_UNMANAGED_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unmanaged PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">&lt;=</span> <span class="n">TLAN_PHY_MAX_ADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;   Off.  +0     +1     +2     +3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data0</span><span class="p">);</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data1</span><span class="p">);</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data2</span><span class="p">);</span>
			<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data3</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;   0x%02x 0x%04hx 0x%04hx 0x%04hx 0x%04hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/*********************************************************************</span>
<span class="cm"> *	tlan_phy_detect</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev	A pointer to the device structure of the adapter</span>
<span class="cm"> *			for which the PHY needs determined.</span>
<span class="cm"> *</span>
<span class="cm"> *	So far I&#39;ve found that adapters which have external PHYs</span>
<span class="cm"> *	may also use the internal PHY for part of the functionality.</span>
<span class="cm"> *	(eg, AUI/Thinnet).  This function finds out if this TLAN</span>
<span class="cm"> *	chip has an internal PHY, and then finds the first external</span>
<span class="cm"> *	PHY (starting from address 0) if it exists).</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_phy_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">control</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">hi</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">lo</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_UNMANAGED_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TLAN_PHY_MAX_ADDR</span><span class="p">,</span> <span class="n">MII_GEN_ID_HI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TLAN_PHY_MAX_ADDR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TLAN_PHY_NONE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TLAN_PHY_NONE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy</span> <span class="o">&lt;=</span> <span class="n">TLAN_PHY_MAX_ADDR</span><span class="p">;</span> <span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_ID_HI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_ID_LO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">control</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hi</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lo</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span>
				 <span class="s">&quot;PHY found at %02x %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">phy</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">TLAN_PHY_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">phy</span> <span class="o">!=</span> <span class="n">TLAN_PHY_MAX_ADDR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TLAN_PHY_NONE</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TLAN_PHY_NONE</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot initialize device, no PHY was found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_phy_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">value</span><span class="p">;</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s: Powering down PHY(s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">MII_GC_PDOWN</span> <span class="o">|</span> <span class="n">MII_GC_LOOPBK</span> <span class="o">|</span> <span class="n">MII_GC_ISOLATE</span><span class="p">;</span>
	<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">],</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TLAN_PHY_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_USE_INTERN_10</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for 50 ms and powerup</span>
<span class="cm">	 * This is abitrary.  It is intended to make sure the</span>
<span class="cm">	 * transceiver settles.</span>
<span class="cm">	 */</span>
	<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">),</span> <span class="n">TLAN_TIMER_PHY_PUP</span><span class="p">);</span>

<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_phy_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">value</span><span class="p">;</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s: Powering up PHY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">MII_GC_LOOPBK</span><span class="p">;</span>
	<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">],</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="cm">/* Wait for 500 ms and reset the</span>
<span class="cm">	 * transceiver.  The TLAN docs say both 50 ms and</span>
<span class="cm">	 * 500 ms, so do the longer, just in case.</span>
<span class="cm">	 */</span>
	<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">),</span> <span class="n">TLAN_TIMER_PHY_RESET</span><span class="p">);</span>

<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">value</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>

	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s: Resetting PHY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">MII_GC_LOOPBK</span> <span class="o">|</span> <span class="n">MII_GC_RESET</span><span class="p">;</span>
	<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">MII_GC_RESET</span><span class="p">)</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Wait for 500 ms and initialize.</span>
<span class="cm">	 * I don&#39;t remember why I wait this long.</span>
<span class="cm">	 * I&#39;ve changed this to 50ms, as it seems long enough.</span>
<span class="cm">	 */</span>
	<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">),</span> <span class="n">TLAN_TIMER_PHY_START_LINK</span><span class="p">);</span>

<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_phy_start_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">ability</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">control</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tctl</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>
	<span class="n">TLAN_DBG</span><span class="p">(</span><span class="n">TLAN_DEBUG_GNRL</span><span class="p">,</span> <span class="s">&quot;%s: Trying to activate link.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ability</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MII_GS_AUTONEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aui</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ability</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span>  <span class="o">==</span> <span class="n">TLAN_SPEED_10</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">TLAN_DUPLEX_HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">TLAN_SPEED_10</span> <span class="o">&amp;&amp;</span>
			   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">TLAN_DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">TLAN_SPEED_100</span> <span class="o">&amp;&amp;</span>
			   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">TLAN_DUPLEX_HALF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">TLAN_SPEED_100</span> <span class="o">&amp;&amp;</span>
			   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">TLAN_DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="mh">0x2100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* Set Auto-Neg advertisement */</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_AN_ADV</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">ability</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* Enablee Auto-Neg */</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="cm">/* Restart Auto-Neg */</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">);</span>
			<span class="cm">/* Wait for 4 sec for autonegotiation</span>
<span class="cm">			 * to complete.  The max spec time is less than this</span>
<span class="cm">			 * but the card need additional time to start AN.</span>
<span class="cm">			 * .5 sec should be plenty extra.</span>
<span class="cm">			 */</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Starting autonegotiation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">),</span> <span class="n">TLAN_TIMER_PHY_FINISH_AN</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aui</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">TLAN_NET_CFG_1FRAG</span> <span class="o">|</span> <span class="n">TLAN_NET_CFG_1CHAN</span>
			<span class="o">|</span> <span class="n">TLAN_NET_CFG_PHY_EN</span><span class="p">;</span>
		<span class="n">tlan_dio_write16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">40</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span> <span class="n">TLAN_TIMER_PHY_PDOWN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aui</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tctl</span> <span class="o">|=</span> <span class="n">TLAN_TC_AUISEL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TLAN_TC_AUISEL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">TLAN_DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">control</span> <span class="o">|=</span> <span class="n">MII_GC_DUPLEX</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">TLAN_SPEED_100</span><span class="p">)</span>
				<span class="n">control</span> <span class="o">|=</span> <span class="n">MII_GC_SPEEDSEL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">TLAN_TLPHY_CTL</span><span class="p">,</span> <span class="n">tctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for 2 sec to give the transceiver time</span>
<span class="cm">	 * to establish link.</span>
<span class="cm">	 */</span>
	<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="p">),</span> <span class="n">TLAN_TIMER_FINISH_RESET</span><span class="p">);</span>

<span class="p">}</span>




<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_phy_finish_auto_neg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">an_adv</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">an_lpa</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">mode</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">status</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>

	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MII_GS_AUTOCMPLT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Wait for 8 sec to give the process</span>
<span class="cm">		 * more time.  Perhaps we should fail after a while.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">neg_be_verbose</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Giving autonegotiation more time.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Please check that your adapter has</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;been properly connected to a HUB or Switch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Trying to establish link in the background...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">HZ</span><span class="p">),</span> <span class="n">TLAN_TIMER_PHY_FINISH_AN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Autonegotiation complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_AN_ADV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an_adv</span><span class="p">);</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_AN_LPA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an_lpa</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">an_adv</span> <span class="o">&amp;</span> <span class="n">an_lpa</span> <span class="o">&amp;</span> <span class="mh">0x03E0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tlan_full_duplex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x0180</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TLAN_ADAPTER_USE_INTERN_10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">TLAN_NET_CFG_1FRAG</span> <span class="o">|</span> <span class="n">TLAN_NET_CFG_1CHAN</span>
			<span class="o">|</span> <span class="n">TLAN_NET_CFG_PHY_EN</span><span class="p">;</span>
		<span class="n">tlan_dio_write16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">TLAN_NET_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">400</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span> <span class="n">TLAN_TIMER_PHY_PDOWN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">TLAN_DUPLEX_FULL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">an_adv</span> <span class="o">&amp;</span> <span class="n">an_lpa</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span>
					   <span class="n">MII_GC_AUTOENB</span> <span class="o">|</span> <span class="n">MII_GC_DUPLEX</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Starting internal PHY with FULL-DUPLEX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tlan_mii_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_CTL</span><span class="p">,</span>
					   <span class="n">MII_GC_AUTOENB</span><span class="p">);</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Starting internal PHY with HALF-DUPLEX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for 100 ms.  No reason in partiticular.</span>
<span class="cm">	 */</span>
	<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">),</span> <span class="n">TLAN_TIMER_FINISH_RESET</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#ifdef MONITOR</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *     tlan_phy_monitor</span>
<span class="cm"> *</span>
<span class="cm"> *     Returns:</span>
<span class="cm"> *	      None</span>
<span class="cm"> *</span>
<span class="cm"> *     Params:</span>
<span class="cm"> *	      dev	     The device structure of this device.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *     This function monitors PHY condition by reading the status</span>
<span class="cm"> *     register via the MII bus. This can be used to give info</span>
<span class="cm"> *     about link changes (up/down), and possible switch to alternate</span>
<span class="cm"> *     media.</span>
<span class="cm"> *</span>
<span class="cm"> *******************************************************************/</span>

<span class="kt">void</span> <span class="nf">tlan_phy_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>     <span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">phy_status</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_num</span><span class="p">];</span>

	<span class="cm">/* Get PHY status register */</span>
	<span class="n">tlan_mii_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MII_GEN_STS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_status</span><span class="p">);</span>

	<span class="cm">/* Check if link has been lost */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy_status</span> <span class="o">&amp;</span> <span class="n">MII_GS_LINK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TLAN: %s has lost link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">),</span> <span class="n">TLAN_TIMER_LINK_BEAT</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Link restablished? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy_status</span> <span class="o">&amp;</span> <span class="n">MII_GS_LINK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TLAN: %s has reestablished link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup a new monitor */</span>
	<span class="n">tlan_set_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">),</span> <span class="n">TLAN_TIMER_LINK_BEAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* MONITOR */</span><span class="cp"></span>


<span class="cm">/*****************************************************************************</span>
<span class="cm">******************************************************************************</span>

<span class="cm">ThunderLAN driver MII routines</span>

<span class="cm">these routines are based on the information in chap. 2 of the</span>
<span class="cm">&quot;ThunderLAN Programmer&#39;s Guide&quot;, pp. 15-24.</span>

<span class="cm">******************************************************************************</span>
<span class="cm">*****************************************************************************/</span>


<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_mii_read_reg</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		false	if ack received ok</span>
<span class="cm"> *		true	if no ack received or other error</span>
<span class="cm"> *</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		The device structure containing</span>
<span class="cm"> *				The io address and interrupt count</span>
<span class="cm"> *				for this device.</span>
<span class="cm"> *		phy		The address of the PHY to be queried.</span>
<span class="cm"> *		reg		The register whose contents are to be</span>
<span class="cm"> *				retrieved.</span>
<span class="cm"> *		val		A pointer to a variable to store the</span>
<span class="cm"> *				retrieved value.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function uses the TLAN&#39;s MII bus to retrieve the contents</span>
<span class="cm"> *	of a given register on a PHY.  It sends the appropriate info</span>
<span class="cm"> *	and then reads the 16-bit register value from the MII bus via</span>
<span class="cm"> *	the TLAN SIO register.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">tlan_mii_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">nack</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">sio</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">minten</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">sio</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="n">minten</span> <span class="o">=</span> <span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MINTEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minten</span><span class="p">)</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MINTEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* start (01b) */</span>
	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* read  (10b) */</span>
	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* device #      */</span>
	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* register #    */</span>


	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MTXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>	<span class="cm">/* change direction */</span>

	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>		<span class="cm">/* clock idle bit */</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>		<span class="cm">/* wait 300ns */</span>

	<span class="n">nack</span> <span class="o">=</span> <span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>	<span class="cm">/* check for ACK */</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>		<span class="cm">/* finish ACK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nack</span><span class="p">)</span> <span class="p">{</span>					<span class="cm">/* no ACK, so fake it */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
			<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>					<span class="cm">/* ACK, so read data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">))</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>		<span class="cm">/* idle cycle */</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minten</span><span class="p">)</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MINTEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_mii_send_data</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		base_port	The base IO port of the adapter	in</span>
<span class="cm"> *				question.</span>
<span class="cm"> *		dev		The address of the PHY to be queried.</span>
<span class="cm"> *		data		The value to be placed on the MII bus.</span>
<span class="cm"> *		num_bits	The number of bits in data that are to</span>
<span class="cm"> *				be placed on the MII bus.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function sends on sequence of bits on the MII</span>
<span class="cm"> *	configuration bus.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_mii_send_data</span><span class="p">(</span><span class="n">u16</span> <span class="n">base_port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">num_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_bits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">base_port</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">sio</span> <span class="o">=</span> <span class="n">base_port</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MTXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">num_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	TLan_MiiSync</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		base_port	The base IO port of the adapter in</span>
<span class="cm"> *				question.</span>
<span class="cm"> *</span>
<span class="cm"> *	This functions syncs all PHYs in terms of the MII configuration</span>
<span class="cm"> *	bus.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_mii_sync</span><span class="p">(</span><span class="n">u16</span> <span class="n">base_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sio</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">base_port</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">sio</span> <span class="o">=</span> <span class="n">base_port</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>

	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MTXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_mii_write_reg</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		dev		The device structure for the device</span>
<span class="cm"> *				to write to.</span>
<span class="cm"> *		phy		The address of the PHY to be written to.</span>
<span class="cm"> *		reg		The register whose contents are to be</span>
<span class="cm"> *				written.</span>
<span class="cm"> *		val		The value to be written to the register.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function uses the TLAN&#39;s MII bus to write the contents of a</span>
<span class="cm"> *	given register on a PHY.  It sends the appropriate info and then</span>
<span class="cm"> *	writes the 16-bit register value from the MII configuration bus</span>
<span class="cm"> *	via the TLAN SIO register.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tlan_mii_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">sio</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">minten</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">sio</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tlan_mii_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="n">minten</span> <span class="o">=</span> <span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MINTEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minten</span><span class="p">)</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MINTEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* start (01b) */</span>
	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* write (01b) */</span>
	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* device #      */</span>
	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* register #    */</span>

	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* send ACK */</span>
	<span class="n">tlan_mii_send_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* send data */</span>

	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>	<span class="cm">/* idle cycle */</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MCLK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minten</span><span class="p">)</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_MINTEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>




<span class="cm">/*****************************************************************************</span>
<span class="cm">******************************************************************************</span>

<span class="cm">ThunderLAN driver eeprom routines</span>

<span class="cm">the Compaq netelligent 10 and 10/100 cards use a microchip 24C02A</span>
<span class="cm">EEPROM.  these functions are based on information in microchip&#39;s</span>
<span class="cm">data sheet.  I don&#39;t know how well this functions will work with</span>
<span class="cm">other Eeproms.</span>

<span class="cm">******************************************************************************</span>
<span class="cm">*****************************************************************************/</span>


<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_ee_send_start</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		io_base		The IO port base address for the</span>
<span class="cm"> *				TLAN device with the EEPROM to</span>
<span class="cm"> *				use.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function sends a start cycle to an EEPROM attached</span>
<span class="cm"> *	to a TLAN chip.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_ee_send_start</span><span class="p">(</span><span class="n">u16</span> <span class="n">io_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">sio</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">sio</span> <span class="o">=</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>

	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ETXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_ee_send_byte</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		If the correct ack was received, 0, otherwise 1</span>
<span class="cm"> *	Parms:	io_base		The IO port base address for the</span>
<span class="cm"> *				TLAN device with the EEPROM to</span>
<span class="cm"> *				use.</span>
<span class="cm"> *		data		The 8 bits of information to</span>
<span class="cm"> *				send to the EEPROM.</span>
<span class="cm"> *		stop		If TLAN_EEPROM_STOP is passed, a</span>
<span class="cm"> *				stop cycle is sent after the</span>
<span class="cm"> *				byte is sent after the ack is</span>
<span class="cm"> *				read.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function sends a byte on the serial EEPROM line,</span>
<span class="cm"> *	driving the clock to send each bit. The function then</span>
<span class="cm"> *	reverses transmission direction and reads an acknowledge</span>
<span class="cm"> *	bit.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_ee_send_byte</span><span class="p">(</span><span class="n">u16</span> <span class="n">io_base</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">place</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">sio</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">sio</span> <span class="o">=</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>

	<span class="cm">/* Assume clock is low, tx is enabled; */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">place</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">place</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">place</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">place</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
			<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ETXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ETXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* STOP, raise data while clock is high */</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_ee_receive_byte</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		Nothing</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		io_base		The IO port base address for the</span>
<span class="cm"> *				TLAN device with the EEPROM to</span>
<span class="cm"> *				use.</span>
<span class="cm"> *		data		An address to a char to hold the</span>
<span class="cm"> *				data sent from the EEPROM.</span>
<span class="cm"> *		stop		If TLAN_EEPROM_STOP is passed, a</span>
<span class="cm"> *				stop cycle is sent after the</span>
<span class="cm"> *				byte is received, and no ack is</span>
<span class="cm"> *				sent.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function receives 8 bits of data from the EEPROM</span>
<span class="cm"> *	over the serial link.  It then sends and ack bit, or no</span>
<span class="cm"> *	ack and a stop bit.  This function is used to retrieve</span>
<span class="cm"> *	data after the address of a byte in the EEPROM has been</span>
<span class="cm"> *	sent.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlan_ee_receive_byte</span><span class="p">(</span><span class="n">u16</span> <span class="n">io_base</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>  <span class="n">place</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sio</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TLAN_NET_SIO</span><span class="p">,</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">TLAN_DIO_ADR</span><span class="p">);</span>
	<span class="n">sio</span> <span class="o">=</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">TLAN_DIO_DATA</span> <span class="o">+</span> <span class="n">TLAN_NET_SIO</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Assume clock is low, tx is enabled; */</span>
	<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ETXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">place</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">place</span><span class="p">;</span> <span class="n">place</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tlan_get_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">))</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="n">place</span><span class="p">;</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ETXEN</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span> <span class="cm">/* ack = 0 */</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>	<span class="cm">/* no ack = 1 (?) */</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="cm">/* STOP, raise data while clock is high */</span>
		<span class="n">tlan_clear_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_ECLOK</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
		<span class="n">tlan_set_bit</span><span class="p">(</span><span class="n">TLAN_NET_SIO_EDATA</span><span class="p">,</span> <span class="n">sio</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>




<span class="cm">/***************************************************************</span>
<span class="cm"> *	tlan_ee_read_byte</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		No error = 0, else, the stage at which the error</span>
<span class="cm"> *		occurred.</span>
<span class="cm"> *	Parms:</span>
<span class="cm"> *		io_base		The IO port base address for the</span>
<span class="cm"> *				TLAN device with the EEPROM to</span>
<span class="cm"> *				use.</span>
<span class="cm"> *		ee_addr		The address of the byte in the</span>
<span class="cm"> *				EEPROM whose contents are to be</span>
<span class="cm"> *				retrieved.</span>
<span class="cm"> *		data		An address to a char to hold the</span>
<span class="cm"> *				data obtained from the EEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function reads a byte of information from an byte</span>
<span class="cm"> *	cell in the EEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlan_ee_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ee_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlan_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tlan_ee_send_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tlan_ee_send_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="n">TLAN_EEPROM_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tlan_ee_send_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">,</span> <span class="n">TLAN_EEPROM_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tlan_ee_send_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tlan_ee_send_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="n">TLAN_EEPROM_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tlan_ee_receive_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TLAN_EEPROM_STOP</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
