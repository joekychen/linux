<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › oki-semi › pch_gbe › pch_gbe_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>pch_gbe_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 1999 - 2010 Intel Corporation.</span>
<span class="cm"> * Copyright (C) 2010 - 2012 LAPIS SEMICONDUCTOR CO., LTD.</span>
<span class="cm"> *</span>
<span class="cm"> * This code was derived from the Intel e1000e Linux driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;pch_gbe.h&quot;</span>
<span class="cp">#include &quot;pch_gbe_api.h&quot;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#ifdef CONFIG_PCH_PTP</span>
<span class="cp">#include &lt;linux/net_tstamp.h&gt;</span>
<span class="cp">#include &lt;linux/ptp_classify.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define DRV_VERSION     &quot;1.00&quot;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">pch_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_VERSION</span><span class="p">;</span>

<span class="cp">#define PCI_DEVICE_ID_INTEL_IOH1_GBE	0x8802		</span><span class="cm">/* Pci device ID */</span><span class="cp"></span>
<span class="cp">#define PCH_GBE_MAR_ENTRIES		16</span>
<span class="cp">#define PCH_GBE_SHORT_PKT		64</span>
<span class="cp">#define DSC_INIT16			0xC000</span>
<span class="cp">#define PCH_GBE_DMA_ALIGN		0</span>
<span class="cp">#define PCH_GBE_DMA_PADDING		2</span>
<span class="cp">#define PCH_GBE_WATCHDOG_PERIOD		(1 * HZ)	</span><span class="cm">/* watchdog time */</span><span class="cp"></span>
<span class="cp">#define PCH_GBE_COPYBREAK_DEFAULT	256</span>
<span class="cp">#define PCH_GBE_PCI_BAR			1</span>
<span class="cp">#define PCH_GBE_RESERVE_MEMORY		0x200000	</span><span class="cm">/* 2MB */</span><span class="cp"></span>

<span class="cm">/* Macros for ML7223 */</span>
<span class="cp">#define PCI_VENDOR_ID_ROHM			0x10db</span>
<span class="cp">#define PCI_DEVICE_ID_ROHM_ML7223_GBE		0x8013</span>

<span class="cm">/* Macros for ML7831 */</span>
<span class="cp">#define PCI_DEVICE_ID_ROHM_ML7831_GBE		0x8802</span>

<span class="cp">#define PCH_GBE_TX_WEIGHT         64</span>
<span class="cp">#define PCH_GBE_RX_WEIGHT         64</span>
<span class="cp">#define PCH_GBE_RX_BUFFER_WRITE   16</span>

<span class="cm">/* Initialize the wake-on-LAN settings */</span>
<span class="cp">#define PCH_GBE_WL_INIT_SETTING    (PCH_GBE_WLC_MP)</span>

<span class="cp">#define PCH_GBE_MAC_RGMII_CTRL_SETTING ( \</span>
<span class="cp">	PCH_GBE_CHIP_TYPE_INTERNAL | \</span>
<span class="cp">	PCH_GBE_RGMII_MODE_RGMII     \</span>
<span class="cp">	)</span>

<span class="cm">/* Ethertype field values */</span>
<span class="cp">#define PCH_GBE_MAX_RX_BUFFER_SIZE      0x2880</span>
<span class="cp">#define PCH_GBE_MAX_JUMBO_FRAME_SIZE    10318</span>
<span class="cp">#define PCH_GBE_FRAME_SIZE_2048         2048</span>
<span class="cp">#define PCH_GBE_FRAME_SIZE_4096         4096</span>
<span class="cp">#define PCH_GBE_FRAME_SIZE_8192         8192</span>

<span class="cp">#define PCH_GBE_GET_DESC(R, i, type)    (&amp;(((struct type *)((R).desc))[i]))</span>
<span class="cp">#define PCH_GBE_RX_DESC(R, i)           PCH_GBE_GET_DESC(R, i, pch_gbe_rx_desc)</span>
<span class="cp">#define PCH_GBE_TX_DESC(R, i)           PCH_GBE_GET_DESC(R, i, pch_gbe_tx_desc)</span>
<span class="cp">#define PCH_GBE_DESC_UNUSED(R) \</span>
<span class="cp">	((((R)-&gt;next_to_clean &gt; (R)-&gt;next_to_use) ? 0 : (R)-&gt;count) + \</span>
<span class="cp">	(R)-&gt;next_to_clean - (R)-&gt;next_to_use - 1)</span>

<span class="cm">/* Pause packet value */</span>
<span class="cp">#define	PCH_GBE_PAUSE_PKT1_VALUE    0x00C28001</span>
<span class="cp">#define	PCH_GBE_PAUSE_PKT2_VALUE    0x00000100</span>
<span class="cp">#define	PCH_GBE_PAUSE_PKT4_VALUE    0x01000888</span>
<span class="cp">#define	PCH_GBE_PAUSE_PKT5_VALUE    0x0000FFFF</span>


<span class="cm">/* This defines the bits that are set in the Interrupt Mask</span>
<span class="cm"> * Set/Read Register.  Each bit is documented below:</span>
<span class="cm"> *   o RXT0   = Receiver Timer Interrupt (ring 0)</span>
<span class="cm"> *   o TXDW   = Transmit Descriptor Written Back</span>
<span class="cm"> *   o RXDMT0 = Receive Descriptor Minimum Threshold hit (ring 0)</span>
<span class="cm"> *   o RXSEQ  = Receive Sequence Error</span>
<span class="cm"> *   o LSC    = Link Status Change</span>
<span class="cm"> */</span>
<span class="cp">#define PCH_GBE_INT_ENABLE_MASK ( \</span>
<span class="cp">	PCH_GBE_INT_RX_DMA_CMPLT |    \</span>
<span class="cp">	PCH_GBE_INT_RX_DSC_EMP   |    \</span>
<span class="cp">	PCH_GBE_INT_RX_FIFO_ERR  |    \</span>
<span class="cp">	PCH_GBE_INT_WOL_DET      |    \</span>
<span class="cp">	PCH_GBE_INT_TX_CMPLT          \</span>
<span class="cp">	)</span>

<span class="cp">#define PCH_GBE_INT_DISABLE_ALL		0</span>

<span class="cp">#ifdef CONFIG_PCH_PTP</span>
<span class="cm">/* Macros for ieee1588 */</span>
<span class="cm">/* 0x40 Time Synchronization Channel Control Register Bits */</span>
<span class="cp">#define MASTER_MODE   (1&lt;&lt;0)</span>
<span class="cp">#define SLAVE_MODE    (0)</span>
<span class="cp">#define V2_MODE       (1&lt;&lt;31)</span>
<span class="cp">#define CAP_MODE0     (0)</span>
<span class="cp">#define CAP_MODE2     (1&lt;&lt;17)</span>

<span class="cm">/* 0x44 Time Synchronization Channel Event Register Bits */</span>
<span class="cp">#define TX_SNAPSHOT_LOCKED (1&lt;&lt;0)</span>
<span class="cp">#define RX_SNAPSHOT_LOCKED (1&lt;&lt;1)</span>

<span class="cp">#define PTP_L4_MULTICAST_SA &quot;01:00:5e:00:01:81&quot;</span>
<span class="cp">#define PTP_L2_MULTICAST_SA &quot;01:1b:19:00:00:00&quot;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">copybreak</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">PCH_GBE_COPYBREAK_DEFAULT</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pch_gbe_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pch_gbe_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pch_gbe_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCH_PTP</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock_filter</span> <span class="n">ptp_filter</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PTP_FILTER</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_ptp_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">uid_hi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">uid_lo</span><span class="p">,</span> <span class="n">u16</span> <span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk_run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ptp_filter</span><span class="p">)</span> <span class="o">==</span> <span class="n">PTP_CLASS_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">IPV4_HLEN</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">UDP_HLEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">OFF_PTP_SEQUENCE_ID</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">seqid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">OFF_PTP_SOURCE_UUID</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">OFF_PTP_SEQUENCE_ID</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lo</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">uid_hi</span> <span class="o">==</span> <span class="o">*</span><span class="n">hi</span> <span class="o">&amp;&amp;</span>
		<span class="n">uid_lo</span> <span class="o">==</span> <span class="n">lo</span> <span class="o">&amp;&amp;</span>
		<span class="n">seqid</span>  <span class="o">==</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pch_rx_timestamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">skb_shared_hwtstamps</span> <span class="o">*</span><span class="n">shhwtstamps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">uid</span><span class="p">,</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_rx_en</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Get ieee1588&#39;s dev information */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ptp_pdev</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">pch_ch_event_read</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RX_SNAPSHOT_LOCKED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">pch_src_uuid_lo_read</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">pch_src_uuid_hi_read</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">uid</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pch_ptp_match</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="n">uid</span><span class="p">),</span> <span class="n">htonl</span><span class="p">(</span><span class="n">lo</span><span class="p">),</span> <span class="n">htons</span><span class="p">(</span><span class="n">seq</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">pch_rx_snap_read</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">shhwtstamps</span> <span class="o">=</span> <span class="n">skb_hwtstamps</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">shhwtstamps</span><span class="p">));</span>
	<span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">pch_ch_event_write</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_SNAPSHOT_LOCKED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pch_tx_timestamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">skb_shared_hwtstamps</span> <span class="n">shhwtstamps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_shared_info</span> <span class="o">*</span><span class="n">shtx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">shtx</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">shtx</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">SKBTX_HW_TSTAMP</span> <span class="o">&amp;&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_tx_en</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shtx</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">SKBTX_IN_PROGRESS</span><span class="p">;</span>

	<span class="cm">/* Get ieee1588&#39;s dev information */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ptp_pdev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This really stinks, but we have to poll for the Tx time stamp.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">pch_ch_event_read</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TX_SNAPSHOT_LOCKED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TX_SNAPSHOT_LOCKED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shtx</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKBTX_IN_PROGRESS</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">pch_tx_snap_read</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="p">));</span>
	<span class="n">shhwtstamps</span><span class="p">.</span><span class="n">hwtstamp</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="n">skb_tstamp_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="p">);</span>

	<span class="n">pch_ch_event_write</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_SNAPSHOT_LOCKED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwtstamp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwtstamp_config</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">station</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="cm">/* reserved for future extensions */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Get ieee1588&#39;s dev information */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ptp_pdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">tx_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_TX_OFF</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_tx_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_TX_ON</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_tx_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">rx_filter</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_NONE</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_rx_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_SYNC</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_rx_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pch_ch_control_write</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SLAVE_MODE</span> <span class="o">|</span> <span class="n">CAP_MODE0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_DELAY_REQ</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_rx_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pch_ch_control_write</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MASTER_MODE</span> <span class="o">|</span> <span class="n">CAP_MODE0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_EVENT</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_rx_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pch_ch_control_write</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">V2_MODE</span> <span class="o">|</span> <span class="n">CAP_MODE2</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">PTP_L4_MULTICAST_SA</span><span class="p">);</span>
		<span class="n">pch_set_station_address</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_EVENT</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hwts_rx_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pch_ch_control_write</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">V2_MODE</span> <span class="o">|</span> <span class="n">CAP_MODE2</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">PTP_L2_MULTICAST_SA</span><span class="p">);</span>
		<span class="n">pch_set_station_address</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear out any old time stamps. */</span>
	<span class="n">pch_ch_event_write</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_SNAPSHOT_LOCKED</span> <span class="o">|</span> <span class="n">RX_SNAPSHOT_LOCKED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_load_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MAC_ADDR_LOAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_read_mac_addr - Read MAC address</span>
<span class="cm"> * @hw:	            Pointer to the HW structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:			Successful.</span>
<span class="cm"> */</span>
<span class="n">s32</span> <span class="nf">pch_gbe_mac_read_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">adr1a</span><span class="p">,</span> <span class="n">adr1b</span><span class="p">;</span>

	<span class="n">adr1a</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">high</span><span class="p">);</span>
	<span class="n">adr1b</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">low</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">adr1a</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">adr1a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">adr1a</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">adr1a</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">adr1b</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">adr1b</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hw-&gt;mac.addr : %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_wait_clr_bit - Wait to clear a bit</span>
<span class="cm"> * @reg:	Pointer of register</span>
<span class="cm"> * @busy:	Busy bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_wait_clr_bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="cm">/* wait busy */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error: busy bit is not cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_wait_clr_bit_irq - Wait to clear a bit for interrupt context</span>
<span class="cm"> * @reg:	Pointer of register</span>
<span class="cm"> * @busy:	Busy bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_wait_clr_bit_irq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* wait busy */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error: busy bit is not cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_mar_set - Set MAC address register</span>
<span class="cm"> * @hw:	    Pointer to the HW structure</span>
<span class="cm"> * @addr:   Pointer to the MAC address</span>
<span class="cm"> * @index:  MAC address array register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_mar_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mar_low</span><span class="p">,</span> <span class="n">mar_high</span><span class="p">,</span> <span class="n">adrmask</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;index : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * HW expects these in little endian so we reverse the byte order</span>
<span class="cm">	 * from network order (big endian) to little endian</span>
<span class="cm">	 */</span>
	<span class="n">mar_high</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">mar_low</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="cm">/* Stop the MAC Address of index. */</span>
	<span class="n">adrmask</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">adrmask</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x0001</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">);</span>
	<span class="cm">/* wait busy */</span>
	<span class="n">pch_gbe_wait_clr_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">,</span> <span class="n">PCH_GBE_BUSY</span><span class="p">);</span>
	<span class="cm">/* Set the MAC address to the MAC address 1A/1B register */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">mar_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">high</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">mar_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">low</span><span class="p">);</span>
	<span class="cm">/* Start the MAC address of index */</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">adrmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0001</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">);</span>
	<span class="cm">/* wait busy */</span>
	<span class="n">pch_gbe_wait_clr_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">,</span> <span class="n">PCH_GBE_BUSY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_reset_hw - Reset hardware</span>
<span class="cm"> * @hw:	Pointer to the HW structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_reset_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Read the MAC address. and store to the private data */</span>
	<span class="n">pch_gbe_mac_read_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_ALL_RST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RESET</span><span class="p">);</span>
<span class="cp">#ifdef PCH_GBE_MAC_IFOP_RGMII</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_MODE_GMII_ETHER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MODE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pch_gbe_wait_clr_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RESET</span><span class="p">,</span> <span class="n">PCH_GBE_ALL_RST</span><span class="p">);</span>
	<span class="cm">/* Setup the receive addresses */</span>
	<span class="n">pch_gbe_mac_mar_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_reset_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Read the MAC addresses. and store to the private data */</span>
	<span class="n">pch_gbe_mac_read_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_RX_RST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RESET</span><span class="p">);</span>
	<span class="n">pch_gbe_wait_clr_bit_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RESET</span><span class="p">,</span> <span class="n">PCH_GBE_RX_RST</span><span class="p">);</span>
	<span class="cm">/* Setup the MAC addresses */</span>
	<span class="n">pch_gbe_mac_mar_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_init_rx_addrs - Initialize receive address&#39;s</span>
<span class="cm"> * @hw:	Pointer to the HW structure</span>
<span class="cm"> * @mar_count: Receive address registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_init_rx_addrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mar_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Setup the receive address */</span>
	<span class="n">pch_gbe_mac_mar_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Zero out the other receive addresses */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mar_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">low</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0xFFFE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">);</span>
	<span class="cm">/* wait busy */</span>
	<span class="n">pch_gbe_wait_clr_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">,</span> <span class="n">PCH_GBE_BUSY</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_mc_addr_list_update - Update Multicast addresses</span>
<span class="cm"> * @hw:	            Pointer to the HW structure</span>
<span class="cm"> * @mc_addr_list:   Array of multicast addresses to program</span>
<span class="cm"> * @mc_addr_count:  Number of multicast addresses to program</span>
<span class="cm"> * @mar_used_count: The first MAC Address register free to program</span>
<span class="cm"> * @mar_total_num:  Total number of supported MAC Address Registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_mc_addr_list_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="o">*</span><span class="n">mc_addr_list</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mc_addr_count</span><span class="p">,</span>
					    <span class="n">u32</span> <span class="n">mar_used_count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mar_total_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">adrmask</span><span class="p">;</span>

	<span class="cm">/* Load the first set of multicast addresses into the exact</span>
<span class="cm">	 * filters (RAR).  If there are not enough to fill the RAR</span>
<span class="cm">	 * array, clear the filters.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">mar_used_count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mar_total_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc_addr_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pch_gbe_mac_mar_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mc_addr_list</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">mc_addr_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">mc_addr_list</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Clear MAC address mask */</span>
			<span class="n">adrmask</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">((</span><span class="n">adrmask</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x0001</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)),</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">);</span>
			<span class="cm">/* wait busy */</span>
			<span class="n">pch_gbe_wait_clr_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">,</span> <span class="n">PCH_GBE_BUSY</span><span class="p">);</span>
			<span class="cm">/* Clear MAC address */</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">low</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_force_mac_fc - Force the MAC&#39;s flow control settings</span>
<span class="cm"> * @hw:	            Pointer to the HW structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:			Successful.</span>
<span class="cm"> *	Negative value:		Failed.</span>
<span class="cm"> */</span>
<span class="n">s32</span> <span class="nf">pch_gbe_mac_force_mac_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_fctrl</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mac-&gt;fc = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">);</span>

	<span class="n">rx_fctrl</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_FCTRL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCH_GBE_FC_NONE</span>:
		<span class="n">rx_fctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_FL_CTRL_EN</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_fc_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCH_GBE_FC_RX_PAUSE</span>:
		<span class="n">rx_fctrl</span> <span class="o">|=</span> <span class="n">PCH_GBE_FL_CTRL_EN</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_fc_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCH_GBE_FC_TX_PAUSE</span>:
		<span class="n">rx_fctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_FL_CTRL_EN</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_fc_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCH_GBE_FC_FULL</span>:
		<span class="n">rx_fctrl</span> <span class="o">|=</span> <span class="n">PCH_GBE_FL_CTRL_EN</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_fc_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Flow control param set incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="n">rx_fctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_FL_CTRL_EN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rx_fctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_FCTRL</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RX_FCTRL reg : 0x%08x  mac-&gt;tx_fc_enable : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_FCTRL</span><span class="p">),</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">tx_fc_enable</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_set_wol_event - Set wake-on-lan event</span>
<span class="cm"> * @hw:     Pointer to the HW structure</span>
<span class="cm"> * @wu_evt: Wake up event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_set_wol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wu_evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr_mask</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;wu_evt : 0x%08x  ADDR_MASK reg : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">wu_evt</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wu_evt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set Wake-On-Lan address mask */</span>
		<span class="n">addr_mask</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ADDR_MASK</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">addr_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">WOL_ADDR_MASK</span><span class="p">);</span>
		<span class="cm">/* wait busy */</span>
		<span class="n">pch_gbe_wait_clr_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">WOL_ADDR_MASK</span><span class="p">,</span> <span class="n">PCH_GBE_WLA_BUSY</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">WOL_ST</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">((</span><span class="n">wu_evt</span> <span class="o">|</span> <span class="n">PCH_GBE_WLC_WOL_MODE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">WOL_CTRL</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TCPIP_ACC</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_INT_ENABLE_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">WOL_CTRL</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">WOL_ST</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_ctrl_miim - Control MIIM interface</span>
<span class="cm"> * @hw:   Pointer to the HW structure</span>
<span class="cm"> * @addr: Address of PHY</span>
<span class="cm"> * @dir:  Operetion. (Write or Read)</span>
<span class="cm"> * @reg:  Access register of PHY</span>
<span class="cm"> * @data: Write data.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: Read date.</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="nf">pch_gbe_mac_ctrl_miim</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">miim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MIIM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_MIIM_OPER_READY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pch-gbe.miim won&#39;t go Ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">miim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No way to indicate timeout error */</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">PCH_GBE_MIIM_REG_ADDR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">PCH_GBE_MIIM_PHY_ADDR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">dir</span> <span class="o">|</span> <span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MIIM</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">data_out</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MIIM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data_out</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_MIIM_OPER_READY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">miim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PHY %s: reg=%d, data=0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dir</span> <span class="o">==</span> <span class="n">PCH_GBE_MIIM_OPER_READ</span> <span class="o">?</span> <span class="s">&quot;READ&quot;</span> <span class="o">:</span> <span class="s">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
		 <span class="n">dir</span> <span class="o">==</span> <span class="n">PCH_GBE_MIIM_OPER_READ</span> <span class="o">?</span> <span class="n">data_out</span> <span class="o">:</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">data_out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mac_set_pause_packet - Set pause packet</span>
<span class="cm"> * @hw:   Pointer to the HW structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mac_set_pause_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">;</span>

	<span class="cm">/* Set Pause packet */</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">PCH_GBE_PAUSE_PKT2_VALUE</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">tmp3</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">tmp3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">tmp3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">tmp3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_PAUSE_PKT1_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT1</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tmp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT2</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tmp3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT3</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_PAUSE_PKT4_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT4</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_PAUSE_PKT5_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT5</span><span class="p">);</span>

	<span class="cm">/* Transmit Pause Packet */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_PS_PKT_RQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_REQ</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PAUSE_PKT1-5 reg : 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT1</span><span class="p">),</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT2</span><span class="p">),</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT3</span><span class="p">),</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT4</span><span class="p">),</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">PAUSE_PKT5</span><span class="p">));</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * pch_gbe_alloc_queues - Allocate memory for all rings</span>
<span class="cm"> * @adapter:  Board private structure to initialize</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:	Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_alloc_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_init_stats - Initialize status</span>
<span class="cm"> * @adapter:  Board private structure to initialize</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_init_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_init_phy - Initialize PHY</span>
<span class="cm"> * @adapter:  Board private structure to initialize</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:	Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="cm">/* Discover phy addr by searching addrs in order {1,0,2,..., 31} */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">PCH_GBE_PHY_REGS_LEN</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">pch_gbe_mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">pch_gbe_mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">pch_gbe_mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">bmcr</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;phy_addr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="cm">/* Selected the phy and isolate the rest */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">PCH_GBE_PHY_REGS_LEN</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pch_gbe_mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
					   <span class="n">BMCR_ISOLATE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="n">pch_gbe_mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="n">pch_gbe_mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
					   <span class="n">bmcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BMCR_ISOLATE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* MII setup */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">pch_gbe_mdio_read</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">pch_gbe_mdio_write</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">supports_gmii</span> <span class="o">=</span> <span class="n">mii_check_gmii_support</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mdio_read - The read function for mii</span>
<span class="cm"> * @netdev: Network interface device structure</span>
<span class="cm"> * @addr:   Phy ID</span>
<span class="cm"> * @reg:    Access location</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:	Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pch_gbe_mac_ctrl_miim</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">PCH_GBE_HAL_MIIM_READ</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_mdio_write - The write function for mii</span>
<span class="cm"> * @netdev: Network interface device structure</span>
<span class="cm"> * @addr:   Phy ID (not used)</span>
<span class="cm"> * @reg:    Access location</span>
<span class="cm"> * @data:   Write data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">pch_gbe_mac_ctrl_miim</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">PCH_GBE_HAL_MIIM_WRITE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_reset_task - Reset processing at the time of transmission timeout</span>
<span class="cm"> * @work:  Pointer of board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_reset_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pch_gbe_adapter</span><span class="p">,</span> <span class="n">reset_task</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">pch_gbe_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_reinit_locked- Re-initialization</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pch_gbe_reinit_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pch_gbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pch_gbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_reset - Reset GbE</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pch_gbe_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pch_gbe_mac_reset_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* reprogram multicast address register after reset */</span>
	<span class="n">pch_gbe_set_multi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="cm">/* Setup the receive address. */</span>
	<span class="n">pch_gbe_mac_init_rx_addrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCH_GBE_MAR_ENTRIES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pch_gbe_hal_init_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Hardware Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_free_irq - Free an interrupt</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;call pci_disable_msi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_irq_disable - Mask off interrupt generation on the NIC</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_sem</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_ST</span><span class="p">);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INT_EN reg : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_irq_enable - Enable default interrupt generation settings</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_sem</span><span class="p">)))</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_INT_ENABLE_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_ST</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INT_EN reg : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">));</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * pch_gbe_setup_tctl - configure the Transmit control registers</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_setup_tctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_mode</span><span class="p">,</span> <span class="n">tcpip</span><span class="p">;</span>

	<span class="n">tx_mode</span> <span class="o">=</span> <span class="n">PCH_GBE_TM_LONG_PKT</span> <span class="o">|</span>
		<span class="n">PCH_GBE_TM_ST_AND_FD</span> <span class="o">|</span>
		<span class="n">PCH_GBE_TM_SHORT_PKT</span> <span class="o">|</span>
		<span class="n">PCH_GBE_TM_TH_TX_STRT_8</span> <span class="o">|</span>
		<span class="n">PCH_GBE_TM_TH_ALM_EMP_4</span> <span class="o">|</span> <span class="n">PCH_GBE_TM_TH_ALM_FULL_8</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tx_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TX_MODE</span><span class="p">);</span>

	<span class="n">tcpip</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TCPIP_ACC</span><span class="p">);</span>
	<span class="n">tcpip</span> <span class="o">|=</span> <span class="n">PCH_GBE_TX_TCPIPACC_EN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tcpip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TCPIP_ACC</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_configure_tx - Configure Transmit Unit after Reset</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_configure_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tdba</span><span class="p">,</span> <span class="n">tdlen</span><span class="p">,</span> <span class="n">dctrl</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma addr = 0x%08llx  size = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
		 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Setup the HW Tx Head and Tail descriptor pointers */</span>
	<span class="n">tdba</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">tdlen</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tdba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TX_DSC_BASE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tdlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TX_DSC_SIZE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tdba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TX_DSC_SW_P</span><span class="p">);</span>

	<span class="cm">/* Enables Transmission DMA */</span>
	<span class="n">dctrl</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>
	<span class="n">dctrl</span> <span class="o">|=</span> <span class="n">PCH_GBE_TX_DMA_EN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_setup_rctl - Configure the receive control registers</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_setup_rctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_mode</span><span class="p">,</span> <span class="n">tcpip</span><span class="p">;</span>

	<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">PCH_GBE_ADD_FIL_EN</span> <span class="o">|</span> <span class="n">PCH_GBE_MLT_FIL_EN</span> <span class="o">|</span>
	<span class="n">PCH_GBE_RH_ALM_EMP_4</span> <span class="o">|</span> <span class="n">PCH_GBE_RH_ALM_FULL_4</span> <span class="o">|</span> <span class="n">PCH_GBE_RH_RD_TRG_8</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rx_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_MODE</span><span class="p">);</span>

	<span class="n">tcpip</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TCPIP_ACC</span><span class="p">);</span>

	<span class="n">tcpip</span> <span class="o">|=</span> <span class="n">PCH_GBE_RX_TCPIPACC_OFF</span><span class="p">;</span>
	<span class="n">tcpip</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_RX_TCPIPACC_EN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tcpip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TCPIP_ACC</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_configure_rx - Configure Receive Unit after Reset</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_configure_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rdba</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">,</span> <span class="n">rctl</span><span class="p">,</span> <span class="n">rxdma</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma adr = 0x%08llx  size = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
		 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">pch_gbe_mac_force_mac_fc</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Disables Receive MAC */</span>
	<span class="n">rctl</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MAC_RX_EN</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">rctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCH_GBE_MRE_MAC_RX_EN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MAC_RX_EN</span><span class="p">);</span>

	<span class="cm">/* Disables Receive DMA */</span>
	<span class="n">rxdma</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>
	<span class="n">rxdma</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_RX_DMA_EN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rxdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MAC_RX_EN reg = 0x%08x  DMA_CTRL reg = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MAC_RX_EN</span><span class="p">),</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">));</span>

	<span class="cm">/* Setup the HW Rx Head and Tail Descriptor Pointers and</span>
<span class="cm">	 * the Base and Length of the Rx Descriptor Ring */</span>
	<span class="n">rdba</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">rdlen</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rdba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_DSC_BASE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rdlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_DSC_SIZE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">rdba</span> <span class="o">+</span> <span class="n">rdlen</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_DSC_SW_P</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_unmap_and_free_tx_resource - Unmap and free tx socket buffer</span>
<span class="cm"> * @adapter:     Board private structure</span>
<span class="cm"> * @buffer_info: Buffer information structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_unmap_and_free_tx_resource</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_unmap_and_free_rx_resource - Unmap and free rx socket buffer</span>
<span class="cm"> * @adapter:      Board private structure</span>
<span class="cm"> * @buffer_info:  Buffer information structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_unmap_and_free_rx_resource</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_clean_tx_ring - Free Tx Buffers</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * @tx_ring:  Ring to be cleaned</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_clean_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Free all the Tx ring sk_buffs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pch_gbe_unmap_and_free_tx_resource</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;call pch_gbe_unmap_and_free_tx_resource() %d count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Zero out the descriptor ring */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TX_DSC_HW_P</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TX_DSC_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_clean_rx_ring - Free Rx Buffers</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * @rx_ring:  Ring to free buffers from</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pch_gbe_clean_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Free all the Rx ring sk_buffs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pch_gbe_unmap_and_free_rx_resource</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;call pch_gbe_unmap_and_free_rx_resource() %d count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Zero out the descriptor ring */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_DSC_HW_P</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_DSC_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_set_rgmii_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rgmii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the RGMII control. */</span>
<span class="cp">#ifdef PCH_GBE_MAC_IFOP_RGMII</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
		<span class="n">rgmii</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCH_GBE_RGMII_RATE_2_5M</span> <span class="o">|</span>
			 <span class="n">PCH_GBE_MAC_RGMII_CTRL_SETTING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">rgmii</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCH_GBE_RGMII_RATE_25M</span> <span class="o">|</span>
			 <span class="n">PCH_GBE_MAC_RGMII_CTRL_SETTING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="n">rgmii</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCH_GBE_RGMII_RATE_125M</span> <span class="o">|</span>
			 <span class="n">PCH_GBE_MAC_RGMII_CTRL_SETTING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rgmii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RGMII_CTRL</span><span class="p">);</span>
<span class="cp">#else	</span><span class="cm">/* GMII */</span><span class="cp"></span>
	<span class="n">rgmii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rgmii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RGMII_CTRL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the communication mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">PCH_GBE_MODE_MII_ETHER</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">PCH_GBE_MODE_MII_ETHER</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">PCH_GBE_MODE_GMII_ETHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">PCH_GBE_MODE_FULL_DUPLEX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">PCH_GBE_MODE_HALF_DUPLEX</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_watchdog - Watchdog process</span>
<span class="cm"> * @data:  Board private structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;right now = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">pch_gbe_update_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ETHTOOL_GSET</span> <span class="p">};</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span><span class="p">;</span>
		<span class="cm">/* mii library handles link maintenance tasks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ethtool get setting Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span>
				  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span>
						<span class="n">PCH_GBE_WATCHDOG_PERIOD</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>
		<span class="cm">/* Set the RGMII control. */</span>
		<span class="n">pch_gbe_set_rgmii_ctrl</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_speed</span><span class="p">,</span>
						<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_duplex</span><span class="p">);</span>
		<span class="cm">/* Set the communication mode */</span>
		<span class="n">pch_gbe_set_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_speed</span><span class="p">,</span>
				 <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_duplex</span><span class="p">);</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="s">&quot;Link is Up %d Mbps %s-Duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_speed</span><span class="p">,</span>
			   <span class="n">cmd</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">?</span> <span class="s">&quot;Full&quot;</span> <span class="o">:</span> <span class="s">&quot;Half&quot;</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;NIC Link is Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span>
		  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">PCH_GBE_WATCHDOG_PERIOD</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_tx_queue - Carry out queuing of the transmission data</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * @tx_ring:  Tx descriptor ring structure</span>
<span class="cm"> * @skb:      Sockt buffer structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp_skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ring_num</span><span class="p">;</span>

	<span class="cm">/*-- Set frame control --*/</span>
	<span class="n">frame_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">PCH_GBE_SHORT_PKT</span><span class="p">))</span>
		<span class="n">frame_ctrl</span> <span class="o">|=</span> <span class="n">PCH_GBE_TXD_CTRL_APAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_NONE</span><span class="p">)</span>
		<span class="n">frame_ctrl</span> <span class="o">|=</span> <span class="n">PCH_GBE_TXD_CTRL_TCPIP_ACC_OFF</span><span class="p">;</span>

	<span class="cm">/* Performs checksum processing */</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is because the hardware accelerator does not support a checksum,</span>
<span class="cm">	 * when the received data size is less than 64 bytes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">PCH_GBE_SHORT_PKT</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">!=</span> <span class="n">CHECKSUM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame_ctrl</span> <span class="o">|=</span> <span class="n">PCH_GBE_TXD_CTRL_APAD</span> <span class="o">|</span>
			      <span class="n">PCH_GBE_TXD_CTRL_TCPIP_ACC_OFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">skb_checksum</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span>
					<span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
							  <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
							  <span class="n">IPPROTO_TCP</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span>
					<span class="n">skb_checksum</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span>
					<span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
							  <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
							  <span class="n">IPPROTO_UDP</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ring_num</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">ring_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">ring_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>


	<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">ring_num</span><span class="p">];</span>
	<span class="n">tmp_skb</span> <span class="o">=</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* [Header:14][payload] ---&gt; [Header:14][paddong:2][payload]    */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="p">],</span>
	       <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">));</span>
	<span class="cm">/*-- Set Buffer information --*/</span>
	<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					  <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					  <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;TX DMA map failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">ring_num</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/*-- Set Tx descriptor --*/</span>
	<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">ring_num</span><span class="p">);</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">tx_words_eob</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">tx_frame_ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_ctrl</span><span class="p">);</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">DSC_INIT16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">++</span><span class="n">ring_num</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="n">ring_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Update software pointer of TX descriptor */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span>
		  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ring_num</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">TX_DSC_SW_P</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCH_PTP</span>
	<span class="n">pch_tx_timestamp</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_update_stats - Update the board statistics counters</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pch_gbe_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Prevent stats update while adapter is being reset, or if the pci</span>
<span class="cm">	 * connection is down.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">error_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">!=</span> <span class="n">pci_channel_io_normal</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Update device status &quot;adapter-&gt;stats&quot; */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_length_errors</span> <span class="o">+</span>
	    <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span> <span class="o">+</span>
	    <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">+</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_timeout_count</span><span class="p">;</span>

	<span class="cm">/* Update network device status &quot;adapter-&gt;net_stats&quot; */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="p">;</span>
	<span class="cm">/* Fill out the OS statistics structure */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">collisions</span><span class="p">;</span>
	<span class="cm">/* Rx Errors */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span><span class="p">;</span>
	<span class="cm">/* Tx Errors */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_stop_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxdma</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Disable Receive DMA */</span>
	<span class="n">rxdma</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>
	<span class="n">rxdma</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_RX_DMA_EN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rxdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>
	<span class="cm">/* Wait Rx DMA BUS is IDLE */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_gbe_wait_clr_bit_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_DMA_ST</span><span class="p">,</span> <span class="n">PCH_GBE_IDLE_CHECK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable Bus master */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="cm">/* Stop Receive */</span>
		<span class="n">pch_gbe_mac_reset_rx</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="cm">/* Enable Bus master */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Stop Receive */</span>
		<span class="n">pch_gbe_mac_reset_rx</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* reprogram multicast address register after reset */</span>
	<span class="n">pch_gbe_set_multi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_start_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rxdma</span><span class="p">;</span>

	<span class="cm">/* Enables Receive DMA */</span>
	<span class="n">rxdma</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>
	<span class="n">rxdma</span> <span class="o">|=</span> <span class="n">PCH_GBE_RX_DMA_EN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rxdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">DMA_CTRL</span><span class="p">);</span>
	<span class="cm">/* Enables Receive */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_GBE_MRE_MAC_RX_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MAC_RX_EN</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_intr - Interrupt Handler</span>
<span class="cm"> * @irq:   Interrupt number</span>
<span class="cm"> * @data:  Pointer to a network interface device structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	- IRQ_HANDLED:	Our interrupt</span>
<span class="cm"> *	- IRQ_NONE:	Not our interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pch_gbe_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_st</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_en</span><span class="p">;</span>

	<span class="cm">/* Check request status */</span>
	<span class="n">int_st</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_ST</span><span class="p">);</span>
	<span class="n">int_st</span> <span class="o">=</span> <span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
	<span class="cm">/* When request status is no interruption factor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">int_st</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* Not our interrupt. End processing. */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s occur int_st = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">int_st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_INT_RX_FRAME_ERR</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">intr_rx_frame_err_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_INT_RX_FIFO_ERR</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_stop_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">intr_rx_fifo_err_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Rx fifo over run</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_stop_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">int_en</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">((</span><span class="n">int_en</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCH_GBE_INT_RX_FIFO_ERR</span><span class="p">),</span>
				  <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
			<span class="n">pch_gbe_stop_receive</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">int_st</span> <span class="o">|=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_ST</span><span class="p">);</span>
			<span class="n">int_st</span> <span class="o">=</span> <span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_INT_RX_DMA_ERR</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">intr_rx_dma_err_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_INT_TX_FIFO_ERR</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">intr_tx_fifo_err_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_INT_TX_DMA_ERR</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">intr_tx_dma_err_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_INT_TCPIP_ERR</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">intr_tcpip_err_count</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* When Rx descriptor is empty  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_INT_RX_DSC_EMP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">intr_rx_dsc_empty_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Rx descriptor is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">int_en</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">((</span><span class="n">int_en</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCH_GBE_INT_RX_DSC_EMP</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">tx_fc_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set Pause packet */</span>
			<span class="n">pch_gbe_mac_set_pause_packet</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* When request status is Receive interruption */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCH_GBE_INT_RX_DMA_CMPLT</span> <span class="o">|</span> <span class="n">PCH_GBE_INT_TX_CMPLT</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_stop_flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Enable only Rx Descriptor empty */</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_sem</span><span class="p">);</span>
			<span class="n">int_en</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
			<span class="n">int_en</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">PCH_GBE_INT_RX_DMA_CMPLT</span> <span class="o">|</span> <span class="n">PCH_GBE_INT_TX_CMPLT</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">int_en</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
			<span class="cm">/* Start polling for NAPI */</span>
			<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;return = 0x%08x  INT_EN reg = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">IRQ_HANDLED</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_alloc_rx_buffers - Replace used receive buffers; legacy &amp; extended</span>
<span class="cm"> * @adapter:       Board private structure</span>
<span class="cm"> * @rx_ring:       Rx descriptor ring</span>
<span class="cm"> * @cleaned_count: Cleaned count</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pch_gbe_alloc_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cleaned_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsz</span><span class="p">;</span>

	<span class="n">bufsz</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cleaned_count</span><span class="o">--</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">bufsz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Better luck next round */</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_alloc_buff_failed</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* align */</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">,</span>
						  <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
						  <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_alloc_buff_failed</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* while !buffer_info-&gt;skb */</span>
		<span class="p">}</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_RX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">=</span> <span class="n">DSC_INIT16</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i = %d  buffer_info-&gt;dma = 0x08%llx  buffer_info-&gt;length = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">!=</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span>
			  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_DSC_SW_P</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pch_gbe_alloc_rx_buffers_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cleaned_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">bufsz</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="n">bufsz</span> <span class="o">+</span> <span class="n">PCH_GBE_RESERVE_MEMORY</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool_logic</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for the receive pool buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">rx_buffer</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool</span> <span class="o">+</span> <span class="n">bufsz</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">bufsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_alloc_tx_buffers - Allocate transmit buffers</span>
<span class="cm"> * @adapter:   Board private structure</span>
<span class="cm"> * @tx_ring:   Tx descriptor ring</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_alloc_tx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>

	<span class="n">bufsz</span> <span class="o">=</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span> <span class="o">+</span> <span class="n">PCH_GBE_DMA_ALIGN</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">bufsz</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">PCH_GBE_DMA_ALIGN</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">DSC_INIT16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_clean_tx - Reclaim resources after transmit completes</span>
<span class="cm"> * @adapter:   Board private structure</span>
<span class="cm"> * @tx_ring:   Tx descriptor ring</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	true:  Cleaned the descriptor</span>
<span class="cm"> *	false: Not cleaned the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">pch_gbe_clean_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cleaned_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cleaned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;next_to_clean : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">;</span>
	<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;gbec_status:0x%04x  dma_status:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span><span class="p">,</span> <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">dma_status</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">&amp;</span> <span class="n">DSC_INIT16</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;gbec_status:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span><span class="p">);</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_TXD_GMAC_STAT_ABT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Transfer Abort Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_TXD_GMAC_STAT_CRSER</span><span class="p">)</span>
			  <span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Transfer Carrier Sense Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_TXD_GMAC_STAT_EXCOL</span><span class="p">)</span>
			  <span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Transfer Collision Abort Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="n">PCH_GBE_TXD_GMAC_STAT_SNGCOL</span> <span class="o">|</span>
			     <span class="n">PCH_GBE_TXD_GMAC_STAT_MLTCOL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Transfer Collision</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_TXD_GMAC_STAT_CMPLT</span><span class="p">)</span>
			  <span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;unmap buffer_info-&gt;dma : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;trim buffer_info-&gt;skb : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">=</span> <span class="n">DSC_INIT16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* weight of a sort for tx, to avoid endless transmit cleanup */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cleaned_count</span><span class="o">++</span> <span class="o">==</span> <span class="n">PCH_GBE_TX_WEIGHT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cleaned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;called pch_gbe_unmap_and_free_tx_resource() %d count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cleaned_count</span><span class="p">);</span>
	<span class="cm">/* Recover from running out of Tx resources in xmit_frame */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cleaned</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_restart_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Tx wake queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;next_to_clean : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cleaned</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_clean_rx - Send received data up the network stack; legacy</span>
<span class="cm"> * @adapter:     Board private structure</span>
<span class="cm"> * @rx_ring:     Rx descriptor ring</span>
<span class="cm"> * @work_done:   Completed count</span>
<span class="cm"> * @work_to_do:  Request count</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	true:  Cleaned the descriptor</span>
<span class="cm"> *	false: Not cleaned the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">pch_gbe_clean_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="o">*</span><span class="n">work_done</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cleaned_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cleaned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dma_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gbec_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tcp_ip_status</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">work_to_do</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check Rx descriptor status */</span>
		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_RX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">==</span> <span class="n">DSC_INIT16</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cleaned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">cleaned_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dma_status</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">dma_status</span><span class="p">;</span>
		<span class="n">gbec_status</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span><span class="p">;</span>
		<span class="n">tcp_ip_status</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">tcp_ip_status</span><span class="p">;</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">=</span> <span class="n">DSC_INIT16</span><span class="p">;</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* unmap dma */</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				   <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RxDecNo = 0x%04x  Status[DMA:0x%02x GBE:0x%04x &quot;</span>
			 <span class="s">&quot;TCP:0x%08x]  BufInf = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">dma_status</span><span class="p">,</span> <span class="n">gbec_status</span><span class="p">,</span> <span class="n">tcp_ip_status</span><span class="p">,</span>
			 <span class="n">buffer_info</span><span class="p">);</span>
		<span class="cm">/* Error check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">gbec_status</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_RXD_GMAC_STAT_NOTOCTAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Receive Not Octal Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">gbec_status</span> <span class="o">&amp;</span>
				<span class="n">PCH_GBE_RXD_GMAC_STAT_NBLERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Receive Nibble Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">gbec_status</span> <span class="o">&amp;</span>
				<span class="n">PCH_GBE_RXD_GMAC_STAT_CRCERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Receive CRC Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* get receive length */</span>
			<span class="cm">/* length convert[-3], length includes FCS length */</span>
			<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">rx_words_eob</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">rx_words_eob</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
				<span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * buffer_info-&gt;rx_buffer: [Header:14][payload]</span>
<span class="cm">			 * skb-&gt;data: [Reserve:2][Header:14][payload]</span>
<span class="cm">			 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

			<span class="cm">/* update status of driver */</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">gbec_status</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_RXD_GMAC_STAT_MARMLT</span><span class="p">))</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Write meta date of skb */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCH_PTP</span>
			<span class="n">pch_rx_timestamp</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcp_ip_status</span> <span class="o">&amp;</span> <span class="n">PCH_GBE_RXD_ACC_STAT_TCPIPOK</span><span class="p">)</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>

			<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">work_done</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Receive skb-&gt;ip_summed: %d length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* return some buffers to hardware, one at a time is too slow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cleaned_count</span> <span class="o">&gt;=</span> <span class="n">PCH_GBE_RX_BUFFER_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pch_gbe_alloc_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span>
						 <span class="n">cleaned_count</span><span class="p">);</span>
			<span class="n">cleaned_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cleaned_count</span><span class="p">)</span>
		<span class="n">pch_gbe_alloc_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">cleaned_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cleaned</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_setup_tx_resources - Allocate Tx resources (Descriptors)</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * @tx_ring:  Tx descriptor ring (for a specific queue) to setup</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pch_gbe_setup_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desNo</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_tx_desc</span><span class="p">);</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for the transmit descriptor ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">desNo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">desNo</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">desNo</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">desNo</span><span class="p">);</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">=</span> <span class="n">DSC_INIT16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tx_ring-&gt;desc = 0x%p  tx_ring-&gt;dma = 0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;next_to_clean = 0x%08x  next_to_use = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
		 <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_setup_rx_resources - Allocate Rx resources (Descriptors)</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * @rx_ring:  Rx descriptor ring (for a specific queue) to setup</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pch_gbe_setup_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desNo</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_rx_desc</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span>	<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for the receive descriptor ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">desNo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">desNo</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">desNo</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">PCH_GBE_RX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">desNo</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">gbec_status</span> <span class="o">=</span> <span class="n">DSC_INIT16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rx_ring-&gt;desc = 0x%p  rx_ring-&gt;dma = 0x%08llx &quot;</span>
		 <span class="s">&quot;next_to_clean = 0x%08x  next_to_use = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
		 <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_free_tx_resources - Free Tx Resources</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * @tx_ring:  Tx descriptor ring for a specific queue</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pch_gbe_free_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pch_gbe_clean_tx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_free_rx_resources - Free Rx Resources</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * @rx_ring:  Ring to clean the resources from</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pch_gbe_free_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pch_gbe_clean_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_request_irq - Allocate an interrupt line</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;call pci_enable_msi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;call pci_enable_msi - Error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch_gbe_intr</span><span class="p">,</span>
			  <span class="n">flags</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate interrupt Error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;adapter-&gt;have_msi : %d  flags : 0x%04x  return : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * pch_gbe_up - Up GbE network device</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pch_gbe_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Ensure we have a valid MAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error: Invalid MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hardware has been reset, we need to reload some things */</span>
	<span class="n">pch_gbe_set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pch_gbe_setup_tctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pch_gbe_configure_tx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pch_gbe_setup_rctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pch_gbe_configure_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pch_gbe_request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error: can&#39;t bring device up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pch_gbe_alloc_rx_buffers_pool</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error: can&#39;t bring device up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pch_gbe_alloc_tx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">pch_gbe_alloc_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span><span class="p">;</span>
	<span class="n">pch_gbe_start_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">pch_gbe_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_down - Down GbE network device</span>
<span class="cm"> * @adapter:  Board private structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pch_gbe_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>

	<span class="cm">/* signal that we&#39;re down so the interrupt handler does not</span>
<span class="cm">	 * reschedule our watchdog timer */</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pch_gbe_irq_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pch_gbe_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pch_gbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pch_gbe_clean_tx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">pch_gbe_clean_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool_size</span><span class="p">,</span>
			    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool_logic</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool_logic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buff_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_sw_init - Initialize general software structures (struct pch_gbe_adapter)</span>
<span class="cm"> * @adapter:  Board private structure to initialize</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_sw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">PCH_GBE_FRAME_SIZE_2048</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">min_frame_size</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

	<span class="cm">/* Initialize the hardware-specific values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pch_gbe_hal_setup_init_funcs</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Hardware Initialization Failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pch_gbe_alloc_queues</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">miim_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ethtool_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pch_gbe_irq_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pch_gbe_init_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rx_buffer_len : %d  mac.min_frame_size : %d  mac.max_frame_size : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span><span class="p">,</span>
		 <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">min_frame_size</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_open - Called when a network interface is made active</span>
<span class="cm"> * @netdev:	Network interface device structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* allocate transmit descriptors */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pch_gbe_setup_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_tx</span><span class="p">;</span>
	<span class="cm">/* allocate receive descriptors */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pch_gbe_setup_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_rx</span><span class="p">;</span>
	<span class="n">pch_gbe_hal_power_up_phy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pch_gbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_up</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Success End</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_up:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wake_up_evt</span><span class="p">)</span>
		<span class="n">pch_gbe_hal_power_down_phy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">pch_gbe_free_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
<span class="nl">err_setup_rx:</span>
	<span class="n">pch_gbe_free_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
<span class="nl">err_setup_tx:</span>
	<span class="n">pch_gbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error End</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_stop - Disables a network interface</span>
<span class="cm"> * @netdev:  Network interface device structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0: Successfully</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">pch_gbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wake_up_evt</span><span class="p">)</span>
		<span class="n">pch_gbe_hal_power_down_phy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">pch_gbe_free_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">pch_gbe_free_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_xmit_frame - Packet transmitting start</span>
<span class="cm"> * @skb:     Socket buffer structure</span>
<span class="cm"> * @netdev:  Network interface device structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	- NETDEV_TX_OK:   Normal end</span>
<span class="cm"> *	- NETDEV_TX_BUSY: Error end</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Transfer length Error: skb len: %d &gt; max: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Collision - tell upper layer to requeue */</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_LOCKED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">PCH_GBE_DESC_UNUSED</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Return : BUSY  next_to use : 0x%08x  next_to clean : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CRC,ITAG no support */</span>
	<span class="n">pch_gbe_tx_queue</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_get_stats - Get System Network Statistics</span>
<span class="cm"> * @netdev:  Network interface device structure</span>
<span class="cm"> * Returns:  The current stats</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">pch_gbe_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only return the current stats */</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_set_multi - Multicast and Promiscuous mode set</span>
<span class="cm"> * @netdev:   Network interface device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mta_list</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;netdev-&gt;flags : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check for Promiscuous and All Multicast modes */</span>
	<span class="n">rctl</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_MODE</span><span class="p">);</span>
	<span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_ADD_FIL_EN</span><span class="p">;</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_MLT_FIL_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* all the multicasting receive permissions */</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">PCH_GBE_ADD_FIL_EN</span><span class="p">;</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_MLT_FIL_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">&gt;=</span> <span class="n">PCH_GBE_MAR_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* all the multicasting receive permissions */</span>
			<span class="n">rctl</span> <span class="o">|=</span> <span class="n">PCH_GBE_ADD_FIL_EN</span><span class="p">;</span>
			<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_GBE_MLT_FIL_EN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCH_GBE_ADD_FIL_EN</span> <span class="o">|</span> <span class="n">PCH_GBE_MLT_FIL_EN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_MODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">&gt;=</span> <span class="n">PCH_GBE_MAR_ENTRIES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mta_list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mc_count</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mta_list</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* The shared function expects a packed array of only addresses. */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">mc_count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mta_list</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pch_gbe_mac_mc_addr_list_update</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mta_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">PCH_GBE_MAR_ENTRIES</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mta_list</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RX_MODE reg(check bit31,30 ADD,MLT) : 0x%08x  netdev-&gt;mc_count : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">RX_MODE</span><span class="p">),</span> <span class="n">mc_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_set_mac - Change the Ethernet Address of the NIC</span>
<span class="cm"> * @netdev: Network interface device structure</span>
<span class="cm"> * @addr:   Pointer to an address structure</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	-EADDRNOTAVAIL:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">skaddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">skaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">skaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">skaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
		<span class="n">pch_gbe_mac_mar_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ret_val : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev_addr : %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mac_addr : %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MAC_ADR1AB reg : 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">high</span><span class="p">),</span>
		 <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">low</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_change_mtu - Change the Maximum Transfer Unit</span>
<span class="cm"> * @netdev:   Network interface device structure</span>
<span class="cm"> * @new_mtu:  New value for maximum frame size</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		Successfully</span>
<span class="cm"> *	-EINVAL:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_rx_buffer_len</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">max_frame</span> <span class="o">=</span> <span class="n">new_mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">max_frame</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">max_frame</span> <span class="o">&gt;</span> <span class="n">PCH_GBE_MAX_JUMBO_FRAME_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Invalid MTU setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_frame</span> <span class="o">&lt;=</span> <span class="n">PCH_GBE_FRAME_SIZE_2048</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">PCH_GBE_FRAME_SIZE_2048</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_frame</span> <span class="o">&lt;=</span> <span class="n">PCH_GBE_FRAME_SIZE_4096</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">PCH_GBE_FRAME_SIZE_4096</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_frame</span> <span class="o">&lt;=</span> <span class="n">PCH_GBE_FRAME_SIZE_8192</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">PCH_GBE_FRAME_SIZE_8192</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">PCH_GBE_MAX_RX_BUFFER_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pch_gbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pch_gbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">old_rx_buffer_len</span><span class="p">;</span>
			<span class="n">pch_gbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">max_frame</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pch_gbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">max_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;max_frame : %d  rx_buffer_len : %d  mtu : %d  max_frame_size : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">max_frame</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span>
		 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">max_frame_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_set_features - Reset device after features changed</span>
<span class="cm"> * @netdev:   Network interface device structure</span>
<span class="cm"> * @features:  New features</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:		HW state updated successfully</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">pch_gbe_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pch_gbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_ioctl - Controls register through a MII interface</span>
<span class="cm"> * @netdev:   Network interface device structure</span>
<span class="cm"> * @ifr:      Pointer to ifr structure</span>
<span class="cm"> * @cmd:      Control command</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	0:	Successfully</span>
<span class="cm"> *	Negative value:	Failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cmd : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCH_PTP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSHWTSTAMP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hwtstamp_ioctl</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_tx_timeout - Respond to a Tx Hang</span>
<span class="cm"> * @netdev:   Network interface device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Do the reset outside of interrupt context */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_timeout_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_gbe_napi_poll - NAPI receive and transfer polling callback</span>
<span class="cm"> * @napi:    Pointer of polling device struct</span>
<span class="cm"> * @budget:  The maximum number of a packet</span>
<span class="cm"> * Returns</span>
<span class="cm"> *	false:  Exit the polling mode</span>
<span class="cm"> *	true:   Continue the polling mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_napi_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pch_gbe_adapter</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">poll_end_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cleaned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_en</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;budget : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="n">pch_gbe_clean_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_done</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="n">cleaned</span> <span class="o">=</span> <span class="n">pch_gbe_clean_tx</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cleaned</span><span class="p">)</span>
		<span class="n">work_done</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="cm">/* If no Tx and not enough Rx work done,</span>
<span class="cm">	 * exit the polling mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span>
		<span class="n">poll_end_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll_end_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_stop_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_stop_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">pch_gbe_start_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pch_gbe_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_stop_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_stop_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">pch_gbe_start_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">int_en</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">((</span><span class="n">int_en</span> <span class="o">|</span> <span class="n">PCH_GBE_INT_RX_FIFO_ERR</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">INT_EN</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;poll_end_flag : %d  work_done : %d  budget : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">poll_end_flag</span><span class="p">,</span> <span class="n">work_done</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/**</span>
<span class="cm"> * pch_gbe_netpoll - Used by things like netconsole to send skbs</span>
<span class="cm"> * @netdev:  Network interface device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">pch_gbe_intr</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">pch_gbe_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">pch_gbe_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">pch_gbe_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">pch_gbe_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> <span class="o">=</span> <span class="n">pch_gbe_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">pch_gbe_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">pch_gbe_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">pch_gbe_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span> <span class="o">=</span> <span class="n">pch_gbe_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> <span class="o">=</span> <span class="n">pch_gbe_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span> <span class="o">=</span> <span class="n">pch_gbe_set_multi</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span> <span class="o">=</span> <span class="n">pch_gbe_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">pch_gbe_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">pch_gbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/* Request a slot slot reset. */</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">pch_gbe_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot re-enable PCI device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pch_gbe_hal_power_up_phy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">pch_gbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="cm">/* Clear wake up status */</span>
	<span class="n">pch_gbe_mac_set_wol_event</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pch_gbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;can&#39;t bring device back up after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pch_gbe_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wufc</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wake_up_evt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">pch_gbe_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wufc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pch_gbe_set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">pch_gbe_setup_rctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">pch_gbe_configure_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">pch_gbe_set_rgmii_ctrl</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_speed</span><span class="p">,</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_duplex</span><span class="p">);</span>
		<span class="n">pch_gbe_set_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_speed</span><span class="p">,</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">link_duplex</span><span class="p">);</span>
		<span class="n">pch_gbe_mac_set_wol_event</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">wufc</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pch_gbe_hal_power_down_phy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">pch_gbe_mac_set_wol_event</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">wufc</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__pch_gbe_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot enable PCI device from suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pch_gbe_hal_power_up_phy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">pch_gbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="cm">/* Clear wake on lan control and status */</span>
	<span class="n">pch_gbe_mac_set_wol_event</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">pch_gbe_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__pch_gbe_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">system_state</span> <span class="o">==</span> <span class="n">SYSTEM_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_gbe_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pch_gbe_hal_phy_hw_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_gbe_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_gbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
		<span class="o">||</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
							  <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ERR: No usable DMA &quot;</span>
					<span class="s">&quot;configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;ERR: Can&#39;t reserve PCI I/O and memory resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_gbe_adapter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_pci</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">back</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCH_GBE_PCI_BAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t ioremap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCH_PTP</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ptp_pdev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
					       <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptp_filter_init</span><span class="p">(</span><span class="n">ptp_filter</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ptp_filter</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Bad ptp filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch_gbe_netdev_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">PCH_GBE_WATCHDOG_PERIOD</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span>
		       <span class="n">pch_gbe_napi_poll</span><span class="p">,</span> <span class="n">PCH_GBE_RX_WEIGHT</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IPV6_CSUM</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>
	<span class="n">pch_gbe_set_ethtool_ops</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pch_gbe_mac_load_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">pch_gbe_mac_reset_hw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* setup the private structure */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_gbe_sw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>

	<span class="cm">/* Initialize PHY */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_gbe_init_phy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY initialize error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_adapter</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pch_gbe_hal_get_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Read the MAC address. and store to the private data */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_gbe_hal_read_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC address Read Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_adapter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the MAC is invalid (or just missing), display a warning</span>
<span class="cm">		 * but do not abort setting up the device. pch_gbe_up will</span>
<span class="cm">		 * prevent the interface from being brought up until a valid MAC</span>
<span class="cm">		 * is set.</span>
<span class="cm">		 */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid MAC address, &quot;</span>
		                    <span class="s">&quot;interface disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">pch_gbe_watchdog</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">,</span> <span class="n">pch_gbe_reset_task</span><span class="p">);</span>

	<span class="n">pch_gbe_check_options</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* initialize the wol settings based on the eeprom settings */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">wake_up_evt</span> <span class="o">=</span> <span class="n">PCH_GBE_WL_INIT_SETTING</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC address : %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* reset the hardware with the new settings */</span>
	<span class="n">pch_gbe_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_adapter</span><span class="p">;</span>
	<span class="cm">/* tell the stack to leave us alone until pch_gbe_open() is called */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCH Network Connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_adapter:</span>
	<span class="n">pch_gbe_hal_phy_hw_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
<span class="nl">err_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reg</span><span class="p">);</span>
<span class="nl">err_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">err_release_pci:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">pch_gbe_pcidev_id</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_IOH1_GBE</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFFFF00</span><span class="p">)</span>
	 <span class="p">},</span>
	<span class="p">{.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ROHM_ML7223_GBE</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFFFF00</span><span class="p">)</span>
	 <span class="p">},</span>
	<span class="p">{.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_ROHM_ML7831_GBE</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCI_CLASS_NETWORK_ETHERNET</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFFFF00</span><span class="p">)</span>
	 <span class="p">},</span>
	<span class="cm">/* required last entry */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">pch_gbe_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pch_gbe_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pch_gbe_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">pch_gbe_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">pch_gbe_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poweroff</span> <span class="o">=</span> <span class="n">pch_gbe_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">pch_gbe_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">pch_gbe_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">pch_gbe_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">pch_gbe_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pch_gbe_io_resume</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pch_gbe_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pch_gbe_pcidev_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pch_gbe_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">pch_gbe_remove</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch_gbe_pm_ops</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">pch_gbe_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch_gbe_err_handler</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pch_gbe_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_gbe_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copybreak</span> <span class="o">!=</span> <span class="n">PCH_GBE_COPYBREAK_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copybreak</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;copybreak disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;copybreak enabled for packets &lt;= %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">copybreak</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pch_gbe_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_gbe_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pch_gbe_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pch_gbe_exit_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;EG20T PCH Gigabit ethernet Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;LAPIS SEMICONDUCTOR, &lt;tshimizu818@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pch_gbe_pcidev_id</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span>
	<span class="s">&quot;Maximum size of packet that is copied to a new buffer on receive&quot;</span><span class="p">);</span>

<span class="cm">/* pch_gbe_main.c */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
