<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › marvell › mv643xx_eth.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mv643xx_eth.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Marvell Discovery (MV643XX) and Marvell Orion ethernet ports</span>
<span class="cm"> * Copyright (C) 2002 Matthew Dharm &lt;mdharm@momenco.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the 64360 driver from:</span>
<span class="cm"> * Copyright (C) 2002 Rabeeh Khoury &lt;rabeeh@galileo.co.il&gt;</span>
<span class="cm"> *		      Rabeeh Khoury &lt;rabeeh@marvell.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 PMC-Sierra, Inc.,</span>
<span class="cm"> *	written by Manish Lachwani</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 Ralf Baechle &lt;ralf@linux-mips.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-2006 MontaVista Software, Inc.</span>
<span class="cm"> *			   Dale Farnsworth &lt;dale@farnsworth.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Steven J. Hill &lt;sjhill1@rockwellcollins.com&gt;</span>
<span class="cm"> *				     &lt;sjhill@realitydiluted.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2008 Marvell Semiconductor</span>
<span class="cm"> *			   Lennert Buytenhek &lt;buytenh@marvell.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/mv643xx_eth.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/inet_lro.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">mv643xx_eth_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mv643xx_eth&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">mv643xx_eth_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;1.4&quot;</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Registers shared between all ports.</span>
<span class="cm"> */</span>
<span class="cp">#define PHY_ADDR			0x0000</span>
<span class="cp">#define SMI_REG				0x0004</span>
<span class="cp">#define  SMI_BUSY			0x10000000</span>
<span class="cp">#define  SMI_READ_VALID			0x08000000</span>
<span class="cp">#define  SMI_OPCODE_READ		0x04000000</span>
<span class="cp">#define  SMI_OPCODE_WRITE		0x00000000</span>
<span class="cp">#define ERR_INT_CAUSE			0x0080</span>
<span class="cp">#define  ERR_INT_SMI_DONE		0x00000010</span>
<span class="cp">#define ERR_INT_MASK			0x0084</span>
<span class="cp">#define WINDOW_BASE(w)			(0x0200 + ((w) &lt;&lt; 3))</span>
<span class="cp">#define WINDOW_SIZE(w)			(0x0204 + ((w) &lt;&lt; 3))</span>
<span class="cp">#define WINDOW_REMAP_HIGH(w)		(0x0280 + ((w) &lt;&lt; 2))</span>
<span class="cp">#define WINDOW_BAR_ENABLE		0x0290</span>
<span class="cp">#define WINDOW_PROTECT(w)		(0x0294 + ((w) &lt;&lt; 4))</span>

<span class="cm">/*</span>
<span class="cm"> * Main per-port registers.  These live at offset 0x0400 for</span>
<span class="cm"> * port #0, 0x0800 for port #1, and 0x0c00 for port #2.</span>
<span class="cm"> */</span>
<span class="cp">#define PORT_CONFIG			0x0000</span>
<span class="cp">#define  UNICAST_PROMISCUOUS_MODE	0x00000001</span>
<span class="cp">#define PORT_CONFIG_EXT			0x0004</span>
<span class="cp">#define MAC_ADDR_LOW			0x0014</span>
<span class="cp">#define MAC_ADDR_HIGH			0x0018</span>
<span class="cp">#define SDMA_CONFIG			0x001c</span>
<span class="cp">#define  TX_BURST_SIZE_16_64BIT		0x01000000</span>
<span class="cp">#define  TX_BURST_SIZE_4_64BIT		0x00800000</span>
<span class="cp">#define  BLM_TX_NO_SWAP			0x00000020</span>
<span class="cp">#define  BLM_RX_NO_SWAP			0x00000010</span>
<span class="cp">#define  RX_BURST_SIZE_16_64BIT		0x00000008</span>
<span class="cp">#define  RX_BURST_SIZE_4_64BIT		0x00000004</span>
<span class="cp">#define PORT_SERIAL_CONTROL		0x003c</span>
<span class="cp">#define  SET_MII_SPEED_TO_100		0x01000000</span>
<span class="cp">#define  SET_GMII_SPEED_TO_1000		0x00800000</span>
<span class="cp">#define  SET_FULL_DUPLEX_MODE		0x00200000</span>
<span class="cp">#define  MAX_RX_PACKET_9700BYTE		0x000a0000</span>
<span class="cp">#define  DISABLE_AUTO_NEG_SPEED_GMII	0x00002000</span>
<span class="cp">#define  DO_NOT_FORCE_LINK_FAIL		0x00000400</span>
<span class="cp">#define  SERIAL_PORT_CONTROL_RESERVED	0x00000200</span>
<span class="cp">#define  DISABLE_AUTO_NEG_FOR_FLOW_CTRL	0x00000008</span>
<span class="cp">#define  DISABLE_AUTO_NEG_FOR_DUPLEX	0x00000004</span>
<span class="cp">#define  FORCE_LINK_PASS		0x00000002</span>
<span class="cp">#define  SERIAL_PORT_ENABLE		0x00000001</span>
<span class="cp">#define PORT_STATUS			0x0044</span>
<span class="cp">#define  TX_FIFO_EMPTY			0x00000400</span>
<span class="cp">#define  TX_IN_PROGRESS			0x00000080</span>
<span class="cp">#define  PORT_SPEED_MASK		0x00000030</span>
<span class="cp">#define  PORT_SPEED_1000		0x00000010</span>
<span class="cp">#define  PORT_SPEED_100			0x00000020</span>
<span class="cp">#define  PORT_SPEED_10			0x00000000</span>
<span class="cp">#define  FLOW_CONTROL_ENABLED		0x00000008</span>
<span class="cp">#define  FULL_DUPLEX			0x00000004</span>
<span class="cp">#define  LINK_UP			0x00000002</span>
<span class="cp">#define TXQ_COMMAND			0x0048</span>
<span class="cp">#define TXQ_FIX_PRIO_CONF		0x004c</span>
<span class="cp">#define TX_BW_RATE			0x0050</span>
<span class="cp">#define TX_BW_MTU			0x0058</span>
<span class="cp">#define TX_BW_BURST			0x005c</span>
<span class="cp">#define INT_CAUSE			0x0060</span>
<span class="cp">#define  INT_TX_END			0x07f80000</span>
<span class="cp">#define  INT_TX_END_0			0x00080000</span>
<span class="cp">#define  INT_RX				0x000003fc</span>
<span class="cp">#define  INT_RX_0			0x00000004</span>
<span class="cp">#define  INT_EXT			0x00000002</span>
<span class="cp">#define INT_CAUSE_EXT			0x0064</span>
<span class="cp">#define  INT_EXT_LINK_PHY		0x00110000</span>
<span class="cp">#define  INT_EXT_TX			0x000000ff</span>
<span class="cp">#define INT_MASK			0x0068</span>
<span class="cp">#define INT_MASK_EXT			0x006c</span>
<span class="cp">#define TX_FIFO_URGENT_THRESHOLD	0x0074</span>
<span class="cp">#define RX_DISCARD_FRAME_CNT		0x0084</span>
<span class="cp">#define RX_OVERRUN_FRAME_CNT		0x0088</span>
<span class="cp">#define TXQ_FIX_PRIO_CONF_MOVED		0x00dc</span>
<span class="cp">#define TX_BW_RATE_MOVED		0x00e0</span>
<span class="cp">#define TX_BW_MTU_MOVED			0x00e8</span>
<span class="cp">#define TX_BW_BURST_MOVED		0x00ec</span>
<span class="cp">#define RXQ_CURRENT_DESC_PTR(q)		(0x020c + ((q) &lt;&lt; 4))</span>
<span class="cp">#define RXQ_COMMAND			0x0280</span>
<span class="cp">#define TXQ_CURRENT_DESC_PTR(q)		(0x02c0 + ((q) &lt;&lt; 2))</span>
<span class="cp">#define TXQ_BW_TOKENS(q)		(0x0300 + ((q) &lt;&lt; 4))</span>
<span class="cp">#define TXQ_BW_CONF(q)			(0x0304 + ((q) &lt;&lt; 4))</span>
<span class="cp">#define TXQ_BW_WRR_CONF(q)		(0x0308 + ((q) &lt;&lt; 4))</span>

<span class="cm">/*</span>
<span class="cm"> * Misc per-port registers.</span>
<span class="cm"> */</span>
<span class="cp">#define MIB_COUNTERS(p)			(0x1000 + ((p) &lt;&lt; 7))</span>
<span class="cp">#define SPECIAL_MCAST_TABLE(p)		(0x1400 + ((p) &lt;&lt; 10))</span>
<span class="cp">#define OTHER_MCAST_TABLE(p)		(0x1500 + ((p) &lt;&lt; 10))</span>
<span class="cp">#define UNICAST_TABLE(p)		(0x1600 + ((p) &lt;&lt; 10))</span>


<span class="cm">/*</span>
<span class="cm"> * SDMA configuration register default value.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(__BIG_ENDIAN)</span>
<span class="cp">#define PORT_SDMA_CONFIG_DEFAULT_VALUE		\</span>
<span class="cp">		(RX_BURST_SIZE_4_64BIT	|	\</span>
<span class="cp">		 TX_BURST_SIZE_4_64BIT)</span>
<span class="cp">#elif defined(__LITTLE_ENDIAN)</span>
<span class="cp">#define PORT_SDMA_CONFIG_DEFAULT_VALUE		\</span>
<span class="cp">		(RX_BURST_SIZE_4_64BIT	|	\</span>
<span class="cp">		 BLM_RX_NO_SWAP		|	\</span>
<span class="cp">		 BLM_TX_NO_SWAP		|	\</span>
<span class="cp">		 TX_BURST_SIZE_4_64BIT)</span>
<span class="cp">#else</span>
<span class="cp">#error One of __BIG_ENDIAN or __LITTLE_ENDIAN must be defined</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Misc definitions.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_RX_QUEUE_SIZE	128</span>
<span class="cp">#define DEFAULT_TX_QUEUE_SIZE	256</span>
<span class="cp">#define SKB_DMA_REALIGN		((PAGE_SIZE - NET_SKB_PAD) % SMP_CACHE_BYTES)</span>


<span class="cm">/*</span>
<span class="cm"> * RX/TX descriptors.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(__BIG_ENDIAN)</span>
<span class="k">struct</span> <span class="n">rx_desc</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">;</span>		<span class="cm">/* Descriptor buffer byte count		*/</span>
	<span class="n">u16</span> <span class="n">buf_size</span><span class="p">;</span>		<span class="cm">/* Buffer size				*/</span>
	<span class="n">u32</span> <span class="n">cmd_sts</span><span class="p">;</span>		<span class="cm">/* Descriptor command status		*/</span>
	<span class="n">u32</span> <span class="n">next_desc_ptr</span><span class="p">;</span>	<span class="cm">/* Next descriptor pointer		*/</span>
	<span class="n">u32</span> <span class="n">buf_ptr</span><span class="p">;</span>		<span class="cm">/* Descriptor buffer pointer		*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tx_desc</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">;</span>		<span class="cm">/* buffer byte count			*/</span>
	<span class="n">u16</span> <span class="n">l4i_chk</span><span class="p">;</span>		<span class="cm">/* CPU provided TCP checksum		*/</span>
	<span class="n">u32</span> <span class="n">cmd_sts</span><span class="p">;</span>		<span class="cm">/* Command/status field			*/</span>
	<span class="n">u32</span> <span class="n">next_desc_ptr</span><span class="p">;</span>	<span class="cm">/* Pointer to next descriptor		*/</span>
	<span class="n">u32</span> <span class="n">buf_ptr</span><span class="p">;</span>		<span class="cm">/* pointer to buffer for this descriptor*/</span>
<span class="p">};</span>
<span class="cp">#elif defined(__LITTLE_ENDIAN)</span>
<span class="k">struct</span> <span class="n">rx_desc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd_sts</span><span class="p">;</span>		<span class="cm">/* Descriptor command status		*/</span>
	<span class="n">u16</span> <span class="n">buf_size</span><span class="p">;</span>		<span class="cm">/* Buffer size				*/</span>
	<span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">;</span>		<span class="cm">/* Descriptor buffer byte count		*/</span>
	<span class="n">u32</span> <span class="n">buf_ptr</span><span class="p">;</span>		<span class="cm">/* Descriptor buffer pointer		*/</span>
	<span class="n">u32</span> <span class="n">next_desc_ptr</span><span class="p">;</span>	<span class="cm">/* Next descriptor pointer		*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tx_desc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd_sts</span><span class="p">;</span>		<span class="cm">/* Command/status field			*/</span>
	<span class="n">u16</span> <span class="n">l4i_chk</span><span class="p">;</span>		<span class="cm">/* CPU provided TCP checksum		*/</span>
	<span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">;</span>		<span class="cm">/* buffer byte count			*/</span>
	<span class="n">u32</span> <span class="n">buf_ptr</span><span class="p">;</span>		<span class="cm">/* pointer to buffer for this descriptor*/</span>
	<span class="n">u32</span> <span class="n">next_desc_ptr</span><span class="p">;</span>	<span class="cm">/* Pointer to next descriptor		*/</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#error One of __BIG_ENDIAN or __LITTLE_ENDIAN must be defined</span>
<span class="cp">#endif</span>

<span class="cm">/* RX &amp; TX descriptor command */</span>
<span class="cp">#define BUFFER_OWNED_BY_DMA		0x80000000</span>

<span class="cm">/* RX &amp; TX descriptor status */</span>
<span class="cp">#define ERROR_SUMMARY			0x00000001</span>

<span class="cm">/* RX descriptor status */</span>
<span class="cp">#define LAYER_4_CHECKSUM_OK		0x40000000</span>
<span class="cp">#define RX_ENABLE_INTERRUPT		0x20000000</span>
<span class="cp">#define RX_FIRST_DESC			0x08000000</span>
<span class="cp">#define RX_LAST_DESC			0x04000000</span>
<span class="cp">#define RX_IP_HDR_OK			0x02000000</span>
<span class="cp">#define RX_PKT_IS_IPV4			0x01000000</span>
<span class="cp">#define RX_PKT_IS_ETHERNETV2		0x00800000</span>
<span class="cp">#define RX_PKT_LAYER4_TYPE_MASK		0x00600000</span>
<span class="cp">#define RX_PKT_LAYER4_TYPE_TCP_IPV4	0x00000000</span>
<span class="cp">#define RX_PKT_IS_VLAN_TAGGED		0x00080000</span>

<span class="cm">/* TX descriptor command */</span>
<span class="cp">#define TX_ENABLE_INTERRUPT		0x00800000</span>
<span class="cp">#define GEN_CRC				0x00400000</span>
<span class="cp">#define TX_FIRST_DESC			0x00200000</span>
<span class="cp">#define TX_LAST_DESC			0x00100000</span>
<span class="cp">#define ZERO_PADDING			0x00080000</span>
<span class="cp">#define GEN_IP_V4_CHECKSUM		0x00040000</span>
<span class="cp">#define GEN_TCP_UDP_CHECKSUM		0x00020000</span>
<span class="cp">#define UDP_FRAME			0x00010000</span>
<span class="cp">#define MAC_HDR_EXTRA_4_BYTES		0x00008000</span>
<span class="cp">#define MAC_HDR_EXTRA_8_BYTES		0x00000200</span>

<span class="cp">#define TX_IHL_SHIFT			11</span>


<span class="cm">/* global *******************************************************************/</span>
<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Ethernet controller base address.</span>
<span class="cm">	 */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Points at the right SMI instance to use.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">smi</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Provides access to local SMI interface.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">smi_bus</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have access to the error interrupt pin (which is</span>
<span class="cm">	 * somewhat misnamed as it not only reflects internal errors</span>
<span class="cm">	 * but also reflects SMI completion), use that to wait for</span>
<span class="cm">	 * SMI access completion instead of polling the SMI busy bit.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">err_interrupt</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">smi_busy_wait</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Per-port MBUS window access register value.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">win_protect</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware-specific parameters.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">extended_rx_coal_limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_bw_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_csum_limit</span><span class="p">;</span>

<span class="p">};</span>

<span class="cp">#define TX_BW_CONTROL_ABSENT		0</span>
<span class="cp">#define TX_BW_CONTROL_OLD_LAYOUT	1</span>
<span class="cp">#define TX_BW_CONTROL_NEW_LAYOUT	2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mv643xx_eth_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mv643xx_eth_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>


<span class="cm">/* per-port *****************************************************************/</span>
<span class="k">struct</span> <span class="n">mib_counters</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">good_octets_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bad_octets_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">internal_mac_transmit_err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">good_frames_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bad_frames_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">broadcast_frames_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">multicast_frames_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames_64_octets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames_65_to_127_octets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames_128_to_255_octets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames_256_to_511_octets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames_512_to_1023_octets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames_1024_to_max_octets</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">good_octets_sent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">good_frames_sent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">excessive_collision</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">multicast_frames_sent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">broadcast_frames_sent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unrec_mac_control_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fc_sent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">good_fc_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bad_fc_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">undersize_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fragments_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oversize_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">jabber_received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_receive_error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bad_crc_event</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">collision</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">late_collision</span><span class="p">;</span>
	<span class="cm">/* Non MIB hardware counters */</span>
	<span class="n">u32</span> <span class="n">rx_discard</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_overrun</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lro_counters</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">lro_aggregated</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lro_flushed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lro_no_desc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rx_queue</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rx_ring_size</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rx_desc_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_curr_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_used_desc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rx_desc_area</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rx_desc_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_desc_area_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">rx_skb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_lro_mgr</span> <span class="n">lro_mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_lro_desc</span> <span class="n">lro_arr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tx_queue</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">tx_ring_size</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">tx_desc_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_curr_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_used_desc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">tx_desc_area</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_desc_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_desc_area_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">tx_skb</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_packets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_dropped</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">shared</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_num</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">mib_counters_timer</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mib_counters_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_counters</span> <span class="n">mib_counters</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">lro_counters</span> <span class="n">lro_counters</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">tx_timeout_task</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">oom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">work_link</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">work_tx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">work_tx_end</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">work_rx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">work_rx_refill</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">skb_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">rx_recycle</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * RX state.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_desc_sram_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_desc_sram_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxq_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">rx_oom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_queue</span> <span class="n">rxq</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * TX state.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">tx_ring_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_desc_sram_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_desc_sram_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_queue</span> <span class="n">txq</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware-specific parameters.</span>
<span class="cm">	 */</span>
<span class="cp">#if defined(CONFIG_HAVE_CLK)</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_clk</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* port register accessors **************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rdlp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wrlp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* rxq/txq helper functions *************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="nf">rxq_to_mp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mv643xx_eth_private</span><span class="p">,</span> <span class="n">rxq</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="nf">txq_to_mp</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mv643xx_eth_private</span><span class="p">,</span> <span class="n">txq</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">rxq_to_mp</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RXQ_COMMAND</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">rxq_to_mp</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RXQ_COMMAND</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RXQ_COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_reset_hw_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_CURRENT_DESC_PTR</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_COMMAND</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_COMMAND</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_maybe_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">nq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">nq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">&gt;=</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">nq</span><span class="p">);</span>
		<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">nq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* rx napi ******************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_get_skb_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">iphdr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">tcph</span><span class="p">,</span>
		       <span class="n">u64</span> <span class="o">*</span><span class="n">hdr_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd_sts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that this packet is Ethernet II, is not VLAN</span>
<span class="cm">	 * tagged, is IPv4, has a valid IP header, and is TCP.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_IP_HDR_OK</span> <span class="o">|</span> <span class="n">RX_PKT_IS_IPV4</span> <span class="o">|</span>
		       <span class="n">RX_PKT_IS_ETHERNETV2</span> <span class="o">|</span> <span class="n">RX_PKT_LAYER4_TYPE_MASK</span> <span class="o">|</span>
		       <span class="n">RX_PKT_IS_VLAN_TAGGED</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">RX_IP_HDR_OK</span> <span class="o">|</span> <span class="n">RX_PKT_IS_IPV4</span> <span class="o">|</span>
	     <span class="n">RX_PKT_IS_ETHERNETV2</span> <span class="o">|</span> <span class="n">RX_PKT_LAYER4_TYPE_TCP_IPV4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="o">*</span><span class="n">iphdr</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tcph</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="o">*</span><span class="n">hdr_flags</span> <span class="o">=</span> <span class="n">LRO_IPV4</span> <span class="o">|</span> <span class="n">LRO_TCP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxq_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">rxq_to_mp</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lro_flush_needed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>

	<span class="n">lro_flush_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&lt;</span> <span class="n">budget</span> <span class="o">&amp;&amp;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_sts</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">;</span>

		<span class="n">rx_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span><span class="p">];</span>

		<span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">cmd_sts</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="n">BUFFER_OWNED_BY_DMA</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span><span class="p">];</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span> <span class="o">==</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">)</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span>
				 <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx_refill</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

		<span class="n">byte_cnt</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">byte_cnt</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Update statistics.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note that the descriptor byte count includes 2 dummy</span>
<span class="cm">		 * bytes automatically inserted by the hardware at the</span>
<span class="cm">		 * start of the packet (which we don&#39;t count), and a 4</span>
<span class="cm">		 * byte CRC at the end of the packet (which we do count).</span>
<span class="cm">		 */</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">byte_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * In case we received a packet without first / last bits</span>
<span class="cm">		 * on, or the error summary bit is set, the packet needs</span>
<span class="cm">		 * to be dropped.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_FIRST_DESC</span> <span class="o">|</span> <span class="n">RX_LAST_DESC</span> <span class="o">|</span> <span class="n">ERROR_SUMMARY</span><span class="p">))</span>
			<span class="o">!=</span> <span class="p">(</span><span class="n">RX_FIRST_DESC</span> <span class="o">|</span> <span class="n">RX_LAST_DESC</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The -4 is for the CRC in the trailer of the</span>
<span class="cm">		 * received packet</span>
<span class="cm">		 */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">byte_cnt</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="n">LAYER_4_CHECKSUM_OK</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span> <span class="o">&amp;&amp;</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lro_receive_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd_sts</span><span class="p">);</span>
			<span class="n">lro_flush_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">continue</span><span class="p">;</span>

<span class="nl">err:</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_FIRST_DESC</span> <span class="o">|</span> <span class="n">RX_LAST_DESC</span><span class="p">))</span> <span class="o">!=</span>
			<span class="p">(</span><span class="n">RX_FIRST_DESC</span> <span class="o">|</span> <span class="n">RX_LAST_DESC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;received packet spanning multiple descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="n">ERROR_SUMMARY</span><span class="p">)</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lro_flush_needed</span><span class="p">)</span>
		<span class="n">lro_flush_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxq_refill</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">rxq_to_mp</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">refilled</span><span class="p">;</span>

	<span class="n">refilled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">refilled</span> <span class="o">&lt;</span> <span class="n">budget</span> <span class="o">&amp;&amp;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span> <span class="o">&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">skb_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">oom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SKB_DMA_REALIGN</span><span class="p">)</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKB_DMA_REALIGN</span><span class="p">);</span>

		<span class="n">refilled</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">rx</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used_desc</span> <span class="o">==</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">)</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span> <span class="o">+</span> <span class="n">rx</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">buf_ptr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
						  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						  <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">BUFFER_OWNED_BY_DMA</span> <span class="o">|</span> <span class="n">RX_ENABLE_INTERRUPT</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * The hardware automatically prepends 2 bytes of</span>
<span class="cm">		 * dummy data to each received packet, so that the</span>
<span class="cm">		 * IP header ends up 16-byte aligned.</span>
<span class="cm">		 */</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">refilled</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx_refill</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

<span class="nl">oom:</span>
	<span class="k">return</span> <span class="n">refilled</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* tx ***********************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">has_tiny_unaligned_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">fragp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">frag</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">fragp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">fragp</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_submit_frag_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">this_frag</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tx_index</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">this_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">frag</span><span class="p">];</span>
		<span class="n">tx_index</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">==</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">)</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span><span class="p">[</span><span class="n">tx_index</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * The last fragment will generate an interrupt</span>
<span class="cm">		 * which will free the skb on TX completion.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">BUFFER_OWNED_BY_DMA</span> <span class="o">|</span>
					<span class="n">ZERO_PADDING</span> <span class="o">|</span> <span class="n">TX_LAST_DESC</span> <span class="o">|</span>
					<span class="n">TX_ENABLE_INTERRUPT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">BUFFER_OWNED_BY_DMA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">l4i_chk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">byte_cnt</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">this_frag</span><span class="p">);</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">buf_ptr</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
						 <span class="n">this_frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">this_frag</span><span class="p">),</span>
						 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be16</span> <span class="nf">sum16_as_be</span><span class="p">(</span><span class="n">__sum16</span> <span class="n">sum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__be16</span><span class="p">)</span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txq_submit_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_sts</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">l4i_chk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">TX_FIRST_DESC</span> <span class="o">|</span> <span class="n">GEN_CRC</span> <span class="o">|</span> <span class="n">BUFFER_OWNED_BY_DMA</span><span class="p">;</span>
	<span class="n">l4i_chk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tag_bytes</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">));</span>

		<span class="n">hdr_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">tag_bytes</span> <span class="o">=</span> <span class="n">hdr_len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span> <span class="o">&gt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">tx_csum_limit</span> <span class="o">||</span>
		    <span class="n">unlikely</span><span class="p">(</span><span class="n">tag_bytes</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_checksum_help</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">no_csum</span><span class="p">;</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tag_bytes</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">cmd_sts</span> <span class="o">|=</span> <span class="n">MAC_HDR_EXTRA_4_BYTES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag_bytes</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">cmd_sts</span> <span class="o">|=</span> <span class="n">MAC_HDR_EXTRA_8_BYTES</span><span class="p">;</span>

		<span class="n">cmd_sts</span> <span class="o">|=</span> <span class="n">GEN_TCP_UDP_CHECKSUM</span> <span class="o">|</span>
			   <span class="n">GEN_IP_V4_CHECKSUM</span>   <span class="o">|</span>
			   <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="n">TX_IHL_SHIFT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPPROTO_UDP</span>:
			<span class="n">cmd_sts</span> <span class="o">|=</span> <span class="n">UDP_FRAME</span><span class="p">;</span>
			<span class="n">l4i_chk</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">sum16_as_be</span><span class="p">(</span><span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPPROTO_TCP</span>:
			<span class="n">l4i_chk</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">sum16_as_be</span><span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">no_csum:</span>
		<span class="cm">/* Errata BTS #50, IHL must be 5 if no HW checksum */</span>
		<span class="n">cmd_sts</span> <span class="o">|=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="n">TX_IHL_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_index</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">==</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">)</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span><span class="p">[</span><span class="n">tx_index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txq_submit_frag_skb</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd_sts</span> <span class="o">|=</span> <span class="n">ZERO_PADDING</span> <span class="o">|</span> <span class="n">TX_LAST_DESC</span> <span class="o">|</span> <span class="n">TX_ENABLE_INTERRUPT</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">l4i_chk</span> <span class="o">=</span> <span class="n">l4i_chk</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">byte_cnt</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">buf_ptr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* ensure all other descriptors are written before first cmd_sts */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">cmd_sts</span><span class="p">;</span>

	<span class="cm">/* clear TX_END status */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx_end</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* ensure all descriptors are written before poking hardware */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">txq_enable</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">+=</span> <span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">mv643xx_eth_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">nq</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">queue</span><span class="p">;</span>
	<span class="n">nq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_tiny_unaligned_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">__skb_linearize</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;failed to linearize skb with tiny unaligned fragment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">&lt;</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx queue full?!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txq_submit_skb</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">entries_left</span><span class="p">;</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

		<span class="n">entries_left</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entries_left</span> <span class="o">&lt;</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">nq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* tx napi ******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">nq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">hw_desc_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">expected_ptr</span><span class="p">;</span>

	<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">hw_desc_ptr</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_CURRENT_DESC_PTR</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
	<span class="n">expected_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span> <span class="o">+</span>
				<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_desc_ptr</span> <span class="o">!=</span> <span class="n">expected_ptr</span><span class="p">)</span>
		<span class="n">txq_enable</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">nq</span><span class="p">);</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx_end</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txq_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">nq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reclaimed</span><span class="p">;</span>

	<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="n">reclaimed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reclaimed</span> <span class="o">&lt;</span> <span class="n">budget</span> <span class="o">&amp;&amp;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tx_index</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">cmd_sts</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">tx_index</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_used_desc</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span><span class="p">[</span><span class="n">tx_index</span><span class="p">];</span>
		<span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">cmd_sts</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="n">BUFFER_OWNED_BY_DMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">cmd_sts</span> <span class="o">=</span> <span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BUFFER_OWNED_BY_DMA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_used_desc</span> <span class="o">=</span> <span class="n">tx_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_used_desc</span> <span class="o">==</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">)</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_used_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">reclaimed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span><span class="o">--</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="n">TX_LAST_DESC</span><span class="p">)</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="n">ERROR_SUMMARY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_sts</span> <span class="o">&amp;</span> <span class="n">TX_FIRST_DESC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span>
					 <span class="n">desc</span><span class="o">-&gt;</span><span class="n">byte_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span>
				       <span class="n">desc</span><span class="o">-&gt;</span><span class="n">byte_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">)</span> <span class="o">&lt;</span>
					<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">&amp;&amp;</span>
			    <span class="n">skb_recycle_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">skb_size</span><span class="p">))</span>
				<span class="n">__skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">nq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reclaimed</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">reclaimed</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* tx rate control **********************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Set total maximum TX rate (shared by all TX queues for this port)</span>
<span class="cm"> * to &#39;rate&#39; bits per second, with a maximum burst of &#39;burst&#39; bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">token_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bucket_size</span><span class="p">;</span>

	<span class="n">token_rate</span> <span class="o">=</span> <span class="p">((</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token_rate</span> <span class="o">&gt;</span> <span class="mi">1023</span><span class="p">)</span>
		<span class="n">token_rate</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>

	<span class="n">mtu</span> <span class="o">=</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>

	<span class="n">bucket_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">burst</span> <span class="o">+</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bucket_size</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="n">bucket_size</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">tx_bw_control</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_BW_CONTROL_OLD_LAYOUT</span>:
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_BW_RATE</span><span class="p">,</span> <span class="n">token_rate</span><span class="p">);</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_BW_MTU</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_BW_BURST</span><span class="p">,</span> <span class="n">bucket_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_BW_CONTROL_NEW_LAYOUT</span>:
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_BW_RATE_MOVED</span><span class="p">,</span> <span class="n">token_rate</span><span class="p">);</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_BW_MTU_MOVED</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_BW_BURST_MOVED</span><span class="p">,</span> <span class="n">bucket_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">token_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bucket_size</span><span class="p">;</span>

	<span class="n">token_rate</span> <span class="o">=</span> <span class="p">((</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token_rate</span> <span class="o">&gt;</span> <span class="mi">1023</span><span class="p">)</span>
		<span class="n">token_rate</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>

	<span class="n">bucket_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">burst</span> <span class="o">+</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bucket_size</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="n">bucket_size</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_BW_TOKENS</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">token_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_BW_CONF</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="p">(</span><span class="n">bucket_size</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">token_rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_set_fixed_prio_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn on fixed priority mode.</span>
<span class="cm">	 */</span>
	<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">tx_bw_control</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_BW_CONTROL_OLD_LAYOUT</span>:
		<span class="n">off</span> <span class="o">=</span> <span class="n">TXQ_FIX_PRIO_CONF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_BW_CONTROL_NEW_LAYOUT</span>:
		<span class="n">off</span> <span class="o">=</span> <span class="n">TXQ_FIX_PRIO_CONF_MOVED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* mii management interface *************************************************/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mv643xx_eth_err_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ERR_INT_CAUSE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ERR_INT_SMI_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">ERR_INT_SMI_DONE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ERR_INT_CAUSE</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_busy_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smi_is_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SMI_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMI_BUSY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smi_wait_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">err_interrupt</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">smi_is_done</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smi_is_done</span><span class="p">(</span><span class="n">msp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_busy_wait</span><span class="p">,</span> <span class="n">smi_is_done</span><span class="p">(</span><span class="n">msp</span><span class="p">),</span>
				   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smi_is_done</span><span class="p">(</span><span class="n">msp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smi_bus_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smi_reg</span> <span class="o">=</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SMI_REG</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smi_wait_ready</span><span class="p">(</span><span class="n">msp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SMI bus busy timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">SMI_OPCODE_READ</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">smi_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smi_wait_ready</span><span class="p">(</span><span class="n">msp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SMI bus busy timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">smi_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">SMI_READ_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SMI bus read not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smi_bus_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smi_reg</span> <span class="o">=</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SMI_REG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smi_wait_ready</span><span class="p">(</span><span class="n">msp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SMI bus busy timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">SMI_OPCODE_WRITE</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="n">smi_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smi_wait_ready</span><span class="p">(</span><span class="n">msp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SMI bus busy timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* statistics ***************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">mv643xx_eth_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_dropped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
		<span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
		<span class="n">tx_dropped</span> <span class="o">+=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">tx_dropped</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_grab_lro_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lro_aggregated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lro_flushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lro_no_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">lro_aggregated</span> <span class="o">+=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">aggregated</span><span class="p">;</span>
		<span class="n">lro_flushed</span> <span class="o">+=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">flushed</span><span class="p">;</span>
		<span class="n">lro_no_desc</span> <span class="o">+=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">no_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">lro_counters</span><span class="p">.</span><span class="n">lro_aggregated</span> <span class="o">=</span> <span class="n">lro_aggregated</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">lro_counters</span><span class="p">.</span><span class="n">lro_flushed</span> <span class="o">=</span> <span class="n">lro_flushed</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">lro_counters</span><span class="p">.</span><span class="n">lro_no_desc</span> <span class="o">=</span> <span class="n">lro_no_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">mib_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rdl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">MIB_COUNTERS</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mib_counters_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Clear non MIB hw counters also */</span>
	<span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RX_DISCARD_FRAME_CNT</span><span class="p">);</span>
	<span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RX_OVERRUN_FRAME_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mib_counters_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mib_counters</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_lock</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">good_octets_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">bad_octets_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">internal_mac_transmit_err</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">good_frames_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">bad_frames_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">broadcast_frames_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">multicast_frames_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frames_64_octets</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frames_65_to_127_octets</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frames_128_to_255_octets</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frames_256_to_511_octets</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frames_512_to_1023_octets</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frames_1024_to_max_octets</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">good_octets_sent</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">good_frames_sent</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">excessive_collision</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">multicast_frames_sent</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">broadcast_frames_sent</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">unrec_mac_control_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">fc_sent</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">good_fc_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">bad_fc_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">undersize_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">fragments_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">oversize_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">jabber_received</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mac_receive_error</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">bad_crc_event</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">collision</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">late_collision</span> <span class="o">+=</span> <span class="n">mib_read</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">);</span>
	<span class="cm">/* Non MIB hardware counters */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_discard</span> <span class="o">+=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RX_DISCARD_FRAME_CNT</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_overrun</span> <span class="o">+=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RX_OVERRUN_FRAME_CNT</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_lock</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mib_counters_timer_wrapper</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_mp</span><span class="p">;</span>

	<span class="n">mib_counters_update</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* interrupt coalescing *****************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Hardware coalescing parameters are set in units of 64 t_clk</span>
<span class="cm"> * cycles.  I.e.:</span>
<span class="cm"> *</span>
<span class="cm"> *	coal_delay_in_usec = 64000000 * register_value / t_clk_rate</span>
<span class="cm"> *</span>
<span class="cm"> *	register_value = coal_delay_in_usec * t_clk_rate / 64000000</span>
<span class="cm"> *</span>
<span class="cm"> * In the -&gt;set*() methods, we round the computed register value</span>
<span class="cm"> * to the nearest integer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_rx_coal</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">SDMA_CONFIG</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">extended_rx_coal_limit</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x003fff80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x003fff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">*=</span> <span class="mi">64000000</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rx_coal</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">usec</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mi">31999999</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">64000000</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">SDMA_CONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">extended_rx_coal_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x023fff80</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mh">0x3fff</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x003fff00</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">SDMA_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_tx_coal</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_FIFO_URGENT_THRESHOLD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">*=</span> <span class="mi">64000000</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_tx_coal</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">usec</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mi">31999999</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">64000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mh">0x3fff</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TX_FIFO_URGENT_THRESHOLD</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ethtool ******************************************************************/</span>
<span class="k">struct</span> <span class="n">mv643xx_eth_stats</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">stat_string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sizeof_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">netdev_off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mp_off</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SSTAT(m)						\</span>
<span class="cp">	{ #m, FIELD_SIZEOF(struct net_device_stats, m),		\</span>
<span class="cp">	  offsetof(struct net_device, stats.m), -1 }</span>

<span class="cp">#define MIBSTAT(m)						\</span>
<span class="cp">	{ #m, FIELD_SIZEOF(struct mib_counters, m),		\</span>
<span class="cp">	  -1, offsetof(struct mv643xx_eth_private, mib_counters.m) }</span>

<span class="cp">#define LROSTAT(m)						\</span>
<span class="cp">	{ #m, FIELD_SIZEOF(struct lro_counters, m),		\</span>
<span class="cp">	  -1, offsetof(struct mv643xx_eth_private, lro_counters.m) }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mv643xx_eth_stats</span> <span class="n">mv643xx_eth_stats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">rx_packets</span><span class="p">),</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">tx_packets</span><span class="p">),</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">rx_bytes</span><span class="p">),</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">tx_bytes</span><span class="p">),</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">rx_errors</span><span class="p">),</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">tx_errors</span><span class="p">),</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">rx_dropped</span><span class="p">),</span>
	<span class="n">SSTAT</span><span class="p">(</span><span class="n">tx_dropped</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">good_octets_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">bad_octets_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">internal_mac_transmit_err</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">good_frames_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">bad_frames_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">broadcast_frames_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">multicast_frames_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">frames_64_octets</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">frames_65_to_127_octets</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">frames_128_to_255_octets</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">frames_256_to_511_octets</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">frames_512_to_1023_octets</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">frames_1024_to_max_octets</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">good_octets_sent</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">good_frames_sent</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">excessive_collision</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">multicast_frames_sent</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">broadcast_frames_sent</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">unrec_mac_control_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">fc_sent</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">good_fc_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">bad_fc_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">undersize_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">fragments_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">oversize_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">jabber_received</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">mac_receive_error</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">bad_crc_event</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">collision</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">late_collision</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">rx_discard</span><span class="p">),</span>
	<span class="n">MIBSTAT</span><span class="p">(</span><span class="n">rx_overrun</span><span class="p">),</span>
	<span class="n">LROSTAT</span><span class="p">(</span><span class="n">lro_aggregated</span><span class="p">),</span>
	<span class="n">LROSTAT</span><span class="p">(</span><span class="n">lro_flushed</span><span class="p">),</span>
	<span class="n">LROSTAT</span><span class="p">(</span><span class="n">lro_no_desc</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_get_settings_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">phy_read_status</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The MAC does not support 1000baseT_Half.</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_1000baseT_Half</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADVERTISED_1000baseT_Half</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_get_settings_phyless</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">port_status</span><span class="p">;</span>

	<span class="n">port_status</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_STATUS</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_MII</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_MII</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_SPEED_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_10</span>:
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_10</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_100</span>:
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_100</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_1000</span>:
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">FULL_DUPLEX</span><span class="p">)</span> <span class="o">?</span> <span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mv643xx_eth_get_settings_phy</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">mv643xx_eth_get_settings_phyless</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The MAC does not support 1000baseT_Half.</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADVERTISED_1000baseT_Half</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">mv643xx_eth_driver_name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">mv643xx_eth_driver_version</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;platform&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">n_stats</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mv643xx_eth_stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genphy_restart_aneg</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">get_rx_coal</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">get_tx_coal</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">set_rx_coal</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">);</span>
	<span class="n">set_tx_coal</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mv643xx_eth_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">er</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">er</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">er</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

	<span class="n">er</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="n">er</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">er</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">er</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">||</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&lt;</span> <span class="mi">4096</span> <span class="o">?</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">:</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;</span> <span class="mi">4096</span> <span class="o">?</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">:</span> <span class="mi">4096</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mv643xx_eth_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mv643xx_eth_open</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;fatal error on re-opening device after ring param change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mv643xx_eth_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">rx_csum</span> <span class="o">=</span> <span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_CONFIG</span><span class="p">,</span> <span class="n">rx_csum</span> <span class="o">?</span> <span class="mh">0x02000000</span> <span class="o">:</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">uint32_t</span> <span class="n">stringset</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stringset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mv643xx_eth_stats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">,</span>
				<span class="n">mv643xx_eth_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_string</span><span class="p">,</span>
				<span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
					  <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mv643xx_eth_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mib_counters_update</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">mv643xx_eth_grab_lro_stats</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mv643xx_eth_stats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">mv643xx_eth_stats</span> <span class="o">*</span><span class="n">stat</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">mv643xx_eth_stats</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">netdev_off</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">netdev_off</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="p">)</span> <span class="o">+</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mp_off</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sizeof_stat</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span>
				<span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">:</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sset</span> <span class="o">==</span> <span class="n">ETH_SS_STATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mv643xx_eth_stats</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">mv643xx_eth_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">mv643xx_eth_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">mv643xx_eth_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">mv643xx_eth_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">mv643xx_eth_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span>		<span class="o">=</span> <span class="n">mv643xx_eth_get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span>		<span class="o">=</span> <span class="n">mv643xx_eth_set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">mv643xx_eth_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>		<span class="o">=</span> <span class="n">mv643xx_eth_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">mv643xx_eth_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">mv643xx_eth_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">mv643xx_eth_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span>		<span class="o">=</span> <span class="n">ethtool_op_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* address handling *********************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uc_addr_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mac_h</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">MAC_ADDR_HIGH</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mac_l</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">MAC_ADDR_LOW</span><span class="p">);</span>

	<span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_h</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_h</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_h</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_h</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_l</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac_l</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uc_addr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">MAC_ADDR_HIGH</span><span class="p">,</span>
		<span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">MAC_ADDR_LOW</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">uc_addr_filter_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nibbles</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nibbles</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">netdev_for_each_uc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">nibbles</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nibbles</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_program_unicast_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">port_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nibbles</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">uc_addr_set</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">port_config</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UNICAST_PROMISCUOUS_MODE</span><span class="p">;</span>

	<span class="n">nibbles</span> <span class="o">=</span> <span class="n">uc_addr_filter_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nibbles</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_config</span> <span class="o">|=</span> <span class="n">UNICAST_PROMISCUOUS_MODE</span><span class="p">;</span>
		<span class="n">nibbles</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="n">UNICAST_TABLE</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

		<span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nibbles</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x00000001</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nibbles</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x00000100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nibbles</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x00010000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nibbles</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x01000000</span><span class="p">;</span>
		<span class="n">nibbles</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">wrl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_CONFIG</span><span class="p">,</span> <span class="n">port_config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">addr_crc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">^</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span>
				<span class="n">crc</span> <span class="o">^=</span> <span class="mh">0x107</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_program_multicast_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mc_spec</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mc_other</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_PROMISC</span> <span class="o">|</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">port_num</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">accept</span><span class="p">;</span>

<span class="nl">oom:</span>
		<span class="n">port_num</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">;</span>
		<span class="n">accept</span> <span class="o">=</span> <span class="mh">0x01010101</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wrl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">SPECIAL_MCAST_TABLE</span><span class="p">(</span><span class="n">port_num</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">accept</span><span class="p">);</span>
			<span class="n">wrl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">OTHER_MCAST_TABLE</span><span class="p">(</span><span class="n">port_num</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">accept</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mc_spec</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc_spec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
	<span class="n">mc_other</span> <span class="o">=</span> <span class="n">mc_spec</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mc_spec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mc_other</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x00\x5e\x00\x00</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">table</span> <span class="o">=</span> <span class="n">mc_spec</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">table</span> <span class="o">=</span> <span class="n">mc_other</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">addr_crc</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">table</span><span class="p">[</span><span class="n">entry</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">SPECIAL_MCAST_TABLE</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">mc_spec</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="n">wrl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">OTHER_MCAST_TABLE</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">mc_other</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mc_spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mv643xx_eth_program_unicast_filter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mv643xx_eth_program_multicast_filter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mv643xx_eth_program_unicast_filter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* rx/tx queue initialisation ***********************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_addr</span><span class="p">,</span>
						<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_size</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
						       <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">,</span>
						       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;can&#39;t allocate rx ring (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate rx skb ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nexti</span><span class="p">;</span>

		<span class="n">nexti</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nexti</span> <span class="o">==</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">)</span>
			<span class="n">nexti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc_ptr</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span> <span class="o">+</span>
					<span class="n">nexti</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">LRO_F_NAPI</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">ip_summed_aggr</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">max_desc</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_arr</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">max_aggr</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">frag_align_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">lro_arr</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_arr</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_mgr</span><span class="p">.</span><span class="n">get_skb_header</span> <span class="o">=</span> <span class="n">mv643xx_get_skb_header</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lro_arr</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


<span class="nl">out_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_size</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				  <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span><span class="p">,</span>
				  <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rxq_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">rxq_to_mp</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rxq_disable</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error freeing rx ring -- %d skbs stuck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area_size</span> <span class="o">&lt;=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_size</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area_size</span><span class="p">,</span>
				  <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_area</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_used_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_addr</span><span class="p">,</span>
						<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_size</span><span class="p">);</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
						       <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span><span class="p">,</span>
						       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;can&#39;t allocate tx ring (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">tx_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="n">tx_desc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nexti</span><span class="p">;</span>

		<span class="n">nexti</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nexti</span> <span class="o">==</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">)</span>
			<span class="n">nexti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">cmd_sts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">next_desc_ptr</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span> <span class="o">+</span>
					<span class="n">nexti</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txq_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">txq_to_mp</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">txq_disable</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">txq_reclaim</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_used_desc</span> <span class="o">!=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area_size</span> <span class="o">&lt;=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_size</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area_size</span><span class="p">,</span>
				  <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_area</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* netdev ops and related ***************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_collect_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">int_cause</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_cause_ext</span><span class="p">;</span>

	<span class="n">int_cause</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_CAUSE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_cause</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">int_cause_ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_cause</span> <span class="o">&amp;</span> <span class="n">INT_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_cause</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_EXT</span><span class="p">;</span>
		<span class="n">int_cause_ext</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_CAUSE_EXT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_cause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_CAUSE</span><span class="p">,</span> <span class="o">~</span><span class="n">int_cause</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx_end</span> <span class="o">|=</span> <span class="p">((</span><span class="n">int_cause</span> <span class="o">&amp;</span> <span class="n">INT_TX_END</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">TXQ_COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">int_cause</span> <span class="o">&amp;</span> <span class="n">INT_RX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">int_cause_ext</span> <span class="o">&amp;=</span> <span class="n">INT_EXT_LINK_PHY</span> <span class="o">|</span> <span class="n">INT_EXT_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_cause_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_CAUSE_EXT</span><span class="p">,</span> <span class="o">~</span><span class="n">int_cause_ext</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_cause_ext</span> <span class="o">&amp;</span> <span class="n">INT_EXT_LINK_PHY</span><span class="p">)</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx</span> <span class="o">|=</span> <span class="n">int_cause_ext</span> <span class="o">&amp;</span> <span class="n">INT_EXT_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mv643xx_eth_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mv643xx_eth_collect_events</span><span class="p">(</span><span class="n">mp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_link_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">port_status</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">LINK_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

				<span class="n">txq_reclaim</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">txq_reset_hw_ptr</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_SPEED_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_10</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_100</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_1000</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">FULL_DUPLEX</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">FLOW_CONTROL_ENABLED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link up, %d Mb/s, %s duplex, flow control %sabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">,</span> <span class="n">fc</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mv643xx_eth_private</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">oom</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">oom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">queue_mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">queue</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">work_tbd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">handle_link_event</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="n">work_done</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">queue_mask</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx</span> <span class="o">|</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx_end</span> <span class="o">|</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">oom</span><span class="p">))</span>
			<span class="n">queue_mask</span> <span class="o">|=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx_refill</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mv643xx_eth_collect_events</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">queue</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">queue_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">queue_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">queue</span><span class="p">;</span>

		<span class="n">work_tbd</span> <span class="o">=</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">work_done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_tbd</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">work_tbd</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx_end</span> <span class="o">&amp;</span> <span class="n">queue_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txq_kick</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_tx</span> <span class="o">&amp;</span> <span class="n">queue_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">work_done</span> <span class="o">+=</span> <span class="n">txq_reclaim</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">queue</span><span class="p">,</span> <span class="n">work_tbd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">txq_maybe_wake</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx</span> <span class="o">&amp;</span> <span class="n">queue_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">work_done</span> <span class="o">+=</span> <span class="n">rxq_process</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">queue</span><span class="p">,</span> <span class="n">work_tbd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">oom</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">work_rx_refill</span> <span class="o">&amp;</span> <span class="n">queue_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">work_done</span> <span class="o">+=</span> <span class="n">rxq_refill</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">queue</span><span class="p">,</span> <span class="n">work_tbd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">oom</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">));</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">oom_timer_wrapper</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">|=</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_write</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">phy_read</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pscr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Perform PHY reset, if there is a PHY.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="n">mv643xx_eth_get_settings</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">phy_reset</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">mv643xx_eth_set_settings</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure basic link parameters.</span>
<span class="cm">	 */</span>
	<span class="n">pscr</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">);</span>

	<span class="n">pscr</span> <span class="o">|=</span> <span class="n">SERIAL_PORT_ENABLE</span><span class="p">;</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">,</span> <span class="n">pscr</span><span class="p">);</span>

	<span class="n">pscr</span> <span class="o">|=</span> <span class="n">DO_NOT_FORCE_LINK_FAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pscr</span> <span class="o">|=</span> <span class="n">FORCE_LINK_PASS</span><span class="p">;</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">,</span> <span class="n">pscr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure TX path and queues.</span>
<span class="cm">	 */</span>
	<span class="n">tx_set_rate</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mi">1000000000</span><span class="p">,</span> <span class="mi">16777216</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">txq_reset_hw_ptr</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">txq_set_rate</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="mi">1000000000</span><span class="p">,</span> <span class="mi">16777216</span><span class="p">);</span>
		<span class="n">txq_set_fixed_prio_mode</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Receive all unmatched unicast, TCP, UDP, BPDU and broadcast</span>
<span class="cm">	 * frames to RX queue #0, and include the pseudo-header when</span>
<span class="cm">	 * calculating receive checksums.</span>
<span class="cm">	 */</span>
	<span class="n">mv643xx_eth_set_features</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Treat BPDUs as normal multicasts, and disable partition mode.</span>
<span class="cm">	 */</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_CONFIG_EXT</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add configured unicast addresses to address filter table.</span>
<span class="cm">	 */</span>
	<span class="n">mv643xx_eth_program_unicast_filter</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable the receive queues.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">);</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">RXQ_CURRENT_DESC_PTR</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>

		<span class="n">rxq_enable</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_recalc_skb_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">skb_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserve 2+14 bytes for an ethernet header (the hardware</span>
<span class="cm">	 * automatically prepends 2 bytes of dummy data to each</span>
<span class="cm">	 * received packet), 16 bytes for up to four VLAN tags, and</span>
<span class="cm">	 * 4 bytes for the trailing FCS -- 36 bytes total.</span>
<span class="cm">	 */</span>
	<span class="n">skb_size</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">36</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that the skb size is a multiple of 8 bytes, as</span>
<span class="cm">	 * the lower three bits of the receive descriptor&#39;s buffer</span>
<span class="cm">	 * size field are ignored by the hardware.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">skb_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_size</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If NET_SKB_PAD is smaller than a cache line,</span>
<span class="cm">	 * netdev_alloc_skb() will cause skb-&gt;data to be misaligned</span>
<span class="cm">	 * to a cache line boundary.  If this is the case, include</span>
<span class="cm">	 * some extra space to allow re-aligning the data area.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">skb_size</span> <span class="o">+=</span> <span class="n">SKB_DMA_REALIGN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_CAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_CAUSE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_CAUSE_EXT</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mv643xx_eth_irq</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t assign irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mv643xx_eth_recalc_skb_size</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">);</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">int_mask</span> <span class="o">=</span> <span class="n">INT_EXT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rxq_init</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rxq_deinit</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rxq_refill</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">int_mask</span> <span class="o">|=</span> <span class="n">INT_RX_0</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">oom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">txq_init</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">txq_deinit</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">int_mask</span> <span class="o">|=</span> <span class="n">INT_TX_END_0</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port_start</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK_EXT</span><span class="p">,</span> <span class="n">INT_EXT_LINK_PHY</span> <span class="o">|</span> <span class="n">INT_EXT_TX</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


<span class="nl">out_free:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rxq_deinit</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">port_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rxq_disable</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txq_disable</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_IN_PROGRESS</span> <span class="o">|</span> <span class="n">TX_FIFO_EMPTY</span><span class="p">))</span> <span class="o">==</span> <span class="n">TX_FIFO_EMPTY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the Enable bit in the Configuration Register */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SERIAL_PORT_ENABLE</span>		<span class="o">|</span>
		  <span class="n">DO_NOT_FORCE_LINK_FAIL</span>	<span class="o">|</span>
		  <span class="n">FORCE_LINK_PASS</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK_EXT</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">port_reset</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">mv643xx_eth_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mib_counters_update</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_timer</span><span class="p">);</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_recycle</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rxq_deinit</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txq_deinit</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_mii_ioctl</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="mi">9500</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="n">mv643xx_eth_recalc_skb_size</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">tx_set_rate</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mi">1000000000</span><span class="p">,</span> <span class="mi">16777216</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop and then re-open the interface. This will allocate RX</span>
<span class="cm">	 * skbs of the new MTU.</span>
<span class="cm">	 * There is a possible danger that the open will not succeed,</span>
<span class="cm">	 * due to memory being full.</span>
<span class="cm">	 */</span>
	<span class="n">mv643xx_eth_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mv643xx_eth_open</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;fatal error on re-opening device after MTU change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ugly</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ugly</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mv643xx_eth_private</span><span class="p">,</span> <span class="n">tx_timeout_task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">port_reset</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">port_start</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">);</span>

	<span class="n">mv643xx_eth_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/* platform glue ************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mv643xx_eth_conf_mbus_windows</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">mbus_dram_target_info</span> <span class="o">*</span><span class="n">dram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">win_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">win_protect</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">WINDOW_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">WINDOW_SIZE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">WINDOW_REMAP_HIGH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">win_enable</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">win_protect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">num_cs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">mbus_dram_window</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mbus_attr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">dram</span><span class="o">-&gt;</span><span class="n">mbus_dram_target_id</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">WINDOW_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">WINDOW_SIZE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="n">win_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">win_protect</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">win_enable</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">WINDOW_BAR_ENABLE</span><span class="p">);</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">win_protect</span> <span class="o">=</span> <span class="n">win_protect</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">infer_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check whether we have a 14-bit coal limit field in bits</span>
<span class="cm">	 * [21:8], or a 16-bit coal limit in bits [25,21:7] of the</span>
<span class="cm">	 * SDMA config register.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x02000000</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0400</span> <span class="o">+</span> <span class="n">SDMA_CONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0400</span> <span class="o">+</span> <span class="n">SDMA_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02000000</span><span class="p">)</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">extended_rx_coal_limit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">extended_rx_coal_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether the MAC supports TX rate control, and if</span>
<span class="cm">	 * yes, whether its associated registers are in the old or</span>
<span class="cm">	 * the new place.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0400</span> <span class="o">+</span> <span class="n">TX_BW_MTU_MOVED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0400</span> <span class="o">+</span> <span class="n">TX_BW_MTU_MOVED</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">tx_bw_control</span> <span class="o">=</span> <span class="n">TX_BW_CONTROL_NEW_LAYOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0400</span> <span class="o">+</span> <span class="n">TX_BW_RATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0400</span> <span class="o">+</span> <span class="n">TX_BW_RATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">msp</span><span class="o">-&gt;</span><span class="n">tx_bw_control</span> <span class="o">=</span> <span class="n">TX_BW_CONTROL_OLD_LAYOUT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">msp</span><span class="o">-&gt;</span><span class="n">tx_bw_control</span> <span class="o">=</span> <span class="n">TX_BW_CONTROL_ABSENT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_shared_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">mv643xx_eth_version_printed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_platform_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mbus_dram_target_info</span> <span class="o">*</span><span class="n">dram</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mv643xx_eth_version_printed</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;MV-643xx 10/100/1000 ethernet driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">mv643xx_eth_driver_version</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">msp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up and register SMI bus.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">shared_smi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span> <span class="o">=</span> <span class="n">mdiobus_alloc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>

		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">msp</span><span class="p">;</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mv643xx_eth smi&quot;</span><span class="p">;</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">smi_bus_read</span><span class="p">;</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">smi_bus_write</span><span class="p">,</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MII_BUS_ID_SIZE</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="o">-&gt;</span><span class="n">phy_mask</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdiobus_register</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_mii_bus</span><span class="p">;</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi</span> <span class="o">=</span> <span class="n">msp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">shared_smi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">err_interrupt</span> <span class="o">=</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_busy_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether the error interrupt is hooked up.</span>
<span class="cm">	 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">mv643xx_eth_err_irq</span><span class="p">,</span>
				  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;mv643xx_eth&quot;</span><span class="p">,</span> <span class="n">msp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ERR_INT_SMI_DONE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ERR_INT_MASK</span><span class="p">);</span>
			<span class="n">msp</span><span class="o">-&gt;</span><span class="n">err_interrupt</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (Re-)program MBUS remapping windows if we are asked to.</span>
<span class="cm">	 */</span>
	<span class="n">dram</span> <span class="o">=</span> <span class="n">mv_mbus_dram_info</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dram</span><span class="p">)</span>
		<span class="n">mv643xx_eth_conf_mbus_windows</span><span class="p">(</span><span class="n">msp</span><span class="p">,</span> <span class="n">dram</span><span class="p">);</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">tx_csum_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_csum_limit</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_csum_limit</span> <span class="o">:</span> <span class="mi">9</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">infer_hw_params</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">msp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_mii_bus:</span>
	<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="p">);</span>
<span class="nl">out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_shared_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_private</span> <span class="o">*</span><span class="n">msp</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_shared_platform_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">shared_smi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="p">);</span>
		<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">err_interrupt</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">err_interrupt</span><span class="p">,</span> <span class="n">msp</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mv643xx_eth_shared_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mv643xx_eth_shared_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mv643xx_eth_shared_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MV643XX_ETH_SHARED_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">phy_addr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">addr_shift</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">rdl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PHY_ADDR</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="n">addr_shift</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">phy_addr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">addr_shift</span><span class="p">;</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PHY_ADDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">phy_addr_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">rdl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PHY_ADDR</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">mv643xx_eth_platform_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">uc_addr_get</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">DEFAULT_RX_QUEUE_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_queue_size</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_queue_size</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_addr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_sram_addr</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_desc_sram_size</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_sram_size</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_queue_count</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">DEFAULT_TX_QUEUE_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_queue_size</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_queue_size</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_addr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_sram_addr</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_size</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_sram_size</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_queue_count</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="nf">phy_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">smi</span><span class="o">-&gt;</span><span class="n">smi_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_addr</span> <span class="o">==</span> <span class="n">MV643XX_ETH_PHY_ADDR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">phy_addr_get</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">phy_addr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phydev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mdiobus_scan</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phydev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">phy_addr_set</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">phydev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">phy_reset</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="n">phy_attach</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PHY_INTERFACE_MODE_GMII</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">duplex</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy_start_aneg</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_pscr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pscr</span><span class="p">;</span>

	<span class="n">pscr</span> <span class="o">=</span> <span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pscr</span> <span class="o">&amp;</span> <span class="n">SERIAL_PORT_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pscr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SERIAL_PORT_ENABLE</span><span class="p">;</span>
		<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">,</span> <span class="n">pscr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pscr</span> <span class="o">=</span> <span class="n">MAX_RX_PACKET_9700BYTE</span> <span class="o">|</span> <span class="n">SERIAL_PORT_CONTROL_RESERVED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pscr</span> <span class="o">|=</span> <span class="n">DISABLE_AUTO_NEG_SPEED_GMII</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">pscr</span> <span class="o">|=</span> <span class="n">SET_GMII_SPEED_TO_1000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="n">pscr</span> <span class="o">|=</span> <span class="n">SET_MII_SPEED_TO_100</span><span class="p">;</span>

		<span class="n">pscr</span> <span class="o">|=</span> <span class="n">DISABLE_AUTO_NEG_FOR_FLOW_CTRL</span><span class="p">;</span>

		<span class="n">pscr</span> <span class="o">|=</span> <span class="n">DISABLE_AUTO_NEG_FOR_DUPLEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">pscr</span> <span class="o">|=</span> <span class="n">SET_FULL_DUPLEX_MODE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">PORT_SERIAL_CONTROL</span><span class="p">,</span> <span class="n">pscr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">mv643xx_eth_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">mv643xx_eth_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">mv643xx_eth_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">mv643xx_eth_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">mv643xx_eth_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">mv643xx_eth_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">mv643xx_eth_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">mv643xx_eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">mv643xx_eth_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">mv643xx_eth_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">mv643xx_eth_get_stats</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">mv643xx_eth_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_platform_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no mv643xx_eth_platform_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">shared</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no mv643xx_eth_platform_data-&gt;shared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mv643xx_eth_private</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0400</span> <span class="o">+</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_number</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_number</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start with a default rate, and if there is a clock, allow</span>
<span class="cm">	 * it to override the default.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span> <span class="o">=</span> <span class="mi">133000000</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_HAVE_CLK)</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">t_clk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">set_params</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">txq_count</span><span class="p">);</span>
	<span class="n">netif_set_real_num_rx_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">rxq_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">!=</span> <span class="n">MV643XX_ETH_PHY_NONE</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_scan</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">phy_init</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mv643xx_eth_ethtool_ops</span><span class="p">);</span>

	<span class="n">init_pscr</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>


	<span class="n">mib_counters_clear</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_timer</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">mib_counters_timer_wrapper</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_timer</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">mib_counters_lock</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">,</span> <span class="n">tx_timeout_task</span><span class="p">);</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">mv643xx_eth_poll</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">rx_oom</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">oom_timer_wrapper</span><span class="p">;</span>


	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mv643xx_eth_netdev_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_UNICAST_FLT</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">win_protect</span><span class="p">)</span>
		<span class="n">wrl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">WINDOW_PROTECT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">),</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">win_protect</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">SDMA_CONFIG</span><span class="p">,</span> <span class="n">PORT_SDMA_CONFIG_DEFAULT_VALUE</span><span class="p">);</span>

	<span class="n">set_rx_coal</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="n">set_tx_coal</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;port %d with MAC address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">mp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_desc_sram_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;configured with sram</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mv643xx_eth_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">phy_detach</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_HAVE_CLK)</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mv643xx_eth_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_private</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Mask all interrupts on ethernet port */</span>
	<span class="n">wrlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rdlp</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">INT_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">port_reset</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mv643xx_eth_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mv643xx_eth_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mv643xx_eth_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">mv643xx_eth_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MV643XX_ETH_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv643xx_eth_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mv643xx_eth_shared_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mv643xx_eth_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mv643xx_eth_shared_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">mv643xx_eth_init_module</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mv643xx_eth_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mv643xx_eth_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mv643xx_eth_shared_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mv643xx_eth_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Rabeeh Khoury, Assaf Hoffman, Matthew Dharm, &quot;</span>
	      <span class="s">&quot;Manish Lachwani, Dale Farnsworth and Lennert Buytenhek&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Ethernet driver for Marvell MV643XX&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">MV643XX_ETH_SHARED_NAME</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">MV643XX_ETH_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
