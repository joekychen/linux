<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › marvell › sky2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sky2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * New driver for Marvell Yukon 2 chipset.</span>
<span class="cm"> * Based on earlier sk98lin, and skge driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver intentionally does not support all the features</span>
<span class="cm"> * of the original driver such as link fail-over and link management because</span>
<span class="cm"> * those should be done at higher levels.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Stephen Hemminger &lt;shemminger@osdl.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &quot;sky2.h&quot;</span>

<span class="cp">#define DRV_NAME		&quot;sky2&quot;</span>
<span class="cp">#define DRV_VERSION		&quot;1.30&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * The Yukon II chipset takes 64 bit command blocks (called list elements)</span>
<span class="cm"> * that are organized into three (receive, transmit, status) different rings</span>
<span class="cm"> * similar to Tigon3.</span>
<span class="cm"> */</span>

<span class="cp">#define RX_LE_SIZE	    	1024</span>
<span class="cp">#define RX_LE_BYTES		(RX_LE_SIZE*sizeof(struct sky2_rx_le))</span>
<span class="cp">#define RX_MAX_PENDING		(RX_LE_SIZE/6 - 2)</span>
<span class="cp">#define RX_DEF_PENDING		RX_MAX_PENDING</span>

<span class="cm">/* This is the worst case number of transmit list elements for a single skb:</span>
<span class="cm">   VLAN:GSO + CKSUM + Data + skb_frags * DMA */</span>
<span class="cp">#define MAX_SKB_TX_LE	(2 + (sizeof(dma_addr_t)/sizeof(u32))*(MAX_SKB_FRAGS+1))</span>
<span class="cp">#define TX_MIN_PENDING		(MAX_SKB_TX_LE+1)</span>
<span class="cp">#define TX_MAX_PENDING		1024</span>
<span class="cp">#define TX_DEF_PENDING		63</span>

<span class="cp">#define TX_WATCHDOG		(5 * HZ)</span>
<span class="cp">#define NAPI_WEIGHT		64</span>
<span class="cp">#define PHY_RETRIES		1000</span>

<span class="cp">#define SKY2_EEPROM_MAGIC	0x9955aabb</span>

<span class="cp">#define RING_NEXT(x, s)	(((x)+1) &amp; ((s)-1))</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">default_msg</span> <span class="o">=</span>
    <span class="n">NETIF_MSG_DRV</span> <span class="o">|</span> <span class="n">NETIF_MSG_PROBE</span> <span class="o">|</span> <span class="n">NETIF_MSG_LINK</span>
    <span class="o">|</span> <span class="n">NETIF_MSG_TIMER</span> <span class="o">|</span> <span class="n">NETIF_MSG_TX_ERR</span> <span class="o">|</span> <span class="n">NETIF_MSG_RX_ERR</span>
    <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFDOWN</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* defaults above */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0=none,...,16=all)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">copybreak</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span> <span class="s">&quot;Receive copy threshold&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_msi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_msi</span><span class="p">,</span> <span class="s">&quot;Disable Message Signaled Interrupt (MSI)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">legacy_pme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">legacy_pme</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">legacy_pme</span><span class="p">,</span> <span class="s">&quot;Legacy power management&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">sky2_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SYSKONNECT</span><span class="p">,</span> <span class="mh">0x9000</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* SK-9Sxx */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SYSKONNECT</span><span class="p">,</span> <span class="mh">0x9E00</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* SK-9Exx */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SYSKONNECT</span><span class="p">,</span> <span class="mh">0x9E01</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* SK-9E21M */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">,</span> <span class="mh">0x4b00</span><span class="p">)</span> <span class="p">},</span>	<span class="cm">/* DGE-560T */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">,</span> <span class="mh">0x4001</span><span class="p">)</span> <span class="p">},</span> 	<span class="cm">/* DGE-550SX */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">,</span> <span class="mh">0x4B02</span><span class="p">)</span> <span class="p">},</span>	<span class="cm">/* DGE-560SX */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">,</span> <span class="mh">0x4B03</span><span class="p">)</span> <span class="p">},</span>	<span class="cm">/* DGE-550T */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4340</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8021 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4341</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8022 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4342</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8061 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4343</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8062 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4344</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8021 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4345</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8022 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4346</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8061 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4347</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8062 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4350</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8035 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4351</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8036 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4352</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8038 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4353</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8039 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4354</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8040 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4355</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8040T */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4356</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88EC033 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4357</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8042 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x435A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8048 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4360</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8052 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4361</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8050 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4362</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8053 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4363</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8055 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4364</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8056 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4365</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8070 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4366</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88EC036 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4367</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88EC032 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4368</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88EC034 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4369</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88EC042 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x436A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8058 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x436B</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8071 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x436C</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8072 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x436D</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8055 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4370</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8075 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4380</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8057 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span> <span class="mh">0x4381</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* 88E8059 */</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">sky2_id_table</span><span class="p">);</span>

<span class="cm">/* Avoid conditionals by using array */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">txqaddr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Q_XA1</span><span class="p">,</span> <span class="n">Q_XA2</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">rxqaddr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Q_R1</span><span class="p">,</span> <span class="n">Q_R2</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">portirq_msk</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Y2_IS_PORT_1</span><span class="p">,</span> <span class="n">Y2_IS_PORT_2</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sky2_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sky2_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="cm">/* Access to PHY via serial interconnect */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gm_phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SMI_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SMI_CTRL</span><span class="p">,</span>
		    <span class="n">GM_SMI_CT_PHY_AD</span><span class="p">(</span><span class="n">PHY_ADDR_MARV</span><span class="p">)</span> <span class="o">|</span> <span class="n">GM_SMI_CT_REG_AD</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SMI_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">io_error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">GM_SMI_CT_BUSY</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy write timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

<span class="nl">io_error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy I/O error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__gm_phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SMI_CTRL</span><span class="p">,</span> <span class="n">GM_SMI_CT_PHY_AD</span><span class="p">(</span><span class="n">PHY_ADDR_MARV</span><span class="p">)</span>
		    <span class="o">|</span> <span class="n">GM_SMI_CT_REG_AD</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">GM_SMI_CT_OP_RD</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SMI_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">io_error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">GM_SMI_CT_RD_VAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SMI_DATA</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy read timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="nl">io_error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: phy I/O error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">gm_phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">__gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* switch power to VCC (WA for VAUX problem) */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_POWER_CTRL</span><span class="p">,</span>
		    <span class="n">PC_VAUX_ENA</span> <span class="o">|</span> <span class="n">PC_VCC_ENA</span> <span class="o">|</span> <span class="n">PC_VAUX_OFF</span> <span class="o">|</span> <span class="n">PC_VCC_ON</span><span class="p">);</span>

	<span class="cm">/* disable Core Clock Division, */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_Y2_CLK_CTRL</span><span class="p">,</span> <span class="n">Y2_CLK_DIV_DIS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;</span> <span class="n">CHIP_REV_YU_XL_A1</span><span class="p">)</span>
		<span class="cm">/* enable bits are inverted */</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_Y2_CLK_GATE</span><span class="p">,</span>
			    <span class="n">Y2_PCI_CLK_LNK1_DIS</span> <span class="o">|</span> <span class="n">Y2_COR_CLK_LNK1_DIS</span> <span class="o">|</span>
			    <span class="n">Y2_CLK_GAT_LNK1_DIS</span> <span class="o">|</span> <span class="n">Y2_PCI_CLK_LNK2_DIS</span> <span class="o">|</span>
			    <span class="n">Y2_COR_CLK_LNK2_DIS</span> <span class="o">|</span> <span class="n">Y2_CLK_GAT_LNK2_DIS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_Y2_CLK_GATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">sky2_pci_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG4</span><span class="p">);</span>
		<span class="cm">/* set all bits to 0 except bits 15..12 and 8 */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="n">P_ASPM_CONTROL_MSK</span><span class="p">;</span>
		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG4</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">sky2_pci_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG5</span><span class="p">);</span>
		<span class="cm">/* set all bits to 0 except bits 28 &amp; 27 */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="n">P_CTL_TIM_VMAIN_AV_MSK</span><span class="p">;</span>
		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG5</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_CFG_REG_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">Y2_HW_WOL_ON</span><span class="p">);</span>

		<span class="cm">/* Enable workaround for dev 4.107 on Yukon-Ultra &amp; Extreme */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_GP_IO</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GLB_GPIO_STAT_RACE_DIS</span><span class="p">;</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_GP_IO</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_GP_IO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on &quot;driver loaded&quot; LED */</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">Y2_LED_STAT_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_power_aux</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;</span> <span class="n">CHIP_REV_YU_XL_A1</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_Y2_CLK_GATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* enable bits are inverted */</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_Y2_CLK_GATE</span><span class="p">,</span>
			    <span class="n">Y2_PCI_CLK_LNK1_DIS</span> <span class="o">|</span> <span class="n">Y2_COR_CLK_LNK1_DIS</span> <span class="o">|</span>
			    <span class="n">Y2_CLK_GAT_LNK1_DIS</span> <span class="o">|</span> <span class="n">Y2_PCI_CLK_LNK2_DIS</span> <span class="o">|</span>
			    <span class="n">Y2_COR_CLK_LNK2_DIS</span> <span class="o">|</span> <span class="n">Y2_CLK_GAT_LNK2_DIS</span><span class="p">);</span>

	<span class="cm">/* switch power to VAUX if supported and PME from D3cold */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Y2_VAUX_AVAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">pci_pme_capable</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">))</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_POWER_CTRL</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">PC_VAUX_ENA</span> <span class="o">|</span> <span class="n">PC_VCC_ENA</span> <span class="o">|</span>
			     <span class="n">PC_VAUX_ON</span> <span class="o">|</span> <span class="n">PC_VCC_OFF</span><span class="p">));</span>

	<span class="cm">/* turn off &quot;driver loaded LED&quot; */</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">Y2_LED_STAT_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_gmac_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* disable all GMAC IRQ&#39;s */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_IRQ_MSK</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* clear MC hash */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RX_CTRL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_RXCR_UCF_ENA</span> <span class="o">|</span> <span class="n">GM_RXCR_MCF_ENA</span><span class="p">;</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RX_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* flow control to advertise bits */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">copper_fc_adv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">FC_NONE</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_TX</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PHY_M_AN_ASP</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_RX</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PHY_M_AN_PC</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_BOTH</span><span class="p">]</span>	<span class="o">=</span> <span class="n">PHY_M_AN_PC</span> <span class="o">|</span> <span class="n">PHY_M_AN_ASP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* flow control to advertise bits when using 1000BaseX */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">fiber_fc_adv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">FC_NONE</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_M_P_NO_PAUSE_X</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_TX</span><span class="p">]</span>   <span class="o">=</span> <span class="n">PHY_M_P_ASYM_MD_X</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_RX</span><span class="p">]</span>	  <span class="o">=</span> <span class="n">PHY_M_P_SYM_MD_X</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_BOTH</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_M_P_BOTH_MD_X</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* flow control to GMA disable bits */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">gm_fc_disable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">FC_NONE</span><span class="p">]</span> <span class="o">=</span> <span class="n">GM_GPCR_FC_RX_DIS</span> <span class="o">|</span> <span class="n">GM_GPCR_FC_TX_DIS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_TX</span><span class="p">]</span>	  <span class="o">=</span> <span class="n">GM_GPCR_FC_RX_DIS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_RX</span><span class="p">]</span>	  <span class="o">=</span> <span class="n">GM_GPCR_FC_TX_DIS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FC_BOTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">ct1000</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">ledctrl</span><span class="p">,</span> <span class="n">ledover</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEWER_PHY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ectrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_CTRL</span><span class="p">);</span>

		<span class="n">ectrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PHY_M_EC_M_DSC_MSK</span> <span class="o">|</span> <span class="n">PHY_M_EC_S_DSC_MSK</span> <span class="o">|</span>
			   <span class="n">PHY_M_EC_MAC_S_MSK</span><span class="p">);</span>
		<span class="n">ectrl</span> <span class="o">|=</span> <span class="n">PHY_M_EC_MAC_S</span><span class="p">(</span><span class="n">MAC_TX_CLK_25_MHZ</span><span class="p">);</span>

		<span class="cm">/* on PHY 88E1040 Rev.D0 (and newer) downshift control changed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC</span><span class="p">)</span>
			<span class="cm">/* set downshift counter to 3x and enable downshift */</span>
			<span class="n">ectrl</span> <span class="o">|=</span> <span class="n">PHY_M_EC_DSC_2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHY_M_EC_DOWN_S_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* set master &amp; slave downshift counter to 1x */</span>
			<span class="n">ectrl</span> <span class="o">|=</span> <span class="n">PHY_M_EC_M_DSC</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHY_M_EC_S_DSC</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_CTRL</span><span class="p">,</span> <span class="n">ectrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_is_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_GIGABIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* enable automatic crossover */</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_PC_MDI_XMODE</span><span class="p">(</span><span class="n">PHY_M_PC_ENA_AUTO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_FE2_A0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">spec</span><span class="p">;</span>

				<span class="cm">/* Enable Class A driver for FE+ A0 */</span>
				<span class="n">spec</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_FE_SPEC_2</span><span class="p">);</span>
				<span class="n">spec</span> <span class="o">|=</span> <span class="n">PHY_M_FESC_SEL_CL_A</span><span class="p">;</span>
				<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_FE_SPEC_2</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* disable energy detect */</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_M_PC_EN_DET_MSK</span><span class="p">;</span>

			<span class="cm">/* enable automatic crossover */</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_PC_MDI_XMODE</span><span class="p">(</span><span class="n">PHY_M_PC_ENA_AUTO</span><span class="p">);</span>

			<span class="cm">/* downshift on PHY 88E1112 and 88E1149 is changed */</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEWER_PHY</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* set downshift counter to 3x and enable downshift */</span>
				<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_M_PC_DSC_MSK</span><span class="p">;</span>
				<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_PC_DSC</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHY_M_PC_DOWN_S_ENA</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* workaround for deviation #4.88 (CRC errors) */</span>
		<span class="cm">/* disable Automatic Crossover */</span>

		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_M_PC_MDIX_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* special setup for PHY 88E1112 Fiber */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_FIBRE_PHY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">);</span>

		<span class="cm">/* Fiber: select 1000BASE-X only mode MAC Specific Ctrl Reg. */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_M_MAC_MD_MSK</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_MAC_MODE_SEL</span><span class="p">(</span><span class="n">PHY_M_MAC_MD_1000BX</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pmd_type</span>  <span class="o">==</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* select page 1 to access Fiber registers */</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* for SFP-module set SIGDET polarity to low */</span>
			<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">);</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_FIB_SIGD_POL</span><span class="p">;</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="n">pg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">PHY_CT_RESET</span><span class="p">;</span>
	<span class="n">ct1000</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adv</span> <span class="o">=</span> <span class="n">PHY_AN_CSMA</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2_is_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
				<span class="n">ct1000</span> <span class="o">|=</span> <span class="n">PHY_M_1000C_AFD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">)</span>
				<span class="n">ct1000</span> <span class="o">|=</span> <span class="n">PHY_M_1000C_AHD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">PHY_M_AN_100_FD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">PHY_M_AN_100_HD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">PHY_M_AN_10_FD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">PHY_M_AN_10_HD</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* special defines for FIBER (88E1040S only) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">PHY_M_AN_1000X_AFD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">PHY_M_AN_1000X_AHD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Restart Auto-negotiation */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_CT_ANE</span> <span class="o">|</span> <span class="n">PHY_CT_RE_CFG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* forced speed/duplex settings */</span>
		<span class="n">ct1000</span> <span class="o">=</span> <span class="n">PHY_M_1000C_MSE</span><span class="p">;</span>

		<span class="cm">/* Disable auto update for duplex flow control and duplex */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_GPCR_AU_DUP_DIS</span> <span class="o">|</span> <span class="n">GM_GPCR_AU_SPD_DIS</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_CT_SP1000</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_GPCR_SPEED_1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_CT_SP100</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_GPCR_SPEED_100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_GPCR_DUP_FULL</span><span class="p">;</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_CT_DUP_MD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span> <span class="o">=</span> <span class="n">FC_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_PAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2_is_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">copper_fc_adv</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">fiber_fc_adv</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_GPCR_AU_FCT_DIS</span><span class="p">;</span>
 		<span class="n">reg</span> <span class="o">|=</span> <span class="n">gm_fc_disable</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span><span class="p">];</span>

		<span class="cm">/* Forward pause packets to GMAC? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span> <span class="o">&amp;</span> <span class="n">FC_RX</span><span class="p">)</span>
			<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_PAUSE_ON</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_PAUSE_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_GIGABIT</span><span class="p">)</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_1000T_CTRL</span><span class="p">,</span> <span class="n">ct1000</span><span class="p">);</span>

	<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_AUNE_ADV</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>
	<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Setup Phy LED&#39;s */</span>
	<span class="n">ledctrl</span> <span class="o">=</span> <span class="n">PHY_M_LED_PULS_DUR</span><span class="p">(</span><span class="n">PULS_170MS</span><span class="p">);</span>
	<span class="n">ledover</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_FE</span>:
		<span class="cm">/* on 88E3082 these bits are at 11..9 (shifted left) */</span>
		<span class="n">ledctrl</span> <span class="o">|=</span> <span class="n">PHY_M_LED_BLINK_RT</span><span class="p">(</span><span class="n">BLINK_84MS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_FE_LED_PAR</span><span class="p">);</span>

		<span class="cm">/* delete ACT LED control bits */</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_M_FELP_LED1_MSK</span><span class="p">;</span>
		<span class="cm">/* change ACT LED control to blink mode */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_FELP_LED1_CTRL</span><span class="p">(</span><span class="n">LED_PAR_CTRL_ACT_BL</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_FE_LED_PAR</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_FE_P</span>:
		<span class="cm">/* Enable Link Partner Next Page */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_PC_ENA_LIP_NP</span><span class="p">;</span>

		<span class="cm">/* disable Energy Detect and enable scrambler */</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PHY_M_PC_ENA_ENE_DT</span> <span class="o">|</span> <span class="n">PHY_M_PC_DIS_SCRAMB</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* set LED2 -&gt; ACT, LED1 -&gt; LINK, LED0 -&gt; SPEED */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">PHY_M_FELP_LED2_CTRL</span><span class="p">(</span><span class="n">LED_PAR_CTRL_ACT_BL</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PHY_M_FELP_LED1_CTRL</span><span class="p">(</span><span class="n">LED_PAR_CTRL_LINK</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PHY_M_FELP_LED0_CTRL</span><span class="p">(</span><span class="n">LED_PAR_CTRL_SPEED</span><span class="p">);</span>

		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_FE_LED_PAR</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_XL</span>:
		<span class="n">pg</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">);</span>

		<span class="cm">/* select page 3 to access LED control register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* set LED Function Control register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">PHY_M_LEDC_LOS_CTRL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* LINK/ACT */</span>
			      <span class="n">PHY_M_LEDC_INIT_CTRL</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* 10 Mbps */</span>
			      <span class="n">PHY_M_LEDC_STA1_CTRL</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* 100 Mbps */</span>
			      <span class="n">PHY_M_LEDC_STA0_CTRL</span><span class="p">(</span><span class="mi">7</span><span class="p">)));</span>	<span class="cm">/* 1000 Mbps */</span>

		<span class="cm">/* set Polarity Control register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_STAT</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">PHY_M_POLC_LS1_P_MIX</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">PHY_M_POLC_IS0_P_MIX</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">PHY_M_POLC_LOS_CTRL</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">PHY_M_POLC_INIT_CTRL</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">PHY_M_POLC_STA1_CTRL</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">PHY_M_POLC_STA0_CTRL</span><span class="p">(</span><span class="mi">2</span><span class="p">)));</span>

		<span class="cm">/* restore page register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="n">pg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EC_U</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EX</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_SUPR</span>:
		<span class="n">pg</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">);</span>

		<span class="cm">/* select page 3 to access LED control register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* set LED Function Control register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">PHY_M_LEDC_LOS_CTRL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* LINK/ACT */</span>
			      <span class="n">PHY_M_LEDC_INIT_CTRL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* 10 Mbps */</span>
			      <span class="n">PHY_M_LEDC_STA1_CTRL</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* 100 Mbps */</span>
			      <span class="n">PHY_M_LEDC_STA0_CTRL</span><span class="p">(</span><span class="mi">7</span><span class="p">)));</span><span class="cm">/* 1000 Mbps */</span>

		<span class="cm">/* set Blink Rate in LED Timer Control Register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_INT_MASK</span><span class="p">,</span>
			     <span class="n">ledctrl</span> <span class="o">|</span> <span class="n">PHY_M_LED_BLINK_RT</span><span class="p">(</span><span class="n">BLINK_84MS</span><span class="p">));</span>
		<span class="cm">/* restore page register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="n">pg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* set Tx LED (LED_TX) to blink mode on Rx OR Tx activity */</span>
		<span class="n">ledctrl</span> <span class="o">|=</span> <span class="n">PHY_M_LED_BLINK_RT</span><span class="p">(</span><span class="n">BLINK_84MS</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHY_M_LEDC_TX_CTRL</span><span class="p">;</span>

		<span class="cm">/* turn off the Rx LED (LED_RX) */</span>
		<span class="n">ledover</span> <span class="o">|=</span> <span class="n">PHY_M_LED_MO_RX</span><span class="p">(</span><span class="n">MO_LED_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_UL_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* apply fixes in PHY AFE */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

		<span class="cm">/* increase differential signal amplitude in 10BASE-T */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xaa99</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x2011</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fix for IEEE A/B Symmetry failure in 1000BASE-T */</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xa204</span><span class="p">);</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* set page register to 0 */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span> <span class="o">&amp;&amp;</span>
		   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_FE2_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* apply workaround for integrated resistors calibration */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PAGE_ADDR</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PAGE_DATA</span><span class="p">,</span> <span class="mh">0x3f60</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_OPT</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* apply fixes in PHY AFE */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mh">0x00ff</span><span class="p">);</span>

		<span class="cm">/* apply RDAC termination workaround */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x2800</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mh">0x2001</span><span class="p">);</span>

		<span class="cm">/* set page register back to 0 */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="n">CHIP_ID_YUKON_EX</span> <span class="o">&amp;&amp;</span>
		   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&lt;</span> <span class="n">CHIP_ID_YUKON_SUPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no effect on Yukon-XL */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_LED_CTRL</span><span class="p">,</span> <span class="n">ledctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* turn on 100 Mbps LED (LED_LINK100) */</span>
			<span class="n">ledover</span> <span class="o">|=</span> <span class="n">PHY_M_LED_MO_100</span><span class="p">(</span><span class="n">MO_LED_ON</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ledover</span><span class="p">)</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_LED_OVER</span><span class="p">,</span> <span class="n">ledover</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_PRM</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_MAC_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* This a phy register setup workaround copied from vendor driver. */</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">eee_afe</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x156</span><span class="p">,</span> <span class="mh">0x58ce</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x153</span><span class="p">,</span> <span class="mh">0x99eb</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x141</span><span class="p">,</span> <span class="mh">0x8064</span> <span class="p">},</span>
			<span class="cm">/* { 0x155, 0x130b },*/</span>
			<span class="p">{</span> <span class="mh">0x000</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x151</span><span class="p">,</span> <span class="mh">0x8433</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x14b</span><span class="p">,</span> <span class="mh">0x8c44</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x14c</span><span class="p">,</span> <span class="mh">0x0f90</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x14f</span><span class="p">,</span> <span class="mh">0x39aa</span> <span class="p">},</span>
			<span class="cm">/* { 0x154, 0x2f39 },*/</span>
			<span class="p">{</span> <span class="mh">0x14d</span><span class="p">,</span> <span class="mh">0xba33</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x144</span><span class="p">,</span> <span class="mh">0x0048</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x152</span><span class="p">,</span> <span class="mh">0x2010</span> <span class="p">},</span>
			<span class="cm">/* { 0x158, 0x1223 },*/</span>
			<span class="p">{</span> <span class="mh">0x140</span><span class="p">,</span> <span class="mh">0x4444</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x154</span><span class="p">,</span> <span class="mh">0x2f3b</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x158</span><span class="p">,</span> <span class="mh">0xb203</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x157</span><span class="p">,</span> <span class="mh">0x2029</span> <span class="p">},</span>
		<span class="p">};</span>

		<span class="cm">/* Start Workaround for OptimaEEE Rev.Z0 */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mh">0x00fb</span><span class="p">);</span>

		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mh">0x4099</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mh">0x1120</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x113c</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x8100</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x112a</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x1008</span><span class="p">);</span>

		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mh">0x20b0</span><span class="p">);</span>

		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mh">0x00ff</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eee_afe</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* apply AFE settings */</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">eee_afe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">eee_afe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">|</span> <span class="mi">1u</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* End Workaround for OptimaEEE */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Enable 10Base-Te (EEE) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">CHIP_ID_YUKON_PRM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_CTRL</span><span class="p">);</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_CTRL</span><span class="p">,</span>
				     <span class="n">reg</span> <span class="o">|</span> <span class="n">PHY_M_10B_TE_ENABLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable phy interrupt on auto-negotiation complete (or link up) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">)</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_INT_MASK</span><span class="p">,</span> <span class="n">PHY_M_IS_AN_COMPL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_INT_MASK</span><span class="p">,</span> <span class="n">PHY_M_DEF_MSK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">phy_power</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">PCI_Y2_PHY1_POWD</span><span class="p">,</span> <span class="n">PCI_Y2_PHY2_POWD</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">coma_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">PCI_Y2_PHY1_COMA</span><span class="p">,</span> <span class="n">PCI_Y2_PHY2_COMA</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_phy_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg1</span><span class="p">;</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_ON</span><span class="p">);</span>
	<span class="n">reg1</span> <span class="o">=</span> <span class="n">sky2_pci_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG1</span><span class="p">);</span>
	<span class="n">reg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">phy_power</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;</span> <span class="n">CHIP_REV_YU_XL_A1</span><span class="p">)</span>
		<span class="n">reg1</span> <span class="o">|=</span> <span class="n">coma_mode</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG1</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_OFF</span><span class="p">);</span>
	<span class="n">sky2_pci_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE</span><span class="p">)</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_CTRL</span><span class="p">,</span> <span class="n">PHY_CT_ANE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GPHY_CTRL</span><span class="p">),</span> <span class="n">GPC_RST_CLR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_phy_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* release GPHY Control reset */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GPHY_CTRL</span><span class="p">),</span> <span class="n">GPC_RST_CLR</span><span class="p">);</span>

	<span class="cm">/* release GMAC reset */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_RST_CLR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEWER_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* select page 2 to access MAC control register */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">);</span>
		<span class="cm">/* allow GMII Power Down */</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_M_MAC_GMIF_PUP</span><span class="p">;</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* set page register back to 0 */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup General Purpose Control Register */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span>
		    <span class="n">GM_GPCR_FL_PASS</span> <span class="o">|</span> <span class="n">GM_GPCR_SPEED_100</span> <span class="o">|</span>
		    <span class="n">GM_GPCR_AU_DUP_DIS</span> <span class="o">|</span> <span class="n">GM_GPCR_AU_FCT_DIS</span> <span class="o">|</span>
		    <span class="n">GM_GPCR_AU_SPD_DIS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="n">CHIP_ID_YUKON_EC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* select page 2 to access MAC control register */</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

			<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">);</span>
			<span class="cm">/* enable Power Down */</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PHY_M_PC_POW_D_ENA</span><span class="p">;</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* set page register back to 0 */</span>
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* set IEEE compatible Power Down Mode (dev. #4.99) */</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_CTRL</span><span class="p">,</span> <span class="n">PHY_CT_PDOWN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_ON</span><span class="p">);</span>
	<span class="n">reg1</span> <span class="o">=</span> <span class="n">sky2_pci_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG1</span><span class="p">);</span>
	<span class="n">reg1</span> <span class="o">|=</span> <span class="n">phy_power</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>		<span class="cm">/* set PHY to PowerDown/COMA Mode */</span>
	<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG1</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* configure IPG according to used link speed */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_set_ipg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GM_SERIAL_MODE</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GM_SMOD_IPG_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">SPEED_100</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">IPG_DATA_VAL</span><span class="p">(</span><span class="n">IPG_DATA_DEF_1000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">IPG_DATA_VAL</span><span class="p">(</span><span class="n">IPG_DATA_DEF_10_100</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GM_SERIAL_MODE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable Rx/Tx */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_enable_rx_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_GPCR_RX_ENA</span> <span class="o">|</span> <span class="n">GM_GPCR_TX_ENA</span><span class="p">;</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Force a renegotiation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_phy_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">sky2_phy_init</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">sky2_enable_rx_tx</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Put device in state to listen for Wake On Lan */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_wol_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">flow_control</span> <span class="n">save_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Bring hardware out of reset */</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_RST_CLR</span><span class="p">);</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_LINK_CTRL</span><span class="p">),</span> <span class="n">GMLC_RST_CLR</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GPHY_CTRL</span><span class="p">),</span> <span class="n">GPC_RST_CLR</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_RST_CLR</span><span class="p">);</span>

	<span class="cm">/* Force to 10/100</span>
<span class="cm">	 * sky2_reset will re-enable on resume</span>
<span class="cm">	 */</span>
	<span class="n">save_mode</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISED_1000baseT_Half</span><span class="o">|</span><span class="n">ADVERTISED_1000baseT_Full</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span> <span class="o">=</span> <span class="n">FC_NONE</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">sky2_phy_power_up</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">sky2_phy_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span> <span class="o">=</span> <span class="n">save_mode</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Set GMAC to no flow control and auto update for speed/duplex */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span>
		    <span class="n">GM_GPCR_FC_TX_DIS</span><span class="o">|</span><span class="n">GM_GPCR_TX_ENA</span><span class="o">|</span><span class="n">GM_GPCR_RX_ENA</span><span class="o">|</span>
		    <span class="n">GM_GPCR_DUP_FULL</span><span class="o">|</span><span class="n">GM_GPCR_FC_RX_DIS</span><span class="o">|</span><span class="n">GM_GPCR_AU_FCT_DIS</span><span class="p">);</span>

	<span class="cm">/* Set WOL address */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">WOL_REGS</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">WOL_MAC_ADDR</span><span class="p">),</span>
		    <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Turn on appropriate WOL control bits */</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">WOL_REGS</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">WOL_CTRL_STAT</span><span class="p">),</span> <span class="n">WOL_CTL_CLEAR_RESULT</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WOL_CTL_ENA_PME_ON_LINK_CHG</span><span class="o">|</span><span class="n">WOL_CTL_ENA_LINK_CHG_UNIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WOL_CTL_DIS_PME_ON_LINK_CHG</span><span class="o">|</span><span class="n">WOL_CTL_DIS_LINK_CHG_UNIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WOL_CTL_ENA_PME_ON_MAGIC_PKT</span><span class="o">|</span><span class="n">WOL_CTL_ENA_MAGIC_PKT_UNIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WOL_CTL_DIS_PME_ON_MAGIC_PKT</span><span class="o">|</span><span class="n">WOL_CTL_DIS_MAGIC_PKT_UNIT</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">WOL_CTL_DIS_PME_ON_PATTERN</span><span class="o">|</span><span class="n">WOL_CTL_DIS_PATTERN_UNIT</span><span class="p">;</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">WOL_REGS</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">WOL_CTRL_STAT</span><span class="p">),</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Disable PiG firmware */</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">Y2_HW_WOL_OFF</span><span class="p">);</span>

	<span class="cm">/* Needed by some broken BIOSes, use PCI rather than PCI-e for WOL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">legacy_pme</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg1</span> <span class="o">=</span> <span class="n">sky2_pci_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG1</span><span class="p">);</span>
		<span class="n">reg1</span> <span class="o">|=</span> <span class="n">PCI_Y2_PME_LEGACY</span><span class="p">;</span>
		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG1</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* block receiver */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_RST_SET</span><span class="p">);</span>
	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_set_tx_stfwd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span> <span class="o">&amp;&amp;</span>
	      <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">!=</span> <span class="n">CHIP_REV_YU_EX_A0</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">CHIP_ID_YUKON_FE_P</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Yukon-Extreme B0 and further Extreme devices */</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">TX_STFW_ENA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set Tx GMAC FIFO Almost Empty Threshold */</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_AE_THR</span><span class="p">),</span>
			     <span class="p">(</span><span class="n">ECU_JUMBO_WM</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ECU_AE_THR</span><span class="p">);</span>

		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">TX_STFW_DIS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">TX_STFW_ENA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_mac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GPHY_CTRL</span><span class="p">),</span> <span class="n">GPC_RST_SET</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GPHY_CTRL</span><span class="p">),</span> <span class="n">GPC_RST_CLR</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_RST_CLR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_XL_A0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">port</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* WA DEV_472 -- looks like crossed wires on port 2 */</span>
		<span class="cm">/* clear GMAC 1 Control reset */</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_RST_CLR</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_RST_SET</span><span class="p">);</span>
			<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_RST_CLR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PHY_MARV_ID0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PHY_MARV_ID0_VAL</span> <span class="o">||</span>
			 <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PHY_MARV_ID1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PHY_MARV_ID1_Y2</span> <span class="o">||</span>
			 <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PHY_MARV_INT_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_IRQ_SRC</span><span class="p">));</span>

	<span class="cm">/* Enable Transmit FIFO Underrun */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_IRQ_MSK</span><span class="p">),</span> <span class="n">GMAC_DEF_MSK</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">sky2_phy_power_up</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">sky2_phy_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="cm">/* MIB clear */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_PHY_ADDR</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_PHY_ADDR</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">GM_PAR_MIB_CLR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">GM_MIB_CNT_BASE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GM_MIB_CNT_END</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_PHY_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* transmit control */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TX_CTRL</span><span class="p">,</span> <span class="n">TX_COL_THR</span><span class="p">(</span><span class="n">TX_COL_DEF</span><span class="p">));</span>

	<span class="cm">/* receive control reg: unicast + multicast + no FCS  */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RX_CTRL</span><span class="p">,</span>
		    <span class="n">GM_RXCR_UCF_ENA</span> <span class="o">|</span> <span class="n">GM_RXCR_CRC_DIS</span> <span class="o">|</span> <span class="n">GM_RXCR_MCF_ENA</span><span class="p">);</span>

	<span class="cm">/* transmit flow control */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TX_FLOW_CTRL</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* transmit parameter */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TX_PARAM</span><span class="p">,</span>
		    <span class="n">TX_JAM_LEN_VAL</span><span class="p">(</span><span class="n">TX_JAM_LEN_DEF</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">TX_JAM_IPG_VAL</span><span class="p">(</span><span class="n">TX_JAM_IPG_DEF</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">TX_IPG_JAM_DATA</span><span class="p">(</span><span class="n">TX_IPG_JAM_DEF</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">TX_BACK_OFF_LIM</span><span class="p">(</span><span class="n">TX_BOF_LIM_DEF</span><span class="p">));</span>

	<span class="cm">/* serial mode register */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">DATA_BLIND_VAL</span><span class="p">(</span><span class="n">DATA_BLIND_DEF</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">GM_SMOD_VLAN_ENA</span> <span class="o">|</span> <span class="n">IPG_DATA_VAL</span><span class="p">(</span><span class="n">IPG_DATA_DEF_1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_SMOD_JUMBO_ENA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_EC_U_B1</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_NEW_FLOW_CTRL</span><span class="p">;</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SERIAL_MODE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* virtual address for data */</span>
	<span class="n">gma_set_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SRC_ADDR_2L</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* physical address: used for pause frames */</span>
	<span class="n">gma_set_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SRC_ADDR_1L</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* ignore counter overflows */</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TX_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RX_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TR_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Configure Rx MAC FIFO */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_RST_CLR</span><span class="p">);</span>
	<span class="n">rx_reg</span> <span class="o">=</span> <span class="n">GMF_OPER_ON</span> <span class="o">|</span> <span class="n">GMF_RX_F_FL_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span><span class="p">)</span>
		<span class="n">rx_reg</span> <span class="o">|=</span> <span class="n">GMF_RX_OVER_ON</span><span class="p">;</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">rx_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware errata - clear flush mask */</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_FL_MSK</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Flush Rx MAC FIFO on any flow control or error */</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_FL_MSK</span><span class="p">),</span> <span class="n">GMR_FS_ANY_ERR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set threshold to 0xa (64 bytes) + 1 to workaround pause bug  */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">RX_GMF_FL_THR_DEF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Another magic mystery workaround from sk98lin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_FE2_A0</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x178</span><span class="p">;</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_FL_THR</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Configure Tx MAC FIFO */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_RST_CLR</span><span class="p">);</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_OPER_ON</span><span class="p">);</span>

	<span class="cm">/* On chips without ram buffer, pause is controlled by MAC level */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RAM_BUFFER</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Pause threshold is scaled by 8 in bytes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_FE2_A0</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mi">1568</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_UP_THR</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_LP_THR</span><span class="p">),</span> <span class="mi">768</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">sky2_set_tx_stfwd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_FE2_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable dynamic watermark */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_EA</span><span class="p">));</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_DYN_WM_ENA</span><span class="p">;</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_EA</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Assign Ram Buffer allocation to queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_ramset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">q</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">u32</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* convert from K bytes to qwords used for hw register */</span>
	<span class="n">start</span> <span class="o">*=</span> <span class="mi">1024</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">space</span> <span class="o">*=</span> <span class="mi">1024</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">space</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_CTRL</span><span class="p">),</span> <span class="n">RB_RST_CLR</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_START</span><span class="p">),</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_END</span><span class="p">),</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_WP</span><span class="p">),</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_RP</span><span class="p">),</span> <span class="n">start</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="n">Q_R1</span> <span class="o">||</span> <span class="n">q</span> <span class="o">==</span> <span class="n">Q_R2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">space</span> <span class="o">-</span> <span class="n">space</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* On receive queue&#39;s set the thresholds</span>
<span class="cm">		 * give receiver priority when &gt; 3/4 full</span>
<span class="cm">		 * send pause when down to 2K</span>
<span class="cm">		 */</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_RX_UTHP</span><span class="p">),</span> <span class="n">tp</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_RX_LTHP</span><span class="p">),</span> <span class="n">space</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

		<span class="n">tp</span> <span class="o">=</span> <span class="n">space</span> <span class="o">-</span> <span class="mi">2048</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_RX_UTPP</span><span class="p">),</span> <span class="n">tp</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_RX_LTPP</span><span class="p">),</span> <span class="n">space</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Enable store &amp; forward on Tx queue&#39;s because</span>
<span class="cm">		 * Tx FIFO is only 1K on Yukon</span>
<span class="cm">		 */</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_CTRL</span><span class="p">),</span> <span class="n">RB_ENA_STFWD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_CTRL</span><span class="p">),</span> <span class="n">RB_ENA_OP_MD</span><span class="p">);</span>
	<span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">RB_CTRL</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Setup Bus Memory Interface */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_qset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_CLR_RESET</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_OPER_INIT</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_FIFO_OP_ON</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Q_WM</span><span class="p">),</span>  <span class="n">BMU_WM_DEFAULT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Setup prefetch unit registers. This is the interface between</span>
<span class="cm"> * hardware and driver list elements</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_prefetch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">qaddr</span><span class="p">,</span>
			       <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">qaddr</span><span class="p">,</span> <span class="n">PREF_UNIT_CTRL</span><span class="p">),</span> <span class="n">PREF_UNIT_RST_SET</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">qaddr</span><span class="p">,</span> <span class="n">PREF_UNIT_CTRL</span><span class="p">),</span> <span class="n">PREF_UNIT_RST_CLR</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">qaddr</span><span class="p">,</span> <span class="n">PREF_UNIT_ADDR_HI</span><span class="p">),</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">qaddr</span><span class="p">,</span> <span class="n">PREF_UNIT_ADDR_LO</span><span class="p">),</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">qaddr</span><span class="p">,</span> <span class="n">PREF_UNIT_LAST_IDX</span><span class="p">),</span> <span class="n">last</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">qaddr</span><span class="p">,</span> <span class="n">PREF_UNIT_CTRL</span><span class="p">),</span> <span class="n">PREF_UNIT_OP_ON</span><span class="p">);</span>

	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">qaddr</span><span class="p">,</span> <span class="n">PREF_UNIT_CTRL</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sky2_tx_le</span> <span class="o">*</span><span class="nf">get_tx_le</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_tx_le</span> <span class="o">*</span><span class="n">le</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span> <span class="o">+</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>

	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">le</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_tx_le</span> <span class="o">*</span><span class="n">le</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_tcpsum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_mss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_reset_queue</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_ADDR64</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Update chip&#39;s next pointer */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sky2_put_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">q</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make sure write&#39; to descriptors are complete before we tell hardware */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">PREF_UNIT_PUT_IDX</span><span class="p">),</span> <span class="n">idx</span><span class="p">);</span>

	<span class="cm">/* Synchronize I/O on since next processor may write to tail */</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sky2_rx_le</span> <span class="o">*</span><span class="nf">sky2_next_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_rx_le</span> <span class="o">*</span><span class="n">le</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span> <span class="o">+</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_put</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_put</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_put</span><span class="p">,</span> <span class="n">RX_LE_SIZE</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">le</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">sky2_get_rx_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Space needed for frame data + headers rounded up */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Stopping point for hardware truncation */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">sky2_get_rx_data_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Space needed for frame data + headers rounded up */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_nfrags</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_nfrags</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">frag_addr</span><span class="p">));</span>

	<span class="cm">/* Compute residue after pages */</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_nfrags</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Optimize to handle small packets and headers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">copybreak</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">copybreak</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Build description to hardware for one receive segment */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span>
			<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_rx_le</span> <span class="o">*</span><span class="n">le</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">le</span> <span class="o">=</span> <span class="n">sky2_next_rx</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_ADDR64</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">le</span> <span class="o">=</span> <span class="n">sky2_next_rx</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">op</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Build description to hardware for one possibly fragmented skb */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sky2_rx_add</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">OP_PACKET</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_data_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sky2_rx_add</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">OP_BUFFER</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">frag_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_rx_map_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mapping_error</span><span class="p">;</span>

	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">re</span><span class="o">-&gt;</span><span class="n">frag_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
						    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">frag_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">goto</span> <span class="n">map_page_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">map_page_error:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">frag_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">,</span> <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">data_size</span><span class="p">),</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

<span class="nl">mapping_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: rx mapping error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_unmap_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">,</span> <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">data_size</span><span class="p">),</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">frag_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Tell chip where to start receive checksum.</span>
<span class="cm"> * Actually has two checksums, but set both same to avoid possible byte</span>
<span class="cm"> * order problems.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_set_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_rx_le</span> <span class="o">*</span><span class="n">le</span> <span class="o">=</span> <span class="n">sky2_next_rx</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">ETH_HLEN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_TCPSTART</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
		     <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span>
		     <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
		     <span class="o">?</span> <span class="n">BMU_ENA_RX_CHKSUM</span> <span class="o">:</span> <span class="n">BMU_DIS_RX_CHKSUM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fixed initial key as seed to RSS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">rss_init_key</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x7c3351da</span><span class="p">,</span> <span class="mh">0x51c5cf4e</span><span class="p">,</span>	<span class="mh">0x44adbdd1</span><span class="p">,</span> <span class="mh">0xe8d38d18</span><span class="p">,</span>	<span class="mh">0x48897c43</span><span class="p">,</span>
	<span class="mh">0xb1d60e7e</span><span class="p">,</span> <span class="mh">0x6a3dd760</span><span class="p">,</span> <span class="mh">0x01a2e453</span><span class="p">,</span> <span class="mh">0x16f46f13</span><span class="p">,</span> <span class="mh">0x1a0e7b30</span>
<span class="p">};</span>

<span class="cm">/* Enable/disable receive hash calculation (RSS) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_set_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nkeys</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Supports IPv6 and other modes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEW_LE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nkeys</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RSS_CFG</span><span class="p">),</span> <span class="n">HASH_ALL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Program RSS initial values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nkeys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RSS_KEY</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
				     <span class="n">rss_init_key</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Need to turn on (undocumented) flag to make hashing work  */</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span>
			     <span class="n">RX_STFW_ENA</span><span class="p">);</span>

		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span>
			     <span class="n">BMU_ENA_RX_RSS_HASH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span>
			     <span class="n">BMU_DIS_RX_RSS_HASH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The RX Stop command will not work for Yukon-2 if the BMU does not</span>
<span class="cm"> * reach the end of packet and since we can&#39;t make sure that we have</span>
<span class="cm"> * incoming data, we must reset the BMU while it is not doing a DMA</span>
<span class="cm"> * transfer. Since it is possible that the RX path is still active,</span>
<span class="cm"> * the RX RAM buffer will be stopped first, so any possible incoming</span>
<span class="cm"> * data will not trigger a DMA. After the RAM buffer is stopped, the</span>
<span class="cm"> * BMU is polled until any DMA in progress is ended and only then it</span>
<span class="cm"> * will be reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rxq</span> <span class="o">=</span> <span class="n">rxqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* disable the RAM Buffer receive queue */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">RB_CTRL</span><span class="p">),</span> <span class="n">RB_DIS_OP_MD</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_RSL</span><span class="p">))</span>
		    <span class="o">==</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_RL</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">stopped</span><span class="p">;</span>

	<span class="n">netdev_warn</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;receiver stop failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">stopped:</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_RST_SET</span> <span class="o">|</span> <span class="n">BMU_FIFO_RST</span><span class="p">);</span>

	<span class="cm">/* reset the Rx prefetch unit */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">PREF_UNIT_CTRL</span><span class="p">),</span> <span class="n">PREF_UNIT_RST_SET</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Clean out receive buffer area, assumes receiver hardware stopped */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RX_LE_BYTES</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sky2_rx_unmap_skb</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Basic MII support */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	<span class="cm">/* Phy still in reset */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">PHY_ADDR_MARV</span><span class="p">;</span>

		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>: <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span>
				   <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SKY2_VLAN_OFFLOADS (NETIF_F_IP_CSUM | NETIF_F_SG | NETIF_F_TSO)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_vlan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span>
			     <span class="n">RX_VLAN_STRIP_ON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span>
			     <span class="n">RX_VLAN_STRIP_OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span>
			     <span class="n">TX_VLAN_TAG_ON</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">SKY2_VLAN_OFFLOADS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span>
			     <span class="n">TX_VLAN_TAG_OFF</span><span class="p">);</span>

		<span class="cm">/* Can&#39;t do transmit offload of vlan without hw vlan */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKY2_VLAN_OFFLOADS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Amount of required worst case padding in rx buffer */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">sky2_rx_pad</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RAM_BUFFER</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate an skb for receiving. If the MTU is large enough</span>
<span class="cm"> * make the skb non-linear with a fragment list of pages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">sky2_rx_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">__netdev_alloc_skb</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_data_size</span> <span class="o">+</span> <span class="n">sky2_rx_pad</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">),</span>
				 <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RAM_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Workaround for a bug in FIFO that cause hang</span>
<span class="cm">		 * if the FIFO if the receive buffer is not 64 byte aligned.</span>
<span class="cm">		 * The buffer returned from netdev_alloc_skb is</span>
<span class="cm">		 * aligned except if slab debugging is enabled.</span>
<span class="cm">		 */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">start</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_nfrags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">gfp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_partial</span><span class="p">;</span>
		<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="nl">free_partial:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">nomem:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sky2_rx_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sky2_put_idx</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">rxq</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_put</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_alloc_rx_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_data_size</span> <span class="o">=</span> <span class="n">sky2_get_rx_data_size</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="cm">/* Fill Rx ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">sky2_rx_alloc</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sky2_rx_map_skb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_data_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup receiver buffer pool.</span>
<span class="cm"> * Normal case this ends up creating one list element for skb</span>
<span class="cm"> * in the receive ring. Worst case if using large MTU and each</span>
<span class="cm"> * allocation falls on a different 64 bit region, that results</span>
<span class="cm"> * in 6 list elements per ring entry.</span>
<span class="cm"> * One element is used for checksum enable/disable, and one</span>
<span class="cm"> * extra to avoid wrap.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rxq</span> <span class="o">=</span> <span class="n">rxqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">thresh</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_put</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sky2_qset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>

	<span class="cm">/* On PCI express lowering the watermark gives better performance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_WM</span><span class="p">),</span> <span class="n">BMU_WM_PEX</span><span class="p">);</span>

	<span class="cm">/* These chips have no ram buffer?</span>
<span class="cm">	 * MAC Rx RAM Read is controlled by hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;</span> <span class="n">CHIP_REV_YU_EC_U_A0</span><span class="p">)</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_TEST</span><span class="p">),</span> <span class="n">F_M_RX_RAM_DIS</span><span class="p">);</span>

	<span class="n">sky2_prefetch_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rxq</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le_map</span><span class="p">,</span> <span class="n">RX_LE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEW_LE</span><span class="p">))</span>
		<span class="n">rx_set_checksum</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RSS_BROKEN</span><span class="p">))</span>
		<span class="n">rx_set_rss</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="cm">/* submit Rx ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sky2_rx_submit</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">re</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The receiver hangs if it receives frames larger than the</span>
<span class="cm">	 * packet buffer. As a workaround, truncate oversize frames, but</span>
<span class="cm">	 * the register is limited to 9 bits, so if you do frames &gt; 2052</span>
<span class="cm">	 * you better get the MTU right!</span>
<span class="cm">	 */</span>
	<span class="n">thresh</span> <span class="o">=</span> <span class="n">sky2_get_rx_threshold</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thresh</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">RX_TRUNC_OFF</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_TR_THR</span><span class="p">),</span> <span class="n">thresh</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">RX_TRUNC_ON</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Tell chip about available buffers */</span>
	<span class="n">sky2_rx_update</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_SUPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable flushing of non ASF packets;</span>
<span class="cm">		 * must be done after initializing the BMUs;</span>
<span class="cm">		 * drivers without ASF support should do this too, otherwise</span>
<span class="cm">		 * it may happen that they cannot run on ASF devices;</span>
<span class="cm">		 * remember that the MAC FIFO isn&#39;t reset during initialization.</span>
<span class="cm">		 */</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">RX_MACSEC_FLUSH_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">CHIP_ID_YUKON_SUPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable RX Home Address &amp; Routing Header checksum fix */</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_FL_CTRL</span><span class="p">),</span>
			     <span class="n">RX_IPV6_SA_MOB_ENA</span> <span class="o">|</span> <span class="n">RX_IPV6_DA_MOB_ENA</span><span class="p">);</span>

		<span class="cm">/* Enable TX Home Address &amp; Routing Header checksum fix */</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_TEST</span><span class="p">),</span>
			     <span class="n">TBMU_TEST_HOME_ADD_FIX_EN</span> <span class="o">|</span> <span class="n">TBMU_TEST_ROUTING_ADD_FIX_EN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_alloc_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* must be power of 2 */</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">*</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_tx_le</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_ring_info</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_LE_BYTES</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RX_LE_BYTES</span><span class="p">);</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring_info</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sky2_alloc_rx_skbs</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
<span class="nl">nomem:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">sky2_rx_clean</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_LE_BYTES</span><span class="p">,</span>
				    <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le_map</span><span class="p">);</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_le</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_tx_le</span><span class="p">),</span>
				    <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le_map</span><span class="p">);</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_hw_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ramsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">otherdev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">tx_init</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm"> 	 * On dual port PCI-X card, there is an problem where status</span>
<span class="cm">	 * can be received out of order due to split transactions</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otherdev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">otherdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
 	    <span class="p">(</span><span class="n">cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">)))</span> <span class="p">{</span>
 		<span class="n">u16</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">);</span>
 		<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_X_CMD_MAX_SPLIT</span><span class="p">;</span>
 		<span class="n">sky2_pci_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_mac_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Register is number of 4K blocks on internal RAM buffer. */</span>
	<span class="n">ramsize</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_E_0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ramsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rxspace</span><span class="p">;</span>

		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;ram buffer %dK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ramsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ramsize</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">rxspace</span> <span class="o">=</span> <span class="n">ramsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rxspace</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ramsize</span> <span class="o">-</span> <span class="mi">16</span><span class="p">))</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>

		<span class="n">sky2_ramset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rxspace</span><span class="p">);</span>
		<span class="n">sky2_ramset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">rxspace</span><span class="p">,</span> <span class="n">ramsize</span> <span class="o">-</span> <span class="n">rxspace</span><span class="p">);</span>

		<span class="cm">/* Make sure SyncQ is disabled */</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">Q_XS1</span> <span class="o">:</span> <span class="n">Q_XS2</span><span class="p">,</span> <span class="n">RB_CTRL</span><span class="p">),</span>
			    <span class="n">RB_RST_SET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_qset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>

	<span class="cm">/* This is copied from sk98lin 10.0.5.3; no one tells me about erratta&#39;s */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_EX_B0</span><span class="p">)</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_TEST</span><span class="p">),</span> <span class="n">F_TX_CHK_AUTO_OFF</span><span class="p">);</span>

	<span class="cm">/* Set almost empty threshold */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_EC_U_A0</span><span class="p">)</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_AL</span><span class="p">),</span> <span class="n">ECU_TXFF_LEV</span><span class="p">);</span>

	<span class="n">sky2_prefetch_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le_map</span><span class="p">,</span>
			   <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sky2_vlan_mode</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>
	<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">sky2_rx_start</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Setup device IRQ and enable napi to process */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_setup_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sky2_intr</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_USE_MSI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">name</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot assign irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_IRQ_SETUP</span><span class="p">;</span>

		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="n">Y2_IS_BASE</span><span class="p">);</span>
		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Bring up network interface. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">imask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sky2_alloc_buffers</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="cm">/* With single port, IRQ is setup when device is brought up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">sky2_setup_irq</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">sky2_hw_up</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts from phy/mac for port */</span>
	<span class="n">imask</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_OPT</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_PRM</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_OP_2</span><span class="p">)</span>
		<span class="n">imask</span> <span class="o">|=</span> <span class="n">Y2_IS_PHY_QLNK</span><span class="p">;</span>	<span class="cm">/* enable PHY Quick Link */</span>

	<span class="n">imask</span> <span class="o">|=</span> <span class="n">portirq_msk</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="n">imask</span><span class="p">);</span>
	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabling interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">sky2_free_buffers</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Modular subtraction in ring */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tx_inuse</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">-</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Number of list elements available for next tx */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tx_avail</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">-</span> <span class="n">tx_inuse</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Estimate of number of transmit list elements required */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">tx_le_req</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>	<span class="cm">/* possible vlan */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_tx_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TX_MAP_SINGLE</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
				 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TX_MAP_PAGE</span><span class="p">)</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
			       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
			       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">re</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Put one packet in ring for transmit.</span>
<span class="cm"> * A single packet can generate multiple list elements, and</span>
<span class="cm"> * the number of ring elements will probably be less than the number</span>
<span class="cm"> * of list elements used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">sky2_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sky2_tx_le</span> <span class="o">*</span><span class="n">le</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">upper</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mss</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_avail</span><span class="p">(</span><span class="n">sky2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tx_le_req</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span>
  		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mapping_error</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">;</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;tx queued, slot %u, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Send high bits if needed */</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">upper</span> <span class="o">!=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_upper</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper</span><span class="p">);</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_upper</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_ADDR64</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for TCP Segmentation Offload */</span>
	<span class="n">mss</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mss</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEW_LE</span><span class="p">))</span>
			<span class="n">mss</span> <span class="o">+=</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

  		<span class="k">if</span> <span class="p">(</span><span class="n">mss</span> <span class="o">!=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_mss</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">);</span>
  			<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mss</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEW_LE</span><span class="p">)</span>
				<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_MSS</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_LRGLEN</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_mss</span> <span class="o">=</span> <span class="n">mss</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Add VLAN tag, can piggyback on LRGLEN or ADDR64 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">le</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">);</span>
			<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_VLAN</span><span class="o">|</span><span class="n">HW_OWNER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">|=</span> <span class="n">OP_VLAN</span><span class="p">;</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">INS_VLAN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle TCP checksum offload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* On Yukon EX (some versions) encoding change. */</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_AUTO_TX_SUM</span><span class="p">)</span>
 			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">CALSUM</span><span class="p">;</span>	<span class="cm">/* auto checksum */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">tcpsum</span><span class="p">;</span>

			<span class="n">tcpsum</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>			<span class="cm">/* sum start */</span>
			<span class="n">tcpsum</span> <span class="o">|=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span><span class="p">;</span>	<span class="cm">/* sum write */</span>

			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">CALSUM</span> <span class="o">|</span> <span class="n">WR_SUM</span> <span class="o">|</span> <span class="n">INIT_SUM</span> <span class="o">|</span> <span class="n">LOCK_SUM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
				<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">UDPTCP</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tcpsum</span> <span class="o">!=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_tcpsum</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_tcpsum</span> <span class="o">=</span> <span class="n">tcpsum</span><span class="p">;</span>

				<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">);</span>
				<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tcpsum</span><span class="p">);</span>
				<span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* initial checksum value */</span>
				<span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* one packet */</span>
				<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_TCPLISW</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">re</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TX_MAP_SINGLE</span><span class="p">;</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">mapping</span><span class="p">));</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">mss</span> <span class="o">?</span> <span class="p">(</span><span class="n">OP_LARGESEND</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">OP_PACKET</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">);</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">mapping</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">mapping_unwind</span><span class="p">;</span>

		<span class="n">upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">upper</span> <span class="o">!=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_upper</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">);</span>
			<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper</span><span class="p">);</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_last_upper</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
			<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_ADDR64</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">slot</span><span class="p">;</span>
		<span class="n">re</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TX_MAP_PAGE</span><span class="p">;</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
		<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>

		<span class="n">le</span> <span class="o">=</span> <span class="n">get_tx_le</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">mapping</span><span class="p">));</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_BUFFER</span> <span class="o">|</span> <span class="n">HW_OWNER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">EOP</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_avail</span><span class="p">(</span><span class="n">sky2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_SKB_TX_LE</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_sent_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">sky2_put_idx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">txqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">mapping_unwind:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">sky2_tx_unmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">mapping_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: tx mapping error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free ring elements from starting at tx_cons until &quot;done&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * NB:</span>
<span class="cm"> *  1. The hardware will tell us about partial completion of multi-part</span>
<span class="cm"> *     buffers so make sure not to free skb to early.</span>
<span class="cm"> *  2. This may run in parallel start_xmit because the it only</span>
<span class="cm"> *     looks at the tail of the queue of FIFO (tx_cons), not</span>
<span class="cm"> *     the head (tx_prod)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u16</span> <span class="n">done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_compl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pkts_compl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">done</span> <span class="o">&gt;=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">;</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">done</span><span class="p">;</span>
	     <span class="n">idx</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ring_info</span> <span class="o">*</span><span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">sky2_tx_unmap</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;tx done %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

			<span class="n">pkts_compl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bytes_compl</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

			<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_next</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="n">netdev_completed_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkts_compl</span><span class="p">,</span> <span class="n">bytes_compl</span><span class="p">);</span>

	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">packets</span> <span class="o">+=</span> <span class="n">pkts_compl</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">bytes_compl</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_tx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable Force Sync bit and Enable Alloc bit */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TXA_CTRL</span><span class="p">),</span>
		    <span class="n">TXA_DIS_FSYNC</span> <span class="o">|</span> <span class="n">TXA_DIS_ALLOC</span> <span class="o">|</span> <span class="n">TXA_STOP_RC</span><span class="p">);</span>

	<span class="cm">/* Stop Interval Timer and Limit Counter of Tx Arbiter */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TXA_ITI_INI</span><span class="p">),</span> <span class="mi">0L</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TXA_LIM_INI</span><span class="p">),</span> <span class="mi">0L</span><span class="p">);</span>

	<span class="cm">/* Reset the PCI FIFO of the async Tx queue */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span>
		     <span class="n">BMU_RST_SET</span> <span class="o">|</span> <span class="n">BMU_FIFO_RST</span><span class="p">);</span>

	<span class="cm">/* Reset the Tx prefetch units */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">PREF_UNIT_CTRL</span><span class="p">),</span>
		     <span class="n">PREF_UNIT_RST_SET</span><span class="p">);</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">RB_CTRL</span><span class="p">),</span> <span class="n">RB_RST_SET</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_RST_SET</span><span class="p">);</span>

	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_hw_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Force flow control off */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_PAUSE_OFF</span><span class="p">);</span>

	<span class="cm">/* Stop transmitter */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_STOP</span><span class="p">);</span>
	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">));</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">RB_CTRL</span><span class="p">),</span>
		     <span class="n">RB_RST_SET</span> <span class="o">|</span> <span class="n">RB_DIS_OP_MD</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GM_GPCR_TX_ENA</span> <span class="o">|</span> <span class="n">GM_GPCR_RX_ENA</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GPHY_CTRL</span><span class="p">),</span> <span class="n">GPC_RST_SET</span><span class="p">);</span>

	<span class="cm">/* Workaround shared GMAC reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	      <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_RST_SET</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_RST_SET</span><span class="p">);</span>

	<span class="cm">/* Force any delayed status interrupt and NAPI */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_CTRL</span><span class="p">);</span>

	<span class="n">sky2_rx_stop</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">sky2_phy_power_down</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="n">sky2_tx_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Free any pending frames stuck in HW queue */</span>
	<span class="n">sky2_tx_complete</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Network shutdown */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Never really got started! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>

		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKY2_HW_IRQ_SETUP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">imask</span><span class="p">;</span>

		<span class="cm">/* Disable port IRQ */</span>
		<span class="n">imask</span>  <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>
		<span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">portirq_msk</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">];</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="n">imask</span><span class="p">);</span>
		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>

		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">napi_synchronize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_hw_down</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="n">sky2_free_buffers</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">sky2_phy_speed</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_FIBRE_PHY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SPEED_1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_GIGABIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aux</span> <span class="o">&amp;</span> <span class="n">PHY_M_PS_SPEED_100</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">SPEED_10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aux</span> <span class="o">&amp;</span> <span class="n">PHY_M_PS_SPEED_MSK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_M_PS_SPEED_1000</span>:
		<span class="k">return</span> <span class="n">SPEED_1000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_M_PS_SPEED_100</span>:
		<span class="k">return</span> <span class="n">SPEED_100</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">SPEED_10</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_link_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fc_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">FC_NONE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">FC_TX</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;tx&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">FC_RX</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;rx&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">FC_BOTH</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;both&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">sky2_set_ipg</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="n">sky2_enable_rx_tx</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_INT_MASK</span><span class="p">,</span> <span class="n">PHY_M_DEF_MSK</span><span class="p">);</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Turn on link LED */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LNK_LED_REG</span><span class="p">),</span>
		    <span class="n">LINKLED_ON</span> <span class="o">|</span> <span class="n">LINKLED_BLINK_OFF</span> <span class="o">|</span> <span class="n">LINKLED_LINKSYNC_OFF</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		   <span class="s">&quot;Link is up at %d Mbps, %s duplex, flow control %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span>
		   <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">,</span>
		   <span class="n">fc_name</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GM_GPCR_RX_ENA</span> <span class="o">|</span> <span class="n">GM_GPCR_TX_ENA</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Turn off link LED */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LNK_LED_REG</span><span class="p">),</span> <span class="n">LINKLED_OFF</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sky2_phy_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">flow_control</span> <span class="nf">sky2_flow</span><span class="p">(</span><span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tx</span> <span class="o">?</span> <span class="n">FC_BOTH</span> <span class="o">:</span> <span class="n">FC_RX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">tx</span> <span class="o">?</span> <span class="n">FC_TX</span> <span class="o">:</span> <span class="n">FC_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_autoneg_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">advert</span><span class="p">,</span> <span class="n">lpa</span><span class="p">;</span>

	<span class="n">advert</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_AUNE_ADV</span><span class="p">);</span>
	<span class="n">lpa</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_AUNE_LP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lpa</span> <span class="o">&amp;</span> <span class="n">PHY_M_AN_RF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;remote fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aux</span> <span class="o">&amp;</span> <span class="n">PHY_M_PS_SPDUP_RES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;speed/duplex mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">sky2_phy_speed</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">aux</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">aux</span> <span class="o">&amp;</span> <span class="n">PHY_M_PS_FULL_DUP</span><span class="p">)</span> <span class="o">?</span> <span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

	<span class="cm">/* Since the pause result bits seem to in different positions on</span>
<span class="cm">	 * different chips. look at registers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_FIBRE_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Shift for bits in fiber PHY */</span>
		<span class="n">advert</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_PAUSE_CAP</span><span class="o">|</span><span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>
		<span class="n">lpa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LPA_PAUSE_CAP</span><span class="o">|</span><span class="n">LPA_PAUSE_ASYM</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">)</span>
			<span class="n">advert</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_CAP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">)</span>
			<span class="n">advert</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpa</span> <span class="o">&amp;</span> <span class="n">LPA_1000XPAUSE</span><span class="p">)</span>
			<span class="n">lpa</span> <span class="o">|=</span> <span class="n">LPA_PAUSE_CAP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpa</span> <span class="o">&amp;</span> <span class="n">LPA_1000XPAUSE_ASYM</span><span class="p">)</span>
			<span class="n">lpa</span> <span class="o">|=</span> <span class="n">LPA_PAUSE_ASYM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">=</span> <span class="n">FC_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_PAUSE_CAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpa</span> <span class="o">&amp;</span> <span class="n">LPA_PAUSE_CAP</span><span class="p">)</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">=</span> <span class="n">FC_BOTH</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">)</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">=</span> <span class="n">FC_RX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lpa</span> <span class="o">&amp;</span> <span class="n">LPA_PAUSE_CAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lpa</span> <span class="o">&amp;</span> <span class="n">LPA_PAUSE_ASYM</span><span class="p">))</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">=</span> <span class="n">FC_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span><span class="p">))</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">=</span> <span class="n">FC_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">&amp;</span> <span class="n">FC_TX</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_PAUSE_ON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span> <span class="n">GMC_PAUSE_OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt from PHY */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_phy_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">istatus</span><span class="p">,</span> <span class="n">phystat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">istatus</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_INT_STAT</span><span class="p">);</span>
	<span class="n">phystat</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_STAT</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;phy interrupt status 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">istatus</span><span class="p">,</span> <span class="n">phystat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="n">PHY_M_IS_AN_COMPL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2_autoneg_done</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">phystat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">sky2_link_up</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="n">PHY_M_IS_LSP_CHANGE</span><span class="p">)</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">sky2_phy_speed</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">phystat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="n">PHY_M_IS_DUP_CHANGE</span><span class="p">)</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">phystat</span> <span class="o">&amp;</span> <span class="n">PHY_M_PS_FULL_DUP</span><span class="p">)</span> <span class="o">?</span> <span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="n">PHY_M_IS_LST_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phystat</span> <span class="o">&amp;</span> <span class="n">PHY_M_PS_LINK_UP</span><span class="p">)</span>
			<span class="n">sky2_link_up</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sky2_link_down</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Special quick link interrupt (Yukon-2 Optima only) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_qlink_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">u32</span> <span class="n">imask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy</span><span class="p">;</span>

	<span class="cm">/* disable irq */</span>
	<span class="n">imask</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>
	<span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Y2_IS_PHY_QLNK</span><span class="p">;</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="n">imask</span><span class="p">);</span>

	<span class="cm">/* reset PHY Link Detect */</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PSM_CONFIG_REG4</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_ON</span><span class="p">);</span>
	<span class="n">sky2_pci_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PSM_CONFIG_REG4</span><span class="p">,</span> <span class="n">phy</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_OFF</span><span class="p">);</span>

	<span class="n">sky2_link_up</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Transmit timeout is only called if we are running, carrier is up</span>
<span class="cm"> * and tx queue is full (stopped).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">netif_err</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit ring %u .. %u report=%u done=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">,</span>
		      <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">STAT_TXA1_RIDX</span> <span class="o">:</span> <span class="n">STAT_TXA2_RIDX</span><span class="p">),</span>
		      <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_DONE</span><span class="p">)));</span>

	<span class="cm">/* can&#39;t restart safely under softirq */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">imask</span><span class="p">;</span>

	<span class="cm">/* MTU size outside the spec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_JUMBO_MTU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* MTU &gt; 1500 on yukon FE and FE+ not allowed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE</span> <span class="o">||</span>
	     <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">imask</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>	<span class="cm">/* prevent tx timeout */</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RAM_BUFFER</span><span class="p">))</span>
		<span class="n">sky2_set_tx_stfwd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">);</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span> <span class="n">ctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GM_GPCR_RX_ENA</span><span class="p">);</span>
	<span class="n">sky2_rx_stop</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="n">sky2_rx_clean</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">DATA_BLIND_VAL</span><span class="p">(</span><span class="n">DATA_BLIND_DEF</span><span class="p">)</span> <span class="o">|</span>	<span class="n">GM_SMOD_VLAN_ENA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">SPEED_100</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">IPG_DATA_VAL</span><span class="p">(</span><span class="n">IPG_DATA_DEF_1000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">IPG_DATA_VAL</span><span class="p">(</span><span class="n">IPG_DATA_DEF_10_100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">GM_SMOD_JUMBO_ENA</span><span class="p">;</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SERIAL_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RB_ADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">RB_CTRL</span><span class="p">),</span> <span class="n">RB_ENA_OP_MD</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sky2_alloc_rx_skbs</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">sky2_rx_start</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sky2_rx_clean</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="n">imask</span><span class="p">);</span>

	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_LISR</span><span class="p">);</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dev_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_GP_CTRL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>

		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">needs_copy</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS</span>
	<span class="cm">/* Some architectures need the IP header to be aligned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">copybreak</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* For small just reuse existing skb for next receive */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">receive_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">,</span>
					    <span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">vlan_tci</span><span class="p">;</span>

		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">,</span>
					       <span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Adjust length of skb with fragments to match received data */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">skb_put_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdr_space</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_frags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* put header into skb */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">hdr_space</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">num_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* don&#39;t need this page */</span>
			<span class="n">__skb_frag_unref</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="o">--</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

			<span class="n">skb_frag_size_set</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Normal packet - take skb from ring element and put in a new one  */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">receive_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="n">nre</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">hdr_space</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_data_size</span><span class="p">;</span>

	<span class="n">nre</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">sky2_rx_alloc</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nre</span><span class="p">.</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nobuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_rx_map_skb</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nre</span><span class="p">,</span> <span class="n">hdr_space</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nomap</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">sky2_rx_unmap_skb</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">re</span><span class="p">);</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="o">*</span><span class="n">re</span> <span class="o">=</span> <span class="n">nre</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span>
		<span class="n">skb_put_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_space</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">nomap:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nre</span><span class="p">.</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">nobuf:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive one packet.</span>
<span class="cm"> * For larger packets, get new buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">sky2_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rx_ring_info</span> <span class="o">*</span><span class="n">re</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GMR_FS_LEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;rx slot %u status 0x%x len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">re</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>	<span class="cm">/* Account for vlan tag */</span>

	<span class="cm">/* This chip has hardware problems that generates bogus status.</span>
<span class="cm">	 * So do only marginal checking and expect higher level protocols</span>
<span class="cm">	 * to handle crap frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_FE_P</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_FE2_A0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">length</span> <span class="o">!=</span> <span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">okay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GMR_FS_ANY_ERR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GMR_FS_RX_OK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>

	<span class="cm">/* if length reported by DMA does not match PHY, packet was truncated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">okay:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_copy</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">receive_copy</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">receive_new</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="nl">resubmit:</span>
	<span class="n">sky2_rx_submit</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">re</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;rx error, status 0x%x length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Transmit complete */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sky2_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sky2_tx_complete</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

		<span class="cm">/* Wake unless it&#39;s detached, and called e.g. from sky2_close() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_avail</span><span class="p">(</span><span class="n">sky2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_SKB_TX_LE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sky2_skb_rx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_NONE</span><span class="p">)</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sky2_rx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="n">packets</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">packets</span> <span class="o">+=</span> <span class="n">packets</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">sky2_rx_update</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If this happens then driver assuming wrong format for chip type */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEW_LE</span><span class="p">);</span>

	<span class="cm">/* Both checksum counters are programmed to start at</span>
<span class="cm">	 * the same offset, so unless there is a problem they</span>
<span class="cm">	 * should match. This failure is an early indication that</span>
<span class="cm">	 * hardware receive checksumming won&#39;t work.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;%s: receive checksum problem (status = %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* Disable checksum offload</span>
<span class="cm">		 * It will be reenabled on next ndo_set_features, but if it&#39;s</span>
<span class="cm">		 * really broken, will get disabled again</span>
<span class="cm">		 */</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span>
			     <span class="n">BMU_DIS_RX_CHKSUM</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u16</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">length</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_rx_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_next</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process status response ring */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_status_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to_do</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_packets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">rmb</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sky2_status_le</span> <span class="o">*</span><span class="n">le</span>  <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">port</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">HW_OWNER</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">);</span>

		<span class="n">port</span> <span class="o">=</span> <span class="n">le</span><span class="o">-&gt;</span><span class="n">css</span> <span class="o">&amp;</span> <span class="n">CSS_LINK_BIT</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HW_OWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_RXSTAT</span>:
			<span class="n">total_packets</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">total_bytes</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">sky2_receive</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* This chip reports checksum status differently */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEW_LE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">css</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSS_ISIPV4</span> <span class="o">|</span> <span class="n">CSS_ISIPV6</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">css</span> <span class="o">&amp;</span> <span class="n">CSS_TCPUDPCSOK</span><span class="p">))</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">sky2_skb_rx</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

			<span class="cm">/* Stop after net poll weight */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">to_do</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_loop</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_RXVLAN</span>:
			<span class="n">sky2_rx_tag</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_RXCHKSVLAN</span>:
			<span class="n">sky2_rx_tag</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">OP_RXCHKS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span>
				<span class="n">sky2_rx_checksum</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_RSS_HASH</span>:
			<span class="n">sky2_rx_hash</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_TXINDEXLE</span>:
			<span class="cm">/* TX index reports status for both ports */</span>
			<span class="n">sky2_tx_done</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">sky2_tx_done</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				     <span class="p">((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
					     <span class="o">|</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unknown status opcode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">);</span>

	<span class="cm">/* Fully processed status ring so clear irq */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_CTRL</span><span class="p">,</span> <span class="n">SC_STAT_CLR_IRQ</span><span class="p">);</span>

<span class="nl">exit_loop:</span>
	<span class="n">sky2_rx_done</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_packets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">total_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">sky2_rx_done</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">total_packets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">total_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_hw_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hw error interrupt status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_PAR_RD1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ram data read parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Clear IRQ */</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">B3_RI_CTRL</span><span class="p">),</span> <span class="n">RI_CLR_RD_PERR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_PAR_WR1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ram data write parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">B3_RI_CTRL</span><span class="p">),</span> <span class="n">RI_CLR_WR_PERR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_PAR_MAC1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_CLI_TX_PE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_PAR_RX1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_CLR_IRQ_PAR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_TCP_TXA1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TCP segmentation error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_CLR_IRQ_TCP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_hw_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_HWE_ISRC</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">hwmsk</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_HWE_IMSK</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">hwmsk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_TIST_OV</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GMAC_TI_ST_CTRL</span><span class="p">,</span> <span class="n">GMT_ST_CLR_IRQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y2_IS_MST_ERR</span> <span class="o">|</span> <span class="n">Y2_IS_IRQ_STAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pci_err</span><span class="p">;</span>

		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_ON</span><span class="p">);</span>
		<span class="n">pci_err</span> <span class="o">=</span> <span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI hardware error (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			        <span class="n">pci_err</span><span class="p">);</span>

		<span class="n">sky2_pci_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span>
				      <span class="n">pci_err</span> <span class="o">|</span> <span class="n">PCI_STATUS_ERROR_BITS</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_PCI_EXP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PCI-Express uncorrectable Error occurred */</span>
		<span class="n">u32</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_ON</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_CFG_AER</span> <span class="o">+</span> <span class="n">PCI_ERR_UNCOR_STATUS</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_CFG_AER</span> <span class="o">+</span> <span class="n">PCI_ERR_UNCOR_STATUS</span><span class="p">,</span>
			     <span class="mh">0xfffffffful</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI Express error (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_CFG_AER</span> <span class="o">+</span> <span class="n">PCI_ERR_UNCOR_STATUS</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_HWE_L1_MASK</span><span class="p">)</span>
		<span class="n">sky2_hw_error</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_HWE_L1_MASK</span><span class="p">)</span>
		<span class="n">sky2_hw_error</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_mac_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GMAC_IRQ_SRC</span><span class="p">));</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mac interrupt status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GM_IS_RX_CO_OV</span><span class="p">)</span>
		<span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RX_IRQ_SRC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GM_IS_TX_CO_OV</span><span class="p">)</span>
		<span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TX_IRQ_SRC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GM_IS_RX_FF_OR</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="p">;</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_CLI_RX_FO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GM_IS_TX_FF_UR</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="p">;</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TX_GMF_CTRL_T</span><span class="p">),</span> <span class="n">GMF_CLI_TX_FU</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This should never happen it is a bug. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_le_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">PREF_UNIT_GET_IDX</span><span class="p">));</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: descriptor error q=%#x get=%u put=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">idx</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">PREF_UNIT_PUT_IDX</span><span class="p">)));</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Q_CSR</span><span class="p">),</span> <span class="n">BMU_CLR_IRQ_CHK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_rx_hung</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rxq</span> <span class="o">=</span> <span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">mac_rp</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_RP</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">mac_lev</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RX_GMF_RLEV</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">fifo_rp</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">fifo_lev</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_RL</span><span class="p">));</span>

	<span class="cm">/* If idle and MAC or PCI is stuck */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">mac_rp</span> <span class="o">==</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">mac_rp</span> <span class="o">&amp;&amp;</span>
	      <span class="n">mac_lev</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mac_lev</span> <span class="o">&gt;=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">mac_lev</span><span class="p">)</span> <span class="o">||</span>
	     <span class="cm">/* Check if the PCI RX hang */</span>
	     <span class="p">(</span><span class="n">fifo_rp</span> <span class="o">==</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">fifo_rp</span> <span class="o">&amp;&amp;</span>
	      <span class="n">fifo_lev</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fifo_lev</span> <span class="o">&gt;=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">fifo_lev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;hung mac %d:%d fifo %d (%d:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">mac_lev</span><span class="p">,</span> <span class="n">mac_rp</span><span class="p">,</span> <span class="n">fifo_lev</span><span class="p">,</span>
			      <span class="n">fifo_rp</span><span class="p">,</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="n">Q_WP</span><span class="p">)));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">mac_rp</span> <span class="o">=</span> <span class="n">mac_rp</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">mac_lev</span> <span class="o">=</span> <span class="n">mac_lev</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">fifo_rp</span> <span class="o">=</span> <span class="n">fifo_rp</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">.</span><span class="n">fifo_lev</span> <span class="o">=</span> <span class="n">fifo_lev</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* Check for lost IRQ once a second */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_ISRC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="o">++</span><span class="n">active</span><span class="p">;</span>

			<span class="cm">/* For chips with Rx FIFO, check if stuck */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RAM_BUFFER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">sky2_rx_hung</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;receiver hang detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Hardware/software error handling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_err_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error interrupt status=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_HW_ERR</span><span class="p">)</span>
		<span class="n">sky2_hw_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_IRQ_MAC1</span><span class="p">)</span>
		<span class="n">sky2_mac_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_IRQ_MAC2</span><span class="p">)</span>
		<span class="n">sky2_mac_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_CHK_RX1</span><span class="p">)</span>
		<span class="n">sky2_le_error</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Q_R1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_CHK_RX2</span><span class="p">)</span>
		<span class="n">sky2_le_error</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Q_R2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_CHK_TXA1</span><span class="p">)</span>
		<span class="n">sky2_le_error</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Q_XA1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_CHK_TXA2</span><span class="p">)</span>
		<span class="n">sky2_le_error</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Q_XA2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work_limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sky2_hw</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_EISR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_ERROR</span><span class="p">))</span>
		<span class="n">sky2_err_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_IRQ_PHY1</span><span class="p">)</span>
		<span class="n">sky2_phy_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_IRQ_PHY2</span><span class="p">)</span>
		<span class="n">sky2_phy_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_PHY_QLNK</span><span class="p">)</span>
		<span class="n">sky2_qlink_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">idx</span> <span class="o">=</span> <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_PUT_IDX</span><span class="p">))</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">work_done</span> <span class="o">+=</span> <span class="n">sky2_status_intr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">work_limit</span> <span class="o">-</span> <span class="n">work_done</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">work_limit</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_LISR</span><span class="p">);</span>
<span class="nl">done:</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sky2_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Reading this mask interrupts as side effect */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_ISRC2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span><span class="p">]);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Chip internal frequency for clock calculations */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">sky2_mhz</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EC</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EC_U</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EX</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_SUPR</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_UL_2</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_OPT</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_PRM</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_OP_2</span>:
		<span class="k">return</span> <span class="mi">125</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_FE</span>:
		<span class="k">return</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_FE_P</span>:
		<span class="k">return</span> <span class="mi">50</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_XL</span>:
		<span class="k">return</span> <span class="mi">156</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">sky2_us2clk</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sky2_mhz</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">*</span> <span class="n">us</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">sky2_clk2us</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clk</span> <span class="o">/</span> <span class="n">sky2_mhz</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sky2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">t8</span><span class="p">;</span>

	<span class="cm">/* Enable all clocks and check for bad PCI access */</span>
	<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_RST_CLR</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_CHIP_ID</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_MAC_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFG_CHIP_R_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_XL</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_GIGABIT</span> <span class="o">|</span> <span class="n">SKY2_HW_NEWER_PHY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&lt;</span> <span class="n">CHIP_REV_YU_XL_A2</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_RSS_BROKEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EC_U</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_GIGABIT</span>
			<span class="o">|</span> <span class="n">SKY2_HW_NEWER_PHY</span>
			<span class="o">|</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EX</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_GIGABIT</span>
			<span class="o">|</span> <span class="n">SKY2_HW_NEWER_PHY</span>
			<span class="o">|</span> <span class="n">SKY2_HW_NEW_LE</span>
			<span class="o">|</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span>
			<span class="o">|</span> <span class="n">SKY2_HW_RSS_CHKSUM</span><span class="p">;</span>

		<span class="cm">/* New transmit checksum */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">!=</span> <span class="n">CHIP_REV_YU_EX_B0</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_AUTO_TX_SUM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_EC</span>:
		<span class="cm">/* This rev is really old, and requires untested workarounds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_EC_A1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported revision Yukon-EC rev A1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_GIGABIT</span> <span class="o">|</span> <span class="n">SKY2_HW_RSS_BROKEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_FE</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_RSS_BROKEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_FE_P</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_NEWER_PHY</span>
			<span class="o">|</span> <span class="n">SKY2_HW_NEW_LE</span>
			<span class="o">|</span> <span class="n">SKY2_HW_AUTO_TX_SUM</span>
			<span class="o">|</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span><span class="p">;</span>

		<span class="cm">/* The workaround for status conflicts VLAN tag detection. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_FE2_A0</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_VLAN_BROKEN</span> <span class="o">|</span> <span class="n">SKY2_HW_RSS_CHKSUM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_SUPR</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_GIGABIT</span>
			<span class="o">|</span> <span class="n">SKY2_HW_NEWER_PHY</span>
			<span class="o">|</span> <span class="n">SKY2_HW_NEW_LE</span>
			<span class="o">|</span> <span class="n">SKY2_HW_AUTO_TX_SUM</span>
			<span class="o">|</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="n">CHIP_REV_YU_SU_A0</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_RSS_CHKSUM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_UL_2</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_GIGABIT</span>
			<span class="o">|</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_OPT</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_PRM</span>:
	<span class="k">case</span> <span class="n">CHIP_ID_YUKON_OP_2</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_HW_GIGABIT</span>
			<span class="o">|</span> <span class="n">SKY2_HW_NEW_LE</span>
			<span class="o">|</span> <span class="n">SKY2_HW_ADV_POWER_CTL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported chip type 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pmd_type</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_PMD_TYP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pmd_type</span> <span class="o">==</span> <span class="sc">&#39;L&#39;</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pmd_type</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pmd_type</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_FIBRE_PHY</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t8</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_Y2_HW_RES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">t8</span> <span class="o">&amp;</span> <span class="n">CFG_DUAL_MAC_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CFG_DUAL_MAC_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_Y2_CLK_GATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Y2_STATUS_LNK2_INAC</span><span class="p">))</span>
			<span class="o">++</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_E_0</span><span class="p">))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_RAM_BUFFER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hwe_mask</span> <span class="o">=</span> <span class="n">Y2_HWE_ALL_MASK</span><span class="p">;</span>

	<span class="cm">/* disable ASF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span>
	    <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_SUPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CPU_WDOG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HCU_CCSR</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HCU_CCSR_AHB_RST</span> <span class="o">|</span> <span class="n">HCU_CCSR_CPU_RST_MODE</span> <span class="o">|</span>
			    <span class="n">HCU_CCSR_UC_STATE_MSK</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * CPU clock divider shouldn&#39;t be used because</span>
<span class="cm">		 * - ASF firmware may malfunction</span>
<span class="cm">		 * - Yukon-Supreme: Parallel FLASH doesn&#39;t support divided clocks</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCU_CCSR_CPU_CLK_DIVIDE_MSK</span><span class="p">;</span>
		<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HCU_CCSR</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CPU_WDOG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B28_Y2_ASF_STAT_CMD</span><span class="p">,</span> <span class="n">Y2_ASF_RESET</span><span class="p">);</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">Y2_ASF_DISABLE</span><span class="p">);</span>

	<span class="cm">/* do a SW reset */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_RST_SET</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_RST_CLR</span><span class="p">);</span>

	<span class="cm">/* allow writes to PCI config */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_ON</span><span class="p">);</span>

	<span class="cm">/* clear PCI errors, if any */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">PCI_STATUS_ERROR_BITS</span><span class="p">;</span>
	<span class="n">sky2_pci_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_MRST_CLR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_CFG_AER</span> <span class="o">+</span> <span class="n">PCI_ERR_UNCOR_STATUS</span><span class="p">,</span>
			     <span class="mh">0xfffffffful</span><span class="p">);</span>

		<span class="cm">/* If error bit is stuck on ignore it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_HWE_ISRC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Y2_IS_PCI_EXP</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ignoring stuck error report bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hwe_mask</span> <span class="o">|=</span> <span class="n">Y2_IS_PCI_EXP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sky2_power_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_OFF</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GMAC_LINK_CTRL</span><span class="p">),</span> <span class="n">GMLC_RST_SET</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GMAC_LINK_CTRL</span><span class="p">),</span> <span class="n">GMLC_RST_CLR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span> <span class="o">||</span>
		    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_SUPR</span><span class="p">)</span>
			<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GMAC_CTRL</span><span class="p">),</span>
				     <span class="n">GMC_BYP_MACSECRX_ON</span> <span class="o">|</span> <span class="n">GMC_BYP_MACSECTX_ON</span>
				     <span class="o">|</span> <span class="n">GMC_BYP_RETR_ON</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_SUPR</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;</span> <span class="n">CHIP_REV_YU_SU_B0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable MACSec clock gating */</span>
		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG3</span><span class="p">,</span> <span class="n">P_CLK_MACSEC_DIS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_OPT</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_PRM</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_OP_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_OPT</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable PCI-E PHY power down (set PHY reg 0x80, bit 7 */</span>
			<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_PEX_PHY_DATA</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x80UL</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>

			<span class="cm">/* set PHY Link Detect Timer to 1.1 second (11x 100ms) */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

			<span class="cm">/* re-enable PEX PM in PEX PHY debug reg. 8 (clear bit 12) */</span>
			<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_PEX_PHY_DATA</span><span class="p">,</span> <span class="n">PEX_DB_ACCESS</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x08UL</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* set PHY Link Detect Timer to 0.4 second (4x 100ms) */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="n">PSM_CONFIG_REG4_TIMER_PHY_LINK_DETECT_BASE</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">PSM_CONFIG_REG4_RST_PHY_LINK_DETECT</span><span class="p">;</span>

		<span class="cm">/* reset PHY Link Detect */</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_ON</span><span class="p">);</span>
		<span class="n">sky2_pci_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PSM_CONFIG_REG4</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* check if PSMv2 was running before */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PSM_CONFIG_REG3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_LNKCTL_ASPMC</span><span class="p">)</span>
			<span class="cm">/* restore the PCIe Link Control register */</span>
			<span class="n">sky2_pci_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span>
					 <span class="n">reg</span><span class="p">);</span>

		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TST_CTRL1</span><span class="p">,</span> <span class="n">TST_CFG_WRITE_OFF</span><span class="p">);</span>

		<span class="cm">/* re-enable PEX PM in PEX PHY debug reg. 8 (clear bit 12) */</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_PEX_PHY_DATA</span><span class="p">,</span> <span class="n">PEX_DB_ACCESS</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x08UL</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Clear I2C IRQ noise */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_I2C_IRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* turn off hardware timer (unused) */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TI_CTRL</span><span class="p">,</span> <span class="n">TIM_STOP</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B2_TI_CTRL</span><span class="p">,</span> <span class="n">TIM_CLR_IRQ</span><span class="p">);</span>

	<span class="cm">/* Turn off descriptor polling */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B28_DPT_CTRL</span><span class="p">,</span> <span class="n">DPT_STOP</span><span class="p">);</span>

	<span class="cm">/* Turn off receive timestamp */</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GMAC_TI_ST_CTRL</span><span class="p">,</span> <span class="n">GMT_ST_STOP</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GMAC_TI_ST_CTRL</span><span class="p">,</span> <span class="n">GMT_ST_CLR_IRQ</span><span class="p">);</span>

	<span class="cm">/* enable the Tx Arbiters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SK_REG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TXA_CTRL</span><span class="p">),</span> <span class="n">TXA_ENA_ARB</span><span class="p">);</span>

	<span class="cm">/* Initialize ram interface */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_CTRL</span><span class="p">),</span> <span class="n">RI_RST_CLR</span><span class="p">);</span>

		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_WTO_R1</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_WTO_XA1</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_WTO_XS1</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_RTO_R1</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_RTO_XA1</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_RTO_XS1</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_WTO_R2</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_WTO_XA2</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_WTO_XS2</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_RTO_R2</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_RTO_XA2</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RAM_BUFFER</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">B3_RI_RTO_XS2</span><span class="p">),</span> <span class="n">SK_RI_TO_53</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_HWE_IMSK</span><span class="p">,</span> <span class="n">hwe_mask</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sky2_gmac_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_status_le</span><span class="p">));</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_CTRL</span><span class="p">,</span> <span class="n">SC_STAT_RST_SET</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_CTRL</span><span class="p">,</span> <span class="n">SC_STAT_RST_CLR</span><span class="p">);</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LIST_ADDR_LO</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_dma</span><span class="p">);</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LIST_ADDR_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Set the list last index */</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LAST_IDX</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_IDX_TH</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_FIFO_WM</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* set Status-FIFO ISR watermark */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_FIFO_ISR_WM</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_FIFO_ISR_WM</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_INI</span><span class="p">,</span> <span class="n">sky2_us2clk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1000</span><span class="p">));</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_INI</span><span class="p">,</span> <span class="n">sky2_us2clk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_INI</span><span class="p">,</span> <span class="n">sky2_us2clk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span>

	<span class="cm">/* enable status unit */</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_CTRL</span><span class="p">,</span> <span class="n">SC_STAT_OP_ON</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_START</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_START</span><span class="p">);</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Take device down (offline).</span>
<span class="cm"> * Equivalent to doing dev_stop() but this does not</span>
<span class="cm"> * inform upper layers of the transition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_tx_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* stop txq */</span>
		<span class="n">netif_tx_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">sky2_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Bring device back after doing sky2_detach */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_reattach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sky2_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not restart %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">dev_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">sky2_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_all_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_IRQ_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">sky2_hw_down</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_all_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">imask</span> <span class="o">=</span> <span class="n">Y2_IS_BASE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sky2_hw_up</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
		<span class="n">sky2_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">imask</span> <span class="o">|=</span> <span class="n">portirq_msk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_IRQ_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="n">imask</span><span class="p">);</span>
		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>
		<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_LISR</span><span class="p">);</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sky2_hw</span><span class="p">,</span> <span class="n">restart_work</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">sky2_all_down</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">sky2_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">sky2_all_up</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">sky2_wol_supported</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sky2_is_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">WAKE_PHY</span> <span class="o">|</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">sky2_wol_supported</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enable_wakeup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">sky2_wol_supported</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span>
			<span class="n">enable_wakeup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">enable_wakeup</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sky2_supported_modes</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_is_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">modes</span> <span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span>
			<span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span>
			<span class="o">|</span> <span class="n">SUPPORTED_100baseT_Half</span>
			<span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_GIGABIT</span><span class="p">)</span>
			<span class="n">modes</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Half</span>
				<span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">modes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">SUPPORTED_1000baseT_Half</span>
			<span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">sky2_supported_modes</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">PHY_ADDR_MARV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_is_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span>  <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_TP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span>  <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">:</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">supported</span> <span class="o">=</span> <span class="n">sky2_supported_modes</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">supported</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sky2_is_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_TP</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_FIBRE</span> <span class="o">|</span>
					    <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>

		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">setting</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">ecmd</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">SUPPORTED_1000baseT_Half</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">SUPPORTED_100baseT_Half</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">SUPPORTED_10baseT_Full</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">setting</span> <span class="o">&amp;</span> <span class="n">supported</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sky2_phy_reinit</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
		<span class="n">sky2_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_stat</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sky2_stats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tx_bytes&quot;</span><span class="p">,</span>	   <span class="n">GM_TXO_OK_HI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_bytes&quot;</span><span class="p">,</span>	   <span class="n">GM_RXO_OK_HI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_broadcast&quot;</span><span class="p">,</span>  <span class="n">GM_TXF_BC_OK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_broadcast&quot;</span><span class="p">,</span>  <span class="n">GM_RXF_BC_OK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_multicast&quot;</span><span class="p">,</span>  <span class="n">GM_TXF_MC_OK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_multicast&quot;</span><span class="p">,</span>  <span class="n">GM_RXF_MC_OK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_unicast&quot;</span><span class="p">,</span>    <span class="n">GM_TXF_UC_OK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_unicast&quot;</span><span class="p">,</span>    <span class="n">GM_RXF_UC_OK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_mac_pause&quot;</span><span class="p">,</span>  <span class="n">GM_TXF_MPAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_mac_pause&quot;</span><span class="p">,</span>  <span class="n">GM_RXF_MPAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;collisions&quot;</span><span class="p">,</span>    <span class="n">GM_TXF_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;late_collision&quot;</span><span class="p">,</span><span class="n">GM_TXF_LAT_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;aborted&quot;</span><span class="p">,</span> 	   <span class="n">GM_TXF_ABO_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;single_collisions&quot;</span><span class="p">,</span> <span class="n">GM_TXF_SNG_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;multi_collisions&quot;</span><span class="p">,</span> <span class="n">GM_TXF_MUL_COL</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;rx_short&quot;</span><span class="p">,</span>      <span class="n">GM_RXF_SHT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_runt&quot;</span><span class="p">,</span> 	   <span class="n">GM_RXE_FRAG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_64_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_RXF_64B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_65_to_127_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_RXF_127B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_128_to_255_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_RXF_255B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_256_to_511_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_RXF_511B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_512_to_1023_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_RXF_1023B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_1024_to_1518_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_RXF_1518B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_1518_to_max_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_RXF_MAX_SZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_too_long&quot;</span><span class="p">,</span>   <span class="n">GM_RXF_LNG_ERR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_fifo_overflow&quot;</span><span class="p">,</span> <span class="n">GM_RXE_FIFO_OV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_jabber&quot;</span><span class="p">,</span>     <span class="n">GM_RXF_JAB_PKT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_fcs_error&quot;</span><span class="p">,</span>   <span class="n">GM_RXF_FCS_ERR</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;tx_64_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_TXF_64B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_65_to_127_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_TXF_127B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_128_to_255_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_TXF_255B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_256_to_511_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_TXF_511B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_512_to_1023_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_TXF_1023B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_1024_to_1518_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_TXF_1518B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_1519_to_max_byte_packets&quot;</span><span class="p">,</span> <span class="n">GM_TXF_MAX_SZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_fifo_underrun&quot;</span><span class="p">,</span> <span class="n">GM_TXE_FIFO_UR</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sky2_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sky2_phy_reinit</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="n">sky2_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_phy_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_stats64</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TXO_OK_LO</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_stats64</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXO_OK_LO</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sky2_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sky2_stats</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sky2_phy_stats</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sky2_stats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sky2_stats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">,</span>
			       <span class="n">sky2_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">B2_MAC_1</span> <span class="o">+</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">B2_MAC_2</span> <span class="o">+</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* virtual address for data */</span>
	<span class="n">gma_set_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SRC_ADDR_2L</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* physical address: used for pause frames */</span>
	<span class="n">gma_set_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_SRC_ADDR_1L</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sky2_add_filter</span><span class="p">(</span><span class="n">u8</span> <span class="n">filter</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">bit</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">;</span>
	<span class="n">filter</span><span class="p">[</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">filter</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rx_pause</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pause_mc_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">};</span>

	<span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">==</span> <span class="n">FC_RX</span> <span class="o">||</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_status</span> <span class="o">==</span> <span class="n">FC_BOTH</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filter</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">gma_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RX_CTRL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_RXCR_UCF_ENA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>	<span class="cm">/* promiscuous */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GM_RXCR_UCF_ENA</span> <span class="o">|</span> <span class="n">GM_RXCR_MCF_ENA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filter</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GM_RXCR_MCF_ENA</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">GM_RXCR_MCF_ENA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_pause</span><span class="p">)</span>
			<span class="n">sky2_add_filter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">pause_mc_addr</span><span class="p">);</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
			<span class="n">sky2_add_filter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H1</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H2</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H3</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_MC_ADDR_H4</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">filter</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">gma_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RX_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="nf">sky2_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">_bytes</span><span class="p">,</span> <span class="n">_packets</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="n">_bytes</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">_packets</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">_packets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">_bytes</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="n">_bytes</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">_packets</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">_packets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">_bytes</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXF_MC_OK</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXF_BC_OK</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_TXF_COL</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXF_LNG_ERR</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXF_FCS_ERR</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXF_SHT</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXE_FRAG</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span> <span class="o">=</span> <span class="n">get_stats32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">GM_RXE_FIFO_OV</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Can have one global because blinking is controlled by</span>
<span class="cm"> * ethtool and that is always under RTNL mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EX</span> <span class="o">||</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_SUPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pg</span><span class="p">;</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">gm_phy_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">);</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MO_LED_OFF</span>:
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span>
				     <span class="n">PHY_M_LEDC_LOS_CTRL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_INIT_CTRL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA1_CTRL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA0_CTRL</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MO_LED_ON</span>:
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span>
				     <span class="n">PHY_M_LEDC_LOS_CTRL</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_INIT_CTRL</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA1_CTRL</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA0_CTRL</span><span class="p">(</span><span class="mi">9</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MO_LED_BLINK</span>:
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span>
				     <span class="n">PHY_M_LEDC_LOS_CTRL</span><span class="p">(</span><span class="mh">0xa</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_INIT_CTRL</span><span class="p">(</span><span class="mh">0xa</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA1_CTRL</span><span class="p">(</span><span class="mh">0xa</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA0_CTRL</span><span class="p">(</span><span class="mh">0xa</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MO_LED_NORM</span>:
			<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_PHY_CTRL</span><span class="p">,</span>
				     <span class="n">PHY_M_LEDC_LOS_CTRL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_INIT_CTRL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA1_CTRL</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LEDC_STA0_CTRL</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_EXT_ADR</span><span class="p">,</span> <span class="n">pg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">gm_phy_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">PHY_MARV_LED_OVER</span><span class="p">,</span>
				     <span class="n">PHY_M_LED_MO_DUP</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LED_MO_10</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LED_MO_100</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LED_MO_1000</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LED_MO_RX</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHY_M_LED_MO_TX</span><span class="p">(</span><span class="n">mode</span><span class="p">));</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* blink LED&#39;s for finding board */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_phys_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ACTIVE</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* cycle on/off once per second */</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_INACTIVE</span>:
		<span class="n">sky2_led</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">MO_LED_NORM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ON</span>:
		<span class="n">sky2_led</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">MO_LED_ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_OFF</span>:
		<span class="n">sky2_led</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">MO_LED_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_NONE</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_TX</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_RX</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_BOTH</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_FLAG_AUTO_PAUSE</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">:</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_FLAG_AUTO_PAUSE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKY2_FLAG_AUTO_PAUSE</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span> <span class="o">=</span> <span class="n">sky2_flow</span><span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">sky2_phy_reinit</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_CTRL</span><span class="p">)</span> <span class="o">==</span> <span class="n">TIM_STOP</span><span class="p">)</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">clks</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_INI</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">sky2_clk2us</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">clks</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_IDX_TH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_CTRL</span><span class="p">)</span> <span class="o">==</span> <span class="n">TIM_STOP</span><span class="p">)</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">clks</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_INI</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">sky2_clk2us</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">clks</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_FIFO_WM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_CTRL</span><span class="p">)</span> <span class="o">==</span> <span class="n">TIM_STOP</span><span class="p">)</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">clks</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_INI</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">sky2_clk2us</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">clks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span> <span class="o">=</span> <span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_FIFO_ISR_WM</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note: this affect both ports */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">sky2_clk2us</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x0ffffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">&gt;</span> <span class="n">tmax</span> <span class="o">||</span>
	    <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">&gt;</span> <span class="n">tmax</span> <span class="o">||</span>
	    <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">&gt;=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">&gt;</span> <span class="n">RX_MAX_PENDING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span> <span class="o">&gt;</span> <span class="n">RX_MAX_PENDING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_STOP</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_INI</span><span class="p">,</span>
			     <span class="n">sky2_us2clk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">));</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_START</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sky2_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_TX_IDX_TH</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_STOP</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_INI</span><span class="p">,</span>
			     <span class="n">sky2_us2clk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">));</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_LEV_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_START</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_FIFO_WM</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_STOP</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_INI</span><span class="p">,</span>
			     <span class="n">sky2_us2clk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span><span class="p">));</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_ISR_TIMER_CTRL</span><span class="p">,</span> <span class="n">TIM_START</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_FIFO_ISR_WM</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware is limited to min of 128 and max of 2048 for ring size</span>
<span class="cm"> * and  rounded up to next power of two</span>
<span class="cm"> * to avoid division in modulus calclation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">roundup_ring_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="mi">128ul</span><span class="p">,</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">pending</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">RX_MAX_PENDING</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">TX_MAX_PENDING</span><span class="p">;</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">RX_MAX_PENDING</span> <span class="o">||</span>
	    <span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">||</span>
	    <span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;</span> <span class="n">TX_MIN_PENDING</span> <span class="o">||</span>
	    <span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">TX_MAX_PENDING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sky2_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">roundup_ring_size</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sky2_reattach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0x4000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_reg_access_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This complicated switch statement is to make sure and</span>
<span class="cm">	 * only access regions that are unreserved.</span>
<span class="cm">	 * Some blocks are only valid on dual port cards.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* second port */</span>
	<span class="k">case</span> <span class="mi">5</span>:		<span class="cm">/* Tx Arbiter 2 */</span>
	<span class="k">case</span> <span class="mi">9</span>:		<span class="cm">/* RX2 */</span>
	<span class="k">case</span> <span class="mi">14</span> <span class="p">...</span> <span class="mi">15</span>:	<span class="cm">/* TX2 */</span>
	<span class="k">case</span> <span class="mi">17</span>: <span class="k">case</span> <span class="mi">19</span>: <span class="cm">/* Ram Buffer 2 */</span>
	<span class="k">case</span> <span class="mi">22</span> <span class="p">...</span> <span class="mi">23</span>: <span class="cm">/* Tx Ram Buffer 2 */</span>
	<span class="k">case</span> <span class="mi">25</span>:	<span class="cm">/* Rx MAC Fifo 1 */</span>
	<span class="k">case</span> <span class="mi">27</span>:	<span class="cm">/* Tx MAC Fifo 2 */</span>
	<span class="k">case</span> <span class="mi">31</span>:	<span class="cm">/* GPHY 2 */</span>
	<span class="k">case</span> <span class="mi">40</span> <span class="p">...</span> <span class="mi">47</span>: <span class="cm">/* Pattern Ram 2 */</span>
	<span class="k">case</span> <span class="mi">52</span>: <span class="k">case</span> <span class="mi">54</span>: <span class="cm">/* TCP Segmentation 2 */</span>
	<span class="k">case</span> <span class="mi">112</span> <span class="p">...</span> <span class="mi">116</span>: <span class="cm">/* GMAC 2 */</span>
		<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* Control */</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* Mac address */</span>
	<span class="k">case</span> <span class="mi">4</span>:		<span class="cm">/* Tx Arbiter 1 */</span>
	<span class="k">case</span> <span class="mi">7</span>:		<span class="cm">/* PCI express reg */</span>
	<span class="k">case</span> <span class="mi">8</span>:		<span class="cm">/* RX1 */</span>
	<span class="k">case</span> <span class="mi">12</span> <span class="p">...</span> <span class="mi">13</span>: <span class="cm">/* TX1 */</span>
	<span class="k">case</span> <span class="mi">16</span>: <span class="k">case</span> <span class="mi">18</span>:<span class="cm">/* Rx Ram Buffer 1 */</span>
	<span class="k">case</span> <span class="mi">20</span> <span class="p">...</span> <span class="mi">21</span>: <span class="cm">/* Tx Ram Buffer 1 */</span>
	<span class="k">case</span> <span class="mi">24</span>:	<span class="cm">/* Rx MAC Fifo 1 */</span>
	<span class="k">case</span> <span class="mi">26</span>:	<span class="cm">/* Tx MAC Fifo 1 */</span>
	<span class="k">case</span> <span class="mi">28</span> <span class="p">...</span> <span class="mi">29</span>: <span class="cm">/* Descriptor and status unit */</span>
	<span class="k">case</span> <span class="mi">30</span>:	<span class="cm">/* GPHY 1*/</span>
	<span class="k">case</span> <span class="mi">32</span> <span class="p">...</span> <span class="mi">39</span>: <span class="cm">/* Pattern Ram 1 */</span>
	<span class="k">case</span> <span class="mi">48</span>: <span class="k">case</span> <span class="mi">50</span>: <span class="cm">/* TCP Segmentation 1 */</span>
	<span class="k">case</span> <span class="mi">56</span> <span class="p">...</span> <span class="mi">60</span>:	<span class="cm">/* PCI space */</span>
	<span class="k">case</span> <span class="mi">80</span> <span class="p">...</span> <span class="mi">84</span>:	<span class="cm">/* GMAC 1 */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns copy of control register region</span>
<span class="cm"> * Note: ethtool_get_regs always provides full size (16k) buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skip poisonous diagnostic ram region in block 3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">128</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sky2_reg_access_ok</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">io</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg2</span><span class="p">;</span>

	<span class="n">reg2</span> <span class="o">=</span> <span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span> <span class="p">((</span><span class="n">reg2</span> <span class="o">&amp;</span> <span class="n">PCI_VPD_ROM_SZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_vpd_wait</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">busy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_VPD_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">)</span> <span class="o">==</span> <span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Can take up to 10.6 ms for write */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VPD cycle timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_vpd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cap</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">sky2_pci_write16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_VPD_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sky2_vpd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">sky2_pci_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_VPD_DATA</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">length</span><span class="p">));</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_vpd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_VPD_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">sky2_pci_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_VPD_ADDR</span><span class="p">,</span> <span class="n">offset</span> <span class="o">|</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">sky2_vpd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">PCI_VPD_ADDR_F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_VPD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">SKY2_EEPROM_MAGIC</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sky2_vpd_read</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_VPD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">SKY2_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Partial writes not supported */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sky2_vpd_write</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">sky2_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* In order to do Jumbo packets on these chips, need to turn off the</span>
<span class="cm">	 * transmit store/forward. Therefore checksum offload won&#39;t work.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">CHIP_ID_YUKON_EC_U</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;checksum offload not possible with jumbo frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NETIF_F_TSO</span><span class="o">|</span><span class="n">NETIF_F_SG</span><span class="o">|</span><span class="n">NETIF_F_ALL_CSUM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Some hardware requires receive checksum for RSS to work. */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RSS_CHKSUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;receive hashing forces receive checksum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_NEW_LE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sky2_write32</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
			     <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_CSR</span><span class="p">),</span>
			     <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
			     <span class="o">?</span> <span class="n">BMU_ENA_RX_CHKSUM</span> <span class="o">:</span> <span class="n">BMU_DIS_RX_CHKSUM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span>
		<span class="n">rx_set_rss</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="o">|</span><span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">))</span>
		<span class="n">sky2_vlan_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">sky2_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">sky2_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">sky2_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">sky2_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>	<span class="o">=</span> <span class="n">sky2_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>	<span class="o">=</span> <span class="n">sky2_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>	<span class="o">=</span> <span class="n">sky2_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>	<span class="o">=</span> <span class="n">sky2_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>	<span class="o">=</span> <span class="n">sky2_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>	<span class="o">=</span> <span class="n">sky2_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>	<span class="o">=</span> <span class="n">sky2_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>	<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>	<span class="o">=</span> <span class="n">sky2_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>	<span class="o">=</span> <span class="n">sky2_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>	<span class="o">=</span> <span class="n">sky2_set_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>	<span class="o">=</span> <span class="n">sky2_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span>	<span class="o">=</span> <span class="n">sky2_get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span>	<span class="o">=</span> <span class="n">sky2_set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>	<span class="o">=</span> <span class="n">sky2_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>	<span class="o">=</span> <span class="n">sky2_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">sky2_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span> <span class="o">=</span> <span class="n">sky2_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span>	<span class="o">=</span> <span class="n">sky2_set_phys_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">sky2_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">sky2_get_ethtool_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SKY2_DEBUG</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">sky2_debug</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Read and parse the first part of Vital Product Data</span>
<span class="cm"> */</span>
<span class="cp">#define VPD_SIZE	128</span>
<span class="cp">#define VPD_MAGIC	0x82</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vpd_tag</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>
<span class="p">}</span> <span class="n">vpd_tags</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;PN&quot;</span><span class="p">,</span>	<span class="s">&quot;Part Number&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;EC&quot;</span><span class="p">,</span> <span class="s">&quot;Engineering Level&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MN&quot;</span><span class="p">,</span> <span class="s">&quot;Manufacturer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SN&quot;</span><span class="p">,</span> <span class="s">&quot;Serial Number&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;YA&quot;</span><span class="p">,</span> <span class="s">&quot;Asset Tag&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;VL&quot;</span><span class="p">,</span> <span class="s">&quot;First Error Log Message&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;VF&quot;</span><span class="p">,</span> <span class="s">&quot;Second Error Log Message&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;VB&quot;</span><span class="p">,</span> <span class="s">&quot;Boot Agent ROM Configuration&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;VE&quot;</span><span class="p">,</span> <span class="s">&quot;EFI UNDI Configuration&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_show_vpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">vpd_size</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg2</span><span class="p">;</span>

	<span class="n">reg2</span> <span class="o">=</span> <span class="n">sky2_pci_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PCI_DEV_REG2</span><span class="p">);</span>
	<span class="n">vpd_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span> <span class="p">((</span><span class="n">reg2</span> <span class="o">&amp;</span> <span class="n">PCI_VPD_ROM_SZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s Product Data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">vpd_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;no memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_vpd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vpd_size</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;VPD read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">VPD_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;VPD tag mismatch: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">vpd_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Invalid id length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">offs</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&lt;</span> <span class="n">vpd_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="s">&quot;RW&quot;</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>	<span class="cm">/* end marker */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">offs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="n">vpd_size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vpd_tags</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vpd_tags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tag</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s: %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">vpd_tags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">label</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">offs</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">offs</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_debug_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sop</span><span class="p">;</span>

	<span class="n">sky2_show_vpd</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IRQ src=%x mask=%x control=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_ISRC</span><span class="p">),</span>
		   <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">),</span>
		   <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_ICR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;network not running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">STAT_PUT_IDX</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Status ring %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Status ring (empty)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Status ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_idx</span><span class="p">;</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">;</span>
		     <span class="n">idx</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_status_le</span> <span class="o">*</span><span class="n">le</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;[%d] %#x %d %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">idx</span><span class="p">,</span> <span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">le</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Tx ring pending=%u...%u report=%d done=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">,</span>
		   <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">STAT_TXA1_RIDX</span> <span class="o">:</span> <span class="n">STAT_TXA2_RIDX</span><span class="p">),</span>
		   <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Q_ADDR</span><span class="p">(</span><span class="n">txqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">Q_DONE</span><span class="p">)));</span>

	<span class="cm">/* Dump contents of tx ring */</span>
	<span class="n">sop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_next</span><span class="p">;</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
	     <span class="n">idx</span> <span class="o">=</span> <span class="n">RING_NEXT</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_tx_le</span> <span class="o">*</span><span class="n">le</span> <span class="o">=</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_le</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">a</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%u:&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">sop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HW_OWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_ADDR64</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %#x:&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_LRGLEN</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; mtu=%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_VLAN</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; vlan=%d&quot;</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_TCPLISW</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; csum=%#x&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_LARGESEND</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; tso=%#x(%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PACKET</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %#x(%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_BUFFER</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; frag=%#x(%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; op=%#x,%#x(%d)&quot;</span><span class="p">,</span> <span class="n">le</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span>
				   <span class="n">a</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_putc</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
			<span class="n">sop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Rx ring hw get=%d put=%d last=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">PREF_UNIT_GET_IDX</span><span class="p">)),</span>
		   <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">PREF_UNIT_PUT_IDX</span><span class="p">)),</span>
		   <span class="n">sky2_read16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">Y2_QADDR</span><span class="p">(</span><span class="n">rxqaddr</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="n">PREF_UNIT_LAST_IDX</span><span class="p">)));</span>

	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_LISR</span><span class="p">);</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_debug_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sky2_debug_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">sky2_debug_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sky2_debug_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Use network device events to create/remove/rename</span>
<span class="cm"> * debugfs file entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_device_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_open</span> <span class="o">!=</span> <span class="n">sky2_open</span> <span class="o">||</span> <span class="o">!</span><span class="n">sky2_debug</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_CHANGENAME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="n">debugfs_rename</span><span class="p">(</span><span class="n">sky2_debug</span><span class="p">,</span> <span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">,</span>
						       <span class="n">sky2_debug</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_GOING_DOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;remove debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">);</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
						    <span class="n">sky2_debug</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">sky2_debug_fops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">))</span>
			<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">sky2_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">sky2_device_event</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">sky2_debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;sky2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sky2_debug</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>
	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2_notifier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">sky2_debug_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sky2_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2_notifier</span><span class="p">);</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">sky2_debug</span><span class="p">);</span>
		<span class="n">sky2_debug</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define sky2_debug_init()</span>
<span class="cp">#define sky2_debug_cleanup()</span>
<span class="cp">#endif</span>

<span class="cm">/* Two copies of network device operations to handle special case of</span>
<span class="cm">   not allowing netpoll on second port */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sky2_netdev_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sky2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sky2_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sky2_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">sky2_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">sky2_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">sky2_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">sky2_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">sky2_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">sky2_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">sky2_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">sky2_get_stats</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">sky2_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
  <span class="p">},</span>
  <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sky2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sky2_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sky2_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">sky2_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">sky2_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">sky2_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">sky2_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">sky2_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">sky2_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">sky2_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">sky2_get_stats</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Initialize network device */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">sky2_init_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
						     <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span>
						     <span class="kt">int</span> <span class="n">highmem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sky2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sky2_ethtool_ops</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_WATCHDOG</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sky2_netdev_ops</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">default_msg</span><span class="p">);</span>

	<span class="cm">/* Auto speed and flow control */</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SKY2_FLAG_AUTO_SPEED</span> <span class="o">|</span> <span class="n">SKY2_FLAG_AUTO_PAUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="n">CHIP_ID_YUKON_XL</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">flow_mode</span> <span class="o">=</span> <span class="n">FC_BOTH</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">sky2_supported_modes</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="n">wol</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">TX_DEF_PENDING</span><span class="p">;</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">roundup_ring_size</span><span class="p">(</span><span class="n">TX_DEF_PENDING</span><span class="p">);</span>
	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">RX_DEF_PENDING</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">sky2</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highmem</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="cm">/* Enable receive hashing unless hardware is known broken */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_RSS_BROKEN</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXHASH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_VLAN_BROKEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">SKY2_VLAN_OFFLOADS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>

	<span class="cm">/* read the mac address */</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">B2_MAC_1</span> <span class="o">+</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">sky2_show_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">sky2</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Handle software interrupt used during MSI test */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">__devinit</span> <span class="nf">sky2_test_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_ISRC2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Y2_IS_IRQ_SW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKY2_HW_USE_MSI</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">msi_wait</span><span class="p">);</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_CL_SW_IRQ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_Y2_SP_ICR</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test interrupt path by forcing a a software IRQ */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sky2_test_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">msi_wait</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sky2_test_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot assign irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="n">Y2_IS_IRQ_SW</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_ST_SW_IRQ</span><span class="p">);</span>
	<span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">);</span>

	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">msi_wait</span><span class="p">,</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_USE_MSI</span><span class="p">),</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_USE_MSI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* MSI test failed, go back to INTx mode */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No interrupt generated using MSI, &quot;</span>
			 <span class="s">&quot;switching to INTx mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_CL_SW_IRQ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This driver supports yukon2 chipset only */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sky2_name</span><span class="p">(</span><span class="n">u8</span> <span class="n">chipid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;XL&quot;</span><span class="p">,</span>		<span class="cm">/* 0xb3 */</span>
		<span class="s">&quot;EC Ultra&quot;</span><span class="p">,</span> 	<span class="cm">/* 0xb4 */</span>
		<span class="s">&quot;Extreme&quot;</span><span class="p">,</span>	<span class="cm">/* 0xb5 */</span>
		<span class="s">&quot;EC&quot;</span><span class="p">,</span>		<span class="cm">/* 0xb6 */</span>
		<span class="s">&quot;FE&quot;</span><span class="p">,</span>		<span class="cm">/* 0xb7 */</span>
		<span class="s">&quot;FE+&quot;</span><span class="p">,</span>		<span class="cm">/* 0xb8 */</span>
		<span class="s">&quot;Supreme&quot;</span><span class="p">,</span>	<span class="cm">/* 0xb9 */</span>
		<span class="s">&quot;UL 2&quot;</span><span class="p">,</span>		<span class="cm">/* 0xba */</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>	<span class="cm">/* 0xbb */</span>
		<span class="s">&quot;Optima&quot;</span><span class="p">,</span>	<span class="cm">/* 0xbc */</span>
		<span class="s">&quot;Optima Prime&quot;</span><span class="p">,</span> <span class="cm">/* 0xbd */</span>
		<span class="s">&quot;Optima 2&quot;</span><span class="p">,</span>	<span class="cm">/* 0xbe */</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chipid</span> <span class="o">&gt;=</span> <span class="n">CHIP_ID_YUKON_XL</span> <span class="o">&amp;&amp;</span> <span class="n">chipid</span> <span class="o">&lt;=</span> <span class="n">CHIP_ID_YUKON_OP_2</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="n">chipid</span> <span class="o">-</span> <span class="n">CHIP_ID_YUKON_XL</span><span class="p">],</span> <span class="n">sz</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="s">&quot;(chip %#x)&quot;</span><span class="p">,</span> <span class="n">chipid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sky2_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">dev1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wol_default</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get configuration information</span>
<span class="cm">	 * Note: only regular PCI config access once to test for HW issues</span>
<span class="cm">	 *       other PCI access through shared memory for speed and to</span>
<span class="cm">	 *	 avoid MMCONFIG problems.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_DEV_REG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI read config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI configuration read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot obtain PCI resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to obtain 64 bit DMA &quot;</span>
				<span class="s">&quot;for consistent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no usable DMA configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="cm">/* The sk98lin vendor driver uses hardware byte swapping but</span>
<span class="cm">	 * this driver uses software swapping.</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_REV_DESC</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_DEV_REG2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI write config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">wol_default</span> <span class="o">=</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">WAKE_MAGIC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;@pci:&quot;</span><span class="p">)</span>
		     <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate hardware struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;@pci:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot map device registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sky2_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>

	<span class="cm">/* ring for status responses */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">*</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">RX_MAX_PENDING</span> <span class="o">+</span> <span class="n">TX_MAX_PENDING</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_status_le</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_reset</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Yukon-2 %s chip revision %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sky2_name</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf1</span><span class="p">)),</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">chip_rev</span><span class="p">);</span>

	<span class="n">sky2_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">sky2_init_netdev</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">using_dac</span><span class="p">,</span> <span class="n">wol_default</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_pci</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_msi</span> <span class="o">&amp;&amp;</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sky2_test_msi</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
 			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>
 	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot register net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">sky2_poll</span><span class="p">,</span> <span class="n">NAPI_WEIGHT</span><span class="p">);</span>

	<span class="n">sky2_show_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev1</span> <span class="o">=</span> <span class="n">sky2_init_netdev</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">using_dac</span><span class="p">,</span> <span class="n">wol_default</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_unregister</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot register second net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_free_dev1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">sky2_setup_irq</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_unregister_dev1</span><span class="p">;</span>

		<span class="n">sky2_show_addr</span><span class="p">(</span><span class="n">dev1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">sky2_watchdog</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hw</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">,</span> <span class="n">sky2_restart</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">d3_delay</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_unregister_dev1:</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev1</span><span class="p">);</span>
<span class="nl">err_out_free_dev1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev1</span><span class="p">);</span>
<span class="nl">err_out_unregister:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_USE_MSI</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_free_pci:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_status_le</span><span class="p">),</span>
			    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_dma</span><span class="p">);</span>
<span class="nl">err_out_reset:</span>
	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_RST_SET</span><span class="p">);</span>
<span class="nl">err_out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">err_out_free_hw:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="nl">err_out_free_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sky2_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">sky2_write32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sky2_read32</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_IMSK</span><span class="p">);</span>

	<span class="n">sky2_power_aux</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">sky2_write8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">,</span> <span class="n">CS_RST_SET</span><span class="p">);</span>
	<span class="n">sky2_read8</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">B0_CTST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SKY2_HW_USE_MSI</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sky2_status_le</span><span class="p">),</span>
			    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_le</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_dma</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">sky2_all_down</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sky2_port</span> <span class="o">*</span><span class="n">sky2</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sky2</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span>
			<span class="n">sky2_wol_init</span><span class="p">(</span><span class="n">sky2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sky2_power_aux</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sky2_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sky2_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Re-enable all clocks */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_DEV_REG3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI write config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">sky2_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">sky2_all_up</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resume failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">sky2_pm_ops</span><span class="p">,</span> <span class="n">sky2_suspend</span><span class="p">,</span> <span class="n">sky2_resume</span><span class="p">);</span>
<span class="cp">#define SKY2_PM_OPS (&amp;sky2_pm_ops)</span>

<span class="cp">#else</span>

<span class="cp">#define SKY2_PM_OPS NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sky2_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sky2_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sky2_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">sky2_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sky2_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sky2_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">sky2_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">SKY2_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sky2_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver version &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sky2_debug_init</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sky2_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sky2_driver</span><span class="p">);</span>
	<span class="n">sky2_debug_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sky2_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sky2_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Marvell Yukon 2 Gigabit Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Stephen Hemminger &lt;shemminger@linux-foundation.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
