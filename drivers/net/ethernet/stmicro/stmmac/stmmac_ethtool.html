<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › stmicro › stmmac › stmmac_ethtool.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>stmmac_ethtool.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>
<span class="cm">  STMMAC Ethtool support</span>

<span class="cm">  Copyright (C) 2007-2009  STMicroelectronics Ltd</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Author: Giuseppe Cavallaro &lt;peppe.cavallaro@st.com&gt;</span>
<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;stmmac.h&quot;</span>
<span class="cp">#include &quot;dwmac_dma.h&quot;</span>

<span class="cp">#define REG_SPACE_SIZE	0x1054</span>
<span class="cp">#define MAC100_ETHTOOL_NAME	&quot;st_mac100&quot;</span>
<span class="cp">#define GMAC_ETHTOOL_NAME	&quot;st_gmac&quot;</span>

<span class="k">struct</span> <span class="n">stmmac_stats</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">stat_string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sizeof_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define STMMAC_STAT(m)	\</span>
<span class="cp">	{ #m, FIELD_SIZEOF(struct stmmac_extra_stats, m),	\</span>
<span class="cp">	offsetof(struct stmmac_priv, xstats.m)}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stmmac_stats</span> <span class="n">stmmac_gstrings_stats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Transmit errors */</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_underflow</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_carrier</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_losscarrier</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">vlan_tag</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_deferred</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_vlan</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_jabber</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_frame_flushed</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_payload_error</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_ip_header_error</span><span class="p">),</span>
	<span class="cm">/* Receive errors */</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_desc</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">sa_filter_fail</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">overflow_error</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">ipc_csum_error</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_collision</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_crc</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">dribbling_bit</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_length</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_mii</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_multicast</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_gmac_overflow</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_watchdog</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">da_rx_filter_fail</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">sa_rx_filter_fail</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_missed_cntr</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_overflow_cntr</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_vlan</span><span class="p">),</span>
	<span class="cm">/* Tx/Rx IRQ errors */</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_undeflow_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_process_stopped_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_jabber_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_overflow_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_buf_unav_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_process_stopped_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_watchdog_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_early_irq</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">fatal_bus_error_irq</span><span class="p">),</span>
	<span class="cm">/* Extra info */</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">threshold</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">tx_pkt_n</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">rx_pkt_n</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">poll_n</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">sched_timer_n</span><span class="p">),</span>
	<span class="n">STMMAC_STAT</span><span class="p">(</span><span class="n">normal_irq_n</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#define STMMAC_STATS_LEN ARRAY_SIZE(stmmac_gstrings_stats)</span>

<span class="cm">/* HW MAC Management counters (if supported) */</span>
<span class="cp">#define STMMAC_MMC_STAT(m)	\</span>
<span class="cp">	{ #m, FIELD_SIZEOF(struct stmmac_counters, m),	\</span>
<span class="cp">	offsetof(struct stmmac_priv, mmc.m)}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stmmac_stats</span> <span class="n">stmmac_mmc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_octetcount_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_framecount_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_broadcastframe_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_multicastframe_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_64_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_65_to_127_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_128_to_255_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_256_to_511_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_512_to_1023_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_1024_to_max_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_unicast_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_multicast_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_broadcast_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_underflow_error</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_singlecol_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_multicol_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_deferred</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_latecol</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_exesscol</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_carrier_error</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_octetcount_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_framecount_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_excessdef</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_pause_frame</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_tx_vlan_frame_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_framecount_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_octetcount_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_octetcount_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_broadcastframe_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_multicastframe_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_crc_errror</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_align_error</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_run_error</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_jabber_error</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_undersize_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_oversize_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_64_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_65_to_127_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_128_to_255_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_256_to_511_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_512_to_1023_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_1024_to_max_octets_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_unicast_g</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_length_error</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_autofrangetype</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_pause_frames</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_fifo_overflow</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_vlan_frames_gb</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_watchdog_error</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipc_intr_mask</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipc_intr</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_gd</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_hderr</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_nopay</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_frag</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_udsbl</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_gd_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_hderr_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_nopay_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_frag_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv4_udsbl_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv6_gd_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv6_hderr_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv6_nopay_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv6_gd</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv6_hderr</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_ipv6_nopay</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_udp_gd</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_udp_err</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_tcp_gd</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_tcp_err</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_icmp_gd</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_icmp_err</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_udp_gd_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_udp_err_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_tcp_gd_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_tcp_err_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_icmp_gd_octets</span><span class="p">),</span>
	<span class="n">STMMAC_MMC_STAT</span><span class="p">(</span><span class="n">mmc_rx_icmp_err_octets</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#define STMMAC_MMC_STATS_LEN ARRAY_SIZE(stmmac_mmc)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stmmac_ethtool_getdrvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">has_gmac</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">GMAC_ETHTOOL_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">MAC100_ETHTOOL_NAME</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stmmac_ethtool_getsettings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s: PHY is not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: interface is disabled: we cannot track &quot;</span>
		<span class="s">&quot;link speed / duplex setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stmmac_ethtool_setsettings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stmmac_ethtool_getmsglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stmmac_ethtool_setmsglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stmmac_check_if_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stmmac_ethtool_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">REG_SPACE_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stmmac_ethtool_gregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">reg_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">space</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">reg_space</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">REG_SPACE_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">has_gmac</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MAC registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reg_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="cm">/* DMA registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reg_space</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">DMA_BUS_MODE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)));</span>
		<span class="n">reg_space</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DMA_CUR_TX_BUF_ADDR</span><span class="p">);</span>
		<span class="n">reg_space</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DMA_CUR_RX_BUF_ADDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MAC registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">55</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reg_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="cm">/* DMA registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reg_space</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">55</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">readl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">DMA_BUS_MODE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">stmmac_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">pause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_RX</span><span class="p">)</span>
		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_TX</span><span class="p">)</span>
		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">stmmac_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">pause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_pause</span> <span class="o">=</span> <span class="n">FLOW_OFF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">new_pause</span> <span class="o">|=</span> <span class="n">FLOW_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
		<span class="n">new_pause</span> <span class="o">|=</span> <span class="n">FLOW_TX</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">new_pause</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">pause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">phy_start_aneg</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stmmac_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Update the DMA HW counters for dwmac10/100 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">has_gmac</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_diagnostic_fr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">,</span>
						 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If supported, for new GMAC chips expose the MMC counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_cap</span><span class="p">.</span><span class="n">rmon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dwmac_mmc_read</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STMMAC_MMC_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
				<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span> <span class="o">+</span> <span class="n">stmmac_mmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_offset</span><span class="p">;</span>

				<span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stmmac_mmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeof_stat</span> <span class="o">==</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span> <span class="o">:</span>
					     <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STMMAC_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span> <span class="o">+</span> <span class="n">stmmac_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_offset</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stmmac_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeof_stat</span> <span class="o">==</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stmmac_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">STMMAC_STATS_LEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_cap</span><span class="p">.</span><span class="n">rmon</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">STMMAC_MMC_STATS_LEN</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stmmac_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_cap</span><span class="p">.</span><span class="n">rmon</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STMMAC_MMC_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stmmac_mmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_string</span><span class="p">,</span>
				       <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STMMAC_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stmmac_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_string</span><span class="p">,</span>
				<span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Currently only support WOL through Magic packet. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stmmac_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span> <span class="o">|</span> <span class="n">WAKE_UCAST</span><span class="p">;</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stmmac_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stmmac_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">support</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span> <span class="o">|</span> <span class="n">WAKE_UCAST</span><span class="p">;</span>

	<span class="cm">/* By default almost all GMAC devices support the WoL via</span>
<span class="cm">	 * magic frame but we can disable it if the HW capability</span>
<span class="cm">	 * register shows no support for pmt_magic_frame. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_cap_support</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_cap</span><span class="p">.</span><span class="n">pmt_magic_frame</span><span class="p">))</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WAKE_MAGIC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">support</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;stmmac: wakeup enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wol_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wol_irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">stmmac_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">begin</span> <span class="o">=</span> <span class="n">stmmac_check_if_running</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">stmmac_ethtool_getdrvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">stmmac_ethtool_getsettings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">stmmac_ethtool_setsettings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span> <span class="o">=</span> <span class="n">stmmac_ethtool_getmsglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span> <span class="o">=</span> <span class="n">stmmac_ethtool_setmsglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span> <span class="o">=</span> <span class="n">stmmac_ethtool_gregs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span> <span class="o">=</span> <span class="n">stmmac_ethtool_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">stmmac_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span> <span class="o">=</span> <span class="n">stmmac_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">stmmac_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">stmmac_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span> <span class="o">=</span> <span class="n">stmmac_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span> <span class="o">=</span> <span class="n">stmmac_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>	<span class="o">=</span> <span class="n">stmmac_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span> <span class="o">=</span> <span class="n">ethtool_op_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">stmmac_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stmmac_ethtool_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
