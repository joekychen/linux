<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › caif › caif_spi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>caif_spi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson AB 2010</span>
<span class="cm"> * Contact: Sjur Brendeland / sjur.brandeland@stericsson.com</span>
<span class="cm"> * Author:  Daniel Martensson / Daniel.Martensson@stericsson.com</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;net/caif/caif_layer.h&gt;</span>
<span class="cp">#include &lt;net/caif/caif_spi.h&gt;</span>

<span class="cp">#ifndef CONFIG_CAIF_SPI_SYNC</span>
<span class="cp">#define FLAVOR &quot;Flavour: Vanilla.\n&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define FLAVOR &quot;Flavour: Master CMD&amp;LEN at start.\n&quot;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CAIF_SPI_SYNC */</span><span class="cp"></span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Daniel Martensson&lt;daniel.martensson@stericsson.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;CAIF SPI driver&quot;</span><span class="p">);</span>

<span class="cm">/* Returns the number of padding bytes for alignment. */</span>
<span class="cp">#define PAD_POW2(x, pow) ((((x)&amp;((pow)-1))==0) ? 0 : (((pow)-((x)&amp;((pow)-1)))))</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">spi_loop</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">spi_loop</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spi_loop</span><span class="p">,</span> <span class="s">&quot;SPI running in loopback mode.&quot;</span><span class="p">);</span>

<span class="cm">/* SPI frame alignment. */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">spi_frm_align</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spi_frm_align</span><span class="p">,</span> <span class="s">&quot;SPI frame alignment.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * SPI padding options.</span>
<span class="cm"> * Warning: must be a base of 2 (&amp; operation used) and can not be zero !</span>
<span class="cm"> */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">spi_up_head_align</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spi_up_head_align</span><span class="p">,</span> <span class="s">&quot;SPI uplink head alignment.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">spi_up_tail_align</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spi_up_tail_align</span><span class="p">,</span> <span class="s">&quot;SPI uplink tail alignment.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">spi_down_head_align</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spi_down_head_align</span><span class="p">,</span> <span class="s">&quot;SPI downlink head alignment.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">spi_down_tail_align</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spi_down_tail_align</span><span class="p">,</span> <span class="s">&quot;SPI downlink tail alignment.&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ARM</span>
<span class="cp">#define BYTE_HEX_FMT &quot;%02X&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define BYTE_HEX_FMT &quot;%02hhX&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#define SPI_MAX_PAYLOAD_SIZE 4096</span>
<span class="cm">/*</span>
<span class="cm"> * Threshold values for the SPI packet queue. Flowcontrol will be asserted</span>
<span class="cm"> * when the number of packets exceeds HIGH_WATER_MARK. It will not be</span>
<span class="cm"> * deasserted before the number of packets drops below LOW_WATER_MARK.</span>
<span class="cm"> */</span>
<span class="cp">#define LOW_WATER_MARK   100</span>
<span class="cp">#define HIGH_WATER_MARK  (LOW_WATER_MARK*5)</span>

<span class="cp">#ifdef CONFIG_UML</span>

<span class="cm">/*</span>
<span class="cm"> * We sometimes use UML for debugging, but it cannot handle</span>
<span class="cm"> * dma_alloc_coherent so we have to wrap it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dma_alloc</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SPI_DMA_BUF_LEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dma_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cpu_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dma_alloc</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">SPI_DMA_BUF_LEN</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dma_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">SPI_DMA_BUF_LEN</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_UML */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>

<span class="cp">#define DEBUGFS_BUF_SIZE	4096</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dbgfs_root</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">driver_debugfs_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbgfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">driver_debugfs_remove</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dbgfs_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dev_debugfs_rem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_frame</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_state</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dbgfs_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Print out debug information. */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;CAIF SPI debug information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span> <span class="n">FLAVOR</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;STATE: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbg_state</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Previous CMD: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Current CMD: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Previous TX len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">tx_ppck_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Previous RX len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">rx_ppck_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Current TX len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">tx_cpck_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Current RX len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">rx_cpck_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Next TX len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">tx_npck_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Next RX len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">rx_npck_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">DEBUGFS_BUF_SIZE</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">DEBUGFS_BUF_SIZE</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">print_frame</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">frm</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cut</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
					<span class="s">&quot;[0x&quot;</span> <span class="n">BYTE_HEX_FMT</span> <span class="s">&quot;]&quot;</span><span class="p">,</span>
					<span class="n">frm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">cut</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cut</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Fast forward. */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">cut</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
					<span class="s">&quot;--- %u bytes skipped ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">count</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dbgfs_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">;</span>

	<span class="n">cfspi</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Print out debug information. */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Current frame:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Tx data (Len: %d):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">tx_cpck_len</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">print_frame</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			   <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">tx_cpck_len</span> <span class="o">+</span> <span class="n">SPI_CMD_SZ</span><span class="p">),</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			<span class="s">&quot;Rx data (Len: %d):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">rx_cpck_len</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">print_frame</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="p">(</span><span class="n">DEBUGFS_BUF_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">),</span>
			   <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_rx</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">rx_cpck_len</span> <span class="o">+</span> <span class="n">SPI_CMD_SZ</span><span class="p">),</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dbgfs_state_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dbgfs_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dbgfs_frame_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dbgfs_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dev_debugfs_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dbgfs_root</span><span class="p">);</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_state</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
						 <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_dir</span><span class="p">,</span> <span class="n">cfspi</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">dbgfs_state_fops</span><span class="p">);</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_frame</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;frame&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
						 <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbgfs_dir</span><span class="p">,</span> <span class="n">cfspi</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">dbgfs_frame_fops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cfspi_dbg_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dbg_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">driver_debugfs_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">driver_debugfs_remove</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dev_debugfs_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dev_debugfs_rem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cfspi_dbg_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cfspi_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">cfspi_list_lock</span><span class="p">;</span>

<span class="cm">/* SPI uplink head alignment. */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_up_head_align</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi_up_head_align</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">up_head_align</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_up_head_align</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* SPI uplink tail alignment. */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_up_tail_align</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi_up_tail_align</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">up_tail_align</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_up_tail_align</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* SPI downlink head alignment. */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_down_head_align</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi_down_head_align</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">down_head_align</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_down_head_align</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* SPI downlink tail alignment. */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_down_tail_align</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi_down_tail_align</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">down_tail_align</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_down_tail_align</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* SPI frame alignment. */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_frame_align</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi_frm_align</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">frame_align</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_frame_align</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cfspi_xmitfrm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">caif_assert</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave_talked</span><span class="p">)</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave_talked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">caif_payload_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">spad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">epad</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">chead</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Calculate length of frame including SPI padding.</span>
<span class="cm">		 * The payload position is found in the control buffer.</span>
<span class="cm">		 */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">caif_payload_info</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute head offset i.e. number of bytes to add to</span>
<span class="cm">		 * get the start of the payload aligned.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spi_up_head_align</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spad</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">PAD_POW2</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">spi_up_head_align</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">spad</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dst</span> <span class="o">+=</span> <span class="n">spad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy in CAIF frame. */</span>
		<span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute tail offset i.e. number of bytes to add to</span>
<span class="cm">		 * get the complete CAIF frame aligned.</span>
<span class="cm">		 */</span>
		<span class="n">epad</span> <span class="o">=</span> <span class="n">PAD_POW2</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">spad</span><span class="p">),</span> <span class="n">spi_up_tail_align</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">epad</span><span class="p">;</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">dst</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dst</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cfspi_xmitlen</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frm_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decommit previously committed frames.</span>
<span class="cm">	 * skb_queue_splice_tail(&amp;cfspi-&gt;chead,&amp;cfspi-&gt;qhead)</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">chead</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">chead</span><span class="p">);</span>
		<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">caif_payload_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">spad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">epad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Calculate length of frame including SPI padding.</span>
<span class="cm">		 * The payload position is found in the control buffer.</span>
<span class="cm">		 */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">caif_payload_info</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute head offset i.e. number of bytes to add to</span>
<span class="cm">		 * get the start of the payload aligned.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spi_up_head_align</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">spad</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">PAD_POW2</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">spi_up_head_align</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute tail offset i.e. number of bytes to add to</span>
<span class="cm">		 * get the complete CAIF frame aligned.</span>
<span class="cm">		 */</span>
		<span class="n">epad</span> <span class="o">=</span> <span class="n">PAD_POW2</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">spad</span><span class="p">),</span> <span class="n">spi_up_tail_align</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">spad</span> <span class="o">+</span> <span class="n">epad</span> <span class="o">+</span> <span class="n">frm_len</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CAIF_MAX_SPI_FRAME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">chead</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">pkts</span><span class="o">++</span><span class="p">;</span>
			<span class="n">frm_len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">spad</span> <span class="o">+</span> <span class="n">epad</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Put back packet. */</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pkts</span> <span class="o">&lt;=</span> <span class="n">CAIF_MAX_SPI_PKTS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send flow on if previously sent flow off</span>
<span class="cm">	 * and now go below the low water mark</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">flow_off_sent</span> <span class="o">&amp;&amp;</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">.</span><span class="n">qlen</span> <span class="o">&lt;</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qd_low_mark</span> <span class="o">&amp;&amp;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">flow_off_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">frm_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cfspi_ss_cb</span><span class="p">(</span><span class="n">bool</span> <span class="n">assert</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfspi_ifc</span> <span class="o">*</span><span class="n">ifc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="p">)</span><span class="n">ifc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The slave device is the master on the link. Interrupts before the</span>
<span class="cm">	 * slave has transmitted are considered spurious.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave_talked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CFSPI: Spurious SS interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">SPI_SS_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">SPI_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">SPI_SS_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Wake up the xfer thread. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assert</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cfspi_xfer_done_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi_ifc</span> <span class="o">*</span><span class="n">ifc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="p">)</span><span class="n">ifc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Transfer done, complete work queue */</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfspi_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cfspi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">SPI_XFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Wake up xfer thread. */</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Send flow off if number of bytes is above high water mark */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">flow_off_sent</span> <span class="o">&amp;&amp;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">.</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qd_high_mark</span> <span class="o">&amp;&amp;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">flow_off_sent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cfspi_rxfrm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">caif_assert</span><span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">spad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">epad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute head offset i.e. number of bytes added to</span>
<span class="cm">		 * get the start of the payload aligned.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spi_down_head_align</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spad</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
			<span class="n">src</span> <span class="o">+=</span> <span class="n">spad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read length of CAIF frame (little endian). */</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
		<span class="n">pkt_len</span> <span class="o">|=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">;</span>
		<span class="n">pkt_len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Add FCS fields. */</span>

		<span class="cm">/* Get a suitable caif packet and copy in data. */</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">caif_assert</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">dst</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_CAIF</span><span class="p">);</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Push received packet up the stack.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi_loop</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">cfspi_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute tail offset i.e. number of bytes added to</span>
<span class="cm">		 * get the complete CAIF frame aligned.</span>
<span class="cm">		 */</span>
		<span class="n">epad</span> <span class="o">=</span> <span class="n">PAD_POW2</span><span class="p">((</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="n">spad</span><span class="p">),</span> <span class="n">spi_down_tail_align</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">epad</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">src</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">src</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfspi_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfspi_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfspi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Set flow info. */</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">flow_off_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qd_low_mark</span> <span class="o">=</span> <span class="n">LOW_WATER_MARK</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qd_high_mark</span> <span class="o">=</span> <span class="n">HIGH_WATER_MARK</span><span class="p">;</span>

	<span class="cm">/* Set slave info. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cfspi_sspi&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave_talked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">slave_talked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate DMA buffers. */</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">pa_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dma_alloc_tx_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_rx</span> <span class="o">=</span> <span class="n">dma_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">pa_rx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dma_alloc_rx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the work queue. */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">cfspi_xfer</span><span class="p">);</span>

	<span class="cm">/* Initialize spin locks. */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Initialize flow control state. */</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">flow_stop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Initialize wait queue. */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* Create work thread. */</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CFSPI: failed to create work queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_create_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize work queue. */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">comp</span><span class="p">);</span>

	<span class="cm">/* Create debugfs entries. */</span>
	<span class="n">dev_debugfs_add</span><span class="p">(</span><span class="n">cfspi</span><span class="p">);</span>

	<span class="cm">/* Set up the ifc. */</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ifc</span><span class="p">.</span><span class="n">ss_cb</span> <span class="o">=</span> <span class="n">cfspi_ss_cb</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ifc</span><span class="p">.</span><span class="n">xfer_done_cb</span> <span class="o">=</span> <span class="n">cfspi_xfer_done_cb</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ifc</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">cfspi</span><span class="p">;</span>

	<span class="cm">/* Add CAIF SPI device to list. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_list_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_list_lock</span><span class="p">);</span>

	<span class="cm">/* Schedule the work queue. */</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_create_wq:</span>
	<span class="n">dma_free</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_rx</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">pa_rx</span><span class="p">);</span>
 <span class="nl">err_dma_alloc_rx:</span>
	<span class="n">dma_free</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">pa_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
 <span class="nl">err_dma_alloc_tx_0:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cfspi_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Remove from list. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_list_lock</span><span class="p">);</span>

	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Free DMA buffers. */</span>
	<span class="n">dma_free</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_rx</span><span class="p">,</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">pa_rx</span><span class="p">);</span>
	<span class="n">dma_free</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">va_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">.</span><span class="n">pa_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SPI_TERMINATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="cm">/* Destroy debugfs directory and files. */</span>
	<span class="n">dev_debugfs_rem</span><span class="p">(</span><span class="n">cfspi</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">cfspi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">cfspi_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">cfspi_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_init</span> <span class="o">=</span> <span class="n">cfspi_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_uninit</span> <span class="o">=</span> <span class="n">cfspi_uninit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">cfspi_xmit</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cfspi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfspi_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_CAIF</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_NOARP</span> <span class="o">|</span> <span class="n">IFF_POINTOPOINT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">SPI_MAX_PAYLOAD_SIZE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">free_netdev</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">chead</span><span class="p">);</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">link_select</span> <span class="o">=</span> <span class="n">CAIF_LINK_HIGH_BANDW</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">use_frag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">use_stx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">cfdev</span><span class="p">.</span><span class="n">use_fcs</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cfspi_spi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfspi_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cfspi_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfspi</span><span class="p">),</span>
			<span class="s">&quot;cfspi%d&quot;</span><span class="p">,</span> <span class="n">cfspi_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">cfspi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* Assign the SPI device. */</span>
	<span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* Assign the device ifc to this SPI interface. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ifc</span><span class="p">;</span>

	<span class="cm">/* Register network device. */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CFSPI: Reg. error: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_net_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

 <span class="nl">err_net_reg:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cfspi_spi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Everything is done in cfspi_uninit(). */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cfspi_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfspi</span> <span class="o">*</span><span class="n">cfspi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfspi_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfspi</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfspi</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">cfspi</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Destroy sysfs files. */</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_up_head_align</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_up_tail_align</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_down_head_align</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_down_tail_align</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_frame_align</span><span class="p">);</span>
	<span class="cm">/* Unregister platform driver. */</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">);</span>
	<span class="cm">/* Destroy debugfs root directory. */</span>
	<span class="n">driver_debugfs_remove</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cfspi_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* Initialize spin lock. */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_list_lock</span><span class="p">);</span>

	<span class="cm">/* Register platform driver. */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not register platform SPI driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dev_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create sysfs files. */</span>
	<span class="n">result</span> <span class="o">=</span>
	    <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">driver_attr_up_head_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sysfs creation failed 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_create_up_head_align</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span>
	    <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">driver_attr_up_tail_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sysfs creation failed 2.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_create_up_tail_align</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span>
	    <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">driver_attr_down_head_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sysfs creation failed 3.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_create_down_head_align</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span>
	    <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">driver_attr_down_tail_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sysfs creation failed 4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_create_down_tail_align</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span>
	    <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">driver_attr_frame_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sysfs creation failed 5.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_create_frame_align</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">driver_debugfs_create</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

 <span class="nl">err_create_frame_align:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_down_tail_align</span><span class="p">);</span>
 <span class="nl">err_create_down_tail_align:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_down_head_align</span><span class="p">);</span>
 <span class="nl">err_create_down_head_align:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_up_tail_align</span><span class="p">);</span>
 <span class="nl">err_create_up_tail_align:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfspi_spi_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_up_head_align</span><span class="p">);</span>
 <span class="nl">err_create_up_head_align:</span>
 <span class="nl">err_dev_register:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cfspi_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cfspi_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
