<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › usb › pegasus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pegasus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) 1999-2005 Petko Manolov (petkan@users.sourceforge.net)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *	ChangeLog:</span>
<span class="cm"> *		....	Most of the time spent on reading sources &amp; docs.</span>
<span class="cm"> *		v0.2.x	First official release for the Linux kernel.</span>
<span class="cm"> *		v0.3.0	Beutified and structured, some bugs fixed.</span>
<span class="cm"> *		v0.3.x	URBifying bulk requests and bugfixing. First relatively</span>
<span class="cm"> *			stable release. Still can touch device&#39;s registers only</span>
<span class="cm"> *			from top-halves.</span>
<span class="cm"> *		v0.4.0	Control messages remained unurbified are now URBs.</span>
<span class="cm"> *			Now we can touch the HW at any time.</span>
<span class="cm"> *		v0.4.9	Control urbs again use process context to wait. Argh...</span>
<span class="cm"> *			Some long standing bugs (enable_net_traffic) fixed.</span>
<span class="cm"> *			Also nasty trick about resubmiting control urb from</span>
<span class="cm"> *			interrupt context used. Please let me know how it</span>
<span class="cm"> *			behaves. Pegasus II support added since this version.</span>
<span class="cm"> *			TODO: suppressing HCD warnings spewage on disconnect.</span>
<span class="cm"> *		v0.4.13	Ethernet address is now set at probe(), not at open()</span>
<span class="cm"> *			time as this seems to break dhcpd.</span>
<span class="cm"> *		v0.5.0	branch to 2.5.x kernels</span>
<span class="cm"> *		v0.5.1	ethtool support added</span>
<span class="cm"> *		v0.5.5	rx socket buffers are in a pool and the their allocation</span>
<span class="cm"> *			is out of the interrupt routine.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &quot;pegasus.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;v0.6.14 (2006/09/27)&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Petko Manolov &lt;petkan@users.sourceforge.net&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Pegasus/Pegasus II USB Ethernet driver&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;pegasus&quot;</span><span class="p">;</span>

<span class="cp">#undef	PEGASUS_WRITE_EEPROM</span>
<span class="cp">#define	BMSR_MEDIA	(BMSR_10HALF | BMSR_10FULL | BMSR_100HALF | \</span>
<span class="cp">			BMSR_100FULL | BMSR_ANEGCAPABLE)</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">loopback</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">mii_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devid</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_eth_dev</span> <span class="n">usb_dev_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define	PEGASUS_DEV(pn, vid, pid, flags)	\</span>
<span class="cp">	{.name = pn, .vendor = vid, .device = pid, .private = flags},</span>
<span class="cp">#define PEGASUS_DEV_CLASS(pn, vid, pid, dclass, flags) \</span>
<span class="cp">	PEGASUS_DEV(pn, vid, pid, flags)</span>
<span class="cp">#include &quot;pegasus.h&quot;</span>
<span class="cp">#undef	PEGASUS_DEV</span>
<span class="cp">#undef	PEGASUS_DEV_CLASS</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">pegasus_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define	PEGASUS_DEV(pn, vid, pid, flags) \</span>
<span class="cp">	{.match_flags = USB_DEVICE_ID_MATCH_DEVICE, .idVendor = vid, .idProduct = pid},</span>
<span class="cm">/*</span>
<span class="cm"> * The Belkin F8T012xx1 bluetooth adaptor has the same vendor and product</span>
<span class="cm"> * IDs as the Belkin F5D5050, so we need to teach the pegasus driver to</span>
<span class="cm"> * ignore adaptors belonging to the &quot;Wireless&quot; class 0xE0. For this one</span>
<span class="cm"> * case anyway, seeing as the pegasus is for &quot;Wired&quot; adaptors.</span>
<span class="cm"> */</span>
<span class="cp">#define PEGASUS_DEV_CLASS(pn, vid, pid, dclass, flags) \</span>
<span class="cp">	{.match_flags = (USB_DEVICE_ID_MATCH_DEVICE | USB_DEVICE_ID_MATCH_DEV_CLASS), \</span>
<span class="cp">	.idVendor = vid, .idProduct = pid, .bDeviceClass = dclass},</span>
<span class="cp">#include &quot;pegasus.h&quot;</span>
<span class="cp">#undef	PEGASUS_DEV</span>
<span class="cp">#undef	PEGASUS_DEV_CLASS</span>
	<span class="p">{},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">loopback</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mii_mode</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">loopback</span><span class="p">,</span> <span class="s">&quot;Enable MAC loopback mode (bit 0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mii_mode</span><span class="p">,</span> <span class="s">&quot;Enable HomePNA mode (bit 0),default=MII mode = 0&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="s">&quot;The format is: &#39;DEV_name:VendorID:DeviceID:Flags&#39;&quot;</span><span class="p">);</span>

<span class="cm">/* use ethtool to change the level for any given device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msg_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msg_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msg_level</span><span class="p">,</span> <span class="s">&quot;Override default message level&quot;</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">pegasus_ids</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">pegasus_netdev_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">update_eth_regs_async</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="p">);</span>
<span class="cm">/* Aargh!!! I _really_ hate such tweaks */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctrl_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_REGS_CHANGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ETH_REGS_CHANGE</span><span class="p">;</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_REGS_CHANGED</span><span class="p">;</span>
			<span class="n">update_eth_regs_async</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
				  <span class="s">&quot;%s, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ETH_REGS_CHANGED</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_registers</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">size</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			   <span class="s">&quot;out of memory in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_REGS_CHANGED</span><span class="p">)</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">PEGASUS_REQT_READ</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">PEGASUS_REQ_GET_REGS</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">indx</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			     <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">,</span>
			     <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ctrl_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>

	<span class="cm">/* using ATOMIC, we&#39;d never wake up if we slept */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
				  <span class="s">&quot;%s, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">schedule</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_registers</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">size</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			   <span class="s">&quot;out of memory in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_REGS_CHANGED</span><span class="p">)</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">PEGASUS_REQT_WRITE</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">PEGASUS_REQ_SET_REGS</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">indx</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">,</span>
			     <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ctrl_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;%s, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">schedule</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_register</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">indx</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			   <span class="s">&quot;out of memory in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_REGS_CHANGED</span><span class="p">)</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">PEGASUS_REQT_WRITE</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">PEGASUS_REQ_SET_REG</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">indx</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">,</span>
			     <span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctrl_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
				  <span class="s">&quot;%s, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">schedule</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_eth_regs_async</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">PEGASUS_REQT_WRITE</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">PEGASUS_REQ_SET_REGS</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EthCtrl0</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">,</span>
			     <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ctrl_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;%s, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns 0 on success, error on failure */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_mii_word</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">phy</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">indx</span><span class="p">,</span> <span class="n">__u16</span> <span class="o">*</span><span class="n">regd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indx</span> <span class="p">};</span>
	<span class="n">__le16</span> <span class="n">regdi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyCtrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyCtrl</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span> <span class="o">|</span> <span class="n">PHY_READ</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REG_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyCtrl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PHY_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">REG_TIMEOUT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regdi</span><span class="p">);</span>
	<span class="o">*</span><span class="n">regd</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">regdi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">read_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_mii_word</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">phy</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">indx</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">regd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indx</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">regd</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">regd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyCtrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyCtrl</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span> <span class="o">|</span> <span class="n">PHY_WRITE</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REG_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">PhyCtrl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PHY_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">REG_TIMEOUT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_eprom_word</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">__u16</span> <span class="o">*</span><span class="n">retdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">retdatai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromCtrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromOffset</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromCtrl</span><span class="p">,</span> <span class="n">EPROM_READ</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REG_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromCtrl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EPROM_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">REG_TIMEOUT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromData</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retdatai</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retdata</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">retdatai</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	PEGASUS_WRITE_EEPROM</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_eprom_write</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl2</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">EPROM_WR_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">disable_eprom_write</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromCtrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl2</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EPROM_WR_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_eprom_word</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EPROM_WRITE</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">le_data</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromOffset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">enable_eprom_write</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromOffset</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromData</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">le_data</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromCtrl</span><span class="p">,</span> <span class="n">EPROM_WRITE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REG_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EpromCtrl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EPROM_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disable_eprom_write</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">REG_TIMEOUT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* PEGASUS_WRITE_EEPROM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_node_id</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">w16</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_eprom_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w16</span><span class="p">);</span>
		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">id</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">w16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ethernet_addr</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">node_id</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">PEGASUS_II</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="n">node_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">get_node_id</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
		<span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="n">node_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">node_id</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">reset_mac</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REG_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loopback</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mii_mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HAS_HOME_PNA</span><span class="p">))</span>
				<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Gpio1</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Gpio1</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
			<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Gpio0</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>
			<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Gpio0</span><span class="p">,</span> <span class="n">DEFAULT_GPIO_SET</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">REG_TIMEOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_dev_id</span><span class="p">[</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">VENDOR_LINKSYS</span> <span class="o">||</span>
	    <span class="n">usb_dev_id</span><span class="p">[</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">VENDOR_DLINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Gpio0</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
		<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Gpio0</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_dev_id</span><span class="p">[</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">VENDOR_ELCON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u16</span> <span class="n">auxmode</span><span class="p">;</span>
		<span class="n">read_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auxmode</span><span class="p">);</span>
		<span class="n">write_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">auxmode</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_net_traffic</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">linkpart</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">read_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkpart</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc9</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linkpart</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_100FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span><span class="p">))</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* set full duplex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linkpart</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_100FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_100HALF</span><span class="p">))</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* set 100 Mbps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mii_mode</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">loopback</span> <span class="o">?</span> <span class="mh">0x09</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_dev_id</span><span class="p">[</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">VENDOR_LINKSYS</span> <span class="o">||</span>
	    <span class="n">usb_dev_id</span><span class="p">[</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">VENDOR_LINKSYS2</span> <span class="o">||</span>
	    <span class="n">usb_dev_id</span><span class="p">[</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">VENDOR_DLINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">auxmode</span><span class="p">;</span>
		<span class="n">read_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auxmode</span><span class="p">);</span>
		<span class="n">write_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">auxmode</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_skb_pool</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SKBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">PEGASUS_MTU</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 ** we give up if the allocation fail. the tasklet will be</span>
<span class="cm">		 ** rescheduled again anyway...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_skb_pool</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SKBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">pull_skb</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span> <span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SKBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_bulk_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">pkt_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;reset MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PEGASUS_RX_BUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:		<span class="cm">/* stall, or disconnect from TT */</span>
		<span class="cm">/* FIXME schedule work to clear the halt */</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;no rx stall recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;rx unlink, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;RX status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">goon</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">goon</span><span class="p">;</span>

	<span class="n">rx_status</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;RX packet error %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span>	<span class="cm">/* long or runt	*/</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>	<span class="cm">/* extra bits	*/</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">goon</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="mh">0x8513</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="n">pkt_len</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">pkt_len</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">4</span><span class="p">];</span>
		<span class="n">pkt_len</span> <span class="o">&amp;=</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">pkt_len</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the packet is unreasonably long, quietly drop it rather than</span>
<span class="cm">	 * kernel panicing by calling skb_put.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="n">PEGASUS_MTU</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">goon</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * at this point we are sure pegasus-&gt;rx_skb != NULL</span>
<span class="cm">	 * so we go ahead and pass up the packet.</span>
<span class="cm">	 */</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PEGASUS_UNPLUG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool_lock</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">pull_skb</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">tl_sched</span><span class="p">;</span>
<span class="nl">goon:</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			  <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PEGASUS_MTU</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
			  <span class="n">read_bulk_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>
	<span class="n">rx_status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PEGASUS_RX_URB_FAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">tl_sched</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PEGASUS_RX_URB_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">tl_sched:</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_tl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_fixup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pegasus</span> <span class="o">=</span> <span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PEGASUS_UNPLUG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fill_skb_pool</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PEGASUS_RX_URB_FAIL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">pull_skb</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;low on memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_tl</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			  <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PEGASUS_MTU</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
			  <span class="n">read_bulk_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>
<span class="nl">try_again:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PEGASUS_RX_URB_FAIL</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_tl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PEGASUS_RX_URB_FAIL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_bulk_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
		<span class="cm">/* FIXME schedule_work() to clear the tx halt */</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;no tx stall recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;tx unlink, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;TX status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="cm">/* FALL THROUGH */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intr_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">net</span> <span class="o">=</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:	<span class="cm">/* unlink */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* some Pegasus-I products report LOTS of data</span>
<span class="cm">		 * toggle errors... avoid log spamming</span>
<span class="cm">		 */</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;intr status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

		<span class="cm">/* byte 0 == tx_status1, reg 2B */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_UNDERRUN</span><span class="o">|</span><span class="n">EXCESSIVE_COL</span>
					<span class="o">|</span><span class="n">LATE_COL</span><span class="o">|</span><span class="n">JABBER_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TX_UNDERRUN</span><span class="p">)</span>
				<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EXCESSIVE_COL</span> <span class="o">|</span> <span class="n">JABBER_TIMEOUT</span><span class="p">))</span>
				<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LATE_COL</span><span class="p">)</span>
				<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* d[5].LINK_STATUS lies on some adapters.</span>
<span class="cm">		 * d[0].NO_CARRIER kicks in only with failed TX.</span>
<span class="cm">		 * ... so monitoring with MII may be safest.</span>
<span class="cm">		 */</span>

		<span class="cm">/* bytes 3-4 == rx_lostpkt, reg 2E/2F */</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;can&#39;t resubmit interrupt urb, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pegasus_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;tx timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">pegasus_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">l16</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">l16</span><span class="p">);</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			  <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			  <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			  <span class="n">write_bulk_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;fail tx, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:		<span class="cm">/* stall, or disconnect from TT */</span>
			<span class="cm">/* cleanup should already have been scheduled */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:		<span class="cm">/* disconnect() upcoming */</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EPERM</span>:
			<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">pegasus_netdev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">disable_net_traffic</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthCtrl0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_interrupt_interval</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">interval</span><span class="p">;</span>

	<span class="n">read_eprom_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">interval</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
				   <span class="s">&quot;intr interval changed from %ums to %ums</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">interval</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">interval</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">interval</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#ifdef PEGASUS_WRITE_EEPROM</span>
			<span class="n">write_eprom_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_all_urbs</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unlink_all_urbs</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_urbs</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">pull_skb</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 ** Note: no point to free the pool.  it is empty :-)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">set_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">EthID</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			  <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PEGASUS_MTU</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
			  <span class="n">read_bulk_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;failed rx_urb, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
			 <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_buff</span><span class="p">),</span>
			 <span class="n">intr_callback</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_interval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;failed intr_urb, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">enable_net_traffic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;can&#39;t enable_net_traffic() - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">);</span>
		<span class="n">free_skb_pool</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_carrier</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PEGASUS_UNPLUG</span><span class="p">))</span>
		<span class="n">disable_net_traffic</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_tl</span><span class="p">);</span>
	<span class="n">unlink_all_urbs</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pegasus_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* also handles three patterns of some kind in hardware */</span>
<span class="cp">#define	WOL_SUPPORTED	(WAKE_MAGIC|WAKE_PHY)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pegasus_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span>	<span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span> <span class="o">|</span> <span class="n">WAKE_PHY</span><span class="p">;</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pegasus_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span>	<span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>		<span class="n">reg78</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WOL_SUPPORTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">reg78</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">reg78</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="cm">/* FIXME this 0x10 bit still needs to get set in the chip... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">)</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">WakeupControl</span><span class="p">,</span> <span class="n">reg78</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pegasus_reset_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="n">wol</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">wol</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pegasus_set_wol</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pegasus_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">;</span>

	<span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pegasus_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pegasus_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pegasus_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pegasus_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">pegasus_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">pegasus_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">pegasus_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span> <span class="o">=</span> <span class="n">pegasus_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">pegasus_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span> <span class="o">=</span> <span class="n">pegasus_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span> <span class="o">=</span> <span class="n">pegasus_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span> <span class="o">=</span> <span class="n">pegasus_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span> <span class="o">=</span> <span class="n">pegasus_set_wol</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">;</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCDEVPRIVATE</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCDEVPRIVATE</span> <span class="o">+</span> <span class="mi">1</span>:
		<span class="n">read_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCDEVPRIVATE</span> <span class="o">+</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">write_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pegasus_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">[</span><span class="n">EthCtrl2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RX_PROMISCUOUS</span><span class="p">;</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;Promiscuous mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">[</span><span class="n">EthCtrl0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RX_MULTICAST</span><span class="p">;</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">[</span><span class="n">EthCtrl2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_PROMISCUOUS</span><span class="p">;</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s">&quot;set allmulti</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">[</span><span class="n">EthCtrl0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_MULTICAST</span><span class="p">;</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">eth_regs</span><span class="p">[</span><span class="n">EthCtrl2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_PROMISCUOUS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_REGS_CHANGE</span><span class="p">;</span>
	<span class="n">ctrl_callback</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u8</span> <span class="nf">mii_phy_probe</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_mii_word</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">BMSR_MEDIA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setup_pegasus_II</span><span class="p">(</span><span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0xa5</span><span class="p">;</span>

	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Reg1d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Reg7b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HAS_HOME_PNA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mii_mode</span><span class="p">)</span>
		<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Reg7b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Reg7b</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">get_registers</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xa5</span><span class="p">)</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="mh">0x8513</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HAS_HOME_PNA</span> <span class="o">&amp;&amp;</span> <span class="n">mii_mode</span><span class="p">)</span>
		<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Reg81</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_register</span><span class="p">(</span><span class="n">pegasus</span><span class="p">,</span> <span class="n">Reg81</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">pegasus_count</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">pegasus_workqueue</span><span class="p">;</span>
<span class="cp">#define CARRIER_CHECK_DELAY (2 * HZ)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">pegasus_t</span><span class="p">,</span> <span class="n">carrier_check</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">set_carrier</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PEGASUS_UNPLUG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">pegasus_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">carrier_check</span><span class="p">,</span>
			<span class="n">CARRIER_CHECK_DELAY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_blacklisted</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device_descriptor</span> <span class="o">*</span><span class="n">udd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">;</span>

	<span class="cm">/* Special quirk to keep the driver from handling the Belkin Bluetooth</span>
<span class="cm">	 * dongle which happens to have the same ID.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">udd</span><span class="o">-&gt;</span><span class="n">idVendor</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">VENDOR_BELKIN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">udd</span><span class="o">-&gt;</span><span class="n">idProduct</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0121</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">udd</span><span class="o">-&gt;</span><span class="n">bDeviceClass</span> <span class="o">==</span> <span class="n">USB_CLASS_WIRELESS_CONTROLLER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">udd</span><span class="o">-&gt;</span><span class="n">bDeviceProtocol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* we rely on probe() and remove() being serialized so we</span>
<span class="cm"> * don&#39;t need extra locking on pegasus_count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pegasus_dec_workqueue</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pegasus_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">pegasus_workqueue</span><span class="p">);</span>
		<span class="n">pegasus_workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="n">pegasus_t</span> <span class="o">*</span><span class="n">pegasus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_index</span> <span class="o">=</span> <span class="n">id</span> <span class="o">-</span> <span class="n">pegasus_ids</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus_blacklisted</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pegasus_workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;pegasus&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus_workqueue</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pegasus_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pegasus</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pegasus</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">dev_index</span> <span class="o">=</span> <span class="n">dev_index</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_urbs</span><span class="p">(</span><span class="n">pegasus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;urbs&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_tl</span><span class="p">,</span> <span class="n">rx_fixup</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pegasus</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">carrier_check</span><span class="p">,</span> <span class="n">check_carrier</span><span class="p">);</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>


	<span class="n">net</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">PEGASUS_TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pegasus_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_pool_lock</span><span class="p">);</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">msg_level</span><span class="p">,</span> <span class="n">NETIF_MSG_DRV</span>
				<span class="o">|</span> <span class="n">NETIF_MSG_PROBE</span> <span class="o">|</span> <span class="n">NETIF_MSG_LINK</span><span class="p">);</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">usb_dev_id</span><span class="p">[</span><span class="n">dev_index</span><span class="p">].</span><span class="n">private</span><span class="p">;</span>
	<span class="n">get_interrupt_interval</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_mac</span><span class="p">(</span><span class="n">pegasus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t reset MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_ethernet_addr</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="n">fill_skb_pool</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">PEGASUS_II</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup Pegasus II specific registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">setup_pegasus_II</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">mii_phy_probe</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t locate MII phy, using default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">pegasus</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pegasus_reset_wol</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">pegasus_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">carrier_check</span><span class="p">,</span>
				<span class="n">CARRIER_CHECK_DELAY</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s, %s, %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">net</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">usb_dev_id</span><span class="p">[</span><span class="n">dev_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out3:</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_skb_pool</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">free_all_urbs</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pegasus_dec_workqueue</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pegasus_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pegasus</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegasus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistering non-bound device?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PEGASUS_UNPLUG</span><span class="p">;</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">carrier_check</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>
	<span class="n">unlink_all_urbs</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="n">free_all_urbs</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="n">free_skb_pool</span><span class="p">(</span><span class="n">pegasus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">pegasus_dec_workqueue</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pegasus</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">carrier_check</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pegasus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pegasus</span> <span class="o">*</span><span class="n">pegasus</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">read_bulk_callback</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>

		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">intr_callback</span><span class="p">(</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">intr_urb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">pegasus_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pegasus</span><span class="o">-&gt;</span><span class="n">carrier_check</span><span class="p">,</span>
				<span class="n">CARRIER_CHECK_DELAY</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">pegasus_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span>			<span class="n">pegasus_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span>			<span class="n">pegasus_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> <span class="o">=</span>			<span class="n">pegasus_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span>		<span class="n">pegasus_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span> <span class="o">=</span>		<span class="n">pegasus_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> <span class="o">=</span>		<span class="n">pegasus_netdev_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span>		<span class="n">pegasus_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span>		<span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span>		<span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span> <span class="o">=</span>		<span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">pegasus_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pegasus_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">pegasus_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pegasus_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pegasus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pegasus_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">parse_id</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vendor_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="cm">/* name now points to a null terminated string*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">vendor_id</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">device_id</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: new device %s, vendor ID 0x%04x, device ID 0x%04x, flags: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">driver_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">vendor_id</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">&gt;</span> <span class="mh">0x10000</span> <span class="o">||</span> <span class="n">vendor_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">&gt;</span> <span class="mh">0x10000</span> <span class="o">||</span> <span class="n">device_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">usb_dev_id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
	<span class="n">usb_dev_id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">usb_dev_id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">usb_dev_id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">usb_dev_id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">pegasus_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">;</span>
	<span class="n">pegasus_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">pegasus_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pegasus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %s, &quot;</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span><span class="p">)</span>
		<span class="n">parse_id</span><span class="p">(</span><span class="n">devid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pegasus_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pegasus_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pegasus_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pegasus_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
