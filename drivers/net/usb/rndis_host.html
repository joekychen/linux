<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › usb › rndis_host.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rndis_host.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Host Side support for RNDIS Networking Links</span>
<span class="cm"> * Copyright (C) 2005 by David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/cdc.h&gt;</span>
<span class="cp">#include &lt;linux/usb/usbnet.h&gt;</span>
<span class="cp">#include &lt;linux/usb/rndis_host.h&gt;</span>


<span class="cm">/*</span>
<span class="cm"> * RNDIS is NDIS remoted over USB.  It&#39;s a MSFT variant of CDC ACM ... of</span>
<span class="cm"> * course ACM was intended for modems, not Ethernet links!  USB&#39;s standard</span>
<span class="cm"> * for Ethernet links is &quot;CDC Ethernet&quot;, which is significantly simpler.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE that Microsoft&#39;s &quot;RNDIS 1.0&quot; specification is incomplete.  Issues</span>
<span class="cm"> * include:</span>
<span class="cm"> *    - Power management in particular relies on information that&#39;s scattered</span>
<span class="cm"> *	through other documentation, and which is incomplete or incorrect even</span>
<span class="cm"> *	there.</span>
<span class="cm"> *    - There are various undocumented protocol requirements, such as the</span>
<span class="cm"> *	need to send unused garbage in control-OUT messages.</span>
<span class="cm"> *    - In some cases, MS-Windows will emit undocumented requests; this</span>
<span class="cm"> *	matters more to peripheral implementations than host ones.</span>
<span class="cm"> *</span>
<span class="cm"> * Moreover there&#39;s a no-open-specs variant of RNDIS called &quot;ActiveSync&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * For these reasons and others, ** USE OF RNDIS IS STRONGLY DISCOURAGED ** in</span>
<span class="cm"> * favor of such non-proprietary alternatives as CDC Ethernet or the newer (and</span>
<span class="cm"> * currently rare) &quot;Ethernet Emulation Model&quot; (EEM).</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * RNDIS notifications from device: command completion; &quot;reverse&quot;</span>
<span class="cm"> * keepalives; etc</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rndis_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;rndis status urb, len %d stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME for keepalives, respond immediately (asynchronously)
if not an RNDIS status, do like cdc_status(dev,urb) does</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rndis_status</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * RNDIS indicate messages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_msg_indicate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rndis_indicate</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">indication</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">indication</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RNDIS_STATUS_MEDIA_CONNECT</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="s">&quot;rndis media connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RNDIS_STATUS_MEDIA_DISCONNECT</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="s">&quot;rndis media disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="s">&quot;rndis indication: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * RPC done RNDIS-style.  Caller guarantees:</span>
<span class="cm"> * - message is properly byteswapped</span>
<span class="cm"> * - there&#39;s no other request pending</span>
<span class="cm"> * - buf can hold up to 1KB response (required by RNDIS spec)</span>
<span class="cm"> * On return, the first few entries are already byteswapped.</span>
<span class="cm"> *</span>
<span class="cm"> * Call context is likely probe(), before interface name is known,</span>
<span class="cm"> * which is why we won&#39;t try to use it in the diagnostics.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rndis_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rndis_msg_hdr</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_state</span>	<span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_notification</span> <span class="n">notification</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">master_ifnum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">partial</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">xid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span>
				<span class="n">status</span><span class="p">;</span>

	<span class="cm">/* REVISIT when this gets called from contexts other than probe() or</span>
<span class="cm">	 * disconnect(): either serialize, or dispatch responses on xid</span>
<span class="cm">	 */</span>

	<span class="n">msg_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">);</span>

	<span class="cm">/* Issue the request; xid is unique, don&#39;t bother byteswapping it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">msg_type</span> <span class="o">!=</span> <span class="n">RNDIS_MSG_HALT</span> <span class="o">&amp;&amp;</span> <span class="n">msg_type</span> <span class="o">!=</span> <span class="n">RNDIS_MSG_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xid</span><span class="p">)</span>
			<span class="n">xid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__le32</span><span class="p">)</span> <span class="n">xid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">master_ifnum</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
		<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">USB_CDC_SEND_ENCAPSULATED_COMMAND</span><span class="p">,</span>
		<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">master_ifnum</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">),</span>
		<span class="n">RNDIS_CONTROL_TIMEOUT_MS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">xid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Some devices don&#39;t respond on the control channel until</span>
<span class="cm">	 * polled on the status channel, so do that first. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">RNDIS_DRIVER_DATA_POLL_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_interrupt_msg</span><span class="p">(</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">notification</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">notification</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">partial</span><span class="p">,</span>
			<span class="n">RNDIS_CONTROL_TIMEOUT_MS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Poll the control channel; the request probably completed immediately */</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">)</span> <span class="o">|</span> <span class="n">RNDIS_MSG_COMPLETION</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">USB_CDC_GET_ENCAPSULATED_RESPONSE</span><span class="p">,</span>
			<span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">master_ifnum</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
			<span class="n">RNDIS_CONTROL_TIMEOUT_MS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">retval</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">msg_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">);</span>
			<span class="n">msg_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">request_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">request_id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">msg_type</span> <span class="o">==</span> <span class="n">rsp</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">request_id</span> <span class="o">==</span> <span class="n">xid</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rsp</span> <span class="o">==</span> <span class="n">RNDIS_MSG_RESET_C</span><span class="p">))</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">RNDIS_STATUS_SUCCESS</span> <span class="o">==</span>
							<span class="n">status</span><span class="p">))</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;rndis reply status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">status</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EL3RST</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;rndis reply id %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">request_id</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>
				<span class="cm">/* then likely retry */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">switch</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">RNDIS_MSG_INDICATE</span>: <span class="cm">/* fault/event */</span>
				<span class="n">rndis_msg_indicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">RNDIS_MSG_KEEPALIVE</span>: <span class="p">{</span> <span class="cm">/* ping */</span>
				<span class="k">struct</span> <span class="n">rndis_keepalive_c</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

				<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_KEEPALIVE_C</span><span class="p">);</span>
				<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
				<span class="n">msg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_STATUS_SUCCESS</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">USB_CDC_SEND_ENCAPSULATED_COMMAND</span><span class="p">,</span>
					<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">master_ifnum</span><span class="p">,</span>
					<span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
					<span class="n">RNDIS_CONTROL_TIMEOUT_MS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;rndis keepalive err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">retval</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;unexpected rndis msg %08x len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">),</span> <span class="n">msg_len</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* device probably issued a protocol stall; ignore */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;rndis response error, code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rndis response timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rndis_command</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * rndis_query:</span>
<span class="cm"> *</span>
<span class="cm"> * Performs a query for @oid along with 0 or more bytes of payload as</span>
<span class="cm"> * specified by @in_len. If @reply_len is not set to -1 then the reply</span>
<span class="cm"> * length is checked against this value, resulting in an error if it</span>
<span class="cm"> * doesn&#39;t match.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Adding a payload exactly or greater than the size of the expected</span>
<span class="cm"> * response payload is an evident requirement MSFT added for ActiveSync.</span>
<span class="cm"> *</span>
<span class="cm"> * The only exception is for OIDs that return a variably sized response,</span>
<span class="cm"> * in which case no payload should be added.  This undocumented (and</span>
<span class="cm"> * nonsensical!) issue was found by sniffing protocol requests from the</span>
<span class="cm"> * ActiveSync 4.1 Windows driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">oid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">in_len</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">**</span><span class="n">reply</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">reply_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_msg_hdr</span>	<span class="o">*</span><span class="n">header</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_query</span>	<span class="o">*</span><span class="n">get</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_query_c</span>	<span class="o">*</span><span class="n">get_c</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">get</span> <span class="o">+</span> <span class="n">in_len</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_QUERY</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">get</span> <span class="o">+</span> <span class="n">in_len</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">oid</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">in_len</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RNDIS_MSG_QUERY(0x%08x) failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">oid</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="mi">8</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">response_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">reply_len</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">!=</span> <span class="o">*</span><span class="n">reply_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">response_error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="o">*</span><span class="n">reply_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">response_error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RNDIS_MSG_QUERY(0x%08x) &quot;</span>
			<span class="s">&quot;invalid response - off %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">oid</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* same as usbnet_netdev_ops but MTU change not allowed */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rndis_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">usbnet_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">usbnet_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">usbnet_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">usbnet_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">generic_rndis_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdc_state</span>	<span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_msg_hdr</span>	<span class="o">*</span><span class="n">header</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_init</span>	<span class="o">*</span><span class="n">init</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_init_c</span>	<span class="o">*</span><span class="n">init_c</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_query</span>	<span class="o">*</span><span class="n">get</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_query_c</span>	<span class="o">*</span><span class="n">get_c</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_set</span>	<span class="o">*</span><span class="n">set</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_set_c</span>	<span class="o">*</span><span class="n">set_c</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_halt</span>	<span class="o">*</span><span class="n">halt</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="n">__le32</span>			<span class="n">phym_unspec</span><span class="p">,</span> <span class="o">*</span><span class="n">phym</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">reply_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="cm">/* we can&#39;t rely on i/o from stack working, or stack allocation */</span>
	<span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">CONTROL_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usbnet_generic_cdc_bind</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_INIT</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* max transfer (in spec) is 0x4000 at full speed, but for</span>
<span class="cm">	 * TX we&#39;ll stick to one Ethernet packet plus RNDIS framing.</span>
<span class="cm">	 * For RX we handle drivers that zero-pad to end-of-packet.</span>
<span class="cm">	 * Don&#39;t let userspace change these settings.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: there still seems to be wierdness here, as if we need</span>
<span class="cm">	 * to do some more things to make sure WinCE targets accept this.</span>
<span class="cm">	 * They default to jumbograms of 8KB or 16KB, which is absurd</span>
<span class="cm">	 * for such low data rates and which is also more than Linux</span>
<span class="cm">	 * can usually expect to allocate for SKB data...</span>
<span class="cm">	 */</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rndis_data_hdr</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;dev-&gt;maxpacket can&#39;t be 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_and_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_urb_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_urb_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">max_transfer_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_urb_size</span><span class="p">);</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rndis_netdev_ops</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* it might not even be an RNDIS device!! */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RNDIS init failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_and_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">init_c</span><span class="o">-&gt;</span><span class="n">max_transfer_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;dev can&#39;t take %u byte packets (max %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">halt_fail_and_release</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;dev can&#39;t take %u byte packets (max %u), &quot;</span>
			 <span class="s">&quot;adjusting MTU to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">net</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">-</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* REVISIT:  peripheral &quot;alignment&quot; request is ignored ... */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;hard mtu %u (%u from dev), rx buflen %Zu, align %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_urb_size</span><span class="p">,</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">init_c</span><span class="o">-&gt;</span><span class="n">packet_alignment</span><span class="p">));</span>

	<span class="cm">/* module has some device initialization code needs to be done right</span>
<span class="cm">	 * after RNDIS_INIT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">early_init</span> <span class="o">&amp;&amp;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">early_init</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">halt_fail_and_release</span><span class="p">;</span>

	<span class="cm">/* Check physical medium */</span>
	<span class="n">phym</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">reply_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">phym</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_query</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
			     <span class="n">RNDIS_OID_GEN_PHYSICAL_MEDIUM</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">phym</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">phym</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* OID is optional so don&#39;t fail here. */</span>
		<span class="n">phym_unspec</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PHYSICAL_MEDIUM_UNSPECIFIED</span><span class="p">);</span>
		<span class="n">phym</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phym_unspec</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RNDIS_PHYM_WIRELESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">le32_to_cpup</span><span class="p">(</span><span class="n">phym</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RNDIS_PHYSICAL_MEDIUM_WIRELESS_LAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;driver requires wireless physical medium, but device is not</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">halt_fail_and_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RNDIS_PHYM_NOT_WIRELESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">le32_to_cpup</span><span class="p">(</span><span class="n">phym</span><span class="p">)</span> <span class="o">==</span> <span class="n">RNDIS_PHYSICAL_MEDIUM_WIRELESS_LAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
			  <span class="s">&quot;driver requires non-wireless physical medium, but device is wireless.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">halt_fail_and_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get designated host ethernet address */</span>
	<span class="n">reply_len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_query</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
			     <span class="n">RNDIS_OID_802_3_PERMANENT_ADDRESS</span><span class="p">,</span>
			     <span class="mi">48</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span><span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rndis get ethaddr, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">halt_fail_and_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* set a nonzero filter to enable data transfers */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_SET</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_CURRENT_PACKET_FILTER</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_DEFAULT_FILTER</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rndis set packet filter, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">halt_fail_and_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">halt_fail_and_release:</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">halt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">halt</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">halt</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_HALT</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">halt</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">halt</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">u</span><span class="p">.</span><span class="n">halt</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>
<span class="nl">fail_and_release:</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="n">driver_of</span><span class="p">(</span><span class="n">intf</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">generic_rndis_bind</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_rndis_bind</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">FLAG_RNDIS_PHYM_NOT_WIRELESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rndis_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_halt</span>	<span class="o">*</span><span class="n">halt</span><span class="p">;</span>

	<span class="cm">/* try to clear any rndis state/activity (no i/o from stack!) */</span>
	<span class="n">halt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">CONTROL_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">halt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">halt</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_HALT</span><span class="p">);</span>
		<span class="n">halt</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">halt</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">halt</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">halt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usbnet_cdc_unbind</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rndis_unbind</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * DATA -- host must not write zlps</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rndis_rx_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* peripheral may have batched packets to us... */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rndis_data_hdr</span>	<span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
		<span class="n">u32</span>			<span class="n">msg_type</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">data_len</span><span class="p">;</span>

		<span class="n">msg_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">);</span>
		<span class="n">msg_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">);</span>
		<span class="n">data_offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>

		<span class="cm">/* don&#39;t choke if we see oob, per-packet data, etc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">msg_type</span> <span class="o">!=</span> <span class="n">RNDIS_MSG_PACKET</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">msg_len</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">data_len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">msg_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;bad rndis message %d/%d/%d/%d, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">),</span>
				   <span class="n">msg_len</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="cm">/* at most one packet left? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">data_len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* try to return all the packets in the batch */</span>
		<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb2</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">msg_len</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb2</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
		<span class="n">usbnet_skb_return</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* caller will usbnet_skb_return the remaining packet */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rndis_rx_fixup</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">rndis_tx_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_data_hdr</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">room</span> <span class="o">=</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="cm">/* enough head room as-is? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">room</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fill</span><span class="p">;</span>

		<span class="cm">/* enough room, but needs to be readjusted? */</span>
		<span class="n">room</span> <span class="o">+=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">room</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
					    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb_set_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fill</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* create a new skb, with the correct size (and tailpad) */</span>
	<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_copy_expand</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">skb2</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb2</span><span class="p">;</span>

	<span class="cm">/* fill out the RNDIS header.  we won&#39;t bother trying to batch</span>
<span class="cm">	 * packets; Linux minimizes wasted bandwidth through tx queues.</span>
<span class="cm">	 */</span>
<span class="nl">fill:</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">__skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_PACKET</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* FIXME make the last packet always be short ... */</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rndis_tx_fixup</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">driver_info</span>	<span class="n">rndis_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>	<span class="s">&quot;RNDIS device&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>	<span class="n">FLAG_ETHER</span> <span class="o">|</span> <span class="n">FLAG_POINTTOPOINT</span> <span class="o">|</span> <span class="n">FLAG_FRAMING_RN</span> <span class="o">|</span> <span class="n">FLAG_NO_SETINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">rndis_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span>	<span class="n">rndis_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span>	<span class="n">rndis_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_fixup</span> <span class="o">=</span>	<span class="n">rndis_rx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fixup</span> <span class="o">=</span>	<span class="n">rndis_tx_fixup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">driver_info</span>	<span class="n">rndis_poll_status_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>	<span class="s">&quot;RNDIS device (poll status before control)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>	<span class="n">FLAG_ETHER</span> <span class="o">|</span> <span class="n">FLAG_POINTTOPOINT</span> <span class="o">|</span> <span class="n">FLAG_FRAMING_RN</span> <span class="o">|</span> <span class="n">FLAG_NO_SETINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span> <span class="o">=</span>		<span class="n">RNDIS_DRIVER_DATA_POLL_STATUS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">rndis_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span>	<span class="n">rndis_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span>	<span class="n">rndis_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_fixup</span> <span class="o">=</span>	<span class="n">rndis_rx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fixup</span> <span class="o">=</span>	<span class="n">rndis_tx_fixup</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span>	<span class="n">products</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="cm">/* 2Wire HomePortal 1000SW */</span>
	<span class="n">USB_DEVICE_AND_INTERFACE_INFO</span><span class="p">(</span><span class="mh">0x1630</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span>
				      <span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="mi">2</span> <span class="cm">/* ACM */</span><span class="p">,</span> <span class="mh">0x0ff</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rndis_poll_status_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="cm">/* RNDIS is MSFT&#39;s un-official variant of CDC ACM */</span>
	<span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="mi">2</span> <span class="cm">/* ACM */</span><span class="p">,</span> <span class="mh">0x0ff</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rndis_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="cm">/* &quot;ActiveSync&quot; is an undocumented variant of RNDIS, used in WM5 */</span>
	<span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_MISC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rndis_poll_status_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="cm">/* RNDIS for tethering */</span>
	<span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_WIRELESS_CONTROLLER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rndis_info</span><span class="p">,</span>
<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>		<span class="c1">// END</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">products</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">rndis_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;rndis_host&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">products</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">usbnet_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">usbnet_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">usbnet_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">usbnet_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">rndis_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Brownell&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;USB Host side RNDIS driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
